<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/golang-notes/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/golang-notes/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Golang学习笔记 | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="Golang学习笔记" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/golang-notes/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="Golang学习笔记">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Golang学习笔记"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/kubernetes-notes/" ><span>Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/k8s-source-code-analysis/" ><span>Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/golang-notes/" ><span class="active">Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/linux-notes/" ><span>Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.2a5adfd47615bf8c81bb30ba075d9ca4.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/golang-notes/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">Golang学习笔记</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-2967e0b8701835ed26f0864ec23cdbbc">语言概述</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-0c11ddefd4f2d1bdbdba425bd9560d35">Golang资源</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-3974ee234033ef37a4e86b1a09b238d1">计算机语言概述</a></li>


    
  
    
    
	
<li>1.3: <a href="#pg-7ccf06550e07c500d243955702ff7907">后端开发技能树</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-a3966659be4885f8204f770c587a1008">安装与配置</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-1f193b481f6a5667b09926c9fe025b98">Golang介绍</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-75df9a0369435be0e9180757813cf697">Golang安装</a></li>


    
  
    
    
	
<li>2.3: <a href="#pg-054af48059449000dd63fdb6840d3d42">包管理工具</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.3.1: <a href="#pg-931ca420ca42f5abd021eb18f284a0db">go modules的使用</a></li>


    
  
    
    
	
<li>2.3.2: <a href="#pg-a94e8596d1af64129a1758974e76a512">dep的使用</a></li>


    
  
    
    
	
<li>2.3.3: <a href="#pg-ebd86caf92009f32a0b5c6ef52a27ce6">glide的使用</a></li>


    
  
    
    
	
<li>2.3.4: <a href="#pg-fe6e6ccd4e8e0dd3bfb895625c7aa8ce">govendor的使用</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-1b6f9e0d7b6230730879c41cc46010d3">顺序编程</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-f0665a4ffa073bc955e8985e7da650be">变量与常量</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-8c5a55e97fdbfcfbb8f91043c01b4c7d">数据类型</a></li>


    
  
    
    
	
<li>3.3: <a href="#pg-46a114232811022faa125b8294f17449">流程语句</a></li>


    
  
    
    
	
<li>3.4: <a href="#pg-76885969b59488f67b4016e7f549d7d9">函数与闭包</a></li>


    
  
    
    
	
<li>3.5: <a href="#pg-87f83fc3da9f5dcbb6bebac4f77c1552">错误处理</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-d086e553801ce3fd465423ac202cff1b">面向对象编程</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-19c2e8fbc544b71642681669ddea0828">Golang系列（二）之面向对象编程</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-f38d91a0433bf615f45ed644177bc984">Golang 指针</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-c35f23d9f6410b81a49a11ea33793112">并发编程</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-4c8372e52fa75cb824e9855efd347543">Golang系列（三）之并发编程</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-d80b67fd8e174563789a593632b2910f">文本处理</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-b29bf66a1261ae910d3a40ffabb70e28">Json处理</a></li>


    
  
    
    
	
<li>6.2: <a href="#pg-a990d95ccd933871e49e55b22aedbf9f">文件操作</a></li>


    
  
    
    
	
<li>6.3: <a href="#pg-719d254961116eb786bedc6cdfe80a71">字符串处理</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-7556189d85d6b1efe21bf0554529e2f7">单元测试</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-9f54ee0a88c9d10394c84722e4749849">单元测试</a></li>


    
  
    
    
	
<li>7.2: <a href="#pg-59028f298d7c92f86b48acee63ac76cf">GDB调试</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-aedac0cb64b7bbac0d96a16b4beb98ad">原理篇</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.1: <a href="#pg-7bc48bb55b545d1380f04f3ad0c830de">Goroutine调度</a></li>


    
  
    
    
	
<li>8.2: <a href="#pg-b8b91a006ccc6631bf1d4686e528f557">内存分配</a></li>


    
  
    
    
	
<li>8.3: <a href="#pg-6175b2f5094c6f2f7f140051010d2af5">垃圾回收</a></li>


    
  
    
    
	
<li>8.4: <a href="#pg-153a0dea4426741d355082018e61bbca">深入理解Channel</a></li>


    
  

    </ul>
    
  
    
    
	
<li>9: <a href="#pg-afe9a2744fbfaff67a60f95f82fde861">框架与工具</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>9.1: <a href="#pg-db9d97f48c46611bb8f9057053ea0221">Cobra命令框架</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>9.1.1: <a href="#pg-9dc604ed1f73abaccaa475707a6f3fb2">cobra 介绍</a></li>


    
  
    
    
	
<li>9.1.2: <a href="#pg-04f7287ef9bca2673f1b910e4df63291">cobra command</a></li>


    
  
    
    
	
<li>9.1.3: <a href="#pg-893ab712567d96d312135e4afc210aa8">cobra flags</a></li>


    
  

    </ul>
    
  
    
    
	
<li>9.2: <a href="#pg-90d3042b02510958c3ff4d2692b71a2e">性能分析之go pprof工具使用</a></li>


    
  

    </ul>
    
  
    
    
	
<li>10: <a href="#pg-730cfb9f4c3061ee695a19a22b0b3d29">代码规范</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1: <a href="#pg-08fea79afe24f6ff5d3f175366b64ee0">Golang 代码规范</a></li>


    
  
    
    
	
<li>10.2: <a href="#pg-bf6db6ddcb3a618c34fdf7a675a73437">golangci-lint的使用</a></li>


    
  
    
    
	
<li>10.3: <a href="#pg-fb52125a339fb8f5e65e197f800dc327">golangci-lint问题优化</a></li>


    
  

    </ul>
    
  
    
    
	
<li>11: <a href="#pg-1d9157890092db27ff6b9052b385ad09">Web编程</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>11.1: <a href="#pg-30303a9620afccb7ad52ab3708f56c92">Http包源码分析</a></li>


    
  
    
    
	
<li>11.2: <a href="#pg-f168014131eb383b79bb6cde867ee7b7">Beego Web框架</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>11.2.1: <a href="#pg-d920f3d65e431a30e0dcb5ea3fbd7f6d">Beego 介绍</a></li>


    
  
    
    
	
<li>11.2.2: <a href="#pg-c1d1f70754730e7cb2300c05042bcfa0">Bee 工具使用</a></li>


    
  
    
    
	
<li>11.2.3: <a href="#pg-7fe6fb93e4540d87e90213d922b39705">Beego 项目逻辑</a></li>


    
  
    
    
	
<li>11.2.4: <a href="#pg-63a7ba74df98839246bc414fa2028a24">Beego 日志处理</a></li>


    
  

    </ul>
    
  
    
    
	
<li>11.3: <a href="#pg-637fdd90dbbca8cc7090a27b277cd979">Go实现限流器</a></li>


    
  

    </ul>
    
  
    
    
	
<li>12: <a href="#pg-93d703b6ce7077fe557914bb99df177d">源码分析</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.1: <a href="#pg-0d8b1d1671033461dfc027e02aedc2c4">confd源码分析</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-2967e0b8701835ed26f0864ec23cdbbc">1 - 语言概述</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0c11ddefd4f2d1bdbdba425bd9560d35">1.1 - Golang资源</h1>
    
	<blockquote>
<p>本文主要记录一些Golang相关的资源链接和书籍</p>
</blockquote>
<h1 id="1-官方文档">1. 官方文档</h1>
<h2 id="1-1-官网">1.1. 官网</h2>
<ul>
<li>
<p><a href="https://golang.org/">https://golang.org/</a></p>
</li>
<li>
<p><a href="https://golang.org/doc/">https://golang.org/doc/</a></p>
</li>
</ul>
<h2 id="1-2-基础">1.2. 基础</h2>
<ul>
<li>
<p><a href="https://tour.golang.org/list">A Tour of Go</a></p>
</li>
<li>
<p><a href="https://golang.org/doc/effective_go.html">Effective Go</a></p>
</li>
<li>
<p><a href="https://golang.org/doc/faq">Frequently Asked Questions (FAQ)</a></p>
</li>
<li>
<p><a href="https://github.com/golang/go/wiki/CodeReviewComments">CodeReviewComments</a></p>
</li>
<li>
<p><a href="https://github.com/uber-go/guide/blob/master/style.md">Uber Go Style Guide</a> | <a href="https://github.com/xxjwxc/uber_go_guide_cn">中文版</a></p>
</li>
</ul>
<h2 id="1-3-补充">1.3. 补充</h2>
<ul>
<li>
<p><a href="https://golang.org/doc/diagnostics.html">Diagnostics</a></p>
</li>
<li>
<p><a href="https://golang.org/wiki">The Go Wiki</a></p>
</li>
<li>
<p><a href="https://golang.org/ref/spec">Language Specification</a></p>
</li>
<li>
<p><a href="https://golang.org/ref/mem">The Go Memory Model</a></p>
</li>
<li>
<p><a href="https://golang.org/play">Go Playground</a></p>
</li>
<li>
<p><a href="https://awesome-go.com/">awesome-go.com</a></p>
</li>
</ul>
<h2 id="1-4-the-go-blog-https-blog-golang-org-index">1.4. <a href="https://blog.golang.org/index">The Go Blog</a></h2>
<ul>
<li><a href="https://golang.org/doc/codewalk/sharemem">Share Memory by Communicating</a></li>
<li><a href="https://golang.org/blog/defer-panic-and-recover">Defer, Panic, and Recover</a></li>
<li><a href="https://golang.org/blog/go-slices-usage-and-internals">Go Slices: usage and internals</a></li>
<li><a href="https://golang.org/blog/profiling-go-programs">Profiling Go Programs</a></li>
</ul>
<h1 id="2-书籍">2. 书籍</h1>
<ul>
<li>
<p><a href="http://www.gopl.io/">《The Go Programming Language》</a></p>
</li>
<li>
<p>《Mastering Go》</p>
</li>
<li>
<p>《Go语言实战》</p>
</li>
</ul>
<h1 id="3-github上优秀的go项目">3. GitHub上优秀的Go项目</h1>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1658042755/article/golang/summary/golang_github_program.png" alt="github_program"></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3974ee234033ef37a4e86b1a09b238d1">1.2 - 计算机语言概述</h1>
    
	<h1 id="1-计算机语言概述">1. 计算机语言概述</h1>
<p>学习一门计算机语言，将计算机语言分为以下几大部分：</p>
<ul>
<li>语言特点</li>
<li>环境准备</li>
<li>基本语法</li>
<li>数据类型
<ul>
<li>变量</li>
<li>常量</li>
<li>引用类型</li>
</ul>
</li>
<li>流程语句
<ul>
<li>判断语句</li>
<li>循环语句</li>
<li>选择语句</li>
</ul>
</li>
<li>函数</li>
<li>面向对象编程
<ul>
<li>封装（类与方法）</li>
<li>继承</li>
<li>多态（接口）</li>
</ul>
</li>
<li>并发编程</li>
<li>特殊属性</li>
<li>包管理</li>
<li>标准库</li>
</ul>
<h1 id="2-思维导图">2. 思维导图</h1>
<p><img src="http://assets.processon.com/chart_image/5d7ce0d3e4b01080c73ee670.png" alt="计算机语言"></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7ccf06550e07c500d243955702ff7907">1.3 - 后端开发技能树</h1>
    
	<h1 id="后端开发技能树">后端开发技能树</h1>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1658042754/article/golang/summary/skill-tree.png" alt="技能树"></p>
<blockquote>
<p>图片来源于网络</p>
</blockquote>
<p>参考：</p>
<ul>
<li><a href="https://github.com/xingshaocheng/architect-awesome">https://github.com/xingshaocheng/architect-awesome</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a3966659be4885f8204f770c587a1008">2 - 安装与配置</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1f193b481f6a5667b09926c9fe025b98">2.1 - Golang介绍</h1>
    
	<h1 id="初识go语言">初识Go语言</h1>
<h2 id="1-概述">1. 概述</h2>
<p>一个在语言层面实现了并发机制的类C通用型编程语言。</p>
<h2 id="2-go关键字-25个">2. Go关键字（25个）</h2>
<table>
<thead>
<tr>
<th>类别</th>
<th>关键字</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>程序声明</td>
<td>package，import</td>
<td>包的声明和导入</td>
</tr>
<tr>
<td>声明与定义</td>
<td>var，const</td>
<td>变量和常量的声明</td>
</tr>
<tr>
<td></td>
<td>type</td>
<td>用于定义类型</td>
</tr>
<tr>
<td>复合数据类型</td>
<td>struct</td>
<td>定义结构体，类似java中的class</td>
</tr>
<tr>
<td></td>
<td>interface</td>
<td>定义接口</td>
</tr>
<tr>
<td></td>
<td>map</td>
<td>定义键值对</td>
</tr>
<tr>
<td></td>
<td>func</td>
<td>定义函数和方法</td>
</tr>
<tr>
<td></td>
<td>chan</td>
<td>定义管道，并发中channel通信</td>
</tr>
<tr>
<td>并发编程</td>
<td>go</td>
<td>并发编程</td>
</tr>
<tr>
<td></td>
<td>select</td>
<td>用于选择不同类型通信</td>
</tr>
<tr>
<td>流程语句</td>
<td>for；if，else；switch，case</td>
<td>循环语句；条件语句；选择语句</td>
</tr>
<tr>
<td></td>
<td>break，continue，fallthrough，default，goto</td>
<td>跳转语句等</td>
</tr>
<tr>
<td></td>
<td>return</td>
<td>函数返回值</td>
</tr>
<tr>
<td></td>
<td>defer</td>
<td>延迟函数，用于return前释放资源</td>
</tr>
<tr>
<td></td>
<td>range</td>
<td>用于读取slice，map，channel容器类数据</td>
</tr>
</tbody>
</table>
<h2 id="3-go语言命令">3. Go语言命令</h2>
<p>Usage：go command [arguments]</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>build</td>
<td>compile packages and dependencies</td>
</tr>
<tr>
<td></td>
<td>clean</td>
<td>remove object files</td>
</tr>
<tr>
<td></td>
<td>doc</td>
<td>show documentation for package or symbol</td>
</tr>
<tr>
<td></td>
<td>env</td>
<td>print Go environment information</td>
</tr>
<tr>
<td></td>
<td>fix</td>
<td>run go tool fix on packages</td>
</tr>
<tr>
<td></td>
<td>fmt</td>
<td>run gofmt on package sources</td>
</tr>
<tr>
<td></td>
<td>generate</td>
<td>generate Go files by processing source</td>
</tr>
<tr>
<td></td>
<td>get</td>
<td>download and install packages and dependencies</td>
</tr>
<tr>
<td></td>
<td>install</td>
<td>compile and install packages and dependencies</td>
</tr>
<tr>
<td></td>
<td>list</td>
<td>list packages</td>
</tr>
<tr>
<td></td>
<td>run</td>
<td>compile and run Go program</td>
</tr>
<tr>
<td></td>
<td>test</td>
<td>test packages</td>
</tr>
<tr>
<td></td>
<td>tool</td>
<td>run specified go tool</td>
</tr>
<tr>
<td></td>
<td>version</td>
<td>print Go version</td>
</tr>
<tr>
<td></td>
<td>vet</td>
<td>run go tool vet on packages</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-75df9a0369435be0e9180757813cf697">2.2 - Golang安装</h1>
    
	<h1 id="1-install-go-sh">1. install-go.sh</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -x
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> -e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># default version</span>
</span></span><span style="display:flex;"><span><span style="color:#000">VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">VERSION</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">.14.6</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">PLATFORM</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$2</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PLATFORM</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">PLATFORM</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">linux</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">GOROOT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/usr/local/go&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">GOPATH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$HOME</span>/gopath
</span></span><span style="display:flex;"><span><span style="color:#000">GO_DOWNLOAD_URL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://golang.org/dl&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># download and install</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">${</span><span style="color:#000">PLATFORM</span><span style="color:#4e9a06">}</span> in
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;linux&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    wget <span style="color:#4e9a06">${</span><span style="color:#000">GO_DOWNLOAD_URL</span><span style="color:#4e9a06">}</span>/go<span style="color:#4e9a06">${</span><span style="color:#000">VERSION</span><span style="color:#4e9a06">}</span>.<span style="color:#4e9a06">${</span><span style="color:#000">PLATFORM</span><span style="color:#4e9a06">}</span>-amd64.tar.gz
</span></span><span style="display:flex;"><span>    tar -C /usr/local -xzf go<span style="color:#4e9a06">${</span><span style="color:#000">VERSION</span><span style="color:#4e9a06">}</span>.<span style="color:#4e9a06">${</span><span style="color:#000">PLATFORM</span><span style="color:#4e9a06">}</span>-amd64.tar.gz
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;mac&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PLATFORM</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;darwin&#34;</span>
</span></span><span style="display:flex;"><span>    wget <span style="color:#4e9a06">${</span><span style="color:#000">GO_DOWNLOAD_URL</span><span style="color:#4e9a06">}</span>/go<span style="color:#4e9a06">${</span><span style="color:#000">VERSION</span><span style="color:#4e9a06">}</span>.<span style="color:#4e9a06">${</span><span style="color:#000">PLATFORM</span><span style="color:#4e9a06">}</span>-amd64.tar.gz
</span></span><span style="display:flex;"><span>    tar -C /usr/local -xzf go<span style="color:#4e9a06">${</span><span style="color:#000">VERSION</span><span style="color:#4e9a06">}</span>.<span style="color:#4e9a06">${</span><span style="color:#000">PLATFORM</span><span style="color:#4e9a06">}</span>-amd64.tar.gz
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>*<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;platform not found&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">esac</span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># set golang env</span>
</span></span><span style="display:flex;"><span>cat &gt;&gt; <span style="color:#000">$HOME</span>/.bashrc <span style="color:#4e9a06">&lt;&lt; EOF 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"># Golang env
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">export GOROOT=/usr/local/go
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">export GOPATH=\$HOME/gopath
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">export PATH=\$PATH:\$GOROOT/bin:\$GOPATH/bin
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">source</span> <span style="color:#000">$HOME</span>/.bashrc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># mkdir gopath</span>
</span></span><span style="display:flex;"><span>mkdir -p <span style="color:#000">$GOPATH</span>/src <span style="color:#000">$GOPATH</span>/pkg <span style="color:#000">$GOPATH</span>/bin
</span></span></code></pre></div><h1 id="2-安装">2. 安装</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod +x install-go.sh
</span></span><span style="display:flex;"><span>./install-go.sh 1.14.6 linux
</span></span></code></pre></div><blockquote>
<p>更多版本号可参考：https://golang.org/dl/</p>
</blockquote>
<p>参考：</p>
<ul>
<li><a href="https://golang.org/doc/install">https://golang.org/doc/install</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-054af48059449000dd63fdb6840d3d42">2.3 - 包管理工具</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-931ca420ca42f5abd021eb18f284a0db">2.3.1 - go modules的使用</h1>
    
	<h1 id="1-go-modules简介">1. Go modules简介</h1>
<p><code>Go 1.11</code>版本开始支持<code>Go modules</code>方式的依赖包管理功能，官网参考：https://github.com/golang/go/wiki/Modules 。</p>
<h1 id="2-go-mod的使用-https-github-com-golang-go-wiki-modules-how-to-use-modules">2. <a href="https://github.com/golang/go/wiki/Modules#how-to-use-modules">go mod的使用</a></h1>
<p>项目文件如下：</p>
<p>hello.go</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;rsc.io/quote&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">quote</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Hello</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>操作记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装GO 1.11及以上版本</span>
</span></span><span style="display:flex;"><span>go version
</span></span><span style="display:flex;"><span>go version go1.12.5 darwin/amd64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 开启module功能</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">GO111MODULE</span><span style="color:#ce5c00;font-weight:bold">=</span>on
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 进入到项目目录</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /home/gopath/src/hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 初始化</span>
</span></span><span style="display:flex;"><span>go mod init
</span></span><span style="display:flex;"><span>go: creating new go.mod: module hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 编译</span>
</span></span><span style="display:flex;"><span>go build
</span></span><span style="display:flex;"><span>go: finding rsc.io/quote v1.5.2
</span></span><span style="display:flex;"><span>go: downloading rsc.io/quote v1.5.2
</span></span><span style="display:flex;"><span>go: extracting rsc.io/quote v1.5.2
</span></span><span style="display:flex;"><span>go: finding rsc.io/sampler v1.3.0
</span></span><span style="display:flex;"><span>go: finding golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c
</span></span><span style="display:flex;"><span>go: downloading rsc.io/sampler v1.3.0
</span></span><span style="display:flex;"><span>go: extracting rsc.io/sampler v1.3.0
</span></span><span style="display:flex;"><span>go: downloading golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c
</span></span><span style="display:flex;"><span>go: extracting golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 不添加vendor目录</span>
</span></span><span style="display:flex;"><span>go mod tidy -v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果添加vendor目录，则执行vendor参数</span>
</span></span><span style="display:flex;"><span>go mod vendor -v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 命令输出如下:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c</span>
</span></span><span style="display:flex;"><span>golang.org/x/text/language
</span></span><span style="display:flex;"><span>golang.org/x/text/internal/tag
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># rsc.io/quote v1.5.2</span>
</span></span><span style="display:flex;"><span>rsc.io/quote
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># rsc.io/sampler v1.3.0</span>
</span></span><span style="display:flex;"><span>rsc.io/sampler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 文件目录结构</span>
</span></span><span style="display:flex;"><span>./
</span></span><span style="display:flex;"><span>├── go.mod
</span></span><span style="display:flex;"><span>├── go.sum
</span></span><span style="display:flex;"><span>├── hello  <span style="color:#8f5902;font-style:italic"># 二进制文件</span>
</span></span><span style="display:flex;"><span>├── hello.go
</span></span><span style="display:flex;"><span>└── vendor
</span></span><span style="display:flex;"><span>    ├── golang.org
</span></span><span style="display:flex;"><span>    ├── modules.txt
</span></span><span style="display:flex;"><span>    └── rsc.io
</span></span></code></pre></div><h1 id="3-go-mod的相关文件">3. go mod的相关文件</h1>
<h2 id="3-1-go-mod">3.1. go.mod</h2>
<p>文件路径：项目根目录下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>module hello
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go 1.12
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>require rsc.io/quote v1.5.2
</span></span></code></pre></div><h2 id="3-2-go-sum">3.2. go.sum</h2>
<p>文件路径：项目根目录下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c h1:qgOY6WgZOaTkIIMiVjBQcw93ERBE4m30iBm00nkL0i8<span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c/go.mod h1:NqM8EUOU14njkJ3fqMW+pc6Ldnwhi/IjpwHt7yyuwOQ<span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>rsc.io/quote v1.5.2 h1:w5fcysjrx7yqtD/aO+QwRjYZOKnaM9Uh2b40tElTs3Y<span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>rsc.io/quote v1.5.2/go.mod h1:LzX7hefJvL54yjefDEDHNONDjII0t9xZLPXsUe+TKr0<span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>rsc.io/sampler v1.3.0 h1:7uVkIFmeBqHfdjD+gZwtXXI+RODJ2Wc4O7MPEh/QiW4<span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>rsc.io/sampler v1.3.0/go.mod h1:T1hPZKmBbMNahiBKFy5HrXp6adAjACjK9JXDnKaTXpA<span style="color:#ce5c00;font-weight:bold">=</span>
</span></span></code></pre></div><h2 id="3-3-modules-txt">3.3. modules.txt</h2>
<p>文件路径：/{project}/vendor/modules.txt</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c</span>
</span></span><span style="display:flex;"><span>golang.org/x/text/language
</span></span><span style="display:flex;"><span>golang.org/x/text/internal/tag
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># rsc.io/quote v1.5.2</span>
</span></span><span style="display:flex;"><span>rsc.io/quote
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># rsc.io/sampler v1.3.0</span>
</span></span><span style="display:flex;"><span>rsc.io/sampler
</span></span></code></pre></div><h1 id="4-go-mod的帮助信息">4. go mod的帮助信息</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go <span style="color:#204a87">help</span> mod
</span></span><span style="display:flex;"><span>Go mod provides access to operations on modules.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Note that support <span style="color:#204a87;font-weight:bold">for</span> modules is built into all the go commands,
</span></span><span style="display:flex;"><span>not just <span style="color:#4e9a06">&#39;go mod&#39;</span>. For example, day-to-day adding, removing, upgrading,
</span></span><span style="display:flex;"><span>and downgrading of dependencies should be <span style="color:#204a87;font-weight:bold">done</span> using <span style="color:#4e9a06">&#39;go get&#39;</span>.
</span></span><span style="display:flex;"><span>See <span style="color:#4e9a06">&#39;go help modules&#39;</span> <span style="color:#204a87;font-weight:bold">for</span> an overview of module functionality.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	go mod &lt;command&gt; <span style="color:#ce5c00;font-weight:bold">[</span>arguments<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The commands are:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	download    download modules to <span style="color:#204a87">local</span> cache
</span></span><span style="display:flex;"><span>	edit        edit go.mod from tools or scripts
</span></span><span style="display:flex;"><span>	graph       print module requirement graph
</span></span><span style="display:flex;"><span>	init        initialize new module in current directory
</span></span><span style="display:flex;"><span>	tidy        add missing and remove unused modules
</span></span><span style="display:flex;"><span>	vendor      make vendored copy of dependencies
</span></span><span style="display:flex;"><span>	verify      verify dependencies have expected content
</span></span><span style="display:flex;"><span>	why         explain why packages or modules are needed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;go help mod &lt;command&gt;&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information about a command.
</span></span></code></pre></div><h2 id="4-1-go-mod-init">4.1. go mod init</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go <span style="color:#204a87">help</span> mod init
</span></span><span style="display:flex;"><span>usage: go mod init <span style="color:#ce5c00;font-weight:bold">[</span>module<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Init initializes and writes a new go.mod to the current directory,
</span></span><span style="display:flex;"><span>in effect creating a new module rooted at the current directory.
</span></span><span style="display:flex;"><span>The file go.mod must not already exist.
</span></span><span style="display:flex;"><span>If possible, init will guess the module path from import comments
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>see <span style="color:#4e9a06">&#39;go help importpath&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span> or from version control configuration.
</span></span><span style="display:flex;"><span>To override this guess, supply the module path as an argument.
</span></span></code></pre></div><h2 id="4-2-go-mod-tidy">4.2. go mod tidy</h2>
<pre tabindex="0"><code>usage: go mod tidy [-v]

Tidy makes sure go.mod matches the source code in the module.
It adds any missing modules necessary to build the current module&#39;s
packages and dependencies, and it removes unused modules that
don&#39;t provide any relevant packages. It also adds any missing entries
to go.sum and removes any unnecessary ones.

The -v flag causes tidy to print information about removed modules
to standard error.
</code></pre><h2 id="4-3-go-mod-vendor">4.3. go mod vendor</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go <span style="color:#204a87">help</span> mod vendor
</span></span><span style="display:flex;"><span>usage: go mod vendor <span style="color:#ce5c00;font-weight:bold">[</span>-v<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Vendor resets the main module<span style="color:#4e9a06">&#39;s vendor directory to include all packages
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">needed to build and test all the main module&#39;</span>s packages.
</span></span><span style="display:flex;"><span>It does not include <span style="color:#204a87">test</span> code <span style="color:#204a87;font-weight:bold">for</span> vendored packages.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The -v flag causes vendor to print the names of vendored
</span></span><span style="display:flex;"><span>modules and packages to standard error.
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/golang/go/wiki/Modules">https://github.com/golang/go/wiki/Modules</a></li>
<li><a href="https://blog.golang.org/modules2019">https://blog.golang.org/modules2019</a></li>
<li><a href="https://blog.golang.org/using-go-modules">https://blog.golang.org/using-go-modules</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a94e8596d1af64129a1758974e76a512">2.3.2 - dep的使用</h1>
    
	<h1 id="1-dep简介">1. dep简介</h1>
<p><code>dep</code>是一个golang项目的包管理工具，一般只需要2-3个命令就可以将go依赖包自动下载并归档到<code>vendor</code>的目录中。dep官网参考：https://github.com/golang/dep</p>
<h1 id="2-dep安装">2. dep安装</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get -u github.com/golang/dep/cmd/dep
</span></span></code></pre></div><h1 id="3-dep使用">3. dep使用</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#进入到项目目录</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /home/gopath/src/demo
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#dep初始化，初始化配置文件Gopkg.toml</span>
</span></span><span style="display:flex;"><span>dep init
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#dep加载依赖包，自动归档到vendor目录</span>
</span></span><span style="display:flex;"><span>dep ensure 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 最终会生成vendor目录，Gopkg.toml和Gopkg.lock的文件</span>
</span></span></code></pre></div><h1 id="4-dep的配置文件">4. dep的配置文件</h1>
<p><code>Gopkg.toml</code>记录依赖包列表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Gopkg.toml example</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Refer to https://golang.github.io/dep/docs/Gopkg.toml.html</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for detailed Gopkg.toml documentation.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># required = [&#34;github.com/user/thing/cmd/thing&#34;]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ignored = [&#34;github.com/user/project/pkgX&#34;, &#34;bitbucket.org/user/project/pkgA/pkgY&#34;]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># [[constraint]]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   name = &#34;github.com/user/project&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   version = &#34;1.0.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># [[constraint]]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   name = &#34;github.com/user/project2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   branch = &#34;dev&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   source = &#34;github.com/myfork/project2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># [[override]]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   name = &#34;github.com/x/y&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   version = &#34;2.4.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># [prune]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   non-go = false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   go-tests = true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   unused-packages = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ignored</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;demo&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[[</span>constraint<span style="color:#ce5c00;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;github.com/BurntSushi/toml&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.3.0&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>prune<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  go-tests <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>  unused-packages <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>
</span></span></code></pre></div><h1 id="5-dep-help">5. dep-help</h1>
<p>更多dep的命令帮助参考<code>dep</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ dep
</span></span><span style="display:flex;"><span>Dep is a tool <span style="color:#204a87;font-weight:bold">for</span> managing dependencies <span style="color:#204a87;font-weight:bold">for</span> Go projects
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage: <span style="color:#4e9a06">&#34;dep [command]&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Commands:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  init     Set up a new Go project, or migrate an existing one
</span></span><span style="display:flex;"><span>  status   Report the status of the project<span style="color:#4e9a06">&#39;s dependencies
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  ensure   Ensure a dependency is safely vendored in the project
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  prune    Pruning is now performed automatically by dep ensure.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  version  Show the dep version information
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Examples:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  dep init                               set up a new project
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  dep ensure                             install the project&#39;</span>s dependencies
</span></span><span style="display:flex;"><span>  dep ensure -update                     update the locked versions of all dependencies
</span></span><span style="display:flex;"><span>  dep ensure -add github.com/pkg/errors  add a dependency to the project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;dep help [command]&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information about a command.
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ebd86caf92009f32a0b5c6ef52a27ce6">2.3.3 - glide的使用</h1>
    
	<h1 id="1-glide简介">1. glide简介</h1>
<p>glide是一个golang项目的包管理工具，非常方便快捷，一般只需要2-3个命令就可以将go依赖包自动下载并归档到vendor的目录中。</p>
<h1 id="2-glide安装">2. glide安装</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get github.com/Masterminds/glide
</span></span></code></pre></div><h1 id="3-glide使用">3. glide使用</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#进入到项目目录</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /home/gopath/src/demo
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#glide初始化，初始化配置文件glide.yaml</span>
</span></span><span style="display:flex;"><span>glide init
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#glide加载依赖包，自动归档到vendor目录</span>
</span></span><span style="display:flex;"><span>glide up -v
</span></span></code></pre></div><h1 id="4-glide的配置文件">4. glide的配置文件</h1>
<p><code>glide.yaml</code>记录依赖包列表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>package: demo
</span></span><span style="display:flex;"><span>import:
</span></span><span style="display:flex;"><span>- package: github.com/astaxie/beego
</span></span><span style="display:flex;"><span>  version: v1.9.2
</span></span><span style="display:flex;"><span>testImport:
</span></span><span style="display:flex;"><span>- package: github.com/smartystreets/goconvey
</span></span><span style="display:flex;"><span>  version: 1.6.3
</span></span><span style="display:flex;"><span>  subpackages:
</span></span><span style="display:flex;"><span>  - convey
</span></span></code></pre></div><h1 id="5-glide-help">5. glide-help</h1>
<p>更多glide的命令帮助参考<code>glide —help</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>➜  demo glide --help
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   glide - Vendor Package Management <span style="color:#204a87;font-weight:bold">for</span> your Go projects.
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   Each project should have a <span style="color:#4e9a06">&#39;glide.yaml&#39;</span> file in the project directory. Files
</span></span><span style="display:flex;"><span>   look something like this:
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>       package: github.com/Masterminds/glide
</span></span><span style="display:flex;"><span>       imports:
</span></span><span style="display:flex;"><span>       - package: github.com/Masterminds/cookoo
</span></span><span style="display:flex;"><span>         version: 1.1.0
</span></span><span style="display:flex;"><span>       - package: github.com/kylelemons/go-gypsy
</span></span><span style="display:flex;"><span>         subpackages:
</span></span><span style="display:flex;"><span>         - yaml
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   For more details on the <span style="color:#4e9a06">&#39;glide.yaml&#39;</span> files see the documentation at
</span></span><span style="display:flex;"><span>   https://glide.sh/docs/glide.yaml
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   glide <span style="color:#ce5c00;font-weight:bold">[</span>global options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>VERSION:
</span></span><span style="display:flex;"><span>   0.13.2-dev
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>     create, init       Initialize a new project, creating a glide.yaml file
</span></span><span style="display:flex;"><span>     config-wizard, cw  Wizard that makes optional suggestions to improve config in a glide.yaml file.
</span></span><span style="display:flex;"><span>     get                Install one or more packages into <span style="color:#4e9a06">`</span>vendor/<span style="color:#4e9a06">`</span> and add dependency to glide.yaml.
</span></span><span style="display:flex;"><span>     remove, rm         Remove a package from the glide.yaml file, and regenerate the lock file.
</span></span><span style="display:flex;"><span>     import             Import files from other dependency management systems.
</span></span><span style="display:flex;"><span>     name               Print the name of this project.
</span></span><span style="display:flex;"><span>     novendor, nv       List all non-vendor paths in a directory.
</span></span><span style="display:flex;"><span>     rebuild            Rebuild <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;go build&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span> the dependencies
</span></span><span style="display:flex;"><span>     install, i         Install a project<span style="color:#4e9a06">&#39;s dependencies
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">     update, up         Update a project&#39;</span>s dependencies
</span></span><span style="display:flex;"><span>     tree               <span style="color:#ce5c00;font-weight:bold">(</span>Deprecated<span style="color:#ce5c00;font-weight:bold">)</span> Tree prints the dependencies of this project as a tree.
</span></span><span style="display:flex;"><span>     list               List prints all dependencies that the present code references.
</span></span><span style="display:flex;"><span>     info               Info prints information about this project
</span></span><span style="display:flex;"><span>     cache-clear, cc    Clears the Glide cache.
</span></span><span style="display:flex;"><span>     about              Learn about Glide
</span></span><span style="display:flex;"><span>     mirror             Manage mirrors
</span></span><span style="display:flex;"><span>     help, h            Shows a list of commands or <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> one <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>GLOBAL OPTIONS:
</span></span><span style="display:flex;"><span>   --yaml value, -y value  Set a YAML configuration file. <span style="color:#ce5c00;font-weight:bold">(</span>default: <span style="color:#4e9a06">&#34;glide.yaml&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   --quiet, -q             Quiet <span style="color:#ce5c00;font-weight:bold">(</span>no info or debug messages<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   --debug                 Print debug verbose informational messages
</span></span><span style="display:flex;"><span>   --home value            The location of Glide files <span style="color:#ce5c00;font-weight:bold">(</span>default: <span style="color:#4e9a06">&#34;/Users/meitu/.glide&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">$GLIDE_HOME</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>   --tmp value             The temp directory to use. Defaults to systems temp <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">$GLIDE_TMP</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>   --no-color              Turn off colored output <span style="color:#204a87;font-weight:bold">for</span> log messages
</span></span><span style="display:flex;"><span>   --help, -h              show <span style="color:#204a87">help</span>
</span></span><span style="display:flex;"><span>   --version, -v           print the version
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fe6e6ccd4e8e0dd3bfb895625c7aa8ce">2.3.4 - govendor的使用</h1>
    
	<h1 id="1-govendor简介">1. govendor简介</h1>
<p>golang工程的依赖包经常使用go get 的方式来获取，例如：go get github.com/kardianos/govendor ，会将依赖包下载到GOPATH的路径下。</p>
<p>常用的依赖包管理工具有godep，govendor等，在Golang1.5之后，Go提供了 <code>GO15VENDOREXPERIMENT</code> 环境变量，用于将go build时的应用路径搜索调整成为 <code>当前项目目录/vendor</code> 目录方式。通过这种形式，我们可以实现类似于 <code>godep</code> 方式的项目依赖管理。</p>
<h1 id="2-安装与使用">2. 安装与使用</h1>
<h2 id="2-1-安装">2.1. 安装</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">get</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">v</span> <span style="color:#000">github</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">com</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">kardianos</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">govendor</span>
</span></span></code></pre></div><h2 id="2-2-使用">2.2. 使用</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#进入到项目目录</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /home/gopath/src/mytool
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#初始化vendor目录</span>
</span></span><span style="display:flex;"><span>govendor init
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#查看vendor目录</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@CC54425A mytool<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># ls</span>
</span></span><span style="display:flex;"><span>commands  main.go  vendor  mytool_test.sh
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#进入vendor目录</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> vendor
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#将GOPATH中本工程使用到的依赖包自动移动到vendor目录中</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#说明：如果本地GOPATH没有依赖包，先go get相应的依赖包</span>
</span></span><span style="display:flex;"><span>govendor add +external
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#通过设置环境变量 GO15VENDOREXPERIMENT=1 使用vendor文件夹构建文件。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#可以选择 export GO15VENDOREXPERIMENT=1 或 GO15VENDOREXPERIMENT=1 go build 执行编译</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">GO15VENDOREXPERIMENT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><h2 id="2-3-说明">2.3. 说明</h2>
<p>govendor只是用来管理项目的依赖包，如果GOPATH中本身没有项目的依赖包，则需要通过go get先下载到GOPATH中，再通过govendor add +external 拷贝到vendor目录中。</p>
<h1 id="3-govendor的配置文件">3. govendor的配置文件</h1>
<p><code>vendor.json</code>记录依赖包列表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;comment&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;ignore&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;test&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;package&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;checksumSHA1&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;uGalSICR4r7354vvKuNnh7Y/R/4=&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;github.com/urfave/cli&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;revision&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;b99aa811b4c1dd84cc6bccb8499c82c72098085a&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;revisionTime&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;2017-08-04T09:34:15Z&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;rootPath&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;mytool&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-govendor使用命令">4. govendor使用命令</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@CC54425A mytool<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># govendor</span>
</span></span><span style="display:flex;"><span>govendor <span style="color:#ce5c00;font-weight:bold">(</span>v1.0.8<span style="color:#ce5c00;font-weight:bold">)</span>: record dependencies and copy into vendor folder
</span></span><span style="display:flex;"><span>    -govendor-licenses    Show govendor<span style="color:#4e9a06">&#39;s licenses.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -version              Show govendor version
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -cpuprofile &#39;</span>file<span style="color:#4e9a06">&#39;    Writes a CPU profile to &#39;</span>file<span style="color:#4e9a06">&#39; for debugging.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    -memprofile &#39;</span>file<span style="color:#4e9a06">&#39;    Writes a heap profile to &#39;</span>file<span style="color:#a40000">&#39;</span> <span style="color:#204a87;font-weight:bold">for</span> debugging.
</span></span><span style="display:flex;"><span>Sub-Commands
</span></span><span style="display:flex;"><span>    init     Create the <span style="color:#4e9a06">&#34;vendor&#34;</span> folder and the <span style="color:#4e9a06">&#34;vendor.json&#34;</span> file.
</span></span><span style="display:flex;"><span>    list     List and filter existing dependencies and packages.
</span></span><span style="display:flex;"><span>    add      Add packages from <span style="color:#000">$GOPATH</span>.
</span></span><span style="display:flex;"><span>    update   Update packages from <span style="color:#000">$GOPATH</span>.
</span></span><span style="display:flex;"><span>    remove   Remove packages from the vendor folder.
</span></span><span style="display:flex;"><span>    status   Lists any packages missing, out-of-date, or modified locally.
</span></span><span style="display:flex;"><span>    fetch    Add new or update vendor folder packages from remote repository.
</span></span><span style="display:flex;"><span>    sync     Pull packages into vendor folder from remote repository with revisions
</span></span><span style="display:flex;"><span>                 from vendor.json file.
</span></span><span style="display:flex;"><span>    migrate  Move packages from a legacy tool to the vendor folder with metadata.
</span></span><span style="display:flex;"><span>    get      Like <span style="color:#4e9a06">&#34;go get&#34;</span> but copies dependencies into a <span style="color:#4e9a06">&#34;vendor&#34;</span> folder.
</span></span><span style="display:flex;"><span>    license  List discovered licenses <span style="color:#204a87;font-weight:bold">for</span> the given status or import paths.
</span></span><span style="display:flex;"><span>    shell    Run a <span style="color:#4e9a06">&#34;shell&#34;</span> to make multiple sub-commands more efficient <span style="color:#204a87;font-weight:bold">for</span> large
</span></span><span style="display:flex;"><span>                 projects.
</span></span><span style="display:flex;"><span>    go tool commands that are wrapped:
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;+status&#34;</span> package selection may be used with them
</span></span><span style="display:flex;"><span>    fmt, build, install, clean, test, vet, generate, tool
</span></span><span style="display:flex;"><span>Status Types
</span></span><span style="display:flex;"><span>    +local    <span style="color:#ce5c00;font-weight:bold">(</span>l<span style="color:#ce5c00;font-weight:bold">)</span> packages in your project
</span></span><span style="display:flex;"><span>    +external <span style="color:#ce5c00;font-weight:bold">(</span>e<span style="color:#ce5c00;font-weight:bold">)</span> referenced packages in GOPATH but not in current project
</span></span><span style="display:flex;"><span>    +vendor   <span style="color:#ce5c00;font-weight:bold">(</span>v<span style="color:#ce5c00;font-weight:bold">)</span> packages in the vendor folder
</span></span><span style="display:flex;"><span>    +std      <span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> packages in the standard library
</span></span><span style="display:flex;"><span>    +excluded <span style="color:#ce5c00;font-weight:bold">(</span>x<span style="color:#ce5c00;font-weight:bold">)</span> external packages explicitly excluded from vendoring
</span></span><span style="display:flex;"><span>    +unused   <span style="color:#ce5c00;font-weight:bold">(</span>u<span style="color:#ce5c00;font-weight:bold">)</span> packages in the vendor folder, but unused
</span></span><span style="display:flex;"><span>    +missing  <span style="color:#ce5c00;font-weight:bold">(</span>m<span style="color:#ce5c00;font-weight:bold">)</span> referenced packages but not found
</span></span><span style="display:flex;"><span>    +program  <span style="color:#ce5c00;font-weight:bold">(</span>p<span style="color:#ce5c00;font-weight:bold">)</span> package is a main package
</span></span><span style="display:flex;"><span>    +outside  +external +missing
</span></span><span style="display:flex;"><span>    +all      +all packages
</span></span><span style="display:flex;"><span>    Status can be referenced by their initial letters.
</span></span><span style="display:flex;"><span>Package specifier
</span></span><span style="display:flex;"><span>    &lt;path&gt;<span style="color:#ce5c00;font-weight:bold">[</span>::&lt;origin&gt;<span style="color:#ce5c00;font-weight:bold">][{</span>/...<span style="color:#000;font-weight:bold">|</span>/^<span style="color:#ce5c00;font-weight:bold">}][</span>@<span style="color:#ce5c00;font-weight:bold">[</span>&lt;version-spec&gt;<span style="color:#ce5c00;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>Ignoring files with build tags, or excluding packages from being vendored:
</span></span><span style="display:flex;"><span>    The <span style="color:#4e9a06">&#34;vendor.json&#34;</span> file contains a string field named <span style="color:#4e9a06">&#34;ignore&#34;</span>.
</span></span><span style="display:flex;"><span>    It may contain a space separated list of build tags to ignore when
</span></span><span style="display:flex;"><span>    listing and copying files.
</span></span><span style="display:flex;"><span>    This list may also contain package prefixes <span style="color:#ce5c00;font-weight:bold">(</span>containing a <span style="color:#4e9a06">&#34;/&#34;</span>, possibly
</span></span><span style="display:flex;"><span>    as last character<span style="color:#ce5c00;font-weight:bold">)</span> to exclude when copying files in the vendor folder.
</span></span><span style="display:flex;"><span>    If <span style="color:#4e9a06">&#34;foo/&#34;</span> appears in this field, <span style="color:#204a87;font-weight:bold">then</span> package <span style="color:#4e9a06">&#34;foo&#34;</span> and all its sub-packages
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo/bar&#34;</span>, …<span style="color:#ce5c00;font-weight:bold">)</span> will be excluded <span style="color:#ce5c00;font-weight:bold">(</span>but package <span style="color:#4e9a06">&#34;bar/foo&#34;</span> will not<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>    By default the init <span style="color:#204a87">command</span> adds the <span style="color:#4e9a06">&#34;test&#34;</span> tag to the ignore list.
</span></span><span style="display:flex;"><span>If using go1.5, ensure <span style="color:#000">GO15VENDOREXPERIMENT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span> is set.
</span></span></code></pre></div>
</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1b6f9e0d7b6230730879c41cc46010d3">3 - 顺序编程</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-f0665a4ffa073bc955e8985e7da650be">3.1 - 变量与常量</h1>
    
	<h1 id="1-变量">1.变量</h1>
<h2 id="1-1变量声明">1.1变量声明</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、单变量声明,类型放在变量名之后，可以为任意类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">变量名</span> <span style="color:#000">类型</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">v2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">v3</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#8f5902;font-style:italic">//多变量同类型声明
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、多变量声明
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">v1</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">v2</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-2变量初始化">1.2变量初始化</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、使用关键字var，声明变量类型并赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">v1</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、使用关键字var，直接对变量赋值，go可以自动推导出变量类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">v2</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//3、直接使用“：=”对变量赋值，不使用var，两者同时使用会语法冲突，推荐使用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">v3</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#0000cf;font-weight:bold">10</span>
</span></span></code></pre></div><h2 id="1-3变量赋值">1.3变量赋值</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、声明后再变量赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、多重赋值，经常使用在函数的多返回值中，err,v=func(arg)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">i</span><span style="color:#a40000">，</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">i</span>  <span style="color:#8f5902;font-style:italic">//两者互换，并不需要引入中间变量
</span></span></span></code></pre></div><h2 id="1-4匿名变量">1.4匿名变量</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Go中所有声明后的变量都需要调用到，当出现函数多返回值，并且部分返回值不需要使用时，可以使用匿名变量丢弃该返回值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">GetName</span><span style="color:#000;font-weight:bold">()(</span><span style="color:#000">firstName</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">lastName</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">nickName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;May&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;Chan&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;Make&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">nickName</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000">GetName</span><span style="color:#000;font-weight:bold">()</span>  <span style="color:#8f5902;font-style:italic">//使用匿名变量丢弃部分返回值
</span></span></span></code></pre></div><h1 id="2-常量">2.常量</h1>
<p>​	Go语言中，常量是编译时期就已知且不可变的值，常量可以是数值类型（整型、浮点型、复数类型）、布尔类型、字符串类型。</p>
<h2 id="2-1字面常量">2.1字面常量</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//字面常量(literal)指程序中硬编码的常量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">3.14</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">“</span><span style="color:#000">foo</span><span style="color:#a40000">”</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">true</span>
</span></span></code></pre></div><h2 id="2-2常量定义">2.2常量定义</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、可以限定常量类型，但非必需
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Pi</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3.14</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、无类型常量和字面常量一样
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">zero</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0.0</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//3、多常量赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">size</span> <span style="color:#204a87;font-weight:bold">int64</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1024</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">eof</span><span style="color:#000;font-weight:bold">=</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//4、常量的多重赋值，类似变量的多重赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">float32</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;foo&#34;</span>    <span style="color:#8f5902;font-style:italic">//无类型常量的多重赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//5、常量赋值是编译期行为，可以赋值为一个编译期运算的常量表达式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">mask</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span></code></pre></div><h2 id="2-3预定义常量">2.3预定义常量</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//预定义常量：true、false、iota
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//iota：可修改常量，在每次const出现时被重置为0，在下一个const出现前，每出现一次iota，其代表的值自动增1。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">(</span>          <span style="color:#8f5902;font-style:italic">//iota重置为0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">c0</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">iota</span>       <span style="color:#8f5902;font-style:italic">//c0==0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">c1</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">iota</span>       <span style="color:#8f5902;font-style:italic">//c1==1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">c2</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">iota</span>       <span style="color:#8f5902;font-style:italic">//c2==2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//两个const赋值语句一样可以省略后一个
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">(</span>          <span style="color:#8f5902;font-style:italic">//iota重置为0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">c0</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">iota</span>       <span style="color:#8f5902;font-style:italic">//c0==0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">c1</span>            <span style="color:#8f5902;font-style:italic">//c1==1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">c2</span>            <span style="color:#8f5902;font-style:italic">//c2==2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-4枚举">2.4枚举</h2>
<p>枚举指一系列相关常量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Sunday</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">iota</span>    <span style="color:#8f5902;font-style:italic">//Sunday==0,以此类推
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">Monday</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Tuesday</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Wednesday</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Thursday</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Friday</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Saturday</span>       <span style="color:#8f5902;font-style:italic">//大写字母开头表示包外可见
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">numberOfDays</span>   <span style="color:#8f5902;font-style:italic">//小写字母开头表示包内私有
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8c5a55e97fdbfcfbb8f91043c01b4c7d">3.2 - 数据类型</h1>
    
	<h1 id="类型">类型</h1>
<h1 id="1-基础类型">1. 基础类型</h1>
<h2 id="1-1-布尔类型">1.1. 布尔类型</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//布尔类型的关键字为bool,值为true或false，不可写为0或1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">v1</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//接受表达式判断赋值，不支持自动或强制类型转换
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">v2</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="1-2-整型">1.2. 整型</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578665/article/golang/basics/int.png" alt="这里写图片描述"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、类型表示
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//int和int32为不同类型，不会自动类型转换需要强制类型转换
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//强制类型转换需注意精度损失（浮点数→整数），值溢出（大范围→小范围）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">v2</span> <span style="color:#204a87;font-weight:bold">int32</span>
</span></span><span style="display:flex;"><span><span style="color:#000">v1</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span><span style="color:#000">v2</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、数值运算,支持“+,-,*,/和%”
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#8f5902;font-style:italic">//求余
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//3、比较运算,“&lt;,&gt;,==,&gt;=,&lt;=,!=”
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//不同类型不能进行比较例如int和int8，但可以与字面常量（literal）进行比较
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int32</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">j</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#000">j</span>  <span style="color:#8f5902;font-style:italic">//编译错误，不同类型不能进行比较
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#0000cf;font-weight:bold">2</span>  <span style="color:#8f5902;font-style:italic">//编译通过，可以与字面常量（literal）进行比较
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//4、位运算
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Go(^x)取反与C语言(~x)不同，其他类似，具体见下表
</span></span></span></code></pre></div><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578663/article/golang/basics/bit-operation.png" alt="这里写图片描述"></p>
<h2 id="1-3-浮点型">1.3. 浮点型</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、浮点型分为float32(类似C中的float)，float64(类似C中的double)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">f1</span> <span style="color:#204a87;font-weight:bold">float32</span>
</span></span><span style="display:flex;"><span><span style="color:#000">f1</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">12</span>     <span style="color:#8f5902;font-style:italic">//不加小数点，被推导为整型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">f2</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#0000cf;font-weight:bold">12.0</span>  <span style="color:#8f5902;font-style:italic">//加小数点，被推导为float64
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">f1</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87">float32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f2</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">//需要执行强制转换
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、浮点数的比较
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//浮点数不是精确的表达方式，不能直接使用“==”来判断是否相等，可以借用math的包math.Fdim 
</span></span></span></code></pre></div><h2 id="1-4-复数类型">1.4. 复数类型</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、复数的表示
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">v1</span> <span style="color:#204a87;font-weight:bold">complex64</span>
</span></span><span style="display:flex;"><span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3.2</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">12i</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//v1 v2 v3 表示为同一个数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">v2</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#0000cf;font-weight:bold">3.2</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">12i</span>
</span></span><span style="display:flex;"><span><span style="color:#000">v3</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87">complex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3.2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、实部与虚部
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//z=complex(x,y),通过内置函数实部x=real(z),虚部y=imag(z)
</span></span></span></code></pre></div><h2 id="1-5-字符串">1.5. 字符串</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明与赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">str</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000">str</span><span style="color:#000;font-weight:bold">=</span><span style="color:#4e9a06">&#34;hello world&#34;</span>
</span></span></code></pre></div><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578664/article/golang/basics/string.png" alt="这里写图片描述"></p>
<h2 id="1-6-字符类型">1.6. 字符类型</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、byte，即uint8的别名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、rune，即Unicode
</span></span></span></code></pre></div><h2 id="1-7-错误类型-error">1.7. 错误类型（error）</h2>
<h1 id="2-复合类型">2. 复合类型</h1>
<h2 id="2-1-数组-array">2.1. 数组(array)</h2>
<p>数组表示同一类型数据，数组长度定义后就不可更改，长度是数组内的一个内置常量，可通过len()来获取。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、创建数组
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">array1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span>    <span style="color:#8f5902;font-style:italic">//声明：var 变量名 类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">array2</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">=[</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">}</span>   <span style="color:#8f5902;font-style:italic">//初始化
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">array3</span><span style="color:#a40000">：</span><span style="color:#000;font-weight:bold">=[</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">}</span>    <span style="color:#8f5902;font-style:italic">//直接用“：=”赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#8f5902;font-style:italic">//二维数组
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">float</span>  <span style="color:#8f5902;font-style:italic">//指针数组
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、元素访问
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">array</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//第一个返回值为数组下标，第二个为元素的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//3、值类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//数组在Go中作为一个值类型，值类型在赋值和函数参数传递时，只复制副本，因此在函数体中并不能改变数组的内容，需用指针来改变数组的值。
</span></span></span></code></pre></div><h2 id="2-2-切片-slice">2.2. 切片(slice)</h2>
<p>​	数组在定义了长度后无法改变，且作为值类型在传递时产生副本，并不能改变数组元素的值。因此切片的功能弥补了这个不足，切片类似指向数组的一个指针。可以抽象为三个变量：指向数组的指针；切片中元素的个数(len函数)；已分配的存储空间(cap函数)。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、创建切片
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//a)基于数组创建
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">myArray</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">=[</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">]{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">mySlice</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000">myArray</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">last</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">slice1</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000">myArray</span><span style="color:#000;font-weight:bold">[:]</span>   <span style="color:#8f5902;font-style:italic">//基于数组所有元素创建
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">slice2</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000">myArray</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span>  <span style="color:#8f5902;font-style:italic">//基于前三个元素创建
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">slice3</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000">myArray</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">:]</span>  <span style="color:#8f5902;font-style:italic">//基于第3个元素开始后的所有元素创建
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//b)直接创建
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">slice1</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>       <span style="color:#8f5902;font-style:italic">//元素初始值为0，初始个数为5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">slice2</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>    <span style="color:#8f5902;font-style:italic">//元素初始值为0，初始个数为5，预留个数为10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">slice3</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">}</span>    <span style="color:#8f5902;font-style:italic">//初始化赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//c)基于切片创建
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">oldSlice</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">newSlice</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000">oldSlice</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span>   <span style="color:#8f5902;font-style:italic">//基于切片创建，不能超过原切片的存储空间(cap函数的值)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、元素遍历
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">slice</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//与数组的方式一致，使用range来遍历
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//第一个返回值(i)为索引，第二个为元素的值(v)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//3、动态增减元素
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//切片分存储空间(cap)和元素个数(len)，当存储空间小于实际的元素个数，会重新分配一块原空间2倍的内存块，并将原数据复制到该内存块中，合理的分配存储空间可以以空间换时间，降低系统开销。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//添加元素
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">newSlice</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldSlice</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic">//直接将元素加进去，若存储空间不够会按上述方式扩容。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">newSlice1</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldSlice1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">oldSlice2</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">//将oldSlice2的元素打散后加到oldSlice1中，三个点不可省略。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//4、内容复制
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//copy()函数可以复制切片，如果切片大小不一样，按较小的切片元素个数进行复制
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">slice1</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">slice2</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">slice2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">slice1</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic">//只会复制slice1的前三个元素到slice2中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">slice1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">slice1</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic">//只会复制slice2的三个元素到slice1中的前三个位置
</span></span></span></code></pre></div><h2 id="2-3-键值对-map">2.3. 键值对(map)</h2>
<p>map是一堆键值对的未排序集合。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、先声明后创建再赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">map1</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">键类型</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">值类型</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">map1</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">键类型</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">值类型</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">map1</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">键类型</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">值类型</span> <span style="color:#000">存储空间</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">map1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">]=</span><span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 直接创建
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">m2</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 然后赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">m2</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;aa&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">m2</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;bb&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 初始化 + 赋值一体化
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">m3</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;aa&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bb&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、元素删除
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//delete()函数删除对应key的键值对，如果key不存在，不会报错；如果value为nil，则会抛出异常(panic)。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">map1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//3、元素查找
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000">myMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ok</span><span style="color:#000;font-weight:bold">{</span><span style="color:#8f5902;font-style:italic">//如果找到
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//处理找到的value值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//遍历
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">myMap</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">//处理key或value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>map可以用来判断一个值是否在切片或数组中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 判断某个类型（假如为myType）的值是否在切片或数组（假如为myList）中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 构造一个map,key的类型为myType,value为bool型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">myMap</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">myType</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">myList</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">myType</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">value1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value2</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 将切片中的值存为map中的key（因为key不能重复）,map的value都为true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">myList</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">myMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 判断valueX是否在myList中，即判断其是否在myMap的key中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">myMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">valueX</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 如果valueX 在myList中，执行后续操作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-4-指针-pointer">2.4. 指针(pointer)</h2>
<p>具体参考<a href="https://www.huweihuang.com/golang-notes/oop/pointer.html">Go语言指针详解</a></p>
<h2 id="2-5-结构体-struct">2.5. 结构体(struct)</h2>
<p>具体参考<a href="https://www.huweihuang.com/golang-notes/oop/struct-method.html">Go面向对象编程之结构体</a></p>
<h2 id="2-6-接口-interface">2.6. 接口(interface)</h2>
<p>具体参考<a href="https://www.huweihuang.com/golang-notes/oop/interface/interface.html">Go面向对象编程之接口</a></p>
<h2 id="2-7-通道-chan">2.7. 通道(chan)</h2>
<p>具体参考<a href="https://www.huweihuang.com/golang-notes/concurrency/channel.html">Go并发编程之channel</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-46a114232811022faa125b8294f17449">3.3 - 流程语句</h1>
    
	<h1 id="流程语句">流程语句</h1>
<h2 id="1-条件语句">1. 条件语句</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//在if之后条件语句之前可以添加变量初始化语句，用;号隔离
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000">条件语句</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>    <span style="color:#8f5902;font-style:italic">//条件语句不需要用括号括起来，花括号必须存在
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//语句体
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span><span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//语句体
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//在有返回值的函数中，不允许将最后的return语句放在if...else...的结构中，否则会编译失败
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//例如以下为错误范例
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">example</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span><span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">x</span>  <span style="color:#8f5902;font-style:italic">//最后的return语句放在if-else结构中，所以编译失败
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-选择语句">2. 选择语句</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、根据条件不同，对应不同的执行体
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;0&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span>                <span style="color:#8f5902;font-style:italic">//满足条件就会退出，只有添加fallthrough才会继续执行下一个case语句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prinntf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#8f5902;font-style:italic">//单个case可以出现多个选项
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;2,3,1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#8f5902;font-style:italic">//当都不满足以上条件时，执行default语句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Default&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、该模式等价于多个if-else的功能
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000">条件表达式1</span><span style="color:#000;font-weight:bold">&gt;:</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#000">语句体1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000">条件表达式2</span><span style="color:#000;font-weight:bold">&gt;:</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#000">语句体2</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-循环语句">3. 循环语句</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、Go只支持for关键字，不支持while，do-while结构
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">{</span>    <span style="color:#8f5902;font-style:italic">//支持多个赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//语句体
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、无限循环
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#000;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">//不接条件表达式表示无限循环
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">sum</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">break</span>   <span style="color:#8f5902;font-style:italic">//满足条件跳出循环
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//3、支持continue和break，break可以指定中断哪个循环，break JLoop(标签)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">break</span> <span style="color:#000">JLoop</span>   <span style="color:#8f5902;font-style:italic">//终止JLoop标签处的外层循环
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">JLoop</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#8f5902;font-style:italic">//标签处
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><h2 id="4-跳转语句">4. 跳转语句</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//关键字goto支持跳转
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">myfunc</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">HERE</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#8f5902;font-style:italic">//定义标签处
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">HERE</span>     <span style="color:#8f5902;font-style:italic">//跳转到标签处
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-76885969b59488f67b4016e7f549d7d9">3.4 - 函数与闭包</h1>
    
	<h1 id="函数">函数</h1>
<h2 id="1-函数定义与调用">1. 函数定义与调用</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、函数组成：关键字func ,函数名，参数列表，返回值，函数体，返回语句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//先名称后类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">函数名</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">参数列表</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">返回值列表</span><span style="color:#000;font-weight:bold">){</span>  <span style="color:#8f5902;font-style:italic">//参数列表和返回值列表以变量声明的形式，如果单返回值可以直接加类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">函数体</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span>    <span style="color:#8f5902;font-style:italic">//返回语句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//例子
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">b</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">ret</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//函数体 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span>   <span style="color:#8f5902;font-style:italic">//return语句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、函数调用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//先导入函数所在的包，直接调用函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;mymath&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sum</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000">mymath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic">//多返回值和错误处理机制
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//可见性，包括函数、类型、变量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//本包内可见(private)：小写字母开头
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//包外可见(public)：大写字母开头
</span></span></span></code></pre></div><h2 id="2-不定参数">2. 不定参数</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、不定参数的类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">myfunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">){</span>   <span style="color:#8f5902;font-style:italic">//...type不定参数的类型，必须是最后一个参数，本质是切片
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">arg</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//函数调用,传参可以选择多个，个数不定
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">myfunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">myfunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、不定参数的传递，假如有个变参函数myfunc2(args ...int)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">myfunc1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//按原样传递
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">myfunc2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//传递切片
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">myfunc2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:]</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//3、任意类型的不定参数，使用interface{}作为指定类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">format</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}){</span>   <span style="color:#8f5902;font-style:italic">//此为标准库中fmt.Printf()函数的原型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//函数体
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-多返回值">3. 多返回值</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//多返回值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//使用下划线&#34;_&#34;来丢弃返回值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">_</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="4-匿名函数">4. 匿名函数</h2>
<p>匿名函数：不带函数名的函数，可以像变量一样被传递。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">b</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">z</span> <span style="color:#204a87;font-weight:bold">float32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">//没有函数名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">f</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">y</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">y</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-闭包">5. 闭包</h2>
<h3 id="5-1-闭包的概念">5.1. 闭包的概念</h3>
<p>闭包是可以包含自由变量（未绑定到特定的对象）的代码块，这些变量不在代码块内或全局上下文中定义，而在定义代码块的环境中定义。要执行的代码块为自由变量提供绑定的计算环境（作用域）。</p>
<h3 id="5-2-闭包的价值">5.2. 闭包的价值</h3>
<p>闭包的价值在于可以作为一个变量对象来进行传递和返回。即可以把函数本身看作是一个变量。</p>
<h3 id="5-3-go中的闭包">5.3. Go中的闭包</h3>
<p>Go闭包是指引用了函数外的变量的一种函数，这样该函数就被绑定在某个变量上，只要闭包还被使用则引用的变量会一直存在。</p>
<p>Go的匿名函数是一个闭包，Go闭包常用在go和defer关键字中。</p>
<h3 id="5-4-闭包的坑">5.4. 闭包的坑</h3>
<p>在for range中goroutine的方式使用闭包，如果没有给匿名函数传入一个变量，或新建一个变量存储迭代的变量，那么goroutine执行的结果会是最后一个迭代变量的结果，而不是每个迭代变量的结果。这是因为如果没有通过一个变量来拷贝迭代变量，那么闭包因为绑定了变量，当每个groutine运行时，迭代变量可能被更改。</p>
<p>示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// false, print 3 3 3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">values</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">values</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// true, print 1 2 3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">values</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">val</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-5-闭包的示例">5.5 闭包的示例</h3>
<blockquote>
<p>closure.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">j</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;i, j: %d, %d\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">a</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">*=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">a</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-6-闭包的参考链接">5.6 闭包的参考链接</h3>
<ul>
<li><a href="https://tour.golang.org/moretypes/25">https://tour.golang.org/moretypes/25</a></li>
<li><a href="https://golang.org/doc/faq#closures_and_goroutines">https://golang.org/doc/faq#closures_and_goroutines</a></li>
<li><a href="https://github.com/golang/go/wiki/CommonMistakes">https://github.com/golang/go/wiki/CommonMistakes</a></li>
</ul>
<p>参考：</p>
<ul>
<li>《Go语言编程》</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-87f83fc3da9f5dcbb6bebac4f77c1552">3.5 - 错误处理</h1>
    
	<h1 id="错误处理">错误处理</h1>
<h2 id="1-error接口">1. error接口</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//定义error接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Error</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//调用error接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Foo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000">Foo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//错误处理
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span><span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//使用返回值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-defer-延迟函数">2. defer[延迟函数]</h2>
<p>语法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">function_name</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>1）defer在声明时不会执行，而是推迟执行，在return执行前，倒序执行defer[先进后出]，一般用于释放资源，清理数据，记录日志，异常处理等。</p>
<p>2）defer有一个特性：即使函数抛出异常，defer仍会被执行，这样不会出现程序错误导致资源不被释放，或者因为第三方包的异常导致程序崩溃。</p>
<p>3）一般用于打开文件后释放资源的操作，比如打开一个文件，最后总是要关闭的。而在打开和关闭之间，会有诸多的处理，可能会有诸多的if-else、根据不同的情况需要提前返回</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">do_something</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">condition_a</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">do_something_again</span><span style="color:#000;font-weight:bold">()</span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">condition_b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">do_further_things</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>4）defer示例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">deferTest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">number</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">number</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;three:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">number</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;two:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">number</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;one:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">number</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;函数返回值：&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">deferTest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">one: 1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">two: 2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">three: 3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">函数返回值： 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">*/</span>
</span></span></code></pre></div><h2 id="3-panic-和recover">3. panic()和recover()</h2>
<p>Go中使用内置函数<code>panic()</code>和<code>recover()</code>来处理程序中的错误。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#204a87">recover</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></div><h3 id="3-1-panic">3.1. panic()</h3>
<p>当函数执行触发了panic()函数时，如果没有使用到defer关键字，函数执行流程会被立即终止；如果使用了defer关键字，则会逐层执行defer语句，直到所有的函数被终止。</p>
<p>错误信息，包括panic函数传入的参数，将会被报告出来。</p>
<p>示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">404</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;network broken&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;file not exists&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h3 id="3-2-recover">3.2. recover()</h3>
<p>recover()函数用于终止错误处理流程。一般使用在defer关键字后以有效截取错误处理流程。如果没有在发生异常的goroutine中明确调用恢复过程（使用recover关键字） ，会导致该goroutine所属的进程打印异常信息后直接退出。</p>
<p>示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">recover</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Runtime error caught: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">foo</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>无论foo()中是否触发了错误处理流程，该匿名defer函数都将在函数退出时得到执行。假如foo()中触发了错误处理流程， recover()函数执行将使得该错误处理过程终止。如果错误处理流程被触发时，程序传给panic函数的参数不为nil，则该函数还会打印详细的错误信息。</p>
<p>参考：</p>
<ul>
<li>《Go语言编程》</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d086e553801ce3fd465423ac202cff1b">4 - 面向对象编程</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-19c2e8fbc544b71642681669ddea0828">4.1 - Golang系列（二）之面向对象编程</h1>
    
	<ul>
<li><strong>面向对象编程</strong></li>
</ul>
<p>​       把一组数据结构和处理它们的方法组成对象（object），把相同行为的对象归纳为类（class），通过类的封装（encapsulation）隐藏内部细节，通过继承（inheritance）实现类的特化（specialization）[方法的重写，子类不同于父类的特性]／泛化（generalization）[共性，子类都拥有父类的特性]，通过多态（polymorphism）实现基于对象类型的动态分派（dynamic dispatch）。</p>
<ul>
<li><strong>面对对象思想</strong></li>
</ul>
<p>​       面向对象思想是对现实世界事物的抽象，系统中一切事物皆为对象；对象是属性及其操作的封装体；对象可按其性质划分为类，对象成为类的实例；实例关系和继承关系是对象之间的静态关系；消息传递是对象之间动态联系的唯一形式，也是计算的唯一形式；方法是消息的序列。</p>
<h2 id="一-类型系统-类的声明">（一）类型系统[类的声明]</h2>
<p>类型系统：</p>
<ul>
<li>一组基本类型构成的“基本类型集合”；</li>
<li>“基本类型集合”上定义的一系列组合、运算、转换方法。</li>
</ul>
<p>类型系统包括基础类型（byte、int、bool、float等）；复合类型（数组、结构体、指针等）；可以指向任何对象的类型（Any类型，类似Java的Object类型）；值语义和引用语义；面向对象类型；接口。Go大多数类型为值语义，可以给任何类型添加方法（包括内置类型，不包括指针类型）。Any类型是空接口即interface{}。</p>
<h3 id="1-方法">1.方法</h3>
<p>1、为类型添加方法[类方法声明]，方法即为有接收者的函数
func (对象名 对象类型) 函数名(参数列表) (返回值列表)
可随时为某个对象添加方法即为某个方法添加归属对象（receiver），以方法为中心
在Go语言中没有隐藏的this指针，即显示传递，形参即为this，例如以下的形参为a。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Integer</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span> <span style="color:#000">Integer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Less</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#000">Integer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">//表示a这个对象定义了Less这个方法，a可以为任意类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000">b</span>                           
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//类型基于值传递，如果要修改值需要传递指针
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Integer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#000">Integer</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">+=</span><span style="color:#000">b</span>    <span style="color:#8f5902;font-style:italic">//通过指针传递来改变值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-值语义和引用语义">2.值语义和引用语义</h3>
<p>值类型：b的修改并不会影响a的值</p>
<p>引用类型：b的修改会影响a的值</p>
<p>Go大多类型为值语义，包括基本类型：byte，int，string等；复合类型：数组，结构体(struct)，指针等</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、值语义和引用语义
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000">a</span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Modify</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//值类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">=[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000">a</span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic">//a=[1,2,3]  b=[1,3,3]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//引用类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">:=&amp;</span><span style="color:#000">a</span>              <span style="color:#8f5902;font-style:italic">//b指向a,即为a的地址，对b指向的值改变实际上就是对a的改变（数组本身就是一种地址指向）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">//a=[1,3,3]  b=[1,3,3]   //*b,取地址指向的值
</span></span></span></code></pre></div><h3 id="3-结构体">3.结构体</h3>
<p>3、结构体[类属性的声明]
struct的功能类似Java的class，可实现嵌套组合(类似继承的功能)
struct实际上就是一种复合类型，只是对类中的属性进行定义赋值，并没有对方法进行定义，方法可以随时定义绑定到该类的对象上，更具灵活性。可利用嵌套组合来实现类似继承的功能避免代码重复。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Rect</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>   <span style="color:#8f5902;font-style:italic">//定义矩形类
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">y</span> <span style="color:#204a87;font-weight:bold">float64</span>       <span style="color:#8f5902;font-style:italic">//类型只包含属性，并没有方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">width</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">height</span> <span style="color:#204a87;font-weight:bold">float64</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Rect</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Area</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">{</span>    <span style="color:#8f5902;font-style:italic">//为Rect类型绑定Area的方法，*Rect为指针引用可以修改传入参数的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">width</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">height</span>         <span style="color:#8f5902;font-style:italic">//方法归属于类型，不归属于具体的对象，声明该类型的对象即可调用该类型的方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="二-初始化-实例化对象">（二）初始化[实例化对象]</h2>
<p>数据初始化的内建函数new()与make()，二者都是用来分配空间。区别如下:</p>
<ul>
<li><strong>new()</strong></li>
</ul>
<ol>
<li>func new(Type) *Type</li>
<li>内置函数 <code>new</code> 分配空间。传递给<code>new</code> 函数的是一个<strong>类型</strong>，不是一个值。返回值是指向这个新分配的零值的<strong>指针</strong></li>
</ol>
<ul>
<li><strong>make()</strong></li>
</ul>
<ol>
<li>func make(Type, size IntegerType) Type</li>
<li>内建函数 <code>make</code> 分配并且初始化 一个 slice, 或者 map 或者 chan 对象。 并且只能是这三种对象。 和 <code>new</code> 一样，第一个参数是 类型，不是一个值。 但是<code>make</code> 的返回值就是这个类型（即使一个引用类型），而不是指针。 具体的返回值，依赖具体传入的类型。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建实例
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">rect1</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Rect</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic">//new一个对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">rect2</span><span style="color:#ce5c00;font-weight:bold">:=&amp;</span><span style="color:#000">Rect</span><span style="color:#000;font-weight:bold">{}</span>     <span style="color:#8f5902;font-style:italic">//为赋值默认值，bool默认值为false，int默认为零值0，string默认为空字符串
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">rect3</span><span style="color:#ce5c00;font-weight:bold">:=&amp;</span><span style="color:#000">Rect</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">}</span>     <span style="color:#8f5902;font-style:italic">//取地址并赋值,按声明的变量顺序依次赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">rect4</span><span style="color:#ce5c00;font-weight:bold">:=&amp;</span><span style="color:#000">Rect</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">width</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">height</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">}</span>    <span style="color:#8f5902;font-style:italic">//按变量名赋值不按顺序赋值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//构造函数：没有构造参数的概念，通常由全局的创建函数NewXXX来实现构造函数的功能
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewRect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">width</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">height</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Rect</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Rect</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">width</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">height</span><span style="color:#000;font-weight:bold">}</span>     <span style="color:#8f5902;font-style:italic">//利用指针来改变传入参数的值达到类似构造参数的效果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//方法的重载,Go不支持方法的重载（函数同名，参数不同）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//v …interface{}表示参数不定的意思，其中v是slice类型，及声明不定参数，可以传入任意参数，实现类似方法的重载
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">poem</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Poem</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">recite</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="三-匿名组合-继承">（三）匿名组合[继承]</h2>
<p>​       组合，即方法代理，例如A包含B，即A通过消息传递的形式代理了B的方法，而不需要重复写B的方法。</p>
<p>​       继承是指这样一种能力：它可以使用现有类的所有功能，并在无需重新编写原来的类的情况下对这些功能进行扩展。继承主要为了代码复用，继承也可以扩展已存在的代码模块（类）。</p>
<p>​       严格来讲，继承是“a kind of ”，即子类是父类的一种，例如student是person的一种；组合是“a part of”，即父类是子类中的一部分，例如眼睛是头部的一部分。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、匿名组合的方式实现了类似Java继承的功能，可以实现多继承
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Base</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">base</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Base</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Foo</span><span style="color:#000;font-weight:bold">(){</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>    <span style="color:#8f5902;font-style:italic">//Base的Foo()方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">base</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Base</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Bar</span><span style="color:#000;font-weight:bold">(){</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>    <span style="color:#8f5902;font-style:italic">//Base的Bar()方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Foo</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000">Base</span>                         <span style="color:#8f5902;font-style:italic">//通过组合的方式声明了基类，即继承了基类
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">foo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Foo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Bar</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">foo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Base</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bar</span><span style="color:#000;font-weight:bold">()</span>               <span style="color:#8f5902;font-style:italic">//并改写了基类的方法，该方法实现时先调用基类的Bar()方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#ce5c00;font-weight:bold">...</span>                          <span style="color:#8f5902;font-style:italic">//如果没有改写即为继承，调用foo.Foo()和调用foo.Base.Foo()的作用的一样的
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//修改内存布局
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Foo</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>   <span style="color:#8f5902;font-style:italic">//其他成员信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">Base</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//以指针方式组合
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Foo</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Base</span>   <span style="color:#8f5902;font-style:italic">//以指针方式派生，创建Foo实例时，需要外部提供一个Base类实例的指针
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//名字冲突问题,组合内外如果出现名字重复问题，只会访问到最外层，内层会被隐藏，不会报错，即类似java中方法覆盖/重写。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">X</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Y</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">X</span>             <span style="color:#8f5902;font-style:italic">//Y.X.Name会被隐藏，内层会被隐藏
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>   <span style="color:#8f5902;font-style:italic">//只会访问到Y.Name，只会调用外层属性
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="四-可见性-封装">（四）可见性[封装]</h2>
<p>​       封装，也就是把客观事物封装成抽象的类，并且类可以把自己的数据和方法只让可信的类或者对象操作，对不可信的进行信息隐藏。</p>
<p>​       <strong>封装的本质或目的其实程序对信息(数据)的控制力。封装分为两部分：该隐藏的隐藏，该暴露的暴露。封装可以隐藏实现细节，使得代码模块化。</strong></p>
<p>​       Go中用大写字母开头来表示public，可以包外访问；小写字母开头来表示private，只能包内访问；访问性是包级别非类型级别
​       如果可访问性是类型一致的，可以加friend关键字表示朋友关系可互相访问彼此的私有成员(属性和方法)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Rect</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">X</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">Y</span> <span style="color:#204a87;font-weight:bold">float64</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Width</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">Height</span> <span style="color:#204a87;font-weight:bold">float64</span>           <span style="color:#8f5902;font-style:italic">//字母大写开头表示该属性可以由包外访问到
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Rect</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">area</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">{</span>   <span style="color:#8f5902;font-style:italic">//字母小写开头表示该方法只能包内调用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Width</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Height</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="五-接口-多态">（五）接口[多态]</h2>
<p>​       多态性（polymorphisn）是允许你将父对象设置成为和一个或更多的他的子对象相等的技术，赋值之后，父对象就可以根据当前赋值给它的子对象的特性以不同的方式运作。</p>
<p>​       简而言之，就是允许将子类类型的指针赋值给父类类型的指针。</p>
<p>​       即一个引用变量倒底会指向哪个类的实例对象，该引用变量发出的方法调用到底是哪个类中实现的方法，必须在由程序运行期间才能决定。不修改程序代码就可以改变程序运行时所绑定的具体代码，让程序可以选择多个运行状态，这就是多态性。多态分为编译时多态（静态多态）和运行时多态（动态多态），编译时多态一般通过方法重载实现，运行时多态一般通过方法重写实现。</p>
<h3 id="5-1接口概念">5.1接口概念</h3>
<p>​      接口即一组方法的集合，定义了对象的一组行为，方法包含实际的代码。换句话说，一个接口就是定义（规范或约束），而方法就是实现，接口的作用应该是将定义与实现分离，降低耦合度。习惯用“er”结尾来命名，例如“Reader”。接口与对象的关系是多对多，即一个对象可以实现多个接口，一个接口也可以被多个对象实现。</p>
<p>​      接口是Go语言整个类型系统的基石，其他语言的接口是不同组件之间的契约的存在，对契约的实现是强制性的，必须显式声明实现了该接口，这类接口称之为“侵入式接口”。而Go语言的接口是隐式存在，只要实现了该接口的所有函数则代表已经实现了该接口，并不需要显式的接口声明。</p>
<ul>
<li><strong>接口的比喻</strong></li>
</ul>
<p>​     你的电脑上只有一个USB接口。这个USB接口可以接MP3，数码相机，摄像头，鼠标，键盘等。。。所有的上述硬件都可以公用这个接口，有很好的扩展性，该USB接口定义了一种规范，只要实现了该规范，就可以将不同的设备接入电脑，而设备的改变并不会对电脑本身有什么影响（低耦合）。</p>
<ul>
<li><strong>面向接口编程</strong></li>
</ul>
<p>​      接口表示调用者和设计者的一种约定，在多人合作开发同一个项目时，事先定义好相互调用的接口可以大大提高开发的效率。接口是用类来实现的，实现接口的类必须严格按照接口的声明来实现接口提供的所有功能。有了接口，就可以在不影响现有接口声明的情况下，修改接口的内部实现，从而使兼容性问题最小化。
​      当其他设计者调用了接口后，就不能再随意更改接口的定义，否则项目开发者事先的约定就失去了意义。但是可以在类中修改相应的代码，完成需要改动的内容。</p>
<h3 id="5-2非侵入式接口">5.2非侵入式接口</h3>
<p>非侵入式接口：一个类只需要实现了接口要求的所有函数就表示实现了该接口，并不需要显式声明</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">File</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//类的属性
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//File类的方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Seek</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">off</span> <span style="color:#204a87;font-weight:bold">int64</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">whence</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pos</span> <span style="color:#204a87;font-weight:bold">int64</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//接口1：IFile
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">IFile</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Seek</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">off</span> <span style="color:#204a87;font-weight:bold">int64</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">whence</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pos</span> <span style="color:#204a87;font-weight:bold">int64</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//接口2：IReader
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">IReader</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//接口赋值,File类实现了IFile和IReader接口，即接口所包含的所有方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">file1</span> <span style="color:#000">IFile</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">file2</span> <span style="color:#000">IReader</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="5-3接口赋值">5.3接口赋值</h3>
<p>只要类实现了该接口的所有方法，即可将该类赋值给这个接口，接口主要用于多态化方法。即对接口定义的方法，不同的实现方式。</p>
<p>接口赋值：
<strong>1）将对象实例赋值给接口</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">IUSB</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">//定义IUSB的接口方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//方法定义在类外，绑定该类，以下为方便，备注写在类中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">MP3</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">//实现IUSB的接口，具体实现方式是MP3的方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Mouse</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">//实现IUSB的接口，具体实现方式是Mouse的方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//接口赋值给具体的对象实例MP3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">usb</span> <span style="color:#000">IUSB</span> <span style="color:#000;font-weight:bold">=</span><span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MP3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">usb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">usb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//接口赋值给具体的对象实例Mouse
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">usb</span> <span style="color:#000">IUSB</span> <span style="color:#000;font-weight:bold">=</span><span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Mouse</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">usb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">usb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><strong>2）将接口赋值给另一个接口</strong></p>
<ol>
<li>只要两个接口拥有相同的方法列表（与次序无关），即是两个相同的接口，可以相互赋值</li>
<li>接口赋值只需要接口A的方法列表是接口B的子集（即假设接口A中定义的所有方法，都在接口B中有定义），那么B接口的实例可以赋值给A的对象。反之不成立，即子接口B包含了父接口A，因此可以将子接口的实例赋值给父接口。</li>
<li>即子接口实例实现了子接口的所有方法，而父接口的方法列表是子接口的子集，则子接口实例自然实现了父接口的所有方法，因此可以将子接口实例赋值给父接口。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Writer</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{</span>    <span style="color:#8f5902;font-style:italic">//父接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ReadWriter</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{</span>    <span style="color:#8f5902;font-style:italic">//子接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">file1</span> <span style="color:#000">ReadWriter</span><span style="color:#000;font-weight:bold">=</span><span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic">//子接口实例
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">file2</span> <span style="color:#000">Writer</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000">file1</span>           <span style="color:#8f5902;font-style:italic">//子接口实例赋值给父接口
</span></span></span></code></pre></div><h3 id="5-4接口查询">5.4接口查询</h3>
<p>若要在 switch 外判断一个接口类型是否实现了某个接口，可以使用“逗号 ok ”。</p>
<p>value, ok := Interfacevariable.(implementType)</p>
<p>其中 Interfacevariable 是接口变量（接口值），implementType 为实现此接口的类型，value 返回接口变量实际类型变量的值，如果该类型实现了此接口返回 true。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//判断file1接口指向的对象实例是否是File类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">file1</span> <span style="color:#000">Writer</span><span style="color:#000;font-weight:bold">=</span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">file5</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000">file1</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">);</span><span style="color:#000">ok</span><span style="color:#000;font-weight:bold">{</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-5接口类型查询">5.5接口类型查询</h3>
<p>在 Go 中，要判断传递给接口值的变量类型，可以在使用 type switch 得到。(type)只能在 switch 中使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 另一个实现了 I 接口的 R 类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">R</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">R</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">i</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">R</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">i</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">v</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#000">I</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// 判断传递给 p 的实际类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">S</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// 指向 S 的指针类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">R</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// 指向 R 的指针类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">S</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#8f5902;font-style:italic">// S 类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">R</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#8f5902;font-style:italic">// R 类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">//实现了 I 接口的其他类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-6接口组合">5.6接口组合</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//接口组合类似类型组合，只不过只包含方法，不包含成员变量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ReadWriter</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">//接口组合，避免代码重复
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">Reader</span>      <span style="color:#8f5902;font-style:italic">//接口Reader
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">Writer</span>      <span style="color:#8f5902;font-style:italic">//接口Writer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-7any类型-空接口">5.7Any类型[空接口]</h3>
<p>每种类型都能匹配到空接口：interface{}。空接口类型对方法没有任何约束（因为没有方法），它能包含任意类型，也可以实现到其他接口类型的转换。如果传递给该接口的类型变量实现了转换后的接口则可以正常运行，否则出现运行时错误。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//interface{}即为可以指向任何对象的Any类型，类似Java中的Object类
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">v1</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}=</span><span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">X</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">}{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">v2</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}=</span><span style="color:#4e9a06">&#34;abc&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">DoSomething</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>   <span style="color:#8f5902;font-style:italic">//该函数可以接收任何类型的参数，因为任何类型都实现了空接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-8接口的代码示例">5.8接口的代码示例</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//接口animal
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Animal</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Speak</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Dog类实现animal接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Dog</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Speak</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Woof!&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Cat类实现animal接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Cat</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Speak</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Meow!&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Llama实现animal接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Llama</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">l</span> <span style="color:#000">Llama</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Speak</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;?????&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//JavaProgrammer实现animal接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">JavaProgrammer</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#000">JavaProgrammer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Speak</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Design patterns!&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//主函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">animals</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">Animal</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">Llama</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">JavaProgrammer</span><span style="color:#000;font-weight:bold">{}}</span>  <span style="color:#8f5902;font-style:italic">//利用接口实现多态
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">animal</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">animals</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">animal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Speak</span><span style="color:#000;font-weight:bold">())</span>  <span style="color:#8f5902;font-style:italic">//打印不同实现该接口的类的方法返回值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f38d91a0433bf615f45ed644177bc984">4.2 - Golang 指针</h1>
    
	<h1 id="1-指针的概念">1. 指针的概念</h1>
<table>
<thead>
<tr>
<th>概念</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量</td>
<td>是一种占位符，用于引用计算机的内存地址。可理解为内存地址的标签</td>
</tr>
<tr>
<td>指针</td>
<td>表示内存地址，表示地址的指向。指针是一个指向另一个变量内存地址的值</td>
</tr>
<tr>
<td>&amp;</td>
<td>取地址符，例如：{指针}:=&amp;{变量}</td>
</tr>
<tr>
<td>*</td>
<td>取值符，例如：{变量}:=*{指针}</td>
</tr>
</tbody>
</table>
<h1 id="2-内存地址说明">2. 内存地址说明</h1>
<h2 id="2-1-内存定义">2.1. 内存定义</h2>
<p>计算机的内存 RAM 可以把它想象成一些有序的盒子，一个接一个的排成一排，每一个盒子或者单元格都被一个唯一的数字标记依次递增，这个数字就是该单元格的地址，也就是内存的地址。
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578751/article/golang/pointer/memory.png" alt="什么是内存"></p>
<p><strong>硬件角度</strong>：内存是CPU沟通的桥梁，程序运行在内存中。</p>
<p><strong>逻辑角度</strong>：内存是一块具备随机访问能力，支持读写操作，用来存放程序及程序运行中产生的数据的区域。</p>
<table>
<thead>
<tr>
<th>概念</th>
<th>比喻</th>
</tr>
</thead>
<tbody>
<tr>
<td>内存</td>
<td>一层楼层</td>
</tr>
<tr>
<td>内存块</td>
<td>楼层中的一个房间</td>
</tr>
<tr>
<td>变量名</td>
<td>房间的标签，例如：总经理室</td>
</tr>
<tr>
<td>指针</td>
<td>房间的具体地址（门牌号），例如：总经理室地址是2楼201室</td>
</tr>
<tr>
<td>变量值</td>
<td>房间里的具体存储物</td>
</tr>
<tr>
<td>指针地址</td>
<td>指针的地址：存储指针内存块的地址</td>
</tr>
</tbody>
</table>
<h2 id="2-2-内存单位和编址">2.2. 内存单位和编址</h2>
<h2 id="2-2-1-内存单位">2.2.1. 内存单位</h2>
<table>
<thead>
<tr>
<th>单位</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>位（bit）</td>
<td>计算机中最小的数据单位，每一位的状态只能是0或1</td>
</tr>
<tr>
<td>字节（Byte）</td>
<td>1Byte=8bit，是内存基本的计量单位</td>
</tr>
<tr>
<td>字</td>
<td>“字”由若干个字节构成，字的位数叫字长，不同档次的机器有不同的字长</td>
</tr>
<tr>
<td>KB</td>
<td>1KB=1024Byte，即1024个字节</td>
</tr>
<tr>
<td>MB</td>
<td>1MB=1024KB</td>
</tr>
<tr>
<td>GB</td>
<td>1GB=1024MB</td>
</tr>
</tbody>
</table>
<h2 id="2-2-2-内存编址">2.2.2. 内存编址</h2>
<p>计算机中的内存按字节编址，每个地址的存储单元可以存放一个字节的数据，CPU通过内存地址获取指令和数据，并不关心这个地址所代表的空间在什么位置，内存地址和地址指向的空间共同构成了一个内存单元。</p>
<h2 id="2-2-3-内存地址">2.2.3. 内存地址</h2>
<p>内存地址通常用16进制的数据表示，例如0x0ffc1。</p>
<h1 id="3-变量与指针运算理解">3.变量与指针运算理解</h1>
<p>编写一段程序，检索出值并存储在地址为 200 的一个块内存中，将其乘以 3，并将结果存储在地址为 201 的另一块内存中</p>
<h2 id="3-1-本质">3.1.本质</h2>
<ol>
<li>检索出内存地址为 200 的值，并将其存储在 CPU 中</li>
<li>将存储在 CPU 中的值乘以 3</li>
<li>将 CPU 中存储的结果，写入地址为 201 的内存块中</li>
</ol>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578752/article/golang/pointer/var1.png" alt="什么是变量"></p>
<h2 id="3-2-基于变量的理解">3.2.基于变量的理解</h2>
<ol>
<li>获取变量 a 中存储的值，并将其存储在 CPU 中</li>
<li>将其乘以 3</li>
<li>将结果保存在变量 b 中</li>
</ol>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578752/article/golang/pointer/var2.png" alt="什么是变量2"></p>
<pre tabindex="0"><code>var a = 6 
var b = a * 3
</code></pre><h2 id="3-3-基于指针的理解">3.3.基于指针的理解</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">200</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以上函数对a进行+1操作，具体理解如下：</p>
<p><strong>1.a:=200</strong></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578751/article/golang/pointer/pointer1.png" alt="什么是指针"></p>
<p><strong>2.  b := &amp;a</strong></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578751/article/golang/pointer/pointer2.png" alt="什么是指针2"></p>
<p>*<em>3. <em>b++</em></em></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578752/article/golang/pointer/pointer3.png" alt="什么是指针3"></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578752/article/golang/pointer/pointer4.png" alt="什么是指针4"></p>
<h1 id="4-指针的使用">4. 指针的使用</h1>
<h2 id="4-1-方法中的指针">4.1. 方法中的指针</h2>
<p>方法即为有接受者的函数，接受者可以是类型的实例变量或者是类型的实例指针变量。但两种效果不同。</p>
<p><strong>1、类型的实例变量</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">person</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Person</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;vanyar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">21</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;person&lt;%s:%d&gt;\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">person</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">person</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">age</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">person</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sayHi</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">person</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ModifyAge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">210</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">person</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sayHi</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Person</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">age</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#000">Person</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">sayHi</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SayHi -- This is %s, my age is %d\n&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">age</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#000">Person</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ModifyAge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">age</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ModifyAge&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">age</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">age</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//输出结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000">vanyar</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">21</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">SayHi</span> <span style="color:#ce5c00;font-weight:bold">--</span> <span style="color:#000">This</span> <span style="color:#000">is</span> <span style="color:#000">vanyar</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">my</span> <span style="color:#000">age</span> <span style="color:#000">is</span> <span style="color:#0000cf;font-weight:bold">21</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ModifyAgeSayHi</span> <span style="color:#ce5c00;font-weight:bold">--</span> <span style="color:#000">This</span> <span style="color:#000">is</span> <span style="color:#000">vanyar</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">my</span> <span style="color:#000">age</span> <span style="color:#000">is</span> <span style="color:#0000cf;font-weight:bold">21</span>
</span></span></code></pre></div><p>尽管 ModifyAge 方法修改了其age字段，可是方法里的p是person变量的一个副本，修改的只是副本的值。下一次调用sayHi方法的时候，还是person的副本，因此修改方法并不会生效。</p>
<p>即实例变量的方式并不会改变接受者本身的值。</p>
<p><strong>2、类型的实例指针变量</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Person</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ChangeAge</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">age</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ModifyAge&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">age</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">age</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Go会根据Person的示例类型，转换成指针类型再拷贝，即 person.ChangeAge会变成 (&amp;person).ChangeAge。</p>
<p>指针类型的接受者，如果实例对象是值，那么go会转换成指针，然后再拷贝，如果本身就是指针对象，那么就直接拷贝指针实例。因为指针都指向一处值，就能修改对象了。</p>
<h1 id="5-零值与nil-空指针">5. 零值与nil(空指针)</h1>
<p>变量声明而没有赋值，默认为零值，不同类型零值不同，例如字符串零值为空字符串；</p>
<p>指针声明而没有赋值，默认为nil，即该指针没有任何指向。当指针没有指向的时候，不能对(*point)进行操作包括读取，否则会报空指针异常。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 声明一个指针变量 aPot 其类型也是 string
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">aPot</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;aPot: %p %#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">aPot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">aPot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出 aPot: 0xc42000c030 (*string)(nil)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">aPot</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;This is a Pointer&#34;</span>  <span style="color:#8f5902;font-style:italic">// 报错： panic: runtime error: invalid memory address or nil pointer dereference
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>解决方法即给该指针分配一个指向,即初始化一个内存，并把该内存地址赋予指针变量，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 声明一个指针变量 aPot 其类型也是 string
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">aPot</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;aPot: %p %#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">aPot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">aPot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出 aPot: 0xc42000c030 (*string)(nil)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">aPot</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">aVar</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">aPot</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;This is a Pointer&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;aVar: %p %#v \n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">aVar</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">aVar</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出 aVar: 0xc42000e240 &#34;This is a Pointer&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;aPot: %p %#v %#v \n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">aPot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">aPot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">aPot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出 aPot: 0xc42000c030 (*string)(0xc42000e240) &#34;This is a Pointer&#34;
</span></span></span></code></pre></div><p>或者通过new开辟一个内存，并返回这个内存的地址。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">aNewPot</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#000">aNewPot</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">aNewPot</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">217</span>
</span></span><span style="display:flex;"><span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;aNewPot: %p %#v %#v \n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">aNewPot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">aNewPot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">aNewPot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出 aNewPot: 0xc42007a028 (*int)(0xc42006e1f0) 217
</span></span></span></code></pre></div><h1 id="6-总结">6. 总结</h1>
<ul>
<li>Golang提供了指针用于操作数据内存，并通过引用来修改变量。</li>
<li>只声明未赋值的变量，golang都会自动为其初始化为零值，基础数据类型的零值比较简单，引用类型和指针的零值都为nil，nil类型不能直接赋值，因此需要通过new开辟一个内存，或者通过make初始化数据类型，或者两者配合，然后才能赋值。</li>
<li>指针也是一种类型，不同于一般类型，指针的值是地址，这个地址指向其他的内存，通过指针可以读取其所指向的地址所存储的值。</li>
<li>函数方法的接受者，也可以是指针变量。无论普通接受者还是指针接受者都会被拷贝传入方法中，不同在于拷贝的指针，其指向的地方都一样，只是其自身的地址不一样。</li>
</ul>
<p>参考：</p>
<ul>
<li>
<p><a href="http://www.jianshu.com/p/d23f78a3922b">http://www.jianshu.com/p/d23f78a3922b</a></p>
</li>
<li>
<p><a href="http://www.jianshu.com/p/44b9429d7bef">http://www.jianshu.com/p/44b9429d7bef</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c35f23d9f6410b81a49a11ea33793112">5 - 并发编程</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-4c8372e52fa75cb824e9855efd347543">5.1 - Golang系列（三）之并发编程</h1>
    
	<h2 id="一-并发基础">（一）并发基础</h2>
<h3 id="1-概念">1.概念</h3>
<p>并发意味着程序在运行时有多个执行上下文，对应多个调用栈。</p>
<p>并发与并行的区别：</p>
<p>并发的主流实现模型：</p>
<table>
<thead>
<tr>
<th>实现模型</th>
<th>说明</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td>多进程</td>
<td>操作系统层面的并发模式</td>
<td>处理简单，互不影响，但开销大</td>
</tr>
<tr>
<td>多线程</td>
<td>系统层面的并发模式</td>
<td>有效，开销较大，高并发时影响效率</td>
</tr>
<tr>
<td>基于回调的非阻塞/异步IO</td>
<td>多用于高并发服务器开发中</td>
<td>编程复杂，开销小</td>
</tr>
<tr>
<td>协程</td>
<td>用户态线程，不需要操作系统抢占调度，寄存于线程中</td>
<td>编程简单，结构简单，开销极小，但需要语言的支持</td>
</tr>
</tbody>
</table>
<p>共享内存系统：线程之间采用共享内存的方式通信，通过加锁来避免死锁或资源竞争。</p>
<p>消息传递系统：将线程间共享状态封装在消息中，通过发送消息来共享内存，而非通过共享内存来通信。</p>
<h3 id="2-协程">2.协程</h3>
<p>执行体是个抽象的概念，在操作系统中分为三个级别：进程（process），进程内的线程（thread），进程内的协程（coroutine，轻量级线程）。协程的数量级可达到上百万个，进程和线程的数量级最多不超过一万个。Go语言中的协程叫goroutine，Go标准库提供的调用操作，IO操作都会出让CPU给其他goroutine，让协程间的切换管理不依赖系统的线程和进程，不依赖CPU的核心数量。</p>
<h3 id="3-并发通信">3.并发通信</h3>
<p>并发编程的难度在于协调，协调需要通过通信，并发通信模型分为共享数据和消息。共享数据即多个并发单元保持对同一个数据的引用，数据可以是内存数据块，磁盘文件，网络数据等。数据共享通过加锁的方式来避免死锁和资源竞争。Go语言则采取消息机制来通信，每个并发单元是独立的个体，有独立的变量，不同并发单元间这些变量不共享，每个并发单元的输入输出只通过消息的方式。</p>
<h2 id="二-goroutine">（二）goroutine</h2>
<h3 id="1-go关键字">1. go关键字</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//定义调用体
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">y</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">z</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">y</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//go关键字执行调用，即会产生一个goroutine并发执行
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//当函数返回时，goroutine自动结束，如果有返回值,返回值会自动被丢弃
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//并发执行
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">{</span><span style="color:#8f5902;font-style:italic">//主函数启动了10个goroutine，然后返回，程序退出，并不会等待其他goroutine结束
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>     <span style="color:#8f5902;font-style:italic">//所以需要通过channel通信来保证其他goroutine可以顺利执行
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-sync-waitgroup">2. sync.WaitGroup</h3>
<p>sync.WaitGroup用来实现启动一组goroutine，并等待任务做完再结束goroutine。</p>
<p>使用方法是：</p>
<ul>
<li>wg.Add()：main协程通过调用 wg.Add(delta int) 设置worker协程的个数，然后创建worker协程；</li>
<li>wg.Done()：worker协程执行结束以后，都要调用 wg.Done()，表示做完任务，goroutine减1；</li>
<li>wg.Wait() ：main协程调用 wg.Wait() 且被block，直到所有worker协程全部执行结束后返回。</li>
<li>针对可能panic的goroutine，可以使用defer wg.Done()来结束goroutine。</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>输出如下，随机输出0到9的数字</p>
<pre tabindex="0"><code>9
5
6
7
8
1
0
3
4
2
</code></pre><h3 id="3-sync-map">3. sync.Map</h3>
<p>Go 语言原生 map 并不是线程安全的，对它进行并发读写操作的时候，需要加锁。sync.map 则是一种并发安全的 map，可以使用在并发读写map的场景中。</p>
<p>sync.Map常见操作：</p>
<ul>
<li>写入：m.Store(&quot;1&quot;, 18)</li>
<li>读取：age, ok := m.Load(&quot;1&quot;)</li>
<li>删除：m.Delete(&quot;1&quot;)</li>
<li>遍历：m.Range(func(key, value interface{}) bool{}</li>
<li>存在则读取否则写入：	m.LoadOrStore(&quot;2&quot;, 100)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">m</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Map</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 1. 写入
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 2. 读取
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">age</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">age</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 3. 遍历
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">age</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">age</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 4. 删除
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">age</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">age</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 5. 如果key存在则读取，否则写入给定的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LoadOrStore</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">age</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">age</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>示例：</p>
<h4 id="3-1-不加锁的map并发读写">3.1. 不加锁的map并发读写</h4>
<p>以下使用线程不安全的map，进行并发写入，就会出现并发报错。可以通过加锁来解决并发问题，但更推荐使用sync.Map来实现。</p>
<p>示例1：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;math/rand&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 生成随机种子
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Unix</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sm</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Intn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 生成0-99的随机数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">sm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">r</span>  <span style="color:#8f5902;font-style:italic">// 同时对map进行并发写入
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 打印map中的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sm</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>输出异常：</p>
<p>map不能并发写入。</p>
<pre tabindex="0"><code>fatal error: concurrent map writes
</code></pre><h4 id="3-2-加锁的并发读写">3.2. 加锁的并发读写</h4>
<p>示例2：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;math/rand&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 生成随机种子
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Unix</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sm</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">SafeMap</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Map</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Intn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 生成0-99的随机数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">sm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>        <span style="color:#8f5902;font-style:italic">// 同时对map进行并发写入
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 打印map中的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Map</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// SafeMap
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">SafeMap</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Map</span>  <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lock</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RWMutex</span> <span style="color:#8f5902;font-style:italic">// 加锁
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Set
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">SafeMap</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">value</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Get
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">SafeMap</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>正常输出</p>
<pre tabindex="0"><code>map[0:52 1:16 2:86 3:50 4:97 5:38 6:54 7:75 8:26 9:32]
</code></pre><h4 id="3-3-使用sync-map并发读写">3.3. 使用sync.Map并发读写</h4>
<p>示例3：</p>
<p>以下使用线程安全的sync.Map来实现对map的值进行并发的读写。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;math/rand&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 生成随机种子
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Unix</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 使用线程安全的sync.Map
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sm</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Map</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Intn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 生成0-99的随机数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">sm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 打印map中的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">sm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>正常输出：</p>
<pre tabindex="0"><code>2 92
4 5
8 48
9 6
0 50
1 64
6 27
7 86
3 59
5 57
</code></pre><h2 id="三-channel">（三）channel</h2>
<p>​       channel就像管道的形式，是goroutine之间的通信方式，是进程内的通信方式，跨进程通信建议用分布式系统的方法来解决，例如Socket或http等通信协议。channel是类型相关，即一个channel只能传递一种类型的值，在声明时指定。</p>
<h3 id="1-基本语法">1、基本语法</h3>
<h4 id="1-channel的声明">1）channel的声明</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、channel声明，声明一个管道chanName，该管道可以传递的类型是ElementType
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//管道是一种复合类型，[chan ElementType],表示可以传递ElementType类型的管道[类似定语从句的修饰方法]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">chanName</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">ElementType</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ch</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span>                  <span style="color:#8f5902;font-style:italic">//声明一个可以传递int类型的管道
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">m</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span>      <span style="color:#8f5902;font-style:italic">//声明一个map，值的类型为可以传递bool类型的管道
</span></span></span></code></pre></div><h4 id="2-初始化">2）初始化</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、初始化ch:=make(chan int)   //make一般用来声明一个复合类型，参数为复合类型的属性
</span></span></span></code></pre></div><h4 id="3-管道读写">3）管道读写</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//3、管道写入,把值想象成一个球，&#34;&lt;-&#34;的方向，表示球的流向，ch即为管道
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//写入时，当管道已满（管道有缓冲长度）则会导致程序堵塞，直到有goroutine从中读取出值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">value</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//管道读取，&#34;&lt;-&#34;表示从管道把球倒出来赋值给一个变量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//当管道为空，读取数据会导致程序阻塞，直到有goroutine写入值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">ch</span> 
</span></span></code></pre></div><h4 id="4-select">4）select</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//4、每个case必须是一个IO操作，面向channel的操作，只执行其中的一个case操作，一旦满足则结束select过程
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//面向channel的操作无非三种情况：成功读出；成功写入；即没有读出也没有写入
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">chan1</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//如果chan1读到数据，则进行该case处理语句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">chan2</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//如果成功向chan2写入数据，则进入该case处理语句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">//如果上面都没有成功，则进入default处理流程
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-缓冲和超时机制">2、缓冲和超时机制</h3>
<h4 id="1-缓冲机制">1）缓冲机制</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、缓冲机制：为管道指定空间长度，达到类似消息队列的效果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">//第二个参数为缓冲区大小，与切片的空间大小类似
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//通过range关键字来实现依次读取管道的数据，与数组或切片的range使用方法类似
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Received:&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="2-超时机制">2）超时机制</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、超时机制：利用select只要一个case满足，程序就继续执行而不考虑其他case的情况的特性实现超时机制
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>    <span style="color:#8f5902;font-style:italic">//设置一个超时管道
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1e9</span><span style="color:#000;font-weight:bold">)</span>      <span style="color:#8f5902;font-style:italic">//设置超时时间，等待一分钟
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">true</span>        <span style="color:#8f5902;font-style:italic">//一分钟后往管道放一个true的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">ch</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#8f5902;font-style:italic">//如果读到数据，则会结束select过程
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//从ch中读取数据
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#8f5902;font-style:italic">//如果前面的case没有调用到，必定会读到true值，结束select，避免永久等待
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//一直没有从ch中读取到数据，但从timeout中读取到了数据
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-channel的传递">3、channel的传递</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//1、channel的传递，来实现Linux系统中管道的功能，以插件的方式增加数据处理的流程
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PipeData</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">handler</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span>   <span style="color:#8f5902;font-style:italic">//handler是属性？
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">next</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span>   <span style="color:#8f5902;font-style:italic">//可以把[chan int]看成一个整体，表示放int类型的管道
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">queue</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PipeData</span><span style="color:#000;font-weight:bold">){</span> <span style="color:#8f5902;font-style:italic">//queue是一个存放*PipeDate类型的管道，可改变管道里的数据块内容
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">{</span>     <span style="color:#8f5902;font-style:italic">//data的类型就是管道存放定义的类型，即PipeData
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">next</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>    <span style="color:#8f5902;font-style:italic">//该方法实现将PipeData的value值存放到next的管道中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-单向channel">4、单向channel</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//2、单向channel：只能用于接收或发送数据，是对channel的一种使用限制
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//单向channel的声明
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ch1</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span>    <span style="color:#8f5902;font-style:italic">//正常channel，可读写
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ch2</span> <span style="color:#204a87;font-weight:bold">chan</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#8f5902;font-style:italic">//单向只写channel  [chan&lt;- int]看成一个整体，表示流入管道
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ch3</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span>  <span style="color:#8f5902;font-style:italic">//单向只读channel  [&lt;-chan int]看成一个整体，表示流出管道
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//管道类型强制转换
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ch4</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span>     <span style="color:#8f5902;font-style:italic">//ch4为双向管道
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ch5</span><span style="color:#ce5c00;font-weight:bold">:=&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ch4</span><span style="color:#000;font-weight:bold">)</span>    <span style="color:#8f5902;font-style:italic">//把[&lt;-chan int]看成单向只读管道类型，对ch4进行强制类型转换
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ch6</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87;font-weight:bold">chan</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ch4</span><span style="color:#000;font-weight:bold">)</span>    <span style="color:#8f5902;font-style:italic">//把[chan&lt;- int]看成单向只写管道类型，对ch4进行强制类型转换
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">){</span>    <span style="color:#8f5902;font-style:italic">//最小权限原则
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">ch</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Parsing value&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-关闭channel">5、关闭channel</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//3、关闭channel，使用内置函数close()函数即可
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ch</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//判断channel是否关闭
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">:=&lt;-</span><span style="color:#000">ch</span> <span style="color:#8f5902;font-style:italic">//ok==false表示channel已经关闭
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>   <span style="color:#8f5902;font-style:italic">//如果channel关闭，ok==false，!ok==true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//执行体
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="四-多核并行化与同步锁">（四）多核并行化与同步锁</h2>
<h3 id="1-多核并行化">1、多核并行化</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//多核并行化
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GOMAXPROCS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">//设置环境变量GOMAXPROCS的值来控制使用多少个CPU核心
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumCPU</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">//来获取核心数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//出让时间片
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Gosched</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">//在每个goroutine中控制何时出让时间片给其他goroutine
</span></span></span></code></pre></div><h3 id="2-同步锁">2、同步锁</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//同步锁
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span> <span style="color:#8f5902;font-style:italic">//单读单写：占用Mutex后，其他goroutine只能等到其释放该Mutex
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RWMutex</span> <span style="color:#8f5902;font-style:italic">//单写多读：会阻止写，不会阻止读
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">RLock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">//读锁
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">//写锁
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">RUnlock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">//解锁（读锁）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">//解锁（写锁）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//全局唯一性操作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//once的Do方法保证全局只调用指定函数(setup)一次，其他goroutine在调用到此函数是会阻塞，直到once调用结束才继续
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">once</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Do</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">setup</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d80b67fd8e174563789a593632b2910f">6 - 文本处理</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b29bf66a1261ae910d3a40ffabb70e28">6.1 - Json处理</h1>
    
	<h1 id="json处理">JSON处理</h1>
<p>JSON是一种轻量级的数据交换语言。</p>
<h2 id="1-解析json-unmarshal-data-byte-v-interface">1. 解析JSON[Unmarshal(data []byte, v interface{})]</h2>
<h2 id="1-1-unmarshal源码">1.1. Unmarshal源码</h2>
<p><strong>/src/encoding/json/decode.go</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Unmarshal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Check for well-formedness.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Avoids filling out half a data structure
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// before discovering a JSON syntax error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">d</span> <span style="color:#000">decodeState</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">checkValid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">init</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unmarshal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">decodeState</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">unmarshal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">recover</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rv</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ptr</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">rv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNil</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">InvalidUnmarshalError</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scan</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reset</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// We decode rv not rv.Elem because the Unmarshaler interface
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// test must be applied at the top level of the value.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">savedError</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-2-解析到结构体">1.2. 解析到结构体</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Server</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ServerName</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ServerIP</span>   <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Serverslice</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Servers</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">Server</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">s</span> <span style="color:#000">Serverslice</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">str</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">`{&#34;servers&#34;:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    [{&#34;serverName&#34;:&#34;Shanghai_VPN&#34;,&#34;serverIP&#34;:&#34;127.0.0.1&#34;},
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    {&#34;serverName&#34;:&#34;Beijing_VPN&#34;,&#34;serverIP&#34;:&#34;127.0.0.2&#34;}]}`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unmarshal</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>说明</strong></p>
<p>JSON格式与结构体一一对应，Unmarshal方法即将JSON文本转换成结构体。只会匹配结构体中的可导出字段，即首字母大写字段（类似java的public），匹配规则如下：json的key为Foo为例</p>
<ol>
<li>先查找struct tag中含有Foo的可导出的struct字段（首字母大写）</li>
<li>其次查找字段名为Foo的可导出字段。</li>
<li>最后查找类似FOO或者FoO这类除首字母外，其他大小写不敏感的可导出字段。</li>
</ol>
<h2 id="1-3-解析到interface">1.3. 解析到interface</h2>
<h2 id="2-生成json-marshal-v-interface">2. 生成JSON[Marshal(v interface{})]</h2>
<h2 id="2-1-marshal源码">2.1. Marshal源码</h2>
<p><strong>/src/encoding/json/encode.go</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Marshal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">encodeState</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">marshal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bytes</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">encodeState</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">marshal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">recover</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reflectValue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-使用方法">2.2. 使用方法</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Server</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ServerName</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;serverName,string&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ServerIP</span>   <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;serverIP,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Serverslice</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Servers</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">Server</span> <span style="color:#4e9a06">`json:&#34;servers&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">s</span> <span style="color:#000">Serverslice</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Servers</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Servers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Server</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">ServerName</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Shanghai_VPN&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ServerIP</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Servers</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Servers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Server</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">ServerName</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Beijing_VPN&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ServerIP</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.02&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">json</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Marshal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;JSON ERR:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-说明">2.3. 说明</h2>
<p>Marshal方法将结构体转换成json文本，匹配规则如下：</p>
<ol>
<li>如果字段的tag是“-”，那么该字段不会输出到JSON。</li>
<li>如果tag中带有自定义名称，那么该自定义名称会出现在JSON字段名中。例如例子中的“serverName”</li>
<li>如果tag中带有“omitempty”选项，那么如果该字段值为空，就不会输出到JSON中。</li>
<li>如果字段类型是bool,string,int,int64等，而tag中带有“，string”选项，那么这个字段在输出到JSON的时候会把该字段对应的值转换成JSON字符串。</li>
</ol>
<p>注意事项：</p>
<ol>
<li>Marshal只有在转换成功的时候才会返回数据，JSON对象只支持string作为key，如果要编码一个map,那么必须是map[string]T这种类型。（T为任意类型）</li>
<li>Channel,complex和function不能被编码成JSON。</li>
<li>嵌套的数据不能编码，会进入死循环。</li>
<li>指针在编码时会输出指针指向的内容，而空指针会输出null。</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a990d95ccd933871e49e55b22aedbf9f">6.2 - 文件操作</h1>
    
	<h1 id="文件操作">文件操作</h1>
<p>更多文件操作见Go的os包。</p>
<h2 id="1-目录操作">1. 目录操作</h2>
<ul>
<li>
<p><strong>func Mkdir(name string, perm FileMode) error</strong><br>
创建名称为 name 的目录，权限设置是 perm，例如 0777</p>
</li>
<li>
<p><strong>func MkdirAll(path string, perm FileMode) error</strong>
根据 path 创建多级子目录，例如 astaxie/test1/test2。</p>
</li>
<li>
<p><strong>func Remove(name string) error</strong>
删除名称为 name 的目录，当目录下有文件或者其他目录是会出错</p>
</li>
<li>
<p><strong>func RemoveAll(path string) error</strong>
根据 path 删除多级子目录，如果 path 是单个名称，那么该目录不删除</p>
</li>
</ul>
<h2 id="2-文件操作">2. 文件操作</h2>
<h2 id="2-1-建立与打开文件">2.1. 建立与打开文件</h2>
<p><strong>新建文件：</strong></p>
<ul>
<li><strong>func Create(name string) (file *File, err Error)</strong>
根据提供的文件名创建新的文件，返回一个文件对象，默认权限是 0666 的文件，返回的文件对象是可读写的。</li>
<li>** func NewFile(fd uintptr, name string) *File**
根据文件描述符创建相应的文件，返回一个文件对象</li>
</ul>
<p><strong>打开文件：</strong></p>
<ul>
<li><strong>func Open(name string) (file *File, err Error)</strong>
该方法打开一个名称为 name 的文件，但是是只读方式，内部实现其实调用了 OpenFile。</li>
<li><strong>func OpenFile(name string, flag int, perm uint32) (file *File, err Error)</strong>
打开名称为 name 的文件，flag 是打开的方式，只读、读写等，perm 是权限</li>
</ul>
<h2 id="2-2-写文件">2.2. 写文件</h2>
<p><strong>写文件函数：</strong></p>
<ul>
<li><strong>func (file *File) Write(b []byte) (n int, err Error)</strong>
写入 byte 类型的信息到文件</li>
<li><strong>func (file *File) WriteAt(b []byte, off int64) (n int, err Error)</strong>
在指定位置开始写入 byte 类型的信息</li>
<li><strong>func (file *File) WriteString(s string) (ret int, err Error)</strong>
写入 string 信息到文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">userFile</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;test.txt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userFile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">fout</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fout</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Just a test!\r\n&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fout</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Just a test!\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-读文件">2.3. 读文件</h2>
<p><strong>读文件函数：</strong></p>
<ul>
<li>
<p>func (file *File) Read(b []byte) (n int, err Error)
读取数据到 b 中</p>
</li>
<li>
<p>func (file *File) ReadAt(b []byte, off int64) (n int, err Error)
从 off 开始读取数据到 b 中</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">userFile</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;text.txt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userFile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">buf</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">n</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stdout</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-4-删除文件">2.4. 删除文件</h2>
<p>Go 语言里面删除文件和删除文件夹是同一个函数</p>
<ul>
<li>func Remove(name string) Error
调用该函数就可以删除文件名为 name 的文件</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-719d254961116eb786bedc6cdfe80a71">6.3 - 字符串处理</h1>
    
	<h1 id="字符串处理">字符串处理</h1>
<p>字符串操作涉及的标准库有<strong>strings</strong>和<strong>strconv</strong>两个包</p>
<h2 id="1-字符串操作">1. 字符串操作</h2>
<table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>func Contains(s, substr string) bool</td>
<td>字符串 s 中是否包含 substr，返回 bool 值</td>
</tr>
<tr>
<td>func Join(a []string, sep string) string</td>
<td>字符串链接，把 slice a 通过 sep 链接起来</td>
</tr>
<tr>
<td>func Index(s, sep string) int</td>
<td>在字符串 s 中查找 sep 所在的位置，返回位置值，找不到返回-1</td>
</tr>
<tr>
<td>func Repeat(s string, count int) string</td>
<td>重复 s 字符串 count 次，最后返回重复的字符串</td>
</tr>
<tr>
<td>func Replace(s, old, new string, n int) string</td>
<td>在 s 字符串中，把 old 字符串替换为 new 字符串，n 表示替换的次数，小于 0 表示全部替换</td>
</tr>
<tr>
<td>func Split(s, sep string) []string</td>
<td>把 s 字符串按照 sep 分割，返回 slice</td>
</tr>
<tr>
<td>func Trim(s string, cutset string) string</td>
<td>在 s 字符串中去除 cutset 指定的字符串</td>
</tr>
<tr>
<td>func Fields(s string) []string</td>
<td>去除 s 字符串的空格符，并且按照空格分割返回 slice</td>
</tr>
</tbody>
</table>
<h2 id="2-字符串转换">2. 字符串转换</h2>
<p>1、Append 系列函数将整数等转换为字符串后，添加到现有的字节数组中</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">str</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">str</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppendInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4567</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">str</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppendBool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">str</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppendQuote</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;abcdefg&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">str</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppendQuoteRune</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;单&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>2、Format 系列函数把其他类型的转换为字符串</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormatBool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormatFloat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">123.23</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;g&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormatInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1234</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormatUint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">12345</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Itoa</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1023</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>3、Parse 系列函数把字符串转换为其他类型</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseBool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;false&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseFloat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;123.23&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;1234&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseUint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;12345&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">e</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Itoa</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;1023&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7556189d85d6b1efe21bf0554529e2f7">7 - 单元测试</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-9f54ee0a88c9d10394c84722e4749849">7.1 - 单元测试</h1>
    
	<h1 id="1-go中的测试框架">1. Go中的测试框架</h1>
<p>Go语言中自带有一个轻量级的测试框架<code>testing</code>和自带的<code>go test</code>命令来实现单元测试和性能测试，<code>testing</code>框架和其他语言中的测试框架类似，你可以基于这个框架写针对相应函数的测试用例，也可以基于该框架写相应的压力测试用例。</p>
<h1 id="2-单元测试原则">2. 单元测试原则</h1>
<ul>
<li>文件名必须是<code>_test.go</code>结尾的，这样在执行<code>go test</code>的时候才会执行到相应的代码</li>
<li>你必须import <code>testing</code>这个包</li>
<li>所有的测试用例函数必须是<code>Test</code>开头</li>
<li>测试用例会按照源代码中写的顺序依次执行</li>
<li>测试函数<code>TestXxx()</code>的参数是<code>testing.T</code>，我们可以使用该类型来记录错误或者是测试状态</li>
<li>测试格式：<code>func TestXxx (t *testing.T)</code>,<code>Xxx</code>部分可以为任意的字母数字的组合，但是首字母不能是小写字母[a-z]，例如<code>Testintdiv</code>是错误的函数名。</li>
<li>函数中通过调用<code>testing.T</code>的<code>Error</code>, <code>Errorf</code>, <code>FailNow</code>, <code>Fatal</code>, <code>FatalIf</code>方法，说明测试不通过，调用<code>Log</code>方法用来记录测试的信息。</li>
</ul>
<h1 id="3-测试常用命令">3 测试常用命令</h1>
<pre tabindex="0"><code># 测试整个目录
go test -v ./pkg/... ./cmd/... -coverprofile cover.out

# 测试某个文件
go test -v  file_test.go file.go 

# 测试某个函数
go test -v -test.run TestFunction
</code></pre><h1 id="4-示例">4. 示例</h1>
<h2 id="4-1-源文件getest-go">4.1. 源文件getest.go</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">gotest</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Division</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;除数不能为0&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-2-测试文件gotest-test-go">4.2. 测试文件gotest_test.go</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Test_Division_2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Division</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">//try a unit test on function
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Division did not work as expected.&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 如果不是如预期的那么就报错
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;one test passed.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">//记录一些你期望记录的信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-压力测试">5. 压力测试</h1>
<p>压力测试用来检测函数(方法）的性能，和编写单元功能测试的方法类似。</p>
<ul>
<li>压力测试用例必须遵循如下格式，其中XXX可以是任意字母数字的组合，但是首字母不能是小写字母</li>
</ul>
<pre tabindex="0"><code>		func BenchmarkXXX(b *testing.B) { ... }
</code></pre><ul>
<li><code>go test</code>不会默认执行压力测试的函数，如果要执行压力测试需要带上参数<code>-test.bench</code>，语法:<code>-test.bench=&quot;test_name_regex&quot;</code>,例如<code>go test -test.bench=&quot;.*&quot;</code>表示测试全部的压力测试函数</li>
<li>在压力测试用例中,请记得在循环体内使用<code>testing.B.N</code>,以使测试可以正常的运行</li>
<li>文件名也必须以<code>_test.go</code>结尾</li>
</ul>
<h2 id="5-1-示例">5.1. 示例</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">gotest</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Benchmark_Division</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">B</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">//use b.N for looping
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">Division</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Benchmark_TimeConsumingFunction</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">B</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StopTimer</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">//调用该函数停止压力测试的时间计数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//做一些初始化的工作,例如读取文件数据,数据库连接之类的,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//这样这些时间不影响我们测试函数本身的性能
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartTimer</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">//重新开始时间
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Division</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>执行测试命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">file</span> <span style="color:#000">webbench_test</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">test</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bench</span><span style="color:#000;font-weight:bold">=</span><span style="color:#4e9a06">&#34;.*&#34;</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-59028f298d7c92f86b48acee63ac76cf">7.2 - GDB调试</h1>
    
	<h1 id="1-gdb简介">1. GDB简介</h1>
<p>GDB是FSF(自由软件基金会)发布的一个强大的类UNIX系统下的程序调试工具。使用GDB可以做如下事情：</p>
<ol>
<li>启动程序，可以按照开发者的自定义要求运行程序。</li>
<li>可让被调试的程序在开发者设定的调置的断点处停住。（断点可以是条件表达式）</li>
<li>当程序被停住时，可以检查此时程序中所发生的事。</li>
<li>动态的改变当前程序的执行环境。</li>
</ol>
<p>目前支持调试Go程序的GDB版本必须大于7.1。</p>
<p>编译Go程序的时候需要注意以下几点</p>
<ol>
<li>传递参数-ldflags &quot;-s&quot;，忽略debug的打印信息</li>
<li>传递-gcflags &quot;-N -l&quot; 参数，这样可以忽略Go内部做的一些优化，聚合变量和函数等优化，这样对于GDB调试来说非常困难，所以在编译的时候加入这两个参数避免这些优化。</li>
</ol>
<h1 id="2-常用命令">2. 常用命令</h1>
<h2 id="2-1-list">2.1. list</h2>
<p>简写命令<code>l</code>，用来显示源代码，默认显示十行代码，后面可以带上参数显示的具体行，例如：<code>list 15</code>，显示十行代码，其中第15行在显示的十行里面的中间，如下所示。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">10</span>	        <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">11</span>	        <span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">i</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">12</span>	    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">13</span>	    <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">14</span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">15</span>	
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">16</span>	<span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">17</span>	    <span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;Starting main&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">18</span>	    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">19</span>	    <span style="color:#000">bus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-2-break">2.2. break</h2>
<p>简写命令 <code>b</code>,用来设置断点，后面跟上参数设置断点的行数，例如<code>b 10</code>在第十行设置断点。</p>
<h2 id="2-3-delete">2.3. delete</h2>
<p>简写命令 <code>d</code>,用来删除断点，后面跟上断点设置的序号，这个序号可以通过<code>info breakpoints</code>获取相应的设置的断点序号，如下是显示的设置断点序号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  Num     Type           Disp Enb Address            What
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2</span>       breakpoint     keep y   0x0000000000400dc3 in main.main at /home/xiemengjun/gdb.go:23
</span></span><span style="display:flex;"><span>  breakpoint already hit <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#204a87">time</span>
</span></span></code></pre></div><h2 id="2-4-backtrace">2.4. backtrace</h2>
<p>简写命令 <code>bt</code>,用来打印执行的代码过程，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">#0  main.main () at /home/xiemengjun/gdb.go:23</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">#1  0x000000000040d61e in runtime.main () at /home/xiemengjun/go/src/pkg/runtime/proc.c:244</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">#2  0x000000000040d6c1 in schedunlock () at /home/xiemengjun/go/src/pkg/runtime/proc.c:267</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">#3  0x0000000000000000 in ?? ()</span>
</span></span></code></pre></div><h2 id="2-5-info">2.5. info</h2>
<p>info命令用来显示信息，后面有几种参数，我们常用的有如下几种：</p>
<p>1、 <code>info locals</code></p>
<p>显示当前执行的程序中的变量值</p>
<p>2、 <code>info breakpoints</code></p>
<p>显示当前设置的断点列表</p>
<p>3、 <code>info goroutines</code></p>
<p>显示当前执行的goroutine列表，如下代码所示,带*的表示当前执行的</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>* <span style="color:#0000cf;font-weight:bold">1</span>  running runtime.gosched
</span></span><span style="display:flex;"><span>* <span style="color:#0000cf;font-weight:bold">2</span>  syscall runtime.entersyscall
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">3</span>  waiting runtime.gosched
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">4</span>  runnable runtime.gosched
</span></span></code></pre></div><h2 id="2-6-print">2.6. print</h2>
<p>简写命令<code>p</code>，用来打印变量或者其他信息，后面跟上需要打印的变量名，当然还有一些很有用的函数$len()和$cap()，用来返回当前string、slices或者maps的长度和容量。</p>
<h2 id="2-7-whatis">2.7. whatis</h2>
<p>用来显示当前变量的类型，后面跟上变量名，例如<code>whatis msg</code>,显示如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  <span style="color:#204a87">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> struct string
</span></span></code></pre></div><h2 id="2-8-next">2.8. next</h2>
<p>简写命令 <code>n</code>,用来单步调试，跳到下一步，当有断点之后，可以输入<code>n</code>跳转到下一步继续执行</p>
<h2 id="2-9-coutinue">2.9. coutinue</h2>
<p>简称命令 <code>c</code>，用来跳出当前断点处，后面可以跟参数N，跳过多少次断点</p>
<h2 id="2-10-set-variable">2.10. set variable</h2>
<p>该命令用来改变运行过程中的变量值，格式如：<code>set variable &lt;var&gt;=&lt;value&gt;</code></p>
<h1 id="3-调试过程">3. 调试过程</h1>
<h2 id="3-1-示例代码">3.1. 示例代码</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">counting</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#204a87;font-weight:bold">chan</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">i</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;Starting main&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">msg</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;starting a gofunc&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">counting</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">bus</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-调试步骤">3.2. 调试步骤</h2>
<p>编译文件，生成可执行文件gdbfile:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go build -gcflags <span style="color:#4e9a06">&#34;-N -l&#34;</span> gdbfile.go
</span></span></code></pre></div><p>通过gdb命令启动调试：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gdb gdbfile
</span></span></code></pre></div><p>启动之后首先看看这个程序是不是可以运行起来，只要输入<code>run</code>命令回车后程序就开始运行，程序正常的话可以看到程序输出如下，和我们在命令行直接执行程序输出是一样的：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> run
</span></span><span style="display:flex;"><span>Starting program: /home/xiemengjun/gdbfile
</span></span><span style="display:flex;"><span>Starting main
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">7</span>
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">9</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>LWP <span style="color:#0000cf;font-weight:bold">2771</span> exited<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Inferior <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>process 2771<span style="color:#ce5c00;font-weight:bold">)</span> exited normally<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>好了，现在我们已经知道怎么让程序跑起来了，接下来开始给代码设置断点：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> b <span style="color:#0000cf;font-weight:bold">23</span>
</span></span><span style="display:flex;"><span>Breakpoint <span style="color:#0000cf;font-weight:bold">1</span> at 0x400d8d: file /home/xiemengjun/gdbfile.go, line 23.
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> run
</span></span><span style="display:flex;"><span>Starting program: /home/xiemengjun/gdbfile
</span></span><span style="display:flex;"><span>Starting main
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>New LWP 3284<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Switching to LWP 3284<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>Breakpoint 1, main.main <span style="color:#ce5c00;font-weight:bold">()</span> at /home/xiemengjun/gdbfile.go:23
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">23</span>          fmt.Println<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count:&#34;</span>, count<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>上面例子<code>b 23</code>表示在第23行设置了断点，之后输入<code>run</code>开始运行程序。现在程序在前面设置断点的地方停住了，我们需要查看断点相应上下文的源码，输入<code>list</code>就可以看到源码显示从当前停止行的前五行开始：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> list
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">18</span>      fmt.Println<span style="color:#ce5c00;font-weight:bold">(</span>msg<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">19</span>      bus :<span style="color:#ce5c00;font-weight:bold">=</span> make<span style="color:#ce5c00;font-weight:bold">(</span>chan int<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">20</span>      <span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;starting a gofunc&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">21</span>      go counting<span style="color:#ce5c00;font-weight:bold">(</span>bus<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">22</span>      <span style="color:#204a87;font-weight:bold">for</span> count :<span style="color:#ce5c00;font-weight:bold">=</span> range bus <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">23</span>          fmt.Println<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count:&#34;</span>, count<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">24</span>      <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">25</span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>现在GDB在运行当前的程序的环境中已经保留了一些有用的调试信息，我们只需打印出相应的变量，查看相应变量的类型及值：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> info locals
</span></span><span style="display:flex;"><span><span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bus</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0xf840001a50
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> p count
</span></span><span style="display:flex;"><span><span style="color:#000">$1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> p bus
</span></span><span style="display:flex;"><span><span style="color:#000">$2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span>chan int<span style="color:#ce5c00;font-weight:bold">)</span> 0xf840001a50
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> whatis bus
</span></span><span style="display:flex;"><span><span style="color:#204a87">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> chan int
</span></span></code></pre></div><p>接下来该让程序继续往下执行，请继续看下面的命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> c
</span></span><span style="display:flex;"><span>Continuing.
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>New LWP 3303<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Switching to LWP 3303<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>Breakpoint 1, main.main <span style="color:#ce5c00;font-weight:bold">()</span> at /home/xiemengjun/gdbfile.go:23
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">23</span> fmt.Println<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count:&#34;</span>, count<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> c
</span></span><span style="display:flex;"><span>Continuing.
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Switching to LWP 3302<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>Breakpoint 1, main.main <span style="color:#ce5c00;font-weight:bold">()</span> at /home/xiemengjun/gdbfile.go:23
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">23</span> fmt.Println<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count:&#34;</span>, count<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>每次输入<code>c</code>之后都会执行一次代码，又跳到下一次for循环，继续打印出来相应的信息。设想目前需要改变上下文相关变量的信息，跳过一些过程，并继续执行下一步，得出修改后想要的结果：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> info locals
</span></span><span style="display:flex;"><span><span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bus</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0xf840001a50
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87">set</span> variable <span style="color:#000">count</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">9</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> info locals
</span></span><span style="display:flex;"><span><span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">9</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bus</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0xf840001a50
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> c
</span></span><span style="display:flex;"><span>Continuing.
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">9</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Switching to LWP 3302<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>Breakpoint 1, main.main <span style="color:#ce5c00;font-weight:bold">()</span> at /home/xiemengjun/gdbfile.go:23
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">23</span> fmt.Println<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count:&#34;</span>, count<span style="color:#ce5c00;font-weight:bold">)</span>  
</span></span></code></pre></div><p>最后稍微思考一下，前面整个程序运行的过程中到底创建了多少个goroutine，每个goroutine都在做什么：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> info goroutines
</span></span><span style="display:flex;"><span>* <span style="color:#0000cf;font-weight:bold">1</span> running runtime.gosched
</span></span><span style="display:flex;"><span>* <span style="color:#0000cf;font-weight:bold">2</span> syscall runtime.entersyscall
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3</span> waiting runtime.gosched
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4</span> runnable runtime.gosched
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>gdb<span style="color:#ce5c00;font-weight:bold">)</span> goroutine <span style="color:#0000cf;font-weight:bold">1</span> bt
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#0 0x000000000040e33b in runtime.gosched () at /home/xiemengjun/go/src/pkg/runtime/proc.c:927</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#1 0x0000000000403091 in runtime.chanrecv (c=void, ep=void, selected=void, received=void)</span>
</span></span><span style="display:flex;"><span>at /home/xiemengjun/go/src/pkg/runtime/chan.c:327
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#2 0x000000000040316f in runtime.chanrecv2 (t=void, c=void)</span>
</span></span><span style="display:flex;"><span>at /home/xiemengjun/go/src/pkg/runtime/chan.c:420
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#3 0x0000000000400d6f in main.main () at /home/xiemengjun/gdbfile.go:22</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#4 0x000000000040d0c7 in runtime.main () at /home/xiemengjun/go/src/pkg/runtime/proc.c:244</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#5 0x000000000040d16a in schedunlock () at /home/xiemengjun/go/src/pkg/runtime/proc.c:267</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#6 0x0000000000000000 in ?? ()</span>
</span></span></code></pre></div><p>通过查看goroutines的命令我们可以清楚地了解goruntine内部是怎么执行的，每个函数的调用顺序已经明明白白地显示出来了。</p>
<p>参考《Go Web编程》</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aedac0cb64b7bbac0d96a16b4beb98ad">8 - 原理篇</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-7bc48bb55b545d1380f04f3ad0c830de">8.1 - Goroutine调度</h1>
    
	<blockquote>
<p>本文主要介绍Go的调度模型。</p>
</blockquote>
<h1 id="1-线程实现模型">1. 线程实现模型</h1>
<p>线程模型有三类：<a href="https://en.wikipedia.org/wiki/Thread_%28computing%29#Models">内核级线程模型、用户级线程模型、混合型线程模型</a>。三者的区别主要在于线程与内核调度实体KSE(Kernel Scheduling Entity)之间的对应关系上。</p>
<blockquote>
<p>内核调度实体KSE指操作系统内核调度器调度的对象实体，是内核调度的最小单元。</p>
</blockquote>
<h2 id="1-1-线程模型对比">1.1. 线程模型对比</h2>
<table>
<thead>
<tr>
<th>线程模型</th>
<th>用户线程与KSE之间的对应关系</th>
<th>特点</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td>内核级线程模型</td>
<td>1:1</td>
<td>1条用户线程对应一条内核进程/线程来调度，即以核心态线程实现。</td>
<td>具有和内核线程一致的优点，不同用户线程之间不会互相影响。可以利用多核系统的优势。</td>
<td>在大量线程的情况下，线程的创建、删除、切换的代价更昂贵，影响性能。</td>
</tr>
<tr>
<td>用户级线程模型</td>
<td>M:1</td>
<td>N条用户线程只由一条内核进程/线程调度，即以用户态线程实现。</td>
<td>线程的创建、删除和环境切换都很高效。</td>
<td>一旦一个线程发生阻塞，整个进程下的其他线程也会被阻塞。不能利用多核系统的优势。</td>
</tr>
<tr>
<td>混合型线程模型</td>
<td>M:N</td>
<td>M条用户线程由N条内核线程动态关联。又称两级线程模型</td>
<td>可以快速地执行上下文切换，而且可以利用多核的优势。当某个线程发生阻塞可以调度出CPU关联到可以执行的线程上。目前Go就是采用这种线程模型。</td>
<td>动态关联机制实现复杂，需要用户或runtime自己去实现。</td>
</tr>
</tbody>
</table>
<h2 id="1-2-线程模型示意图">1.2. 线程模型示意图</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1557130409/article/golang/scheduler/thread-model.png" width="100%">
<h1 id="2-g-p-m调度模型">2. G-P-M调度模型</h1>
<p><strong>调度模型:</strong></p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1557129220/article/golang/scheduler/go-scheduler.png" width="80%">
<p><strong>G-P-M对应关系：</strong></p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1557129219/article/golang/scheduler/gpm.png" width="40%">
<h2 id="2-1-基本概念">2.1. 基本概念</h2>
<ul>
<li>M：machine，代表系统内核进程，用来执行G。（工人）</li>
<li>P：processor，代表调度执行的上下文（context），维护了一个本地的goroutine的队列。（小推车）</li>
<li>G：goroutine，代表goroutine，即执行的goroutine的数据结构及栈等。（砖头）</li>
</ul>
<h2 id="2-2-基本流程">2.2. 基本流程</h2>
<p>调度的本质是将G尽量均匀合理地安排给M来执行，其中P的作用就是来实现合理安排逻辑。</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1557134526/article/golang/scheduler/in-motion.jpg" width="50%">
<ul>
<li>P的数量通过 <code>GOMAXPROCS()</code> 来设置，一般等于CPU的核数，对于一次代码执行设置好一般不会变。</li>
<li>P维护了一个本地的G队列（runqueue），包括正在执行和待执行的G，尽量保证所有的P都匹配一个M同时在执行G。</li>
<li>当P本地goroutine队列消费完，会从全局的goroutine队列（global runqueue）中拿goroutine到本地队列。P也会定期检查全局的goroutine队列，避免存在全局的goroutine没有被执行而&quot;饿死&quot;的现象。</li>
<li>P和M是动态形式的一对一的关系，P和G是动态形式的一对多的关系。</li>
</ul>
<h2 id="2-3-抢占式调度-阻塞">2.3. 抢占式调度（阻塞）</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1557134526/article/golang/scheduler/syscall.jpg">
<p>当goroutine发生阻塞的时候，可以通过P将剩余的G切换给新的M来执行，而不会导致剩余的G无法执行，如果没有M则创建M来匹配P。</p>
<p>当阻塞的goroutine返回后，进程会尝试获取一个上下文（Context）来执行这个goroutine。一般是先从其他进程中&quot;偷取&quot;一个Context，如果&quot;偷取&quot;不成功，则将goroutine放入全局的goroutine中。</p>
<h2 id="2-4-偷任务">2.4. 偷任务</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1557134526/article/golang/scheduler/steal.jpg">
<p>P可以偷任务即goroutine，当某个P的本地G执行完，且全局没有G需要执行的时候，P可以去偷别的P还没有执行完的一半的G来给M执行，提高了G的执行效率。</p>
<p>参考：</p>
<ul>
<li><a href="http://morsmachine.dk/go-scheduler">http://morsmachine.dk/go-scheduler</a></li>
<li><a href="https://docs.google.com/document/d/1TTj4T2JO42uD5ID9e89oa0sLKhJYD0Y_kqxDv3I3XMw/edit#heading=h.mmq8lm48qfcw">Scalable Go Scheduler Design Doc</a></li>
<li><a href="https://docs.google.com/document/d/1ETuA2IOmnaQ4j81AtTGT40Y4_Jr6_IDASEKg0t0dBR8/edit#heading=h.3pilqarbrc9h">Go Preemptive Scheduler Design Doc</a></li>
<li><a href="https://github.com/k2huang/blogpost/blob/master/golang/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6/Go%E5%B9%B6%E5%8F%91%E6%9C%BA%E5%88%B6.md">k2huang/blogpost/Go并发机制</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b8b91a006ccc6631bf1d4686e528f557">8.2 - 内存分配</h1>
    
	<blockquote>
<p>TODO</p>
</blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6175b2f5094c6f2f7f140051010d2af5">8.3 - 垃圾回收</h1>
    
	<blockquote>
<p>TODO</p>
</blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-153a0dea4426741d355082018e61bbca">8.4 - 深入理解Channel</h1>
    
	<blockquote>
<p>TODO</p>
</blockquote>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-afe9a2744fbfaff67a60f95f82fde861">9 - 框架与工具</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-db9d97f48c46611bb8f9057053ea0221">9.1 - Cobra命令框架</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-9dc604ed1f73abaccaa475707a6f3fb2">9.1.1 - cobra 介绍</h1>
    
	<h1 id="1-cobra简介">1. Cobra简介</h1>
<p><code>Cobra</code>是一个cli接口模式的应用程序框架，同时也是生成该框架的命令行工具。用户可以通过<code>help</code>方式快速查看该二进制的使用方式。</p>
<p><code>Cobra</code>主要包括以下部分</p>
<ul>
<li><code>Command</code>:一般表示action，即运行的二进制命令服务。同时可以拥有子命令（children commands）。</li>
<li><code>Args</code>:命令执行相关参数。</li>
<li><code>Flags</code>:二进制命令的配置参数，可对应配置文件。参数可分为全局参数和子命令参数。参考：<a href="https://github.com/spf13/pflag">pflag library</a>。</li>
</ul>
<h1 id="2-安装">2. 安装</h1>
<p>通过以下操作可以在<code>$GOPATH/bin</code>安装cobra的二进制命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get -u github.com/spf13/cobra/cobra
</span></span></code></pre></div><h1 id="3-使用">3. 使用</h1>
<p><code>cobra</code>命令行帮助信息如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cobra</span>
</span></span><span style="display:flex;"><span>Cobra is a CLI library <span style="color:#204a87;font-weight:bold">for</span> Go that empowers applications.
</span></span><span style="display:flex;"><span>This application is a tool to generate the needed files
</span></span><span style="display:flex;"><span>to quickly create a Cobra application.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  cobra <span style="color:#ce5c00;font-weight:bold">[</span>command<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available Commands:
</span></span><span style="display:flex;"><span>  add         Add a <span style="color:#204a87">command</span> to a Cobra Application
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">help</span>        Help about any <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>  init        Initialize a Cobra Application
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>  -a, --author string    author name <span style="color:#204a87;font-weight:bold">for</span> copyright attribution <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;YOUR NAME&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --config string    config file <span style="color:#ce5c00;font-weight:bold">(</span>default is <span style="color:#000">$HOME</span>/.cobra.yaml<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -h, --help             <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> cobra
</span></span><span style="display:flex;"><span>  -l, --license string   name of license <span style="color:#204a87;font-weight:bold">for</span> the project
</span></span><span style="display:flex;"><span>      --viper            use Viper <span style="color:#204a87;font-weight:bold">for</span> configuration <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#204a87">true</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;cobra [command] --help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information about a command.
</span></span></code></pre></div><h2 id="3-1-cobra-init">3.1. cobra init</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cobra init --help</span>
</span></span><span style="display:flex;"><span>Initialize <span style="color:#ce5c00;font-weight:bold">(</span>cobra init<span style="color:#ce5c00;font-weight:bold">)</span> will create a new application, with a license
</span></span><span style="display:flex;"><span>and the appropriate structure <span style="color:#204a87;font-weight:bold">for</span> a Cobra-based CLI application.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  * If a name is provided, it will be created in the current directory<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  * If no name is provided, the current directory will be assumed<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  * If a relative path is provided, it will be created inside <span style="color:#000">$GOPATH</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">(</span>e.g. github.com/spf13/hugo<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  * If an absolute path is provided, it will be created<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  * If the directory already exists but is empty, it will be used.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Init will not use an existing directory with contents.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  cobra init <span style="color:#ce5c00;font-weight:bold">[</span>name<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>flags<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Aliases:
</span></span><span style="display:flex;"><span>  init, initialize, initialise, create
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>  -h, --help              <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> init
</span></span><span style="display:flex;"><span>      --pkg-name string   fully qualified pkg name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Global Flags:
</span></span><span style="display:flex;"><span>  -a, --author string    author name <span style="color:#204a87;font-weight:bold">for</span> copyright attribution <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;YOUR NAME&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --config string    config file <span style="color:#ce5c00;font-weight:bold">(</span>default is <span style="color:#000">$HOME</span>/.cobra.yaml<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -l, --license string   name of license <span style="color:#204a87;font-weight:bold">for</span> the project
</span></span><span style="display:flex;"><span>      --viper            use Viper <span style="color:#204a87;font-weight:bold">for</span> configuration <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#204a87">true</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="3-2-cobra-add">3.2. cobra add</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cobra add --help</span>
</span></span><span style="display:flex;"><span>Add <span style="color:#ce5c00;font-weight:bold">(</span>cobra add<span style="color:#ce5c00;font-weight:bold">)</span> will create a new command, with a license and
</span></span><span style="display:flex;"><span>the appropriate structure <span style="color:#204a87;font-weight:bold">for</span> a Cobra-based CLI application,
</span></span><span style="display:flex;"><span>and register it to its parent <span style="color:#ce5c00;font-weight:bold">(</span>default rootCmd<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>If you want your <span style="color:#204a87">command</span> to be public, pass in the <span style="color:#204a87">command</span> name
</span></span><span style="display:flex;"><span>with an initial uppercase letter.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Example: cobra add server -&gt; resulting in a new cmd/server.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  cobra add <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> name<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>flags<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Aliases:
</span></span><span style="display:flex;"><span>  add, <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>  -h, --help            <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> add
</span></span><span style="display:flex;"><span>  -p, --parent string   variable name of parent <span style="color:#204a87">command</span> <span style="color:#204a87;font-weight:bold">for</span> this <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;rootCmd&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Global Flags:
</span></span><span style="display:flex;"><span>  -a, --author string    author name <span style="color:#204a87;font-weight:bold">for</span> copyright attribution <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;YOUR NAME&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --config string    config file <span style="color:#ce5c00;font-weight:bold">(</span>default is <span style="color:#000">$HOME</span>/.cobra.yaml<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -l, --license string   name of license <span style="color:#204a87;font-weight:bold">for</span> the project
</span></span><span style="display:flex;"><span>      --viper            use Viper <span style="color:#204a87;font-weight:bold">for</span> configuration <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#204a87">true</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/spf13/cobra">https://github.com/spf13/cobra</a></li>
<li><a href="https://github.com/spf13/cobra/blob/master/cobra/README.md">https://github.com/spf13/cobra/blob/master/cobra/README.md</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-04f7287ef9bca2673f1b910e4df63291">9.1.2 - cobra command</h1>
    
	<blockquote>
<p>本文以cobra-demo为例介绍cobra添加命令的具体使用操作。</p>
</blockquote>
<h1 id="0-cobra-demo">0. cobra-demo</h1>
<p><code>cobra-demo</code>编译二进制执行的结果如下。具体代码参考：https://github.com/huweihuang/cobra-demo</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> $ ./cobra-demo 
</span></span><span style="display:flex;"><span>A longer description that spans multiple lines and likely contains
</span></span><span style="display:flex;"><span>examples and usage of using your application. For example:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Cobra is a CLI library <span style="color:#204a87;font-weight:bold">for</span> Go that empowers applications.
</span></span><span style="display:flex;"><span>This application is a tool to generate the needed files
</span></span><span style="display:flex;"><span>to quickly create a Cobra application.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  cobra-demo <span style="color:#ce5c00;font-weight:bold">[</span>command<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available Commands:
</span></span><span style="display:flex;"><span>  config      A brief description of your <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">help</span>        Help about any <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>  server      A brief description of your <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>      --config string   config file <span style="color:#ce5c00;font-weight:bold">(</span>default is <span style="color:#000">$HOME</span>/.cobra-demo.yaml<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -h, --help            <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> cobra-demo
</span></span><span style="display:flex;"><span>  -t, --toggle          Help message <span style="color:#204a87;font-weight:bold">for</span> toggle
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;cobra-demo [command] --help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information about a command.
</span></span></code></pre></div><h1 id="1-cobra-init">1. cobra init</h1>
<blockquote>
<p>cobra init 的具体使用参考 <a href="http://www.huweihuang.com/framework/cobra/cobra-usage.html#31-cobra-init">init</a></p>
</blockquote>
<h2 id="1-1-cobra-init-pkg-name">1.1. cobra init --pkg-name</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cobra init &lt;cobra-demo&gt; --pkg-name github.com/huweihuang/cobra-demo -a <span style="color:#4e9a06">&#39;author name &lt;email&gt;&#39;</span>
</span></span></code></pre></div><p>执行以上命令，创建的文件目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./
</span></span><span style="display:flex;"><span>├── LICENSE
</span></span><span style="display:flex;"><span>├── cmd
</span></span><span style="display:flex;"><span>│   ├── root.go
</span></span><span style="display:flex;"><span>└── main.go
</span></span></code></pre></div><h2 id="1-2-main-go">1.2. main.go</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;github.com/huweihuang/cobra-demo/cmd&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-3-cmd-root-go">1.3. cmd/root.go</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;github.com/spf13/cobra&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">homedir</span> <span style="color:#4e9a06">&#34;github.com/mitchellh/go-homedir&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;github.com/spf13/viper&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">cfgFile</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// rootCmd represents the base command when called without any subcommands
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">rootCmd</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;cobra-demo&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Short</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A brief description of your application&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Long</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`A longer description that spans multiple lines and likely contains
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">examples and usage of using your application. For example:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Cobra is a CLI library for Go that empowers applications.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">This application is a tool to generate the needed files
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">to quickly create a Cobra application.`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Uncomment the following line if your bare application
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// has an action associated with it:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">//	Run: func(cmd *cobra.Command, args []string) { },
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Execute adds all child commands to the root command and sets flags appropriately.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This is called by main.main(). It only needs to happen once to the rootCmd.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rootCmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnInitialize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">initConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Here you will define your flags and configuration settings.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Cobra supports persistent flags, which, if defined here,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// will be global for your application.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">rootCmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentFlags</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cfgFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;config file (default is $HOME/.cobra-demo.yaml)&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Cobra also supports local flags, which will only run
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// when this action is called directly.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">rootCmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">BoolP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;toggle&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;t&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Help message for toggle&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// initConfig reads in config file and ENV variables if set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">initConfig</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfgFile</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Use config file from the flag.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">viper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetConfigFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfgFile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Find home directory.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">home</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">homedir</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dir</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Search config in home directory with name &#34;.cobra-demo&#34; (without extension).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">viper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddConfigPath</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">home</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">viper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetConfigName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.cobra-demo&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">viper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AutomaticEnv</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// read in environment variables that match
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// If a config file is found, read it in.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">viper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadInConfig</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Using config file:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">viper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigFileUsed</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-cobra-add">2. cobra add</h1>
<blockquote>
<p>cobra add 的具体使用参考 <a href="http://www.huweihuang.com/framework/cobra/cobra-usage.html#32-cobra-add">add</a></p>
</blockquote>
<h2 id="2-1-cobra-add-command">2.1. cobra add command</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cobra add serve -a <span style="color:#4e9a06">&#39;author name &lt;email&gt;&#39;</span>
</span></span><span style="display:flex;"><span>cobra add config -a <span style="color:#4e9a06">&#39;author name &lt;email&gt;&#39;</span>
</span></span><span style="display:flex;"><span>cobra add create -p <span style="color:#4e9a06">&#39;configCmd&#39;</span> -a <span style="color:#4e9a06">&#39;author name &lt;email&gt;&#39;</span><span style="color:#8f5902;font-style:italic"># 在父命令config命令下创建子命令create,若没有指定-p,默认的父命令为rootCmd。</span>
</span></span></code></pre></div><p>执行以上命令，创建的文件目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./
</span></span><span style="display:flex;"><span>├── LICENSE
</span></span><span style="display:flex;"><span>├── cmd
</span></span><span style="display:flex;"><span>│   ├── config.go  <span style="color:#8f5902;font-style:italic"># rootCmd的子命令 </span>
</span></span><span style="display:flex;"><span>│   ├── create.go  <span style="color:#8f5902;font-style:italic"># config的子命令</span>
</span></span><span style="display:flex;"><span>│   ├── root.go    <span style="color:#8f5902;font-style:italic"># 默认父命令</span>
</span></span><span style="display:flex;"><span>│   └── server.go  <span style="color:#8f5902;font-style:italic"># rootCmd的子命令</span>
</span></span><span style="display:flex;"><span>└── main.go
</span></span></code></pre></div><h2 id="2-2-cmd-config-go">2.2. cmd/config.go</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/spf13/cobra&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// configCmd represents the config command
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">configCmd</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Short</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A brief description of your command&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Long</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`A longer description that spans multiple lines and likely contains examples
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">and usage of using your command. For example:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Cobra is a CLI library for Go that empowers applications.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">This application is a tool to generate the needed files
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">to quickly create a Cobra application.`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Run</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;config called&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rootCmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configCmd</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Here you will define your flags and configuration settings.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Cobra supports Persistent Flags which will work for this command
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// and all subcommands, e.g.:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// configCmd.PersistentFlags().String(&#34;foo&#34;, &#34;&#34;, &#34;A help for foo&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Cobra supports local flags which will only run when this command
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// is called directly, e.g.:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// configCmd.Flags().BoolP(&#34;toggle&#34;, &#34;t&#34;, false, &#34;Help message for toggle&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-cmd-create-go">2.3. cmd/create.go</h2>
<p>create为config的子命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/spf13/cobra&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// createCmd represents the create command
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">createCmd</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Short</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;A brief description of your command&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Long</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`A longer description that spans multiple lines and likely contains examples
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">and usage of using your command. For example:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Cobra is a CLI library for Go that empowers applications.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">This application is a tool to generate the needed files
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">to quickly create a Cobra application.`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Run</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create called&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">configCmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">createCmd</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Here you will define your flags and configuration settings.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Cobra supports Persistent Flags which will work for this command
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// and all subcommands, e.g.:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// createCmd.PersistentFlags().String(&#34;foo&#34;, &#34;&#34;, &#34;A help for foo&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Cobra supports local flags which will only run when this command
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// is called directly, e.g.:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// createCmd.Flags().BoolP(&#34;toggle&#34;, &#34;t&#34;, false, &#34;Help message for toggle&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/spf13/cobra">https://github.com/spf13/cobra</a></li>
<li><a href="https://github.com/spf13/cobra/blob/master/cobra/README.md">https://github.com/spf13/cobra/blob/master/cobra/README.md</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-893ab712567d96d312135e4afc210aa8">9.1.3 - cobra flags</h1>
    
	<h1 id="添加flags">添加Flags</h1>
<h2 id="1-persistent-flags">1. Persistent Flags</h2>
<p><code>Persistent Flags</code>表示该类参数可以被用于当前命令及其子命令。</p>
<p>例如，以下表示<code>verbose</code>参数可以被用于<code>rootCmd</code>及其子命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">rootCmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentFlags</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">BoolVarP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Verbose</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;verbose&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;verbose output&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-local-flags">2. Local Flags</h2>
<p><code>Local Flags</code>表示该类参数只能用于当前命令。</p>
<p>例如，以下表示<code>source</code>只能用于<code>localCmd</code>这个命令，不能用于其子命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">localCmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StringVarP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;source&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Source directory to read from&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="3-local-flag-on-parent-commands">3. Local Flag on Parent Commands</h2>
<p>cobra默认只解析当前命令的local flags，通过开启<code>Command.TraverseChildren</code>参数，可以解析每个命令的local flags。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">command</span> :<span style="color:#ce5c00;font-weight:bold">=</span> cobra.Command<span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  Use: <span style="color:#4e9a06">&#34;print [OPTIONS] [COMMANDS]&#34;</span>,
</span></span><span style="display:flex;"><span>  TraverseChildren: true,
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-bind-flags-with-config">4. Bind Flags with Config</h2>
<p>可以通过 <a href="https://github.com/spf13/viper">viper</a>来绑定flags。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>var author string
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func init<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  rootCmd.PersistentFlags<span style="color:#ce5c00;font-weight:bold">()</span>.StringVar<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000;font-weight:bold">&amp;</span>author, <span style="color:#4e9a06">&#34;author&#34;</span>, <span style="color:#4e9a06">&#34;YOUR NAME&#34;</span>, <span style="color:#4e9a06">&#34;Author name for copyright attribution&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  viper.BindPFlag<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span>, rootCmd.PersistentFlags<span style="color:#ce5c00;font-weight:bold">()</span>.Lookup<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;author&#34;</span><span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>更多参考： <a href="https://github.com/spf13/viper#working-with-flags">viper documentation</a>。</p>
<h2 id="5-required-flags">5. Required flags</h2>
<p>默认添加的flags的<code>可选</code>参数，如果需要在二进制运行时添加<code>必要</code>参数，即当该参数没指定时会报错。可使用以下设置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">rootCmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StringVarP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Region</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;region&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;r&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;AWS region (required)&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">rootCmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MarkFlagRequired</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;region&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/spf13/cobra">https://github.com/spf13/cobra</a></li>
<li><a href="https://github.com/spf13/cobra/blob/master/cobra/README.md">https://github.com/spf13/cobra/blob/master/cobra/README.md</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-90d3042b02510958c3ff4d2692b71a2e">9.2 - 性能分析之go pprof工具使用</h1>
    
	<h1 id="1-go-pprof工具简介">1. go pprof工具简介</h1>
<p>在 Go 语言中，PProf 是用于可视化和分析性能分析数据的工具，PProf 以 profile.proto 读取分析样本的集合，并生成报告以可视化并帮助分析数据（支持文本和图形报告）。</p>
<ul>
<li>runtime/pprof：采集程序（非 Server）的指定区块的运行数据进行分析。</li>
<li>net/http/pprof：基于 HTTP Server 运行，并且可以采集运行时数据进行分析。</li>
</ul>
<h2 id="1-1-分析内容">1.1. 分析内容</h2>
<ul>
<li>cpu（CPU Profiling）: <code>$HOST/debug/pprof/profile</code>，默认进行 30s 的 CPU Profiling，得到一个分析用的 profile 文件</li>
<li>block（Block Profiling）：<code>$HOST/debug/pprof/block</code>，查看导致阻塞同步的堆栈跟踪</li>
<li>goroutine：<code>$HOST/debug/pprof/goroutine</code>，查看当前所有运行的 goroutines 堆栈跟踪</li>
<li>heap（Memory Profiling）: <code>$HOST/debug/pprof/heap</code>，查看活动对象的内存分配情况</li>
<li>mutex（Mutex Profiling）：<code>$HOST/debug/pprof/mutex</code>，查看导致互斥锁的竞争持有者的堆栈跟踪</li>
<li>threadcreate：<code>$HOST/debug/pprof/threadcreate</code>，查看创建新OS线程的堆栈跟踪</li>
</ul>
<h2 id="1-2-分析方式">1.2. 分析方式</h2>
<ul>
<li>
<p>go tool pprof命令交互方式</p>
</li>
<li>
<p>web网页方式查看</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> http://ip:port/debug/pprof/
</span></span></code></pre></div><h1 id="2-代码配置pprof">2. 代码配置pprof</h1>
<h2 id="2-1-gin框架集成pprof">2.1. Gin框架集成pprof</h2>
<p>调用<code>github.com/gin-contrib/pprof</code>，执行pprof.Register(*gin.Engine)。</p>
<p>示例代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;github.com/gin-contrib/pprof&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">server</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conf</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">gin</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">gin</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Engine</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">setupServer</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">gin</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Engine</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 注册pprof
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">gin</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// register routers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setupRoutes</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">gin</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-非gin框架集成pprof">2.2. 非Gin框架集成pprof</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;net/http/pprof&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;github.com/gorilla/mux&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Install adds the Profiling webservice to the given mux.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Install</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Router</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/profile&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Profile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/symbol&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Symbol</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/trace&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Trace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">redirectTo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PathPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">HandlerFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Index</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">RegisterPprof</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>     <span style="color:#8f5902;font-style:italic">//    NewRouter
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">muxHandler</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRouter</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// register handler for pprof
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Install</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">muxHandler</span><span style="color:#000;font-weight:bold">)</span>   
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-go-tool-pprof">3. go tool pprof</h1>
<h2 id="3-1-内存">3.1. 内存</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go tool pprof http://ip:port/debug/pprof/heap
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># go tool pprof http://ip:port/debug/pprof/heap</span>
</span></span><span style="display:flex;"><span>Fetching profile over HTTP from http://ip:port/debug/pprof/heap
</span></span><span style="display:flex;"><span>Saved profile in /root/pprof/pprof.yurt-tunnel-server.alloc_objects.alloc_space.inuse_objects.inuse_space.001.pb.gz
</span></span><span style="display:flex;"><span>File: yurt-tunnel-server
</span></span><span style="display:flex;"><span>Type: inuse_space
</span></span><span style="display:flex;"><span>Time: May 10, <span style="color:#0000cf;font-weight:bold">2023</span> at 11:03am <span style="color:#ce5c00;font-weight:bold">(</span>+08<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Entering interactive mode <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">type</span> <span style="color:#4e9a06">&#34;help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> commands, <span style="color:#4e9a06">&#34;o&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> options<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>pprof<span style="color:#ce5c00;font-weight:bold">)</span> top
</span></span><span style="display:flex;"><span>Showing nodes accounting <span style="color:#204a87;font-weight:bold">for</span> 46.08GB, 94.72% of 48.65GB total
</span></span><span style="display:flex;"><span>Dropped <span style="color:#0000cf;font-weight:bold">319</span> nodes <span style="color:#ce5c00;font-weight:bold">(</span>cum &lt;<span style="color:#ce5c00;font-weight:bold">=</span> 0.24GB<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Showing top <span style="color:#0000cf;font-weight:bold">10</span> nodes out of <span style="color:#0000cf;font-weight:bold">31</span>
</span></span><span style="display:flex;"><span>      flat  flat%   sum%        cum   cum%
</span></span><span style="display:flex;"><span>   25.91GB 53.27% 53.27%    25.91GB 53.27%  bufio.NewWriterSize <span style="color:#ce5c00;font-weight:bold">(</span>inline<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   12.91GB 26.54% 79.80%    12.91GB 26.54%  bufio.NewReaderSize
</span></span><span style="display:flex;"><span>    1.67GB  3.43% 83.23%     1.74GB  3.59%  net/textproto.<span style="color:#ce5c00;font-weight:bold">(</span>*Reader<span style="color:#ce5c00;font-weight:bold">)</span>.ReadMIMEHeader
</span></span><span style="display:flex;"><span>    1.26GB  2.59% 85.83%     1.26GB  2.59%  runtime.malg
</span></span><span style="display:flex;"><span>    1.22GB  2.51% 88.34%     5.72GB 11.75%  net/http.<span style="color:#ce5c00;font-weight:bold">(</span>*conn<span style="color:#ce5c00;font-weight:bold">)</span>.readRequest
</span></span><span style="display:flex;"><span>    0.86GB  1.77% 90.11%     3.39GB  6.96%  net/http.readRequest
</span></span><span style="display:flex;"><span>    0.68GB  1.39% 91.50%    13.72GB 28.20%  sigs.k8s.io/apiserver-network-proxy/pkg/server.<span style="color:#ce5c00;font-weight:bold">(</span>*Tunnel<span style="color:#ce5c00;font-weight:bold">)</span>.ServeHTTP
</span></span><span style="display:flex;"><span>    0.58GB  1.20% 92.70%     0.86GB  1.78%  context.propagateCancel
</span></span><span style="display:flex;"><span>    0.51GB  1.06% 93.76%     0.51GB  1.06%  net/http.<span style="color:#ce5c00;font-weight:bold">(</span>*Server<span style="color:#ce5c00;font-weight:bold">)</span>.newConn
</span></span><span style="display:flex;"><span>    0.47GB  0.96% 94.72%     1.33GB  2.74%  context.WithCancel
</span></span></code></pre></div><h2 id="3-2-cpu">3.2. CPU</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go tool pprof http://ip:port/debug/pprof/profile
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># go tool pprof http://ip:port/debug/pprof/profile</span>
</span></span><span style="display:flex;"><span>Fetching profile over HTTP from http://ip:port/debug/pprof/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Saved profile in /root/pprof/pprof.yurt-tunnel-server.samples.cpu.001.pb.gz
</span></span><span style="display:flex;"><span>File: yurt-tunnel-server
</span></span><span style="display:flex;"><span>Type: cpu
</span></span><span style="display:flex;"><span>Time: May 10, <span style="color:#0000cf;font-weight:bold">2023</span> at 10:58am <span style="color:#ce5c00;font-weight:bold">(</span>+08<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Duration: 30.14s, Total <span style="color:#000">samples</span> <span style="color:#ce5c00;font-weight:bold">=</span> 35.72s <span style="color:#ce5c00;font-weight:bold">(</span>118.52%<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Entering interactive mode <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">type</span> <span style="color:#4e9a06">&#34;help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> commands, <span style="color:#4e9a06">&#34;o&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> options<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>pprof<span style="color:#ce5c00;font-weight:bold">)</span> top
</span></span><span style="display:flex;"><span>Showing nodes accounting <span style="color:#204a87;font-weight:bold">for</span> 25120ms, 70.32% of 35720ms total
</span></span><span style="display:flex;"><span>Dropped <span style="color:#0000cf;font-weight:bold">240</span> nodes <span style="color:#ce5c00;font-weight:bold">(</span>cum &lt;<span style="color:#ce5c00;font-weight:bold">=</span> 178.60ms<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Showing top <span style="color:#0000cf;font-weight:bold">10</span> nodes out of <span style="color:#0000cf;font-weight:bold">58</span>
</span></span><span style="display:flex;"><span>      flat  flat%   sum%        cum   cum%
</span></span><span style="display:flex;"><span>   12100ms 33.87% 33.87%    12120ms 33.93%  runtime.<span style="color:#ce5c00;font-weight:bold">(</span>*lfstack<span style="color:#ce5c00;font-weight:bold">)</span>.pop <span style="color:#ce5c00;font-weight:bold">(</span>inline<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    3360ms  9.41% 43.28%     3360ms  9.41%  runtime.<span style="color:#ce5c00;font-weight:bold">(</span>*lfstack<span style="color:#ce5c00;font-weight:bold">)</span>.push
</span></span><span style="display:flex;"><span>    2200ms  6.16% 49.44%     2200ms  6.16%  runtime.pageIndexOf <span style="color:#ce5c00;font-weight:bold">(</span>inline<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    1350ms  3.78% 53.22%     1520ms  4.26%  runtime.findObject
</span></span><span style="display:flex;"><span>    1350ms  3.78% 57.00%     3490ms  9.77%  runtime.scanobject
</span></span><span style="display:flex;"><span>    1120ms  3.14% 60.13%     3550ms  9.94%  runtime.sweepone
</span></span><span style="display:flex;"><span>    1000ms  2.80% 62.93%    10850ms 30.38%  runtime.scanblock
</span></span><span style="display:flex;"><span>     910ms  2.55% 65.48%     1310ms  3.67%  runtime.step
</span></span><span style="display:flex;"><span>     890ms  2.49% 67.97%      890ms  2.49%  runtime.markBits.isMarked <span style="color:#ce5c00;font-weight:bold">(</span>inline<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>     840ms  2.35% 70.32%    20300ms 56.83%  runtime.gentraceback
</span></span></code></pre></div><h1 id="4-生成火焰图">4. 生成火焰图</h1>
<p>安装graphviz，用于生成火焰图。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic"># ubuntu</span>
</span></span><span style="display:flex;"><span> apt-get install -y graphviz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic"># centos</span>
</span></span><span style="display:flex;"><span> yum install -y graphviz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic"># mac</span>
</span></span><span style="display:flex;"><span> brew install graphviz
</span></span></code></pre></div><p>当执行go pprof的命令时，会自动生成<code>.pb.gz</code>文件，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 内存</span>
</span></span><span style="display:flex;"><span>Saved profile in /root/pprof/pprof.yurt-tunnel-server.alloc_objects.alloc_space.inuse_objects.inuse_space.001.pb.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># CPU</span>
</span></span><span style="display:flex;"><span>Saved profile in /root/pprof/pprof.yurt-tunnel-server.samples.cpu.001.pb.gz
</span></span></code></pre></div><p>将<code>.pb.gz</code>文件拷贝到mac本地，执行以下命令，在浏览器查看相关视图。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go tool pprof -http<span style="color:#ce5c00;font-weight:bold">=</span>:8081 pprof.yurt-tunnel-server.alloc_objects.alloc_space.inuse_objects.inuse_space.001.pb.gz
</span></span><span style="display:flex;"><span>Serving web UI on http://localhost:8081
</span></span></code></pre></div><h2 id="4-1-内存分布图">4.1. 内存分布图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1683701710/article/golang/pprof/profile001.png" alt=""></p>
<h2 id="4-2-火焰图">4.2. 火焰图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1683701425/article/golang/pprof/graph.png" alt=""></p>
<h1 id="5-查看goroutine泄露">5. 查看goroutine泄露</h1>
<p>可以通过访问web地址的<code>/debug/pprof/goroutine</code>路径，查看goroutine的详细分布情况。goroutine数量分布过多的地方可能会存在内存泄露的情况。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>goroutine profile: total <span style="color:#0000cf;font-weight:bold">3337450</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3336630</span> @ 0x437fb6 0x40640c 0x405e38 0x1406b18 0x7c19bb 0x7bd528 0x4684c1
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x1406b17    sigs.k8s.io/apiserver-network-proxy/pkg/server.(*Tunnel).ServeHTTP+0xbb7    /go/pkg/mod/github.com/openyurtio/apiserver-network-proxy@v1.18.8/pkg/server/tunnel.go:105</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x7c19ba    net/http.serverHandler.ServeHTTP+0x43a                        /usr/local/go/src/net/http/server.go:2878</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x7bd527    net/http.(*conn).serve+0xb07                            /usr/local/go/src/net/http/server.go:1929</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">195</span> @ 0x437fb6 0x43095e 0x462d69 0x4c90b2 0x4ca41a 0x4ca408 0x525649 0x536665 0x7b7b8d 0x4fd5e6 0x140709a 0x7c19bb 0x7bd528 0x4684c1
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x462d68    internal/poll.runtime_pollWait+0x88                        /usr/local/go/src/runtime/netpoll.go:229</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x4c90b1    internal/poll.(*pollDesc).wait+0x31                        /usr/local/go/src/internal/poll/fd_poll_runtime.go:84</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x4ca419    internal/poll.(*pollDesc).waitRead+0x259                    /usr/local/go/src/internal/poll/fd_poll_runtime.go:89</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x4ca407    internal/poll.(*FD).Read+0x247                            /usr/local/go/src/internal/poll/fd_unix.go:167</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x525648    net.(*netFD).Read+0x28                                /usr/local/go/src/net/fd_posix.go:56</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x536664    net.(*conn).Read+0x44                                /usr/local/go/src/net/net.go:183</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x7b7b8c    net/http.(*connReader).Read+0x16c                        /usr/local/go/src/net/http/server.go:780</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x4fd5e5    bufio.(*Reader).Read+0x105                            /usr/local/go/src/bufio/bufio.go:213</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x1407099    sigs.k8s.io/apiserver-network-proxy/pkg/server.(*Tunnel).ServeHTTP+0x1139    /go/pkg/mod/github.com/openyurtio/apiserver-network-proxy@v1.18.8/pkg/server/tunnel.go:138</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x7c19ba    net/http.serverHandler.ServeHTTP+0x43a                        /usr/local/go/src/net/http/server.go:2878</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x7bd527    net/http.(*conn).serve+0xb07                            /usr/local/go/src/net/http/server.go:1929</span>
</span></span></code></pre></div><p>上述goroutine的分布超过300万个，主要都分布在第一个部分，因此可以得出以下可能的结论：</p>
<p><code>/go/pkg/mod/github.com/openyurtio/apiserver-network-proxy@v1.18.8/pkg/server/tunnel.go:105</code> 代码可能存在内存泄露的情况。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    0x1406b17    sigs.k8s.io/apiserver-network-proxy/pkg/server.(*Tunnel).ServeHTTP+0xbb7    /go/pkg/mod/github.com/openyurtio/apiserver-network-proxy@v1.18.8/pkg/server/tunnel.go:105</span>
</span></span></code></pre></div><p>因此我们追踪tunnel.go:105的源码:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">#</span><span style="color:#0000cf;font-weight:bold">105</span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connected</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// Waiting for response before we begin full communication.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>select 没有返回，导致goroutine不断累计。</p>
<h2 id="5-1-解决goroutine泄露">5.1. 解决goroutine泄露</h2>
<p>以上分析的代码来自<a href="https://github.com/kubernetes-sigs/apiserver-network-proxy">apiserver-network-proxy</a>。</p>
<p>我们可以查看该内存泄露的issue:</p>
<ul>
<li><a href="https://github.com/kubernetes-sigs/apiserver-network-proxy/pull/270">https://github.com/kubernetes-sigs/apiserver-network-proxy/pull/270</a></li>
</ul>
<p>修复内存泄露的commit：</p>
<ul>
<li><a href="https://github.com/kubernetes-sigs/apiserver-network-proxy/pull/270/files#diff-eea155e8345014451f10cb525235e3a66c9d0223b9927184a6b4b0a52dfeacc4R116">Fix obscure HTTP CONNECT goroutine leak by jveski · Pull Request #270 · kubernetes-sigs/apiserver-network-proxy · GitHub</a></li>
</ul>
<p>涉及代码修改如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">connection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connected</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// Waiting for response before we begin full communication.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">closed</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// Connection was closed before being established
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>增加closed类型，退出goroutine。</p>
<p>参考：</p>
<ul>
<li>
<p><a href="https://segmentfault.com/a/1190000016412013">Golang 大杀器之性能剖析 PProf - SegmentFault 思否</a></p>
</li>
<li>
<p><a href="https://geektutu.com/post/hpg-pprof.html">https://geektutu.com/post/hpg-pprof.html</a></p>
</li>
<li>
<p><a href="https://coder.today/tech/2018-11-10_profiling-your-golang-app-in-3-steps/">https://coder.today/tech/2018-11-10_profiling-your-golang-app-in-3-steps/</a></p>
</li>
<li>
<p><a href="https://go.dev/blog/pprof">Profiling Go Programs - The Go Programming Language</a></p>
</li>
<li>
<p><a href="https://golang2.eddycjy.com/posts/ch6/01-pprof-1/">Go 大杀器之性能剖析 PProf（上） | Go 语言编程之旅</a></p>
</li>
<li>
<p><a href="https://www.likakuli.com/posts/docker-leak3/">Dockerd资源泄露系列</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-730cfb9f4c3061ee695a19a22b0b3d29">10 - 代码规范</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-08fea79afe24f6ff5d3f175366b64ee0">10.1 - Golang 代码规范</h1>
    
	<h2 id="1-前言">1. 前言</h2>
<p>本规范在 <a href="https://github.com/golang/go/wiki/CodeReviewComments">Google Golang 代码规范</a> 的基础上，进行了调整和补充。</p>
<p>每项规范内容，给出了要求等级，其定义为：</p>
<ul>
<li><strong>必须（Mandatory）</strong>：用户必须采用；</li>
<li><strong>推荐（Preferable）</strong>：用户理应采用，但如有特殊情况，可以不采用；</li>
<li><strong>可选（Optional）</strong>：用户可参考，自行决定是否采用；</li>
</ul>
<h2 id="2-代码风格">2. 代码风格</h2>
<h3 id="2-1-必须-格式化">2.1 【必须】格式化</h3>
<ul>
<li>代码都必须用 <code>gofmt</code> 格式化。</li>
</ul>
<h3 id="2-2-推荐-换行">2.2 【推荐】换行</h3>
<ul>
<li>建议一行代码不要超过<code>120列</code>，超过的情况，使用合理的换行方法换行。</li>
<li>例外场景：
<ul>
<li>import 模块语句</li>
<li>工具生成代码</li>
<li>struct tag</li>
</ul>
</li>
</ul>
<h3 id="2-3-必须-括号和空格">2.3 【必须】括号和空格</h3>
<ul>
<li>
<p>遵循 <code>gofmt</code> 的逻辑。</p>
</li>
<li>
<p>运算符和操作数之间要留空格。</p>
</li>
<li>
<p>作为输入参数或者数组下标时，运算符和运算数之间不需要空格，紧凑展示。</p>
</li>
</ul>
<h3 id="2-4-必须-import-规范">2.4 【必须】import 规范</h3>
<ul>
<li>
<p>使用 <code>goimports</code> 自动格式化引入的包名，import 规范原则上以 <code>goimports</code> 规则为准。</p>
</li>
<li>
<p><code>goimports</code> 会自动把依赖包按首字母排序，并对包进行分组管理，通过空行隔开，默认分为本地包（标准库、内部包）、第三方包。</p>
</li>
<li>
<p>标准包永远位于最上面的第一组。</p>
</li>
<li>
<p>内部包是指不能被外部 import 的包，如 GoPath 模式下的包名或者非域名开头的当前项目的 GoModules 包名。</p>
</li>
<li>
<p><code>goimports</code> 默认最少分成本地包和第三方包两大类，这两类包必须分开不能放在一起。本地包或者第三方包内部可以继续按实际情况细分不同子类。</p>
</li>
<li>
<p>不要使用相对路径引入包：</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不要采用这种方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;../net&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><ul>
<li>应该使用完整的路径引入包：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;xxxx.com/proj/net&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><ul>
<li>包名和 git 路径名不一致时，或者多个相同包名冲突时，使用别名代替，别名命名规范和包命名规范保持一致：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 合理用法：包名和 git 路径名不一致，使用别名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">opentracing</span> <span style="color:#4e9a06">&#34;github.com/opentracing/opentracing-go&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 合理用法：多个相同包名冲突，使用别名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;runtime/trace&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nettrace</span> <span style="color:#4e9a06">&#34;golang.net/x/trace&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不合理用法：包名和路径名一致，也不存在多包名冲突，不应该使用别名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nettrace</span> <span style="color:#4e9a06">&#34;golang.net/x/trace&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><ul>
<li>【可选】匿名包的引用建议使用一个新的分组引入，并在匿名包上写上注释说明。</li>
</ul>
<p>完整示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// standard package &amp; inner package
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#4e9a06">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;myproject/models&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;myproject/controller&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// third-party package
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#4e9a06">&#34;git.obc.im/obc/utils&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;git.obc.im/dep/beego&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;git.obc.im/dep/mysql&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">opentracing</span> <span style="color:#4e9a06">&#34;github.com/opentracing/opentracing-go&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// anonymous import package
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// import filesystem storage driver
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">_</span> <span style="color:#a40000">&#34;</span><span style="color:#000">github</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">com</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">org</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">repo</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">pkg</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">storage</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">filesystem</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="2-5-必须-错误处理">2.5 【必须】错误处理</h3>
<h4 id="2-5-1-必须-error-处理">2.5.1 【必须】error 处理</h4>
<ul>
<li>
<p><code>error</code> 作为函数的值返回，必须对 <code>error</code> 进行处理, 或将返回值赋值给明确忽略。对于 <code>defer xx.Close()</code>可以不用显式处理。</p>
</li>
<li>
<p><code>error</code> 作为函数的值返回且有多个返回值的时候，<code>error</code> 必须是最后一个参数。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不要采用这种方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">do</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 要采用下面的方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">do</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>
<p>错误描述不需要标点结尾。</p>
</li>
<li>
<p>采用独立的错误流进行处理。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不要采用这种方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// error handling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// normal code
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 而要采用下面的方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// error handling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#8f5902;font-style:italic">// or continue, etc.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// normal code
</span></span></span></code></pre></div><ul>
<li>如果返回值需要初始化，则采用下面的方式：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// error handling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#8f5902;font-style:italic">// or continue, etc.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// use x
</span></span></span></code></pre></div><ul>
<li>错误返回的判断独立处理，不与其他变量组合逻辑判断。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不要采用这种方式：
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>   <span style="color:#8f5902;font-style:italic">// 当y与err都为空时，函数的调用者会出现错误的调用逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 应当使用如下方式：
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;some error&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>【推荐】对于不需要格式化的错误，生成方式为：<code>errors.New(&quot;xxxx&quot;)</code>。</li>
<li>【推荐】建议go1.13 以上，error 生成方式为：<code>fmt.Errorf(&quot;module xxx: %w&quot;, err)</code>。</li>
</ul>
<h4 id="2-5-2-必须-panic-处理">2.5.2 【必须】panic 处理</h4>
<ul>
<li>
<p>在业务逻辑处理中禁止使用 <code>panic</code>。</p>
</li>
<li>
<p>在 <code>main</code> 包中只有当完全不可运行的情况可使用 <code>panic</code>，例如：文件无法打开，数据库无法连接导致程序无法正常运行。</p>
</li>
<li>
<p>对于其它的包，可导出的接口一定不能有 <code>panic</code>；在包内传递错误时，不推荐使用 <code>panic</code> 来传递 <code>error</code>。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不推荐为传递error而在包内使用panic,以下为示例
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PError 包内定义的错误类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PError</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Error error接口方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span> <span style="color:#000">PError</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Error</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">do</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">str</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// 此处的panic用于传递error
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;错误信息&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Do 包级访问入口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Do</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">str</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">recover</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">PError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">do</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">str</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>
<p>建议在 <code>main</code> 包中使用 <code>log.Fatal</code> 来记录错误，这样就可以由 <code>log</code> 来结束程序，或者将 <code>panic</code> 抛出的异常记录到日志文件中，方便排查问题。</p>
</li>
<li>
<p><code>panic</code> 捕获只能到 <code>goroutine</code> 最顶层，每个自行启动的 <code>goroutine</code>，必须在入口处捕获 <code>panic</code>，并打印详细堆栈信息或进行其它处理。</p>
</li>
</ul>
<h4 id="2-5-3-必须-recover-处理">2.5.3 【必须】recover 处理</h4>
<ul>
<li>
<p><code>recover</code> 用于捕获 <code>runtime</code> 的异常，禁止滥用 <code>recover</code>。</p>
</li>
<li>
<p>必须在 <code>defer</code> 中使用，一般用来捕获程序运行期间发生异常抛出的 <code>panic</code> 或程序主动抛出的 <code>panic</code>。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">recover</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// do something or record log
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;exec panic error: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// log.Println(debug.Stack())
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">getOne</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 手动抛出panic
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// getOne 模拟slice越界 runtime运行时抛出的panic
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">getOne</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">recover</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// do something or record log
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;exec panic error: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// log.Println(debug.Stack())
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">arr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;c&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello,&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 执行结果：
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 2020/01/02 17:18:53 exec panic error:  runtime error: index out of range
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 2020/01/02 17:18:53 exec panic error:  11
</span></span></span></code></pre></div><h3 id="2-6-必须-单元测试">2.6 【必须】单元测试</h3>
<ul>
<li>
<p>单元测试文件名命名规范为 <code>example_test.go</code>。</p>
</li>
<li>
<p>测试用例的函数名称必须以 <code>Test</code> 开头，例如 <code>TestExample</code>。</p>
</li>
<li>
<p>如果存在 <code>func Foo</code>，单测函数可以带下划线，为 <code>func Test_Foo</code>。如果存在 <code>func (b *Bar) Foo</code>，单测函数可以为 <code>func TestBar_Foo</code>。下划线不能出现在前面描述情况以外的位置。</p>
</li>
<li>
<p>单测文件行数限制是普通文件的2倍，即<code>1600行</code>。单测函数行数限制也是普通函数的2倍，即为<code>160行</code>。圈复杂度、列数限制、 import 分组等其他规范细节和普通文件保持一致。</p>
</li>
<li>
<p>由于单测文件内的函数都是不对外的，所有可导出函数可以没有注释，但是结构体定义时尽量不要导出。</p>
</li>
<li>
<p>每个重要的可导出函数都要首先编写测试用例，测试用例和正规代码一起提交方便进行回归测试。</p>
</li>
</ul>
<h3 id="2-7-必须-类型断言失败处理">2.7 【必须】类型断言失败处理</h3>
<ul>
<li><code>type assertion</code> 的单个返回值形式针对不正确的类型将产生 <code>panic</code>。因此，请始终使用 <code>“comma ok”</code> 的惯用法。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不要采用这种方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 而要采用下面的方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 优雅地处理错误
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-注释">3. 注释</h2>
<ol>
<li>在编码阶段同步写好变量、函数、包注释，注释可以通过 <code>godoc</code> 导出生成文档。</li>
<li>程序中每一个被导出的(大写的)名字，都应该有一个文档注释。</li>
<li>所有注释掉的代码在提交 code review 前都应该被删除，除非添加注释讲解为什么不删除， 并且标明后续处理建议（比如删除计划）。</li>
</ol>
<h3 id="3-1-必须-包注释">3.1 【必须】包注释</h3>
<ul>
<li>
<p>每个包都应该有一个包注释。</p>
</li>
<li>
<p>包如果有多个 go 文件，只需要出现在一个 go 文件中（一般是和包同名的文件）即可，格式为：“// Package 包名 包信息描述”。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Package math provides basic constants and mathematical functions.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">math</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 或者
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">Package template implements data-driven templates for generating textual
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">output such as HTML.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">....
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">template</span>
</span></span></code></pre></div><h3 id="3-2-必须-结构体注释">3.2 【必须】结构体注释</h3>
<ul>
<li>
<p>每个需要导出的自定义结构体或者接口都必须有注释说明。</p>
</li>
<li>
<p>注释对结构进行简要介绍，放在结构体定义的前一行。</p>
</li>
<li>
<p>格式为：&quot;// 结构体名 结构体信息描述&quot;。</p>
</li>
<li>
<p>结构体内的可导出成员变量名，如果是个生僻词，或者意义不明确的词，就必须要给出注释，放在成员变量的前一行或同一行的末尾。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// User 用户结构定义了用户基础信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Name</span>  <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Email</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Demographic 族群
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Demographic</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-3-必须-方法注释">3.3 【必须】方法注释</h3>
<ul>
<li>
<p>每个需要导出的函数或者方法（结构体或者接口下的函数称为方法）都必须有注释。注意，如果方法的接收器为不可导出类型，可以不注释，但需要质疑该方法可导出的必要性。</p>
</li>
<li>
<p>注释描述函数或方法功能、调用方等信息。</p>
</li>
<li>
<p>格式为：&quot;// 函数名 函数信息描述&quot;。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewtAttrModel 是属性数据层操作类的工厂方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewAttrModel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">common</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">AttrModel</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// TODO
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-4-必须-变量和常量注释">3.4 【必须】变量和常量注释</h3>
<ul>
<li>
<p>每个需要导出的常量和变量都必须有注释说明。</p>
</li>
<li>
<p>该注释对常量或变量进行简要介绍，放在常量或者变量定义的前一行。</p>
</li>
<li>
<p>大块常量或变量定义时，可在前面注释一个总的说明，然后每一行常量的末尾详细注释该常量的定义。</p>
</li>
<li>
<p>格式为：&quot;// 变量名 变量信息描述&quot;，斜线后面紧跟一个空格。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// FlagConfigFile 配置文件的命令行参数名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">FlagConfigFile</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;--config&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 命令行参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">FlagConfigFile1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;--config&#34;</span> <span style="color:#8f5902;font-style:italic">// 配置文件的命令行参数名1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">FlagConfigFile2</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;--config&#34;</span> <span style="color:#8f5902;font-style:italic">// 配置文件的命令行参数名2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">FlagConfigFile3</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;--config&#34;</span> <span style="color:#8f5902;font-style:italic">// 配置文件的命令行参数名3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">FlagConfigFile4</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;--config&#34;</span> <span style="color:#8f5902;font-style:italic">// 配置文件的命令行参数名4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// FullName 返回指定用户名的完整名称
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">FullName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">username</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fake-%s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">username</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-5-必须-类型注释">3.5 【必须】类型注释</h3>
<ul>
<li>
<p>每个需要导出的类型定义（type definition）和类型别名（type aliases）都必须有注释说明。</p>
</li>
<li>
<p>该注释对类型进行简要介绍，放在定义的前一行。</p>
</li>
<li>
<p>格式为：&quot;// 类型名 类型信息描述&quot;。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// StorageClass 存储类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">StorageClass</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// FakeTime 标准库时间的类型别名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">FakeTime</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span>
</span></span></code></pre></div><h2 id="4-命名规范">4. 命名规范</h2>
<p>命名是代码规范中很重要的一部分，统一的命名规范有利于提高代码的可读性，好的命名仅仅通过命名就可以获取到足够多的信息。</p>
<h3 id="4-1-推荐-包命名">4.1 【推荐】包命名</h3>
<ul>
<li>
<p>保持 <code>package</code> 的名字和目录一致。</p>
</li>
<li>
<p>尽量采取有意义、简短的包名，尽量不要和标准库冲突。</p>
</li>
<li>
<p>包名应该为小写单词，不要使用下划线或者混合大小写，使用多级目录来划分层级。</p>
</li>
<li>
<p>包名可谨慎地使用缩写。当缩写是程序员广泛熟知的词时，可以使用缩写。例如：</p>
<ul>
<li>strconv (string conversion)</li>
<li>syscall (system call)</li>
<li>fmt (formatted I/O)</li>
</ul>
<p>如果缩写有歧义或不清晰，不用缩写。</p>
</li>
<li>
<p>项目名可以通过中划线来连接多个单词。</p>
</li>
<li>
<p>简单明了的包命名，如：<code>time</code>、<code>list</code>、<code>http</code>。</p>
</li>
<li>
<p>不要使用无意义的包名，如：<code>util</code>、<code>common</code>、<code>misc</code>、<code>global</code>。<code>package</code>名字应该追求清晰且越来越收敛，符合‘单一职责’原则。而不是像<code>common</code>一样，什么都能往里面放，越来越膨胀，让依赖关系变得复杂，不利于阅读、复用、重构。注意，<code>xx/util/encryption</code>这样的包名是允许的。</p>
</li>
</ul>
<h3 id="4-2-必须-文件命名">4.2 【必须】文件命名</h3>
<ul>
<li>
<p>采用有意义，简短的文件名。</p>
</li>
<li>
<p>文件名应该采用小写，并且使用下划线分割各个单词。</p>
</li>
</ul>
<h3 id="4-3-必须-结构体命名">4.3 【必须】结构体命名</h3>
<ul>
<li>
<p>采用驼峰命名方式，首字母根据访问控制采用大写或者小写。</p>
</li>
<li>
<p>结构体名应该是名词或名词短语，如 <code>Customer</code>、<code>WikiPage</code>、<code>Account</code>、<code>AddressParser</code>，它不应是动词。</p>
</li>
<li>
<p>避免使用 <code>Data</code>、<code>Info</code> 这类意义太宽泛的结构体名。</p>
</li>
<li>
<p>结构体的声明和初始化格式采用多行，例如：</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// User 多行声明
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Name</span>  <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Email</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 多行初始化
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;john&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Email</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;john@example.com&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-4-推荐-接口命名">4.4 【推荐】接口命名</h3>
<ul>
<li>
<p>命名规则基本保持和结构体命名规则一致。</p>
</li>
<li>
<p>单个函数的接口名以 <code>er</code> 作为后缀，例如 <code>Reader</code>，<code>Writer</code>。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Reader 字节数组读取接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Reader</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Read 读取整个给定的字节数据并返回读取的长度
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>
<p>两个函数的接口名综合两个函数名。</p>
</li>
<li>
<p>三个以上函数的接口名，类似于结构体名。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Car 小汽车结构申明
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Car</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Start ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Stop ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Recover ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Recover</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-5-必须-变量命名">4.5 【必须】变量命名</h3>
<ul>
<li>
<p>变量名必须遵循驼峰式，首字母根据访问控制决定使用大写或小写。</p>
</li>
<li>
<p>特有名词时，需要遵循以下规则：</p>
<ul>
<li>如果变量为私有，且特有名词为首个单词，则使用小写，如 <code>apiClient</code>；</li>
<li>其他情况都应该使用该名词原有的写法，如 <code>APIClient</code>、<code>repoID</code>、<code>UserID</code>；</li>
<li>错误示例：<code>UrlArray</code>，应该写成 <code>urlArray</code> 或者 <code>URLArray</code>；</li>
<li>详细的专有名词列表可参考<a href="https://github.com/golang/lint/blob/738671d3881b9731cc63024d5d88cf28db875626/lint.go#L770">这里</a>。</li>
</ul>
</li>
<li>
<p>私有全局变量和局部变量规范一致，均以小写字母开头。</p>
</li>
<li>
<p>代码生成工具自动生成的代码可排除此规则（如 xxx.pb.go 里面的 Id）。</p>
</li>
<li>
<p>变量名更倾向于选择短命名。特别是对于局部变量。 <code>c</code>比<code>lineCount</code>要好，<code>i</code>比<code>sliceIndex</code>要好。基本原则是：变量的使用和声明的位置越远，变量名就需要具备越强的描述性。</p>
</li>
</ul>
<h3 id="4-6-必须-常量命名">4.6 【必须】常量命名</h3>
<ul>
<li>常量均需遵循驼峰式。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// AppVersion 应用程序版本号定义
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AppVersion</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.0.0&#34;</span>
</span></span></code></pre></div><ul>
<li>如果是枚举类型的常量，需要先创建相应类型：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Scheme 传输协议
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Scheme</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// HTTP 表示HTTP明文传输协议
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">HTTP</span> <span style="color:#000">Scheme</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// HTTPS 表示HTTPS加密传输协议
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">HTTPS</span> <span style="color:#000">Scheme</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;https&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><ul>
<li>私有全局常量和局部变量规范一致，均以小写字母开头。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">appVersion</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.0.0&#34;</span>
</span></span></code></pre></div><h3 id="4-7-必须-函数命名">4.7 【必须】函数命名</h3>
<ul>
<li>函数名必须遵循驼峰式，首字母根据访问控制决定使用大写或小写。</li>
<li>代码生成工具自动生成的代码可排除此规则（如协议生成文件 xxx.pb.go , gotests 自动生成文件 xxx_test.go 里面的下划线）。</li>
</ul>
<h2 id="5-控制结构">5. 控制结构</h2>
<h3 id="5-1-推荐-if">5.1  【推荐】if</h3>
<ul>
<li><code>if</code> 接受初始化语句，约定如下方式建立局部变量：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Chmod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0664</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li><code>if</code> 对两个值进行判断时，约定如下顺序：变量在左，常量在右：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不要采用这种方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// error handling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不要采用这种方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">errorCode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// do something
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 而要采用下面的方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// error handling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 而要采用下面的方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">errorCode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// do something
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li><code>if</code> 对于bool类型的变量，应直接进行真假判断：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">allowUserLogin</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不要采用这种方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allowUserLogin</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// do something
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不要采用这种方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allowUserLogin</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// do something
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 而要采用下面的方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allowUserLogin</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// do something
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 而要采用下面的方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">allowUserLogin</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// do something
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-2-推荐-for">5.2	【推荐】for</h3>
<ul>
<li>采用短声明建立局部变量：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-3-必须-range">5.3	【必须】range</h3>
<ul>
<li>如果只需要第一项（key），就丢弃第二个：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">m</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expired</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>如果只需要第二项，则把第一项置为下划线：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">array</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">value</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-4-必须-switch">5.4	【必须】switch</h3>
<ul>
<li>要求必须有 <code>default</code>：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">os</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GOOS</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">os</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;darwin&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;OS X.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;linux&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Linux.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// freebsd, openbsd,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// plan9, windows...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s.\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-5-推荐-return">5.5 【推荐】return</h3>
<ul>
<li>尽早 <code>return</code>，一旦有错误发生，马上返回：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">codeUsing</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="5-6-必须-goto">5.6 【必须】goto</h3>
<ul>
<li>业务代码禁止使用 <code>goto</code>，其他框架或底层源码推荐尽量不用。</li>
</ul>
<h2 id="6-函数">6. 函数</h2>
<h3 id="6-1-推荐-函数参数">6.1 【推荐】函数参数</h3>
<ul>
<li>函数返回相同类型的两个或三个参数，或者如果从上下文中不清楚结果的含义，使用命名返回，其它情况不建议使用命名返回。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Parent1 ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Parent1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Node</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Parent2 ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Parent2</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Location ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Foo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Location</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lat</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">long</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><ul>
<li>
<p>传入变量和返回变量以小写字母开头。</p>
</li>
<li>
<p>参数数量均不能超过<code>5个</code>。</p>
</li>
<li>
<p>尽量用值传递，非指针传递。</p>
</li>
<li>
<p>传入参数是 <code>map</code>，<code>slice</code>，<code>chan</code>，<code>interface</code> 不要传递指针。</p>
</li>
</ul>
<h3 id="6-2-必须-defer">6.2 【必须】defer</h3>
<ul>
<li>
<p>当存在资源管理时，应紧跟 <code>defer</code> 函数进行资源的释放。</p>
</li>
<li>
<p>判断是否有错误发生之后，再 <code>defer</code> 释放资源。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">resp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 如果操作成功，再defer Close()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">resp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><ul>
<li>禁止在循环中使用 <code>defer</code>，举例如下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不要这样使用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">filterSomething</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">values</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">values</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Query</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 示例，实际不要这么查询，防止sql注入
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// xxx
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 继续使用fields
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 应当使用如下的方式：
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">filterSomething</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">values</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">values</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Query</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 示例，实际不要这么查询，防止sql注入
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 继续使用fields
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="6-3-推荐-方法的接收器">6.3 【推荐】方法的接收器</h3>
<ul>
<li>
<p>【推荐】推荐以类名第一个英文首字母的小写作为接收器的命名。</p>
</li>
<li>
<p>【推荐】接收器的命名在函数超过<code>20行</code>的时候不要用单字符。</p>
</li>
<li>
<p>【必须】命名不能采用 <code>me</code>，<code>this</code>，<code>self</code> 这类易混淆名称。</p>
</li>
</ul>
<h3 id="6-4-推荐-代码行数">6.4 【推荐】代码行数</h3>
<ul>
<li>
<p>【必须】文件长度不能超过<code>800行</code>。</p>
</li>
<li>
<p>【推荐】函数长度不能超过<code>80行</code>（函数长度为函数签名左括号下一行开始到右括号上一行结束部分的行数，包括代码行，注释行，空行）。</p>
</li>
</ul>
<h3 id="6-5-必须-嵌套">6.5 【必须】嵌套</h3>
<ul>
<li>嵌套深度不能超过<code>4层</code>：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// AddArea 添加成功或出错
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">BookingService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">AddArea</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">areas</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">area</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">areas</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">has</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">areas</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">area</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">has</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">srverr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrAreaConflict</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">areas</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">areas</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">area</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">areaOrders</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">area</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">order</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AreaOrder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 建议调整为这样：
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// AddArea 添加成功或出错
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">BookingService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">AddArea</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">areas</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">area</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">areas</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HasArea</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">area</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">srverr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrAreaConflict</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">areas</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">areas</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">area</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">areaOrders</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">area</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">order</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AreaOrder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HasArea ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">BookingService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HasArea</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">area</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">has</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">areas</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">area</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">has</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="6-6-推荐-变量声明">6.6 【推荐】变量声明</h3>
<ul>
<li>变量声明尽量放在变量第一次使用前面，就近原则。</li>
</ul>
<h3 id="6-7-必须-魔法数字">6.7 【必须】魔法数字</h3>
<ul>
<li>如果魔法数字出现超过<code>2次</code>，则禁止使用。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">getArea</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">3.14</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">r</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">getLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">3.14</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">r</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>用一个常量代替：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PI ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">PI</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3.14</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">getArea</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">PI</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">r</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">getLength</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">PI</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">r</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="7-依赖管理">7. 依赖管理</h2>
<h3 id="7-1-必须-go1-11-以上必须使用-go-modules-模式">7.1 【必须】go1.11 以上必须使用 <code>go modules</code> 模式：</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">mod</span> <span style="color:#000">init</span> <span style="color:#000">git</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">xxx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">com</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">group</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">myrepo</span>
</span></span></code></pre></div><h3 id="7-2-推荐-代码提交">7.2 【推荐】代码提交</h3>
<ul>
<li>
<p>建议所有不对外开源的工程的 <code>module name</code> 使用 <code>git.xxx.com/group/repo</code> ，方便他人直接引用。</p>
</li>
<li>
<p>建议使用 <code>go modules</code> 作为依赖管理的项目不提交 <code>vendor</code> 目录。</p>
</li>
<li>
<p>建议使用 <code>go modules</code> 管理依赖的项目， <code>go.sum</code> 文件必须提交，不要添加到 .gitignore 规则中。</p>
</li>
</ul>
<h2 id="8-应用服务">8. 应用服务</h2>
<h3 id="8-1-推荐-应用服务接口建议有-readme-md">8.1 【推荐】应用服务接口建议有 <code>README.md</code></h3>
<ul>
<li>其中建议包括服务基本描述、使用方法、部署时的限制与要求、基础环境依赖（例如最低 go 版本、最低外部通用包版本）等。</li>
</ul>
<h3 id="8-2-必须-应用服务必须要有接口测试">8.2 【必须】应用服务必须要有接口测试。</h3>
<h2 id="附-常用工具">附：常用工具</h2>
<p>go 语言本身在代码规范性这方面也做了很多努力，很多限制都是强制语法要求，例如左大括号不换行，引用的包或者定义的变量不使用会报错，此外 go 还是提供了很多好用的工具帮助我们进行代码的规范。</p>
<ul>
<li><code>gofmt</code> ，大部分的格式问题可以通过 <code>gofmt</code> 解决， <code>gofmt</code> 自动格式化代码，保证所有的 go 代码与官方推荐的格式保持一致，于是所有格式有关问题，都以 <code>gofmt</code> 的结果为准。</li>
<li><code>goimports</code> ，此工具在 <code>gofmt</code> 的基础上增加了自动删除和引入包。</li>
<li><code>go vet</code> ，<code>vet</code> 工具可以帮我们静态分析我们的源码存在的各种问题，例如多余的代码，提前 <code>return</code> 的逻辑， <code>struct</code> 的 <code>tag</code> 是否符合标准等。编译前先执行代码静态分析。</li>
<li><code>golint</code> ，类似 <code>javascript</code> 中的 <code>jslint</code> 的工具，主要功能就是检测代码中不规范的地方。</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bf6db6ddcb3a618c34fdf7a675a73437">10.2 - golangci-lint的使用</h1>
    
	<p>golangci-lint是一种go linter的工具，支持快速，可配置多种linter参数的功能。在go项目中使用golangci-lint可以帮助多人团队开发的代码风格及质量的一致性，同时也可以帮助开发者提高代码质量。可以结合<a href="https://blog.huweihuang.com/golang-notes/standard/go-style-guide/">Golang 代码规范</a>配置golangci-lint的参数。</p>
<p>本文主要介绍该工具的使用及常见推荐配置。</p>
<h1 id="1-golangci-lint安装">1. golangci-lint安装</h1>
<p>golangci-lint推荐在Makefile文件中配置安装和执行命令，参考如下Makefile内容：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">## golangci-lint的安装及命令
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">GOLANGCI_LINT</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">$(</span>shell <span style="color:#204a87">pwd</span><span style="color:#204a87;font-weight:bold">)</span>/bin/golangci-lint
</span></span><span style="display:flex;"><span><span style="color:#000">GOLANGCI_LINT_VERSION</span> <span style="color:#ce5c00;font-weight:bold">?=</span> v1.54.2
</span></span><span style="display:flex;"><span><span style="color:#000">golangci-lint</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	@<span style="color:#ce5c00;font-weight:bold">[</span> -f <span style="color:#204a87;font-weight:bold">$(</span>GOLANGCI_LINT<span style="color:#204a87;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	<span style="color:#204a87">set</span> -e <span style="color:#000;font-weight:bold">;</span><span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh <span style="color:#000;font-weight:bold">|</span> sh -s -- -b <span style="color:#204a87;font-weight:bold">$(</span>shell dirname <span style="color:#204a87;font-weight:bold">$(</span>GOLANGCI_LINT<span style="color:#204a87;font-weight:bold">))</span> <span style="color:#204a87;font-weight:bold">$(</span>GOLANGCI_LINT_VERSION<span style="color:#204a87;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">;</span><span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">.PHONY</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">lint</span>
</span></span><span style="display:flex;"><span><span style="color:#000">lint</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">golangci</span>-<span style="color:#000">lint</span> <span style="color:#8f5902;font-style:italic">## Run golangci-lint linter &amp; yamllint
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">$(</span>GOLANGCI_LINT<span style="color:#204a87;font-weight:bold">)</span> run --timeout<span style="color:#ce5c00;font-weight:bold">=</span>10m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">.PHONY</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">lint</span>-<span style="color:#000">fix</span>
</span></span><span style="display:flex;"><span><span style="color:#000">lint-fix</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">golangci</span>-<span style="color:#000">lint</span> <span style="color:#8f5902;font-style:italic">## Run golangci-lint linter and perform fixes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">$(</span>GOLANGCI_LINT<span style="color:#204a87;font-weight:bold">)</span> run --fix
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">## 配置在build阶段执行lint命令
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">##@ Build
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">.PHONY</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">build</span>
</span></span><span style="display:flex;"><span><span style="color:#000">build</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">fmt</span> <span style="color:#000">vet</span> <span style="color:#000">lint</span> <span style="color:#8f5902;font-style:italic">## Build manager binary.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	bash hack/build.sh
</span></span></code></pre></div><p>可以在makefile中集成golangci-lint，同时集成到代码CI的流程中，在代码提交和merge前自动执行golangci-lint的操作。</p>
<p>通过执行<code>make lint</code>的命令即可运行golangci-lint。</p>
<h1 id="2-配置参数说明">2. 配置参数说明</h1>
<h3 id="基础检测-推荐所有项目开启"><strong>基础检测（推荐所有项目开启）</strong></h3>
<p>这些 linters 检查常见的代码错误和潜在问题：</p>
<ul>
<li><strong><code>govet</code></strong>: [默认开启]Go 内置的静态分析工具，用于检查可能导致运行时错误的问题。</li>
<li><strong><code>gosimple</code></strong>:  [默认开启]提示可以简化的代码。</li>
<li><strong><code>staticcheck</code></strong>:  [默认开启]检测潜在错误、不良代码风格以及性能优化建议。</li>
<li><strong><code>errcheck</code></strong>: [默认开启] 检查未处理的错误。</li>
<li><strong><code>ineffassign</code></strong>: [默认开启] 检测无效的变量赋值。</li>
<li><strong><code>unused</code></strong>:  [默认开启]检测未使用的代码（变量、函数等）。</li>
</ul>
<hr>
<h3 id="代码风格和一致性"><strong>代码风格和一致性</strong></h3>
<p>这些 linters 确保代码风格一致，易于维护：</p>
<ul>
<li><strong><code>gofmt</code></strong>: 强制格式化代码。</li>
<li><strong><code>goimports</code></strong>: 格式化代码并管理导入的包。</li>
<li><strong><code>typecheck</code></strong>: 检查类型错误。</li>
<li><strong><code>misspell</code></strong>: 检测并修复拼写错误。</li>
<li><strong><code>stylecheck</code></strong>: 提供风格建议，确保代码符合 Go 的约定。</li>
<li><strong><code>dupl</code></strong>: 检测代码中的重复部分。</li>
<li><strong><code>wsl</code></strong>: 确保 <code>if</code> 语句等块代码之间有适当的空行。</li>
</ul>
<hr>
<h3 id="复杂度和性能"><strong>复杂度和性能</strong></h3>
<p>用于优化代码的可读性和性能：</p>
<ul>
<li><strong><code>gocyclo</code></strong>: 检测代码的圈复杂度，确保函数复杂度不会过高（默认阈值为 30）。</li>
<li><strong><code>funlen</code></strong>: 检查函数和文件的长度（如上所述）。</li>
<li><strong><code>megacheck</code></strong>: 组合了 <code>gosimple</code>, <code>unused</code>, 和 <code>staticcheck</code>。</li>
<li><strong><code>prealloc</code></strong>: 检测在大型切片中是否提前分配了容量。</li>
</ul>
<hr>
<h3 id="安全性"><strong>安全性</strong></h3>
<p>检测安全问题，适合对代码安全性有要求的项目：</p>
<ul>
<li><strong><code>nakedret</code></strong>: 检查是否有裸返回值，可能导致混淆或错误。</li>
<li><strong><code>gosec</code></strong>: 检测常见的安全问题，例如 SQL 注入、弱密码等。</li>
<li><strong><code>maligned</code></strong>: 检测结构体字段排列是否影响内存对齐。</li>
</ul>
<h1 id="3-golangci-yml推荐配置">3. golangci.yml推荐配置</h1>
<p>可以通过<code>.golangci.yml</code>配置文件来配置详细的lint参数，在项目的根目录下创建该文件。常用推荐配置如下：</p>
<p>为了可以精准控制开启的类型，可以<code>把disable-all设置为true</code>，然后再根据团队需要逐步添加enable的类型，避免开启检查过多影响开发效率。</p>
<ul>
<li>linters：主要配置开启或关闭的检查类型。</li>
<li>linters-settings：针对linters中的具体检查类型配置该类型的参数。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">run</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;10m&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">linters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">disable-all</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># basic</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">govet</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">staticcheck</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">errcheck</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">ineffassign</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">gosimple</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">unused</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># style</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">gofmt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">goimports</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">misspell</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">stylecheck</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">dupl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">wsl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">goconst</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># complexity</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">funlen</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">gocyclo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">lll</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># security</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">gosec</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">linters-settings</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">funlen</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Checks the number of lines in a function.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">lines</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Checks the number of statements in a function.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">statements</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">40</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Ignore comments when counting lines.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ignore-comments</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">lines-in-file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">800</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">gocyclo</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Minimal code complexity to report.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Default: 30 (but we recommend 10-20)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">min-complexity</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">lll</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Max line length, lines longer will be reported.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Default: 120.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">line-length</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">120</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dupl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Tokens count to trigger issue.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Default: 150</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">threshold</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">output</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">format</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">colored-line-number</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">print-issued-lines</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">print-config</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://golangci-lint.run/">https://golangci-lint.run/</a></li>
<li><a href="https://golangci-lint.run/usage/configuration/">https://golangci-lint.run/usage/configuration/</a></li>
<li><a href="https://golangci-lint.run/usage/linters/">https://golangci-lint.run/usage/linters/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fb52125a339fb8f5e65e197f800dc327">10.3 - golangci-lint问题优化</h1>
    
	<p>在<a href="https://blog.huweihuang.com/golang-notes/standard/golangci-lint/">golangci-lint的使用介绍</a>一文中我们提到了linter常见的几种配置，例如，gocyclo（圈复杂度），dupl（重复代码）等。本文主要介绍这几种常见linter的问题如何优化。</p>
<h1 id="1-gocyclo-圈复杂度">1. gocyclo（圈复杂度）</h1>
<p>在 Go 中，<strong>圈复杂度（Cyclomatic Complexity）</strong> 是一种衡量代码复杂度的指标，表示代码中可能的独立执行路径的数量。它反映了程序的逻辑复杂度，也就是代码有多少个分支或决策点（如 <code>if</code>、<code>for</code>、<code>switch</code> 等）。圈复杂度越高，代码的理解和维护成本就越大。</p>
<p><code>.golangci.yml</code>中圈复杂度的配置如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">linters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#204a87;font-weight:bold">enabel</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	  </span>- <span style="color:#000">gocycle</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">linters-settings</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">gocyclo</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Minimal code complexity to report.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Default: 30 (but we recommend 10-20)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">min-complexity</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="1-1-计算规则">1.1. 计算规则</h2>
<p>圈复杂度的计算公式为：</p>
<p><code>M=E−N+2P</code></p>
<p>其中：</p>
<ul>
<li>E：代码中的边数（控制流图中的边，表示程序中的控制流路径，例如从一条语句跳转到下一条语句）。</li>
<li>N：代码中的节点数（控制流图中的节点，表示程序中的基本块或语句）。</li>
<li>P：控制流图中连通部分的数量（通常为 1）。</li>
</ul>
<p>简单来说，圈复杂度可以通过统计代码中的以下决策点来估算，其中<code>初始值为1，即默认返回路径，再根据以下规则累加</code>：</p>
<ul>
<li>每个 <code>if</code> 或 <code>else if</code> 增加 1。</li>
<li>每个 <code>for</code> 或 <code>while</code> 循环增加 1。</li>
<li>每个 <code>case</code>（不包括 <code>default</code>）增加 1。</li>
<li>每个 <code>&amp;&amp;</code> 或 <code>||</code> 表达式增加 1。</li>
</ul>
<p>举例说明：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Example</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">a</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">// if语句 +1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">b</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">// if语句 +1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#000">初始值为1</span> 
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>控制流路径为：</p>
<ul>
<li>初始值为1</li>
<li>2个if语句 + 2</li>
</ul>
<p>因此该函数的圈复杂度为3。</p>
<h2 id="1-2-常见标准">1.2. 常见标准</h2>
<p>通常，<code>圈复杂度以合理的范围为佳（例如：10-15），过低的圈复杂度会导致拆分函数过多，代码可读性变差</code>。</p>
<p>以下是圈复杂度的参考标准：</p>
<ul>
<li><strong>1-10</strong>：代码逻辑简单，可维护性高。</li>
<li><strong>11-20</strong>：代码逻辑较复杂，可能需要重构。</li>
<li><strong>21+</strong>：代码逻辑非常复杂，维护成本高，建议拆分函数。</li>
</ul>
<h2 id="1-3-优化圈复杂度">1.3. 优化圈复杂度</h2>
<ol>
<li><code>拆分函数</code>：（最常见的方式）将复杂的函数拆分成多个小函数，每个函数只处理一种逻辑。</li>
<li><code>减少嵌套</code>：使用 <code>early return</code> 减少嵌套层级。</li>
<li><code>简化逻辑</code>：合并条件表达式，避免重复的分支逻辑。</li>
</ol>
<p>优化圈复杂度的关键在于：</p>
<ol>
<li>减少嵌套，增加代码的扁平化。</li>
<li>提高代码的模块化和复用性。</li>
</ol>
<h1 id="2-dupl-重复代码">2. dupl（重复代码）</h1>
<p>Golang 的静态分析工具（如 <code>golangci-lint</code>）能够检测代码中的重复部分。这类工具通常使用<strong>重复代码检测算法</strong>，通过对代码块进行特定分析，找到相似或完全相同的代码片段。</p>
<p>golangci-lint中检查重复代码的配置如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">linters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	</span><span style="color:#204a87;font-weight:bold">enabel</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">	  </span>- <span style="color:#000">dupl</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">linters-settings</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dupl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Tokens count to trigger issue.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Default: 150</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">threshold</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-1-计算规则">2.1. 计算规则</h2>
<p><strong>Tokenization（代码标记化）</strong></p>
<p>工具会将源代码分解为标记（Token），比如关键字、标识符、操作符等。通过这种方式，它可以忽略注释和格式差异，只关注代码的语义。</p>
<p><strong>Token</strong> 是代码的最小组成单元，包括：</p>
<ul>
<li>关键字：如 <code>if</code>、<code>for</code>、<code>switch</code>。</li>
<li>标识符：变量名、函数名、类型名等。</li>
<li>操作符：如 <code>+</code>、<code>-</code>、<code>*</code>、<code>/</code> 等。</li>
<li>常量值：如 <code>123</code>、<code>&quot;text&quot;</code>。</li>
<li>界符：如 <code>{</code>、<code>}</code>、<code>(</code>、<code>)</code>。</li>
</ul>
<p><strong><code>threshold</code> 参数的作用</strong></p>
<ul>
<li><strong>定义：</strong> <code>threshold</code> 是重复代码块的最小 Token 数。</li>
<li>如果两个代码块中有 <strong>相同 Token 的数量</strong> &gt;= <code>threshold</code>，则会被认为是重复代码，并报告。</li>
</ul>
<p><strong>示例：<code>threshold: 50</code></strong></p>
<ul>
<li>如果两个代码块中有 50 个或更多的 Token 是相同的，<code>dupl</code> 会报告它们为重复代码。</li>
<li>小于 50 个 Token 的重复代码不会被报告。</li>
</ul>
<h2 id="2-2-配置方式">2.2. 配置方式</h2>
<p>通过配置threshold的大小可以控制重复代码的粒度。threshold默认值是150，可根据需要调整大小。</p>
<ul>
<li>
<p><code>阈值越小：越容易检测到小的重复代码，但可能导致误报增多。</code></p>
</li>
<li>
<p><code>阈值越大：检测更宽松，只报告较大的重复代码块。</code></p>
</li>
</ul>
<p>当发现重复代码时，<code>golangci-lint</code> 会输出类似的报告：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>main.go:10-20: duplicated code found in main.go:30-40 <span style="color:#ce5c00;font-weight:bold">(</span>dupl<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>如果要忽略特定代码，在代码中添加注释：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//nolint:dupl
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">SomeFunction</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 重复代码块
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-优化重复代码">2.3. 优化重复代码</h2>
<ol>
<li><code>提取函数</code>：将重复逻辑抽象为通用函数。</li>
<li><code>映射表代替分支</code>： 用键值对简化条件逻辑。</li>
<li><code>利用泛型</code>： 合并不同类型的重复逻辑。</li>
</ol>
<p>示例1：</p>
<p>如果重复代码包含多个 <code>if-else</code> 或 <code>switch</code>，尝试用映射表或配置文件替代。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Before: 重复代码块
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">GetDiscount</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">category</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">category</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;student&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0.15</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;veteran&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0.2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;senior&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0.25</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// After: 使用映射表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">GetDiscount</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">category</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">discounts</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;student&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.15</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;veteran&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;senior&#34;</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#0000cf;font-weight:bold">0.25</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">discounts</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">category</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>示例2：</p>
<p>使用 <strong>泛型</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Before: 重复代码块
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FindMaxInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">a</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">b</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FindMaxFloat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">a</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">b</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// After: 使用泛型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FindMax</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">T</span> <span style="color:#000">constraints</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ordered</span><span style="color:#000;font-weight:bold">](</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">T</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">a</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">b</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-总结">3. 总结</h1>
<p>本文主要分析了<code>gocyclo（圈复杂度）</code>，<code>dupl（重复代码）</code>这2种linter配置的检测、配置和优化方式。因为在多人团队的开发中经常会因为开发者的水平不一，标准不一导致无法开发出统一且较高质量的代码。虽然代码的质量不会严格影响功能的运行，但可以为未来的开发者提供可读性更强，更方便接手开发的代码。同样通过这种方式也能初步看出一个开发者代码质量水平的高低。</p>
<p>参考：</p>
<ul>
<li><a href="https://golangci-lint.run/usage/linters/#gocyclo">https://golangci-lint.run/usage/linters/#gocyclo</a></li>
<li><a href="https://golangci-lint.run/usage/linters/#dupl">https://golangci-lint.run/usage/linters/#dupl</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1d9157890092db27ff6b9052b385ad09">11 - Web编程</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-30303a9620afccb7ad52ab3708f56c92">11.1 - Http包源码分析</h1>
    
	<h1 id="1-http包建立web服务器">1. http包建立web服务器</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">sayhelloName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseForm</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Form</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;path&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Path</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scheme&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Form</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;url_long&#34;</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Form</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;val:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hello world&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sayhelloName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:9090&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ListenAndServe:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-http包的运行机制">2. http包的运行机制</h1>
<p>相关源码位于：/src/net/http/server.go</p>
<p><strong>服务端的几个概念</strong></p>
<ul>
<li>Request：用户请求的信息，用来解析用户的请求信息，包括post，get，Cookie，url等信息。</li>
<li>Response:服务器需要反馈给客户端的信息。</li>
<li>Conn：用户的每次请求链接。</li>
<li>Handle:处理请求和生成返回信息的处理逻辑。</li>
</ul>
<p><strong>Go实现web服务的流程</strong></p>
<ol>
<li>创建Listen Socket，监听指定的端口，等待客户端请求到来。</li>
<li>Listen Socket接受客户端的请求，得到Client Socket，接下来通过Client Socket与客户端通信。</li>
<li>处理客户端请求，首先从Client Socket读取HTTP请求的协议头，如果是POST方法，还可能要读取客户端提交的数据，然后交给相应的handler处理请求，handler处理完，将数据通过Client Socket返回给客户端。</li>
</ol>
<h2 id="2-1-http包执行流程图">2.1. http包执行流程图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578729/article/golang/http/http-flow.png" alt="image2017-3-5 22-46-35"></p>
<h2 id="2-2-注册路由-handlefunc">2.2. 注册路由[HandleFunc]</h2>
<p>http.HandlerFunc类型默认实现了ServeHTTP的接口。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The HandlerFunc type is an adapter to allow the use of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ordinary functions as HTTP handlers.  If f is a function
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// with the appropriate signature, HandlerFunc(f) is a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Handler that calls f.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">HandlerFunc</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ServeHTTP calls f(w, r).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#000">HandlerFunc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">f</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandleFunc registers the handler function for the given pattern
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// in the DefaultServeMux.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The documentation for ServeMux explains how patterns are matched.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">DefaultServeMux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandleFunc registers the handler function for the given pattern.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">mux</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ServeMux</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HandlerFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">handler</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>Handle</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Handle registers the handler for the given pattern.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If a handler already exists for pattern, Handle panics.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">mux</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ServeMux</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pattern</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http: invalid pattern &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">handler</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http: nil handler&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">explicit</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http: multiple registrations for &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">muxEntry</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">explicit</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#39;/&#39;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hosts</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Helpful behavior:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// If pattern is /tree/, insert an implicit permanent redirect for /tree.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// It can be overridden by an explicit registration.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">n</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">n</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;/&#39;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">n</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]].</span><span style="color:#000">explicit</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// If pattern contains a host name, strip it and use remaining
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// path for redirect.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pattern</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#39;/&#39;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// In pattern, at least the last character is a &#39;/&#39;, so
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#8f5902;font-style:italic">// strings.Index can&#39;t be -1.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">path</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">):]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">url</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Path</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">n</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">muxEntry</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">h</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">RedirectHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">StatusMovedPermanently</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-如何监听端口">2.3. 如何监听端口</h2>
<p>通过ListenAndServe来监听，底层实现：初始化一个server对象，调用net.Listen(&quot;tcp&quot;,addr)，也就是底层用TCP协议搭建了一个服务，监听设置的端口。然后调用srv.Serve(net.Listener)函数，这个函数处理接收客户端的请求信息。这个函数里起了一个for循环，通过Listener接收请求，创建conn，开一个goroutine，把请求的数据当作参数给conn去服务：go c.serve()，即每次请求都是在新的goroutine中去服务，利于高并发。</p>
<p><strong>src/net/http/server.go</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListenAndServe always returns a non-nil error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addr</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Addr</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListenAndServe listens on the TCP network address srv.Addr and then
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// calls Serve to handle requests on incoming connections.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Accepted connections are configured to enable TCP keep-alives.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If srv.Addr is blank, &#34;:http&#34; is used.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListenAndServe always returns a non-nil error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">srv</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">addr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">srv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Addr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">addr</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">addr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ln</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">srv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tcpKeepAliveListener</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">ln</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TCPListener</span><span style="color:#000;font-weight:bold">)})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-4-如何接收客户端的请求">2.4. 如何接收客户端的请求</h2>
<p>srv.Serve</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Serve accepts incoming connections on the Listener l, creating a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// new service goroutine for each. The service goroutines read requests and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// then call srv.Handler to reply to them.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Serve always returns a non-nil error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">srv</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">l</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listener</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fn</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">testHookServerServe</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">fn</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">srv</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">tempDelay</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span> <span style="color:#8f5902;font-style:italic">// how long to sleep on accept failure
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">srv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setupHTTP2</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Accept</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ne</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">ne</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Temporary</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tempDelay</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">tempDelay</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">tempDelay</span> <span style="color:#ce5c00;font-weight:bold">*=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">max</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">tempDelay</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">max</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">tempDelay</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">max</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">srv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http: Accept error: %v; retrying in %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tempDelay</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tempDelay</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">e</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">tempDelay</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">srv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">newConn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rwc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">StateNew</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// before Serve can return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serve</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>关键代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">srv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">newConn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rwc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">StateNew</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// before Serve can return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serve</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><strong>newConn</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create new connection from rwc.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">srv</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">newConn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rwc</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">conn</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">conn</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">server</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">srv</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">rwc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">rwc</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">debugServerConnections</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rwc</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newLoggingConn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;server&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rwc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">c</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-5-如何分配handler">2.5. 如何分配handler</h2>
<p>conn先解析request：c.readRequest()，获取相应的handler:handler:=c.server.Handler，即ListenAndServe的第二个参数，因为值为nil，所以默认handler=DefaultServeMux。该变量是一个路由器，用来匹配url跳转到其相应的handle函数。其中http.HandleFunc(&quot;/&quot;,sayhelloName)即注册了请求“/”的路由规则，当uri为“/”时，路由跳转到函数sayhelloName。DefaultServeMux会调用ServeHTTP方法，这个方法内部调用sayhelloName本身，最后写入response的信息反馈给客户端。</p>
<h2 id="2-5-1-c-serve">2.5.1. c.serve()</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Serve a new connection.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">conn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">serve</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">readRequest</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">serverHandler</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">}.</span><span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">w</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">..</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-5-2-c-readrequest">2.5.2. c.readRequest()</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Read next request from connection.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">conn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">readRequest</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hijacked</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ErrHijacked</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadTimeout</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rwc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetReadDeadline</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteTimeout</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rwc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetWriteDeadline</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setReadLimit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">initialReadLimitSize</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// while using bufr
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastMethod</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;POST&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// RFC 2616 section 4.1 tolerance for old buggy clients.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">peek</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bufr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Peek</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// ReadRequest will get err below
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bufr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Discard</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">numLeadingCRorLF</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">peek</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">readRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bufr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keepHostHeader</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hitReadLimit</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errTooLarge</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastMethod</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Method</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setInfiniteReadLimit</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">hosts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">haveHost</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Header</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Host&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProtoAtLeast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(!</span><span style="color:#000">haveHost</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">hosts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">badRequestError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;missing required Host header&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">hosts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">badRequestError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;too many Host headers&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">hosts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">validHostHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">hosts</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">badRequestError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;malformed Host header&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vv</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Header</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">validHeaderName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">badRequestError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;invalid header name&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">vv</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">validHeaderValue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">badRequestError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;invalid header value&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Header</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Host&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteAddr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">remoteAddr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TLS</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tlsState</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Body</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">doEarlyClose</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">w</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">req</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reqBody</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">handlerHeader</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Header</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">contentLength</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">w</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cw</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">res</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">w</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">w</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">w</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newBufioWriterSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bufferBeforeChunkingSize</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-5-3-servehttp-w-w-req">2.5.3. ServeHTTP(w, w.req)</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sh</span> <span style="color:#000">serverHandler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span> <span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">handler</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sh</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">srv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">handler</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">handler</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">DefaultServeMux</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestURI</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;*&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Method</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;OPTIONS&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">handler</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">globalOptionsHandler</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-5-4-defaultservemux">2.5.4. DefaultServeMux</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ServeMux</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mu</span>    <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RWMutex</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">m</span>     <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">muxEntry</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">hosts</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#8f5902;font-style:italic">// whether any patterns contain hostnames
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">muxEntry</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">explicit</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">h</span>        <span style="color:#000">Handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pattern</span>  <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewServeMux allocates and returns a new ServeMux.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewServeMux</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ServeMux</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ServeMux</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">muxEntry</span><span style="color:#000;font-weight:bold">)}</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// DefaultServeMux is the default ServeMux used by Serve.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">DefaultServeMux</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">NewServeMux</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><strong>handler接口的定义</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Handler</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-5-5-servemux-servehttp">2.5.5. ServeMux.ServeHTTP</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ServeHTTP dispatches the request to the handler whose
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pattern most closely matches the request URL.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">mux</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ServeMux</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestURI</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;*&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProtoAtLeast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">w</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Header</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Connection&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;close&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">w</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">StatusBadRequest</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">h</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">h</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>mux.Handler(r)</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Handler returns the handler to use for the given request,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// consulting r.Method, r.Host, and r.URL.Path. It always returns
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// a non-nil handler. If the path is not in its canonical form, the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// handler will be an internally-generated handler that redirects
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to the canonical path.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Handler also returns the registered pattern that matches the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// request or, in the case of internally-generated redirects,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the pattern that will match after following the redirect.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If there is no registered handler that applies to the request,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Handler returns a ``page not found&#39;&#39; handler and an empty pattern.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">mux</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ServeMux</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">h</span> <span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pattern</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Method</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;CONNECT&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cleanPath</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Path</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Path</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pattern</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">url</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">url</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Path</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">RedirectHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">StatusMovedPermanently</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">pattern</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Path</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// handler is the main implementation of Handler.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The path is known to be in canonical form, except for CONNECT methods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">mux</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ServeMux</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">path</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">h</span> <span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pattern</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RLock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RUnlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Host-specific pattern takes precedence over generic ones
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hosts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">h</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pattern</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">match</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">host</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">h</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pattern</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">match</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">h</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pattern</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">NotFoundHandler</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-6-http连接处理流程图">2.6. http连接处理流程图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578730/article/golang/http/http-connect-flow.png" alt="image2017-3-5 23-50-6"></p>
<h1 id="3-http的执行流程总结">3. http的执行流程总结</h1>
<p>1、首先调用Http.HandleFunc，按如下顺序执行：</p>
<ol>
<li>调用了DefaultServerMux的HandleFunc。</li>
<li>调用了DefaultServerMux的Handle。</li>
<li>往DefaultServerMux的map[string] muxEntry中增加对应的handler和路由规则。</li>
</ol>
<p>2、调用http.ListenAndServe(&quot;:9090&quot;,nil)，按如下顺序执行：</p>
<ol>
<li>实例化Server。</li>
<li>调用Server的ListenAndServe()。</li>
<li>调用net.Listen(&quot;tcp&quot;,addr)监听端口。</li>
<li>启动一个for循环，在循环体中Accept请求。</li>
<li>对每个请求实例化一个Conn，并且开启一个goroutine为这个请求进行服务go c.serve()。</li>
<li>读取每个请求的内容w,err:=c.readRequest()。</li>
<li>判断handler是否为空，如果没有设置handler，handler默认设置为DefaultServeMux。</li>
<li>调用handler的ServeHttp。</li>
<li>根据request选择handler，并且进入到这个handler的ServeHTTP,
mux.handler(r).ServeHTTP(w,r)</li>
<li>选择handler</li>
</ol>
<ul>
<li>判断是否有路由能满足这个request（循环遍历ServeMux的muxEntry）。</li>
<li>如果有路由满足，调用这个路由handler的ServeHttp。</li>
<li>如果没有路由满足，调用NotFoundHandler的ServeHttp。</li>
</ul>
<h1 id="4-自定义路由">4. 自定义路由</h1>
<p>Go支持外部实现路由器，ListenAndServe的第二个参数就是配置外部路由器，它是一个Handler接口。即外部路由器实现Hanlder接口。</p>
<p>Handler接口：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Handler</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>自定义路由</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">MyMux</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">MyMux</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Path</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sayhelloName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NotFound</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">sayhelloName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;Hello myroute&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mux</span><span style="color:#ce5c00;font-weight:bold">:=&amp;</span><span style="color:#000">MyMux</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:9090&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">mux</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>文章参考：</p>
<p>《Go web编程》</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f168014131eb383b79bb6cde867ee7b7">11.2 - Beego Web框架</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-d920f3d65e431a30e0dcb5ea3fbd7f6d">11.2.1 - Beego 介绍</h1>
    
	<h1 id="1-beego的使用">1. beego的使用</h1>
<h2 id="1-1-beego的安装">1.1. beego的安装</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">get</span> <span style="color:#000">github</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">com</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">astaxie</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">beego</span>
</span></span></code></pre></div><h2 id="1-2-beego的升级">1.2. beego的升级</h2>
<p>1、直接升级</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">get</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">u</span> <span style="color:#000">github</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">com</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">astaxie</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">beego</span>
</span></span></code></pre></div><p>2、源码下载升级</p>
<p>用户访问 <code>https://github.com/astaxie/beego</code> ,下载源码，然后覆盖到 <code>$GOPATH/src/github.com/astaxie/beego</code> 目录，然后通过本地执行安装就可以升级了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">install</span>  <span style="color:#000">github</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">com</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">astaxie</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">beego</span>
</span></span></code></pre></div><h1 id="2-beego的架构">2. beego的架构</h1>
<p>beego 是一个快速开发 Go 应用的 HTTP 框架，他可以用来快速开发 API、Web 及后端服务等各种应用，是一个 RESTful 的框架。</p>
<h2 id="2-1-beego架构图">2.1. beego架构图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578706/article/golang/beego/architecture.png" alt="architecture"></p>
<p>beego 是基于八大独立的模块构建的，是一个高度解耦的框架。</p>
<p>可以使用 cache 模块来做你的缓存逻辑；使用日志模块来记录你的操作信息；使用 config 模块来解析你各种格式的文件。</p>
<h2 id="2-2-beego执行逻辑">2.2. beego执行逻辑</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578706/article/golang/beego/flow.png" alt="flow"></p>
<p>参考：</p>
<ul>
<li><a href="https://beego.me/docs/intro/">https://beego.me/docs/intro/</a></li>
<li><a href="https://beego.me/docs/install/">https://beego.me/docs/install/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c1d1f70754730e7cb2300c05042bcfa0">11.2.2 - Bee 工具使用</h1>
    
	<h1 id="1-bee工具">1. bee工具</h1>
<p>bee工具用来进行beego项目的创建、热编译、开发、测试、和部署。</p>
<p>安装:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">get</span> <span style="color:#000">github</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">com</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">beego</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">bee</span>
</span></span></code></pre></div><p>配置：</p>
<p>安装完之后，<code>bee</code>可执行文件默认存放在<code>$GOPATH/bin</code>里面，所以要把<code>$GOPATH/bin</code>添加到环境变量中。</p>
<h1 id="2-bee命令">2. bee命令</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Bee is a tool <span style="color:#204a87;font-weight:bold">for</span> managing beego framework.
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    bee <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>The commands are:
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    new         create an application base on beego framework
</span></span><span style="display:flex;"><span>    run         run the app which can hot compile
</span></span><span style="display:flex;"><span>    pack        compress an beego project
</span></span><span style="display:flex;"><span>    api         create an api application base on beego framework
</span></span><span style="display:flex;"><span>    bale        packs non-Go files to Go <span style="color:#204a87">source</span> files
</span></span><span style="display:flex;"><span>    version     show the bee <span style="color:#000;font-weight:bold">&amp;</span> beego version
</span></span><span style="display:flex;"><span>    generate    <span style="color:#204a87">source</span> code generator
</span></span><span style="display:flex;"><span>    migrate     run database migrations
</span></span></code></pre></div><p>说明：</p>
<h2 id="2-1-new">2.1. new</h2>
<p>在 <code>$GOPATH/src</code>的目录下执行<code>bee new &lt;appname&gt;</code>，会在当前目录下生成以下文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">myproject</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">├──</span> <span style="color:#000">conf</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">│</span>   <span style="color:#a40000">└──</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">conf</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">├──</span> <span style="color:#000">controllers</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">│</span>   <span style="color:#a40000">└──</span> <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">├──</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">├──</span> <span style="color:#000">models</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">├──</span> <span style="color:#000">routers</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">│</span>   <span style="color:#a40000">└──</span> <span style="color:#000">router</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">├──</span> <span style="color:#000">static</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">│</span>   <span style="color:#a40000">├──</span> <span style="color:#000">css</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">│</span>   <span style="color:#a40000">├──</span> <span style="color:#000">img</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">│</span>   <span style="color:#a40000">└──</span> <span style="color:#000">js</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">├──</span> <span style="color:#000">tests</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">│</span>   <span style="color:#a40000">└──</span> <span style="color:#000">default_test</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">└──</span> <span style="color:#000">views</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">└──</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tpl</span>
</span></span></code></pre></div><h2 id="2-2-run">2.2. run</h2>
<p>必须在<code>$GOPATH/src/appname</code>下执行bee run，默认监听8080端口：<code>http://localhost:8080/。</code></p>
<h2 id="2-3-api">2.3. api</h2>
<p><code>api</code> 命令就是用来创建 API 应用，生成以下文件：和 Web 项目相比，少了 static 和 views 目录，多了一个 test 模块，用来做单元测试。</p>
<pre tabindex="0"><code>apiproject
├── conf
│   └── app.conf
├── controllers
│   └── object.go
│   └── user.go
├── docs
│   └── doc.go
├── main.go
├── models
│   └── object.go
│   └── user.go
├── routers
│   └── router.go
└── tests
    └── default_test.go
</code></pre><h2 id="2-4-pack">2.4. pack</h2>
<p><code>pack</code> 目录用来发布应用的时候打包，会把项目打包成 zip 包(<code>apiproject.tar.gz</code>)，这样我们部署的时候直接把打包之后的项目上传，解压就可以部署了：</p>
<h2 id="2-5-generate">2.5. generate</h2>
<p>用来自动化的生成代码的，包含了从数据库一键生成model，还包含了scaffold。</p>
<h2 id="2-6-migrate">2.6. migrate</h2>
<p>这个命令是应用的数据库迁移命令，主要是用来每次应用升级，降级的SQL管理。</p>
<p>参考：</p>
<ul>
<li><a href="https://beego.me/docs/install/bee.md">https://beego.me/docs/install/bee.md</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7fe6fb93e4540d87e90213d922b39705">11.2.3 - Beego 项目逻辑</h1>
    
	<h1 id="beego项目逻辑">beego项目逻辑</h1>
<h1 id="1-路由设置">1. 路由设置</h1>
<h2 id="1-1-beego-router">1.1. beego.Router</h2>
<p>入口文件main.go</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">_</span> <span style="color:#4e9a06">&#34;quickstart/routers&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;github.com/astaxie/beego&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>go中导入包中init函数的执行逻辑</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578706/article/golang/beego/init.png" alt="init"></p>
<p><code>_ &quot;quickstart/routers&quot;</code>,包只引入执行了里面的init函数</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">routers</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;quickstart/controllers&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;github.com/astaxie/beego&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Router</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MainController</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>路由包里执行了路由注册<code>beego.Router</code>, 这个函数的功能是映射URL到controller，第一个参数是URL(用户请求的地址)，这里是 <code>/</code>，也就是访问的不带任何参数的URL，第二个参数是对应的 Controller，就是把请求分发到那个控制器来执行相应的逻辑。</p>
<h2 id="1-2-beego-run">1.2. beego.Run</h2>
<ul>
<li>
<p>解析配置文件</p>
<p>beego 会自动解析在 conf 目录下面的配置文件 <code>app.conf</code>，通过修改配置文件相关的属性，我们可以定义：开启的端口，是否开启 session，应用名称等信息。</p>
</li>
<li>
<p>执行用户的hookfunc</p>
<p>beego会执行用户注册的hookfunc，默认的已经存在了注册mime，用户可以通过函数<code>AddAPPStartHook</code>注册自己的启动函数。</p>
</li>
<li>
<p>是否开启 session</p>
<p>会根据上面配置文件的分析之后判断是否开启 session，如果开启的话就初始化全局的 session。</p>
</li>
<li>
<p>是否编译模板</p>
<p>beego 会在启动的时候根据配置把 views 目录下的所有模板进行预编译，然后存在 map 里面，这样可以有效的提高模板运行的效率，无需进行多次编译。</p>
</li>
<li>
<p>是否开启文档功能</p>
<p>根据EnableDocs配置判断是否开启内置的文档路由功能</p>
</li>
<li>
<p>是否启动管理模块</p>
<p>beego 目前做了一个很酷的模块，应用内监控模块，会在 8088 端口做一个内部监听，我们可以通过这个端口查询到 QPS、CPU、内存、GC、goroutine、thread 等统计信息。</p>
</li>
<li>
<p>监听服务端口</p>
<p>这是最后一步也就是我们看到的访问 8080 看到的网页端口，内部其实调用了 <code>ListenAndServe</code>，充分利用了 goroutine 的优势，一旦 run 起来之后，我们的服务就监听在两个端口了，一个服务端口 8080 作为对外服务，另一个 8088 端口实行对内监控。</p>
</li>
</ul>
<h1 id="2-controller-逻辑">2. controller 逻辑</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">controllers</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;github.com/astaxie/beego&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">MainController</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">this</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">MainController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Website&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;beego.me&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Email&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;astaxie@gmail.com&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TplName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;index.tpl&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>1、声明了一个控制器 <code>MainController</code>，这个控制器里面内嵌了 <code>beego.Controller</code>，即Go 的嵌入方式，也就是 <code>MainController</code> 自动拥有了所有 <code>beego.Controller</code> 的方法。而 <code>beego.Controller</code> 拥有很多方法，其中包括 <code>Init</code>、<code>Prepare</code>、<code>Post</code>、<code>Get</code>、<code>Delete</code>、<code>Head</code>等方法。可以通过重写的方式来实现这些方法，以上例子重写了 <code>Get</code> 方法。</p>
<p>2、beego 是一个 RESTful 的框架，请求默认是执行对应 <code>req.Method</code> 的方法。例如浏览器的是 <code>GET</code> 请求，那么默认就会执行 <code>MainController</code> 下的 <code>Get</code> 方法。（用户可以改变这个行为，通过注册自定义的函数名）。</p>
<p>3、获取数据，赋值到 <code>this.Data</code> 中，这是一个用来存储输出数据的 map。</p>
<p>4、渲染模板，<code>this.TplName</code> 就是需要渲染的模板，这里指定了 <code>index.tpl</code>，如果用户不设置该参数，那么默认会去到模板目录的 <code>Controller/&lt;方法名&gt;.tpl</code> 查找，例如上面的方法会去 <code>maincontroller/get.tpl</code>(文件、文件夹必须小写)。用户设置了模板之后系统会自动的调用 <code>Render</code> 函数（这个函数是在 beego.Controller 中实现的），所以无需用户自己来调用渲染。</p>
<p>5、如果不使用模板可以直接输出：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">this</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">MainController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-model逻辑">3. model逻辑</h1>
<p>model一般用来处理数据库操作，如果逻辑中存在可以复用的部分就可以抽象成一个model。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">models</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;loggo/utils&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;path/filepath&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">NotPV</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;css&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;js&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;class&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;gif&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;jpg&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;jpeg&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;png&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bmp&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ico&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;rss&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;xml&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;swf&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">big</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0xFFFFFF</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">LogPV</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">urls</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ext</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ext</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">urls</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ext</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">NotPV</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ToLower</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ext</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-view逻辑">4. view逻辑</h1>
<p><code>Controller中的this.TplName = &quot;index.tpl&quot;</code>，设置显示的模板文件，默认支持 <code>tpl</code> 和 <code>html</code> 的后缀名，如果想设置其他后缀你可以调用 <code>beego.AddTemplateExt</code> 接口设置。beego 采用了 Go 语言默认的模板引擎，和 Go 的模板语法一样。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">html</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">head</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">&gt;</span>Beego<span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">meta</span> <span style="color:#c4a000">http-equiv</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Content-Type&#34;</span> <span style="color:#c4a000">content</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;text/html; charset=utf-8&#34;</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">head</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">body</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">header</span> <span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;hero-unit&#34;</span> <span style="color:#c4a000">style</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;background-color:#A9F16C&#34;</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">div</span> <span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;container&#34;</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">div</span> <span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;row&#34;</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">div</span> <span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;hero-text&#34;</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">h1</span><span style="color:#000;font-weight:bold">&gt;</span>Welcome to Beego!<span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">h1</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">p</span> <span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;description&#34;</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>                    Beego is a simple <span style="color:#a40000">&amp;</span> powerful Go web framework which is inspired by tornado and sinatra.
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">br</span> <span style="color:#000;font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>                    Official website: <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">a</span> <span style="color:#c4a000">href</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;http://{{.Website}}&#34;</span><span style="color:#000;font-weight:bold">&gt;</span>{{.Website}}<span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">a</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">br</span> <span style="color:#000;font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>                    Contact me: {{.Email}}
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">p</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">div</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">div</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">div</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">header</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">body</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">html</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span></code></pre></div><p>Controller 里面把数据赋值给了 data（map 类型），然后在模板中就直接通过 key 访问 <code>.Website</code> 和 <code>.Email</code> 。这样就做到了数据的输出。</p>
<h1 id="5-静态文件">5. 静态文件</h1>
<p>网页往往包含了很多的静态文件，包括图片、JS、CSS 等</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>├── static
</span></span><span style="display:flex;"><span>    │   ├── css
</span></span><span style="display:flex;"><span>    │   ├── img
</span></span><span style="display:flex;"><span>    │   └── js
</span></span></code></pre></div><p>beego 默认注册了 static 目录为静态处理的目录，注册样式：URL 前缀和映射的目录（在/main.go文件中beego.Run()之前加入）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">StaticDir</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;/static&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;static&#34;</span>
</span></span></code></pre></div><p>用户可以设置多个静态文件处理目录，例如你有多个文件下载目录 download1、download2，你可以这样映射（在/main.go文件中beego.Run()之前加入）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetStaticPath</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/down1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;download1&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetStaticPath</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/down2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;download2&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>这样用户访问 URL <code>http://localhost:8080/down1/123.txt</code> 则会请求 download1 目录下的 123.txt 文件。</p>
<p>参考：</p>
<ul>
<li><a href="https://beego.me/docs/quickstart/router.md">https://beego.me/docs/quickstart/router.md</a></li>
<li><a href="https://beego.me/docs/quickstart/controller.md">https://beego.me/docs/quickstart/controller.md</a></li>
<li><a href="https://beego.me/docs/quickstart/model.md">https://beego.me/docs/quickstart/model.md</a></li>
<li><a href="https://beego.me/docs/quickstart/view.md">https://beego.me/docs/quickstart/view.md</a></li>
<li><a href="https://beego.me/docs/quickstart/static.md">https://beego.me/docs/quickstart/static.md</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-63a7ba74df98839246bc414fa2028a24">11.2.4 - Beego 日志处理</h1>
    
	<h1 id="1-使用入门">1. 使用入门</h1>
<p>beego 的日志处理是基于 logs 模块搭建的，内置了一个变量 <code>BeeLogger</code>，默认已经是 <code>logs.BeeLogger</code> 类型，初始化了 console，也就是默认输出到 <code>console。</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Emergency</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this is emergency&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Alert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this is alert&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Critical</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this is critical&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this is error&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this is warning&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Notice</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this is notice&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informational</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this is informational&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this is debug&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="2-设置输出">2. 设置输出</h1>
<p>我们的程序往往期望把信息输出到 log 中，现在设置输出到文件很方便，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">`{&#34;filename&#34;:&#34;logs/test.log&#34;}`</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>这个默认情况就会同时输出到两个地方，一个 console，一个 file，如果只想输出到文件，就需要调用删除操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BeeLogger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DelLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;console&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="3-设置级别">3. 设置级别</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">LevelEmergency</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LevelAlert</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LevelCritical</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LevelError</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LevelWarning</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LevelNotice</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LevelInformational</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LevelDebug</span>
</span></span></code></pre></div><p>级别依次降低，默认全部打印，但是一般我们在部署环境，可以通过设置级别设置日志级别：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLevel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LevelInformational</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="4-输出文件名和行号">4. 输出文件名和行号</h1>
<p>日志默认不输出调用的文件名和文件行号,如果你期望输出调用的文件名和文件行号,可以如下设置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">beego</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogFuncCall</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>开启传入参数 true, 关闭传入参数 false, 默认是关闭的。</p>
<h1 id="5-beego-logs模块的使用">5. beego/logs模块的使用</h1>
<p>是一个用来处理日志的库，目前支持的引擎有 file、console、net、smtp，可以通过如下方式进行安装：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">get</span> <span style="color:#000">github</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">com</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">astaxie</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">beego</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">logs</span>
</span></span></code></pre></div><h2 id="5-1-通用方式">5.1. 通用方式</h2>
<p>首先引入包：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span> <span style="color:#4e9a06">&#34;github.com/astaxie/beego/logs&#34;</span> <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>然后添加输出引擎（log 支持同时输出到多个引擎），这里我们以 console 为例，第一个参数是引擎名（包括：console、file、conn、smtp、es、multifile）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;console&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>添加输出引擎也支持第二个参数,用来表示配置信息，详细的配置请看下面介绍：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdapterFile</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">`{&#34;filename&#34;:&#34;project.log&#34;,&#34;level&#34;:7,&#34;maxlines&#34;:0,&#34;maxsize&#34;:0,&#34;daily&#34;:true,&#34;maxdays&#34;:10}`</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;github.com/astaxie/beego/logs&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">//an official log.Logger
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">l</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetLogger</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">l</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this is a message of http&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">//an official log.Logger with prefix ORM
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ORM&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this is a message of orm&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my book is bought in the year of &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2016</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this %s cat is %v years old&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;yellow&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;json is a type of kv like&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2016</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;is a very&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;good game&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Critical</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;oh,crash&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-2-输出文件名和行号">5.2. 输出文件名和行号</h2>
<p>日志默认不输出调用的文件名和文件行号,如果你期望输出调用的文件名和文件行号,可以如下设置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableFuncCallDepth</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>开启传入参数 true,关闭传入参数 false,默认是关闭的.</p>
<p>如果你的应用自己封装了调用 log 包,那么需要设置 SetLogFuncCallDepth,默认是 2,也就是直接调用的层级,如果你封装了多层,那么需要根据自己的需求进行调整.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogFuncCallDepth</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="5-3-异步输出日志">5.3. 异步输出日志</h2>
<p>为了提升性能, 可以设置异步输出:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Async</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>异步输出允许设置缓冲 chan 的大小</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Async</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1e3</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="5-4-引擎配置">5.4. 引擎配置</h2>
<ul>
<li>
<p>console</p>
<p>可以设置输出的级别，或者不设置保持默认，默认输出到 <code>os.Stdout</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdapterConsole</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">`{&#34;level&#34;:1}`</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div></li>
<li>
<p>file</p>
<p>设置的例子如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdapterFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">`{&#34;filename&#34;:&#34;test.log&#34;}`</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>主要的参数如下说明：</p>
<ul>
<li>filename 保存的文件名</li>
<li>maxlines 每个文件保存的最大行数，默认值 1000000</li>
<li>maxsize 每个文件保存的最大尺寸，默认值是 1 &lt;&lt; 28, //256 MB</li>
<li>daily 是否按照每天 logrotate，默认是 true</li>
<li>maxdays 文件最多保存多少天，默认保存 7 天</li>
<li>rotate 是否开启 logrotate，默认是 true</li>
<li>level 日志保存的时候的级别，默认是 Trace 级别</li>
<li>perm 日志文件权限</li>
</ul>
</li>
<li>
<p>multifile</p>
<p>设置的例子如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdapterMultiFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">``</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;filename&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;test.log&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;separate&#34;</span><span style="color:#000;font-weight:bold">:[</span><span style="color:#4e9a06">&#34;emergency&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;alert&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;critical&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;warning&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;notice&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;info&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;debug&#34;</span><span style="color:#000;font-weight:bold">]}</span><span style="color:#4e9a06">``</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>主要的参数如下说明(除 separate 外,均与file相同)：</p>
<ul>
<li>filename 保存的文件名</li>
<li>maxlines 每个文件保存的最大行数，默认值 1000000</li>
<li>maxsize 每个文件保存的最大尺寸，默认值是 1 &lt;&lt; 28, //256 MB</li>
<li>daily 是否按照每天 logrotate，默认是 true</li>
<li>maxdays 文件最多保存多少天，默认保存 7 天</li>
<li>rotate 是否开启 logrotate，默认是 true</li>
<li>level 日志保存的时候的级别，默认是 Trace 级别</li>
<li>perm 日志文件权限</li>
<li>separate 需要单独写入文件的日志级别,设置后命名类似 test.error.log</li>
</ul>
</li>
<li>
<p>conn</p>
<p>网络输出，设置的例子如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdapterConn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">`{&#34;net&#34;:&#34;tcp&#34;,&#34;addr&#34;:&#34;:7020&#34;}`</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>主要的参数说明如下：</p>
<ul>
<li>reconnectOnMsg 是否每次链接都重新打开链接，默认是 false</li>
<li>reconnect 是否自动重新链接地址，默认是 false</li>
<li>net 发开网络链接的方式，可以使用 tcp、unix、udp 等</li>
<li>addr 网络链接的地址</li>
<li>level 日志保存的时候的级别，默认是 Trace 级别</li>
</ul>
</li>
<li>
<p>smtp</p>
<p>邮件发送，设置的例子如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdapterMail</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">`{&#34;username&#34;:&#34;beegotest@gmail.com&#34;,&#34;password&#34;:&#34;xxxxxxxx&#34;,&#34;host&#34;:&#34;smtp.gmail.com:587&#34;,&#34;sendTos&#34;:[&#34;xiemengjun@gmail.com&#34;]}`</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>主要的参数说明如下：</p>
<ul>
<li>username smtp 验证的用户名</li>
<li>password smtp 验证密码</li>
<li>host 发送的邮箱地址</li>
<li>sendTos 邮件需要发送的人，支持多个</li>
<li>subject 发送邮件的标题，默认是 <code>Diagnostic message from server</code></li>
<li>level 日志发送的级别，默认是 Trace 级别</li>
</ul>
</li>
<li>
<p>ElasticSearch</p>
<p>输出到 ElasticSearch:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdapterEs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">`{&#34;dsn&#34;:&#34;http://localhost:9200/&#34;,&#34;level&#34;:1}`</span>
</span></span></code></pre></div></li>
</ul>
<p>参考文章：</p>
<ul>
<li><a href="https://beego.me/docs/mvc/controller/logs.md">https://beego.me/docs/mvc/controller/logs.md</a></li>
<li><a href="https://beego.me/docs/module/logs.md">https://beego.me/docs/module/logs.md</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-637fdd90dbbca8cc7090a27b277cd979">11.3 - Go实现限流器</h1>
    
	<p>在 Go 中实现一个简单的 <strong>Rate Limiter（限流器）</strong> 可以有多种方式，常见的有基于 <strong>令牌桶（Token Bucket）</strong> 和 <strong>漏桶（Leaky Bucket）</strong> 的实现。下面我们先介绍一种经典方式 —— <strong>令牌桶算法</strong> 实现。</p>
<h1 id="1-令牌桶算法">1. 令牌桶算法</h1>
<p>“<strong>令牌桶算法（Token Bucket）</strong>”是一种 <strong>限流算法</strong>，用于控制请求的速率，是常见于 API 网关、负载均衡器、流控中间件等的核心策略之一。</p>
<h2 id="1-1-核心思想">1.1. 核心思想</h2>
<blockquote>
<p><strong>系统以固定速率往“桶”里放令牌，每次请求必须拿到一个令牌才能被处理，否则被拒绝（限流）。</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>桶（Bucket）</td>
<td>保存令牌的容器，最多可以装 <code>burst</code> 个令牌（突发容量）</td>
</tr>
<tr>
<td>令牌（Token）</td>
<td>每个令牌代表一次允许的操作（如一次 HTTP 请求）</td>
</tr>
<tr>
<td>速率（Rate）</td>
<td>向桶中添加令牌的速度，比如每秒放 5 个</td>
</tr>
<tr>
<td>请求到来时</td>
<td>若桶中有令牌，请求就“取出一个令牌”被允许；否则就被拒绝或等待</td>
</tr>
</tbody>
</table>
<h2 id="1-2-动态行为图示">1.2. 动态行为图示</h2>
<p>假设：每秒生成1个令牌，桶最多装3个。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>时间：0s 桶：<span style="color:#ce5c00;font-weight:bold">[</span>●<span style="color:#ce5c00;font-weight:bold">]</span> 请求：允许（消耗1个令牌）
</span></span><span style="display:flex;"><span>时间：1s 桶：<span style="color:#ce5c00;font-weight:bold">[</span>●<span style="color:#ce5c00;font-weight:bold">]</span> 请求：允许（消耗1个令牌）
</span></span><span style="display:flex;"><span>时间：2s 桶：<span style="color:#ce5c00;font-weight:bold">[</span>●●<span style="color:#ce5c00;font-weight:bold">]</span> 请求：允许
</span></span><span style="display:flex;"><span>时间：3s 桶：<span style="color:#ce5c00;font-weight:bold">[</span>●●●<span style="color:#ce5c00;font-weight:bold">]</span> 请求：允许
</span></span><span style="display:flex;"><span>时间：4s 桶：<span style="color:#ce5c00;font-weight:bold">[</span>●●●<span style="color:#ce5c00;font-weight:bold">]</span> 请求：没有消费，桶满了（不再增加）
</span></span><span style="display:flex;"><span>时间：5s 桶：<span style="color:#ce5c00;font-weight:bold">[</span>●●●<span style="color:#ce5c00;font-weight:bold">]</span> 来5个请求，只允许3个，其余被限流
</span></span></code></pre></div><h2 id="1-3-和漏桶算法的对比">1.3. 和漏桶算法的对比</h2>
<table>
<thead>
<tr>
<th>比较项</th>
<th>令牌桶（Token Bucket）</th>
<th>漏桶（Leaky Bucket）</th>
</tr>
</thead>
<tbody>
<tr>
<td>控制方式</td>
<td>控制请求进入速率</td>
<td>控制请求处理速率</td>
</tr>
<tr>
<td>支持突发请求</td>
<td>✅ 支持</td>
<td>❌ 严格匀速处理</td>
</tr>
<tr>
<td>应用场景</td>
<td>限流（API、接口）</td>
<td>排队（网络、处理任务）</td>
</tr>
</tbody>
</table>
<h2 id="1-4-应用场景举例">1.4. 应用场景举例</h2>
<ul>
<li>
<p>API 请求速率控制（每个用户最多1秒10次）</p>
</li>
<li>
<p>登录/注册防暴力攻击（每 IP 限1分钟5次）</p>
</li>
<li>
<p>CDN 边缘限流（防止源站被打爆）</p>
</li>
<li>
<p>后端任务投递（防止 RabbitMQ 拥堵）</p>
</li>
</ul>
<h1 id="2-实现简单-token-bucket-限流器">2. 实现简单 Token Bucket 限流器</h1>
<h2 id="2-1-使用-time-ticker-实现">2.1. 使用 time.Ticker 实现</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">RateLimiter</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tokens</span>       <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ticker</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ticker</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxTokens</span>    <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">refillPeriod</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewRateLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rps</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">burst</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RateLimiter</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rl</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">RateLimiter</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">tokens</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">burst</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ticker</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTicker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rps</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxTokens</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">burst</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">refillPeriod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rps</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 初始化 token 桶
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">burst</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">rl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tokens</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 后台协程定时放 token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">rl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ticker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">C</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">rl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tokens</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// 桶满时丢弃 token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rl</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Allow 会阻塞直到有 token 可用（可改成 TryAllow 非阻塞版本）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RateLimiter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Allow</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">rl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tokens</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">limiter</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewRateLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 每秒 5 个请求，最多缓冲 10 个
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">limiter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Allow</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Request&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;allowed at&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Request&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;denied at&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-使用go-rate包实现">2.2. 使用Go rate包实现</h2>
<p>Go 的 <code>golang.org/x/time/rate</code> 包就实现了 <strong>令牌桶算法</strong>，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 每秒5个令牌，最多能装10个（允许突发10次）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">limiter</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> 
</span></span></code></pre></div><p>你可以使用 <code>.Allow()</code> 来判断是否获得令牌：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">limiter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Allow</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 有令牌，请求通过
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 没令牌，请求被限流
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-实现gin按用户或-ip-限流中间件">3. 实现Gin按用户或 IP 限流中间件</h1>
<h2 id="3-1-限流器结构-使用-rate-limiter">3.1. 限流器结构（使用 rate.Limiter）</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">ratelimiter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;golang.org/x/time/rate&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">RateLimiter</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rate</span>     <span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Limit</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">burst</span>    <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">buckets</span>  <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Limiter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mutex</span>    <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewRateLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Limit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RateLimiter</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">RateLimiter</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">rate</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">r</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">burst</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">buckets</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Limiter</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RateLimiter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">getLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Limiter</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mutex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">rl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mutex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">limiter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">buckets</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">limiter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">limiter</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">burst</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">buckets</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">limiter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">limiter</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RateLimiter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Allow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Allow</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-gin-中间件">3.2. Gin 中间件</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">ratelimiter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">KeyFunc</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">gin</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Middleware</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RateLimiter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keyFn</span> <span style="color:#000">KeyFunc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">gin</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlerFunc</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">gin</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">keyFn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">rl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Allow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AbortWithStatusJSON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatusTooManyRequests</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gin</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">H</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;rate limit exceeded&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Next</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-在-main-go-中使用-按-ip-限流">3.3. 在 main.go 中使用（按 IP 限流）</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;golang.org/x/time/rate&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;your_project/ratelimiter&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 每秒2个请求，最多突发5个
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rl</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ratelimiter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRateLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">gin</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Default</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ratelimiter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Middleware</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">gin</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientIP</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// 或使用 c.GetString(&#34;userID&#34;) 实现按用户限流
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GET</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/hello&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">gin</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gin</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">H</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;msg&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;hello&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:8080&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-93d703b6ce7077fe557914bb99df177d">12 - 源码分析</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0d8b1d1671033461dfc027e02aedc2c4">12.1 - confd源码分析</h1>
    
	<blockquote>
<p>confd的源码参考：https://github.com/kelseyhightower/confd</p>
</blockquote>
<p>本文分析的<code>confd</code>的版本是<code>v0.16.0</code>，代码参考：https://github.com/kelseyhightower/confd/tree/v0.16.0。</p>
<h1 id="1-main-https-github-com-kelseyhightower-confd-blob-v0-16-0-confd-go-l16">1. <a href="https://github.com/kelseyhightower/confd/blob/v0.16.0/confd.go#L16">Main</a></h1>
<p>confd的入口函数 Main 函数，先解析参数，如果是打印版本信息的参数，则执行打印版本的命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintVersion</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;confd %s (Git SHA: %s, Go Version: %s)\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Version</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">GitSHA</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Version</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>其中版本信息记录在https://github.com/kelseyhightower/confd/blob/v0.16.0/version.go#L3</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0.16.0&#34;</span>
</span></span></code></pre></div><h2 id="1-1-initconfig-https-github-com-kelseyhightower-confd-blob-v0-16-0-config-go-l82">1.1. <a href="https://github.com/kelseyhightower/confd/blob/v0.16.0/config.go#L82">initConfig</a></h2>
<p>初始化配置文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">initConfig</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>initConfig</code>函数对基本的配置内容做初始化，当没有指定后端存储的时候，设置默认存储。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// initConfig initializes the confd configuration by first setting defaults,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// then overriding settings from the confd config file, then overriding
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// settings from environment variables, and finally overriding
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// settings from flags set on the command line.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It returns an error if any.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">initConfig</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigFile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Skipping confd config file.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Loading &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigFile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">configBytes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ioutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigFile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">toml</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configBytes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Update config from environment variables.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">processEnv</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecretKeyring</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecretKeyring</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">kr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PGPPrivateKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ioutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogLevel</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLevel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogLevel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SRVDomain</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SRVRecord</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SRVRecord</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;_%s._tcp.%s.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backend</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SRVDomain</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Update BackendNodes from SRV records.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backend</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;env&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SRVRecord</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SRV record set to &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SRVRecord</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">srvNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getBackendNodesFromSRV</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SRVRecord</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Cannot get nodes from SRV records &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backend</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;etcd&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">vsm</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">srvNodes</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">srvNodes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">vsm</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;://&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">srvNodes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">vsm</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BackendNodes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">srvNodes</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BackendNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backend</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;consul&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BackendNodes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;127.0.0.1:8500&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;etcd&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">peerstr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ETCDCTL_PEERS&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">peerstr</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BackendNodes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">peerstr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;,&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BackendNodes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;http://127.0.0.1:4001&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;etcdv3&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BackendNodes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;127.0.0.1:2379&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BackendNodes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;127.0.0.1:6379&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BackendNodes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;http://127.0.0.1:8200&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;zookeeper&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BackendNodes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;127.0.0.1:2181&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Initialize the storage client
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Backend set to &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backend</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Watch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">unsupportedBackends</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34;dynamodb&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34;ssm&#34;</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">unsupportedBackends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backend</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Watch is not supported for backend %s. Exiting...&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backend</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backend</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;dynamodb&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Table</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;No DynamoDB table configured&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigDir</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfDir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;conf.d&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TemplateDir</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfDir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;templates&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-2-storeclient">1.2. storeClient</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting confd&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">storeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">backends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BackendsConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>根据配置文件中的存储后端类型构造一个存储后端的client，其中主要调用的函数为<a href="https://github.com/kelseyhightower/confd/blob/v0.16.0/backends/client.go#L29">backends.New(config.BackendsConfig)</a>。</p>
<p>当没有设置存储后端时，默认为<code>etcd</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backend</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backend</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;etcd&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">backendNodes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BackendNodes</span>
</span></span></code></pre></div><p>当存储后端为<code>file</code>类型的处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backend</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;file&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Backend source(s) set to &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YAMLFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Backend source(s) set to &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">backendNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>最后再根据不同类型的存储后端，调用不同的存储后端构建函数，本文只分析<code>redis</code>类型的存储后端。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backend</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;consul&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">consul</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BackendNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientCert</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientKey</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientCaKeys</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BasicAuth</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Username</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Password</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;etcd&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Create the etcd client upfront and use it for the life of the process.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// The etcdClient is an http.Client and designed to be reused.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">etcd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewEtcdClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">backendNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientCert</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientCaKeys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BasicAuth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Username</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Password</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;etcdv3&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">etcdv3</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewEtcdClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">backendNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientCert</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientCaKeys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BasicAuth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Username</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Password</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;zookeeper&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">zookeeper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewZookeeperClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">backendNodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;rancher&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rancher</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRancherClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">backendNodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRedisClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">backendNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Separator</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;env&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">env</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewEnvClient</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;file&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">file</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewFileClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YAMLFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;vault&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">vaultConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;app-id&#34;</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;user-id&#34;</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UserID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;role-id&#34;</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RoleID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;secret-id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecretID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;username&#34;</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Username</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;password&#34;</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Password</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;token&#34;</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthToken</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;cert&#34;</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientCert</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientKey</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;caCert&#34;</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientCaKeys</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;path&#34;</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Path</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">vault</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">backendNodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vaultConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;dynamodb&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">table</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Table</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;DynamoDB table set to &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dynamodb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDynamoDBClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;ssm&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ssm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Invalid backend&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>其中redis类型的存储后端调用了<code>NewRedisClient</code>方法来构造redis的client。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRedisClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">backendNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Separator</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>其中涉及三个参数：</p>
<ul>
<li><code>backendNodes</code>：redis的节点地址。</li>
<li><code>ClientKey</code>：redis的密码。</li>
<li><code>Separator</code>：查找redis键的分隔符，该参数只用在redis类型。</li>
</ul>
<p><code>NewRedisClient</code>函数方法如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewRedisClient returns an *redis.Client with a connection to named machines.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It returns an error if a connection to the cluster cannot be made.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewRedisClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">machines</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">separator</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">separator</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">separator</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Redis Separator: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">separator</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">clientWrapper</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">machines</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">machines</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">password</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">separator</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">separator</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pscChan</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">watchResponse</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">psc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PubSubConn</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">clientWrapper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tryConnect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">machines</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">clientWrapper</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-3-processor">1.3. processor</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">stopChan</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">doneChan</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">errChan</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">processor</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Processor</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">processor</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WatchProcessor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TemplateConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">doneChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">processor</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IntervalProcessor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TemplateConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">doneChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interval</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Process</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>当开启<code>watch</code>参数的时候，则构造<code>WatchProcessor</code>，否则构造<code>IntervalProcessor</code>，最后起一个goroutine。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Process</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>这块的逻辑在本文第二部分析。</p>
<h2 id="1-4-signalchan">1.4. signalChan</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">signalChan</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Signal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Notify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">signalChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SIGINT</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SIGTERM</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">errChan</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">signalChan</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Captured %v. Exiting...&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">doneChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">doneChan</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-process-https-github-com-kelseyhightower-confd-blob-v0-16-0-resource-template-processor-go-l12">2. <a href="https://github.com/kelseyhightower/confd/blob/v0.16.0/resource/template/processor.go#L12">Process</a></h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Processor</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Process</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>Processor</code>是一个接口类型，主要的实现体有：</p>
<ul>
<li><code>intervalProcessor</code>：默认的实现体，即没有添加watch参数。</li>
<li><code>watchProcessor</code>：添加watch参数的实现体。</li>
</ul>
<h2 id="2-1-intervalprocessor">2.1. intervalProcessor</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">intervalProcessor</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span>   <span style="color:#000">Config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">stopChan</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">doneChan</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">errChan</span>  <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">interval</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>intervalProcessor根据config内容和几个channel构造一个intervalProcessor。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">IntervalProcessor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span> <span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">doneChan</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errChan</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">interval</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Processor</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">intervalProcessor</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">doneChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">interval</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-1-1-intervalprocessor-process">2.1.1. intervalProcessor.Process</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">intervalProcessor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Process</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">doneChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getTemplateResources</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ts</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">After</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interval</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过解析config内容获取<code>TemplateResources</code>，其中核心函数为<code>process(ts)</code>，然后执行<code>t.process()</code>，该函数中会调用<code>t.sync()</code>。<code>t.process()</code>的具体逻辑后文分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ts</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TemplateResource</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">lastErr</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">ts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lastErr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">lastErr</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-watchprocessor">2.2. watchProcessor</h2>
<pre tabindex="0"><code>type watchProcessor struct {
	config   Config
	stopChan chan bool
	doneChan chan bool
	errChan  chan error
	wg       sync.WaitGroup
}
</code></pre><p>watchProcessor根据config内容和几个channel构造一个watchProcessor。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">WatchProcessor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span> <span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">doneChan</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errChan</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Processor</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">watchProcessor</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">doneChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errChan</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-2-1-watchprocessor-process">2.2.1. watchProcessor.Process</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">watchProcessor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Process</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">doneChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getTemplateResources</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">ts</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">monitorPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>watchProcessor.Process</code>方法实现了<code>Processor</code>接口中定义的方法，通过解析config内容获取<code>TemplateResources</code>，再遍历<code>TemplateResources</code>执行<code>monitorPrefix</code>，有多少个<code>TemplateResources</code>就运行多少个<code>monitorPrefix</code>的goroutine。</p>
<h3 id="2-2-2-monitorprefix">2.2.2. monitorPrefix</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">watchProcessor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">monitorPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TemplateResource</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">keys</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppendPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Keys</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">storeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WatchPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastIndex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">errChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Prevent backend errors from consuming all resources.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastIndex</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">index</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">errChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>先对配置文件中的<code>prefix</code>和<code>keys</code>参数进行拼接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">keys</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppendPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Keys</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>AppendPrefix</code>函数如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">AppendPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prefix</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keys</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">keys</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">s</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>接着再执行<code>storeClient</code>的<code>WatchPrefix</code>方法，因为<code>storeClient</code>是一个接口，对应不同类型的存储后端，<code>WatchPrefix</code>的实现逻辑也不同，本文分析的存储类型为<code>redis</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">storeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WatchPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastIndex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">errChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Prevent backend errors from consuming all resources.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>storeClient.WatchPrefix</code>主要是获取<code>lastIndex</code>的值，这个值在<code>t.process()</code>中使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastIndex</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">index</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">errChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-templateresource-process">2.3. TemplateResource.process</h2>
<p>无论是否加<code>watch</code>参数，即<code>intervalProcessor</code>和<code>watchProcessor</code>最终都会调用到<code>TemplateResource.process</code>这个函数，而这个函数中的核心函数为<code>t.sync()</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// process is a convenience function that wraps calls to the three main tasks
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// required to keep local configuration files in sync. First we gather vars
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// from the store, then we stage a candidate configuration file, and finally sync
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// things up.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It returns an error if any.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TemplateResource</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">process</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setFileMode</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setVars</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createStageFile</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-3-1-setfilemode">2.3.1. setFileMode</h3>
<p><code>setFileMode</code>设置文件的权限，如果没有在配置文件指定<code>mode</code>参数则默认为<code>0644</code>，否则根据配置文件中指定的<code>mode</code>来设置文件权限。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// setFileMode sets the FileMode.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TemplateResource</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">setFileMode</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsFileExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileMode</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0644</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fi</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileMode</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mode</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseUint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileMode</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileMode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-3-2-setvars">2.3.2. setVars</h3>
<p><code>setVars</code>将后端存储中最新的值拿出来暂存到内存中供后续进程使用。其中根据不同的后端，<code>storeClient.GetValues</code>的逻辑可能不同，但通过接口的方式可以让不同的存储后端实现不同的获取值的方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// setVars sets the Vars for template resource.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TemplateResource</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">setVars</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Retrieving keys from store&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Key prefix set to &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prefix</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">storeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppendPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Keys</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Got the following map from store: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Purge</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TrimPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prefix</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-3-3-createstagefile">2.3.3. createStageFile</h3>
<p><code>createStageFile</code>通过<code>src</code>的<code>template</code>文件和最新内存中的变量数据生成<code>StageFile</code>，该文件在sync中和目标文件进行比较，看是否有修改。即<code>StageFile</code>实际上是根据后端存储生成的最新的配置文件，如果这份配置文件跟当前的配置文件不同，表明后端存储的数据被更新了需要重新生成一份新的配置文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// createStageFile stages the src configuration file by processing the src
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// template and setting the desired owner, group, and mode. It also sets the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// StageFile for the template resource.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It returns an error if any.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TemplateResource</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">createStageFile</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Using source template &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Src</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsFileExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Src</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Missing template: &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Src</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Compiling source template &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Src</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tmpl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Base</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Src</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#000">Funcs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">funcMap</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">ParseFiles</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Src</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unable to process template %s, %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// create TempFile in Dest directory to avoid cross-filesystem issues
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">temp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ioutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TempFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Base</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tmpl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">temp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">temp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Remove</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">temp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">temp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Set the owner, group, and mode on the stage file now to make it easier to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// compare against the destination configuration file later.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Chmod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">temp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileMode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Chown</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">temp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Uid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Gid</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StageFile</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">temp</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-3-4-sync">2.3.4. sync</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>t.sync()</code>是执行confd核心功能的函数，将配置文件通过模板的方式自动生成，并执行检查命令和reload命令。该部分逻辑在本文第三部分分析。</p>
<h1 id="3-sync-https-github-com-kelseyhightower-confd-blob-v0-16-0-resource-template-resource-go-l238">3. <a href="https://github.com/kelseyhightower/confd/blob/v0.16.0/resource/template/resource.go#L238">sync</a></h1>
<p><code>sync</code>通过比较源文件和目标文件的差别，如果不同则重新生成新的配置，当设置了<code>check_cmd</code>和<code>reload_cmd</code>的时候，会执行<code>check_cmd</code>指定的检查命令，如果都没有问题则执行<code>reload_cmd</code>中指定的reload命令。</p>
<h2 id="3-1-isconfigchanged">3.1. IsConfigChanged</h2>
<p><code>IsConfigChanged</code>比较源文件和目标文件是否相等，其中比较内容包括：<code>Uid</code>、<code>Gid</code>、<code>Mode</code>、<code>Md5</code>。只要其中任意值不同则认为两个文件不同。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// IsConfigChanged reports whether src and dest config files are equal.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Two config files are equal when they have the same file contents and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Unix permissions. The owner, group, and mode must match.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It return false in other cases.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">IsConfigChanged</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dest</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">IsFileExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">FileStat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">FileStat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Uid</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Uid</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s has UID %d should be %d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Uid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Uid</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Gid</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Gid</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s has GID %d should be %d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Gid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Gid</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mode</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s has mode %s should be %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileMode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mode</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileMode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mode</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Md5</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Md5</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s has md5sum %s should be %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Md5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Md5</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Uid</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Uid</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Gid</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Gid</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mode</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mode</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Md5</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Md5</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果文件发生改变则执行<code>check_cmd</code>命令（有配置的情况下），重新生成配置文件，并执行<code>reload_cmd</code>命令（有配置的情况下）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Target config &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; out of sync&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncOnly</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckCmd</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">check</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Config check failed: &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Overwriting target config &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Rename</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">staged</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;device or resource busy&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Rename failed - target is likely a mount. Trying to write instead&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// try to open the file and write to it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">contents</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">rerr</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">contents</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rerr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ioutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">staged</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rerr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rerr</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ioutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">contents</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileMode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// make sure owner and group match the temp file, in case the file was created with WriteFile
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Chown</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Uid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Gid</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncOnly</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReloadCmd</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reload</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Target config &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; has been updated&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Target config &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; in sync&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-check">3.2. check</h2>
<p><code>check</code>检查暂存的配置文件即<code>stageFile</code>，该文件是由最新的后端存储中的数据生成的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncOnly</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckCmd</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">check</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Config check failed: &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>t.check()</code>只是执行配置文件中<code>checkcmd</code>参数指定的命令而已，根据是否执行成功来返回报错。当<code>check</code>命令产生错误的是，则直接return报错，不再执行重新生成配置文件和``reload`的操作了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// check executes the check command to validate the staged config file. The
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// command is modified so that any references to src template are substituted
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// with a string representing the full path of the staged file. This allows the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// check to be run on the staged file before overwriting the destination config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// file.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It returns nil if the check command returns 0 and there are no other errors.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TemplateResource</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">check</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">cmdBuffer</span> <span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Buffer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;src&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StageFile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tmpl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;checkcmd&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckCmd</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">tmpl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cmdBuffer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">runCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmdBuffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>check</code>会通过模板解析的方式解析出<code>checkcmd</code>中的<code>{{.src}}</code>部分，并用<code>stageFile</code>来替代。即check的命令是拉取最新后端存储的数据形成临时配置文件（stageFile），并通过指定的<code>checkcmd</code>来检查最新的临时配置文件是否合法，如果合法则替换会新的配置文件，否则返回错误。</p>
<h2 id="3-3-overwriting">3.3. Overwriting</h2>
<p>将<code>staged</code>文件命名为<code>Dest</code>文件的名字，读取<code>staged</code>文件中的内容并将它写入到<code>Dest</code>文件中，该过程实际上就是重新生成一份新的配置文件。<code>staged</code>文件的生成逻辑在函数<code>createStageFile</code>中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Overwriting target config &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Rename</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">staged</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;device or resource busy&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Rename failed - target is likely a mount. Trying to write instead&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// try to open the file and write to it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">contents</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">rerr</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">contents</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rerr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ioutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">staged</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rerr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rerr</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ioutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">contents</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileMode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// make sure owner and group match the temp file, in case the file was created with WriteFile
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Chown</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Uid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Gid</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-4-reload">3.4. reload</h2>
<p>如果没有指定syncOnly参数并且指定了<code>ReloadCmd</code>则执行<code>reload</code>操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncOnly</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReloadCmd</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reload</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中<code>t.reload()</code>实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// reload executes the reload command.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It returns nil if the reload command returns 0.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TemplateResource</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">reload</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">runCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReloadCmd</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>t.reload()</code>和<code>t.check()</code>都调用了<code>runCommand</code>函数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// runCommand is a shared function used by check and reload
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to run the given command and log its output.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It returns nil if the given cmd returns 0.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The command can be run on unix and windows.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">runCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Running &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cmd</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GOOS</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;windows&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cmd&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/C&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">exec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/bin/sh&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;-c&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">output</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CombinedOutput</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">output</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">output</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-redisclient-watchprefix-https-github-com-kelseyhightower-confd-blob-v0-16-0-backends-redis-client-go-l228">4. <a href="https://github.com/kelseyhightower/confd/blob/v0.16.0/backends/redis/client.go#L228">redisClient.WatchPrefix</a></h1>
<p><code>redisClient.WatchPrefix</code>是当用户设置了<code>watch</code>参数的时候，并且存储后端为<code>redis</code>，则会调用到redis的watch机制。其中<code>redisClient.WatchPrefix</code>是redis存储类型的时候实现了<code>StoreClient</code>接口的<code>WatchPrefix</code>方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The StoreClient interface is implemented by objects that can retrieve
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// key/value pairs from a backend store.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">StoreClient</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">GetValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">keys</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WatchPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prefix</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keys</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">waitIndex</span> <span style="color:#204a87;font-weight:bold">uint64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopChan</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">uint64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>StoreClient</code>是对后端存储类型的抽象，常用的后端存储类型有<code>Etcd</code>和<code>Redis</code>等，不同的后端存储类型<code>GetValues</code>和<code>WatchPrefix</code>的具体实现不同，本文主要分析Redis类型的<code>watch</code>机制。</p>
<h2 id="4-1-watchprefix">4.1. WatchPrefix</h2>
<p>WatchPrefix的调用函数在<a href="#222-monitorPrefix">monitorPrefix</a>的部分，具体参考：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">watchProcessor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">monitorPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TemplateResource</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">keys</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppendPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Keys</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">storeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WatchPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastIndex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">errChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Prevent backend errors from consuming all resources.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastIndex</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">index</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">process</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">errChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>redis的<code>watch</code>主要通过<code>pub-sub</code>的机制，即WatchPrefix会根据传入的<code>prefix</code>起一个sub的监听机制，而在写入redis的数据的同时需要执行redis的publish操作，channel为符合prefix的值，value为给定命令之一，实际上是给定命令之一，具体是什么命令并没有关系，则会触发watch机制，从而自动更新配置，给定的命令列表如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;del&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;append&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;rename_from&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;rename_to&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;expire&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;set&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;incrby&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;incrbyfloat&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hset&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hincrby&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hincrbyfloat&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hdel&#34;</span>
</span></span></code></pre></div><p>sub监听的key的格式如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">__keyspace</span><span style="color:#a40000">@</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000">__</span><span style="color:#000;font-weight:bold">:{</span><span style="color:#000">prefix</span><span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">/*</span>
</span></span></code></pre></div><p>如果只是写入redis数据而没有自动执行publish的操作，并不会触发redis的watch机制来自动更新配置。但是如果使用etcd，则etcd的watch机制，只需要用户写入或更新数据就可以自动触发更新配置。</p>
<p><code>WatchPrefix</code>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">WatchPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prefix</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keys</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">waitIndex</span> <span style="color:#204a87;font-weight:bold">uint64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopChan</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">uint64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">waitIndex</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pscChan</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">respChan</span> <span style="color:#000">watchResponse</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pscChan</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">respChan</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pscChan</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">respChan</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">waitIndex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">respChan</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">psc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">rClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">tryConnect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">machines</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">password</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">psc</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PubSubConn</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pscChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">watchResponse</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>			<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">psc</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PubSubConn</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">rClient</span><span style="color:#000;font-weight:bold">}</span>		
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">psc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">psc</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PubSubConn</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">psc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Receive</span><span style="color:#000;font-weight:bold">().(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PMessage</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>							<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Redis Message: %s %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Data</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>							<span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>							<span style="color:#000">commands</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;del&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;append&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;rename_from&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;rename_to&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;expire&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;set&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;incrby&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;incrbyfloat&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hset&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hincrby&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hincrbyfloat&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hdel&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>							<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">commands</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>								<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>									<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pscChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">watchResponse</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>									<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>								<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>							<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>						<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Subscription</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>							<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Redis Subscription: %s %s %d\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Count</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>							<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Count</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>								<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pscChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">watchResponse</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>								<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>							<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>						<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>							<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Redis error: %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>							<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pscChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">watchResponse</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>							<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>			<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">psc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PSubscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;__keyspace@&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Itoa</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;__:&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">transform</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prefix</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">psc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PUnsubscribe</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">waitIndex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pscChan</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">waitIndex</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-总结">5. 总结</h1>
<ol>
<li>confd的作用是通过将配置存放到存储后端，来自动触发更新配置的功能，其中常用的后端有<code>Etcd</code>和<code>Redis</code>等。</li>
<li>不同的存储后端，watch机制不同，例如Etcd只需要更新key便可以触发自动更新配置的操作，而redis除了更新key还需要执行<code>publish</code>的操作。</li>
<li>可以通过配置<code>check_cmd</code>来校验配置文件是否正确，如果配置文件非法则不会执行自动更新配置和<code>reload</code>的操作，但是当存储后端存入的非法数据，会导致每次校验都是失败的，即使后面新增的配置部分是合法的，所以需要有机制来控制存入存储后端的数据始终是合法的。</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kelseyhightower/confd/tree/v0.16.0">https://github.com/kelseyhightower/confd/tree/v0.16.0</a></li>
</ul>

</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2025 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
