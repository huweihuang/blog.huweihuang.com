<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/linux-notes/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/linux-notes/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Linux学习笔记 | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="Linux学习笔记" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/linux-notes/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="Linux学习笔记">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linux学习笔记"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/kubernetes-notes/" ><span>Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/k8s-source-code-analysis/" ><span>Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/linux-notes/" ><span class="active">Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.1a3d56fd81ed8a9e99639253c4c303da.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/linux-notes/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">Linux学习笔记</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-2b1d297a60eef39bc26a1596c55494b8">Linux 文件系统</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-3d91317eb6270bd994a7ca5e80d4d8b7">Linux介绍</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-9103fc8f641ac26af94593740e4ef6ab">Linux文件系统</a></li>


    
  
    
    
	
<li>1.3: <a href="#pg-6135486aa33d07567abb490570427588">Linux文件存储</a></li>


    
  
    
    
	
<li>1.4: <a href="#pg-a7b3f765840dfa2ad5df8a5b65479d1b">Linux文件权限</a></li>


    
  
    
    
	
<li>1.5: <a href="#pg-001340490ba5e7da366978868f3215e6">Linux常用命令</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-ee442c6d6808dd7649643a83c1efc6a2">磁盘</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-efb1da2d07097c48baf556ef4e43b997">磁盘命令</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-dcd309351d4b31616b979c4aad4cde28">LVM的使用</a></li>


    
  
    
    
	
<li>2.3: <a href="#pg-d4bbbd15228232e898b358dae27e6a1c">Raid介绍</a></li>


    
  
    
    
	
<li>2.4: <a href="#pg-896ec2a9f485dc3588d18d5b785ff93a">创建硬件Raid</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-2877dd58d274d3880a06c631d157bce3">TCP/IP</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-c629a2b6a83fee825cbde9907286afdd">TCPIP基础</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-f7cbb4c5a76ec9332d300cd3470493c2">IP协议</a></li>


    
  
    
    
	
<li>3.3: <a href="#pg-783f0fab77205aefe1fd803e53ba7c52">TCP协议</a></li>


    
  
    
    
	
<li>3.4: <a href="#pg-84452cfe31915d8c4f4d04258246cb10">UDP协议</a></li>


    
  
    
    
	
<li>3.5: <a href="#pg-0890a784034f82778864893ae61492de">HTTP协议</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-24adc5fd31391cd2d4ff660df560df4c">网络</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-699fefc6af767e2525a21bee111a7f03">tcpdump抓包流程</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-2e853cd9731a1b7fa5f3d4955c5ceda3">iptables介绍</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-fb885bb9e042e5f183dbbe1462da53d7">iptables命令</a></li>


    
  
    
    
	
<li>4.4: <a href="#pg-05f4d807ce9b3245e03b30114a0acab5">wrk的使用</a></li>


    
  
    
    
	
<li>4.5: <a href="#pg-47e00858ae348d66329dcfca96f7a676">VLAN介绍</a></li>


    
  
    
    
	
<li>4.6: <a href="#pg-3c94e21a7f8d25dbd0f1027dd1ff8ac0">netplan介绍</a></li>


    
  
    
    
	
<li>4.7: <a href="#pg-6b897bd3369333340265bef5a501a17a">网卡Bonding介绍</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-f6a2843e805577065b3bd6954dcad95b">Shell脚本</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-1c9274495cca8d3f7a2a4cdfef52cf76">Shell简介</a></li>


    
  
    
    
	
<li>5.2: <a href="#pg-13fe6aa636c36aafc0610e9e5bafe6dd">Shell变量</a></li>


    
  
    
    
	
<li>5.3: <a href="#pg-c62e5c02b9a01be54ad23d975c082291">Shell运算符</a></li>


    
  
    
    
	
<li>5.4: <a href="#pg-c4413e1441110142d959e29a1be59096">Shell数组</a></li>


    
  
    
    
	
<li>5.5: <a href="#pg-1c4908b9298c264248fc1c192a1aa162">Shell echo命令</a></li>


    
  
    
    
	
<li>5.6: <a href="#pg-3e7580ccae2cfd4463708b26683b2832">Shell 判断语句</a></li>


    
  
    
    
	
<li>5.7: <a href="#pg-520bfcc1b1f2e050d803497bcd9f2646">Shell 循环语句</a></li>


    
  
    
    
	
<li>5.8: <a href="#pg-427cb5778e5423db520256d99897d9a6">Shell 函数</a></li>


    
  
    
    
	
<li>5.9: <a href="#pg-e6194060e55926f98d5865870e2d2baa">Shell 重定向</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-bbde1feaea89039a1489906ebd5dd645">运维工具</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-19e331c309cc44664359cc5ff58f47ff">ansible的使用</a></li>


    
  
    
    
	
<li>6.2: <a href="#pg-65763f1b371a58100a39fc1333ba1541">ceph-fuse的使用</a></li>


    
  
    
    
	
<li>6.3: <a href="#pg-96144427fb37ef08b231fd81e3a8f3fe">confd的使用</a></li>


    
  
    
    
	
<li>6.4: <a href="#pg-5531ca3712df8e070f36d75562fd0f0e">NFS的使用</a></li>


    
  
    
    
	
<li>6.5: <a href="#pg-9b6e7b7fc8e7add51ad7e8a79a48edd8">ssh tips</a></li>


    
  
    
    
	
<li>6.6: <a href="#pg-2fced7315a2daf4cf08293398519ee28">Supervisor的使用</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-c28c6a3abee361dd3f854007745692f7">GIT命令</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-cff29e90b0bc24db749cc6ee1e7f6a04">Git介绍</a></li>


    
  
    
    
	
<li>7.2: <a href="#pg-b6a548be9e6ddcaeda2721c9a3f2f8ef">Git常用命令</a></li>


    
  
    
    
	
<li>7.3: <a href="#pg-f9f4e5c41f44aa45facefe4fb49b47f1">Git命令分类</a></li>


    
  
    
    
	
<li>7.4: <a href="#pg-e48a32742a2c5129a6ef36eb9ec51bd4">Git commit规范</a></li>


    
  
    
    
	
<li>7.5: <a href="#pg-a1b9224ec12791c7d41ce8381ea5ab4d">Git命令别名</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-3aee0e423ebb89b407ca75b697cf3a28">Mysql</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.1: <a href="#pg-ebadcae1889d3c43f4974dbe7131450b">Mysql服务部署</a></li>


    
  
    
    
	
<li>8.2: <a href="#pg-2609be5f858790ac1cddb1f05497c666">Mysql常用命令之系统管理</a></li>


    
  
    
    
	
<li>8.3: <a href="#pg-7ccae74658d9fc5c12e59022143d21b7">Mysql常用命令之数据表操作</a></li>


    
  
    
    
	
<li>8.4: <a href="#pg-5ba81b3ac92960640ff1ead93cc35ba1">Mysql常用命令之表内容操作</a></li>


    
  

    </ul>
    
  
    
    
	
<li>9: <a href="#pg-9e477e659dccf915ab32cf50bbf82a15">Redis</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>9.1: <a href="#pg-06c8cb916130c134fb71dc7a25278b26">Redis介绍</a></li>


    
  
    
    
	
<li>9.2: <a href="#pg-f92dac7a4ae2762cd888cf113e026e81">Redis集群模式部署</a></li>


    
  
    
    
	
<li>9.3: <a href="#pg-5caba3265013584f81feac5ce6c89fad">Redis哨兵模式部署</a></li>


    
  
    
    
	
<li>9.4: <a href="#pg-159b390d9892e8b1b4d4b746b95330a8">Redis配置详解（中文版）</a></li>


    
  
    
    
	
<li>9.5: <a href="#pg-fb05c22cf7382c53488c3ab08823d9b8">Redis配置详解（英文版）</a></li>


    
  

    </ul>
    
  
    
    
	
<li>10: <a href="#pg-ad720d1acea602e36850206b5c3201aa">Memcached</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1: <a href="#pg-1a183ff43ce899c1c4a8db7481a3acaf">Memcached的使用</a></li>


    
  
    
    
	
<li>10.2: <a href="#pg-c28ae96d748e302a7642d5734f49cfad">Memcached命令</a></li>


    
  

    </ul>
    
  
    
    
	
<li>11: <a href="#pg-153b18296e29e533d7c39d91a8a169f9">Nginx</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>11.1: <a href="#pg-2b21d9995de5be0bc344a9f01ba118e4">Nginx的部署与配置</a></li>


    
  
    
    
	
<li>11.2: <a href="#pg-3bd1e1c86d00c1b0ad09142914f775f6">Nginx作为反向代理</a></li>


    
  
    
    
	
<li>11.3: <a href="#pg-fd3c37bc56a35cbed876a7ec53b56dc6">Nginx http服务器</a></li>


    
  
    
    
	
<li>11.4: <a href="#pg-703079dad1fd73ade9e4c50d7b207138">配置Nginx免费证书</a></li>


    
  

    </ul>
    
  
    
    
	
<li>12: <a href="#pg-b1f3db196ed4affef1e665659e3bf482">Keepalived</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.1: <a href="#pg-295f28cbefbc44466b8fbb62852e0e33">Keepalived简介</a></li>


    
  
    
    
	
<li>12.2: <a href="#pg-a0c0ae349d3e1054e9789f4f459ccd1c">Keepalived安装与配置</a></li>


    
  
    
    
	
<li>12.3: <a href="#pg-e553bc1d8197e89a121a1338faed792d">Keepalived相关操作</a></li>


    
  
    
    
	
<li>12.4: <a href="#pg-c60c32f3a5275e8f405771d11c5a360f">Keepalived配置详解</a></li>


    
  

    </ul>
    
  
    
    
	
<li>13: <a href="#pg-16f49169aa956c243ca215c373a08ac2">IDE配置</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>13.1: <a href="#pg-243ed74536ebf2005c7cf02805cada75">vscode使用配置</a></li>


    
  
    
    
	
<li>13.2: <a href="#pg-7224ecb92d80a9b6c12c139c7848a293">Goland配置</a></li>


    
  
    
    
	
<li>13.3: <a href="#pg-c4eb9770381a78fb5f9401001a8d5fa1">VIM配置</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>13.3.1: <a href="#pg-c20a457b7e26f9f05096ffe2529b4571">basic vimrc</a></li>


    
  
    
    
	
<li>13.3.2: <a href="#pg-20b46b33939e315547987e613a59b4fd">vim 命令</a></li>


    
  
    
    
	
<li>13.3.3: <a href="#pg-779146eac7118bf7f6498da5bb9ec3e4">vim 配置</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>14: <a href="#pg-bf34de6e998c6df58b66ee716c2bb945">快捷键</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>14.1: <a href="#pg-e3c108320ce63363bf1c69dd20cf3b36">vscode快捷键</a></li>


    
  
    
    
	
<li>14.2: <a href="#pg-c8f6be5c515ff7cf53a522f8a2590173">eclipse快捷键</a></li>


    
  
    
    
	
<li>14.3: <a href="#pg-272274d6cdd6ca909a6e3761d71fb5e4">chrome快捷键</a></li>


    
  
    
    
	
<li>14.4: <a href="#pg-5433013698b9a3e74116f9cc13b4d2b1">tmux快捷键</a></li>


    
  
    
    
	
<li>14.5: <a href="#pg-10c176346e3ba799558f25b19b5fc093">iterm2 rz与sz的使用</a></li>


    
  
    
    
	
<li>14.6: <a href="#pg-0718f1276a4708caa2b7206e4792ef77">博客问题记录</a></li>


    
  

    </ul>
    
  
    
    
	
<li>15: <a href="#pg-0488542643c0e111cc5f5c82f6e0c1cd">裸金属</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>15.1: <a href="#pg-fced43a1ad90e1cdc08fa6daea3e24fb">BMC概念</a></li>


    
  
    
    
	
<li>15.2: <a href="#pg-9518c18f4390f81263a98d07b0d07cff">Redfish API</a></li>


    
  
    
    
	
<li>15.3: <a href="#pg-37f45ccd9b715779fda2cec095a76286">格式化磁盘分区</a></li>


    
  

    </ul>
    
  
    
    
	
<li>16: <a href="#pg-f9e021ef17cb105673447af8aecd0337">大模型</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>16.1: <a href="#pg-093f126ec9e750c4adca83e14d272d51">基于Ollama构建本地大模型</a></li>


    
  
    
    
	
<li>16.2: <a href="#pg-e44128ff477d39d7fb8644a3a4a27ea6">大模型相关概念</a></li>


    
  

    </ul>
    
  
    
    
	
<li>17: <a href="#pg-025ba230ccbdecd2053c28d50a7b1b46"></a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-2b1d297a60eef39bc26a1596c55494b8">1 - Linux 文件系统</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-3d91317eb6270bd994a7ca5e80d4d8b7">1.1 - Linux介绍</h1>
    
	<h1 id="1-linux简介">1. Linux简介</h1>
<p>严格来讲，Linux（内核）是<code>计算机软件与硬件通信之间的平台</code>，不是真正意义上的操作系统，而一些厂家将Linux内核和GNU软件（系统软件和工具）整合起来，并提供一些安装界面和系统设定与管理工具，就构成一些发行套件（系统），例如：<code>Ubuntu</code>、<code>CentOS</code>、<code>Red Hat</code>、<code>Debian</code>等。</p>
<p><strong>Linux内核版本</strong></p>
<p>Linux内核版本一般格式为：<code>x.y.zz-www </code>，例如：Kernel2.6.15</p>
<ul>
<li>x.y：Linux内核主版本号，y若为奇数则表示是测试版</li>
<li>zz：次版本好</li>
<li>www：代表发行号</li>
</ul>
<h1 id="2-linux体系结构">2. Linux体系结构</h1>
<p>Linux体系结构如下：</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1536472043/article/linux/file-system/kernel.jpg" width=60%>
<p>几个重要概念：</p>
<ul>
<li><code>内核</code>：内核是操作系统的核心。内核直接与硬件交互，并处理大部分较低层的任务，如内存管理、进程调度、文件管理等。</li>
<li><code>Shell</code>：Shell是一个处理用户请求的工具，它负责解释用户输入的命令，调用用户希望使用的程序。</li>
<li><code>命令和工具</code>：日常工作中，你会用到很多系统命令和工具，如cp、mv、cat和grep等。</li>
<li><code>文件和目录</code>：Linux系统中所有的数据都被存储到文件中，这些文件被分配到各个目录，构成文件系统。</li>
</ul>
<h1 id="3-系统操作">3. 系统操作</h1>
<h2 id="3-1-登录linux">3.1. 登录Linux</h2>
<p>登录需要输入用户名和密码，用户名和密码是区分大小写。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>login : amrood
</span></span><span style="display:flex;"><span>amrood<span style="color:#a40000">&#39;</span>s password:
</span></span><span style="display:flex;"><span>Last login: Sun Jun <span style="color:#0000cf;font-weight:bold">14</span> 09:32:32 <span style="color:#0000cf;font-weight:bold">2009</span> from 62.61.164.73
</span></span><span style="display:flex;"><span>$
</span></span></code></pre></div><h2 id="3-2-修改密码">3.2. 修改密码</h2>
<p>输入<code>password</code>命令后，输入原密码和新密码，确认密码即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ passwd
</span></span><span style="display:flex;"><span>Changing password <span style="color:#204a87;font-weight:bold">for</span> amrood
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>current<span style="color:#ce5c00;font-weight:bold">)</span> Linux password:******
</span></span><span style="display:flex;"><span>New Linux password:*******
</span></span><span style="display:flex;"><span>Retype new Linux password:*******
</span></span><span style="display:flex;"><span>passwd: all authentication tokens updated  successfully
</span></span></code></pre></div><h2 id="3-3-查看当前用户">3.3. 查看当前用户</h2>
<p>1、查看自己的用户名</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ whoami
</span></span><span style="display:flex;"><span>amrood
</span></span></code></pre></div><p>2、查看当前在线用户</p>
<p>可以使用<code>users</code> 、<code>who</code>、<code>w</code>命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ users
</span></span><span style="display:flex;"><span>amrood bablu qadir
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ who
</span></span><span style="display:flex;"><span>amrood ttyp0 Oct <span style="color:#0000cf;font-weight:bold">8</span> 14:10 <span style="color:#ce5c00;font-weight:bold">(</span>limbo<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>bablu  ttyp2 Oct <span style="color:#0000cf;font-weight:bold">4</span> 09:08 <span style="color:#ce5c00;font-weight:bold">(</span>calliope<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>qadir  ttyp4 Oct <span style="color:#0000cf;font-weight:bold">8</span> 12:09 <span style="color:#ce5c00;font-weight:bold">(</span>dent<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ w
</span></span><span style="display:flex;"><span> 13:58:53 up <span style="color:#0000cf;font-weight:bold">158</span> days, 22:07,  <span style="color:#0000cf;font-weight:bold">3</span> users,  load average: 0.72, 0.99, 1.11
</span></span><span style="display:flex;"><span>USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
</span></span><span style="display:flex;"><span>root     pts/1    172.16.20.65     13:40    0.00s  0.22s  0.02s w
</span></span><span style="display:flex;"><span>root     pts/2    172.16.20.65     Fri15   43:17m  1.04s  1.04s -bash
</span></span></code></pre></div><h2 id="3-4-关闭系统">3.4. 关闭系统</h2>
<p>关闭系统可以使用以下命令</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>halt</td>
<td>直接关闭系统</td>
</tr>
<tr>
<td>init 0</td>
<td>使用预先定义的脚本关闭系统，关闭前可以清理和更新有关信息</td>
</tr>
<tr>
<td>init 6</td>
<td>重新启动系统</td>
</tr>
<tr>
<td>poweroff</td>
<td>通过断电来关闭系统</td>
</tr>
<tr>
<td>reboot</td>
<td>重新启动系统</td>
</tr>
<tr>
<td>shutdown</td>
<td>安全关闭系统</td>
</tr>
</tbody>
</table>
<blockquote>
<p>一般只有root有关闭系统的权限，普通用户被赋予相应权限也可以关闭系统。</p>
</blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9103fc8f641ac26af94593740e4ef6ab">1.2 - Linux文件系统</h1>
    
	<h1 id="1-文件系统">1. 文件系统</h1>
<p>文件系统就是分区或磁盘上的所有文件的逻辑集合。文件系统不仅包含着文件中的数据而且还有文件系统的结构，所有Linux 用户和程序看到的文件、目录、软连接及文件保护信息等都存储在其中。</p>
<p>不同Linux发行版本之间的文件系统差别很少，主要表现在系统管理的特色工具以及软件包管理方式的不同，文件目录结构基本上都是一样的。</p>
<ul>
<li>ext2 ： 早期linux中常用的文件系统；</li>
<li>ext3 ： ext2的升级版，带日志功能；</li>
<li>RAMFS ： 内存文件系统，速度很快；</li>
<li>iso9660：光盘或光盘镜像；</li>
<li>NFS ： 网络文件系统，由SUN发明，主要用于远程文件共享；</li>
<li>MS-DOS ： MS-DOS文件系统；</li>
<li>FAT ： Windows XP 操作系统采用的文件系统；</li>
<li>NTFS ： Windows NT/XP 操作系统采用的文件系统。</li>
</ul>
<h1 id="2-分区与目录">2. 分区与目录</h1>
<p>文件系统位于磁盘分区中；一个硬盘可以有多个分区，也可以只有一个分区；一个分区只能包含一个文件系统。</p>
<p>Linux文件系统与Windows有较大的差别：</p>
<ul>
<li>
<p>Windows的文件结构是多个并列的树状结构，最顶部的是不同的磁盘（分区），如 C、D、E、F等。</p>
</li>
<li>
<p>Linux的文件结构是单个的树状结构，根目录是“/”，其他目录都要位于根目录下。</p>
</li>
</ul>
<p>每次安装系统的时候我们都会进行分区，Linux下磁盘分区和目录的关系如下：</p>
<ul>
<li>任何一个分区都必须对应到某个目录上，才能进行读写操作，称为“挂载”。</li>
<li>被挂载的目录可以是根目录，也可以是其他二级、三级目录，任何目录都可以是挂载点。</li>
<li>目录是逻辑上的区分。分区是物理上的区分。</li>
<li>根目录是所有Linux的文件和目录所在的地方，需要挂载上一个磁盘分区。</li>
</ul>
<p>下图是常见的目录和分区的对应关系：</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1536666481/article/linux/file-system/file.png" width="70%">
<p>更详细的目录路径功能如下：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1536667515/article/linux/file-system/directory-tree.gif" alt=""></p>
<p>为什么要分区，如何分区？</p>
<ul>
<li>可以把不同资料，分别放入不同分区中管理，降低风险。</li>
<li>大硬盘搜索范围大，效率低。</li>
<li>/home、/var、/usr/local 经常是单独分区，因为经常会操作，容易产生碎片。</li>
</ul>
<p>为了便于定位和查找，Linux中的每个目录一般都存放特定类型的文件，下表列出了各种Linux发行版本的常见目录：</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>/</td>
<td>根目录，只能包含目录，不能包含具体文件。</td>
</tr>
<tr>
<td>/bin</td>
<td>存放可执行文件。很多命令就对应/bin目录下的某个程序，例如 ls、cp、mkdir。/bin目录对所有用户有效。</td>
</tr>
<tr>
<td>/dev</td>
<td>硬件驱动程序。例如声卡、磁盘驱动等，还有如 /dev/null、/dev/console、/dev/zero、/dev/full 等文件。</td>
</tr>
<tr>
<td>/etc</td>
<td>主要包含系统配置文件和用户、用户组配置文件。</td>
</tr>
<tr>
<td>/lib</td>
<td>主要包含共享库文件，类似于Windows下的DLL；有时也会包含内核相关文件。</td>
</tr>
<tr>
<td>/boot</td>
<td>系统启动文件，例如Linux内核、引导程序等。</td>
</tr>
<tr>
<td>/home</td>
<td>用户工作目录（主目录），每个用户都会分配一个目录。</td>
</tr>
<tr>
<td>/mnt</td>
<td>临时挂载文件系统。这个目录一般是用于存放挂载储存设备的挂载目录的，例如挂载CD-ROM的cdrom目录。</td>
</tr>
<tr>
<td>/proc</td>
<td>操作系统运行时，进程（正在运行中的程序）信息及内核信息（比如cpu、硬盘分区、内存信息等）存放在这里。/proc目录伪装的文件系统proc的挂载目录，proc并不是真正的文件系统。</td>
</tr>
<tr>
<td>/tmp</td>
<td>临时文件目录，系统重启后不会被保存。</td>
</tr>
<tr>
<td>/usr</td>
<td>/user目下的文件比较混杂，包含了管理命令、共享文件、库文件等，可以被很多用户使用。</td>
</tr>
<tr>
<td>/var</td>
<td>主要包含一些可变长度的文件，会经常对数据进行读写，例如日志文件和打印队列里的文件。</td>
</tr>
<tr>
<td>/sbin</td>
<td>和 /bin 类似，主要包含可执行文件，不过一般是系统管理所需要的，不是所有用户都需要。</td>
</tr>
</tbody>
</table>
<h1 id="3-常用文件管理命令">3. 常用文件管理命令</h1>
<p>你可以通过下面的命令来管理文件：</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>cat filename</td>
<td>查看文件内容。</td>
</tr>
<tr>
<td>cd dirname</td>
<td>改变所在目录。</td>
</tr>
<tr>
<td>cp file1 file2</td>
<td>复制文件或目录。</td>
</tr>
<tr>
<td>file filename</td>
<td>查看文件类型(binary, text, etc)。</td>
</tr>
<tr>
<td>find filename dir</td>
<td>搜索文件或目录。</td>
</tr>
<tr>
<td>head filename</td>
<td>显示文件的开头，与tail命令相对。</td>
</tr>
<tr>
<td>less filename</td>
<td>查看文件的全部内容，可以分页显示，比more命令要强大。</td>
</tr>
<tr>
<td>ls dirname</td>
<td>遍历目录下的文件或目录。</td>
</tr>
<tr>
<td>mkdir dirname</td>
<td>创建目录。</td>
</tr>
<tr>
<td>more filename</td>
<td>查看文件的全部内容，可以分页显示。</td>
</tr>
<tr>
<td>mv file1 file2</td>
<td>移动文件或重命名。</td>
</tr>
<tr>
<td>pwd</td>
<td>显示用户当前所在目录。</td>
</tr>
<tr>
<td>rm filename</td>
<td>删除文件。</td>
</tr>
<tr>
<td>rmdir dirname</td>
<td>删除目录。</td>
</tr>
<tr>
<td>tail filename</td>
<td>显示文件的结尾，与head命令相对。</td>
</tr>
<tr>
<td>touch filename</td>
<td>文件不存在时创建一个空文件，存在时修改文件时间戳。</td>
</tr>
<tr>
<td>whereis filename</td>
<td>查看文件所在位置。</td>
</tr>
<tr>
<td>which filename</td>
<td>如果文件在环境变量PATH中有定义，那么显示文件位置。</td>
</tr>
</tbody>
</table>
<h2 id="3-1-df命令">3.1. df命令</h2>
<p>管理磁盘分区时经常会使用 <strong>df</strong> (disk free) 命令，df -k 命令可以用来查看磁盘空间的使用情况（以千字节计），例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">$df</span> -k
</span></span><span style="display:flex;"><span>Filesystem      1K-blocks      Used   Available Use% Mounted on
</span></span><span style="display:flex;"><span>/dev/vzfs        <span style="color:#0000cf;font-weight:bold">10485760</span>   <span style="color:#0000cf;font-weight:bold">7836644</span>     <span style="color:#0000cf;font-weight:bold">2649116</span>  75% /
</span></span><span style="display:flex;"><span>/devices                <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#0000cf;font-weight:bold">0</span>   0% /devices
</span></span></code></pre></div><p>每一列的含义如下：</p>
<table>
<thead>
<tr>
<th>列</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Filesystem</td>
<td>代表文件系统对应的设备文件的路径名（一般是硬盘上的分区）。</td>
</tr>
<tr>
<td>kbytes</td>
<td>分区包含的数据块（1024字节）的数目。</td>
</tr>
<tr>
<td>used</td>
<td>已用空间。</td>
</tr>
<tr>
<td>avail</td>
<td>可用空间。</td>
</tr>
<tr>
<td>capacity</td>
<td>已用空间的百分比。</td>
</tr>
<tr>
<td>Mounted on</td>
<td>文件系统挂载点。</td>
</tr>
</tbody>
</table>
<p>某些目录（例如 /devices）的 kbytes、used、avail 列为0，use列为0%，这些都是特殊（或虚拟）文件系统，即使位于根目录下，也不占用硬盘空间。</p>
<p>你可以结合 -h (human readable) 选项将输出信息格式化，让人更易阅读。</p>
<h2 id="3-2-du-命令">3.2. du 命令</h2>
<p>du (disk usage) 命令可以用来查看特定目录的空间使用情况。</p>
<p>du 命令会显示每个目录所占用数据块。根据系统的不同，一个数据块可能是 512 字节或 1024 字节。举例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">$du</span> /etc
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">10</span>     /etc/cron.d
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">126</span>    /etc/default
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6</span>      /etc/dfs
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>结合 -h 选项可以让信息显示的更加清晰：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">$du</span> -h /etc
</span></span><span style="display:flex;"><span>5k    /etc/cron.d
</span></span><span style="display:flex;"><span>63k   /etc/default
</span></span><span style="display:flex;"><span>3k    /etc/dfs
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h1 id="4-挂载文件系统">4. 挂载文件系统</h1>
<p>挂载是指将一个硬件设备（例如硬盘、U盘、光盘等）对应到一个已存在的目录上。 若要访问设备中的文件，必须将文件挂载到一个已存在的目录上， 然后通过访问这个目录来访问存储设备。</p>
<p>这样就为用户提供了统一的接口，屏蔽了硬件设备的细节。Linux将所有的硬件设备看做文件，对硬件设备的操作等同于对文件的操作。</p>
<p>注意：挂载目录可以不为空，但挂载后这个目录下以前的内容将不可用。</p>
<p>需要知道的是，光盘、软盘、其他操作系统使用的文件系统的格式与linux使用的文件系统格式是不一样的，挂载需要确认Linux是否支持所要挂载的文件系统格式。</p>
<p>查看当前系统所挂载的硬件设备可以使用 mount 命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ mount
</span></span><span style="display:flex;"><span>/dev/vzfs on / <span style="color:#204a87">type</span> reiserfs <span style="color:#ce5c00;font-weight:bold">(</span>rw,usrquota,grpquota<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>proc on /proc <span style="color:#204a87">type</span> proc <span style="color:#ce5c00;font-weight:bold">(</span>rw,nodiratime<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>devpts on /dev/pts <span style="color:#204a87">type</span> devpts <span style="color:#ce5c00;font-weight:bold">(</span>rw<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>一般约定，/mnt 为临时挂载目录，例如挂载CD-ROM、远程网络设备、软盘等。
也可以通过mount命令来挂载文件系统，语法为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mount -t file_system_type device_to_mount directory_to_mount_to
</span></span></code></pre></div><p>例如：</p>
<p>将 CD-ROM 挂载到 /mnt/cdrom 目录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ mount -t iso9660 /dev/cdrom /mnt/cdrom
</span></span></code></pre></div><p>注意：file_system_type用来指定文件系统类型，通常可以不指定，Linux会自动正确选择文件系统类型。</p>
<p>挂载文件系统后，就可以通过 cd、cat 等命令来操作对应文件。</p>
<p>可以通过 umount 命令来卸载文件系统。例如，卸载 cdrom：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ umount /dev/cdrom
</span></span></code></pre></div><p>不过，大部分现代的Linux系统都有自动挂载卸载功能，unmount 命令较少用到。</p>
<h1 id="5-用户和群组配额">5. 用户和群组配额</h1>
<p>用户和群组配额可以让管理员为每个用户或群组分配固定的磁盘空间。
管理员有两种方式来分配磁盘空间：</p>
<ul>
<li>软限制：如果用户超过指定的空间，会有一个宽限期，等待用户释放空间。</li>
<li>硬限制：没有宽限期，超出指定空间立即禁止操作。</li>
</ul>
<p>下面的命令可以用来管理配额：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>quota</td>
<td>显示磁盘使用情况以及每个用户组的配额。</td>
</tr>
<tr>
<td>edquota</td>
<td>编辑用户和群组的配额。</td>
</tr>
<tr>
<td>quotacheck</td>
<td>查看文件系统的磁盘使用情况，创建、检查并修复配额文件。</td>
</tr>
<tr>
<td>setquota</td>
<td>设置配额。</td>
</tr>
<tr>
<td>quotaon</td>
<td>开启用户或群组的配额功能。</td>
</tr>
<tr>
<td>quotaoff</td>
<td>关闭用户或群组的配额功能。</td>
</tr>
<tr>
<td>repquota</td>
<td>打印指定文件系统的配额。</td>
</tr>
</tbody>
</table>
<p>参考：</p>
<ul>
<li><a href="http://c.biancheng.net/cpp/linux/">http://c.biancheng.net/cpp/linux/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6135486aa33d07567abb490570427588">1.3 - Linux文件存储</h1>
    
	<h1 id="文件存储结构">文件存储结构</h1>
<p>大部分的Linux文件系统（如ext2、ext3）规定，一个文件由目录项、inode和数据块组成</p>
<ul>
<li>目录项：包括文件名和inode节点号。</li>
<li>Inode：又称文件索引节点，包含文件的基础信息以及数据块的指针。</li>
<li>数据块：包含文件的具体内容。</li>
</ul>
<h2 id="1-inode">1. inode</h2>
<p>理解inode，要从文件储存说起。文件储存在硬盘上，硬盘的最小存储单位叫做&quot;扇区&quot;（Sector），每个扇区储存512字节（相当于0.5KB）。</p>
<p>操作系统读取硬盘的时候，不会一个扇区一个扇区地读取，这样效率太低，而是一次性连续读取多个扇区，即一次性读取一个&quot;块&quot;（block）。这种由多个扇区组成的&quot;块&quot;，是文件存取的最小单位。，即连续八个 sector组成一个 block。</p>
<p>文件数据都储存在&quot;块&quot;中，那么很显然，我们还必须找到一个地方储存文件的元信息，比如文件的创建者、文件的创建日期、文件的大小等等。这种储存文件元信息的区域就叫做inode，中文译名为&quot;索引节点&quot;。</p>
<p>inode包含文件的元信息，具体来说有以下内容：</p>
<ul>
<li>文件的字节数。</li>
<li>文件拥有者的User ID。</li>
<li>文件的Group ID。</li>
<li>文件的读、写、执行权限。</li>
<li>文件的时间戳，共有三个：ctime指inode上一次变动的时间，mtime指文件内容上一次变动的时间，atime指文件上一次打开的时间。</li>
<li>链接数，即有多少文件名指向这个inode。</li>
<li>文件数据block的位置。</li>
</ul>
<p>可以用stat命令，查看某个文件的inode信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>stat demo.txt
</span></span></code></pre></div><p>总之，除了文件名以外的所有文件信息，都存在inode之中。</p>
<p>当查看某个文件时，会先从inode表中查出文件属性及数据存放点，再从数据块中读取数据。</p>
<p>请看文件存储结构示意图：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1741317220/article/linux/file-system/linux-storage.png" alt="img"></p>
<h3 id="1-1-inode的大小">1.1. inode的大小</h3>
<p>inode也会消耗硬盘空间，所以硬盘格式化的时候，操作系统自动将硬盘分成两个区域。一个是数据区，存放文件数据；另一个是inode区（inode table），存放inode所包含的信息。</p>
<p>每个inode节点的大小，一般是128字节或256字节。inode节点的总数，在格式化时就给定，一般是每1KB或每2KB就设置一个inode。假定在一块1GB的硬盘中，每个inode节点的大小为128字节，每1KB就设置一个inode，那么inode table的大小就会达到128MB，占整块硬盘的12.8%。</p>
<p>查看每个硬盘分区的inode总数和已经使用的数量，可以使用df -i 命令。</p>
<p>查看每个inode节点的大小，可以用如下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo dumpe2fs -h /dev/hda <span style="color:#000;font-weight:bold">|</span> grep <span style="color:#4e9a06">&#34;Inode size&#34;</span>
</span></span></code></pre></div><p>由于每个文件都必须有一个inode，因此有可能发生inode已经用光，但是硬盘还未存满的情况。这时，就无法在硬盘上创建新文件。</p>
<h3 id="1-2-inode号码">1.2. inode号码</h3>
<p>每个inode都有一个号码，操作系统用inode号码来识别不同的文件。</p>
<p>Linux系统内部不使用文件名，而使用inode号码来识别文件。对于系统来说，文件名只是inode号码便于识别的别称或者绰号。表面上，用户通过文件名，打开文件。实际上，系统内部这个过程分成三步：首先，系统找到这个文件名对应的inode号码；其次，通过inode号码，获取inode信息；最后，根据inode信息，找到文件数据所在的block，读出数据。</p>
<p>使用ls -i命令，可以看到文件名对应的inode号码，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls -i demo.txt
</span></span></code></pre></div><h2 id="3-目录项">3. 目录项</h2>
<p>Linux系统中，目录（directory）也是一种文件。打开目录，实际上就是打开目录文件。</p>
<p>目录文件的结构非常简单，就是一系列目录项（dirent）的列表。每个目录项，由两部分组成：所包含文件的文件名，以及该文件名对应的inode号码。</p>
<p>ls命令只列出目录文件中的所有文件名：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls /etc
</span></span></code></pre></div><p>ls -i命令列出整个目录文件，即文件名和inode号码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls -i /etc
</span></span></code></pre></div><p>如果要查看文件的详细信息，就必须根据inode号码，访问inode节点，读取信息。ls -l命令列出文件的详细信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls -l /etc
</span></span></code></pre></div><h2 id="4-硬链接和软链接">4. 硬链接和软链接</h2>
<h3 id="4-1-硬链接">4.1. 硬链接</h3>
<p>一般情况下，文件名和inode号码是&quot;一一对应&quot;关系，每个inode号码对应一个文件名。但是，Linux系统允许，多个文件名指向同一个inode号码。这意味着，可以用不同的文件名访问同样的内容；对文件内容进行修改，会影响到所有文件名；但是，删除一个文件名，不影响另一个文件名的访问。这种情况就被称为&quot;硬链接&quot;（hard link）。</p>
<p>ln命令可以创建硬链接</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln source_file target_file
</span></span></code></pre></div><p>运行上面这条命令以后，源文件与目标文件的inode号码相同，都指向同一个inode。inode信息中有一项叫做&quot;链接数&quot;，记录指向该inode的文件名总数，这时就会增加1。反过来，删除一个文件名，就会使得inode节点中的&quot;链接数&quot;减1。当这个值减到0，表明没有文件名指向这个inode，系统就会回收这个inode号码，以及其所对应block区域。</p>
<p>这里顺便说一下目录文件的&quot;链接数&quot;。创建目录时，默认会生成两个目录项：&quot;.&quot;和&quot;..&quot;。前者的inode号码就是当前目录的inode号码，等同于当前目录的&quot;硬链接&quot;；后者的inode号码就是当前目录的父目录的inode号码，等同于父目录的&quot;硬链接&quot;。所以，任何一个目录的&quot;硬链接&quot;总数，总是等于2加上它的子目录总数（含隐藏目录）,这里的2是父目录对其的“硬链接”和当前目录下的&quot;.硬链接“。</p>
<h3 id="4-2-软链接">4.2. 软链接</h3>
<p>除了硬链接以外，还有一种特殊情况。文件A和文件B的inode号码虽然不一样，但是文件A的内容是文件B的路径。读取文件A时，系统会自动将访问者导向文件B。因此，无论打开哪一个文件，最终读取的都是文件B。这时，文件A就称为文件B的&quot;软链接&quot;（soft link）或者&quot;符号链接（symbolic link）。</p>
<p>这意味着，文件A依赖于文件B而存在，如果删除了文件B，打开文件A就会报错：&quot;No such file or directory&quot;。这是软链接与硬链接最大的不同：文件A指向文件B的文件名，而不是文件B的inode号码，文件B的inode&quot;链接数&quot;不会因此发生变化。</p>
<p>ln -s命令可以创建软链接</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln -s source_file target_file
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="http://c.biancheng.net/cpp/linux/">http://c.biancheng.net/cpp/linux/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a7b3f765840dfa2ad5df8a5b65479d1b">1.4 - Linux文件权限</h1>
    
	<h1 id="1-linux文件管理">1. Linux文件管理</h1>
<p>Linux中的所有数据都被保存在文件中，所有的文件被分配到不同的目录。目录是一种类似于树的结构，称为文件系统。</p>
<h2 id="1-1-文件类型">1.1. 文件类型</h2>
<p>1、<code>普通文件</code></p>
<p>普通文件是以字节为单位的数据流，包括文本文件、源码文件、可执行文件等。文本和二进制对Linux来说并无区别，对普通文件的解释由处理该文件的应用程序进行。</p>
<p>2、<code>目录</code></p>
<p>目录可以包含普通文件和特殊文件，目录相当于Windows和Mac OS中的文件夹。</p>
<p>3、<code>设备文件</code></p>
<p>Linux 与外部设备（例如光驱，打印机，终端，modern等）是通过一种被称为设备文件的文件来进行通信。Linux 输入输出到外部设备的方式和输入输出到一个文件的方式是相同的。Linux 和一个外部设备通讯之前，这个设备必须首先要有一个设备文件存在。</p>
<p>设备文件和普通文件不一样，设备文件中并不包含任何数据。</p>
<p>设备文件有两种类型：字符设备文件和块设备文件。</p>
<ul>
<li>字符设备文件以字母&quot;c&quot;开头。字符设备文件向设备传送数据时，一次传送一个字符。典型的通过字符传送数据的设备有终端、打印机、绘图仪、modern等。字符设备文件有时也被称为&quot;raw&quot;设备文件。</li>
<li>块设备文件以字母&quot;b&quot;开头。块设备文件向设备传送数据时，先从内存中的buffer中读或写数据，而不是直接传送数据到物理磁盘。磁盘和CD-ROMS既可以使用字符设备文件也可以使用块设备文件。</li>
</ul>
<h2 id="1-2-文件属性">1.2. 文件属性</h2>
<p>可以使用<code>ls -al</code>来查看当前目录下的所有文件列表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@www ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># ls -al</span>
</span></span><span style="display:flex;"><span>total <span style="color:#0000cf;font-weight:bold">156</span>
</span></span><span style="display:flex;"><span>drwxr-x---   <span style="color:#0000cf;font-weight:bold">4</span>    root   root     <span style="color:#0000cf;font-weight:bold">4096</span>   Sep  <span style="color:#0000cf;font-weight:bold">8</span> 14:06 .   <span style="color:#8f5902;font-style:italic"># 当前目录</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#0000cf;font-weight:bold">23</span>    root   root     <span style="color:#0000cf;font-weight:bold">4096</span>   Sep  <span style="color:#0000cf;font-weight:bold">8</span> 14:21 ..  <span style="color:#8f5902;font-style:italic"># 父目录</span>
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#0000cf;font-weight:bold">1</span>    root   root     <span style="color:#0000cf;font-weight:bold">1474</span>   Sep  <span style="color:#0000cf;font-weight:bold">4</span> 18:27 anaconda-ks.cfg
</span></span><span style="display:flex;"><span>-rw-------   <span style="color:#0000cf;font-weight:bold">1</span>    root   root      <span style="color:#0000cf;font-weight:bold">199</span>   Sep  <span style="color:#0000cf;font-weight:bold">8</span> 17:14 .bash_history
</span></span><span style="display:flex;"><span>-rw-r--r--   <span style="color:#0000cf;font-weight:bold">1</span>    root   root       <span style="color:#0000cf;font-weight:bold">24</span>   Jan  <span style="color:#0000cf;font-weight:bold">6</span>  <span style="color:#0000cf;font-weight:bold">2007</span> .bash_logout
</span></span><span style="display:flex;"><span>-rw-r--r--   <span style="color:#0000cf;font-weight:bold">1</span>    root   root      <span style="color:#0000cf;font-weight:bold">191</span>   Jan  <span style="color:#0000cf;font-weight:bold">6</span>  <span style="color:#0000cf;font-weight:bold">2007</span> .bash_profile
</span></span><span style="display:flex;"><span>-rw-r--r--   <span style="color:#0000cf;font-weight:bold">1</span>    root   root      <span style="color:#0000cf;font-weight:bold">176</span>   Jan  <span style="color:#0000cf;font-weight:bold">6</span>  <span style="color:#0000cf;font-weight:bold">2007</span> .bashrc
</span></span><span style="display:flex;"><span>-rw-r--r--   <span style="color:#0000cf;font-weight:bold">1</span>    root   root      <span style="color:#0000cf;font-weight:bold">100</span>   Jan  <span style="color:#0000cf;font-weight:bold">6</span>  <span style="color:#0000cf;font-weight:bold">2007</span> .cshrc
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#0000cf;font-weight:bold">3</span>    root   root     <span style="color:#0000cf;font-weight:bold">4096</span>   Sep  <span style="color:#0000cf;font-weight:bold">5</span> 10:37 .gconf      
</span></span><span style="display:flex;"><span>drwx------   <span style="color:#0000cf;font-weight:bold">2</span>    root   root     <span style="color:#0000cf;font-weight:bold">4096</span>   Sep  <span style="color:#0000cf;font-weight:bold">5</span> 14:09 .gconfd
</span></span><span style="display:flex;"><span>-rw-r--r--   <span style="color:#0000cf;font-weight:bold">1</span>    root   root    <span style="color:#0000cf;font-weight:bold">42304</span>   Sep  <span style="color:#0000cf;font-weight:bold">4</span> 18:26 install.log
</span></span><span style="display:flex;"><span>-rw-r--r--   <span style="color:#0000cf;font-weight:bold">1</span>    root   root     <span style="color:#0000cf;font-weight:bold">5661</span>   Sep  <span style="color:#0000cf;font-weight:bold">4</span> 18:25 install.log.syslog
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>    <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">][</span>   <span style="color:#0000cf;font-weight:bold">3</span>  <span style="color:#ce5c00;font-weight:bold">][</span>  <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#ce5c00;font-weight:bold">]</span>  <span style="color:#ce5c00;font-weight:bold">[</span>  <span style="color:#0000cf;font-weight:bold">5</span>   <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>    <span style="color:#0000cf;font-weight:bold">6</span>     <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>       <span style="color:#0000cf;font-weight:bold">7</span>          <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>  权限   <span style="color:#ce5c00;font-weight:bold">][</span>文件数<span style="color:#ce5c00;font-weight:bold">][</span>所有者<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>用户组<span style="color:#ce5c00;font-weight:bold">][</span>文件容量<span style="color:#ce5c00;font-weight:bold">][</span> 修改日期   <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>      文件名      <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>每列含义说明：</p>
<ul>
<li>第一列：文件类型。</li>
<li>第二列：表示文件个数。如果是文件，那么就是1；如果是目录，那么就是该目录中文件的数目。</li>
<li>第三列：文件的所有者，即文件的创建者。</li>
<li>第四列：文件所有者所在的用户组。在Linux中，每个用户都隶属于一个用户组。</li>
<li>第五列：文件大小（以字节计）。</li>
<li>第六列：文件被创建或上次被修改的时间。</li>
<li>第七列：文件名或目录名。</li>
</ul>
<p><strong>文件类型字符</strong></p>
<table>
<thead>
<tr>
<th>前缀</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>-</td>
<td>普通文件。如文本文件、二进制可执行文件、源代码等。</td>
</tr>
<tr>
<td>b</td>
<td>块设备文件。硬盘可以使用块设备文件。</td>
</tr>
<tr>
<td>c</td>
<td>字符设备文件。硬盘也可以使用字符设备文件。</td>
</tr>
<tr>
<td>d</td>
<td>目录文件。目录可以包含文件和其他目录。</td>
</tr>
<tr>
<td>l</td>
<td>符号链接（软链接）。可以链接任何普通文件，类似于 Windows 中的快捷方式。</td>
</tr>
<tr>
<td>p</td>
<td>具名管道。管道是进程间的一种通信机制。</td>
</tr>
<tr>
<td>s</td>
<td>用于进程间通信的套接字。</td>
</tr>
</tbody>
</table>
<p><strong>隐藏文件</strong></p>
<p>隐藏文件的第一个字符为英文句号或点号(.)，Linux程序（包括Shell）通常使用隐藏文件来保存配置信息。可以通过<code>ls -a</code>来查看所有文件，即包含隐藏文件。</p>
<p>常见的隐藏文件：
.profile：Bourne shell (sh) 初始化脚本
.kshrc：Korn shell (ksh) 初始化脚本
.cshrc：C shell (csh) 初始化脚本
.rhosts：Remote shell (rsh) 配置文件</p>
<h2 id="1-3-文件的操作">1.3. 文件的操作</h2>
<table>
<thead>
<tr>
<th>操作</th>
<th>命令</th>
</tr>
</thead>
<tbody>
<tr>
<td>创建</td>
<td>touch filename</td>
</tr>
<tr>
<td>编辑</td>
<td>vi filename</td>
</tr>
<tr>
<td>查看</td>
<td>cat filename</td>
</tr>
<tr>
<td>复制</td>
<td>cp filename copyfile</td>
</tr>
<tr>
<td>重命名</td>
<td>mv filename newfile</td>
</tr>
<tr>
<td>删除</td>
<td>rm filename filename2</td>
</tr>
<tr>
<td>统计词数</td>
<td>wc filename</td>
</tr>
</tbody>
</table>
<h2 id="1-4-标准的linux流">1.4. 标准的Linux流</h2>
<p>一般情况下，每个Linux程序运行时都会创建三个文件流（三个文件）：</p>
<ul>
<li><code>标准输入流(stdin)</code>：stdin的文件描述符为0，Linux程序默认从stdin读取数据。</li>
<li><code>标准输出流(stdout)</code>：stdout 的文件描述符为1，Linux程序默认向stdout输出数据。</li>
<li><code>标准错误流(stderr)</code>：stderr的文件描述符为2，Linux程序会向stderr流中写入错误信息。</li>
</ul>
<h1 id="2-文件权限和访问模式">2. 文件权限和访问模式</h1>
<h2 id="2-1-查看文件权限">2.1. 查看文件权限</h2>
<p>Linux每个文件都有三类权限：</p>
<ul>
<li><code>所有者权限(user)</code>：文件所有者能够进行的操作</li>
<li><code>组权限(group)</code>：文件所属用户组能够进行的操作</li>
<li><code>外部权限（other）</code>：其他用户可以进行的操作。</li>
</ul>
<p>通过<code>ls -l</code>的命令可以查看文件权限信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">$ls</span> -l /home/amrood
</span></span><span style="display:flex;"><span>-rwxr-xr--  <span style="color:#0000cf;font-weight:bold">1</span> amrood   users <span style="color:#0000cf;font-weight:bold">1024</span>  Nov <span style="color:#0000cf;font-weight:bold">2</span> 00:10  myfile
</span></span><span style="display:flex;"><span>drwxr-xr--- <span style="color:#0000cf;font-weight:bold">1</span> amrood   users <span style="color:#0000cf;font-weight:bold">1024</span>  Nov <span style="color:#0000cf;font-weight:bold">2</span> 00:10  mydir
</span></span></code></pre></div><p>第一列<code>-rwxr-xr-- </code>包含了文件或目录的权限。</p>
<p>除了第一个字符<code>-</code>或<code>d</code>分别用来表示<code>文件</code>或<code>目录</code>外，其他的九个字符可以分为三组，分别对应<code>所有者权限</code>，<code>用户组权限</code>，<code>其他用户权限</code>，即<code>-|user|group|other</code>。</p>
<p>每组的权限又可分为三类：</p>
<ul>
<li>
<p><code>读取（r）</code>，对应权限数字<code>4</code></p>
</li>
<li>
<p><code>写入（w）</code>，对应权限数字<code>2</code></p>
</li>
<li>
<p><code>执行（x）</code>，对应权限数字<code>1</code></p>
</li>
</ul>
<p>使用数字表示权限：</p>
<table>
<thead>
<tr>
<th>数字</th>
<th>说明</th>
<th>权限</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>没有任何权限</td>
<td>---</td>
</tr>
<tr>
<td>1</td>
<td>执行权限</td>
<td>--x</td>
</tr>
<tr>
<td>2</td>
<td>写入权限</td>
<td>-w-</td>
</tr>
<tr>
<td>3</td>
<td>执行权限和写入权限：1 (执行) + 2 (写入) = 3</td>
<td>-wx</td>
</tr>
<tr>
<td>4</td>
<td>读取权限</td>
<td>r--</td>
</tr>
<tr>
<td>5</td>
<td>读取和执行权限：4 (读取) + 1 (执行) = 5</td>
<td>r-x</td>
</tr>
<tr>
<td>6</td>
<td>读取和写入权限：4 (读取) + 2 (写入) = 6</td>
<td>rw-</td>
</tr>
<tr>
<td>7</td>
<td>所有权限: 4 (读取) + 2 (写入) + 1 (执行) = 7</td>
<td>rwx</td>
</tr>
</tbody>
</table>
<h2 id="2-2-访问模式">2.2. 访问模式</h2>
<h3 id="2-2-1-文件访问模式">2.2.1. 文件访问模式</h3>
<p>基本的权限有读取(r)、写入(w)和执行(x)：</p>
<ul>
<li>读取：用户能够读取文件信息，查看文件内容。</li>
<li>写入：用户可以编辑文件，可以向文件写入内容，也可以删除文件内容。</li>
<li>执行：用户可以将文件作为程序来运行。</li>
</ul>
<h3 id="2-2-2-目录访问模式">2.2.2. 目录访问模式</h3>
<p>目录的访问模式和文件类似，但是稍有不同：</p>
<ul>
<li>读取：用户可以查看目录中的文件</li>
<li>写入：用户可以在当前目录中删除文件或创建文件</li>
<li>执行：执行权限赋予用户遍历目录的权利，例如执行 cd 和 ls 命令。</li>
</ul>
<h2 id="2-3-权限的操作">2.3. 权限的操作</h2>
<h3 id="2-3-1-chmod">2.3.1. chmod</h3>
<p><strong>chmod</strong> (change mode) 命令来改变文件或目录的访问权限，权限可以使用符号或数字来表示。</p>
<p><strong>1、通过符号方式</strong></p>
<p>可以使用符号来改变文件或目录的权限，你可以增加(+)和删除(-)权限，也可以指定特定权限(=)。</p>
<p>指定权限范围</p>
<ul>
<li>u (user)：所有者权限</li>
<li>g(group)：所属用户组权限</li>
<li>o(other)：其他用户权限</li>
</ul>
<table>
<thead>
<tr>
<th>符号</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>+</td>
<td>为文件或目录增加权限</td>
</tr>
<tr>
<td>-</td>
<td>删除文件或目录的权限</td>
</tr>
<tr>
<td>=</td>
<td>设置指定的权限</td>
</tr>
</tbody>
</table>
<p>示例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看权限</span>
</span></span><span style="display:flex;"><span><span style="color:#000">$ls</span> -l testfile
</span></span><span style="display:flex;"><span>-rwxrwxr--  <span style="color:#0000cf;font-weight:bold">1</span> amrood   users <span style="color:#0000cf;font-weight:bold">1024</span>  Nov <span style="color:#0000cf;font-weight:bold">2</span> 00:10  testfile
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 增加权限</span>
</span></span><span style="display:flex;"><span><span style="color:#000">$chmod</span> o+wx testfile
</span></span><span style="display:flex;"><span><span style="color:#000">$ls</span> -l testfile
</span></span><span style="display:flex;"><span>-rwxrwxrwx  <span style="color:#0000cf;font-weight:bold">1</span> amrood   users <span style="color:#0000cf;font-weight:bold">1024</span>  Nov <span style="color:#0000cf;font-weight:bold">2</span> 00:10  testfile
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除权限</span>
</span></span><span style="display:flex;"><span><span style="color:#000">$chmod</span> u-x testfile
</span></span><span style="display:flex;"><span><span style="color:#000">$ls</span> -l testfile
</span></span><span style="display:flex;"><span>-rw-rwxrwx  <span style="color:#0000cf;font-weight:bold">1</span> amrood   users <span style="color:#0000cf;font-weight:bold">1024</span>  Nov <span style="color:#0000cf;font-weight:bold">2</span> 00:10  testfile
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定权限</span>
</span></span><span style="display:flex;"><span><span style="color:#000">$chmod</span> <span style="color:#000">g</span><span style="color:#ce5c00;font-weight:bold">=</span>rx testfile
</span></span><span style="display:flex;"><span><span style="color:#000">$ls</span> -l testfile
</span></span><span style="display:flex;"><span>-rw-r-xrwx  <span style="color:#0000cf;font-weight:bold">1</span> amrood   users <span style="color:#0000cf;font-weight:bold">1024</span>  Nov <span style="color:#0000cf;font-weight:bold">2</span> 00:10  testfile
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 同时使用多个符号</span>
</span></span><span style="display:flex;"><span><span style="color:#000">$chmod</span> o+wx,u-x,g<span style="color:#ce5c00;font-weight:bold">=</span>rx testfile
</span></span><span style="display:flex;"><span><span style="color:#000">$ls</span> -l testfile
</span></span><span style="display:flex;"><span>-rw-r-xrwx  <span style="color:#0000cf;font-weight:bold">1</span> amrood   users <span style="color:#0000cf;font-weight:bold">1024</span>  Nov <span style="color:#0000cf;font-weight:bold">2</span> 00:10  testfile
</span></span></code></pre></div><p><strong>2、通过数字权限方式</strong></p>
<p>数字权限依照<code>2.1</code>的权限说明。</p>
<p>示例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">$ls</span> -l testfile
</span></span><span style="display:flex;"><span>-rwxrwxr--  <span style="color:#0000cf;font-weight:bold">1</span> amrood   users <span style="color:#0000cf;font-weight:bold">1024</span>  Nov <span style="color:#0000cf;font-weight:bold">2</span> 00:10  testfile
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#0000cf;font-weight:bold">755</span> testfile
</span></span><span style="display:flex;"><span><span style="color:#000">$ls</span> -l testfile
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#0000cf;font-weight:bold">1</span> amrood   users <span style="color:#0000cf;font-weight:bold">1024</span>  Nov <span style="color:#0000cf;font-weight:bold">2</span> 00:10  testfile
</span></span></code></pre></div><h3 id="2-3-2-chown">2.3.2. chown</h3>
<p>chown 命令是&quot;change owner&quot;的缩写，用来改变文件的<code>所有者</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># user可以是用户名或用户ID</span>
</span></span><span style="display:flex;"><span>$ chown user filelist
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如：</span>
</span></span><span style="display:flex;"><span>$ chown amrood testfile
</span></span></code></pre></div><blockquote>
<p>超级用户 root 可以不受限制的更改文件的所有者和用户组，但是普通用户只能更改所有者是自己的文件或目录。</p>
</blockquote>
<h3 id="2-3-3-chgrp">2.3.3. chgrp</h3>
<p>chgrp 命令是&quot;change group&quot;的缩写，用来改变文件所在的<code>群组</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># group可以是用户组名或用户组ID</span>
</span></span><span style="display:flex;"><span>$ chgrp group filelist
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如：</span>
</span></span><span style="display:flex;"><span>$ chgrp special testfile
</span></span></code></pre></div><h2 id="2-4-suid和sgid位">2.4. SUID和SGID位</h2>
<p>在Linux中，一些程序需要特殊权限才能完成用户指定的操作。例如密码文件<code>/etc/shadow</code>。</p>
<p>Linux 通过给程序设置SUID(Set User ID)和SGID(Set Group ID)位来赋予普通用户特殊权限。当我们运行一个带有SUID位的程序时，就会继承该程序所有者的权限；如果程序不带SUID位，则会根据程序使用者的权限来运行。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -l /usr/bin/passwd
</span></span><span style="display:flex;"><span>-r-sr-xr-x  <span style="color:#0000cf;font-weight:bold">1</span>   root   bin  <span style="color:#0000cf;font-weight:bold">19031</span> Feb <span style="color:#0000cf;font-weight:bold">7</span> 13:47  /usr/bin/passwd*
</span></span></code></pre></div><p>上面第一列第四个字符不是'x'或'-'，而是's'，说明 /usr/bin/passwd 文件设置了SUID位，这时普通用户会以root用户的权限来执行passwd程序。</p>
<blockquote>
<p>小写字母's'说明文件所有者有执行权限(x)，大写字母'S'说明程序所有者没有执行权限(x)。</p>
</blockquote>
<p>为一个目录设置SUID和SGID位可以使用下面的命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ chmod ug+s dirname
</span></span><span style="display:flex;"><span>$ ls -l
</span></span><span style="display:flex;"><span>drwsr-sr-x <span style="color:#0000cf;font-weight:bold">2</span> root root  <span style="color:#0000cf;font-weight:bold">4096</span> Jun <span style="color:#0000cf;font-weight:bold">19</span> 06:45 dirname
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-001340490ba5e7da366978868f3215e6">1.5 - Linux常用命令</h1>
    
	<h1 id="创建用户名和密码">创建用户名和密码</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过写文件创建用户，/home/mybot是用户目录</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;mybot:x:1001:1001::/home/mybot:/bin/bash&#34;</span> &gt;&gt; /etc/passwd
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 给用户创建密码</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;mybot:{password}&#34;</span> <span style="color:#000;font-weight:bold">|</span> chpasswd
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定文件系统根目录创建密码，例如：/mnt/dev/sda，一般为外挂文件系统，并没有chroot</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;mybot:{password}&#34;</span> <span style="color:#000;font-weight:bold">|</span> chpasswd -R /mnt/dev/sda
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 给用户分配sudo权限，NOPASSWD表示不需要root密码执行sudo</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;mybot ALL=(root) NOPASSWD: ALL&#34;</span> &gt; /etc/sudoers.d/mybot
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置允许ssh用户密码登录</span>
</span></span><span style="display:flex;"><span>sudo sed -i <span style="color:#4e9a06">&#39;s/^#\?PasswordAuthentication no/PasswordAuthentication yes/&#39;</span> /etc/ssh/sshd_config
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置不允许ssh密码登录</span>
</span></span><span style="display:flex;"><span>sudo sed -i <span style="color:#4e9a06">&#39;s/PasswordAuthentication yes/PasswordAuthentication no/&#39;</span> /etc/ssh/sshd_config
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 不重启ssh服务使得配置修改生效</span>
</span></span><span style="display:flex;"><span>sudo systemctl reload sshd
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ee442c6d6808dd7649643a83c1efc6a2">2 - 磁盘</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-efb1da2d07097c48baf556ef4e43b997">2.1 - 磁盘命令</h1>
    
	<h1 id="1-判断磁盘是ssd或hdd盘">1. 判断磁盘是SSD或HDD盘</h1>
<p><strong>1、没有使用raid方案</strong></p>
<p>lsblk -d -o name,rota命令，0表示SSD，1表示HDD</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># lsblk -d -o name,rota</span>
</span></span><span style="display:flex;"><span>NAME ROTA
</span></span><span style="display:flex;"><span>sda     <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>sdb     <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>sdc     <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><p><strong>2、使用raid方案</strong></p>
<p>下载工具</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/eLvErDe/hwraid/master/wrapper-scripts/megaclisas-status
</span></span></code></pre></div><p>执行检测命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ megaclisas-status
</span></span><span style="display:flex;"><span>-- Controller information --
</span></span><span style="display:flex;"><span>-- ID <span style="color:#000;font-weight:bold">|</span> H/W Model <span style="color:#000;font-weight:bold">|</span> RAM    <span style="color:#000;font-weight:bold">|</span> Temp <span style="color:#000;font-weight:bold">|</span> BBU    <span style="color:#000;font-weight:bold">|</span> Firmware
</span></span><span style="display:flex;"><span>c0    <span style="color:#000;font-weight:bold">|</span> SAS3508 <span style="color:#000;font-weight:bold">|</span> 2048MB <span style="color:#000;font-weight:bold">|</span> 55C  <span style="color:#000;font-weight:bold">|</span> Good   <span style="color:#000;font-weight:bold">|</span> FW: 50.6.3-0109
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-- Array information --
</span></span><span style="display:flex;"><span>-- ID <span style="color:#000;font-weight:bold">|</span> Type   <span style="color:#000;font-weight:bold">|</span>    Size <span style="color:#000;font-weight:bold">|</span>  Strpsz <span style="color:#000;font-weight:bold">|</span> Flags <span style="color:#000;font-weight:bold">|</span> DskCache <span style="color:#000;font-weight:bold">|</span>   Status <span style="color:#000;font-weight:bold">|</span>  OS Path <span style="color:#000;font-weight:bold">|</span> CacheCade <span style="color:#000;font-weight:bold">|</span>InProgress
</span></span><span style="display:flex;"><span>c0u0  <span style="color:#000;font-weight:bold">|</span> RAID-1 <span style="color:#000;font-weight:bold">|</span>   1089G <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">256</span> KB <span style="color:#000;font-weight:bold">|</span> RA,WB <span style="color:#000;font-weight:bold">|</span>  Default <span style="color:#000;font-weight:bold">|</span>  Optimal <span style="color:#000;font-weight:bold">|</span> /dev/sda <span style="color:#000;font-weight:bold">|</span> None      <span style="color:#000;font-weight:bold">|</span>None
</span></span><span style="display:flex;"><span>c0u1  <span style="color:#000;font-weight:bold">|</span> RAID-5 <span style="color:#000;font-weight:bold">|</span>   2616G <span style="color:#000;font-weight:bold">|</span>  <span style="color:#0000cf;font-weight:bold">256</span> KB <span style="color:#000;font-weight:bold">|</span> RA,WB <span style="color:#000;font-weight:bold">|</span>  Default <span style="color:#000;font-weight:bold">|</span>  Optimal <span style="color:#000;font-weight:bold">|</span> /dev/sdb <span style="color:#000;font-weight:bold">|</span> None      <span style="color:#000;font-weight:bold">|</span>None
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-- Disk information --
</span></span><span style="display:flex;"><span>-- ID   <span style="color:#000;font-weight:bold">|</span> Type <span style="color:#000;font-weight:bold">|</span> Drive Model                                 <span style="color:#000;font-weight:bold">|</span> Size     <span style="color:#000;font-weight:bold">|</span> Status          <span style="color:#000;font-weight:bold">|</span> Speed    <span style="color:#000;font-weight:bold">|</span> Temp <span style="color:#000;font-weight:bold">|</span> Slot ID  <span style="color:#000;font-weight:bold">|</span> LSI ID
</span></span><span style="display:flex;"><span>c0u0p0  <span style="color:#000;font-weight:bold">|</span> HDD  <span style="color:#000;font-weight:bold">|</span> TOSHIBA AL15SEB120N 080710R0A0LJFDWG        <span style="color:#000;font-weight:bold">|</span> 1.089 TB <span style="color:#000;font-weight:bold">|</span> Online, Spun Up <span style="color:#000;font-weight:bold">|</span> 12.0Gb/s <span style="color:#000;font-weight:bold">|</span> 27C  <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">[</span>134:4<span style="color:#ce5c00;font-weight:bold">]</span>  <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>c0u0p1  <span style="color:#000;font-weight:bold">|</span> HDD  <span style="color:#000;font-weight:bold">|</span> TOSHIBA AL15SEB120N 080710S0A10SFDWG        <span style="color:#000;font-weight:bold">|</span> 1.089 TB <span style="color:#000;font-weight:bold">|</span> Online, Spun Up <span style="color:#000;font-weight:bold">|</span> 12.0Gb/s <span style="color:#000;font-weight:bold">|</span> 28C  <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">[</span>134:5<span style="color:#ce5c00;font-weight:bold">]</span>  <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>c0u1p0  <span style="color:#000;font-weight:bold">|</span> SSD  <span style="color:#000;font-weight:bold">|</span> HUAWEI HWE52SS3960L005N3248033GSN10L5002816 <span style="color:#000;font-weight:bold">|</span> 893.1 Gb <span style="color:#000;font-weight:bold">|</span> Online, Spun Up <span style="color:#000;font-weight:bold">|</span> 12.0Gb/s <span style="color:#000;font-weight:bold">|</span> 29C  <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">[</span>134:0<span style="color:#ce5c00;font-weight:bold">]</span>  <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>c0u1p1  <span style="color:#000;font-weight:bold">|</span> SSD  <span style="color:#000;font-weight:bold">|</span> HUAWEI HWE52SS3960L005N3248033GSN10L5002799 <span style="color:#000;font-weight:bold">|</span> 893.1 Gb <span style="color:#000;font-weight:bold">|</span> Online, Spun Up <span style="color:#000;font-weight:bold">|</span> 12.0Gb/s <span style="color:#000;font-weight:bold">|</span> 30C  <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">[</span>134:1<span style="color:#ce5c00;font-weight:bold">]</span>  <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>c0u1p2  <span style="color:#000;font-weight:bold">|</span> SSD  <span style="color:#000;font-weight:bold">|</span> HUAWEI HWE52SS3960L005N3248033GSN10L5002805 <span style="color:#000;font-weight:bold">|</span> 893.1 Gb <span style="color:#000;font-weight:bold">|</span> Online, Spun Up <span style="color:#000;font-weight:bold">|</span> 12.0Gb/s <span style="color:#000;font-weight:bold">|</span> 29C  <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">[</span>134:2<span style="color:#ce5c00;font-weight:bold">]</span>  <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>c0u1p3  <span style="color:#000;font-weight:bold">|</span> SSD  <span style="color:#000;font-weight:bold">|</span> HUAWEI HWE52SS3960L005N3248033GSN10L5002797 <span style="color:#000;font-weight:bold">|</span> 893.1 Gb <span style="color:#000;font-weight:bold">|</span> Online, Spun Up <span style="color:#000;font-weight:bold">|</span> 12.0Gb/s <span style="color:#000;font-weight:bold">|</span> 29C  <span style="color:#000;font-weight:bold">|</span> <span style="color:#ce5c00;font-weight:bold">[</span>134:3<span style="color:#ce5c00;font-weight:bold">]</span>  <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span></code></pre></div><h1 id="2-解决umount-target-is-busy挂载盘卸载不掉问题">2. 解决umount target is busy挂载盘卸载不掉问题</h1>
<p><strong>问题描述:</strong></p>
<p>由于有进程占用目录，因此无法umount目录，需要先将占用进程杀死，再umount目录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ umount /data
</span></span><span style="display:flex;"><span>umount: /data: target is busy.
</span></span></code></pre></div><p>查看目录占用进程：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># fuser -mv /mnt/</span>
</span></span><span style="display:flex;"><span>                     USER        PID ACCESS COMMAND
</span></span><span style="display:flex;"><span>/mnt:                root     kernel mount /mnt
</span></span><span style="display:flex;"><span>                     root      <span style="color:#0000cf;font-weight:bold">13830</span> ..c.. bash
</span></span></code></pre></div><p>杀死目录占用进程</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># fuser -kv /mnt/</span>
</span></span><span style="display:flex;"><span>                     USER        PID ACCESS COMMAND
</span></span><span style="display:flex;"><span>/mnt:                root     kernel mount /mnt
</span></span><span style="display:flex;"><span>                     root      <span style="color:#0000cf;font-weight:bold">13830</span> ..c.. bash
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 检查目录占用进程                     </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># fuser -mv /mnt/   </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># umount /mnt</span>
</span></span></code></pre></div><p>fuser命令参数说明</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-k,--kill <span style="color:#204a87">kill</span> 　　processes accessing the named file
</span></span><span style="display:flex;"><span>-m,--mount 　　 show all processes using the named filesystems or block device
</span></span><span style="display:flex;"><span>-v,--verbose 　　 verbose output
</span></span></code></pre></div><h1 id="3-删除大文件后磁盘空间没减少">3. 删除大文件后磁盘空间没减少</h1>
<p><strong>问题描述：</strong></p>
<p>为了清理磁盘空间，在删除某些大文件后，查看df -h发现磁盘的空间并没减少。</p>
<p><strong>原因：</strong></p>
<p>有进程占用了被删除的文件，导致空间没有清理。</p>
<p><strong>解决方案:</strong></p>
<p>查看所占用文件的进程，并杀掉该进程。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># lsof 查看删除文件对应的进程</span>
</span></span><span style="display:flex;"><span>lsof <span style="color:#000;font-weight:bold">|</span> grep deleted<span style="color:#000;font-weight:bold">|</span>grep <span style="color:#4e9a06">&#34;/data/xxxx&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 杀掉进程</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">kill</span> -9 <span style="color:#ce5c00;font-weight:bold">{</span>pid<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看空间,此时空间已经腾出来</span>
</span></span><span style="display:flex;"><span>df -h 
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dcd309351d4b31616b979c4aad4cde28">2.2 - LVM的使用</h1>
    
	<blockquote>
<p>本文由网络内容整理而成的笔记</p>
</blockquote>
<h1 id="1-lvm简介">1. LVM简介</h1>
<p>LVM是逻辑盘卷管理（Logical Volume Manager）的简称，它是Linux环境下对磁盘分区进行管理的一种机制，LVM是建立在硬盘和分区之上的一个逻辑层，来提高磁盘分区管理的灵活性。</p>
<p>优点：</p>
<ul>
<li>
<p>可以灵活分配和管理磁盘空间</p>
</li>
<li>
<p>可以对分区进行动态的扩容</p>
</li>
<li>
<p>可以增加新的磁盘到lvm中</p>
</li>
</ul>
<h1 id="2-lvm核心概念">2. LVM核心概念</h1>
<p>LVM概念图：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1646318332/article/linux/lvm/lvm-concept.png" alt=""></p>
<ul>
<li><strong>PV（Physical Volume）物理卷</strong> 磁盘分区后（还未格式化为文件系统）使用 pvcreate 命令可以将硬盘分区创建为 pv，此分区的 systemID 为8e，即为 LVM 格式的系统标识符。</li>
<li><strong>VG（Volume Group）卷组</strong> 将多个 PV 组合起来，使用 vgcreate 命令创建成卷组。卷组包含了多个 PV，相当于重新整合了多个分区后得到的硬盘。虽然 VG 整合了多个 PV，但是创建 VG 时会将所有空间根据指定 PE 大小划分为多个 PE，在 LVM 模式下的存储都是以 PE 为单元，类似于文件系统的 Block。</li>
<li><strong>PE（Physical Extend）物理存储单元</strong> PE 是 VG 中的存储单元。实际存储的数据都是在 PE 存储。</li>
<li><strong>LV（Logical Volume）逻辑卷</strong> 如果说VG是整合分区为硬盘，那么 LV 就是把这个硬盘重新的分区，只不过该分区是通过 VG 来划分的。VG 中有很多 PE 单元，可以指定将多少 PE 划分给一个 LV，也可以直接指定大小来划分。划分 LV 后就相当于划分了分区，只需要对 LV 进行格式化即可变成普通的文件系统。</li>
<li><strong>LE（Logical extent）逻辑存储单元</strong> LE 则是逻辑存储单元，即 LV 中的逻辑存储单元，和 PE 的大小一样。从 VG 中划分 LV，实际上是从 VG 中划分 VG 中的 PE，只不过划分 LV 后它不在称为 PE，而是 LE。</li>
</ul>
<h1 id="3-lvm原理">3. LVM原理</h1>
<p>LVM 之所以能够伸缩容量，实现的方法就是讲 LV 里空闲的 PE 移出，或向 LV 中添加空闲的 PE。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1646318332/article/linux/lvm/lvm-arch.png" alt=""></p>
<h1 id="4-格式化为lvm盘">4. 格式化为LVM盘</h1>
<h2 id="4-1-fdisk格式化2t以下磁盘">4.1. fdisk格式化2T以下磁盘</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用fdisk进行盘的格式化</span>
</span></span><span style="display:flex;"><span>fdisk /dev/vdb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 以下是交互输出结果</span>
</span></span><span style="display:flex;"><span>Welcome to fdisk <span style="color:#ce5c00;font-weight:bold">(</span>util-linux 2.23.2<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Changes will remain in memory only, <span style="color:#204a87;font-weight:bold">until</span> you decide to write them.
</span></span><span style="display:flex;"><span>Be careful before using the write command.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Device does not contain a recognized partition table
</span></span><span style="display:flex;"><span>Building a new DOS disklabel with disk identifier 0xadfbfcb4.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Command <span style="color:#ce5c00;font-weight:bold">(</span>m <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87">help</span><span style="color:#ce5c00;font-weight:bold">)</span>: n <span style="color:#8f5902;font-style:italic"># 新建分区</span>
</span></span><span style="display:flex;"><span>Partition type:
</span></span><span style="display:flex;"><span>   p   primary <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> primary, <span style="color:#0000cf;font-weight:bold">0</span> extended, <span style="color:#0000cf;font-weight:bold">4</span> free<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   e   extended
</span></span><span style="display:flex;"><span>Select <span style="color:#ce5c00;font-weight:bold">(</span>default p<span style="color:#ce5c00;font-weight:bold">)</span>: p  <span style="color:#8f5902;font-style:italic"># 待定主分区</span>
</span></span><span style="display:flex;"><span>Partition number <span style="color:#ce5c00;font-weight:bold">(</span>1-4, default 1<span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#8f5902;font-style:italic"># 序号</span>
</span></span><span style="display:flex;"><span>First sector <span style="color:#ce5c00;font-weight:bold">(</span>2048-1048575999, default 2048<span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#8f5902;font-style:italic"># 直接回车</span>
</span></span><span style="display:flex;"><span>Using default value <span style="color:#0000cf;font-weight:bold">2048</span>
</span></span><span style="display:flex;"><span>Last sector, +sectors or +size<span style="color:#ce5c00;font-weight:bold">{</span>K,M,G<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">(</span>2048-1048575999, default 1048575999<span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#8f5902;font-style:italic"># 直接回车</span>
</span></span><span style="display:flex;"><span>Using default value <span style="color:#0000cf;font-weight:bold">1048575999</span>
</span></span><span style="display:flex;"><span>Partition <span style="color:#0000cf;font-weight:bold">1</span> of <span style="color:#204a87">type</span> Linux and of size <span style="color:#0000cf;font-weight:bold">500</span> GiB is <span style="color:#204a87">set</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Command <span style="color:#ce5c00;font-weight:bold">(</span>m <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87">help</span><span style="color:#ce5c00;font-weight:bold">)</span>: p <span style="color:#8f5902;font-style:italic"># 确认分区情况</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Disk /dev/vdb: 536.9 GB, <span style="color:#0000cf;font-weight:bold">536870912000</span> bytes, <span style="color:#0000cf;font-weight:bold">1048576000</span> sectors
</span></span><span style="display:flex;"><span><span style="color:#000">Units</span> <span style="color:#ce5c00;font-weight:bold">=</span> sectors of <span style="color:#0000cf;font-weight:bold">1</span> * <span style="color:#000">512</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">512</span> bytes
</span></span><span style="display:flex;"><span>Sector size <span style="color:#ce5c00;font-weight:bold">(</span>logical/physical<span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#0000cf;font-weight:bold">512</span> bytes / <span style="color:#0000cf;font-weight:bold">512</span> bytes
</span></span><span style="display:flex;"><span>I/O size <span style="color:#ce5c00;font-weight:bold">(</span>minimum/optimal<span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#0000cf;font-weight:bold">512</span> bytes / <span style="color:#0000cf;font-weight:bold">512</span> bytes
</span></span><span style="display:flex;"><span>Disk label type: dos
</span></span><span style="display:flex;"><span>Disk identifier: 0xadfbfcb4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   Device Boot      Start         End      Blocks   Id  System
</span></span><span style="display:flex;"><span>/dev/vdb1            <span style="color:#0000cf;font-weight:bold">2048</span>  <span style="color:#0000cf;font-weight:bold">1048575999</span>   <span style="color:#0000cf;font-weight:bold">524286976</span>   <span style="color:#0000cf;font-weight:bold">83</span>  Linux
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Command <span style="color:#ce5c00;font-weight:bold">(</span>m <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87">help</span><span style="color:#ce5c00;font-weight:bold">)</span>: t <span style="color:#8f5902;font-style:italic"># 选择系统id</span>
</span></span><span style="display:flex;"><span>Selected partition <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>Hex code <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">type</span> L to list all codes<span style="color:#ce5c00;font-weight:bold">)</span>: 8e <span style="color:#8f5902;font-style:italic"># 8e指定的是使用LVM</span>
</span></span><span style="display:flex;"><span>Changed <span style="color:#204a87">type</span> of partition <span style="color:#4e9a06">&#39;Linux&#39;</span> to <span style="color:#4e9a06">&#39;Linux LVM&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Command <span style="color:#ce5c00;font-weight:bold">(</span>m <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87">help</span><span style="color:#ce5c00;font-weight:bold">)</span>: w <span style="color:#8f5902;font-style:italic"># 保存</span>
</span></span><span style="display:flex;"><span>The partition table has been altered!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Calling ioctl<span style="color:#ce5c00;font-weight:bold">()</span> to re-read partition table.
</span></span><span style="display:flex;"><span>Syncing disks.
</span></span></code></pre></div><h2 id="4-2-parted格式化2t以上磁盘">4.2. parted格式化2T以上磁盘</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># parted /dev/sdk</span>
</span></span><span style="display:flex;"><span>GNU Parted 3.1
</span></span><span style="display:flex;"><span>使用 /dev/sdk
</span></span><span style="display:flex;"><span>Welcome to GNU Parted! Type <span style="color:#4e9a06">&#39;help&#39;</span> to view a list of commands.
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>parted<span style="color:#ce5c00;font-weight:bold">)</span> mktable
</span></span><span style="display:flex;"><span>新的磁盘标签类型？ gpt
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>parted<span style="color:#ce5c00;font-weight:bold">)</span> p
</span></span><span style="display:flex;"><span>Model: ATA ST4000NM0035-1V4 <span style="color:#ce5c00;font-weight:bold">(</span>scsi<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Disk /dev/sdk: 4001GB
</span></span><span style="display:flex;"><span>Sector size <span style="color:#ce5c00;font-weight:bold">(</span>logical/physical<span style="color:#ce5c00;font-weight:bold">)</span>: 512B/512B
</span></span><span style="display:flex;"><span>Partition Table: gpt
</span></span><span style="display:flex;"><span>Disk Flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Number  Start  End  Size  File system  Name  标志
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>parted<span style="color:#ce5c00;font-weight:bold">)</span> mkpart
</span></span><span style="display:flex;"><span>分区名称？  <span style="color:#ce5c00;font-weight:bold">[]</span>?
</span></span><span style="display:flex;"><span>文件系统类型？  <span style="color:#ce5c00;font-weight:bold">[</span>ext2<span style="color:#ce5c00;font-weight:bold">]</span>?
</span></span><span style="display:flex;"><span>起始点？ 0g
</span></span><span style="display:flex;"><span>结束点？ 4000G
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>parted<span style="color:#ce5c00;font-weight:bold">)</span> p
</span></span><span style="display:flex;"><span>Model: ATA ST4000NM0035-1V4 <span style="color:#ce5c00;font-weight:bold">(</span>scsi<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Disk /dev/sdk: 4001GB
</span></span><span style="display:flex;"><span>Sector size <span style="color:#ce5c00;font-weight:bold">(</span>logical/physical<span style="color:#ce5c00;font-weight:bold">)</span>: 512B/512B
</span></span><span style="display:flex;"><span>Partition Table: gpt
</span></span><span style="display:flex;"><span>Disk Flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Number  Start   End     Size    File system  Name  标志
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">1</span>      1049kB  4000GB  4000GB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>parted<span style="color:#ce5c00;font-weight:bold">)</span> toggle <span style="color:#0000cf;font-weight:bold">1</span> lvm
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>parted<span style="color:#ce5c00;font-weight:bold">)</span> p
</span></span><span style="display:flex;"><span>Model: ATA ST4000NM0035-1V4 <span style="color:#ce5c00;font-weight:bold">(</span>scsi<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Disk /dev/sdk: 4001GB
</span></span><span style="display:flex;"><span>Sector size <span style="color:#ce5c00;font-weight:bold">(</span>logical/physical<span style="color:#ce5c00;font-weight:bold">)</span>: 512B/512B
</span></span><span style="display:flex;"><span>Partition Table: gpt
</span></span><span style="display:flex;"><span>Disk Flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Number  Start   End     Size    File system  Name  标志
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">1</span>      1049kB  4000GB  4000GB                     lvm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>parted<span style="color:#ce5c00;font-weight:bold">)</span> quit
</span></span><span style="display:flex;"><span>信息: You may need to update /etc/fstab.
</span></span></code></pre></div><h1 id="5-lvm操作">5. LVM操作</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pvcreate如果提示命令不存在，则需要安装lvm2</span>
</span></span><span style="display:flex;"><span>yum install lvm2 -y
</span></span></code></pre></div><h2 id="5-1-创建物理卷-pv">5.1. 创建物理卷（PV）</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pvcreate /dev/nvme1n1p1 /dev/nvme2n1p1</span>
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#4e9a06">&#34;/dev/nvme1n1p1&#34;</span> successfully created.
</span></span><span style="display:flex;"><span>  Physical volume <span style="color:#4e9a06">&#34;/dev/nvme2n1p1&#34;</span> successfully created.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用pvs或者 pvdisplay 查看结果</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pvs</span>
</span></span><span style="display:flex;"><span>  PV             VG Fmt  Attr PSize   PFree
</span></span><span style="display:flex;"><span>  /dev/nvme1n1p1    lvm2 ---  931.51g 931.51g
</span></span><span style="display:flex;"><span>  /dev/nvme2n1p1    lvm2 ---  931.51g 931.51g
</span></span></code></pre></div><h2 id="5-2-创建卷组-vg">5.2. 创建卷组（VG）</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># vgcreate vgdata /dev/nvme1n1p1 /dev/nvme2n1p1</span>
</span></span><span style="display:flex;"><span>  Volume group <span style="color:#4e9a06">&#34;vgdata&#34;</span> successfully created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用vgs 查看vg, vgdisplay的信息</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># lsblk查看</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># lsblk</span>
</span></span><span style="display:flex;"><span>NAME                                          MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
</span></span><span style="display:flex;"><span>nvme0n1                                       259:0    <span style="color:#0000cf;font-weight:bold">0</span> 931.5G  <span style="color:#0000cf;font-weight:bold">0</span> disk  /pcdn_data/storage1_ssd
</span></span><span style="display:flex;"><span>nvme2n1                                       259:2    <span style="color:#0000cf;font-weight:bold">0</span> 931.5G  <span style="color:#0000cf;font-weight:bold">0</span> disk
</span></span><span style="display:flex;"><span>└─nvme2n1p1                                   259:5    <span style="color:#0000cf;font-weight:bold">0</span> 931.5G  <span style="color:#0000cf;font-weight:bold">0</span> part
</span></span><span style="display:flex;"><span>  └─vgdata-data                               251:2    <span style="color:#0000cf;font-weight:bold">0</span>   1.8T  <span style="color:#0000cf;font-weight:bold">0</span> lvm   /vgdata
</span></span><span style="display:flex;"><span>nvme1n1                                       259:1    <span style="color:#0000cf;font-weight:bold">0</span> 931.5G  <span style="color:#0000cf;font-weight:bold">0</span> disk
</span></span><span style="display:flex;"><span>└─nvme1n1p1                                   259:4    <span style="color:#0000cf;font-weight:bold">0</span> 931.5G  <span style="color:#0000cf;font-weight:bold">0</span> part
</span></span><span style="display:flex;"><span>  └─vgdata-data                               251:2    <span style="color:#0000cf;font-weight:bold">0</span>   1.8T  <span style="color:#0000cf;font-weight:bold">0</span> lvm   /vgdata
</span></span></code></pre></div><h2 id="5-3-创建逻辑卷-lv">5.3. 创建逻辑卷（LV）</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># lvcreate -L 后面是大小， -n 后面是逻辑卷名称， vgdata对应上面的卷组</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># lvcreate -L 1.8T -n data vgdata</span>
</span></span><span style="display:flex;"><span>  Rounding up size to full physical extent 1.80 TiB
</span></span><span style="display:flex;"><span>  Logical volume <span style="color:#4e9a06">&#34;data&#34;</span> created.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用lvdisplay 查看结果</span>
</span></span></code></pre></div><h2 id="5-4-格式化文件系统及挂载">5.4. 格式化文件系统及挂载</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看磁盘信息</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># fdisk -l</span>
</span></span><span style="display:flex;"><span>磁盘 /dev/mapper/vgdata-data：1979.1 GB, <span style="color:#0000cf;font-weight:bold">1979124285440</span> 字节，3865477120 个扇区
</span></span><span style="display:flex;"><span><span style="color:#000">Units</span> <span style="color:#ce5c00;font-weight:bold">=</span> 扇区 of <span style="color:#0000cf;font-weight:bold">1</span> * <span style="color:#000">512</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">512</span> bytes
</span></span><span style="display:flex;"><span>扇区大小<span style="color:#ce5c00;font-weight:bold">(</span>逻辑/物理<span style="color:#ce5c00;font-weight:bold">)</span>：512 字节 / <span style="color:#0000cf;font-weight:bold">512</span> 字节
</span></span><span style="display:flex;"><span>I/O 大小<span style="color:#ce5c00;font-weight:bold">(</span>最小/最佳<span style="color:#ce5c00;font-weight:bold">)</span>：512 字节 / <span style="color:#0000cf;font-weight:bold">512</span> 字节
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 格式化成xfs, /dev/vgdata/data为上面 LV Path</span>
</span></span><span style="display:flex;"><span>mkfs.xfs /dev/vgdata/data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># mount</span>
</span></span><span style="display:flex;"><span>mkdir -p /data
</span></span><span style="display:flex;"><span>mount /dev/vgdata/data /data
</span></span></code></pre></div><h2 id="5-5-lvm扩容">5.5. LVM扩容</h2>
<p>LVM最大的优势就是其可伸缩性，伸缩性有更加偏重与扩容。扩容的实质是将 VG 中的空闲 PE 添加到 LV 中，所以只要 VG 中有空闲的 PE，就可以进行扩容。即使没有空闲 PE，也可以添加PV，将PV加入到VG中增加空闲PE。</p>
<p>扩容的两个关键步骤：</p>
<p>（1）使用 lvextend 或 lvresize 添加更多的 PE 或容量到 LV</p>
<p>（2）使用 resize2fs命令（xfs 使用 xfs_growfs）将 LV 增加后的容量添加到对应的文件系统中(此过程是修改文件系统而非LVM内容)</p>
<h1 id="6-lvm相关命令">6. LVM相关命令</h1>
<h2 id="6-1-管理-pv">6.1. 管理 PV</h2>
<table>
<thead>
<tr>
<th><strong>功能</strong></th>
<th><strong>命令</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>创建 PV</td>
<td>pvcreate</td>
</tr>
<tr>
<td>扫描并列出所有 PV</td>
<td>pvscan</td>
</tr>
<tr>
<td>列出 PV 属性</td>
<td>pvdisplay {name|size}</td>
</tr>
<tr>
<td>移除 PV</td>
<td>pvremove</td>
</tr>
<tr>
<td>移动 PV 中的数据</td>
<td>pvmove</td>
</tr>
</tbody>
</table>
<h2 id="6-2-管理-vg">6.2. 管理 VG</h2>
<table>
<thead>
<tr>
<th><strong>功能</strong></th>
<th><strong>命令</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>创建 VG</td>
<td>vgcreate</td>
</tr>
<tr>
<td>扫描并列出所有 VG</td>
<td>vgscan</td>
</tr>
<tr>
<td>列出 VG 属性信息</td>
<td>vgdisplay</td>
</tr>
<tr>
<td>移除（删除）VG</td>
<td>vgremove</td>
</tr>
<tr>
<td>从 VG 中移除 PV</td>
<td>vgreduce</td>
</tr>
<tr>
<td>将 PV 添加到 VG 中</td>
<td>vgextend</td>
</tr>
<tr>
<td>修改 VG 属性</td>
<td>vgchange</td>
</tr>
</tbody>
</table>
<h2 id="6-3-管理-lv">6.3. 管理 LV</h2>
<table>
<thead>
<tr>
<th><strong>功能</strong></th>
<th><strong>命令</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>创建 LV</td>
<td>lvcreate</td>
</tr>
<tr>
<td>扫描并列出所有 LV</td>
<td>lvscan</td>
</tr>
<tr>
<td>列出 LV 属性信息</td>
<td>lvdisplay</td>
</tr>
<tr>
<td>移除 LV</td>
<td>lvremove</td>
</tr>
<tr>
<td>缩小 LV 容量</td>
<td>lvreduce/lvresize</td>
</tr>
<tr>
<td>增大 LV 容量</td>
<td>lvextend/lvresize</td>
</tr>
<tr>
<td>调整 LV 容量</td>
<td>lvresize</td>
</tr>
</tbody>
</table>
<p><code>lvcreate</code>命令</p>
<p>一般用法：lvcreate [-L size(M/G) | -l PEnum] -n lv_name vg_name</p>
<p>选项：</p>
<p>-L：根据大小创建 LV，即分配多少空间给此 LV</p>
<p>-l：根据 PE 的数量来创建 LV，即分配多少个 PE 给此 LV</p>
<p>-n：指定 LV 名称</p>
<p>参考：</p>
<ul>
<li>
<p><a href="https://izsk.me/2020/09/15/System-use-lvm-manager-disks/">Linux下使用lvm将多块盘合并 | Z.S.K.'s Records</a></p>
</li>
<li>
<p><a href="https://cloud.tencent.com/developer/article/1382501">100个Linux命令(5)-LVM - 云+社区 - 腾讯云</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/document_detail/178476.html">LVM数据卷 - 容器服务 ACK - 阿里云</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d4bbbd15228232e898b358dae27e6a1c">2.3 - Raid介绍</h1>
    
	<h1 id="1-raid是什么">1. Raid是什么</h1>
<p>RAID英文全称Redundant Array of Independent Disk，翻译过来就是“独立磁盘冗余系统”。RAID是一种可提高性能或提供容错功能的磁盘子系统。</p>
<p>RAID的基本思想是将多个容量较小、速度较慢、可靠性较差的廉价磁盘，组合成一个磁盘组，从而以较低的成本获得与昂贵的大容量、高速磁盘相似的性能。</p>
<p>优势：</p>
<ul>
<li>
<p>高性能</p>
</li>
<li>
<p>可靠性可用性</p>
</li>
<li>
<p>大容量</p>
</li>
<li>
<p>可管理性</p>
</li>
</ul>
<h1 id="2-raid的基本原理">2. Raid的基本原理</h1>
<p>架构上，通过RAID控制器就将多块磁盘组合，在操作系统层我们看到的是一个或多个逻辑磁盘。</p>
<p>技术上，RAID主要采用<strong>磁盘镜像技术</strong>、<strong>条带化技术</strong>和<strong>奇偶校验技术</strong>实现高性能、可靠性、容错能力和扩展性。</p>
<ul>
<li>
<p><strong>磁盘镜像技术</strong>：将数据复制到多个磁盘，一方面可以提高可靠性，另一方面可以提高读性能。因为需要写入多个磁盘会导致写性能降低。</p>
</li>
<li>
<p><strong>数据条带技术</strong>：将数据分片保存到多个不同的磁盘，多个数据分片共同组成完整的数据。主要用于提示磁盘IO性能，当访问数据时可以同时对多个磁盘进行读取。</p>
</li>
<li>
<p><strong>数据校验技术</strong>：利益冗余数据对数据进行校验和修复。冗余数据通常采用海明码、异或操作等算法来计算获得。可以提高磁盘阵列的可靠性和容错能力。不过，数据校验需要从多处读取数据并进行计算和对比，会影响系统性能。</p>
</li>
</ul>
<h1 id="3-raid的级别">3. Raid的级别</h1>
<p>RAID级别命名方式如，RAID 0、RAID 1/RAID 5、RAID 10等。RAID每一个级别代表一种RAID组合实现方法和技术，级别之间并无高低之分。不同等级的 RAID 采用其中一个或多个技术，得到的是不同的容量、I/O性能、可靠性、可用性。在决定选择哪种RAID级别之前，需要深入理解系统需求，根据自身情况进行合理选择，综合评估可靠性、性能和成本来进行折中的选择。</p>
<table>
<thead>
<tr>
<th>Raid等级</th>
<th>Raid0</th>
<th>Raid1</th>
<th>Raid3</th>
<th>Raid5</th>
<th>Raid6</th>
<th>Raid10</th>
</tr>
</thead>
<tbody>
<tr>
<td>别名</td>
<td>条带</td>
<td>镜像</td>
<td>专用奇偶校验条带</td>
<td>分布奇偶校验条带</td>
<td>双重奇偶校验条带</td>
<td>镜像+条带</td>
</tr>
<tr>
<td>容错性</td>
<td>无</td>
<td>有</td>
<td>有</td>
<td>有</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td>冗余类型</td>
<td>无</td>
<td>有</td>
<td>有</td>
<td>有</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td>热备份选择</td>
<td>无</td>
<td>有</td>
<td>有</td>
<td>有</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td>读性能</td>
<td>高</td>
<td>低</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td>高</td>
</tr>
<tr>
<td>随机写性能</td>
<td>高</td>
<td>低</td>
<td>低</td>
<td>一般</td>
<td>低</td>
<td>一般</td>
</tr>
<tr>
<td>连续写性能</td>
<td>高</td>
<td>低</td>
<td>低</td>
<td>低</td>
<td>低</td>
<td>一般</td>
</tr>
<tr>
<td>需要磁盘数</td>
<td>n&gt;=1</td>
<td>2n(n&gt;=1)</td>
<td>n&gt;=3</td>
<td>n&gt;=3</td>
<td>n&gt;=4</td>
<td>2n&gt;=4</td>
</tr>
<tr>
<td>可用容量</td>
<td>全部</td>
<td>50%</td>
<td>（n-1）/n</td>
<td>（n-1）/n</td>
<td>（n-2）/n</td>
<td>50%</td>
</tr>
</tbody>
</table>
<h1 id="4-raid级别介绍">4. Raid级别介绍</h1>
<h2 id="4-1-raid0-使用较多">4.1. Raid0（使用较多）</h2>
<p>Raid0是将多块物理磁盘组合成一个大的逻辑磁盘，在读写的时候会以独立的方式对N块磁盘进行读写，因此执行效率非常高。理论上读写的性能是单块磁盘的N倍。但是单块磁盘的损坏会导致数据丢失，无法恢复。因此适用于对可靠性不高，读写性能要求高的场景中。</p>
<ul>
<li>
<p><strong>特点</strong>：RAID 0通过条带化技术，将数据分散到多个磁盘上，从而提高存储性能。它不提供数据冗余，因此没有容错能力。</p>
</li>
<li>
<p><strong>适用场景</strong>：适用于对性能要求极高，但对数据安全性要求不高的场景，如视频编辑、高性能计算等。</p>
</li>
</ul>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1712049568/article/linux/disk/raid0.png" alt=""></p>
<h2 id="4-2-raid1-镜像">4.2. Raid1（镜像）</h2>
<p>Raid1 是磁盘阵列中单位成本最高的一种方式。因为它的原理是在往磁盘写数据的时候，将同一份数据无差别的写两份到磁盘，分别写到工作磁盘和镜像磁盘，那么它的实际空间使用率只有50%了，两块磁盘当做一块用，这是一种比较昂贵的方案。可靠性高，但是性能低。</p>
<ul>
<li>
<p><strong>特点</strong>：RAID 1通过镜像技术，将数据同时写入两个或多个相同的磁盘.中，提供数据冗余和容错能力。如果一个磁盘发生故障，另一个磁盘上的数据仍然可用。</p>
</li>
<li>
<p><strong>适用场景</strong>：适用于对数据安全性要求较高的场景，如金融机构、医疗机构等。</p>
</li>
</ul>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1712049569/article/linux/disk/raid1.png" alt=""></p>
<h2 id="4-3-raid5-使用最多">4.3. Raid5（使用最多）</h2>
<p>Raid5是兼具Raid0和Raid1的优点，在性能和可靠性上兼具的一种方式，也是使用最多的一种方案。</p>
<p>Raid5方案是总共有N块磁盘，会将要写入的数据分成N份，并发的写入到N块磁盘中，同时还将数据的校验码信息也写入到这N块磁盘中（数据与对应的校验码信息必须得分开存储在不同的磁盘上）。一旦某一块磁盘损坏了，就可以用剩下的数据和对应的奇偶校验码信息去恢复损坏的数据。</p>
<p>RAID5的方式，最少需要三块磁盘来组建磁盘阵列，允许最多同时坏一块磁盘。如果有两块磁盘同时损坏了，那数据就无法恢复了。</p>
<ul>
<li>
<p><strong>特点</strong>：RAID 5结合了条带化和数据冗余技术。它将数据分割成块并分布在多个磁盘上，同时使用一个或多个磁盘存储冗余信息(校验块)。如果一个磁盘发生故障，系统可以使用冗余信息来重建故障磁盘上的数据。</p>
</li>
<li>
<p><strong>适用场景</strong>：适用于对数据安全性和性能都有一定要求的场景，如企业数据库、文件服务器等。</p>
</li>
</ul>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1712049569/article/linux/disk/raid5.png" alt=""></p>
<h2 id="4-4-raid6">4.4. Raid6</h2>
<p>RAID6在RAID5的基础上再次改进，引入了双重校验的概念。RAID6除了每块磁盘上都有同级数据XOR校验区以外，还有针对每个数据块的XOR校验区，这样的话，相当于每个数据块有两个校验保护措施，因此数据的冗余性更高了。但是RAID6的这种设计也带来了很高的复杂度，虽然数据冗余性好，读取的效率也比较高，但是写数据的性能就很差。因此RAID6在实际环境中应用的比较少。</p>
<ul>
<li>
<p><strong>特点</strong>：RAID 6与RAID 5类似，但使用了两个冗余信息来提供更高的容错能力。这意味着即使两个磁盘同时发生故障，系统仍然可以使用冗余信息来重建数据。</p>
</li>
<li>
<p><strong>适用场景</strong>：适用于对数据安全性要求非常高的场景，如大型数据库、关键业务系统等。</p>
</li>
</ul>
<h2 id="4-5-raid10">4.5. Raid10</h2>
<p>RAID10其实就是RAID1与RAID0的一个合体。RAID10兼备了RAID1和RAID0的有优点。</p>
<p>首先基于RAID1模式将磁盘分为2份，当要写入数据的时候，将所有的数据在两份磁盘上同时写入，相当于写了双份数据，起到了数据保障的作用。且在每一份磁盘上又会基于RAID0技术讲数据分为N份并发的读写，这样也保障了数据的效率。RAID10模式是有一半的磁盘空间用于存储冗余数据的，浪费的很严重，因此用的也不是很多。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1712049569/article/linux/disk/raid10.png" alt=""></p>
<h1 id="5-硬raid和软raid区别">5. 硬Raid和软Raid区别</h1>
<p>硬raid主要是通过厂商的硬件raid卡控制器来实现，而软raid主要是操作系统的raid命令来实现（例如 mdadm 命令）。</p>
<p>以下是2者的区别：</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>硬raid</th>
<th>软raid</th>
</tr>
</thead>
<tbody>
<tr>
<td>实现方式</td>
<td>硬件 RAID 使用专用的 RAID 控制器卡，这是一块独立的硬件，通常插入到服务器或工作站的 PCIe 插槽中。该控制器处理所有 RAID 计算和磁盘管理任务，减轻了主机 CPU 的负担。</td>
<td>软件 RAID 通过操作系统提供的 RAID 功能来实现（如 Linux 的 mdadm 或 Windows 的 Storage Spaces）。RAID 操作由主机的 CPU 处理。</td>
</tr>
<tr>
<td>性能</td>
<td>硬件 RAID 控制器有专用的处理器和缓存，用于处理 RAID 操作，因此通常提供更高的性能，特别是在高负载或复杂 RAID 配置（如 RAID 5 或 RAID 6）下。</td>
<td>由于 RAID 操作由主机 CPU 处理，软件 RAID 在高负载或复杂 RAID 配置下的性能可能不如硬件 RAID。</td>
</tr>
<tr>
<td>系统依赖性</td>
<td>RAID 配置存储在控制器上，因此更换主机系统或操作系统不会影响 RAID 阵列的数据完整性。</td>
<td>RAID 配置依赖于操作系统，因此更换操作系统或重新安装系统可能需要重新配置 RAID 阵列。</td>
</tr>
<tr>
<td>成本</td>
<td>硬件 RAID 控制器通常价格较高，增加了系统的总体成本。</td>
<td>不需要额外的硬件，降低了成本。对于预算有限的小型企业或个人用户来说，这是一个经济的选择。</td>
</tr>
<tr>
<td>数据安全与可靠性</td>
<td>硬件 RAID 提供更高的可靠性和数据保护功能，如热备用盘和电池备份缓存。</td>
<td>软件 RAID 在数据安全和可靠性上依赖于操作系统的实现和配置。</td>
</tr>
<tr>
<td>灵活性</td>
<td>依赖不同厂商不同的raid卡命令，配置比较复杂</td>
<td>软件 RAID 配置和管理更灵活，可以通过操作系统的命令行工具或图形界面轻松实现。</td>
</tr>
<tr>
<td>高级功能</td>
<td>硬件 RAID 控制器通常提供高级功能，如热插拔、在线扩展、热备用盘、硬件级别的加密和电池备份缓存。</td>
<td>软件 RAID 通常缺乏一些高级功能，如硬件 RAID 提供的电池备份缓存和专用处理器。</td>
</tr>
</tbody>
</table>
<h1 id="6-如何配置硬raid">6. 如何配置硬Raid</h1>
<p>配置硬件raid可以通过raid配置界面操作，也可以通过厂商提供的cli工具配置硬Raid。具体可参考<a href="make-hardware-raid.md">创建硬件Raid</a></p>
<p>参考：</p>
<ul>
<li><a href="https://www.chinastor.com/baike/raid/">https://www.chinastor.com/baike/raid/</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/51170719">https://zhuanlan.zhihu.com/p/51170719</a></li>
<li><a href="https://mp.weixin.qq.com/s/xWD5p7pmzdl_YpMXY5YO4g">https://mp.weixin.qq.com/s/xWD5p7pmzdl_YpMXY5YO4g</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-896ec2a9f485dc3588d18d5b785ff93a">2.4 - 创建硬件Raid</h1>
    
	<p>本文主要描述如何针对物理机做硬件的raid配置，硬件raid不依赖于操作系统，具有更高的性能，经常在装机系统中使用到。</p>
<h1 id="1-查询raid控制器信息">1. 查询raid控制器信息</h1>
<p>可以通过<code>lspci -mm</code>命令的输出查找raid控制器信息。实际情况可以执行以下命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lspci -mm <span style="color:#000;font-weight:bold">|</span>egrep <span style="color:#4e9a06">&#34;Broadcom / LSI|Adaptec&#34;</span>
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># lspci -mm |egrep &#34;Broadcom / LSI|Adaptec&#34;</span>
</span></span><span style="display:flex;"><span>3b:00.0 <span style="color:#4e9a06">&#34;RAID bus controller&#34;</span> <span style="color:#4e9a06">&#34;Broadcom / LSI&#34;</span> <span style="color:#4e9a06">&#34;MegaRAID SAS-3 3108 [Invader]&#34;</span> -r02 -p00 <span style="color:#4e9a06">&#34;Dell&#34;</span> <span style="color:#4e9a06">&#34;PERC H730P Mini&#34;</span>
</span></span></code></pre></div><p><code>lspci -mm</code> 输出中的每一列含义如下：</p>
<ol>
<li><strong><code>PCI 地址</code></strong>：设备的总线号、设备号和功能号，用于唯一标识设备位置。例如：3b:00.0</li>
<li><strong><code>设备类型</code></strong>：设备的功能类别，例如 RAID 控制器、网络控制器等。例如： &quot;RAID bus controller&quot; ,&quot;Serial Attached SCSI controller&quot;</li>
<li><strong><code>制造商</code></strong>：设备的制造商名称。例如：&quot;Broadcom / LSI&quot;, &quot;Adaptec&quot;，最关键的信息，决定raid命令。</li>
<li><strong><code>设备型号</code></strong>：设备的具体产品型号和名称。例如：&quot;MegaRAID SAS-3 3108 [Invader]&quot;,&quot;Smart Storage PQI SAS&quot;</li>
<li><strong><code>子系统制造商</code></strong>：子系统的生产厂商（可能为空）。例如：&quot;Dell&quot;,&quot;Huawei&quot;,&quot;Lenovo&quot;</li>
<li><strong><code>子系统设备名称</code></strong>：子系统的设备名称（可能为空）。例如：&quot;PERC H730P Mini&quot;</li>
</ol>
<p>以下是常见的几个物理机厂商的设备的raid信息:</p>
<p>通过执行<code>lspci -mm |egrep &quot;Broadcom / LSI|Adaptec&quot;</code>命令可以查看不同厂商设备的raid信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># DELL</span>
</span></span><span style="display:flex;"><span>18:00.0 <span style="color:#4e9a06">&#34;RAID bus controller&#34;</span> <span style="color:#4e9a06">&#34;Broadcom / LSI&#34;</span> <span style="color:#4e9a06">&#34;MegaRAID SAS-3 3108 [Invader]&#34;</span> -r02 -p00 <span style="color:#4e9a06">&#34;Dell&#34;</span> <span style="color:#4e9a06">&#34;PERC H730P Adapter&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># HUAWEI</span>
</span></span><span style="display:flex;"><span>1c:00.0 <span style="color:#4e9a06">&#34;RAID bus controller&#34;</span> <span style="color:#4e9a06">&#34;Broadcom / LSI&#34;</span> <span style="color:#4e9a06">&#34;MegaRAID Tri-Mode SAS3508&#34;</span> -r01 -p00 <span style="color:#4e9a06">&#34;Huawei Technologies Co., Ltd.&#34;</span> <span style="color:#4e9a06">&#34;MegaRAID Tri-Mode SAS3508&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># XFUSION</span>
</span></span><span style="display:flex;"><span>2a:00.0 <span style="color:#4e9a06">&#34;RAID bus controller&#34;</span> <span style="color:#4e9a06">&#34;Broadcom / LSI&#34;</span> <span style="color:#4e9a06">&#34;MegaRAID 12GSAS/PCIe Secure SAS39xx&#34;</span> <span style="color:#4e9a06">&#34;Broadcom / LSI&#34;</span> <span style="color:#4e9a06">&#34;MegaRAID 12GSAS/PCIe Secure SAS39xx&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># INSPUR</span>
</span></span><span style="display:flex;"><span>18:00.0 <span style="color:#4e9a06">&#34;RAID bus controller&#34;</span> <span style="color:#4e9a06">&#34;Broadcom / LSI&#34;</span> <span style="color:#4e9a06">&#34;MegaRAID Tri-Mode SAS3516&#34;</span> -r01 <span style="color:#4e9a06">&#34;Broadcom / LSI&#34;</span> <span style="color:#4e9a06">&#34;MegaRAID Tri-Mode SAS3516&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># LENOVO</span>
</span></span><span style="display:flex;"><span>4b:00.0 <span style="color:#4e9a06">&#34;RAID bus controller&#34;</span> <span style="color:#4e9a06">&#34;Broadcom / LSI&#34;</span> <span style="color:#4e9a06">&#34;MegaRAID Tri-Mode SAS3516&#34;</span> -r01 <span style="color:#4e9a06">&#34;Lenovo&#34;</span> <span style="color:#4e9a06">&#34;ThinkSystem RAID 930-16i 4GB Flash PCIe 12Gb Adapter&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># HPE</span>
</span></span><span style="display:flex;"><span>5c:00.0 <span style="color:#4e9a06">&#34;Serial Attached SCSI controller&#34;</span> <span style="color:#4e9a06">&#34;Adaptec&#34;</span> <span style="color:#4e9a06">&#34;Smart Storage PQI SAS&#34;</span> -r01 -p00 <span style="color:#4e9a06">&#34;Hewlett-Packard Company&#34;</span> <span style="color:#4e9a06">&#34;Smart Array P408i-a SR Gen10&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># KAYTUS</span>
</span></span><span style="display:flex;"><span>31:00.0 <span style="color:#4e9a06">&#34;Serial Attached SCSI controller&#34;</span> <span style="color:#4e9a06">&#34;Adaptec&#34;</span> <span style="color:#4e9a06">&#34;Smart Storage PQI 12G SAS/PCIe 3&#34;</span> -r01 <span style="color:#4e9a06">&#34;Inspur Electronic Information Industry Co., Ltd.&#34;</span> <span style="color:#4e9a06">&#34;PM8222-SHBA&#34;</span>
</span></span></code></pre></div><p>常见的raid制造商：</p>
<ul>
<li><strong>Broadcom / LSI</strong>：LSI 是知名的存储控制器制造商，现已被 Broadcom 收购。MegaRAID 系列是其广泛使用的 RAID 控制器。</li>
<li><strong>Adaptec</strong>:   Adaptec 提供一系列 RAID 控制器，主要用于高性能存储解决方案。</li>
</ul>
<h1 id="2-常见的-raid-厂商及其命令行工具">2. 常见的 RAID 厂商及其命令行工具</h1>
<table>
<thead>
<tr>
<th>设备类型</th>
<th>raid控制器制造商</th>
<th>设备型号</th>
<th>Raid命令</th>
<th>使用该raid的服务器厂商</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>RAID bus controller</td>
<td>Broadcom / LSI（MegaRAID 系列）</td>
<td>MegaRAID Tri-Mode SAS3508</td>
<td>storcli</td>
<td>DELL，HUAWEI，XFUSION，INSPUR，LENOVO</td>
<td></td>
</tr>
<tr>
<td>Serial Attached SCSI controller</td>
<td>Adaptec</td>
<td>Smart Storage PQI</td>
<td>ssacli</td>
<td>HPE，KAYTUS</td>
<td></td>
</tr>
<tr>
<td>Non-Volatile memory controller</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>SATA controller</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="3-使用storcli命令创建raid">3. 使用storcli命令创建raid</h1>
<h2 id="3-1-安装storcli">3.1. 安装storcli</h2>
<p>登录https://www.broadcom.com/products/storage/raid-controllers/megaraid-9560-8i下载最新的storcli的解压包，解压后可以执行<code>rpm -ivh /tmp/StorCLIxxx.aarch64.rpm</code>命令安装。</p>
<p>参数说明</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/cx <span style="color:#ce5c00;font-weight:bold">=</span> Controller ID
</span></span><span style="display:flex;"><span>/vx <span style="color:#ce5c00;font-weight:bold">=</span> Virtual Drive Number.
</span></span><span style="display:flex;"><span>/ex <span style="color:#ce5c00;font-weight:bold">=</span> Enclosure ID
</span></span><span style="display:flex;"><span>/sx <span style="color:#ce5c00;font-weight:bold">=</span> Slot ID
</span></span></code></pre></div><h2 id="3-2-创建raid">3.2. 创建raid</h2>
<p>在创建之前需要查看当前有几个controller，有几块物理磁盘以及物理磁盘的<code>EID:Slt</code>信息，用于选定哪几快物理磁盘来做指定级别的raid。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 由第3、4、5块物理磁盘来构建RAID5，分配所有空间的逻辑磁盘命名tmp1。</span>
</span></span><span style="display:flex;"><span>storcli /c0 add vd <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span>raid5 <span style="color:#000">size</span><span style="color:#ce5c00;font-weight:bold">=</span>all <span style="color:#000">names</span><span style="color:#ce5c00;font-weight:bold">=</span>tmp1 <span style="color:#000">drives</span><span style="color:#ce5c00;font-weight:bold">=</span>32:2-4 WB                           
</span></span></code></pre></div><p>参数说明：</p>
<ul>
<li>
<p><strong><code>storcli</code></strong> 是 Broadcom / LSI 的命令行工具，用于管理 MegaRAID 控制器。</p>
</li>
<li>
<p><strong><code>/c0</code></strong> 表示第一个 RAID 控制器（控制器 0）。如果有多个 RAID 控制器，可以用 <code>/c1</code>、<code>/c2</code> 等来指定其他控制器。</p>
</li>
<li>
<p><strong><code>add vd</code></strong> 表示添加一个虚拟驱动器（Virtual Drive，简称 VD）。VD 是 RAID 阵列的逻辑表示，用户通过它来访问 RAID 上的数据。</p>
</li>
<li>
<p><strong><code>type=raid5</code></strong> 表示要创建的 RAID 类型是 RAID 5。RAID 5 使用分布式奇偶校验，提供了较好的读取性能和数据冗余，至少需要 3 个物理磁盘。</p>
</li>
<li>
<p><strong><code>size=all</code></strong> 表示使用所有可用的磁盘空间来创建这个虚拟驱动器。可以指定特定大小，但此处使用 <code>all</code> 表示使用磁盘的全部空间。</p>
</li>
<li>
<p><strong><code>names=tmp1</code></strong> 为虚拟驱动器命名为 <code>tmp1</code>。这有助于在系统中区分不同的虚拟驱动器。名称是用户定义的，便于识别。</p>
</li>
<li>
<p><strong><code>drives=32:2-4</code></strong> 或**<code>drives=32:2,3,4</code>**</p>
<p>指定用于创建 RAID 的物理磁盘。</p>
<ul>
<li><code>32</code> 是扩展器（enclosure）的编号即<code>EID</code>。如果磁盘是直接连接到控制器，通常编号为 <code>0</code>，如果是通过扩展器连接，扩展器的编号为 <code>32</code>。</li>
<li><code>2-4</code> 指定物理磁盘编号即<code>Slt</code>，表示使用该扩展器上的 2、3、4 号磁盘。此处的 RAID 5 至少需要 3 个磁盘。</li>
</ul>
</li>
<li>
<p><strong><code>WB</code></strong>: 表示启用 Write Back 缓存。Write Back 意味着在写操作时，数据首先写入缓存，然后返回成功响应，实际数据写入磁盘可能稍后进行。</p>
<ul>
<li>Write Back 缓存可以提高写入性能，但需要有备用电源（如电池或超级电容）来保证缓存数据在断电时不会丢失。</li>
<li>另一种模式是 <strong>Write Through (WT)</strong>，数据直接写入磁盘，只有数据成功写入磁盘时才返回成功响应，相对更安全但性能较低。</li>
</ul>
</li>
</ul>
<h2 id="3-3-查看raid">3.3. 查看raid</h2>
<h3 id="3-3-1-查看有哪些controller">3.3.1. 查看有哪些controller</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># storcli show</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>System Overview :
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------
</span></span><span style="display:flex;"><span>Ctl Model   Ports PDs DGs DNOpt VDs VNOpt BBU sPR DS  EHS ASOs Hlth
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">0</span> SAS3508     <span style="color:#0000cf;font-weight:bold">8</span>   <span style="color:#0000cf;font-weight:bold">2</span>   <span style="color:#0000cf;font-weight:bold">1</span>     <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#0000cf;font-weight:bold">1</span>     <span style="color:#0000cf;font-weight:bold">0</span> Opt On  1<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0000cf;font-weight:bold">2</span> Y      <span style="color:#0000cf;font-weight:bold">3</span> Opt
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------
</span></span><span style="display:flex;"><span><span style="color:#000">Ctl</span><span style="color:#ce5c00;font-weight:bold">=</span>Controller Index<span style="color:#000;font-weight:bold">|</span><span style="color:#000">DGs</span><span style="color:#ce5c00;font-weight:bold">=</span>Drive groups<span style="color:#000;font-weight:bold">|</span><span style="color:#000">VDs</span><span style="color:#ce5c00;font-weight:bold">=</span>Virtual drives<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Fld</span><span style="color:#ce5c00;font-weight:bold">=</span>Failed
</span></span><span style="display:flex;"><span><span style="color:#000">PDs</span><span style="color:#ce5c00;font-weight:bold">=</span>Physical drives<span style="color:#000;font-weight:bold">|</span><span style="color:#000">DNOpt</span><span style="color:#ce5c00;font-weight:bold">=</span>Array NotOptimal<span style="color:#000;font-weight:bold">|</span><span style="color:#000">VNOpt</span><span style="color:#ce5c00;font-weight:bold">=</span>VD NotOptimal<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Opt</span><span style="color:#ce5c00;font-weight:bold">=</span>Optimal
</span></span><span style="display:flex;"><span><span style="color:#000">Msng</span><span style="color:#ce5c00;font-weight:bold">=</span>Missing<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Dgd</span><span style="color:#ce5c00;font-weight:bold">=</span>Degraded<span style="color:#000;font-weight:bold">|</span><span style="color:#000">NdAtn</span><span style="color:#ce5c00;font-weight:bold">=</span>Need Attention<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Unkwn</span><span style="color:#ce5c00;font-weight:bold">=</span>Unknown
</span></span><span style="display:flex;"><span><span style="color:#000">sPR</span><span style="color:#ce5c00;font-weight:bold">=</span>Scheduled Patrol Read<span style="color:#000;font-weight:bold">|</span><span style="color:#000">DS</span><span style="color:#ce5c00;font-weight:bold">=</span>DimmerSwitch<span style="color:#000;font-weight:bold">|</span><span style="color:#000">EHS</span><span style="color:#ce5c00;font-weight:bold">=</span>Emergency Spare Drive
</span></span><span style="display:flex;"><span><span style="color:#000">Y</span><span style="color:#ce5c00;font-weight:bold">=</span>Yes<span style="color:#000;font-weight:bold">|</span><span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">=</span>No<span style="color:#000;font-weight:bold">|</span><span style="color:#000">ASOs</span><span style="color:#ce5c00;font-weight:bold">=</span>Advanced Software Options<span style="color:#000;font-weight:bold">|</span><span style="color:#000">BBU</span><span style="color:#ce5c00;font-weight:bold">=</span>Battery backup unit/CV
</span></span><span style="display:flex;"><span><span style="color:#000">Hlth</span><span style="color:#ce5c00;font-weight:bold">=</span>Health<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Safe</span><span style="color:#ce5c00;font-weight:bold">=</span>Safe-mode boot<span style="color:#000;font-weight:bold">|</span>CertProv-Certificate Provision mode
</span></span><span style="display:flex;"><span><span style="color:#000">Chrg</span><span style="color:#ce5c00;font-weight:bold">=</span>Charging <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">MsngCbl</span><span style="color:#ce5c00;font-weight:bold">=</span>Cable Failure
</span></span></code></pre></div><p>上述信息可以看出当前有1个controller， 第一个controller有2个物理磁盘。</p>
<p>如果要用json格式的方式查看可以增加<code>J</code>参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># storcli show J</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;Controllers&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;Command Status&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#4e9a06">&#34;CLI Version&#34;</span>: <span style="color:#4e9a06">&#34;007.2203.0000.0000 May 11, 2022&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#4e9a06">&#34;Status Code&#34;</span>: 0,
</span></span><span style="display:flex;"><span>                <span style="color:#4e9a06">&#34;Status&#34;</span>: <span style="color:#4e9a06">&#34;Success&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#4e9a06">&#34;Description&#34;</span>: <span style="color:#4e9a06">&#34;None&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;Response Data&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#4e9a06">&#34;Number of Controllers&#34;</span>: 1,
</span></span><span style="display:flex;"><span>                <span style="color:#4e9a06">&#34;System Overview&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;Ctl&#34;</span>: 0,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;Model&#34;</span>: <span style="color:#4e9a06">&#34;SAS3508&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;Ports&#34;</span>: 8,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;PDs&#34;</span>: 2,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;DGs&#34;</span>: 1,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;DNOpt&#34;</span>: 0,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;VDs&#34;</span>: 1,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;VNOpt&#34;</span>: 0,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;BBU&#34;</span>: <span style="color:#4e9a06">&#34;Opt&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;sPR&#34;</span>: <span style="color:#4e9a06">&#34;On&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;DS&#34;</span>: <span style="color:#4e9a06">&#34;1&amp;2&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;EHS&#34;</span>: <span style="color:#4e9a06">&#34;Y&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;ASOs&#34;</span>: 3,
</span></span><span style="display:flex;"><span>                        <span style="color:#4e9a06">&#34;Hlth&#34;</span>: <span style="color:#4e9a06">&#34;Opt&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-3-2-查看controller信息">3.3.2. 查看controller信息</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># storcli /c0  show</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TOPOLOGY :
</span></span><span style="display:flex;"><span>---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>DG Arr Row EID:Slot DID Type  State BT     Size PDC  PI SED DS3  FSpace TR
</span></span><span style="display:flex;"><span>---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">0</span> -   -   -        -   RAID1 Optl  N  1.089 TB dflt N  N   dflt N      N
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>   -   -        -   RAID1 Optl  N  1.089 TB dflt N  N   dflt N      N
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#0000cf;font-weight:bold">0</span>   134:0    <span style="color:#0000cf;font-weight:bold">1</span>   DRIVE Onln  N  1.089 TB dflt N  N   dflt -      N
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#0000cf;font-weight:bold">1</span>   134:1    <span style="color:#0000cf;font-weight:bold">0</span>   DRIVE Onln  N  1.089 TB dflt N  N   dflt -      N
</span></span><span style="display:flex;"><span>---------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">DG</span><span style="color:#ce5c00;font-weight:bold">=</span>Disk Group Index<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Arr</span><span style="color:#ce5c00;font-weight:bold">=</span>Array Index<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Row</span><span style="color:#ce5c00;font-weight:bold">=</span>Row Index<span style="color:#000;font-weight:bold">|</span><span style="color:#000">EID</span><span style="color:#ce5c00;font-weight:bold">=</span>Enclosure Device ID
</span></span><span style="display:flex;"><span><span style="color:#000">DID</span><span style="color:#ce5c00;font-weight:bold">=</span>Device ID<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">=</span>Drive Type<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Onln</span><span style="color:#ce5c00;font-weight:bold">=</span>Online<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Rbld</span><span style="color:#ce5c00;font-weight:bold">=</span>Rebuild<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Optl</span><span style="color:#ce5c00;font-weight:bold">=</span>Optimal<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Dgrd</span><span style="color:#ce5c00;font-weight:bold">=</span>Degraded
</span></span><span style="display:flex;"><span><span style="color:#000">Pdgd</span><span style="color:#ce5c00;font-weight:bold">=</span>Partially degraded<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Offln</span><span style="color:#ce5c00;font-weight:bold">=</span>Offline<span style="color:#000;font-weight:bold">|</span><span style="color:#000">BT</span><span style="color:#ce5c00;font-weight:bold">=</span>Background Task Active
</span></span><span style="display:flex;"><span><span style="color:#000">PDC</span><span style="color:#ce5c00;font-weight:bold">=</span>PD Cache<span style="color:#000;font-weight:bold">|</span><span style="color:#000">PI</span><span style="color:#ce5c00;font-weight:bold">=</span>Protection Info<span style="color:#000;font-weight:bold">|</span><span style="color:#000">SED</span><span style="color:#ce5c00;font-weight:bold">=</span>Self Encrypting Drive<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Frgn</span><span style="color:#ce5c00;font-weight:bold">=</span>Foreign
</span></span><span style="display:flex;"><span><span style="color:#000">DS3</span><span style="color:#ce5c00;font-weight:bold">=</span>Dimmer Switch 3<span style="color:#000;font-weight:bold">|</span><span style="color:#000">dflt</span><span style="color:#ce5c00;font-weight:bold">=</span>Default<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Msng</span><span style="color:#ce5c00;font-weight:bold">=</span>Missing<span style="color:#000;font-weight:bold">|</span><span style="color:#000">FSpace</span><span style="color:#ce5c00;font-weight:bold">=</span>Free Space Present
</span></span><span style="display:flex;"><span><span style="color:#000">TR</span><span style="color:#ce5c00;font-weight:bold">=</span>Transport Ready
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Virtual <span style="color:#000">Drives</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VD LIST :
</span></span><span style="display:flex;"><span>-------------------------------------------------------------
</span></span><span style="display:flex;"><span>DG/VD TYPE  State Access Consist Cache Cac sCC     Size Name
</span></span><span style="display:flex;"><span>-------------------------------------------------------------
</span></span><span style="display:flex;"><span>0/0   RAID1 Optl  RW     No      RWBD  -   ON  1.089 TB
</span></span><span style="display:flex;"><span>-------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">VD</span><span style="color:#ce5c00;font-weight:bold">=</span>Virtual Drive<span style="color:#000;font-weight:bold">|</span> <span style="color:#000">DG</span><span style="color:#ce5c00;font-weight:bold">=</span>Drive Group<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Rec</span><span style="color:#ce5c00;font-weight:bold">=</span>Recovery
</span></span><span style="display:flex;"><span><span style="color:#000">Cac</span><span style="color:#ce5c00;font-weight:bold">=</span>CacheCade<span style="color:#000;font-weight:bold">|</span><span style="color:#000">OfLn</span><span style="color:#ce5c00;font-weight:bold">=</span>OffLine<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Pdgd</span><span style="color:#ce5c00;font-weight:bold">=</span>Partially Degraded<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Dgrd</span><span style="color:#ce5c00;font-weight:bold">=</span>Degraded
</span></span><span style="display:flex;"><span><span style="color:#000">Optl</span><span style="color:#ce5c00;font-weight:bold">=</span>Optimal<span style="color:#000;font-weight:bold">|</span><span style="color:#000">dflt</span><span style="color:#ce5c00;font-weight:bold">=</span>Default<span style="color:#000;font-weight:bold">|</span><span style="color:#000">RO</span><span style="color:#ce5c00;font-weight:bold">=</span>Read Only<span style="color:#000;font-weight:bold">|</span><span style="color:#000">RW</span><span style="color:#ce5c00;font-weight:bold">=</span>Read Write<span style="color:#000;font-weight:bold">|</span><span style="color:#000">HD</span><span style="color:#ce5c00;font-weight:bold">=</span>Hidden<span style="color:#000;font-weight:bold">|</span><span style="color:#000">TRANS</span><span style="color:#ce5c00;font-weight:bold">=</span>TransportReady
</span></span><span style="display:flex;"><span><span style="color:#000">B</span><span style="color:#ce5c00;font-weight:bold">=</span>Blocked<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Consist</span><span style="color:#ce5c00;font-weight:bold">=</span>Consistent<span style="color:#000;font-weight:bold">|</span><span style="color:#000">R</span><span style="color:#ce5c00;font-weight:bold">=</span>Read Ahead Always<span style="color:#000;font-weight:bold">|</span><span style="color:#000">NR</span><span style="color:#ce5c00;font-weight:bold">=</span>No Read Ahead<span style="color:#000;font-weight:bold">|</span><span style="color:#000">WB</span><span style="color:#ce5c00;font-weight:bold">=</span>WriteBack
</span></span><span style="display:flex;"><span><span style="color:#000">AWB</span><span style="color:#ce5c00;font-weight:bold">=</span>Always WriteBack<span style="color:#000;font-weight:bold">|</span><span style="color:#000">WT</span><span style="color:#ce5c00;font-weight:bold">=</span>WriteThrough<span style="color:#000;font-weight:bold">|</span><span style="color:#000">C</span><span style="color:#ce5c00;font-weight:bold">=</span>Cached IO<span style="color:#000;font-weight:bold">|</span><span style="color:#000">D</span><span style="color:#ce5c00;font-weight:bold">=</span>Direct IO<span style="color:#000;font-weight:bold">|</span><span style="color:#000">sCC</span><span style="color:#ce5c00;font-weight:bold">=</span>Scheduled
</span></span><span style="display:flex;"><span>Check Consistency
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Physical <span style="color:#000">Drives</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PD LIST :
</span></span><span style="display:flex;"><span>----------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>EID:Slt DID State DG     Size Intf Med SED PI SeSz Model            Sp Type
</span></span><span style="display:flex;"><span>----------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>134:0     <span style="color:#0000cf;font-weight:bold">1</span> Onln   <span style="color:#0000cf;font-weight:bold">0</span> 1.089 TB SAS  HDD N   N  512B ST1200MM0009     U  -
</span></span><span style="display:flex;"><span>134:1     <span style="color:#0000cf;font-weight:bold">0</span> Onln   <span style="color:#0000cf;font-weight:bold">0</span> 1.089 TB SAS  HDD N   N  512B ST1200MM0009     U  -
</span></span><span style="display:flex;"><span>----------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">EID</span><span style="color:#ce5c00;font-weight:bold">=</span>Enclosure Device ID<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Slt</span><span style="color:#ce5c00;font-weight:bold">=</span>Slot No<span style="color:#000;font-weight:bold">|</span><span style="color:#000">DID</span><span style="color:#ce5c00;font-weight:bold">=</span>Device ID<span style="color:#000;font-weight:bold">|</span><span style="color:#000">DG</span><span style="color:#ce5c00;font-weight:bold">=</span>DriveGroup
</span></span><span style="display:flex;"><span><span style="color:#000">DHS</span><span style="color:#ce5c00;font-weight:bold">=</span>Dedicated Hot Spare<span style="color:#000;font-weight:bold">|</span><span style="color:#000">UGood</span><span style="color:#ce5c00;font-weight:bold">=</span>Unconfigured Good<span style="color:#000;font-weight:bold">|</span><span style="color:#000">GHS</span><span style="color:#ce5c00;font-weight:bold">=</span>Global Hotspare
</span></span><span style="display:flex;"><span><span style="color:#000">UBad</span><span style="color:#ce5c00;font-weight:bold">=</span>Unconfigured Bad<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Sntze</span><span style="color:#ce5c00;font-weight:bold">=</span>Sanitize<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Onln</span><span style="color:#ce5c00;font-weight:bold">=</span>Online<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Offln</span><span style="color:#ce5c00;font-weight:bold">=</span>Offline<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Intf</span><span style="color:#ce5c00;font-weight:bold">=</span>Interface
</span></span><span style="display:flex;"><span><span style="color:#000">Med</span><span style="color:#ce5c00;font-weight:bold">=</span>Media Type<span style="color:#000;font-weight:bold">|</span><span style="color:#000">SED</span><span style="color:#ce5c00;font-weight:bold">=</span>Self Encryptive Drive<span style="color:#000;font-weight:bold">|</span><span style="color:#000">PI</span><span style="color:#ce5c00;font-weight:bold">=</span>Protection Info
</span></span><span style="display:flex;"><span><span style="color:#000">SeSz</span><span style="color:#ce5c00;font-weight:bold">=</span>Sector Size<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Sp</span><span style="color:#ce5c00;font-weight:bold">=</span>Spun<span style="color:#000;font-weight:bold">|</span><span style="color:#000">U</span><span style="color:#ce5c00;font-weight:bold">=</span>Up<span style="color:#000;font-weight:bold">|</span><span style="color:#000">D</span><span style="color:#ce5c00;font-weight:bold">=</span>Down<span style="color:#000;font-weight:bold">|</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">=</span>Transition<span style="color:#000;font-weight:bold">|</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">=</span>Foreign
</span></span><span style="display:flex;"><span><span style="color:#000">UGUnsp</span><span style="color:#ce5c00;font-weight:bold">=</span>UGood Unsupported<span style="color:#000;font-weight:bold">|</span><span style="color:#000">UGShld</span><span style="color:#ce5c00;font-weight:bold">=</span>UGood shielded<span style="color:#000;font-weight:bold">|</span><span style="color:#000">HSPShld</span><span style="color:#ce5c00;font-weight:bold">=</span>Hotspare shielded
</span></span><span style="display:flex;"><span><span style="color:#000">CFShld</span><span style="color:#ce5c00;font-weight:bold">=</span>Configured shielded<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Cpybck</span><span style="color:#ce5c00;font-weight:bold">=</span>CopyBack<span style="color:#000;font-weight:bold">|</span><span style="color:#000">CBShld</span><span style="color:#ce5c00;font-weight:bold">=</span>Copyback Shielded
</span></span><span style="display:flex;"><span><span style="color:#000">UBUnsp</span><span style="color:#ce5c00;font-weight:bold">=</span>UBad Unsupported<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Rbld</span><span style="color:#ce5c00;font-weight:bold">=</span>Rebuild
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">Enclosures</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Enclosure LIST :
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------
</span></span><span style="display:flex;"><span>EID State Slots PD PS Fans TSs Alms SIM Port# ProdID VendorSpecific
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">134</span> OK        <span style="color:#0000cf;font-weight:bold">8</span>  <span style="color:#0000cf;font-weight:bold">2</span>  <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#0000cf;font-weight:bold">1</span> -     SGPIO
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">EID</span><span style="color:#ce5c00;font-weight:bold">=</span>Enclosure Device ID <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">PD</span><span style="color:#ce5c00;font-weight:bold">=</span>Physical drive count <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">PS</span><span style="color:#ce5c00;font-weight:bold">=</span>Power Supply count
</span></span><span style="display:flex;"><span><span style="color:#000">TSs</span><span style="color:#ce5c00;font-weight:bold">=</span>Temperature sensor count <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">Alms</span><span style="color:#ce5c00;font-weight:bold">=</span>Alarm count <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">SIM</span><span style="color:#ce5c00;font-weight:bold">=</span>SIM Count <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">ProdID</span><span style="color:#ce5c00;font-weight:bold">=</span>Product ID
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Cachevault_Info :
</span></span><span style="display:flex;"><span>------------------------------------
</span></span><span style="display:flex;"><span>Model  State   Temp Mode MfgDate
</span></span><span style="display:flex;"><span>------------------------------------
</span></span><span style="display:flex;"><span>CVPM02 Optimal 26C  -    2018/06/05
</span></span><span style="display:flex;"><span>------------------------------------
</span></span></code></pre></div><h3 id="3-3-2-查看物理机磁盘">3.3.2. 查看物理机磁盘</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># storcli /c0 /eall /sall show</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Drive Information :
</span></span><span style="display:flex;"><span>----------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>EID:Slt DID State DG     Size Intf Med SED PI SeSz Model            Sp Type
</span></span><span style="display:flex;"><span>----------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>134:0     <span style="color:#0000cf;font-weight:bold">1</span> Onln   <span style="color:#0000cf;font-weight:bold">0</span> 1.089 TB SAS  HDD N   N  512B ST1200MM0009     U  -
</span></span><span style="display:flex;"><span>134:1     <span style="color:#0000cf;font-weight:bold">0</span> Onln   <span style="color:#0000cf;font-weight:bold">0</span> 1.089 TB SAS  HDD N   N  512B ST1200MM0009     U  -
</span></span><span style="display:flex;"><span>----------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">EID</span><span style="color:#ce5c00;font-weight:bold">=</span>Enclosure Device ID<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Slt</span><span style="color:#ce5c00;font-weight:bold">=</span>Slot No<span style="color:#000;font-weight:bold">|</span><span style="color:#000">DID</span><span style="color:#ce5c00;font-weight:bold">=</span>Device ID<span style="color:#000;font-weight:bold">|</span><span style="color:#000">DG</span><span style="color:#ce5c00;font-weight:bold">=</span>DriveGroup
</span></span><span style="display:flex;"><span><span style="color:#000">DHS</span><span style="color:#ce5c00;font-weight:bold">=</span>Dedicated Hot Spare<span style="color:#000;font-weight:bold">|</span><span style="color:#000">UGood</span><span style="color:#ce5c00;font-weight:bold">=</span>Unconfigured Good<span style="color:#000;font-weight:bold">|</span><span style="color:#000">GHS</span><span style="color:#ce5c00;font-weight:bold">=</span>Global Hotspare
</span></span><span style="display:flex;"><span><span style="color:#000">UBad</span><span style="color:#ce5c00;font-weight:bold">=</span>Unconfigured Bad<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Sntze</span><span style="color:#ce5c00;font-weight:bold">=</span>Sanitize<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Onln</span><span style="color:#ce5c00;font-weight:bold">=</span>Online<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Offln</span><span style="color:#ce5c00;font-weight:bold">=</span>Offline<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Intf</span><span style="color:#ce5c00;font-weight:bold">=</span>Interface
</span></span><span style="display:flex;"><span><span style="color:#000">Med</span><span style="color:#ce5c00;font-weight:bold">=</span>Media Type<span style="color:#000;font-weight:bold">|</span><span style="color:#000">SED</span><span style="color:#ce5c00;font-weight:bold">=</span>Self Encryptive Drive<span style="color:#000;font-weight:bold">|</span><span style="color:#000">PI</span><span style="color:#ce5c00;font-weight:bold">=</span>Protection Info
</span></span><span style="display:flex;"><span><span style="color:#000">SeSz</span><span style="color:#ce5c00;font-weight:bold">=</span>Sector Size<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Sp</span><span style="color:#ce5c00;font-weight:bold">=</span>Spun<span style="color:#000;font-weight:bold">|</span><span style="color:#000">U</span><span style="color:#ce5c00;font-weight:bold">=</span>Up<span style="color:#000;font-weight:bold">|</span><span style="color:#000">D</span><span style="color:#ce5c00;font-weight:bold">=</span>Down<span style="color:#000;font-weight:bold">|</span><span style="color:#000">T</span><span style="color:#ce5c00;font-weight:bold">=</span>Transition<span style="color:#000;font-weight:bold">|</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">=</span>Foreign
</span></span><span style="display:flex;"><span><span style="color:#000">UGUnsp</span><span style="color:#ce5c00;font-weight:bold">=</span>UGood Unsupported<span style="color:#000;font-weight:bold">|</span><span style="color:#000">UGShld</span><span style="color:#ce5c00;font-weight:bold">=</span>UGood shielded<span style="color:#000;font-weight:bold">|</span><span style="color:#000">HSPShld</span><span style="color:#ce5c00;font-weight:bold">=</span>Hotspare shielded
</span></span><span style="display:flex;"><span><span style="color:#000">CFShld</span><span style="color:#ce5c00;font-weight:bold">=</span>Configured shielded<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Cpybck</span><span style="color:#ce5c00;font-weight:bold">=</span>CopyBack<span style="color:#000;font-weight:bold">|</span><span style="color:#000">CBShld</span><span style="color:#ce5c00;font-weight:bold">=</span>Copyback Shielded
</span></span><span style="display:flex;"><span><span style="color:#000">UBUnsp</span><span style="color:#ce5c00;font-weight:bold">=</span>UBad Unsupported<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Rbld</span><span style="color:#ce5c00;font-weight:bold">=</span>Rebuild
</span></span></code></pre></div><h3 id="3-3-2-查看虚拟磁盘">3.3.2. 查看虚拟磁盘</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># storcli /c0 /v0 show</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Virtual Drives :
</span></span><span style="display:flex;"><span>-------------------------------------------------------------
</span></span><span style="display:flex;"><span>DG/VD TYPE  State Access Consist Cache Cac sCC     Size Name
</span></span><span style="display:flex;"><span>-------------------------------------------------------------
</span></span><span style="display:flex;"><span>0/0   RAID1 Optl  RW     No      RWBD  -   ON  1.089 TB
</span></span><span style="display:flex;"><span>-------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">VD</span><span style="color:#ce5c00;font-weight:bold">=</span>Virtual Drive<span style="color:#000;font-weight:bold">|</span> <span style="color:#000">DG</span><span style="color:#ce5c00;font-weight:bold">=</span>Drive Group<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Rec</span><span style="color:#ce5c00;font-weight:bold">=</span>Recovery
</span></span><span style="display:flex;"><span><span style="color:#000">Cac</span><span style="color:#ce5c00;font-weight:bold">=</span>CacheCade<span style="color:#000;font-weight:bold">|</span><span style="color:#000">OfLn</span><span style="color:#ce5c00;font-weight:bold">=</span>OffLine<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Pdgd</span><span style="color:#ce5c00;font-weight:bold">=</span>Partially Degraded<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Dgrd</span><span style="color:#ce5c00;font-weight:bold">=</span>Degraded
</span></span><span style="display:flex;"><span><span style="color:#000">Optl</span><span style="color:#ce5c00;font-weight:bold">=</span>Optimal<span style="color:#000;font-weight:bold">|</span><span style="color:#000">dflt</span><span style="color:#ce5c00;font-weight:bold">=</span>Default<span style="color:#000;font-weight:bold">|</span><span style="color:#000">RO</span><span style="color:#ce5c00;font-weight:bold">=</span>Read Only<span style="color:#000;font-weight:bold">|</span><span style="color:#000">RW</span><span style="color:#ce5c00;font-weight:bold">=</span>Read Write<span style="color:#000;font-weight:bold">|</span><span style="color:#000">HD</span><span style="color:#ce5c00;font-weight:bold">=</span>Hidden<span style="color:#000;font-weight:bold">|</span><span style="color:#000">TRANS</span><span style="color:#ce5c00;font-weight:bold">=</span>TransportReady
</span></span><span style="display:flex;"><span><span style="color:#000">B</span><span style="color:#ce5c00;font-weight:bold">=</span>Blocked<span style="color:#000;font-weight:bold">|</span><span style="color:#000">Consist</span><span style="color:#ce5c00;font-weight:bold">=</span>Consistent<span style="color:#000;font-weight:bold">|</span><span style="color:#000">R</span><span style="color:#ce5c00;font-weight:bold">=</span>Read Ahead Always<span style="color:#000;font-weight:bold">|</span><span style="color:#000">NR</span><span style="color:#ce5c00;font-weight:bold">=</span>No Read Ahead<span style="color:#000;font-weight:bold">|</span><span style="color:#000">WB</span><span style="color:#ce5c00;font-weight:bold">=</span>WriteBack
</span></span><span style="display:flex;"><span><span style="color:#000">AWB</span><span style="color:#ce5c00;font-weight:bold">=</span>Always WriteBack<span style="color:#000;font-weight:bold">|</span><span style="color:#000">WT</span><span style="color:#ce5c00;font-weight:bold">=</span>WriteThrough<span style="color:#000;font-weight:bold">|</span><span style="color:#000">C</span><span style="color:#ce5c00;font-weight:bold">=</span>Cached IO<span style="color:#000;font-weight:bold">|</span><span style="color:#000">D</span><span style="color:#ce5c00;font-weight:bold">=</span>Direct IO<span style="color:#000;font-weight:bold">|</span><span style="color:#000">sCC</span><span style="color:#ce5c00;font-weight:bold">=</span>Scheduled
</span></span><span style="display:flex;"><span>Check Consistency
</span></span></code></pre></div><p>可以看到虚拟磁盘做的是<code>RAID1</code>的配置。</p>
<h2 id="3-4-删除raid">3.4. 删除raid</h2>
<p>删除 RAID 阵列</p>
<ul>
<li>
<p><strong><code>/c0</code></strong> 表示控制器 0。</p>
</li>
<li>
<p><strong><code>/v0</code></strong> 表示虚拟驱动器 0。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>storcli /c0 /v0 delete force
</span></span></code></pre></div><p>删除所有虚拟驱动器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>storcli /c0/vall delete preservedCache
</span></span></code></pre></div><p>删除 外部阵列（foreign configurations）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>storcli /c0/fall delete
</span></span></code></pre></div><p><strong><code>/fall</code></strong>：<code>fall</code> 表示 <strong>所有的外部阵列（foreign configurations）</strong>。外部阵列通常是指在不同的 RAID 控制器或硬盘被移动到当前系统中后，RAID 控制器检测到的现有 RAID 配置，但这些配置尚未被本地控制器认可为有效的 RAID 配置。</p>
<h1 id="4-使用ssacli命令创建raid">4. 使用ssacli命令创建raid</h1>
<blockquote>
<p>Todo</p>
</blockquote>
<h3 id="3-2-1-创建raid">3.2.1. 创建raid</h3>
<h3 id="3-2-2-查看raid">3.2.2. 查看raid</h3>
<h3 id="3-2-3-删除raid">3.2.3. 删除raid</h3>
<h1 id="5-总结">5. 总结</h1>
<p>本文主要描述如何创建硬件raid，主要包含以下几个步骤</p>
<ol>
<li>通过<code>lspci -mm |egrep &quot;Broadcom / LSI|Adaptec&quot;</code>命令查询当前机器使用的是哪个raid厂商，对应使用哪种raid命令，例如storcli或ssacli等。</li>
<li>根据选中的命令清除当前的raid配置。</li>
<li>根据选中的命令查询当前有哪些物理磁盘，大小，磁盘编号，控制器有哪些并记录下来。</li>
<li>根据用户配置选择做哪种raid（raid级别），以及选择哪些磁盘用来做raid（通过磁盘编号即<code>EID:Slt</code>）</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="https://www.cnblogs.com/xzongblogs/p/14700443.html">storcli</a></li>
<li><a href="https://www.cnblogs.com/xzongblogs/p/14555789.html">ssacli</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2877dd58d274d3880a06c631d157bce3">3 - TCP/IP</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-c629a2b6a83fee825cbde9907286afdd">3.1 - TCPIP基础</h1>
    
	<h1 id="1-基础知识">1. 基础知识</h1>
<h2 id="1-1-协议">1.1. 协议</h2>
<p>计算机与网络设备要相互通信，必须基于相同的方法。比如，如何探测到通信目标，使用哪种语言通信，如何结束通信等规则要事先确定。</p>
<p>不同硬件，操作系统之间的通信都需要一种规则，我们将这种<code>事先约定好的规则称之为协议</code>。</p>
<h2 id="1-2-地址">1.2. 地址</h2>
<p>地址：在某一范围内确认的唯一标识符，即数据包传到某一个范围，需要有一个明确唯一的目标地址。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>层</th>
<th>地址</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>端口号</td>
<td>传输层</td>
<td>程序地址</td>
<td>同一个计算机中不同的应用程序</td>
</tr>
<tr>
<td>IP地址</td>
<td>网络层</td>
<td>主机地址</td>
<td>识别TCP/IP网络中不同的主机或路由器</td>
</tr>
<tr>
<td>MAC地址</td>
<td>数据链路层</td>
<td>物理地址</td>
<td>在同一个数据链路中识别不同的计算机</td>
</tr>
</tbody>
</table>
<h2 id="1-3-网络构成">1.3. 网络构成</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579692/article/tcpip/basics/network.png" width="70%">
<table>
<thead>
<tr>
<th>构成要素</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>网卡</td>
<td>连入网络必须使用网卡，又称网络接口卡。</td>
</tr>
<tr>
<td>中继器</td>
<td>OSI第1层，物理层上延长网络的设备，将电缆的信号放大传给另一个电缆。</td>
</tr>
<tr>
<td>网桥/2层交换机</td>
<td>OSI第2层，数据链路层面上连接两个网络的设备，识别数据帧的内容并转发给相邻的网段，根据MAC地址进行处理。</td>
</tr>
<tr>
<td>路由器/3层交换机</td>
<td>OSI第3层，网络层面连接两个网络并对分组报文进行转发，根据IP进行处理。</td>
</tr>
<tr>
<td>4-7层交换机</td>
<td>传输层到应用层，以TCP等协议分析收发数据，负载均衡器就是其中一种。</td>
</tr>
<tr>
<td>网关</td>
<td>对传输层到应用层的数据进行转换和转发的设备，通常会使用表示层或应用层的网关来处理不同协议之间的翻译和通信，代理服务器（proxy）就是应用网关的一种。</td>
</tr>
</tbody>
</table>
<h1 id="2-osi与tcp-ip参考模型">2. OSI与TCP/IP参考模型</h1>
<h2 id="2-1-osi与tcp-ip参考模型图">2.1. OSI与TCP/IP参考模型图</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579693/article/tcpip/basics/TCPIP-OSI.png" width=70%>
<h2 id="2-2-osi参考模型分层说明">2.2. OSI参考模型分层说明</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579692/article/tcpip/basics/osi-function.png" width=70%>
<h2 id="2-3-osi参考模型通信过程">2.3. OSI参考模型通信过程</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579692/article/tcpip/basics/OSI.png" width=70%>
<p>1、打包数据时，每一层在处理上一层传过来的数据时，会在数据上附上当前层的首部信息后传给下一层；</p>
<p>2、解包数据时，每一层在处理下一层传过来的数据时，会将当前层的首部信息与数据分开，将数据传给上一层。</p>
<p>3、数据通信过程</p>
<table>
<thead>
<tr>
<th>分层</th>
<th>每层的操作</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用层</td>
<td>在数据前面加首部，首部包括数据内容、源地址和目标地址，同时也会处理异常的反馈信息。</td>
</tr>
<tr>
<td>表示层</td>
<td>将特有的数据格式转换为通用的数据格式，同时也会加上表示层的首部信息以供解析。</td>
</tr>
<tr>
<td>会话层</td>
<td>对何时连接，以何种方式连接，连接多久，何时断开等做记录。同时也会加会话层的首部信息。</td>
</tr>
<tr>
<td>传输层</td>
<td>建立连接，断开连接，确认数据是否发送成功和执行失败重发任务。</td>
</tr>
<tr>
<td>网络层</td>
<td>负责将数据发到目标地址，也包含首部信息。</td>
</tr>
<tr>
<td>数据链路层</td>
<td>通过物理的传输介质实现数据的传输。</td>
</tr>
<tr>
<td>物理层</td>
<td>将0/1转换成物理的传输介质，通过MAC地址进行传输。</td>
</tr>
</tbody>
</table>
<h2 id="2-4-tcp-ip应用层协议">2.4. TCP/IP应用层协议</h2>
<h3 id="2-4-1-通信模型">2.4.1. 通信模型</h3>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579692/article/tcpip/basics/TrafficModel.png" width=70%>
<h3 id="2-4-2-应用层协议说明">2.4.2. 应用层协议说明</h3>
<table>
<thead>
<tr>
<th>应用类型</th>
<th>协议</th>
<th>协议说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>WWW</td>
<td>HTTP,HTML</td>
<td><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579693/article/tcpip/basics/www.png" width=100%></td>
</tr>
<tr>
<td>电子邮件</td>
<td>SMTP，MIME</td>
<td><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579691/article/tcpip/basics/email.png" width=100%></td>
</tr>
<tr>
<td>文件传输</td>
<td>FTP</td>
<td><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579691/article/tcpip/basics/ftp.png" width=100%></td>
</tr>
<tr>
<td>远程登录</td>
<td>TELNET,SSH</td>
<td><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579693/article/tcpip/basics/telnet.png" width=100%></td>
</tr>
<tr>
<td>网络管理</td>
<td>SNMP,MIB</td>
<td><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579692/article/tcpip/basics/snmp.png" width=100%></td>
</tr>
</tbody>
</table>
<h1 id="3-tcp-ip通信过程">3. TCP/IP通信过程</h1>
<h2 id="3-1-数据包结构">3.1. 数据包结构</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579691/article/tcpip/basics/data-package.png" width=70%>
<h2 id="3-2-数据打包和解包过程">3.2. 数据打包和解包过程</h2>
<h3 id="3-2-1-包的封装">3.2.1. 包的封装</h3>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579692/article/tcpip/basics/package.png" width=60%> 
<h3 id="3-2-2-发送与接收">3.2.2. 发送与接收</h3>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579693/article/tcpip/basics/send-receive.png" width=60%>
<h2 id="3-3-数据包传输过程">3.3. 数据包传输过程</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579693/article/tcpip/basics/transmission.png" width=60%>
<p>文章：</p>
<ul>
<li>《图解TCP/IP》</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f7cbb4c5a76ec9332d300cd3470493c2">3.2 - IP协议</h1>
    
	<h1 id="1-ip基础">1. IP基础</h1>
<p>TCP/IP的心脏是互联网层，这一层主要有IP和ICMP两个协议组成，在OSI参考模型中为第三层（网络层）。网络层的主要作用是实现终端节点之间的通信（点对点通信）。</p>
<h2 id="1-1-网络层与数据链路层的关系">1.1. 网络层与数据链路层的关系</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579278/article/tcpip/ip/1.1.png" alt="这里写图片描述"></p>
<h2 id="1-2-ip寻址">1.2. IP寻址</h2>
<p>IP地址用于在“连接到网络中的所有主机中识别出进行通信的目标地址”。因此TCP/IP通信中所有主机或路由器必须设定自己的IP地址（每块网卡至少配置一个或以上的IP地址）。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579278/article/tcpip/ip/1.2.png" alt="这里写图片描述"></p>
<h2 id="1-3-路由控制">1.3. 路由控制</h2>
<p>路由控制是指将分组数据发送到最终目标地址的功能。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579278/article/tcpip/ip/1.3.png" alt="这里写图片描述"></p>
<p>IP数据包类似快递中的包裹，送货车类似数据链路，包裹依赖送货车承载转运，而一辆送货车只能将包裹送到某个区间内，由新的快递点安排新的送货车来进行下一区间的运输。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579278/article/tcpip/ip/1.3.0.png" alt="这里写图片描述"></p>
<h3 id="1-3-1-路由控制表">1.3.1. 路由控制表</h3>
<p>为了将数据包发给目标主机，所有主机都维护一张路由控制表（Routing Table）,该表记录IP数据在下一步应该发给哪个路由器。IP包根据这个路由表在各个数据链路上传输。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579278/article/tcpip/ip/1.3.1.png" alt="这里写图片描述"></p>
<h2 id="1-4-数据链路的抽象化">1.4. 数据链路的抽象化</h2>
<p>IP是实现多个数据链路之间通信的协议。对不同数据链路的相异特性进行抽象化也是IP的重要作用之一。不同数据链路最大的区别在于它们各自的最大传输单位（MTU）不同，类似快递包裹有各自的大小限制。当数据包过大时，IP进行分片处理，即将大的IP包分成多个较小的IP包，当到目标地址后再被组合起来传给上一层。</p>
<h2 id="1-5-ip是面向无连接型">1.5. IP是面向无连接型</h2>
<p>IP发包之前不需要提前与目标建立连接。采用面向无连接的原因：为了简化和提速。面向连接型需要提前建立连接会降低处理速度。IP只负责将数据发给目标主机，但途中可能会发生丢包、错位、数据量翻倍等问题。TCP则是面向连接的协议，负责保证对端主机确实收到数据。</p>
<h1 id="2-ip地址">2. IP地址</h1>
<p>在TCP/IP通信中，用IP地址识别主机和路由器。</p>
<h2 id="2-1-ip地址的定义">2.1. IP地址的定义</h2>
<p>IP地址（IPv4地址）由32位正整数来表示。IP地址在计算机内部以二进制方式被处理，但习惯将32位的IP地址以8位为一组，分成4组，每组以“.”隔开，转换成10进制来表示。IPv4地址为32位，最多允许43亿台计算机连接网络。</p>
<p>实际上，IP地址并非根据主机台数来分配而是每一台主机上的每一块网卡都得设置IP地址，一块网卡可以设置一个或以上个IP,路由器通常会配置两个以上的网卡。</p>
<h2 id="2-2-ip地址由网络和主机两部分标识组成">2.2. IP地址由网络和主机两部分标识组成</h2>
<p>IP地址由“网络地址”和“主机地址”两部分组成。</p>
<p>网络标识在数据链路的每个段配置不同的值，必须保证相互连接的每个段的地址不重复，相同段内连接的主机必须有相同的网络地址。主机标识则不允许同一个网段内重复出现。在某一范围内，IP地址需具有唯一性。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579279/article/tcpip/ip/2.2.png" alt="这里写图片描述"></p>
<p>IP包被转发到某个路由器时，是利用目标IP地址的网络标识进行路由，即使不看主机地址，由网络地址则可判断是否是该网段内的主机。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579278/article/tcpip/ip/2.2.1.png" alt="这里写图片描述"></p>
<h2 id="2-3-ip地址的分类">2.3. IP地址的分类</h2>
<p>IP地址分为A、B、C、D四类。</p>
<table>
<thead>
<tr>
<th>IP地址类别</th>
<th>地址开头</th>
<th>网络地址</th>
<th>主机地址</th>
<th>范围</th>
<th>一个网段内主机地址个数</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>A类地址</td>
<td>0</td>
<td>第1-8位</td>
<td>后24位</td>
<td>0.0.0.0~127.0.0.0</td>
<td>2^24-2=16777214</td>
<td></td>
</tr>
<tr>
<td>B类地址</td>
<td>10</td>
<td>第1-16位</td>
<td>后16位</td>
<td>128.0.0.0~191.255.0.0</td>
<td>2^16-2=65534</td>
<td></td>
</tr>
<tr>
<td>C类地址</td>
<td>110</td>
<td>第1-24位</td>
<td>后8位</td>
<td>192.0.0.0~239.255.255.0</td>
<td>2^8-2=254</td>
<td></td>
</tr>
<tr>
<td>D类地址</td>
<td>1110</td>
<td>第1-32位</td>
<td>没有主机地址</td>
<td>224.0.0.0~239.255.255.255</td>
<td></td>
<td>常用于多播</td>
</tr>
</tbody>
</table>
<p>注意：同一个网段中的主机地址分配，主机地址全为0表示对应的网络地址，主机地址全为1通常用于广播地址。因此一个网段内主机的个数去掉2个（例如2^8-2=254）。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579279/article/tcpip/ip/2.3.png" alt="这里写图片描述"></p>
<h2 id="2-4-子网隐码">2.4. 子网隐码</h2>
<p>用1表示网络地址的范围，用0表示主机地址的访问。因此A、B、C类可表示为</p>
<table>
<thead>
<tr>
<th>IP类别</th>
<th>表示</th>
</tr>
</thead>
<tbody>
<tr>
<td>A类</td>
<td>255.0.0.0</td>
</tr>
<tr>
<td>B类</td>
<td>255.255.0.0</td>
</tr>
<tr>
<td>C类</td>
<td>255.255.255.0</td>
</tr>
</tbody>
</table>
<p>按照以上的组合方式IP有点浪费，因此产生子网隐码的分类方法减少这种浪费。</p>
<p>引入子网后，IP地址由两种识别码组成：IP地址本身+表示网络地址的子网隐码。即将A,B,C类中的主机地址拆成网络部分和主机部分，重新分配网络地址和主机地址。子网隐码同样是用1表示网络地址的范围，用0表示主机地址的访问。</p>
<h3 id="2-4-1-子网隐码的表示方法">2.4.1. 子网隐码的表示方法</h3>
<table>
<thead>
<tr>
<th>表示方法</th>
<th>地址</th>
<th></th>
<th>子网隐码</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>数字</td>
<td>IP地址</td>
<td>172.20.100.52</td>
<td>255.255.255.192</td>
<td></td>
</tr>
<tr>
<td>网络地址</td>
<td>172.20.100.0</td>
<td>255.255.255.192</td>
<td></td>
<td></td>
</tr>
<tr>
<td>广播地址</td>
<td>172.20.100.63</td>
<td>255.255.255.192</td>
<td></td>
<td></td>
</tr>
<tr>
<td>“/26”，表示前26位为网络地址</td>
<td>IP地址</td>
<td>172.20.100.52/26</td>
<td></td>
<td></td>
</tr>
<tr>
<td>网络地址</td>
<td>172.20.100.0/26</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>广播地址</td>
<td>172.20.100.63/26</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579279/article/tcpip/ip/2.4.1.png" alt="这里写图片描述"></p>
<h1 id="3-路由控制">3. 路由控制</h1>
<p>发送数据包除了有目标IP地址外，还需要指明路由器和主机的信息，即路由控制表。</p>
<p>路由控制表的形成方式有两种：</p>
<p>1、静态路由</p>
<p>由管理员手动设置</p>
<p>2、动态路由</p>
<p>路由器与其他路由器相互交互信息时自动刷新。为了让动态路由及时刷新路由表，在网络上互联的路由器之间需设置路由协议，保证正常读取路由控制信息。</p>
<h2 id="3-1-ip地址和路由控制">3.1. IP地址和路由控制</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579279/article/tcpip/ip/3.1.png" alt="这里写图片描述"></p>
<p>IP地址的网络地址部分用于进行路由控制。路由控制表中记录着网络地址与下一步应该发送至路由器的地址。在发送IP包时，首先确认IP包首部中的目标地址，再从路由控制表中找到与该地址具有相同网络地址的记录，根据该记录将IP包转发给相应的下一个路由器。如果存在多条相同网络地址的记录，则选择最为吻合的网络地址（相同位数最多）。例如：172.20.100.52的网络地址与172.20.0/16和172.20.100.0/24都匹配，则选择匹配最长的172.20.100.0/24。</p>
<h3 id="3-1-1-默认路由">3.1.1. 默认路由</h3>
<p>默认路由一般标记为0.0.0.0/0或default。当路由表中没有任何一个地址与之匹配的记录，则使用默认路由。</p>
<h3 id="3-1-2-主机路由">3.1.2. 主机路由</h3>
<p>“IP地址/32”也被称为主机路由，即整个IP地址的所有位都参与路由。进行主机路由意味着基于主机上网卡配置的IP地址本身而不是基于该地址的网络地址进行路由。一般用于不希望通过网络地址路由的情况。使用主机路由会导致路由表膨大，路由负荷增加，网络性能下降。</p>
<h3 id="3-1-3-环回地址">3.1.3. 环回地址</h3>
<p>环回地址是在同一台计算机上程序之间进行网络通信时所使用的一个默认地址。即IP地址为127.0.0.1，主机名为localhost。</p>
<h2 id="3-2-路由控制表的聚合">3.2. 路由控制表的聚合</h2>
<p>路由信息的聚合可以有效的减少路由表的条目。路由表越大，管理它所需要的内存和CPU就越多，查找路由表的时间越长，导致转发IP包性能下降。要构建高性能网络就需要尽可能减少路由表的大小。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579280/article/tcpip/ip/3.2.png" alt="这里写图片描述"></p>
<h1 id="4-ip首部信息">4. IP首部信息</h1>
<p>IP进行通信时，需要在数据前面加入IP首部信息，IP首部包含着用于IP协议进行发包控制时所有的必要信息。</p>
<h2 id="4-1-ipv4首部">4.1. IPv4首部</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579280/article/tcpip/ip/4.1.png" alt="这里写图片描述"></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
<th>大小</th>
</tr>
</thead>
<tbody>
<tr>
<td>版本</td>
<td>标识IP首部的版本号，IPv4，即版本号为4</td>
<td>4比特</td>
</tr>
<tr>
<td>首部长度</td>
<td>表示IP首部的大小，单位为4字节</td>
<td>4比特</td>
</tr>
<tr>
<td>区分服务</td>
<td>表示服务质量</td>
<td>8比特</td>
</tr>
<tr>
<td>DSCP段与ECN段</td>
<td>DSCP用来进行质量控制，值越大优先度越高；ECN用来报告网络拥堵情况</td>
<td>2比特</td>
</tr>
<tr>
<td>总长度</td>
<td>表示IP首部与数据部分合起来的总字节数</td>
<td>16比特</td>
</tr>
<tr>
<td>标识</td>
<td>用于分片重组，同一个分片标识值相同，不同分片的标识值不同</td>
<td>16比特</td>
</tr>
<tr>
<td>标志</td>
<td>表示包被分片的相关信息</td>
<td>3比特</td>
</tr>
<tr>
<td>片偏移</td>
<td>用来标识被分片的每一个分段相对于原始数据的位置。</td>
<td>13比特</td>
</tr>
<tr>
<td>生存时间（TTL）</td>
<td>本意为包的生存期限，一般表示可以中转多少个路由器，每经过一个路由器TTL减1，直到变为0则丢弃该包</td>
<td>8比特</td>
</tr>
<tr>
<td>协议</td>
<td>表示IP首部的下一个首部隶属于哪个协议。</td>
<td>8比特</td>
</tr>
<tr>
<td>首部校验和</td>
<td>IP首部校验和，用来确保IP数据报不被破坏。</td>
<td>16比特</td>
</tr>
<tr>
<td>源地址</td>
<td>发送端IP地址</td>
<td>32比特</td>
</tr>
<tr>
<td>目标地址</td>
<td>接收端IP地址</td>
<td>32比特</td>
</tr>
<tr>
<td>可选项</td>
<td>安全级别、源路径、路径记录、时间戳</td>
<td></td>
</tr>
<tr>
<td>填充</td>
<td>填补物，调整大小使用</td>
<td></td>
</tr>
<tr>
<td>数据</td>
<td>存入数据</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="4-2-ipv6首部">4.2. IPv6首部</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579280/article/tcpip/ip/4.2.png" alt="这里写图片描述"></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>版本</td>
<td>IPv6,版本为6</td>
</tr>
<tr>
<td>通信量类</td>
<td>相当于IPv4的TOS（Type Of Service）字段</td>
</tr>
<tr>
<td>流标号</td>
<td>用于服务质量控制</td>
</tr>
<tr>
<td>有效载荷长度</td>
<td>包的数据部分</td>
</tr>
<tr>
<td>下一个首部</td>
<td>相当于IPv4的协议字段</td>
</tr>
<tr>
<td>跳数限制</td>
<td>Hop Limit，同IPv4的TTL,表示可通过的路由器个数</td>
</tr>
<tr>
<td>源地址</td>
<td>发送端的IP地址</td>
</tr>
<tr>
<td>目标地址</td>
<td>接收端的IP地址</td>
</tr>
</tbody>
</table>
<p><br/>参考</p>
<ul>
<li>《图解TCP/IP》</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-783f0fab77205aefe1fd803e53ba7c52">3.3 - TCP协议</h1>
    
	<h1 id="1-传输层的作用">1. 传输层的作用</h1>
<h2 id="1-1-传输层的定义">1.1. 传输层的定义</h2>
<p>IP首部有个协议字段，用来标识传输层协议，识别数据是TCP的内容还是UDP的内容。同样，传输层，为了识别数据应该发给哪个应用也设定了这样的编号，即端口。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579309/article/tcpip/tcpudp/1.1.png" alt="这里写图片描述"></p>
<h2 id="1-2-通信处理">1.2. 通信处理</h2>
<p>应用协议大多以C/S形式运行，即服务端需提前启动服务，监听某个端口，当客户端往该端口发送数据时，可以及时处理请求。</p>
<p>服务端程序在UNIX系统中称为守护进程，例如HTTP的服务端程序为httpd；ssh的服务端程序为sshd。UNIX中不必要逐个启动这些守护进程，而是由超级守护进程inetd(互联网守护进程)启动，当收到客户端请求时会创建（fork）新的进程并转换（exec）为httpd等各个守护进程。根据请求端口分配到对应的服务端守护进程上处理。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579310/article/tcpip/tcpudp/1.2.png" alt="这里写图片描述"></p>
<h2 id="1-3-tcp和udp">1.3. TCP和UDP</h2>
<h3 id="1-3-1-tcp">1.3.1. TCP</h3>
<p>TCP是面向连接、可靠的数据流。流就是不间断的数据结构，可理解为水管中的水流。虽然可以保证发送顺序，但犹如没有间隔的发送数据流给接收端。例如：发送10次100字节的消息，接收端可能会收到一个1000字节连续不断的数据。TCP为实现可靠传输，实行“顺序控制”和“重发控制”；还具备“流量控制”、“拥塞控制”、提高网络利用率等。TCP可以类比为“打电话”，有去有回。</p>
<h3 id="1-3-2-udp">1.3.2. UDP</h3>
<p>UDP是不具备可靠性的数据报协议，可以确保发送消息的大小，但不能保证消息一定到达，应用有时会根据自己的需要进行重发处理。UDP可以类比“发短信”，有去无回。</p>
<h3 id="1-3-3-套接字">1.3.3. 套接字</h3>
<p>应用在使用TCP或UDP时会用到系统提供的类库，即API（应用编程接口），通信时会用到套接字（socket）的API。应用程序利用套接字，可以设置对端的IP地址、端口号，并实现数据的发送与接收。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579309/article/tcpip/tcpudp/1.3.3.png" alt="这里写图片描述"></p>
<h1 id="2-端口号">2. 端口号</h1>
<h2 id="2-1-端口号的定义">2.1. 端口号的定义</h2>
<table>
<thead>
<tr>
<th>类别</th>
<th>地址</th>
<th>层</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>端口号</td>
<td>程序地址</td>
<td>传输层</td>
<td>同一个计算机中不同的应用程序</td>
</tr>
<tr>
<td>IP地址</td>
<td>主机地址</td>
<td>网络层</td>
<td>识别TCP/IP网络中不同的主机或路由器</td>
</tr>
<tr>
<td>MAC地址</td>
<td>物理地址</td>
<td>数据链路层</td>
<td>在同一个数据链路中识别不同的计算机</td>
</tr>
</tbody>
</table>
<p>把数据传输比作快递传递；IP地址就像你的家庭地址；那么端口号相当于你家具体的收件人；知道了家庭地址和收件人才能将快递准确送达。</p>
<h2 id="2-2-根据端口号识别应用">2.2. 根据端口号识别应用</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579309/article/tcpip/tcpudp/2.2.png" alt="这里写图片描述"></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579309/article/tcpip/tcpudp/2.2.1.png" alt="这里写图片描述"></p>
<h2 id="2-3-通过ip地址-端口号-协议号进行通信">2.3. 通过IP地址、端口号、协议号进行通信</h2>
<p>5个信息唯一标识一个通信：源地址IP、目标地址IP、协议号、源端口号、目标端口号。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579310/article/tcpip/tcpudp/2.3.png" alt="这里写图片描述"></p>
<h2 id="2-4-端口号如何确定">2.4. 端口号如何确定</h2>
<h3 id="2-4-1-标准既定的端口号">2.4.1. 标准既定的端口号</h3>
<p>该方法也叫静态方法，是指每个应用程序都有其指定的端口号。例如HTTP、FTP等应用协议使用的端口号，这类端口号称为知名端口号，一般由0-1023的数字分配而成。除知名端口号外，还有一些端口号也被正式注册，分布在1024-49151的数字之间。这些端口可用于任何通信用途。</p>
<h3 id="2-4-2-时序分配法">2.4.2. 时序分配法</h3>
<p>该方法也叫动态分配法，服务端有必要确定监听端口号，但接受服务的客户端没必要确定端口号。客户端可以不用自己设置端口号，由操作系统进行分配。操作系统为每个应用程序分配互不冲突的端口号。例如，新增一个端口号则在之前的端口号上加1，动态分配的端口号取值范围：49152-65535。</p>
<h1 id="3-tcp协议概述">3. TCP协议概述</h1>
<p>TCP:Transmission Control Protocol (传输控制协议)，TCP实现了数据传输时的各种控制功能，可以进行丢包重发，乱序纠正，控制通信流量的浪费。</p>
<p>参考：</p>
<ul>
<li>《图解TCP/IP》</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-84452cfe31915d8c4f4d04258246cb10">3.4 - UDP协议</h1>
    
	<h1 id="1-udp协议概述">1. UDP协议概述</h1>
<p>UDP:User Datagram Protocol的缩写，提供面向无连接的通信服务，在应用程序发来数据收到那一刻则立即原样发送到网络上。即使出现丢包也不负责重发，包出现乱序也不能纠正。</p>
<p>UDP可以随时发送数据，本身处理简单高效，但不具备可靠性，适合以下场景：</p>
<ul>
<li>包总量较少的通信（DNS、SNMP等）</li>
<li>视频、音频等多媒体通信（即使通信）</li>
<li>限定于LAN等特定网络中的应用通信</li>
<li>广播通信（广播、多播）</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0890a784034f82778864893ae61492de">3.5 - HTTP协议</h1>
    
	<h1 id="1-web及网络基础">1. web及网络基础</h1>
<h2 id="1-1-通过http访问web-c-s">1.1. 通过HTTP访问web[C/S]</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579775/article/tcpip/http/basis/1.1.png" alt=""></p>
<h2 id="1-2-tcp-ip四层模型">1.2. TCP/IP四层模型</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579776/article/tcpip/http/basis/1.2.png" alt=""></p>
<h3 id="1-2-1-数据包的封装">1.2.1. 数据包的封装</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579776/article/tcpip/http/basis/1.2.1.png" alt=""></p>
<h2 id="1-3-tcp-ip协议族">1.3. TCP/IP协议族</h2>
<h3 id="1-3-1-负责传输的ip协议">1.3.1. 负责传输的IP协议</h3>
<p>使用ARP协议凭借MAC地址通信</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579776/article/tcpip/http/basis/1.3.1.png" alt=""></p>
<h3 id="1-3-2-确保可靠的tcp协议">1.3.2. 确保可靠的TCP协议</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579775/article/tcpip/http/basis/1.3.2.png" alt=""></p>
<h3 id="1-3-3-负责域名解析的dns服务">1.3.3. 负责域名解析的DNS服务</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579776/article/tcpip/http/basis/1.3.3.png" alt=""></p>
<h3 id="1-3-4-各协议与http的关系">1.3.4. 各协议与HTTP的关系</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579775/article/tcpip/http/basis/1.3.4.png" alt=""></p>
<h2 id="1-4-uri与url">1.4. URI与URL</h2>
<ul>
<li>URI(Uniform Resource Identifier):统一资源标识符</li>
<li>URL(Uniform Resource Locator):统一资源定位符；URL是URI的子集</li>
</ul>
<h3 id="1-4-1-uri的格式">1.4.1. URI的格式</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579775/article/tcpip/http/basis/1.4.1.png" alt=""></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>协议</td>
<td>http/https</td>
</tr>
<tr>
<td>登录信息（认证）</td>
<td>user:pass@(一般没有)</td>
</tr>
<tr>
<td>服务器地址</td>
<td>域名或IP</td>
</tr>
<tr>
<td>服务器端口号</td>
<td>服务端口号，省略则取默认端口号</td>
</tr>
<tr>
<td>带层次的文件路径</td>
<td>指定服务器上的文件路径来定位特指的资源</td>
</tr>
<tr>
<td>查询字符串</td>
<td>使用查询字符串传入参数</td>
</tr>
<tr>
<td>片段标识符</td>
<td>标记以获取资源中的子资源（文档内的某个位置）</td>
</tr>
</tbody>
</table>
<h3 id="1-4-2-uri的示例">1.4.2. URI的示例</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579775/article/tcpip/http/basis/1.4.2.png" alt=""></p>
<h1 id="2-http协议">2. HTTP协议</h1>
<h2 id="2-1-通过请求和响应的交换达成通信">2.1. 通过请求和响应的交换达成通信</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579776/article/tcpip/http/basis/2.1.png" alt=""></p>
<h3 id="2-1-1-请求报文">2.1.1. 请求报文</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579775/article/tcpip/http/basis/2.1.1.png" alt=""></p>
<h3 id="2-1-2-响应报文">2.1.2. 响应报文</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579776/article/tcpip/http/basis/2.1.2.png" alt=""></p>
<h2 id="2-2-http请求方法">2.2. HTTP请求方法</h2>
<h3 id="2-2-1-get-获取资源">2.2.1. GET:获取资源</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579776/article/tcpip/http/basis/2.2.1.png" alt=""></p>
<h3 id="2-2-2-post-传输实体主体">2.2.2. POST:传输实体主体</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579777/article/tcpip/http/basis/2.2.2.1.png" alt=""></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579776/article/tcpip/http/basis/2.2.2.2.png" alt=""></p>
<h3 id="2-2-3-put-传输文件">2.2.3. PUT:传输文件</h3>
<p>PUT方法用来传输文件，像FTP协议一样，要求在请求报文的主体中包含文件内容，然后保存到请求URI指定的位置。</p>
<p>因为自身不带验证机制，有安全问题，因此一般不采用。若配合验证机制或者REST标准则可使用。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579777/article/tcpip/http/basis/2.2.3.png" alt=""></p>
<h3 id="2-2-4-head-获取报文头部">2.2.4. HEAD:获取报文头部</h3>
<p>HEAD和GET一样但不返回报文主体部分，用于确认URI的有效性及资源的更新时间等。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579777/article/tcpip/http/basis/2.2.4.png" alt=""></p>
<h3 id="2-2-5-delete-删除文件">2.2.5. DELETE:删除文件</h3>
<p>DELETE与PUT作用相反，但不带安全验证机制一般不采用。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579777/article/tcpip/http/basis/2.2.5.1.png" alt=""></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579777/article/tcpip/http/basis/2.2.5.2.png" alt=""></p>
<h3 id="2-2-6-options-询问支持的方法">2.2.6. OPTIONS:询问支持的方法</h3>
<p>OPTIONS用来查询针对请求URI指定的资源支持的方法</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579777/article/tcpip/http/basis/2.2.6.png" alt=""></p>
<h3 id="2-2-7-trace-追踪路径">2.2.7. TRACE:追踪路径</h3>
<p>TRACE用来查询发送出去的请求是怎样被加工修改/篡改的，因为易引发XST（跨站追踪）攻击，一般不使用。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579777/article/tcpip/http/basis/2.2.7.png" alt=""></p>
<h3 id="2-2-8-connect-要求用隧道协议连接代理">2.2.8. CONNECT:要求用隧道协议连接代理</h3>
<p>CONNECT要求在与代理服务器通信时建立隧道，实现用隧道协议进行TCP通信。主要使用SSL（Source Sockets Layer:安全套接字）和TLS（Transport Layer Security:传输层安全）协议把通信内容加密后经网络隧道传输。</p>
<p>方法格式如下：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579777/article/tcpip/http/basis/2.2.8.1.png" alt=""></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579778/article/tcpip/http/basis/2.2.8.2.png" alt=""></p>
<h2 id="2-3-持久连接">2.3. 持久连接</h2>
<h3 id="2-3-1-keep-alive">2.3.1. keep-alive</h3>
<p>为解决每进行一次HTTP通信就要断开一次TCP连接，增加了通信量的开销，HTTP/1.1通过keep-alive持久连接，只要任意一端没有明确提出断开连接，则保持TCP连接状态。</p>
<p>持久连接减少了TCP连接的重复建立和断开所造成的额外开销，减轻了服务器端的负载。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579778/article/tcpip/http/basis/2.3.1.png" alt=""></p>
<h3 id="2-3-2-管线化">2.3.2. 管线化</h3>
<p>持续连接使得多数请求以管线化（pipelining）方式发送成为可能。管线化即同时并行发送多个请求，而不需要一个接一个等待响应。管线化技术比持续连接速度快，请求数越多越明显。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579778/article/tcpip/http/basis/2.3.2.png" alt=""></p>
<h3 id="2-3-3-使用cookie的状态管理">2.3.3. 使用cookie的状态管理</h3>
<p>HTTP是无状态协议，不对之前发生过的请求和响应的状态进行管理，即无法根据之前的状态进行本次的请求处理。无状态协议的优点在于不必保存状态，减少服务器CPU及内存资源的消耗。</p>
<p>cookie技术通过在请求和响应报文中写入cookie信息来控制客户端的状态。cookie会根据从服务端发送的响应报文内的一个叫做Set-Cookie的首部字段通知客户端保存Cookie；当客户端再往服务端发送请求时，客户端自动在请求报文中加入Cookie值后发送出去。服务器发现Cookie后会检查从哪个客户端发送来的连接请求，对比服务器上的记录，最后得到之前的状态信息。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579778/article/tcpip/http/basis/2.3.3.png" alt=""></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579778/article/tcpip/http/basis/2.3.3.2.png" alt=""></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579778/article/tcpip/http/basis/2.3.3.3.png" alt=""></p>
<h1 id="3-http报文">3. HTTP报文</h1>
<h2 id="3-1-http报文">3.1. HTTP报文</h2>
<p>用于HTTP协议交互的信息被称为HTTP报文，客户端的HTTP报文叫做请求报文，服务端的叫做响应报文。报文大致分为报文首部和报文主体，但并不一定要有报文主体。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580019/article/tcpip/http/codestatus/3.1.png" alt="img"></p>
<h2 id="3-2-报文结构">3.2. 报文结构</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580019/article/tcpip/http/codestatus/3.2.png" alt="img"></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580020/article/tcpip/http/codestatus/3.2.2.png" alt="img"></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>请求行</td>
<td>请求方法，请求URI和HTTP版本</td>
</tr>
<tr>
<td>状态行</td>
<td>响应结果的状态码，原因短语和HTTP版本</td>
</tr>
<tr>
<td>首部字段</td>
<td>请求和响应的各种条件和属性的各类首部：通用首部、请求首部、响应首部、实体首部</td>
</tr>
<tr>
<td>其他</td>
<td>HTTP的RFC里未定义的首部（Cookie等）</td>
</tr>
</tbody>
</table>
<h2 id="3-3-编码提升传输速率">3.3. 编码提升传输速率</h2>
<p>HTTP在传输数据时可以按照数据原貌直接传输也可以在传输过程中编码提升传输速率；通过编码可以处理大量请求但会消耗更多的CPU等资源。</p>
<h3 id="3-3-1-报文主体和实体主体的差异">3.3.1. 报文主体和实体主体的差异</h3>
<ul>
<li>报文：是HTTP通信中的基本单位，由8位组字节流组成，通过HTTP通信传输。</li>
<li>实体：作为请求或响应的有效载荷数据被传输，其内容由实体首部和实体主体组成。</li>
</ul>
<p>通常报文主体等于实体主体，但当传输中进行编码时，实体主体的内容发生变化才会与报文主体产生差异。</p>
<h3 id="3-3-2-压缩传输的内容编码">3.3.2. 压缩传输的内容编码</h3>
<p>HTTP中的内容编码指明应用在实体内容上的编码格式，并保持实体信息原样压缩，内容编码后的实体由客户端接收并负责解码。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580019/article/tcpip/http/codestatus/3.3.2.png" alt="img"></p>
<p>常用的内容编码：</p>
<ul>
<li>gzip(GNU ZIP)</li>
<li>compress(UNIX系统的标准压缩)</li>
<li>deflate(zlib)</li>
<li>identity(不进行编码)</li>
</ul>
<h3 id="3-3-3-分块传输编码">3.3.3. 分块传输编码</h3>
<p>分块传输编码会将实体主体分成多个块，每一块都会用十六进制来标记快的大小，而实体的最后一块会使用“0（CR+LF）”来标记。</p>
<p>由接收的客户端负责解码，回复到编码前的实体主体。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580020/article/tcpip/http/codestatus/3.3.3.png" alt="img"></p>
<h2 id="3-4-发送多种数据的多部分对象集合">3.4. 发送多种数据的多部分对象集合</h2>
<p>HTTP中的多部分对象集合即发送一份报文主体内可含有多类型实体，通常是图片或文本文件上传等。</p>
<p>多部分对象集合包含的对象：</p>
<ul>
<li>multipart/form-data:在web表单文件上传时使用</li>
<li>multipart/byteranges：状态码206响应报文包含了多个范围的内容时使用</li>
</ul>
<h2 id="3-5-获取部分内容的范围请求">3.5. 获取部分内容的范围请求</h2>
<p>指定范围发送的请求叫做范围请求，对于一份10000字节大小的资源，如果使用范围请求，可以只请求5001-10000字节内的资源。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580020/article/tcpip/http/codestatus/3.5.png" alt="img"></p>
<p>执行范围请求时，会用到首部字段Range来指定资源的byte范围</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580020/article/tcpip/http/codestatus/3.5.2.png" alt="img"></p>
<h2 id="3-6-内容协商返回最合适的内容">3.6. 内容协商返回最合适的内容</h2>
<p>内容协商机制是指客户端和服务端就响应的资源内容进行交涉，然后提供给客户端最合适的资源。内容协商会以响应资源的语言、编码方式等作为判断的基准。</p>
<p>内容协商类型：</p>
<ul>
<li>服务器驱动协商</li>
<li>客户端驱动协商</li>
<li>透明协商</li>
</ul>
<h1 id="4-http状态码">4. HTTP状态码</h1>
<p>状态码即服务器返回的请求结果。</p>
<table>
<thead>
<tr>
<th>状态码</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1xx</td>
<td>Informational(信息性状态码)</td>
<td>接收的请求正在处理</td>
</tr>
<tr>
<td>2xx</td>
<td>Success(成功)</td>
<td>请求正常处理完毕</td>
</tr>
<tr>
<td>3xx</td>
<td>Redirection(重定向)</td>
<td>需要进行附加操作以完成请求</td>
</tr>
<tr>
<td>4xx</td>
<td>Client Error(客户端错误)</td>
<td>服务器无法处理请求</td>
</tr>
<tr>
<td>5xx</td>
<td>Server Error(服务端错误)</td>
<td>服务器处理请求出错</td>
</tr>
</tbody>
</table>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580022/article/tcpip/http/codestatus/4.png" alt="img"></p>
<h2 id="4-1-2xx成功">4.1. 2XX成功</h2>
<h3 id="4-1-1-200-ok">4.1.1. 200 OK</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580020/article/tcpip/http/codestatus/4.1.1.png" alt="img"></p>
<h3 id="4-1-2-204-no-content">4.1.2. 204 No Content</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580020/article/tcpip/http/codestatus/4.1.2.png" alt="img"></p>
<p>表示请求已成功处理，但在返回的响应报文中不含实体的主体部分。</p>
<h3 id="4-1-3-206-partial-content">4.1.3. 206 Partial Content</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580020/article/tcpip/http/codestatus/4.1.3.png" alt="img"></p>
<p>该状态码表示客户端进行了范围请求，服务器成功执行了这部分的GET请求。响应报文中包含由Content-Range指定范围的实体内容。</p>
<h2 id="4-2-3xx-重定向">4.2. 3XX 重定向</h2>
<h3 id="4-2-1-301-moved-permanently">4.2.1. 301 Moved Permanently</h3>
<p>永久性重定向，表示资源已被分配了新的URI，以后应使用新的URI。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580020/article/tcpip/http/codestatus/4.2.1.png" alt="img"></p>
<h3 id="4-2-2-302-found">4.2.2. 302 Found</h3>
<p>临时性重定向，表示请求的资源已被分配了新的URI，但是临时性的。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580021/article/tcpip/http/codestatus/4.2.2.png" alt="img"></p>
<h3 id="4-2-3-303-see-other">4.2.3. 303 See Other</h3>
<p>表示由于请求的资源存在另一个URI，应使用GET方法重定向获取请求的资源。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580020/article/tcpip/http/codestatus/4.2.3.png" alt="img"></p>
<h3 id="4-2-4-304-not-modified">4.2.4. 304 Not Modified</h3>
<p>表示客户端发送附带条件的请求时（GET中的If-Modified-Since等首部），服务器允许访问资源，但未满足附带条件因此直接返回304（服务器的资源未改变，可直接使用客户端未过期的缓存），不包含任何响应的主体部分。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580021/article/tcpip/http/codestatus/4.2.4.png" alt="img"></p>
<h3 id="4-2-5-307-temporary-redirect">4.2.5. 307 Temporary Redirect</h3>
<p>临时重定向，该状态与302有相同的含义。</p>
<h2 id="4-3-4xx-客户端错误">4.3. 4XX 客户端错误</h2>
<h3 id="4-3-1-400-bad-request">4.3.1. 400 Bad Request</h3>
<p>表示请求报文中存在语法错误，需修改内容重新发送请求。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580021/article/tcpip/http/codestatus/4.3.1.png" alt="img"></p>
<h3 id="4-3-2-401-unauthorized">4.3.2. 401 Unauthorized</h3>
<p>表示需要通过HTTP认证。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580021/article/tcpip/http/codestatus/4.3.2.png" alt="img"></p>
<h3 id="4-3-3-403-forbidden">4.3.3. 403 Forbidden</h3>
<p>表示请求被服务器拒绝，未获得访问授权。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580021/article/tcpip/http/codestatus/4.3.3.png" alt="img"></p>
<h3 id="4-3-4-404-no-found">4.3.4. 404 No Found</h3>
<p>表明服务器上找不到请求的资源，也可以在服务器拒绝请求且不想说明理由时使用。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580021/article/tcpip/http/codestatus/4.3.4.png" alt="img"></p>
<h2 id="4-4-5xx-服务器错误">4.4. 5XX 服务器错误</h2>
<h3 id="4-4-1-500-internal-server-error">4.4.1. 500 Internal Server Error</h3>
<p>表明服务器在执行请求时发生了错误，也可能是Web应用存在bug或临时故障等。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580021/article/tcpip/http/codestatus/4.4.1.png" alt="img"></p>
<h3 id="4-4-2-503-service-unavailable">4.4.2. 503 Service Unavailable</h3>
<p>表明服务器暂时处于超负荷或正在进行停机维护，现在不能处理请求。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510580022/article/tcpip/http/codestatus/4.4.2.png" alt="img"></p>
<p>参考：</p>
<ul>
<li>《图解HTTP》</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-24adc5fd31391cd2d4ff660df560df4c">4 - 网络</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-699fefc6af767e2525a21bee111a7f03">4.1 - tcpdump抓包流程</h1>
    
	<h1 id="1-简介">1. 简介</h1>
<p>linux系统上常用tcpdump抓包来分析网络问题。本文基于网络文章整理，主要介绍tcpdump抓包的常用命令及参数。</p>
<p>以下是数据包在操作系统层面的流程：</p>
<p><code>网卡nic</code> -&gt; <code>tcpdump</code> -&gt; <code>iptables(netfilter)</code> -&gt; <code>app</code> -&gt; <code>iptables(netfilter)</code> -&gt; <code>tcpdump</code> -&gt; <code>网卡nic</code></p>
<h1 id="2-tcpdump常用参数及命令">2. tcpdump常用参数及命令</h1>
<h2 id="2-1-指定网卡-i-和主机-host">2.1. 指定网卡(-i)和主机(host)</h2>
<p>tcpdump默认会将IP反向解析为域名，可以用<code>-nn</code>禁止反向解析。</p>
<ul>
<li>
<p><code>-i</code>：指定网卡</p>
</li>
<li>
<p><code>host</code>：指定主机</p>
</li>
<li>
<p><code>-nn</code>：禁止反向解析域名</p>
</li>
<li>
<p><code>-v或-vv</code>：显示抓包的详细信息</p>
</li>
<li>
<p><code>-w:</code> 写入文件（.pcap或.cap），供wireshark分析。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tcpdump -i any host 192.168.1.1      <span style="color:#8f5902;font-style:italic">#-i指定网卡为所有</span>
</span></span><span style="display:flex;"><span>tcpdump -i eth0 host 192.168.1.1      <span style="color:#8f5902;font-style:italic">#-i指定网卡为eth0</span>
</span></span><span style="display:flex;"><span>tcpdump -i eth0 host 192.168.1.1 -nn -v -w client.pcap     <span style="color:#8f5902;font-style:italic"># 写入文件</span>
</span></span></code></pre></div><h2 id="2-2-指定来源ip或目的ip-网段">2.2. 指定来源IP或目的IP、网段</h2>
<ul>
<li>
<p><code>src</code>：指定来源IP</p>
</li>
<li>
<p><code>dst</code>: 指定目标IP</p>
</li>
<li>
<p><code>net</code>: 指定网段</p>
</li>
<li>
<p><code>-s</code> : 指定抓包字节数，<code>-s 0</code>不限字节数，抓完整的包。例如icmp 大小为84字节</p>
</li>
<li>
<p><code>port</code>: 指定端口</p>
</li>
<li>
<p><code>portrange</code>: 指定端口范围</p>
</li>
<li>
<p><code>协议</code>：tcp, udp, icmp</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定源IP</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any src host 192.168.1.1 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  指定目标IP</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any dst 192.168.1.1 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定网段</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any net 192.168.1.1/32
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定字节数</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">84</span> host 192.168.1.1  <span style="color:#8f5902;font-style:italic"># 84表示icmp的包</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定协议</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> icmp  <span style="color:#8f5902;font-style:italic">#只抓icmp协议</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">60</span> tcp port <span style="color:#0000cf;font-weight:bold">80</span>  <span style="color:#8f5902;font-style:italic">#tcp协议，这里只抓60个头部字节</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> udp port <span style="color:#0000cf;font-weight:bold">22</span> <span style="color:#8f5902;font-style:italic"># udp协议</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定端口或范围</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> port <span style="color:#0000cf;font-weight:bold">22</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any tcp portrange 53-80 
</span></span></code></pre></div><h2 id="2-3-指定抓包数量-抓包大小-及轮询抓包">2.3. 指定抓包数量、抓包大小、及轮询抓包</h2>
<ul>
<li>
<p>-c: 指定抓多少个包</p>
</li>
<li>
<p>-W: 最多写入多少个抓包文件，以MB为单位</p>
</li>
<li>
<p>-C：写入到抓包文件的大小上限</p>
</li>
<li>
<p>-G：参数指定间隔多少秒轮询保存一次文件，通常是以时间格式命令</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定抓2个包</span>
</span></span><span style="display:flex;"><span>tcpdump -i any -s <span style="color:#0000cf;font-weight:bold">0</span> net 192.168.1.1/32 -c <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定写入到文件的大小上限为1M</span>
</span></span><span style="display:flex;"><span>tcpdump -i any -s <span style="color:#0000cf;font-weight:bold">0</span> -C <span style="color:#0000cf;font-weight:bold">1</span> -v -w client.pcap
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定写入到10个抓包文件，每个文件只抓1M，循环写入</span>
</span></span><span style="display:flex;"><span>tcpdump -i any -s <span style="color:#0000cf;font-weight:bold">0</span> -C 1M -v -W <span style="color:#0000cf;font-weight:bold">10</span> -w client.pcap
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 参数指定间隔多少秒轮询保存一次文件，通常是以时间格式命令</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> -G <span style="color:#0000cf;font-weight:bold">5</span> -Z root -v -w %m-%d-%H:%M:%S.pcap  <span style="color:#8f5902;font-style:italic">#每隔五秒保存一次文件</span>
</span></span></code></pre></div><h2 id="2-4-tcpdump的逻辑表达式-or-and-not">2.4. tcpdump的逻辑表达式(or、and、not)</h2>
<ul>
<li>
<p><code>and</code>: 与</p>
</li>
<li>
<p><code>or</code>: 或</p>
</li>
<li>
<p><code>not</code>: 非</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 与</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> host 192.168.1.1 and icmp
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> host 192.168.1.1 or icmp or src net 192.168.1.1/32 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 非</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> ! net 172.16.0.0/16 and icmp and ! tcp
</span></span></code></pre></div><h1 id="3-flags标记解读">3. Flags标记解读</h1>
<table>
<thead>
<tr>
<th>Flags</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[S]</code></td>
<td>SYN</td>
</tr>
<tr>
<td><code>[.]</code></td>
<td>ACK</td>
</tr>
<tr>
<td><code>[S.]</code></td>
<td>SYN、ACK</td>
</tr>
<tr>
<td><code>[P.]</code></td>
<td>PUSH</td>
</tr>
<tr>
<td><code>[R.]</code></td>
<td>RST</td>
</tr>
<tr>
<td><code>[F.]</code></td>
<td>FIN</td>
</tr>
<tr>
<td><code>[DF]</code></td>
<td>Don't Fragment(不分片)，当DF=0时，允许分片</td>
</tr>
<tr>
<td><code>[FP.]</code></td>
<td>FIN、PUSH、ACK</td>
</tr>
</tbody>
</table>
<p>参考：</p>
<ul>
<li>
<p><a href="https://www.tcpdump.org/manpages/tcpdump.1.html">https://www.tcpdump.org/manpages/tcpdump.1.html</a></p>
</li>
<li>
<p><a href="https://cloud.tencent.com/developer/article/1858612">抓包神器TCPDUMP的分析总结-涵盖各大使用场景、高级用法</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2e853cd9731a1b7fa5f3d4955c5ceda3">4.2 - iptables介绍</h1>
    
	<h1 id="1-简介">1. 简介</h1>
<p>iptables是一个设置防火墙（<strong>netfilter</strong>）规则的命令工具。网络规则包括源地址、目的地址、传输协议（如TCP、UDP、ICMP）和服务类型（如HTTP、FTP和SMTP）等，当数据包与规则匹配时，iptables就根据规则所定义的方法来处理这些数据包，如放行（accept）、拒绝（reject）和丢弃（drop）等。配置防火墙的主要工作就是添加、修改和删除这些规则。</p>
<h1 id="2-基本概念">2. 基本概念</h1>
<h2 id="2-1-链-chain">2.1. 链(Chain)</h2>
<p>网络设置的”关卡“一般有多个网络规则，称为链。</p>
<ul>
<li>
<p>INPUT</p>
</li>
<li>
<p>OUTPUT</p>
</li>
<li>
<p>FORWORD</p>
</li>
<li>
<p>PREROUTING</p>
</li>
<li>
<p>POSTROUTING</p>
</li>
</ul>
<h2 id="2-2-表">2.2. 表</h2>
<p>具有相同功能的规则的集合叫做”表”。iptables定义了四类表。</p>
<ul>
<li>
<p>filter表：负责过滤功能，防火墙；内核模块：iptables_filter</p>
</li>
<li>
<p>nat表：network address translation，网络地址转换功能；内核模块：iptable_nat</p>
</li>
<li>
<p>mangle表：拆解报文，做出修改，并重新封装 的功能；iptable_mangle</p>
</li>
<li>
<p>raw表：关闭nat表上启用的连接追踪机制；iptable_raw</p>
</li>
</ul>
<h2 id="2-3-表和链的关系">2.3. 表和链的关系</h2>
<ul>
<li>
<p><code>PREROUTING</code>的规则可以存在于：raw表，mangle表，nat表。</p>
</li>
<li>
<p><code>INPUT</code>的规则可以存在于：mangle表，filter表。</p>
</li>
<li>
<p><code>FORWARD</code>的规则可以存在于：mangle表，filter表。</p>
</li>
<li>
<p><code>OUTPUT</code>的规则可以存在于：raw表mangle表，nat表，filter表。</p>
</li>
<li>
<p><code>POSTROUTING</code>的规则可以存在于：mangle表，nat表。</p>
</li>
</ul>
<h1 id="3-规则匹配条件">3. 规则匹配条件</h1>
<p><strong>基本匹配条件</strong></p>
<ul>
<li>
<p>源地址Source IP</p>
</li>
<li>
<p>目标地址 Destination IP</p>
</li>
</ul>
<p><strong>扩展匹配条件</strong></p>
<ul>
<li>
<p>源端口Source Port,</p>
</li>
<li>
<p>目标端口Destination Port</p>
</li>
</ul>
<p><strong>处理操作</strong></p>
<ul>
<li>
<p><strong>ACCEPT</strong>：允许数据包通过。</p>
</li>
<li>
<p><strong>DROP</strong>：直接丢弃数据包，不给任何回应信息，这时候客户端会感觉自己的请求泥牛入海了，过了超时时间才会有反应。</p>
</li>
<li>
<p><strong>REJECT</strong>：拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息。</p>
</li>
<li>
<p><strong>SNAT</strong>：源地址转换，解决内网用户用同一个公网地址上网的问题。</p>
</li>
<li>
<p><strong>MASQUERADE</strong>：是SNAT的一种特殊形式，适用于动态的、临时会变的ip上。</p>
</li>
<li>
<p><strong>DNAT</strong>：目标地址转换。</p>
</li>
<li>
<p><strong>REDIRECT</strong>：在本机做端口映射。l</p>
</li>
</ul>
<h1 id="4-数据包经过防火墙的流程">4. 数据包经过防火墙的流程</h1>
<blockquote>
<p>图片来自：https://www.zsythink.net/archives/1199</p>
</blockquote>
<ul>
<li>
<p>到本机某进程的报文：PREROUTING –&gt; INPUT</p>
</li>
<li>
<p>由本机转发的报文：PREROUTING –&gt; FORWARD –&gt; POSTROUTING</p>
</li>
<li>
<p>由本机的某进程发出报文（通常为响应报文）：OUTPUT –&gt; POSTROUTING</p>
</li>
</ul>
<p><img src="https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_2.png" alt=""></p>
<p><img src="https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_6.png" alt=""></p>
<p>参考：</p>
<ul>
<li>
<p><a href="https://www.zsythink.net/archives/category/%e8%bf%90%e7%bb%b4%e7%9b%b8%e5%85%b3/iptables/">IPtables-朱双印博客</a></p>
</li>
<li>
<p><a href="https://www.zsythink.net/archives/1199">iptables详解（1）：iptables概念-朱双印博客</a></p>
</li>
</ul>
<p>    </p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fb885bb9e042e5f183dbbe1462da53d7">4.3 - iptables命令</h1>
    
	<h2 id="添加iptables规则">添加iptables规则</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 单个端口</span>
</span></span><span style="display:flex;"><span>iptables -A INPUT -p tcp --dport <span style="color:#0000cf;font-weight:bold">22</span> -j ACCEPT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 多个端口</span>
</span></span><span style="display:flex;"><span>iptables -A INPUT -p tcp -m multiport --dports 6443,8443,2379,2380,10250 -j ACCEPT
</span></span></code></pre></div><h2 id="删除iptables规则">删除iptables规则</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示iptables规则行号</span>
</span></span><span style="display:flex;"><span>iptables -nL --line-numbers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除某行规则</span>
</span></span><span style="display:flex;"><span>iptables -D INPUT <span style="color:#0000cf;font-weight:bold">11</span>
</span></span></code></pre></div><h2 id="持久化iptables-重启仍生效">持久化iptables（重启仍生效）</h2>
<p>持久化iptables规则，添加规则到文件中/etc/sysconfig/iptables</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># vi /etc/sysconfig/iptables</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-A INPUT -p vrrp -j ACCEPT
</span></span><span style="display:flex;"><span>-A OUTPUT -p vrrp -j ACCEPT
</span></span></code></pre></div><p>或者</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt-get install iptables-persistent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>netfilter-persistent save
</span></span><span style="display:flex;"><span>netfilter-persistent reload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 生成的规则存储在以下文件</span>
</span></span><span style="display:flex;"><span>/etc/iptables/rules.v4
</span></span><span style="display:flex;"><span>/etc/iptables/rules.v6
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-05f4d807ce9b3245e03b30114a0acab5">4.4 - wrk的使用</h1>
    
	<h1 id="1-installation">1. Installation</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># mac</span>
</span></span><span style="display:flex;"><span>brew install wrk
</span></span></code></pre></div><h1 id="2-usage">2. Usage</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ wrk --help
</span></span><span style="display:flex;"><span>Usage: wrk &lt;options&gt; &lt;url&gt;
</span></span><span style="display:flex;"><span>  Options:
</span></span><span style="display:flex;"><span>    -c, --connections &lt;N&gt;  Connections to keep open <span style="color:#8f5902;font-style:italic"># 跟服务器建立并保持的TCP连接数量  </span>
</span></span><span style="display:flex;"><span>    -d, --duration    &lt;T&gt;  Duration of <span style="color:#204a87">test</span> <span style="color:#8f5902;font-style:italic"># 压测时间    </span>
</span></span><span style="display:flex;"><span>    -t, --threads     &lt;N&gt;  Number of threads to use <span style="color:#8f5902;font-style:italic"># 使用多少个线程进行压测 </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    -s, --script      &lt;S&gt;  Load Lua script file <span style="color:#8f5902;font-style:italic"># 指定Lua脚本路径 </span>
</span></span><span style="display:flex;"><span>    -H, --header      &lt;H&gt;  Add header to request  <span style="color:#8f5902;font-style:italic"># 为每一个HTTP请求添加HTTP头  </span>
</span></span><span style="display:flex;"><span>        --latency          Print latency statistics <span style="color:#8f5902;font-style:italic"># 在压测结束后，打印延迟统计信息 </span>
</span></span><span style="display:flex;"><span>        --timeout     &lt;T&gt;  Socket/request timeout  <span style="color:#8f5902;font-style:italic"># 超时时间  </span>
</span></span><span style="display:flex;"><span>    -v, --version          Print version details <span style="color:#8f5902;font-style:italic"># 打印正在使用的wrk的详细版本信息</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Numeric arguments may include a SI unit <span style="color:#ce5c00;font-weight:bold">(</span>1k, 1M, 1G<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 代表数字参数，支持国际单位 (1k, 1M, 1G)</span>
</span></span><span style="display:flex;"><span>  Time arguments may include a <span style="color:#204a87">time</span> unit <span style="color:#ce5c00;font-weight:bold">(</span>2s, 2m, 2h<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 代表时间参数，支持时间单位 (2s, 2m, 2h)</span>
</span></span></code></pre></div><p>参数设置说明：</p>
<p>一般设置线程数t，并发数c，压测时间d，--latency四个通用的参数。</p>
<ul>
<li>
<p>线程数：一般设置为压测机器CPU核数的2-4倍，过大会导致线程切换频繁，效果下降。</p>
</li>
<li>
<p>并发数：根据压测结果，动态调整并发数使得压测达到瓶颈。</p>
</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wrk -t12 -c400 -d30s --latency http://www.baidu.com
</span></span></code></pre></div><h1 id="3-压测结果">3. 压测结果</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># wrk -t12 -c400 -d30s --latency http://www.baidu.com</span>
</span></span><span style="display:flex;"><span>Running 30s <span style="color:#204a87">test</span> @ http://www.baidu.com
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">12</span> threads and <span style="color:#0000cf;font-weight:bold">400</span> connections
</span></span><span style="display:flex;"><span>               （平均值） （标准差）  （最大值）（正负一个标准差所占比例）
</span></span><span style="display:flex;"><span>  Thread Stats   Avg      Stdev     Max   +/- Stdev
</span></span><span style="display:flex;"><span>    （延迟）
</span></span><span style="display:flex;"><span>    Latency   568.16ms  250.70ms   2.00s    83.49%
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">(</span>每秒请求数<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    Req/Sec    28.26     14.99    90.00     65.71%
</span></span><span style="display:flex;"><span>  Latency Distribution （延迟分布）
</span></span><span style="display:flex;"><span>     50%  530.91ms
</span></span><span style="display:flex;"><span>     75%  585.73ms
</span></span><span style="display:flex;"><span>     90%  691.64ms
</span></span><span style="display:flex;"><span>     99%    1.78s
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">9842</span> requests in 30.10s, 99.03MB <span style="color:#204a87">read</span>  <span style="color:#ce5c00;font-weight:bold">(</span>30.10s内处理了9842个请求，耗费流量99.03MB<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  Socket errors: connect 158, <span style="color:#204a87">read</span> 0, write 0, timeout <span style="color:#0000cf;font-weight:bold">580</span>  <span style="color:#ce5c00;font-weight:bold">(</span>发生错误数<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Requests/sec:    327.00  <span style="color:#ce5c00;font-weight:bold">(</span>QPS ,即平均每秒处理请求数<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Transfer/sec:      3.29MB  <span style="color:#ce5c00;font-weight:bold">(</span>平均每秒流量<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="4-lua脚本定制压测参数">4. Lua脚本定制压测参数</h1>
<p>例如：压测post请求，需要设置指定参数。</p>
<p>写入以下lua脚本，login.lua</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#000">wrk.method</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;POST&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">wrk.body</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;{&#34;username&#34;:&#34;xxx&#34;,&#34;password&#34;:&#34;xxx&#34;}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">wrk.headers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;application/x-www-form-urlencoded&#34;</span>
</span></span></code></pre></div><p>发起压测请求：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wrk -t12 -c1000 -d30s --latency  http://127.0.0.1:8081/login -s login.lua
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/wg/wrk">GitHub - wg/wrk: Modern HTTP benchmarking tool</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/quanxiaoha/p/10661650.html">https://www.cnblogs.com/quanxiaoha/p/10661650.html</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-47e00858ae348d66329dcfca96f7a676">4.5 - VLAN介绍</h1>
    
	<h1 id="1-vlan是什么">1. vlan是什么</h1>
<p>VLAN（Virtual Local Area Network）即虚拟局域网，是将一个物理的LAN在逻辑上划分成多个广播域的通信技术。每个VLAN是一个广播域，VLAN内的主机间可以直接通信，而VLAN间则不能直接互通。这样，广播报文就被限制在一个VLAN内。</p>
<h1 id="2-为什么需要vlan">2. 为什么需要vlan</h1>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1719749729/article/linux/network/vlan.webp" alt=""></p>
<p>没有vlan前，广播报文会被发送到较大的广播域，主机数量较多时候会造成广播泛滥，性能低下，网络不可用等问题。<strong>如果把一个LAN网分成多个逻辑LAN网，每个逻辑LAN网通过id进行标识，相同逻辑LAN内的主机可以直接通信，不同逻辑LAN网内的主机不能直接通信，那么广播报文就限制在一个逻辑LAN网内，而这个逻辑LAN就是所谓的VLAN。</strong></p>
<p>由此可见，VLAN有以下的优点：</p>
<ul>
<li>限制广播域：节省了带宽，提高网络处理效率。</li>
<li>增加安全性：不同VLAN互相隔离，增加安全性。</li>
<li>灵活构建局域网：可以方便的构建安全的局域网。</li>
</ul>
<h1 id="3-vlan-id及vlan-tag">3. vlan ID及vlan tag</h1>
<p>为了让交换机识别不同vlan的报文，则需要通过某种标识来区分，因此在报文中加了vlan tag的字段，其中包括vlan id的信息，</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1719751351/article/linux/network/vlan_tag.webp" alt=""></p>
<p><strong>Vlan id(简称VID)，取值范围为0-4095,0和4095为保留字段，因此VLAN ID的有效范围为1-4094。</strong></p>
<p>交换机内部处理的数据帧都带有VLAN标签。而交换机连接的部分设备（如用户主机、服务器）只会收发不带VLAN tag的传统以太网数据帧。因此，要与这些设备交互，就需要交换机的接口能够识别传统以太网数据帧，并在收发时给帧添加、剥除VLAN标签。添加什么VLAN标签，由接口上的缺省VLAN（Port Default VLAN ID，PVID）决定。</p>
<h1 id="4-vlan的接口类型">4. vlan的接口类型</h1>
<p>现网中属于同一个VLAN的用户可能会被连接在不同的交换机上，且跨越交换机的VLAN可能不止一个，如果需要用户间的互通，就需要交换机间的接口能够同时识别和发送多个VLAN的数据帧。根据接口连接对象以及对收发数据帧处理的不同，当前有VLAN的多种接口类型，以适应不同的连接和组网。</p>
<p>常见的VLAN接口类型有三种，包括：Access、Trunk和Hybrid。</p>
<h2 id="4-1-access接口-接入vlan">4.1. Access接口（接入VLAN）</h2>
<p>Access接口一般用于和不能识别Tag的用户终端（如用户主机、服务器）相连，或者不需要区分不同VLAN成员时使用。</p>
<p><strong>定义</strong>：Access VLAN接口是一种用于连接终端设备（如计算机、打印机等）的接口，每个接口只属于一个VLAN。</p>
<p><strong>使用场景</strong>：适用于接入层交换机端口，每个端口连接一个终端设备，只能传输单个VLAN的流量。例如，一个办公区域内的计算机都连接到Access VLAN，以便这些计算机能够互相通信。</p>
<h2 id="4-2-trunk接口-干线vlan">4.2. Trunk接口（干线VLAN）</h2>
<p>Trunk接口一般用于连接交换机、路由器、AP以及可同时收发Tagged帧和Untagged帧的语音终端。它可以允许多个VLAN的帧带Tag通过，但只允许属于缺省VLAN的帧从该类接口上发出时不带Tag（即剥除Tag）。</p>
<p><strong>定义</strong>：Trunk VLAN接口用于在交换机之间传输多个VLAN的流量。Trunk端口能够标记（tagging）VLAN信息，以便区分不同的VLAN流量。
<strong>使用场景</strong>：适用于交换机之间或交换机与路由器之间的连接，用于传输多VLAN流量。例如，在数据中心内，需要通过Trunk端口将多个VLAN的数据传输到核心交换机。</p>
<h2 id="4-3-hybrid接口-混合vlan">4.3. Hybrid接口（混合VLAN）</h2>
<p>Hybrid接口既可以用于连接不能识别Tag的用户终端（如用户主机、服务器）和网络设备（如Hub），也可以用于连接交换机、路由器以及可同时收发Tagged帧和Untagged帧的语音终端、AP。它可以允许多个VLAN的帧带Tag通过，且允许从该类接口发出的帧根据需要配置某些VLAN的帧带Tag（即不剥除Tag）、某些VLAN的帧不带Tag（即剥除Tag）。</p>
<p><strong>定义</strong>：Hybrid VLAN接口可以同时处理Access VLAN和Trunk VLAN的流量。它可以将未标记的流量作为Access VLAN流量处理，并将标记的流量作为Trunk VLAN流量处理。</p>
<p><strong>使用场景</strong>：适用于需要灵活配置的环境，既需要处理来自终端设备的单一VLAN流量，又需要处理来自交换机的多VLAN流量。例如，在一个网络中，需要同时连接计算机和其他交换机的端口可以配置为Hybrid VLAN。</p>
<p>参考：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/5wH9QbBTGKpYaolRbMijMA">https://mp.weixin.qq.com/s/5wH9QbBTGKpYaolRbMijMA</a></li>
<li><a href="https://www.wpgdadatong.com.cn/blog/detail/71784">https://www.wpgdadatong.com.cn/blog/detail/71784</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3c94e21a7f8d25dbd0f1027dd1ff8ac0">4.6 - netplan介绍</h1>
    
	<h1 id="1-netplan简介">1. netplan简介</h1>
<p><code>netplan</code>是一个linux<code>网络配置的渲染器</code>，可以通过创建一个网络配置的yaml文件，netplan将该文件渲染成linux network所需的配置。</p>
<h1 id="2-netplan原理">2. netplan原理</h1>
<p>netplan读取<code>/etc/netplan/*.yaml</code>的配置文件，Netplan在<code>/run</code>（例如：<code>/run/systemd/network/</code>）中生成特定于后端的配置文件，将设备的控制交给特定的网络守护进程。</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1721465066/article/linux/network/netplan.svg" width="30%" />
<h1 id="3-netplan配置">3. netplan配置</h1>
<p>具体的netplan配置可以参考：</p>
<ul>
<li><a href="https://netplan.readthedocs.io/en/stable/howto/">https://netplan.readthedocs.io/en/stable/howto/</a></li>
<li><a href="https://netplan.readthedocs.io/en/stable/netplan-yaml/">https://netplan.readthedocs.io/en/stable/netplan-yaml/</a></li>
</ul>
<p>通用配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">network</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NUMBER   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 必填</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">renderer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">STRING  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 必填  networkd（默认）或者NetworkManager</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ethernets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 网卡相关配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bonds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># bond相关配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vlans</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># VLAN相关配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bridges</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dummy-devices</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">modems</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">tunnels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">virtual-ethernets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vrfs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">wifis</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">nm-devices</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-1-使用直连网关配置">3.1. 使用直连网关配置</h2>
<p>具体可参考：https://netplan.readthedocs.io/en/stable/netplan-yaml/#routing</p>
<p>如果是没有bond设置及VLAN设置，则可用以下网关配置。</p>
<p>参数说明：</p>
<ul>
<li><code>addresses</code>：网卡的IP地址</li>
<li><code>routes</code> 路由地址，一般to后面对应0.0.0.0/0， via对应网关地址</li>
<li><code>dhcp4</code>：布尔类型，是否给IPv4开启DHCP，默认是false。</li>
<li><code>gateway4</code>: IPv4的网关地址，已经废弃，被routes参数取代。gateway4和route两者配置一个即可。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">network</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">renderer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">networkd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ethernets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">addresses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;192.168.10.1/24&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">to</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># or 0.0.0.0/0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">via</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9.9.9.9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">on-link</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>使用“on-link”关键字，其中网关是直接连接到网络的IP地址，即使该地址与接口上配置的子网不匹配。</p>
<h2 id="3-2-配置bond网卡">3.2. 配置bond网卡</h2>
<p>具体可参考：https://netplan.readthedocs.io/en/stable/netplan-yaml/#properties-for-device-type-bonds</p>
<p>如果有bond网卡则按以下的配置。</p>
<p>bond参数 parameters 说明：</p>
<ul>
<li><code>mode</code>:网卡的bond模式，包括<code>balance-rr</code>(默认，即轮询), <code>active-backup</code>（主备模式）, <code>balance-xor</code>, <code>broadcast</code>, <code>802.3ad</code>, <code>balance-tlb</code> , <code>balance-alb</code></li>
<li><code>mii-monitor-interval</code>：指定MII监控的间隔时间(检查绑定的接口是否有carrier)。默认值为0;这将禁用MII监控。这相当于网络后端的MIIMonitorSec=字段。如果没有指定时间后缀，该值将被解释为毫秒。</li>
<li><code>lacp-rate</code>：配置lacpdu的传输速率。这只在802.3ad模式下有用。可能的值是slow(默认为30秒)和fast(每秒)。</li>
<li><code>transmit-hash-policy</code>：指定端口选择的传输哈希策略。这只在balance-xor、802.3ad和balance-tlb模式下有用。取值为layer2、layer3+4、layer2+3、encap2+3、encap3+4。</li>
</ul>
<p>以下示例配置一个或多个bond网卡：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">network</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">renderer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">networkd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ethernets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens4</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bonds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bond0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># bond0 即网卡名称</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">interfaces</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 由哪几块网卡做的bond0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ens1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ens2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">addresses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;192.168.10.1/24&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 配置bond0网卡地址及路由</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">to</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># or 0.0.0.0/0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">via</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9.9.9.9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># bond相关参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;802.3ad&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mii-monitor-interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;100&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置 MII 链路监控间隔为 100 毫秒。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">lacp-rate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;fast&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置 LACP 速率为快速模式（每秒发送 LACPDU 数据包）。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">transmit-hash-policy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;layer3+4&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置传输散列策略为基于第3层和第4层（IP地址和端口）的负载均衡策略。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bond1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># bond1 即网卡名称</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">interfaces</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 由哪几块网卡做的bond1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ens3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ens4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">addresses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;192.168.10.2/24&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 配置bond1网卡地址及路由</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">to</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># or 0.0.0.0/0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">via</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9.9.9.9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># bond相关参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;802.3ad&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mii-monitor-interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;100&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">lacp-rate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;fast&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">transmit-hash-policy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;layer3+4&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="3-2-1-bond模式802-3ad说明">3.2.1. bond模式802.3ad说明</h3>
<p>在网络配置中，<code>bond</code>（又称为 <code>link aggregation</code> 或 <code>NIC teaming</code>）是将多个网络接口聚合成一个单一的逻辑接口，以提高带宽和提供冗余性。<code>bond</code>模式决定了这些接口如何协同工作。</p>
<p><code>mode: &quot;802.3ad&quot;</code> 是一种 <code>bond</code>模式，它遵循 IEEE 802.3ad 标准，也称为 <code>LACP</code>（Link Aggregation Control Protocol）。这个模式提供了一种动态协商机制，可以在多个网络接口之间聚合链路。</p>
<p><strong>802.3ad 模式的特点</strong></p>
<ul>
<li><strong>动态协商</strong>：使用 LACP 协议动态协商链路聚合，使多个网络接口协同工作。</li>
<li><strong>负载均衡</strong>：能够在多个链路上均衡负载，提高整体带宽。</li>
<li><strong>冗余性</strong>：在任何一个接口故障时，其他接口仍能继续工作，提供链路冗余。</li>
<li><strong>兼容性</strong>：需要交换机端也支持并配置 LACP 协议。</li>
</ul>
<p><strong>典型应用场景</strong></p>
<ul>
<li><strong>高带宽需求</strong>：需要聚合多个网络接口来提高带宽，例如服务器对网络带宽有较高要求的情况。</li>
<li><strong>高可用性需求</strong>：需要提供网络接口的冗余，确保网络连接的稳定性和可靠性。</li>
</ul>
<p><strong>常用的模式802.3ad配置</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># bond相关参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;802.3ad&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mii-monitor-interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;100&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置 MII 链路监控间隔为 100 毫秒。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">lacp-rate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;fast&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置 LACP 速率为快速模式（每秒发送 LACPDU 数据包）。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">transmit-hash-policy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;layer3+4&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置传输散列策略为基于第3层和第4层（IP地址和端口）的负载均衡策略。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>交换机配置要求</strong></p>
<p>为了使 <code>802.3ad</code> 模式正常工作，需要确保连接的交换机支持并配置了 LACP。通过这种配置，可以实现服务器端和交换机端的链路聚合，提供更高的带宽和冗余性。</p>
<h2 id="3-3-配置vlan">3.3. 配置VLAN</h2>
<p>具体可参考：https://netplan.readthedocs.io/en/stable/netplan-yaml/#properties-for-device-type-vlans</p>
<p>如果有配置VLAN ID则按以下配置，</p>
<p>VLAN参数说明：</p>
<ul>
<li><code>bond0.1000</code>：VLAN的网卡名称</li>
<li><code>id</code>：VLAN id</li>
<li><code>link</code>：链接的网卡名称，可以是实体网卡也可以是bond的网卡。</li>
</ul>
<p>以下示例配置一个或多个VLAN网卡。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">network</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">renderer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">networkd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ethernets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bonds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bond0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">interfaces</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ens1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ens2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;802.3ad&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mii-monitor-interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;100&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">lacp-rate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;fast&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">transmit-hash-policy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;layer3+4&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vlans</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bond0.1000</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">addresses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;192.168.10.1/24&#34;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">#配置 bond0.1000 的地址和路由</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">to</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;0.0.0.0/0&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">via</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;9.9.9.9&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># VLAN ID</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">link</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;bond0&#34;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 配置VLAN对应的网卡</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens3.2000</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">#多个VLAN的配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">addresses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;192.168.10.2/24&#34;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">#配置 bond0.1000 的地址和路由</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">to</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;0.0.0.0/0&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">via</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;9.9.9.9&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># VLAN ID</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">link</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ens3&#34;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 配置VLAN对应的网卡</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>总结上述三种情况下<code>addresses</code>和<code>routes</code>参数配置的地方：</p>
<ul>
<li>没有配置bond和VLAN，则addresses和routes参数配置在ethernets</li>
<li>如果没有配置VLAN，但是配置了bond，则配置在bond下</li>
<li>如果配置了VLAN，不论是否配置bond，都配置在VLAN下</li>
</ul>
<h1 id="4-netplan命令">4. netplan命令</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>netplan -h
</span></span><span style="display:flex;"><span>usage: /usr/sbin/netplan  <span style="color:#ce5c00;font-weight:bold">[</span>-h<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>--debug<span style="color:#ce5c00;font-weight:bold">]</span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Network configuration in YAML
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>options:
</span></span><span style="display:flex;"><span>  -h, --help  show this <span style="color:#204a87">help</span> message and <span style="color:#204a87">exit</span>
</span></span><span style="display:flex;"><span>  --debug     Enable debug messages
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available commands:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">help</span>      Show this <span style="color:#204a87">help</span> message
</span></span><span style="display:flex;"><span>    apply     Apply current netplan config to running system
</span></span><span style="display:flex;"><span>    generate  Generate backend specific configuration files from /etc/netplan/*.yaml
</span></span><span style="display:flex;"><span>    get       Get a setting by specifying a nested key like <span style="color:#4e9a06">&#34;ethernets.eth0.addresses&#34;</span>, or <span style="color:#4e9a06">&#34;all&#34;</span>
</span></span><span style="display:flex;"><span>    info      Show available features
</span></span><span style="display:flex;"><span>    ip        Retrieve IP information from the system
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">set</span>       Add new setting by specifying a dotted <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span>value pair like ethernets.eth0.dhcp4<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>    rebind    Rebind SR-IOV virtual functions of given physical functions to their driver
</span></span><span style="display:flex;"><span>    status    Query networking state of the running system
</span></span><span style="display:flex;"><span>    try       Try to apply a new netplan config to running system, with automatic rollback
</span></span></code></pre></div><h2 id="4-1-netplan-get">4.1. netplan get</h2>
<p>查询当前的配置内容：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ netplan get
</span></span><span style="display:flex;"><span>network:
</span></span><span style="display:flex;"><span>  version: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>  renderer: networkd
</span></span><span style="display:flex;"><span>  ethernets:
</span></span><span style="display:flex;"><span>    enp24s0f0: <span style="color:#ce5c00;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    enp24s0f1: <span style="color:#ce5c00;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>  bonds:
</span></span><span style="display:flex;"><span>    bond0:
</span></span><span style="display:flex;"><span>      interfaces:
</span></span><span style="display:flex;"><span>      - enp24s0f1
</span></span><span style="display:flex;"><span>      - enp24s0f0
</span></span><span style="display:flex;"><span>      parameters:
</span></span><span style="display:flex;"><span>        mode: <span style="color:#4e9a06">&#34;802.3ad&#34;</span>
</span></span><span style="display:flex;"><span>        mii-monitor-interval: <span style="color:#4e9a06">&#34;100&#34;</span>
</span></span><span style="display:flex;"><span>        lacp-rate: <span style="color:#4e9a06">&#34;fast&#34;</span>
</span></span><span style="display:flex;"><span>        transmit-hash-policy: <span style="color:#4e9a06">&#34;layer3+4&#34;</span>
</span></span><span style="display:flex;"><span>  vlans:
</span></span><span style="display:flex;"><span>    bond0.1000:
</span></span><span style="display:flex;"><span>      addresses:
</span></span><span style="display:flex;"><span>      - <span style="color:#4e9a06">&#34;a.x.x.x/26&#34;</span>
</span></span><span style="display:flex;"><span>      dhcp4: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>      routes:
</span></span><span style="display:flex;"><span>      - to: <span style="color:#4e9a06">&#34;0.0.0.0/0&#34;</span>
</span></span><span style="display:flex;"><span>        via: <span style="color:#4e9a06">&#34;b.x.x.x&#34;</span>
</span></span><span style="display:flex;"><span>      id: <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>      link: <span style="color:#4e9a06">&#34;bond0&#34;</span>
</span></span></code></pre></div><h2 id="4-2-netplan-apply">4.2. netplan apply</h2>
<p>通过编辑/etc/netplan/*.yaml的文件，再执行<code>netplan apply</code>的命令可以使得网络配置生效。</p>
<h1 id="5-systemd-networkd">5. Systemd-networkd</h1>
<p>可以通过<code>man systemd-networkd</code>查看说明</p>
<ul>
<li>
<p>systemd-networkd是一种管理网络的系统服务。它检测和配置网络设备，以及创建虚拟网络设备。</p>
</li>
<li>
<p>systemd-networkd将根据systemd.netdev文件中的配置创建网络设备，并遵守这些文件中的[Match]部分。</p>
</li>
<li>
<p>当systemd-networkd退出时，它通常会保留现有的网络设备和配置不变。当配置更新并重新启动systemd-networkd时，netdev已删除配置的接口不会被删除，可能需要手动清理。</p>
</li>
<li>
<p>systemd-networkd可以在运行时使用<code>networkctl</code>进行控制。</p>
</li>
</ul>
<h2 id="5-1-配置文件">5.1. 配置文件</h2>
<p>systemd-networkd的配置文件位于<code>/run/systemd/network</code>，部分配置在<code>/etc/systemd/network</code>下。</p>
<p>主要配置文件路径和用途</p>
<ol>
<li><strong><code>.network</code> 文件</strong>：定义网络接口的配置。
<ul>
<li>路径：<code>/run/systemd/network/*.network</code></li>
<li>用途：配置网络接口的 IP 地址、网关、DNS 等。</li>
</ul>
</li>
<li><strong><code>.link</code> 文件</strong>：定义网络接口的属性，如名称、MAC 地址等。
<ul>
<li>路径：<code>/etc/systemd/network/*.link</code></li>
<li>用途：配置网络接口的属性，比如名称、MAC 地址、MTU 等。</li>
</ul>
</li>
<li><strong><code>.netdev</code> 文件</strong>：定义虚拟网络设备（例如 bridge、bond、vlan 等）的配置。
<ul>
<li>路径：<code>/run/systemd/network/*.netdev</code></li>
<li>用途：配置虚拟网络设备。</li>
</ul>
</li>
</ol>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cat  10-netplan-bond0.netdev</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">NetDev]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Name=bond0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Kind=bond</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Bond]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Mode=802.3ad</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LACPTransmitRate=fast</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">MIIMonitorSec=100ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">TransmitHashPolicy=layer3+4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># cat  10-netplan-bond0.network</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Match]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Name=bond0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Network]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LinkLocalAddressing=ipv6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ConfigureWithoutCarrier=yes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">VLAN=bond0.1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#cat  10-netplan-bond0.1000.network</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Match]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Name=bond0.1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Network]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LinkLocalAddressing=ipv6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Address=192.168.0.1/26</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ConfigureWithoutCarrier=yes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Route]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Destination=0.0.0.0/0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Gateway=9.9.9.9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># cat  10-netplan-bond0.1000.netdev</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">NetDev]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Name=bond0.1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Kind=vlan</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">VLAN]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Id=1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="5-2-netdev参数说明">5.2. netdev参数说明</h2>
<p>netdev的参数可以参考：https://manpages.ubuntu.com/manpages/bionic/man5/systemd.netdev.5.html</p>
<p><strong>bond部分的参数说明：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>       The <span style="color:#4e9a06">&#34;[Bond]&#34;</span> section accepts the following key:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">Mode</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>           Specifies one of the bonding policies. The default is <span style="color:#4e9a06">&#34;balance-rr&#34;</span> <span style="color:#ce5c00;font-weight:bold">(</span>round robin<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>           Possible values are <span style="color:#4e9a06">&#34;balance-rr&#34;</span>, <span style="color:#4e9a06">&#34;active-backup&#34;</span>, <span style="color:#4e9a06">&#34;balance-xor&#34;</span>, <span style="color:#4e9a06">&#34;broadcast&#34;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#4e9a06">&#34;802.3ad&#34;</span>, <span style="color:#4e9a06">&#34;balance-tlb&#34;</span>, and <span style="color:#4e9a06">&#34;balance-alb&#34;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">TransmitHashPolicy</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>           Selects the transmit <span style="color:#204a87">hash</span> policy to use <span style="color:#204a87;font-weight:bold">for</span> slave selection in balance-xor, 802.3ad,
</span></span><span style="display:flex;"><span>           and tlb modes. Possible values are <span style="color:#4e9a06">&#34;layer2&#34;</span>, <span style="color:#4e9a06">&#34;layer3+4&#34;</span>, <span style="color:#4e9a06">&#34;layer2+3&#34;</span>, <span style="color:#4e9a06">&#34;encap2+3&#34;</span>, and
</span></span><span style="display:flex;"><span>           <span style="color:#4e9a06">&#34;encap3+4&#34;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">LACPTransmitRate</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>           Specifies the rate with which link partner transmits Link Aggregation Control Protocol
</span></span><span style="display:flex;"><span>           Data Unit packets in 802.3ad mode. Possible values are <span style="color:#4e9a06">&#34;slow&#34;</span>, which requests partner
</span></span><span style="display:flex;"><span>           to transmit LACPDUs every <span style="color:#0000cf;font-weight:bold">30</span> seconds, and <span style="color:#4e9a06">&#34;fast&#34;</span>, which requests partner to transmit
</span></span><span style="display:flex;"><span>           LACPDUs every second. The default value is <span style="color:#4e9a06">&#34;slow&#34;</span>.
</span></span></code></pre></div><p><strong>vlan部分说明：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>       The <span style="color:#4e9a06">&#34;[VLAN]&#34;</span> section only applies <span style="color:#204a87;font-weight:bold">for</span> netdevs of kind <span style="color:#4e9a06">&#34;vlan&#34;</span>, and accepts the following
</span></span><span style="display:flex;"><span>       key:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">Id</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>           The VLAN ID to use. An integer in the range 0–4094. This option is compulsory.
</span></span></code></pre></div><h1 id="6-networkctl命令">6. networkctl命令</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># networkctl -h</span>
</span></span><span style="display:flex;"><span>networkctl <span style="color:#ce5c00;font-weight:bold">[</span>OPTIONS...<span style="color:#ce5c00;font-weight:bold">]</span> COMMAND
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Query and control the networking subsystem.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Commands:
</span></span><span style="display:flex;"><span>  list <span style="color:#ce5c00;font-weight:bold">[</span>PATTERN...<span style="color:#ce5c00;font-weight:bold">]</span>      List links
</span></span><span style="display:flex;"><span>  status <span style="color:#ce5c00;font-weight:bold">[</span>PATTERN...<span style="color:#ce5c00;font-weight:bold">]</span>    Show link status
</span></span><span style="display:flex;"><span>  lldp <span style="color:#ce5c00;font-weight:bold">[</span>PATTERN...<span style="color:#ce5c00;font-weight:bold">]</span>      Show LLDP neighbors
</span></span><span style="display:flex;"><span>  label                  Show current address label entries in the kernel
</span></span><span style="display:flex;"><span>  delete DEVICES...      Delete virtual netdevs
</span></span><span style="display:flex;"><span>  up DEVICES...          Bring devices up
</span></span><span style="display:flex;"><span>  down DEVICES...        Bring devices down
</span></span><span style="display:flex;"><span>  renew DEVICES...       Renew dynamic configurations
</span></span><span style="display:flex;"><span>  forcerenew DEVICES...  Trigger DHCP reconfiguration of all connected clients
</span></span><span style="display:flex;"><span>  reconfigure DEVICES... Reconfigure interfaces
</span></span><span style="display:flex;"><span>  reload                 Reload .network and .netdev files
</span></span><span style="display:flex;"><span>  edit FILES<span style="color:#000;font-weight:bold">|</span>DEVICES...  Edit network configuration files
</span></span><span style="display:flex;"><span>  cat FILES<span style="color:#000;font-weight:bold">|</span>DEVICES...   Show network configuration files
</span></span></code></pre></div><h2 id="6-1-networkctl-status">6.1. networkctl status</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># networkctl status</span>
</span></span><span style="display:flex;"><span>● Interfaces: 8, 9, 7, 6, 5, 4, 3, 2, <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>       State: routable
</span></span><span style="display:flex;"><span>Online state: online
</span></span><span style="display:flex;"><span>     Address: 192.168.0.1 on bond0.1000
</span></span><span style="display:flex;"><span>              xxxx::4c0e:43ff:feba:xxxx on bond0
</span></span><span style="display:flex;"><span>              xxxx::4c0e:43ff:feba:xxxx on bond0.1000
</span></span><span style="display:flex;"><span>     Gateway: 9.9.9.9 on bond0.1000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:16 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0.1000: netdev ready
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:16 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: eno5: Gained carrier
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:16 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0.1000: Configuring with /run/systemd/network/10-netplan-bond0.1000.network.
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:16 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0.1000: Link UP
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:16 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0: Gained carrier
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:16 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0.1000: Gained carrier
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:17 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: eno6: Gained carrier
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:17 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0.1000: Gained IPv6LL
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:18 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0: Gained IPv6LL
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:18 192.168.0.1 systemd<span style="color:#ce5c00;font-weight:bold">[</span>1<span style="color:#ce5c00;font-weight:bold">]</span>: Finished systemd-networkd-wait-online.service - Wait <span style="color:#204a87;font-weight:bold">for</span> Network to be Configured.
</span></span></code></pre></div><h2 id="6-2-networkctl-list">6.2. networkctl list</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># networkctl list</span>
</span></span><span style="display:flex;"><span>IDX LINK       TYPE     OPERATIONAL SETUP
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">1</span> lo         loopback carrier     unmanaged
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2</span> eno1       ether    off         unmanaged
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">3</span> eno2       ether    off         unmanaged
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">4</span> eno3       ether    off         unmanaged
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">5</span> eno4       ether    off         unmanaged
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">6</span> eno5       ether    enslaved    configured
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">7</span> eno6       ether    enslaved    configured
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">8</span> bond0      bond     degraded    configured
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">9</span> bond0.1000 vlan     routable    configured
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">9</span> links listed.
</span></span></code></pre></div><h1 id="7-总结">7. 总结</h1>
<p>本文大概介绍了netplan和systemd-networkd两个模块，其中systemd-networkd是主要负责linux机器上的网络管理的后台进程。可以通过networkctl的命令行进行配置和查看。而netplan则是一个网络配置模板渲染工具，通过yaml文件可以生成systemd-networkd所使用的配置文件。其中netplan的配置文件位于<code>/etc/netplan/</code>目录，而systemd-networkd的配置文件为<code>/run/systemd/network</code>目录。两者的配置参数几乎是一一对应的，通过配置netplan的参数则可以配置systemd-networkd的参数。</p>
<p>参考：</p>
<ul>
<li><a href="https://netplan.io/">https://netplan.io/</a></li>
<li><a href="https://netplan.readthedocs.io/en/stable/netplan-yaml/">https://netplan.readthedocs.io/en/stable/netplan-yaml/</a></li>
<li><a href="https://netplan.readthedocs.io/en/stable/netplan-yaml/#routing">https://netplan.readthedocs.io/en/stable/netplan-yaml/#routing</a></li>
<li><a href="https://netplan.readthedocs.io/en/stable/netplan-yaml/#properties-for-device-type-bonds">https://netplan.readthedocs.io/en/stable/netplan-yaml/#properties-for-device-type-bonds</a></li>
<li><a href="https://netplan.readthedocs.io/en/stable/netplan-yaml/#properties-for-device-type-vlans">https://netplan.readthedocs.io/en/stable/netplan-yaml/#properties-for-device-type-vlans</a></li>
<li><a href="http://manpages.ubuntu.com/manpages/bionic/man5/systemd.network.5.html">Systemd-networkd</a></li>
<li><a href="https://manpages.ubuntu.com/manpages/bionic/man5/systemd.netdev.5.html">https://manpages.ubuntu.com/manpages/bionic/man5/systemd.netdev.5.html</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6b897bd3369333340265bef5a501a17a">4.7 - 网卡Bonding介绍</h1>
    
	<h1 id="1-概述">1. 概述</h1>
<p>网络接口绑定（Network Interface Bonding），也称为链路聚合（Link Aggregation）或NIC Teaming，是将多个物理网络接口聚合成一个逻辑接口，以提高带宽和提供冗余性的技术。这种技术广泛应用于服务器和高性能计算环境中，以确保网络的高可用性和高性能。</p>
<h1 id="2-优势">2. 优势</h1>
<ol>
<li><strong>增加带宽</strong>：通过聚合多个网络接口，整体带宽增加，从而提升网络吞吐量。</li>
<li><strong>高可用性</strong>：在一个接口发生故障时，其他接口可以继续工作，确保网络连接的连续性。</li>
<li><strong>负载均衡</strong>：数据流量可以在多个接口之间均衡分配，避免单一接口成为瓶颈。</li>
<li><strong>简化管理</strong>：将多个接口管理为一个逻辑接口，简化了网络配置和管理。</li>
</ol>
<h1 id="3-bonding-模式">3. Bonding 模式</h1>
<p>Linux 支持多种 Bonding 模式，每种模式都有其独特的特点和应用场景：</p>
<ol>
<li><strong>mode=0 (balance-rr)</strong>：循环方式（Round-robin），每个数据包依次从每个接口发送。提供负载均衡和容错功能。</li>
<li><strong>mode=1 (active-backup)</strong>：主备模式（Active-backup），一个接口为主接口，其他接口为备份接口。当主接口失败时，备份接口接管。提供高可用性。</li>
<li><strong>mode=2 (balance-xor)</strong>：根据传输散列算法选择接口。提供负载均衡和容错功能。</li>
<li><strong>mode=3 (broadcast)</strong>：广播模式，所有数据包通过所有接口发送。提供容错功能。</li>
<li><strong>mode=4 (802.3ad)</strong>：动态链路聚合（LACP），需要交换机支持 IEEE 802.3ad。提供负载均衡和高可用性。</li>
<li><strong>mode=5 (balance-tlb)</strong>：基于发送负载的自适应传输负载均衡（Adaptive Transmit Load Balancing）。无需特殊交换机支持。</li>
<li><strong>mode=6 (balance-alb)</strong>：基于接收负载的自适应负载均衡（Adaptive Load Balancing）。无需特殊交换机支持。</li>
</ol>
<h1 id="4-配置示例">4. 配置示例</h1>
<p>以下是使用 <code>systemd-networkd</code> 配置 Bonding 的示例。</p>
<h2 id="4-1-配置物理接口">4.1. 配置物理接口</h2>
<p>首先，配置要绑定的物理接口。例如，<code>enp26s0f0</code> 和 <code>enp26s0f1</code>：</p>
<p>创建文件 <code>/etc/systemd/network/10-enp26s0f0.network</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Match<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Name</span><span style="color:#ce5c00;font-weight:bold">=</span>enp26s0f0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Network<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Bond</span><span style="color:#ce5c00;font-weight:bold">=</span>bond0
</span></span></code></pre></div><p>创建文件 <code>/etc/systemd/network/10-enp26s0f1.network</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Match<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Name</span><span style="color:#ce5c00;font-weight:bold">=</span>enp26s0f1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Network<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Bond</span><span style="color:#ce5c00;font-weight:bold">=</span>bond0
</span></span></code></pre></div><h2 id="4-2-配置-bonding-接口">4.2. 配置 Bonding 接口</h2>
<p>创建文件 <code>/etc/systemd/network/bond0.netdev</code> 来定义 Bonding 接口：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>NetDev<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Name</span><span style="color:#ce5c00;font-weight:bold">=</span>bond0
</span></span><span style="display:flex;"><span><span style="color:#000">Kind</span><span style="color:#ce5c00;font-weight:bold">=</span>bond
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Bond<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Mode</span><span style="color:#ce5c00;font-weight:bold">=</span>802.3ad
</span></span><span style="display:flex;"><span><span style="color:#000">MIIMonitorSec</span><span style="color:#ce5c00;font-weight:bold">=</span>1s
</span></span><span style="display:flex;"><span><span style="color:#000">LACPTransmitRate</span><span style="color:#ce5c00;font-weight:bold">=</span>fast
</span></span></code></pre></div><h2 id="4-3-配置-bonding-接口的网络设置">4.3. 配置 Bonding 接口的网络设置</h2>
<p>创建文件 <code>/etc/systemd/network/10-bond0.network</code> 来配置 Bonding 接口的网络设置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Match<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Name</span><span style="color:#ce5c00;font-weight:bold">=</span>bond0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Network<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Address</span><span style="color:#ce5c00;font-weight:bold">=</span>192.168.1.10/24
</span></span><span style="display:flex;"><span><span style="color:#000">Gateway</span><span style="color:#ce5c00;font-weight:bold">=</span>192.168.1.1
</span></span><span style="display:flex;"><span><span style="color:#000">DNS</span><span style="color:#ce5c00;font-weight:bold">=</span>8.8.8.8
</span></span><span style="display:flex;"><span><span style="color:#000">DNS</span><span style="color:#ce5c00;font-weight:bold">=</span>8.8.4.4
</span></span></code></pre></div><h2 id="4-4-应用配置">4.4. 应用配置</h2>
<p>保存配置文件后，重新启动 <code>systemd-networkd</code> 服务以应用新的网络配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl restart systemd-networkd
</span></span></code></pre></div><h2 id="4-5-检查配置">4.5. 检查配置</h2>
<p>或者查看具体接口的详细信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># networkctl status bond0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>● 8: bond0
</span></span><span style="display:flex;"><span>                   Link File: /usr/lib/systemd/network/99-default.link
</span></span><span style="display:flex;"><span>                Network File: /run/systemd/network/10-netplan-bond0.network
</span></span><span style="display:flex;"><span>                       State: degraded <span style="color:#ce5c00;font-weight:bold">(</span>configured<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                Online state: online
</span></span><span style="display:flex;"><span>                        Type: bond
</span></span><span style="display:flex;"><span>                        Kind: bond
</span></span><span style="display:flex;"><span>                      Driver: bonding
</span></span><span style="display:flex;"><span>            Hardware Address: 4e:0e:43:ba:f7:82
</span></span><span style="display:flex;"><span>                         MTU: <span style="color:#0000cf;font-weight:bold">1500</span> <span style="color:#ce5c00;font-weight:bold">(</span>min: 68, max: 65535<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                       QDisc: noqueue
</span></span><span style="display:flex;"><span>IPv6 Address Generation Mode: eui64
</span></span><span style="display:flex;"><span>                        Mode: 802.3ad
</span></span><span style="display:flex;"><span>                      Miimon: 100ms
</span></span><span style="display:flex;"><span>                     Updelay: <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>                   Downdelay: <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    Number of Queues <span style="color:#ce5c00;font-weight:bold">(</span>Tx/Rx<span style="color:#ce5c00;font-weight:bold">)</span>: 16/16
</span></span><span style="display:flex;"><span>            Auto negotiation: no
</span></span><span style="display:flex;"><span>                       Speed: 20Gbps
</span></span><span style="display:flex;"><span>                      Duplex: full
</span></span><span style="display:flex;"><span>                     Address: xxx::4c0e:43ff:feba:xxx
</span></span><span style="display:flex;"><span>           Activation Policy: up
</span></span><span style="display:flex;"><span>         Required For Online: yes
</span></span><span style="display:flex;"><span>           DHCP6 Client DUID: DUID-EN/Vendor:0000ab111fbd6366525ac0ea
</span></span></code></pre></div><h1 id="5-通过命令配置bond">5. 通过命令配置bond</h1>
<h2 id="5-1-通过ip命令做bond">5.1. 通过IP命令做bond</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装必要的软件包</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get install -y ifenslave
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 Bond 接口</span>
</span></span><span style="display:flex;"><span>sudo ip link add bond0 <span style="color:#204a87">type</span> bond
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置 Bond 模式</span>
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> bond0 <span style="color:#204a87">type</span> bond mode 802.3ad
</span></span><span style="display:flex;"><span>或者
</span></span><span style="display:flex;"><span>modprobe bonding <span style="color:#000">mode</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000">miimon</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#000">lacp_rate</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000">xmit_hash_policy</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加从接口到 Bond 接口</span>
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> enp26s0f0 down
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> enp26s0f0 master bond0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> enp26s0f1 down
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> enp26s0f1 master bond0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 配置 Bond 接口的 IP 地址</span>
</span></span><span style="display:flex;"><span>sudo ip addr add 192.168.1.10/24 dev bond0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启用 Bond 接口</span>
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> bond0 up
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启用从接口</span>
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> enp26s0f0 up
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> enp26s0f1 up
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Bond 接口配置完成&#34;</span>
</span></span></code></pre></div><p>查看bond状态</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /proc/net/bonding/bond0
</span></span></code></pre></div><blockquote>
<p>使用 modprobe 工具配置网络接口的 Bond（绑定）操作是另一种在 Linux 上设置链路聚合的方法。modprobe 用于加载和卸载内核模块，而 bonding 模块是用于实现网络接口绑定的内核模块。</p>
</blockquote>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f6a2843e805577065b3bd6954dcad95b">5 - Shell脚本</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1c9274495cca8d3f7a2a4cdfef52cf76">5.1 - Shell简介</h1>
    
	<h1 id="1-shell简介">1. shell简介</h1>
<p><code>shell</code>是用户和Linux内核之间的一层代理，解释用户输入的命令，传递给内核。</p>
<p>shell是一种脚本语言（解释性语言）。</p>
<p>Shell既是一种命令语言，又是一种程序设计语言。作为命令语言，它交互式地解释和执行用户输入的命令；作为程序设计语言，它定义了各种变量和参数，并提供了许多在高级语言中才具有的控制结构，包括循环和分支。</p>
<p><strong>Shell有两种执行命令的方式：</strong></p>
<ul>
<li>交互式（Interactive）：解释执行用户的命令，用户输入一条命令，Shell就解释执行一条。</li>
<li>批处理（Batch）：用户事先写一个Shell脚本(Script)，其中有很多条命令，让Shell一次把这些命令执行完，而不必一条一条地敲命令。</li>
</ul>
<p>Shell脚本和编程语言很相似，也有变量和流程控制语句，但Shell脚本是解释执行的，不需要编译，Shell程序从脚本中一行一行读取并执行这些命令，相当于一个用户把脚本中的命令一行一行敲到Shell提示符下执行。</p>
<p>Unix/Linux上常见的Shell脚本解释器有bash、sh、csh、ksh等，习惯上把它们称作一种Shell。</p>
<p>程序设计语言可以分为两类：编译型语言和解释型语言。</p>
<h2 id="1-1-编译型语言">1.1. 编译型语言</h2>
<p>很多传统的程序设计语言，例如Fortran、Ada、Pascal、C、C++和Java，都是编译型语言。这类语言需要预先将我们写好的源代码(source code)转换成目标代码(object code)，这个过程被称作“编译”。运行程序时，直接读取目标代码(object code)。由于编译后的目标代码(object code)非常接近计算机底层，因此执行效率很高，这是编译型语言的优点。</p>
<p>编译型语言多半运作于底层，所处理的是字节、整数、浮点数或是其他机器层级的对象，往往实现一个简单的功能需要大量复杂的代码。</p>
<h2 id="1-2-解释型语言">1.2. 解释型语言</h2>
<p>有的语言（例如： Shell、JavaScript、Python、PHP等）需要一边执行一边翻译，不会产生任何可执行文件，用户需要拿到源码才能运行程序。程序运行后会即时翻译，翻译一部分执行一部分，并不用等所有代码翻译完。</p>
<p>这个过程叫<code>解释</code>，这类语言叫<code>解释型语言</code>或<code>脚本语言</code>，完成解释过程的软件叫<code>解释器</code>。</p>
<p>解释型语言也被称作“脚本语言”。因为每次执行程序都多了编译的过程，因此效率有所下降。</p>
<p>使用脚本编程语言的好处是，它们多半运行在比编译型语言还高的层级，能够轻易处理文件与目录之类的对象；缺点是它们的效率通常不如编译型语言。</p>
<p>脚本编程语言的例子有awk、Perl、Python、Ruby与Shell。</p>
<h1 id="2-常见的shell类型">2. 常见的Shell类型</h1>
<table>
<thead>
<tr>
<th>shell类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>sh</td>
<td>sh 是 UNIX 上的标准 shell，很多 UNIX 版本都配有 sh。</td>
</tr>
<tr>
<td>bash</td>
<td>bash shell 是 Linux 的默认 shell，bash 兼容 sh，但并不完全一致。</td>
</tr>
<tr>
<td>csh</td>
<td>语法有点类似C语言。</td>
</tr>
<tr>
<td>...</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="2-1-查看shell">2.1. 查看shell</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cat /etc/shells
</span></span><span style="display:flex;"><span>/bin/sh
</span></span><span style="display:flex;"><span>/bin/bash
</span></span><span style="display:flex;"><span>/sbin/nologin
</span></span><span style="display:flex;"><span>/usr/bin/sh
</span></span><span style="display:flex;"><span>/usr/bin/bash
</span></span><span style="display:flex;"><span>/usr/sbin/nologin
</span></span><span style="display:flex;"><span>/bin/tcsh
</span></span><span style="display:flex;"><span>/bin/csh
</span></span></code></pre></div><p>查看默认shell</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#204a87">echo</span> <span style="color:#000">$SHELL</span>
</span></span><span style="display:flex;"><span>/bin/bash
</span></span></code></pre></div><p>sh 一般被 bash 代替，<code>/bin/sh</code>往往是指向<code>/bin/bash</code>的符号链接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -l /bin/sh
</span></span><span style="display:flex;"><span>lrwxrwxrwx. <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">4</span> Mar  <span style="color:#0000cf;font-weight:bold">8</span>  <span style="color:#0000cf;font-weight:bold">2018</span> /bin/sh -&gt; bash
</span></span></code></pre></div><h1 id="3-使用shell场景">3. 使用shell场景</h1>
<p>之所以要使用Shell脚本是基于：</p>
<ul>
<li>简单性：Shell是一个高级语言；通过它，你可以简洁地表达复杂的操作。</li>
<li>可移植性：使用POSIX所定义的功能，可以做到脚本无须修改就可在不同的系统上执行。</li>
<li>开发容易：可以在短时间内完成一个功能强大又妤用的脚本。</li>
</ul>
<p>但是，考虑到Shell脚本的命令限制和效率问题，下列情况一般不使用Shell：</p>
<ol>
<li>资源密集型的任务，尤其在需要考虑效率时（比如，排序，hash等等）。</li>
<li>需要处理大任务的数学操作，尤其是浮点运算，精确运算，或者复杂的算术运算（这种情况一般使用C++或FORTRAN 来处理）。</li>
<li>有跨平台（操作系统）移植需求（一般使用C 或Java）。</li>
<li>复杂的应用，在必须使用结构化编程的时候（需要变量的类型检查，函数原型，等等）。</li>
<li>对于影响系统全局性的关键任务应用。</li>
<li>对于安全有很高要求的任务，比如你需要一个健壮的系统来防止入侵、破解、恶意破坏等等。</li>
<li>项目由连串的依赖的各个部分组成。</li>
<li>需要大规模的文件操作。</li>
<li>需要多维数组的支持。</li>
<li>需要数据结构的支持，比如链表或数等数据结构。</li>
<li>需要产生或操作图形化界面 GUI。</li>
<li>需要直接操作系统硬件。</li>
<li>需要 I/O 或socket 接口。</li>
<li>需要使用库或者遗留下来的老代码的接口。</li>
<li>私人的、闭源的应用（shell 脚本把代码就放在文本文件中，全世界都能看到）。</li>
</ol>
<h1 id="4-shell脚本">4. shell脚本</h1>
<p>打开文本编辑器，新建一个文件，扩展名为sh（sh代表shell），扩展名并不影响脚本执行，见名知意就好，如果你用php写shell 脚本，扩展名就用php好了。</p>
<p>输入一些代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Hello World !&#34;</span>
</span></span></code></pre></div><p><strong>“#!” 是一个约定的标记，它告诉系统这个脚本需要什么解释器来执行，即使用哪一种Shell</strong>。echo命令用于向窗口输出文本。</p>
<h1 id="5-运行shell">5. 运行shell</h1>
<p>运行Shell脚本有两种方法。</p>
<h2 id="5-1-作为可执行程序">5.1. 作为可执行程序</h2>
<p>将上面的代码保存为test.sh，并 cd 到相应目录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod +x ./test.sh  <span style="color:#8f5902;font-style:italic">#使脚本具有执行权限</span>
</span></span><span style="display:flex;"><span>./test.sh  <span style="color:#8f5902;font-style:italic">#执行脚本</span>
</span></span></code></pre></div><p>注意，一定要写成./test.sh，而不是test.sh。运行其它二进制的程序也一样，直接写test.sh，linux系统会去PATH里寻找有没有叫test.sh的，而只有/bin, /sbin, /usr/bin，/usr/sbin等在PATH里，你的当前目录通常不在PATH里，所以写成test.sh是会找不到命令的，要用./test.sh告诉系统说，就在当前目录找。</p>
<h2 id="5-2-作为解释器参数">5.2. 作为解释器参数</h2>
<p>这种运行方式是，直接运行解释器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用 sh 解释器</span>
</span></span><span style="display:flex;"><span>sh test.sh
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用 bash 解释器</span>
</span></span><span style="display:flex;"><span>bash test.sh
</span></span></code></pre></div><p>这种方式运行的脚本，不需要在第一行指定解释器信息，写了也没用。</p>
<p>参考：</p>
<ul>
<li><a href="http://c.biancheng.net/cpp/shell/">http://c.biancheng.net/cpp/shell/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-13fe6aa636c36aafc0610e9e5bafe6dd">5.2 - Shell变量</h1>
    
	<h1 id="1-shell变量">1. shell变量</h1>
<p>Shell支持自定义变量。</p>
<h2 id="1-1-定义变量">1.1. 定义变量</h2>
<p>定义变量时，变量名不加美元符号<code>（$）</code>，如：</p>
<pre tabindex="0"><code>variableName=&#34;value&#34;
</code></pre><p>注意，<strong>变量名和等号之间不能有空格</strong>，这可能和你熟悉的所有编程语言都不一样。同时，变量名的命名须遵循如下规则：</p>
<ul>
<li>首个字符必须为字母（a-z，A-Z）。</li>
<li>中间不能有空格，可以使用下划线（_）。</li>
<li>不能使用标点符号。</li>
<li>不能使用bash里的关键字（可用help命令查看保留关键字）。</li>
</ul>
<h2 id="1-2-使用变量">1.2. 使用变量</h2>
<p>使用一个定义过的变量，只要在变量名前面加美元符号（$）即可，如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">your_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;mozhiyan&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#000">$your_name</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">${</span><span style="color:#000">your_name</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><p>变量名外面的花括号是可选的，加不加都行，，比如下面这种情况：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> skill in Ada Coffe Action Java 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;I am good at </span><span style="color:#4e9a06">${</span><span style="color:#000">skill</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">Script&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><p>如果不给skill变量加花括号，写成echo &quot;I am good at $skillScript&quot;，解释器就会把$skillScript当成一个变量（其值为空），代码执行结果就不是我们期望的样子了。推荐给所有变量加上花括号，这是个好的编程习惯。</p>
<h2 id="1-3-重新定义变量">1.3. 重新定义变量</h2>
<p>已定义的变量，可以被重新定义，如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">myUrl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;http://see.xidian.edu.cn/cpp/linux/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">${</span><span style="color:#000">myUrl</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">myUrl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;http://see.xidian.edu.cn/cpp/shell/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">${</span><span style="color:#000">myUrl</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><p>这样写是合法的，但注意，第二次赋值的时候不能写 $myUrl=&quot;http://see.xidian.edu.cn/cpp/shell/&quot;， 使用变量的时候才加美元符（$）。</p>
<h2 id="1-4-只读变量">1.4. 只读变量</h2>
<p>使用 <strong>readonly</strong> 命令可以将变量定义为只读变量，只读变量的值不能被改变。</p>
<p>下面的例子尝试更改只读变量，结果报错：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">myUrl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;http://see.xidian.edu.cn/cpp/shell/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">readonly</span> myUrl
</span></span><span style="display:flex;"><span><span style="color:#000">myUrl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;http://see.xidian.edu.cn/cpp/danpianji/&#34;</span>
</span></span></code></pre></div><p>运行脚本，结果如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/bin/sh: NAME: This variable is <span style="color:#204a87">read</span> only.
</span></span></code></pre></div><h2 id="1-5-删除变量">1.5. 删除变量</h2>
<p>使用 <strong>unset</strong> 命令可以删除变量。语法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">unset</span> variable_name
</span></span></code></pre></div><p>变量被删除后不能再次使用；unset 命令不能删除只读变量。</p>
<p>举个例子：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">myUrl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;http://see.xidian.edu.cn/cpp/u/xitong/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">unset</span> myUrl
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#000">$myUrl</span>
</span></span></code></pre></div><p>上面的脚本没有任何输出。</p>
<h2 id="1-6-变量类型">1.6. 变量类型</h2>
<p>运行shell时，会同时存在三种变量：</p>
<h3 id="1-局部变量">1) 局部变量</h3>
<p>局部变量在脚本或命令中定义，仅在当前shell实例中有效，其他shell启动的程序不能访问局部变量。</p>
<h3 id="2-环境变量">2) 环境变量</h3>
<p>所有的程序，包括shell启动的程序，都能访问环境变量，有些程序需要环境变量来保证其正常运行。必要的时候shell脚本也可以定义环境变量。</p>
<h3 id="3-shell变量">3) shell变量</h3>
<p>shell变量是由shell程序设置的特殊变量。shell变量中有一部分是环境变量，有一部分是局部变量，这些变量保证了shell的正常运行。</p>
<hr>
<h1 id="2-shell的特殊变量">2. shell的特殊变量</h1>
<p>特殊变量列表</p>
<table>
<thead>
<tr>
<th>变量</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>$0</td>
<td>当前脚本的文件名</td>
</tr>
<tr>
<td>$n</td>
<td>传递给脚本或函数的参数。n 是一个数字，表示第几个参数。例如，第一个参数是$1，第二个参数是$2。</td>
</tr>
<tr>
<td>$#</td>
<td>传递给脚本或函数的参数个数。</td>
</tr>
<tr>
<td>$*</td>
<td>传递给脚本或函数的所有参数。</td>
</tr>
<tr>
<td>$@</td>
<td>传递给脚本或函数的所有参数。被双引号(&quot; &quot;)包含时，与 $* 稍有不同，下面将会讲到。</td>
</tr>
<tr>
<td>$?</td>
<td>上个命令的退出状态，或函数的返回值。</td>
</tr>
<tr>
<td>$$</td>
<td>当前Shell进程ID。对于 Shell 脚本，就是这些脚本所在的进程ID。</td>
</tr>
</tbody>
</table>
<h2 id="2-1-命令行参数">2.1. 命令行参数</h2>
<p>运行脚本时传递给脚本的参数称为命令行参数。命令行参数用\ $n 表示，例如，$1 表示第一个参数，$2 表示第二个参数，依次类推。</p>
<h2 id="2-2-和-的区别">2.2. $* 和$@ 的区别</h2>
<p>$* 和 $@ 都表示传递给函数或脚本的所有参数，不被双引号(&quot; &quot;)包含时，都以&quot;$1&quot; &quot;$2&quot; … &quot;$n&quot; 的形式输出所有参数。
但是当它们被双引号(&quot; &quot;)包含时，</p>
<ul>
<li>
<p>&quot;$*&quot; 会将所有的参数作为一个整体，以&quot;$1 $2 … $n&quot;的形式输出所有参数；</p>
</li>
<li>
<p>&quot;$@&quot; 会将各个参数分开，以&quot;$1&quot; &quot;$2&quot; … &quot;$n&quot; 的形式输出所有参数。</p>
</li>
</ul>
<h2 id="2-3-退出状态">2.3. 退出状态</h2>
<p>$? 可以获取上一个命令的退出状态。所谓退出状态，就是上一个命令执行后的返回结果。
退出状态是一个数字，一般情况下，大部分命令执行成功会返回 0，失败返回 1。
不过，也有一些命令返回其他值，表示不同类型的错误。$? 也可以表示函数的返回值。</p>
<hr>
<h1 id="3-转义字符">3. 转义字符</h1>
<p>如果表达式中包含特殊字符，Shell 将会进行替换。例如，在双引号中使用变量就是一种替换，转义字符也是一种替换。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">&#34;Value of a is </span><span style="color:#000">$a</span><span style="color:#4e9a06"> \n&#34;</span> 
</span></span></code></pre></div><p>-e 表示对转义字符进行替换</p>
<p>下面的转义字符都可以用在 echo 中：</p>
<table>
<thead>
<tr>
<th>转义字符</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>\</td>
<td>反斜杠</td>
</tr>
<tr>
<td>\a</td>
<td>警报，响铃</td>
</tr>
<tr>
<td>\b</td>
<td>退格（删除键）</td>
</tr>
<tr>
<td>\f</td>
<td>换页(FF)，将当前位置移到下页开头</td>
</tr>
<tr>
<td>\n</td>
<td>换行</td>
</tr>
<tr>
<td>\r</td>
<td>回车</td>
</tr>
<tr>
<td>\t</td>
<td>水平制表符（tab键）</td>
</tr>
<tr>
<td>\v</td>
<td>垂直制表符</td>
</tr>
</tbody>
</table>
<p>可以使用 echo 命令的 -E 选项禁止转义，默认也是不转义的；使用 -n 选项可以禁止插入换行符。</p>
<h1 id="4-变量替换">4. 变量替换</h1>
<h2 id="4-1-命令替换">4.1. 命令替换</h2>
<p>命令替换是指Shell可以先执行命令，将输出结果暂时保存，在适当的地方输出。
命令替换的语法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#4e9a06">`</span><span style="color:#204a87">command</span><span style="color:#4e9a06">`</span>
</span></span></code></pre></div><p>注意是反引号，不是单引号，这个键位于 Esc 键下方。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">DATE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">`</span>date<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Date is </span><span style="color:#000">$DATE</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><h2 id="4-2-变量替换">4.2. 变量替换</h2>
<p>变量替换可以根据变量的状态（是否为空、是否定义等）来改变它的值
可以使用的变量替换形式：</p>
<table>
<thead>
<tr>
<th>形式</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>${var}</td>
<td>变量本来的值</td>
</tr>
<tr>
<td>${var:-word}</td>
<td>如果变量 var 为空或已被删除(unset)，那么返回 word，但不改变 var 的值。</td>
</tr>
<tr>
<td>${var:=word}</td>
<td>如果变量 var 为空或已被删除(unset)，那么返回 word，并将 var 的值设置为 word。</td>
</tr>
<tr>
<td>${var:?message}</td>
<td>如果变量 var 为空或已被删除(unset)，那么将消息 message 送到标准错误输出，可以用来检测变量 var 是否可以被正常赋值。 若此替换出现在Shell脚本中，那么脚本将停止运行。</td>
</tr>
<tr>
<td>${var:+word}</td>
<td>如果变量 var 被定义，那么返回 word，但不改变 var 的值。</td>
</tr>
</tbody>
</table>
<p>作用：用来检测变量是否为空，并提示相关信息。</p>
<p>参考：</p>
<ul>
<li><a href="http://c.biancheng.net/cpp/shell/">http://c.biancheng.net/cpp/shell/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c62e5c02b9a01be54ad23d975c082291">5.3 - Shell运算符</h1>
    
	<h1 id="1-shell运算符">1. shell运算符</h1>
<p>Bash 支持很多运算符，包括算数运算符、关系运算符、布尔运算符、字符串运算符和文件测试运算符。
awk 和 expr，expr 最常用</p>
<p>例如，两个数相加：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">val</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">`</span>expr <span style="color:#0000cf;font-weight:bold">2</span> + 2<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Total value : </span><span style="color:#000">$val</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><p>运行脚本输出：</p>
<pre tabindex="0"><code>Total value : 4
</code></pre><p>两点注意：</p>
<ul>
<li><strong>表达式和运算符之间要有空格</strong>，例如 2+2 是不对的，必须写成 2 + 2，这与我们熟悉的大多数编程语言不一样。</li>
<li>完整的表达式要被``包含，注意这个字符不是常用的单引号，在 Esc 键下边。</li>
</ul>
<h2 id="1-1-算术运算符">1.1. 算术运算符</h2>
<p>算术运算符列表</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>+</td>
<td>加法</td>
<td>`expr $a + $b` 结果为 30。</td>
</tr>
<tr>
<td>-</td>
<td>减法</td>
<td>`expr $a - $b` 结果为 10。</td>
</tr>
<tr>
<td>*</td>
<td>乘法</td>
<td>`expr $a * $b` 结果为  200。</td>
</tr>
<tr>
<td>/</td>
<td>除法</td>
<td>`expr $b / $a` 结果为 2。</td>
</tr>
<tr>
<td>%</td>
<td>取余</td>
<td>`expr $b % $a` 结果为 0。</td>
</tr>
<tr>
<td>=</td>
<td>赋值</td>
<td>a=$b 将把变量 b 的值赋给 a。</td>
</tr>
<tr>
<td>==</td>
<td>相等。用于比较两个数字，相同则返回 true。</td>
<td>[ $a == $b ] 返回 false。</td>
</tr>
<tr>
<td>!=</td>
<td>不相等。用于比较两个数字，不相同则返回 true。</td>
<td>[ $a != $b ] 返回 true。</td>
</tr>
</tbody>
</table>
<p>注意：</p>
<ul>
<li>
<p>乘号(*)前边必须加反斜杠()才能实现乘法运算</p>
</li>
<li>
<p>条件表达式要放在方括号之间，并且要有空格，例如 [$a==$b] 是错误的，必须写成 [$a == $b ]。</p>
</li>
</ul>
<h2 id="1-2-关系运算符">1.2. 关系运算符</h2>
<p>关系运算符只支持数字，不支持字符串，除非字符串的值是数字。</p>
<p>关系运算符列表</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>-eq</td>
<td>检测两个数是否相等，相等返回 true。</td>
<td>[ $a -eq $b ] 返回 true。</td>
</tr>
<tr>
<td>-ne</td>
<td>检测两个数是否相等，不相等返回 true。</td>
<td>[ $a -ne $b ] 返回 true。</td>
</tr>
<tr>
<td>-gt</td>
<td>检测左边的数是否大于右边的，如果是，则返回 true。</td>
<td>[ $a -gt $b ] 返回 false。</td>
</tr>
<tr>
<td>-lt</td>
<td>检测左边的数是否小于右边的，如果是，则返回 true。</td>
<td>[ $a -lt $b ] 返回 true。</td>
</tr>
<tr>
<td>-ge</td>
<td>检测左边的数是否大等于右边的，如果是，则返回 true。</td>
<td>[ $a -ge $b ] 返回 false。</td>
</tr>
<tr>
<td>-le</td>
<td>检测左边的数是否小于等于右边的，如果是，则返回 true。</td>
<td>[ $a -le $b ] 返回 true。</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>eq:equal</p>
</li>
<li>
<p>ne:not equal</p>
</li>
<li>
<p>gt:greater than</p>
</li>
<li>
<p>lt:less than</p>
</li>
<li>
<p>ge:greater or equal</p>
</li>
<li>
<p>le:less or equal</p>
</li>
</ul>
<h2 id="1-3-布尔运算符">1.3. 布尔运算符</h2>
<p>布尔运算符列表</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>!</td>
<td>非运算，表达式为 true 则返回 false，否则返回 true。</td>
<td>[ ! false ] 返回 true。</td>
</tr>
<tr>
<td>-o</td>
<td>或运算，有一个表达式为 true 则返回 true。</td>
<td>[ $a -lt 20 -o $b -gt 100 ] 返回 true。</td>
</tr>
<tr>
<td>-a</td>
<td>与运算，两个表达式都为 true 才返回 true。</td>
<td>[ $a -lt 20 -a $b -gt 100 ] 返回 false。</td>
</tr>
</tbody>
</table>
<ul>
<li>-o:or  或</li>
<li>-a: and  与</li>
</ul>
<h2 id="1-4-字符串运算符">1.4. 字符串运算符</h2>
<p>字符串运算符列表</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td>检测两个字符串是否相等，相等返回 true。</td>
<td>[ $a = $b ] 返回 false。</td>
</tr>
<tr>
<td>!=</td>
<td>检测两个字符串是否相等，不相等返回 true。</td>
<td>[ $a != $b ] 返回 true。</td>
</tr>
<tr>
<td>-z</td>
<td>检测字符串长度是否为0，为0返回 true。</td>
<td>[ -z $a ] 返回 false。</td>
</tr>
<tr>
<td>-n</td>
<td>检测字符串长度是否为0，不为0返回 true。</td>
<td>[ -z $a ] 返回 true。</td>
</tr>
<tr>
<td>str</td>
<td>检测字符串是否为空，不为空返回 true。</td>
<td>[ $a ] 返回 true。</td>
</tr>
</tbody>
</table>
<p>字符串长度：</p>
<ul>
<li>-z:zero ---&gt;true</li>
<li>-n: not zero---&gt;true</li>
</ul>
<h2 id="1-5-文件测试运算符">1.5. 文件测试运算符</h2>
<p>文件测试运算符用于检测 Unix 文件的各种属性。</p>
<p>文件测试运算符列表</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>-b file</td>
<td>检测文件是否是块设备文件，如果是，则返回 true。</td>
<td>[ -b $file ] 返回 false。</td>
</tr>
<tr>
<td>-c file</td>
<td>检测文件是否是字符设备文件，如果是，则返回 true。</td>
<td>[ -b $file ] 返回 false。</td>
</tr>
<tr>
<td>-d file</td>
<td>检测文件是否是目录，如果是，则返回 true。</td>
<td>[ -d $file ] 返回 false。</td>
</tr>
<tr>
<td>-f file</td>
<td>检测文件是否是普通文件（既不是目录，也不是设备文件），如果是，则返回 true。</td>
<td>[ -f $file ] 返回 true。</td>
</tr>
<tr>
<td>-g file</td>
<td>检测文件是否设置了 SGID 位，如果是，则返回 true。</td>
<td>[ -g $file ] 返回 false。</td>
</tr>
<tr>
<td>-k file</td>
<td>检测文件是否设置了粘着位(Sticky Bit)，如果是，则返回 true。</td>
<td>[ -k $file ] 返回 false。</td>
</tr>
<tr>
<td>-p file</td>
<td>检测文件是否是具名管道，如果是，则返回 true。</td>
<td>[ -p $file ] 返回 false。</td>
</tr>
<tr>
<td>-u file</td>
<td>检测文件是否设置了 SUID 位，如果是，则返回 true。</td>
<td>[ -u $file ] 返回 false。</td>
</tr>
<tr>
<td>-r file</td>
<td>检测文件是否可读，如果是，则返回 true。</td>
<td>[ -r $file ] 返回 true。</td>
</tr>
<tr>
<td>-w file</td>
<td>检测文件是否可写，如果是，则返回 true。</td>
<td>[ -w $file ] 返回 true。</td>
</tr>
<tr>
<td>-x file</td>
<td>检测文件是否可执行，如果是，则返回 true。</td>
<td>[ -x $file ] 返回 true。</td>
</tr>
<tr>
<td>-s file</td>
<td>检测文件是否为空（文件大小是否大于0），不为空返回 true。</td>
<td>[ -s $file ] 返回 true。</td>
</tr>
<tr>
<td>-e file</td>
<td>检测文件（包括目录）是否存在，如果是，则返回 true。</td>
<td>[ -e $file ] 返回 true。</td>
</tr>
</tbody>
</table>
<h1 id="2-shell注释">2. shell注释</h1>
<p>以“#”开头的行就是注释，会被解释器忽略。
sh里没有多行注释，只能每一行加一个#号。</p>
<p>如果在开发过程中，遇到大段的代码需要临时注释起来，过一会儿又取消注释，怎么办呢？每一行加个#符号太费力了，可以把这一段要注释的代码用一对花括号括起来，定义成一个函数，没有地方调用这个函数，这块代码就不会执行，达到了和注释一样的效果。</p>
<p>参考：</p>
<ul>
<li><a href="http://c.biancheng.net/cpp/shell/">http://c.biancheng.net/cpp/shell/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c4413e1441110142d959e29a1be59096">5.4 - Shell数组</h1>
    
	<h1 id="1-字符串">1. 字符串</h1>
<p>字符串是shell编程中最常用最有用的数据类型（除了数字和字符串，也没啥其它类型好用了），字符串可以用单引号，也可以用双引号，也可以不用引号。单双引号的区别跟PHP类似。</p>
<h2 id="1-1-单引号">1.1. 单引号</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">str</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;this is a string&#39;</span>
</span></span></code></pre></div><p>单引号字符串的限制：</p>
<ul>
<li>单引号里的任何字符都会原样输出，单引号字符串中的变量是无效的；</li>
<li>单引号字串中不能出现单引号（对单引号使用转义符后也不行）。</li>
</ul>
<h2 id="1-2-双引号">1.2. 双引号</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">your_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;qinjx&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">str</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Hello, I know your are \&#34;</span><span style="color:#000">$your_name</span><span style="color:#4e9a06">\&#34;! \n&#34;</span>
</span></span></code></pre></div><p>双引号的优点：</p>
<ul>
<li>双引号里可以有变量</li>
<li>双引号里可以出现转义字符</li>
</ul>
<h2 id="1-3-拼接字符串">1.3. 拼接字符串</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">your_name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;qinjx&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">greeting</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;hello, &#34;</span><span style="color:#000">$your_name</span><span style="color:#4e9a06">&#34; !&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">greeting_1</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;hello, </span><span style="color:#4e9a06">${</span><span style="color:#000">your_name</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> !&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#000">$greeting</span> <span style="color:#000">$greeting_1</span>
</span></span></code></pre></div><h2 id="1-4-获取字符串长度">1.4. 获取字符串长度</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">string</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;abcd&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">${#</span><span style="color:#000">string</span><span style="color:#4e9a06">}</span> <span style="color:#8f5902;font-style:italic">#输出 4</span>
</span></span></code></pre></div><h2 id="1-5-提取子字符串">1.5. 提取子字符串</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">string</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;alibaba is a great company&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">${</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">4</span><span style="color:#4e9a06">}</span> <span style="color:#8f5902;font-style:italic">#输出liba</span>
</span></span></code></pre></div><h2 id="1-6-查找子字符串">1.6. 查找子字符串</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">string</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;alibaba is a great company&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">`</span>expr index <span style="color:#4e9a06">&#34;</span><span style="color:#000">$string</span><span style="color:#4e9a06">&#34;</span> is<span style="color:#4e9a06">`</span>
</span></span></code></pre></div><h1 id="2-数组">2. 数组</h1>
<p>bash支持一维数组（不支持多维数组），并且没有限定数组的大小。类似与C语言，数组元素的下标由0开始编号。获取数组中的元素要利用下标，下标可以是整数或算术表达式，其值应大于或等于0。</p>
<h2 id="2-1-定义数组">2.1. 定义数组</h2>
<p>在Shell中，用括号来表示数组，数组元素用“空格”符号分割开。</p>
<p>定义数组的一般形式为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">array_name</span><span style="color:#ce5c00;font-weight:bold">=(</span>value1 ... valuen<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">array_name</span><span style="color:#ce5c00;font-weight:bold">=(</span>value0 value1 value2 value3<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>或者</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">array_name</span><span style="color:#ce5c00;font-weight:bold">=(</span>
</span></span><span style="display:flex;"><span>value0
</span></span><span style="display:flex;"><span>value1
</span></span><span style="display:flex;"><span>value2
</span></span><span style="display:flex;"><span>value3
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>还可以单独定义数组的各个分量：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>array_name<span style="color:#ce5c00;font-weight:bold">[</span>0<span style="color:#ce5c00;font-weight:bold">]=</span>value0
</span></span><span style="display:flex;"><span>array_name<span style="color:#ce5c00;font-weight:bold">[</span>1<span style="color:#ce5c00;font-weight:bold">]=</span>value1
</span></span><span style="display:flex;"><span>array_name<span style="color:#ce5c00;font-weight:bold">[</span>2<span style="color:#ce5c00;font-weight:bold">]=</span>value2
</span></span></code></pre></div><p>可以不使用连续的下标，而且下标的范围没有限制。</p>
<h2 id="2-2-读取数组">2.2. 读取数组</h2>
<p>读取数组元素值的一般格式是：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#4e9a06">${</span><span style="color:#000">array_name</span><span style="color:#000;font-weight:bold">[index]</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">valuen</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">array_name</span><span style="color:#000;font-weight:bold">[2]</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><p>使用@ 或 * 可以获取数组中的所有元素，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#4e9a06">${</span><span style="color:#000">array_name</span><span style="color:#000;font-weight:bold">[*]</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">${</span><span style="color:#000">array_name</span><span style="color:#000;font-weight:bold">[@]</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><h2 id="2-3-获取数组的长度">2.3. 获取数组的长度</h2>
<p>获取数组长度的方法与获取字符串长度的方法相同，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 取得数组元素的个数</span>
</span></span><span style="display:flex;"><span><span style="color:#000">length</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${#</span><span style="color:#000">array_name</span><span style="color:#000;font-weight:bold">[@]</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或者</span>
</span></span><span style="display:flex;"><span><span style="color:#000">length</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${#</span><span style="color:#000">array_name</span><span style="color:#000;font-weight:bold">[*]</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 取得数组单个元素的长度</span>
</span></span><span style="display:flex;"><span><span style="color:#000">lengthn</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${#</span><span style="color:#000">array_name</span><span style="color:#000;font-weight:bold">[n]</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="http://c.biancheng.net/cpp/shell/">http://c.biancheng.net/cpp/shell/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1c4908b9298c264248fc1c192a1aa162">5.5 - Shell echo命令</h1>
    
	<h1 id="1-echo">1. echo</h1>
<p>echo是Shell的一个内部指令，用于在屏幕上打印出指定的字符串。命令格式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> arg
</span></span></code></pre></div><p>您可以使用echo实现更复杂的输出格式控制。</p>
<h2 id="1-1-显示转义字符">1.1. 显示转义字符</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;\&#34;It is a test\&#34;&#34;</span>
</span></span></code></pre></div><p>结果将是：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;It is a test&#34;</span>
</span></span></code></pre></div><p>双引号也可以省略。</p>
<h2 id="1-2-显示变量">1.2. 显示变量</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;OK&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$name</span><span style="color:#4e9a06"> It is a test&#34;</span>
</span></span></code></pre></div><p>结果将是：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>OK It is a <span style="color:#204a87">test</span>
</span></span></code></pre></div><p>同样双引号也可以省略。</p>
<p>如果变量与其它字符相连的话，需要使用大括号（{ }）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">mouth</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">mouth</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">-1-2009&#34;</span>
</span></span></code></pre></div><p>结果将是：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>8-1-2009
</span></span></code></pre></div><h2 id="1-3-显示换行">1.3. 显示换行</h2>
<pre tabindex="0"><code>echo &#34;OK!\n&#34;
echo &#34;It is a test&#34;
</code></pre><p>输出：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>OK!
</span></span><span style="display:flex;"><span>It is a <span style="color:#204a87">test</span>
</span></span></code></pre></div><h2 id="1-4-显示不换行">1.4. 显示不换行</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;OK!\c&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;It is a test&#34;</span>
</span></span></code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>OK!It si a <span style="color:#204a87">test</span>
</span></span></code></pre></div><h2 id="1-5-显示结果重定向至文件">1.5. 显示结果重定向至文件</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;It is a test&#34;</span> &gt; myfile
</span></span></code></pre></div><h2 id="1-6-原样输出字符串">1.6. 原样输出字符串</h2>
<p>若需要原样输出字符串（不进行转义），请使用单引号。例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;$name\&#34;&#39;</span>
</span></span></code></pre></div><h2 id="1-7-显示命令执行结果">1.7. 显示命令执行结果</h2>
<pre tabindex="0"><code>echo `date`
</code></pre><p>结果将显示当前日期
从上面可看出，双引号可有可无，单引号主要用在原样输出中。</p>
<h1 id="2-printf">2. printf</h1>
<p>printf 命令用于格式化输出， 是echo命令的增强版。它是C语言printf()库函数的一个有限的变形，并且在语法上有些不同。
printf 不像 echo 那样会自动换行，必须显式添加换行符(\n)。
注意：printf 由 POSIX 标准所定义，移植性要比 echo 好。</p>
<p>printf 命令的语法：</p>
<pre tabindex="0"><code>printf  format-string  [arguments...]
</code></pre><p>format-string 为格式控制字符串，arguments 为参数列表。</p>
<p>printf()功能和用法与 printf 命令类似</p>
<p>这里仅说明与C语言printf()函数的不同：</p>
<ul>
<li>printf 命令不用加括号</li>
<li>format-string 可以没有引号，但最好加上，单引号双引号均可。</li>
<li>参数多于格式控制符(%)时，format-string 可以重用，可以将所有参数都转换。</li>
<li>格式只指定了一个参数，但多出的参数仍然会按照该格式输出，format-string 被重用</li>
<li>arguments 使用空格分隔，不用逗号。</li>
</ul>
<p>如果没有 arguments，那么 %s 用NULL代替，%d 用 0 代替</p>
<p>如果以 %d 的格式来显示字符串，那么会有警告，提示无效的数字，此时默认置为 0</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># format-string为双引号,单引号与双引号效果一样,没有引号也可以输出</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#204a87">printf</span> <span style="color:#4e9a06">&#34;%d %s\n&#34;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#4e9a06">&#34;abc&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span> abc
</span></span></code></pre></div><p>注意，根据POSIX标准，浮点格式%e、%E、%f、%g与%G是“不需要被支持”。这是因为awk支持浮点预算，且有它自己的printf语句。这样Shell程序中需要将浮点数值进行格式化的打印时，可使用小型的awk程序实现。然而，内建于bash、ksh93和zsh中的printf命令都支持浮点格式。</p>
<p>参考：</p>
<ul>
<li><a href="http://c.biancheng.net/cpp/shell/">http://c.biancheng.net/cpp/shell/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3e7580ccae2cfd4463708b26683b2832">5.6 - Shell 判断语句</h1>
    
	<h1 id="1-if语句">1. if语句</h1>
<p>if 语句通过关系运算符判断表达式的真假来决定执行哪个分支。Shell 有三种 if ... else 语句：</p>
<ul>
<li>if ... fi 语句；</li>
<li>if ... else ... fi 语句；</li>
<li>if ... elif ... else ... fi 语句。</li>
</ul>
<h2 id="1-1-if-else">1.1. if ... else</h2>
<p>if ... else 语句的语法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> expression <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>   Statement<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> to be executed <span style="color:#204a87;font-weight:bold">if</span> expression is <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span></code></pre></div><p>如果 expression 返回 true，then 后边的语句将会被执行；如果返回 false，不会执行任何语句。
<strong>最后必须以 fi 来结尾闭合 if</strong>，fi 就是 if 倒过来拼写。
注意：<strong>expression 和方括号([ ])之间必须有空格</strong>，否则会有语法错误。</p>
<h2 id="1-2-if-else-fi">1.2. if ... else ... fi</h2>
<p>if ... else ... fi 语句的语法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> expression <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>   Statement<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> to be executed <span style="color:#204a87;font-weight:bold">if</span> expression is <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>   Statement<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> to be executed <span style="color:#204a87;font-weight:bold">if</span> expression is not <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span></code></pre></div><p>如果 expression 返回 true，那么 then 后边的语句将会被执行；否则，执行 else 后边的语句。</p>
<h2 id="1-3-if-elif-fi-多分枝选择">1.3. if ... elif ... fi 多分枝选择</h2>
<p>if ... elif ... fi 语句可以对多个条件进行判断，语法为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> expression <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>   Statement<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> to be executed <span style="color:#204a87;font-weight:bold">if</span> expression <span style="color:#0000cf;font-weight:bold">1</span> is <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#ce5c00;font-weight:bold">[</span> expression <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>   Statement<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> to be executed <span style="color:#204a87;font-weight:bold">if</span> expression <span style="color:#0000cf;font-weight:bold">2</span> is <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#ce5c00;font-weight:bold">[</span> expression <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>   Statement<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> to be executed <span style="color:#204a87;font-weight:bold">if</span> expression <span style="color:#0000cf;font-weight:bold">3</span> is <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>   Statement<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> to be executed <span style="color:#204a87;font-weight:bold">if</span> no expression is <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span></code></pre></div><p>哪一个 expression 的值为 true，就执行哪个 expression 后面的语句；如果都为 false，那么不执行任何语句。</p>
<p>if ... else 语句也可以写成一行，用分号隔开，以命令的方式来运行</p>
<p>if ... else 语句也经常与 test 命令结合使用，test 命令用于检查某个条件是否成立，与方括号([ ])类似。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">test</span> $<span style="color:#ce5c00;font-weight:bold">[</span>num1<span style="color:#ce5c00;font-weight:bold">]</span> -eq $<span style="color:#ce5c00;font-weight:bold">[</span>num2<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h1 id="2-case语句">2. case语句</h1>
<p>case ... esac 与其他语言中的 switch ... case 语句类似，是一种多分枝选择结构。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> 值 in模式1<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">#-------&gt;匹配值</span>
</span></span><span style="display:flex;"><span>    command1
</span></span><span style="display:flex;"><span>    command2
</span></span><span style="display:flex;"><span>    command3
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>  <span style="color:#8f5902;font-style:italic">#------&gt;break</span>
</span></span><span style="display:flex;"><span>模式2）
</span></span><span style="display:flex;"><span>    command1
</span></span><span style="display:flex;"><span>    command2
</span></span><span style="display:flex;"><span>    command3
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>*<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># -------&gt;相当于default</span>
</span></span><span style="display:flex;"><span>    command1
</span></span><span style="display:flex;"><span>    command2
</span></span><span style="display:flex;"><span>    command3
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">esac</span>  <span style="color:#8f5902;font-style:italic">#-----&gt;结束标志</span>
</span></span></code></pre></div><p>case工作方式如上所示。</p>
<ul>
<li>取值后面必须为关键字 in，</li>
<li>每一模式必须以右括号结束</li>
<li>取值可以为变量或常数。</li>
<li>匹配发现取值符合某一模式后，其间所有命令开始执行直至 ;;。</li>
<li>;; 与其他语言中的 break 类似，意思是跳到整个 case 语句的最后。</li>
<li>取值将检测匹配的每一个模式。一旦模式匹配，则执行完匹配模式相应命令后不再继续其他模式。</li>
<li>如果无一匹配模式，使用星号 * 捕获该值，再执行后面的命令。</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="http://c.biancheng.net/cpp/shell/">http://c.biancheng.net/cpp/shell/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-520bfcc1b1f2e050d803497bcd9f2646">5.7 - Shell 循环语句</h1>
    
	<h1 id="1-for">1. for</h1>
<p>for循环一般格式为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> 变量 in 列表
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>    command1
</span></span><span style="display:flex;"><span>    command2
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    commandN
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><p>列表是一组值（数字、字符串等）组成的序列，每个值通过空格分隔。每循环一次，就将列表中的下一个值赋给变量。
in 列表是可选的，如果不用它，for 循环使用命令行的位置参数。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> loop in <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;The value is: </span><span style="color:#000">$loop</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 运行结果：</span>
</span></span><span style="display:flex;"><span>The value is: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>The value is: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>The value is: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>The value is: <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>The value is: <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><h1 id="2-while">2. while</h1>
<p>while循环用于不断执行一系列命令，也用于从输入文件中读取数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">while</span> <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>   Statement<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> to be executed <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">command</span> is <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><p>命令执行完毕，控制返回循环顶部，从头开始直至测试条件为假。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">COUNTER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">while</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#000">$COUNTER</span> -lt <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">COUNTER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;expr $COUNTER+1&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#000">$COUNTER</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><p>while循环可用于读取键盘信息。下面的例子中，输入信息被设置为变量FILM，按&lt;Ctrl-D&gt;结束循环。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;type &lt;CTRL-D&gt; to terminate&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> -n <span style="color:#4e9a06">&#39;enter your most liked film: &#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">while</span> <span style="color:#204a87">read</span> FILM
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Yeah! great film the </span><span style="color:#000">$FILM</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><h1 id="3-until">3. until</h1>
<p>until 循环执行一系列命令直至条件为 true 时停止。until 循环与 while 循环在处理方式上刚好相反。一般while循环优于until循环，但在某些时候，也只是极少数情况下，until 循环更加有用。
until 循环格式为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">until</span> <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>   Statement<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> to be executed <span style="color:#204a87;font-weight:bold">until</span> <span style="color:#204a87">command</span> is <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><p>command 一般为条件表达式，如果返回值为 false，则继续执行循环体内的语句，否则跳出循环。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">until</span> <span style="color:#ce5c00;font-weight:bold">[</span> ! <span style="color:#000">$a</span> -lt <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87">echo</span> <span style="color:#000">$a</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">`</span>expr <span style="color:#000">$a</span> + 1<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><h1 id="4-break命令">4. break命令</h1>
<p>break命令允许跳出<strong>所有</strong>（终止执行后面的所有循环）。</p>
<p>在嵌套循环中，break 命令后面还可以跟一个整数，表示跳出第几层循环</p>
<pre tabindex="0"><code>break n
</code></pre><p>表示跳出第 n 层循环。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">while</span> :
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> -n <span style="color:#4e9a06">&#34;Input a number between 1 to 5: &#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">read</span> aNum
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">$aNum</span> in
</span></span><span style="display:flex;"><span>        1<span style="color:#000;font-weight:bold">|</span>2<span style="color:#000;font-weight:bold">|</span>3<span style="color:#000;font-weight:bold">|</span>4<span style="color:#000;font-weight:bold">|</span>5<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Your number is </span><span style="color:#000">$aNum</span><span style="color:#4e9a06">!&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>        *<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;You do not select a number between 1 to 5, game is over!&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">esac</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><h1 id="5-continue命令">5. continue命令</h1>
<p>continue命令与break命令类似，只有一点差别，它不会跳出所有循环，仅仅跳出循环</p>
<p>同样，continue 后面也可以跟一个数字，表示跳出第几层循环。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">while</span> :
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> -n <span style="color:#4e9a06">&#34;Input a number between 1 to 5: &#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">read</span> aNum
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">$aNum</span> in
</span></span><span style="display:flex;"><span>        1<span style="color:#000;font-weight:bold">|</span>2<span style="color:#000;font-weight:bold">|</span>3<span style="color:#000;font-weight:bold">|</span>4<span style="color:#000;font-weight:bold">|</span>5<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Your number is </span><span style="color:#000">$aNum</span><span style="color:#4e9a06">!&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>        *<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;You do not select a number between 1 to 5!&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Game is over!&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">esac</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="http://c.biancheng.net/cpp/shell/">http://c.biancheng.net/cpp/shell/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-427cb5778e5423db520256d99897d9a6">5.8 - Shell 函数</h1>
    
	<h1 id="1-函数定义">1. 函数定义</h1>
<p>函数可以让我们将一个复杂功能划分成若干模块，让程序结构更加清晰，代码重复利用率更高。Shell 也支持函数。Shell 函数必须先定义后使用。</p>
<p>Shell 函数的定义格式如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>function_name <span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    list of commands
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#204a87;font-weight:bold">return</span> value <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>也可以在函数名前加上关键字 function：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> function_name <span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    list of commands
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#204a87;font-weight:bold">return</span> value <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-函数返回值">2. 函数返回值</h1>
<p>函数返回值，可以显式增加return语句；如果不加，会将最后一条命令运行结果作为返回值。</p>
<p>Shell 函数返回值只能是整数，一般用来表示函数执行成功与否，0表示成功，其他值表示失败。</p>
<p>如果 return 其他数据，比如一个字符串，往往会得到错误提示：“numeric argument required”。</p>
<p>如果一定要让函数返回字符串，那么可以先定义一个变量，用来接收函数的计算结果，脚本在需要的时候访问这个变量来获得函数返回值。函数返回值在调用该函数后通过 $?【$?表示上个命令的退出状态，或函数的返回值。】 来获得。</p>
<h1 id="3-函数调用">3. 函数调用</h1>
<p>调用函数只需要给出函数名，不需要加括号。</p>
<p>像删除变量一样，删除函数也可以使用 unset 不过要加上 .f 选项</p>
<pre tabindex="0"><code>$unset .f function_name
</code></pre><p>如果你希望直接从终端调用函数，可以将函数定义在主目录下的 .profile 文件，这样每次登录后，在命令提示符后面输入函数名字就可以立即调用。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic"># Define your function here</span>
</span></span><span style="display:flex;"><span>Hello <span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Url is http://see.xidian.edu.cn/cpp/shell/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Invoke your function</span>
</span></span><span style="display:flex;"><span>Hello
</span></span></code></pre></div><p>运行结果：</p>
<pre tabindex="0"><code>$./test.sh
Hello World
$
</code></pre><h1 id="4-函数参数">4. 函数参数</h1>
<p>在Shell中，调用函数时可以向其传递参数。在函数体内部，通过 $n 的形式来获取参数的值，例如，$1表示第一个参数，$2表示第二个参数...</p>
<p>注意，$10 不能获取第十个参数，获取第十个参数需要${10}。当n&gt;=10时，需要使用${n}来获取参数。</p>
<p>特殊变量用来处理参数:</p>
<table>
<thead>
<tr>
<th>特殊变量</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>$#</td>
<td>传递给函数的参数个数。</td>
</tr>
<tr>
<td>$*</td>
<td>显示所有传递给函数的参数。</td>
</tr>
<tr>
<td>$@</td>
<td>与$*相同，但是略有区别，请查看<a href="http://c.biancheng.net/cpp/view/2739.html">Shell特殊变量</a>。</td>
</tr>
<tr>
<td>$?</td>
<td>函数的返回值。</td>
</tr>
</tbody>
</table>
<p>带参数的函数示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>funWithParam<span style="color:#ce5c00;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;The value of the first parameter is </span><span style="color:#000">$1</span><span style="color:#4e9a06"> !&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;The value of the second parameter is </span><span style="color:#000">$2</span><span style="color:#4e9a06"> !&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;The value of the tenth parameter is </span><span style="color:#000">$10</span><span style="color:#4e9a06"> !&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;The value of the tenth parameter is </span><span style="color:#4e9a06">${</span><span style="color:#000">10</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> !&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;The value of the eleventh parameter is </span><span style="color:#4e9a06">${</span><span style="color:#000">11</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> !&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;The amount of the parameters is </span><span style="color:#000">$#</span><span style="color:#4e9a06"> !&#34;</span>  <span style="color:#8f5902;font-style:italic"># 参数个数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;The string of the parameters is </span><span style="color:#000">$*</span><span style="color:#4e9a06"> !&#34;</span>  <span style="color:#8f5902;font-style:italic"># 传递给函数的所有参数</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>funWithParam <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">34</span> <span style="color:#0000cf;font-weight:bold">73</span>
</span></span></code></pre></div><p>运行脚本：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>The value of the first parameter is <span style="color:#0000cf;font-weight:bold">1</span> !
</span></span><span style="display:flex;"><span>The value of the second parameter is <span style="color:#0000cf;font-weight:bold">2</span> !
</span></span><span style="display:flex;"><span>The value of the tenth parameter is <span style="color:#0000cf;font-weight:bold">10</span> !
</span></span><span style="display:flex;"><span>The value of the tenth parameter is <span style="color:#0000cf;font-weight:bold">34</span> !
</span></span><span style="display:flex;"><span>The value of the eleventh parameter is <span style="color:#0000cf;font-weight:bold">73</span> !
</span></span><span style="display:flex;"><span>The amount of the parameters is <span style="color:#0000cf;font-weight:bold">12</span> !
</span></span><span style="display:flex;"><span>The string of the parameters is <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">34</span> <span style="color:#0000cf;font-weight:bold">73</span> !<span style="color:#4e9a06">&#34;
</span></span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="http://c.biancheng.net/cpp/shell/">http://c.biancheng.net/cpp/shell/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e6194060e55926f98d5865870e2d2baa">5.9 - Shell 重定向</h1>
    
	<p>Unix 命令默认从标准输入设备(stdin)获取输入，将结果输出到标准输出设备(stdout)显示。一般情况下，标准输入设备就是键盘，标准输出设备就是终端，即显示器。</p>
<h1 id="1-输出重定向">1. 输出重定向</h1>
<p>命令的输出不仅可以是显示器，还可以很容易的转移向到文件，这被称为输出重定向。</p>
<p>命令输出重定向的语法为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#204a87">command</span> &gt; file
</span></span></code></pre></div><p>这样，输出到显示器的内容就可以被重定向到文件。</p>
<p>输出重定向会覆盖文件内容；如果不希望文件内容被覆盖，可以使用 &gt;&gt; 追加到文件末尾</p>
<h1 id="2-输入重定向">2. 输入重定向</h1>
<p>和输出重定向一样，Unix 命令也可以从文件获取输入，语法为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#204a87">command</span> &lt; file
</span></span></code></pre></div><p>这样，本来需要从键盘获取输入的命令会转移到文件读取内容。</p>
<p>注意：输出重定向是大于号(&gt;)，输入重定向是小于号(&lt;)。</p>
<h1 id="3-重定向深入讲解">3. 重定向深入讲解</h1>
<p>一般情况下，每个 Unix/Linux 命令运行时都会打开三个文件：</p>
<ul>
<li>标准输入文件(stdin)：stdin的文件描述符为0，Unix程序默认从stdin读取数据。</li>
<li>标准输出文件(stdout)：stdout 的文件描述符为1，Unix程序默认向stdout输出数据。</li>
<li>标准错误文件(stderr)：stderr的文件描述符为2，Unix程序会向stderr流中写入错误信息。</li>
</ul>
<p>默认情况下，command &gt; file 将 stdout 重定向到 file，command &lt; file 将stdin 重定向到 file。</p>
<p>如果希望 stderr 重定向到 file，可以这样写：</p>
<pre tabindex="0"><code>$command 2 &gt; file
</code></pre><p>如果希望 stderr 追加到 file 文件末尾，可以这样写：</p>
<pre tabindex="0"><code>$command 2 &gt;&gt; file
</code></pre><p>2 表示标准错误文件(stderr)。</p>
<p>如果希望将 stdout 和 stderr 合并后重定向到 file，可以这样写：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">$command</span> &gt; file 2&gt;<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><p>或</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">$command</span> &gt;&gt; file 2&gt;<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><p>如果希望对 stdin 和 stdout 都重定向，可以这样写：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">$command</span> &lt; file1 &gt;file2
</span></span></code></pre></div><p>command 命令将 stdin 重定向到 file1，将 stdout 重定向到 file2。</p>
<p>全部可用的重定向命令列表</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>command &gt; file</td>
<td>将输出重定向到 file。</td>
</tr>
<tr>
<td>command &lt; file</td>
<td>将输入重定向到 file。</td>
</tr>
<tr>
<td>command &gt;&gt; file</td>
<td>将输出以追加的方式重定向到 file。</td>
</tr>
<tr>
<td>n &gt; file</td>
<td>将文件描述符为 n 的文件重定向到 file。</td>
</tr>
<tr>
<td>n &gt;&gt; file</td>
<td>将文件描述符为 n 的文件以追加的方式重定向到 file。</td>
</tr>
<tr>
<td>n &gt;&amp; m</td>
<td>将输出文件 m 和 n 合并。</td>
</tr>
<tr>
<td>n &lt;&amp; m</td>
<td>将输入文件 m 和 n 合并。</td>
</tr>
<tr>
<td>&lt;&lt; tag</td>
<td>将开始标记 tag 和结束标记 tag 之间的内容作为输入。</td>
</tr>
</tbody>
</table>
<h1 id="4-here-document">4. Here Document</h1>
<p>Here Document 目前没有统一的翻译，这里暂译为”嵌入文档“。Here Document 是 Shell 中的一种特殊的重定向方式，它的基本的形式如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">command</span> <span style="color:#4e9a06">&lt;&lt; delimiter
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    document
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">delimiter</span>
</span></span></code></pre></div><p>它的作用是将两个 delimiter 之间的内容(document) 作为输入传递给 command。
注意：</p>
<ul>
<li>结尾的delimiter 一定要顶格写，前面不能有任何字符，后面也不能有任何字符，包括空格和 tab 缩进。</li>
<li>开始的delimiter前后的空格会被忽略掉。</li>
</ul>
<h1 id="5-dev-null-文件">5. /dev/null 文件</h1>
<p>如果希望执行某个命令，但又不希望在屏幕上显示输出结果，那么可以将输出重定向到 /dev/null：</p>
<pre tabindex="0"><code>$ command &gt; /dev/null
</code></pre><p>/dev/null 是一个特殊的文件，写入到它的内容都会被丢弃；如果尝试从该文件读取内容，那么什么也读不到。但是 /dev/null 文件非常有用，将命令的输出重定向到它，会起到”禁止输出“的效果。</p>
<p>如果希望屏蔽 stdout 和 stderr，可以这样写：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#204a87">command</span> &gt; /dev/null 2&gt;<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><h1 id="6-文件包含">6. 文件包含</h1>
<p>像其他语言一样，Shell 也可以包含外部脚本，将外部脚本的内容合并到当前脚本。</p>
<p>Shell 中包含脚本可以使用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>. filename
</span></span></code></pre></div><p>或</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">source</span> filename
</span></span></code></pre></div><p>两种方式的效果相同，简单起见，一般使用点号(.)，但是注意点号(.)和文件名中间有一空格。</p>
<p>注意：被包含脚本不需要有执行权限。</p>
<p>参考：</p>
<ul>
<li><a href="http://c.biancheng.net/cpp/shell/">http://c.biancheng.net/cpp/shell/</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bbde1feaea89039a1489906ebd5dd645">6 - 运维工具</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-19e331c309cc44664359cc5ff58f47ff">6.1 - ansible的使用</h1>
    
	<h1 id="1-安装">1. 安装</h1>
<p>以centos为例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y ansible
</span></span></code></pre></div><h1 id="2-配置">2. 配置</h1>
<p>默认配置目录在<code>/etc/ansible/</code>，主要有以下两个配置：</p>
<ul>
<li>ansible.cfg：ansible的配置文件</li>
<li>hosts：配置ansible所连接的机器IP信息</li>
</ul>
<h2 id="2-1-ansible-cfg">2.1. ansible.cfg</h2>
<h2 id="2-2-hosts">2.2. hosts</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This is the default ansible &#39;hosts&#39; file.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It should live in /etc/ansible/hosts</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   - Comments begin with the &#39;#&#39; character</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   - Blank lines are ignored</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   - Groups of hosts are delimited by [header] elements</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   - You can enter hostnames or ip addresses</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   - A hostname/ip can be a member of multiple groups</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Ex 1: Ungrouped hosts, specify before any group headers.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># green.example.com</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># blue.example.com</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 192.168.100.1</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 192.168.100.10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Ex 2: A collection of hosts belonging to the &#39;webservers&#39; group</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># [webservers]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># alpha.example.org</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># beta.example.org</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 192.168.1.100</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 192.168.1.110</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If you have multiple hosts following a pattern you can specify</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># them like this:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># www[001:006].example.com</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Ex 3: A collection of database servers in the &#39;dbservers&#39; group</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># [dbservers]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># db01.intranet.mydomain.net</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># db02.intranet.mydomain.net</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 10.25.1.56</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 10.25.1.57</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Here&#39;s another example of host ranges, this time there are no</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># leading 0s:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># db-[99:101]-node.example.com</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>k8s<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>192.168.201.52
</span></span><span style="display:flex;"><span>192.168.201.53
</span></span><span style="display:flex;"><span>192.168.201.54
</span></span><span style="display:flex;"><span>192.168.201.55
</span></span><span style="display:flex;"><span>192.168.201.56
</span></span><span style="display:flex;"><span>192.168.201.57
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># password setting</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>all:vars<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ansible_connection</span><span style="color:#ce5c00;font-weight:bold">=</span>ssh
</span></span><span style="display:flex;"><span><span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root
</span></span><span style="display:flex;"><span><span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span>xxx
</span></span></code></pre></div><h1 id="3-ansible的命令">3. ansible的命令</h1>
<p>命令格式为：ansible <host-pattern> [options]</p>
<ul>
<li><code>host-pattern</code>：即hosts文件中配置的集群名称</li>
<li><code>options</code>：命令操作符</li>
</ul>
<p>例如：ansible k8s -a 'uname -r'</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@k8s-master ansible<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># ansible k8s -a &#39;uname -r&#39;</span>
</span></span><span style="display:flex;"><span>172.16.201.56 <span style="color:#000;font-weight:bold">|</span> SUCCESS <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">rc</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> &gt;&gt;
</span></span><span style="display:flex;"><span>4.16.11-1.el7.elrepo.x86_64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>172.16.201.55 <span style="color:#000;font-weight:bold">|</span> SUCCESS <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">rc</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> &gt;&gt;
</span></span><span style="display:flex;"><span>4.16.11-1.el7.elrepo.x86_64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>172.16.201.54 <span style="color:#000;font-weight:bold">|</span> SUCCESS <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">rc</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> &gt;&gt;
</span></span><span style="display:flex;"><span>4.16.11-1.el7.elrepo.x86_64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>172.16.201.53 <span style="color:#000;font-weight:bold">|</span> SUCCESS <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">rc</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> &gt;&gt;
</span></span><span style="display:flex;"><span>4.16.11-1.el7.elrepo.x86_64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>172.16.201.52 <span style="color:#000;font-weight:bold">|</span> SUCCESS <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">rc</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> &gt;&gt;
</span></span><span style="display:flex;"><span>4.16.11-1.el7.elrepo.x86_64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>172.16.201.57 <span style="color:#000;font-weight:bold">|</span> SUCCESS <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">rc</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> &gt;&gt;
</span></span><span style="display:flex;"><span>4.16.11-1.el7.elrepo.x86_64
</span></span></code></pre></div><p>具体的命令信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Usage: ansible &lt;host-pattern&gt; <span style="color:#ce5c00;font-weight:bold">[</span>options<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Define and run a single task <span style="color:#4e9a06">&#39;playbook&#39;</span> against a <span style="color:#204a87">set</span> of hosts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Options:
</span></span><span style="display:flex;"><span>  -a MODULE_ARGS, --args<span style="color:#ce5c00;font-weight:bold">=</span>MODULE_ARGS
</span></span><span style="display:flex;"><span>                        module arguments
</span></span><span style="display:flex;"><span>  --ask-vault-pass      ask <span style="color:#204a87;font-weight:bold">for</span> vault password
</span></span><span style="display:flex;"><span>  -B SECONDS, --background<span style="color:#ce5c00;font-weight:bold">=</span>SECONDS
</span></span><span style="display:flex;"><span>                        run asynchronously, failing after X seconds
</span></span><span style="display:flex;"><span>                        <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>N/A<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -C, --check           don<span style="color:#4e9a06">&#39;t make any changes; instead, try to predict some
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        of the changes that may occur
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -D, --diff            when changing (small) files and templates, show the
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        differences in those files; works great with --check
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -e EXTRA_VARS, --extra-vars=EXTRA_VARS
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        set additional variables as key=value or YAML/JSON, if
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        filename prepend with @
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -f FORKS, --forks=FORKS
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        specify number of parallel processes to use
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        (default=5)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -h, --help            show this help message and exit
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -i INVENTORY, --inventory=INVENTORY, --inventory-file=INVENTORY
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        specify inventory host path or comma separated host
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        list. --inventory-file is deprecated
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -l SUBSET, --limit=SUBSET
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        further limit selected hosts to an additional pattern
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --list-hosts          outputs a list of matching hosts; does not execute
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        anything else
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -m MODULE_NAME, --module-name=MODULE_NAME
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        module name to execute (default=command)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -M MODULE_PATH, --module-path=MODULE_PATH
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        prepend colon-separated path(s) to module library
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        (default=[u&#39;</span>/root/.ansible/plugins/modules<span style="color:#4e9a06">&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        u&#39;</span>/usr/share/ansible/plugins/modules<span style="color:#4e9a06">&#39;])
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -o, --one-line        condense output
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --playbook-dir=BASEDIR
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        Since this tool does not use playbooks, use this as a
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        subsitute playbook directory.This sets the relative
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        path for many features including roles/ group_vars/
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        etc.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -P POLL_INTERVAL, --poll=POLL_INTERVAL
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        set the poll interval if using -B (default=15)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --syntax-check        perform a syntax check on the playbook, but do not
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        execute it
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -t TREE, --tree=TREE  log output to this directory
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --vault-id=VAULT_IDS  the vault identity to use
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --vault-password-file=VAULT_PASSWORD_FILES
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        vault password file
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -v, --verbose         verbose mode (-vvv for more, -vvvv to enable
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        connection debugging)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --version             show program&#39;</span>s version number and <span style="color:#204a87">exit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Connection Options:
</span></span><span style="display:flex;"><span>    control as whom and how to connect to hosts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    -k, --ask-pass      ask <span style="color:#204a87;font-weight:bold">for</span> connection password
</span></span><span style="display:flex;"><span>    --private-key<span style="color:#ce5c00;font-weight:bold">=</span>PRIVATE_KEY_FILE, --key-file<span style="color:#ce5c00;font-weight:bold">=</span>PRIVATE_KEY_FILE
</span></span><span style="display:flex;"><span>                        use this file to authenticate the connection
</span></span><span style="display:flex;"><span>    -u REMOTE_USER, --user<span style="color:#ce5c00;font-weight:bold">=</span>REMOTE_USER
</span></span><span style="display:flex;"><span>                        connect as this user <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>None<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -c CONNECTION, --connection<span style="color:#ce5c00;font-weight:bold">=</span>CONNECTION
</span></span><span style="display:flex;"><span>                        connection <span style="color:#204a87">type</span> to use <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>smart<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -T TIMEOUT, --timeout<span style="color:#ce5c00;font-weight:bold">=</span>TIMEOUT
</span></span><span style="display:flex;"><span>                        override the connection timeout in seconds
</span></span><span style="display:flex;"><span>                        <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>10<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --ssh-common-args<span style="color:#ce5c00;font-weight:bold">=</span>SSH_COMMON_ARGS
</span></span><span style="display:flex;"><span>                        specify common arguments to pass to sftp/scp/ssh <span style="color:#ce5c00;font-weight:bold">(</span>e.g.
</span></span><span style="display:flex;"><span>                        ProxyCommand<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --sftp-extra-args<span style="color:#ce5c00;font-weight:bold">=</span>SFTP_EXTRA_ARGS
</span></span><span style="display:flex;"><span>                        specify extra arguments to pass to sftp only <span style="color:#ce5c00;font-weight:bold">(</span>e.g. -f,
</span></span><span style="display:flex;"><span>                        -l<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --scp-extra-args<span style="color:#ce5c00;font-weight:bold">=</span>SCP_EXTRA_ARGS
</span></span><span style="display:flex;"><span>                        specify extra arguments to pass to scp only <span style="color:#ce5c00;font-weight:bold">(</span>e.g. -l<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --ssh-extra-args<span style="color:#ce5c00;font-weight:bold">=</span>SSH_EXTRA_ARGS
</span></span><span style="display:flex;"><span>                        specify extra arguments to pass to ssh only <span style="color:#ce5c00;font-weight:bold">(</span>e.g. -R<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Privilege Escalation Options:
</span></span><span style="display:flex;"><span>    control how and which user you become as on target hosts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    -s, --sudo          run operations with sudo <span style="color:#ce5c00;font-weight:bold">(</span>nopasswd<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>deprecated, use
</span></span><span style="display:flex;"><span>                        become<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -U SUDO_USER, --sudo-user<span style="color:#ce5c00;font-weight:bold">=</span>SUDO_USER
</span></span><span style="display:flex;"><span>                        desired sudo user <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>root<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>deprecated, use
</span></span><span style="display:flex;"><span>                        become<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -S, --su            run operations with su <span style="color:#ce5c00;font-weight:bold">(</span>deprecated, use become<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -R SU_USER, --su-user<span style="color:#ce5c00;font-weight:bold">=</span>SU_USER
</span></span><span style="display:flex;"><span>                        run operations with su as this user <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>None<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#ce5c00;font-weight:bold">(</span>deprecated, use become<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -b, --become        run operations with become <span style="color:#ce5c00;font-weight:bold">(</span>does not imply password
</span></span><span style="display:flex;"><span>                        prompting<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --become-method<span style="color:#ce5c00;font-weight:bold">=</span>BECOME_METHOD
</span></span><span style="display:flex;"><span>                        privilege escalation method to use <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>sudo<span style="color:#ce5c00;font-weight:bold">)</span>,
</span></span><span style="display:flex;"><span>                        valid choices: <span style="color:#ce5c00;font-weight:bold">[</span> sudo <span style="color:#000;font-weight:bold">|</span> su <span style="color:#000;font-weight:bold">|</span> pbrun <span style="color:#000;font-weight:bold">|</span> pfexec <span style="color:#000;font-weight:bold">|</span> doas <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>                        dzdo <span style="color:#000;font-weight:bold">|</span> ksu <span style="color:#000;font-weight:bold">|</span> runas <span style="color:#000;font-weight:bold">|</span> pmrun <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">enable</span> <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    --become-user<span style="color:#ce5c00;font-weight:bold">=</span>BECOME_USER
</span></span><span style="display:flex;"><span>                        run operations as this user <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>root<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --ask-sudo-pass     ask <span style="color:#204a87;font-weight:bold">for</span> sudo password <span style="color:#ce5c00;font-weight:bold">(</span>deprecated, use become<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --ask-su-pass       ask <span style="color:#204a87;font-weight:bold">for</span> su password <span style="color:#ce5c00;font-weight:bold">(</span>deprecated, use become<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -K, --ask-become-pass
</span></span><span style="display:flex;"><span>                        ask <span style="color:#204a87;font-weight:bold">for</span> privilege escalation password
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Some modules <span style="color:#204a87;font-weight:bold">do</span> not make sense in Ad-Hoc <span style="color:#ce5c00;font-weight:bold">(</span>include, meta, etc<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="4-ansible-playbook">4. ansible-playbook</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Usage: ansible-playbook <span style="color:#ce5c00;font-weight:bold">[</span>options<span style="color:#ce5c00;font-weight:bold">]</span> playbook.yml <span style="color:#ce5c00;font-weight:bold">[</span>playbook2 ...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Runs Ansible playbooks, executing the defined tasks on the targeted hosts.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Options:
</span></span><span style="display:flex;"><span>  --ask-vault-pass      ask <span style="color:#204a87;font-weight:bold">for</span> vault password
</span></span><span style="display:flex;"><span>  -C, --check           don<span style="color:#4e9a06">&#39;t make any changes; instead, try to predict some
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        of the changes that may occur
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -D, --diff            when changing (small) files and templates, show the
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        differences in those files; works great with --check
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -e EXTRA_VARS, --extra-vars=EXTRA_VARS
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        set additional variables as key=value or YAML/JSON, if
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        filename prepend with @
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --flush-cache         clear the fact cache for every host in inventory
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --force-handlers      run handlers even if a task fails
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -f FORKS, --forks=FORKS
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        specify number of parallel processes to use
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        (default=5)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -h, --help            show this help message and exit
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -i INVENTORY, --inventory=INVENTORY, --inventory-file=INVENTORY
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        specify inventory host path or comma separated host
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        list. --inventory-file is deprecated
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -l SUBSET, --limit=SUBSET
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        further limit selected hosts to an additional pattern
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --list-hosts          outputs a list of matching hosts; does not execute
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        anything else
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --list-tags           list all available tags
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --list-tasks          list all tasks that would be executed
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -M MODULE_PATH, --module-path=MODULE_PATH
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        prepend colon-separated path(s) to module library
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        (default=[u&#39;</span>/root/.ansible/plugins/modules<span style="color:#4e9a06">&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        u&#39;</span>/usr/share/ansible/plugins/modules<span style="color:#4e9a06">&#39;])
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --skip-tags=SKIP_TAGS
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        only run plays and tasks whose tags do not match these
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        values
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --start-at-task=START_AT_TASK
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        start the playbook at the task matching this name
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --step                one-step-at-a-time: confirm each task before running
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --syntax-check        perform a syntax check on the playbook, but do not
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        execute it
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -t TAGS, --tags=TAGS  only run plays and tasks tagged with these values
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --vault-id=VAULT_IDS  the vault identity to use
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --vault-password-file=VAULT_PASSWORD_FILES
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        vault password file
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -v, --verbose         verbose mode (-vvv for more, -vvvv to enable
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                        connection debugging)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --version             show program&#39;</span>s version number and <span style="color:#204a87">exit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Connection Options:
</span></span><span style="display:flex;"><span>    control as whom and how to connect to hosts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    -k, --ask-pass      ask <span style="color:#204a87;font-weight:bold">for</span> connection password
</span></span><span style="display:flex;"><span>    --private-key<span style="color:#ce5c00;font-weight:bold">=</span>PRIVATE_KEY_FILE, --key-file<span style="color:#ce5c00;font-weight:bold">=</span>PRIVATE_KEY_FILE
</span></span><span style="display:flex;"><span>                        use this file to authenticate the connection
</span></span><span style="display:flex;"><span>    -u REMOTE_USER, --user<span style="color:#ce5c00;font-weight:bold">=</span>REMOTE_USER
</span></span><span style="display:flex;"><span>                        connect as this user <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>None<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -c CONNECTION, --connection<span style="color:#ce5c00;font-weight:bold">=</span>CONNECTION
</span></span><span style="display:flex;"><span>                        connection <span style="color:#204a87">type</span> to use <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>smart<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -T TIMEOUT, --timeout<span style="color:#ce5c00;font-weight:bold">=</span>TIMEOUT
</span></span><span style="display:flex;"><span>                        override the connection timeout in seconds
</span></span><span style="display:flex;"><span>                        <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>10<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --ssh-common-args<span style="color:#ce5c00;font-weight:bold">=</span>SSH_COMMON_ARGS
</span></span><span style="display:flex;"><span>                        specify common arguments to pass to sftp/scp/ssh <span style="color:#ce5c00;font-weight:bold">(</span>e.g.
</span></span><span style="display:flex;"><span>                        ProxyCommand<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --sftp-extra-args<span style="color:#ce5c00;font-weight:bold">=</span>SFTP_EXTRA_ARGS
</span></span><span style="display:flex;"><span>                        specify extra arguments to pass to sftp only <span style="color:#ce5c00;font-weight:bold">(</span>e.g. -f,
</span></span><span style="display:flex;"><span>                        -l<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --scp-extra-args<span style="color:#ce5c00;font-weight:bold">=</span>SCP_EXTRA_ARGS
</span></span><span style="display:flex;"><span>                        specify extra arguments to pass to scp only <span style="color:#ce5c00;font-weight:bold">(</span>e.g. -l<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --ssh-extra-args<span style="color:#ce5c00;font-weight:bold">=</span>SSH_EXTRA_ARGS
</span></span><span style="display:flex;"><span>                        specify extra arguments to pass to ssh only <span style="color:#ce5c00;font-weight:bold">(</span>e.g. -R<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Privilege Escalation Options:
</span></span><span style="display:flex;"><span>    control how and which user you become as on target hosts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    -s, --sudo          run operations with sudo <span style="color:#ce5c00;font-weight:bold">(</span>nopasswd<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>deprecated, use
</span></span><span style="display:flex;"><span>                        become<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -U SUDO_USER, --sudo-user<span style="color:#ce5c00;font-weight:bold">=</span>SUDO_USER
</span></span><span style="display:flex;"><span>                        desired sudo user <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>root<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>deprecated, use
</span></span><span style="display:flex;"><span>                        become<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -S, --su            run operations with su <span style="color:#ce5c00;font-weight:bold">(</span>deprecated, use become<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -R SU_USER, --su-user<span style="color:#ce5c00;font-weight:bold">=</span>SU_USER
</span></span><span style="display:flex;"><span>                        run operations with su as this user <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>None<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#ce5c00;font-weight:bold">(</span>deprecated, use become<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -b, --become        run operations with become <span style="color:#ce5c00;font-weight:bold">(</span>does not imply password
</span></span><span style="display:flex;"><span>                        prompting<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --become-method<span style="color:#ce5c00;font-weight:bold">=</span>BECOME_METHOD
</span></span><span style="display:flex;"><span>                        privilege escalation method to use <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>sudo<span style="color:#ce5c00;font-weight:bold">)</span>,
</span></span><span style="display:flex;"><span>                        valid choices: <span style="color:#ce5c00;font-weight:bold">[</span> sudo <span style="color:#000;font-weight:bold">|</span> su <span style="color:#000;font-weight:bold">|</span> pbrun <span style="color:#000;font-weight:bold">|</span> pfexec <span style="color:#000;font-weight:bold">|</span> doas <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>                        dzdo <span style="color:#000;font-weight:bold">|</span> ksu <span style="color:#000;font-weight:bold">|</span> runas <span style="color:#000;font-weight:bold">|</span> pmrun <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">enable</span> <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    --become-user<span style="color:#ce5c00;font-weight:bold">=</span>BECOME_USER
</span></span><span style="display:flex;"><span>                        run operations as this user <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>root<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --ask-sudo-pass     ask <span style="color:#204a87;font-weight:bold">for</span> sudo password <span style="color:#ce5c00;font-weight:bold">(</span>deprecated, use become<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    --ask-su-pass       ask <span style="color:#204a87;font-weight:bold">for</span> su password <span style="color:#ce5c00;font-weight:bold">(</span>deprecated, use become<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    -K, --ask-become-pass
</span></span><span style="display:flex;"><span>                        ask <span style="color:#204a87;font-weight:bold">for</span> privilege escalation password
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-65763f1b371a58100a39fc1333ba1541">6.2 - ceph-fuse的使用</h1>
    
	<h1 id="1-安装ceph-fuse">1. 安装ceph-fuse</h1>
<pre tabindex="0"><code>yum install -y ceph-fuse
</code></pre><p>如果安装失败，先执行以下命令，再执行上述安装命令</p>
<pre tabindex="0"><code>yum -y install epel-release


rpm -Uhv http://download.ceph.com/rpm-jewel/el7/noarch/ceph-release-1-1.el7.noarch.rpm
</code></pre><h1 id="2-配置客户端访问的key">2. 配置客户端访问的key</h1>
<p>mkdir /etc/ceph/
vi /etc/ceph/ceph.client.admin.keyring</p>
<pre tabindex="0"><code>[client.admin]
key = xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx==
</code></pre><h1 id="3-ceph-fuse-挂载">3. ceph-fuse 挂载</h1>
<pre tabindex="0"><code>ceph-fuse -m &lt;mons_IP1&gt;:6789,&lt;mons_IP2&gt;:6789,&lt;mons_IP3&gt;:6789 -r &lt;ceph集群中的目录&gt; &lt;宿主机目录&gt; -o nonempty
</code></pre><p>例如：</p>
<pre tabindex="0"><code># ceph-fuse -m 192.168.18.3:6789,192.168.18.4:6789,192.168.18.5:6789 -r /pvc-volumes /root/cephfsdir -o nonempty
2019-03-27 17:58:04.435985 7fc61b67cec0 -1 did not load config file, using default settings.
ceph-fuse[18051]: starting ceph client
2019-03-27 17:58:04.469144 7fc61b67cec0 -1 init, newargv = 0x55cecaba81c0 newargc=13
ceph-fuse[18051]: starting fuse
</code></pre><h1 id="4-查看是否挂载成功">4. 查看是否挂载成功</h1>
<pre tabindex="0"><code># df -h
Filesystem Size Used Avail Use% Mounted on
...
ceph-fuse 1.6T  8.8G  1.6T   1% /root/cephfsdir
</code></pre><h1 id="5-ceph-fuse命令说明">5. ceph-fuse命令说明</h1>
<pre tabindex="0"><code># ceph-fuse --help
2019-03-27 18:01:16.421376 7fae11998ec0 -1 did not load config file, using default settings.
usage: ceph-fuse [-m mon-ip-addr:mon-port] &lt;mount point&gt; [OPTIONS]
  --client_mountpoint/-r &lt;root_directory&gt;
                    use root_directory as the mounted root, rather than the full Ceph tree.

usage: ceph-fuse mountpoint [options]

general options:
    -o opt,[opt...]        mount options
    -h   --help            print help
    -V   --version         print version

FUSE options:
    -d   -o debug          enable debug output (implies -f)
    -f                     foreground operation
    -s                     disable multi-threaded operation

  --conf/-c FILE    read configuration from the given configuration file
  --id/-i ID        set ID portion of my name
  --name/-n TYPE.ID set name
  --cluster NAME    set cluster name (default: ceph)
  --setuser USER    set uid to user or uid (and gid to user&#39;s gid)
  --setgroup GROUP  set gid to group or gid
  --version         show version and quit
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-96144427fb37ef08b231fd81e3a8f3fe">6.3 - confd的使用</h1>
    
	<blockquote>
<p>confd的源码参考：https://github.com/kelseyhightower/confd</p>
</blockquote>
<h1 id="1-confd的部署">1. confd的部署</h1>
<p>以下Linux系统为例。</p>
<p>下载<code>confd</code>的二进制文件，下载地址为：https://github.com/kelseyhightower/confd/releases。例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Download the binary</span>
</span></span><span style="display:flex;"><span>wget https://github.com/kelseyhightower/confd/releases/download/v0.16.0/confd-0.16.0-linux-amd64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重命名二进制文件，并移动到PATH的目录下</span>
</span></span><span style="display:flex;"><span>mv confd-0.16.0-linux-amd64 /usr/local/bin/confd
</span></span><span style="display:flex;"><span>chmod +x /usr/local/bin/confd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 验证是否安装成功</span>
</span></span><span style="display:flex;"><span>confd --help
</span></span></code></pre></div><h1 id="2-confd的配置">2. confd的配置</h1>
<p><code>Confd</code>通过读取后端存储的配置信息来动态更新对应的配置文件，对应的后端存储可以是<code>etcd</code>，<code>redis</code>等，其中etcd的v3版本对应的存储后端为<code>etcdv3</code>。</p>
<h2 id="2-1-confd-toml">2.1. confd.toml</h2>
<p><code>confd.toml</code>为confd服务本身的配置文件，主要记录了使用的存储后端、协议、confdir等参数。</p>
<p><strong>示例：</strong></p>
<ul>
<li>存储后端<code>etcdv3</code>：</li>
</ul>
<pre tabindex="0"><code>backend = &#34;etcdv3&#34;
confdir = &#34;/etc/confd&#34;
log-level = &#34;debug&#34;
interval = 5
nodes = [
  &#34;http://192.168.10.4:12379&#34;,
]
scheme = &#34;http&#34;
watch = true
</code></pre><p>其中<code>watch</code>参数表示实时监听后端存储的变化，如有变化则更新confd管理的配置。</p>
<ul>
<li>存储后端为<code>redis</code></li>
</ul>
<pre tabindex="0"><code>backend = &#34;redis&#34;
confdir = &#34;/etc/confd&#34;
log-level = &#34;debug&#34;
interval = 1  # 间隔 1 秒同步一次配置文件
nodes = [
  &#34;127.0.0.1:6379&#34;,
]
scheme = &#34;http&#34;
client_key = &#34;123456&#34;  # redis的密码，不是 password 参数
#watch = true
</code></pre><p>如果没有启动<code>watch</code>参数，则会依据<code>interval</code>参数定期去redis存储后端拿取数据，并比较与当前配置数据是否有变化（主要比较<code>md5</code>值），如果有变化则更新配置，没有变化则定期再去拿取数据，以此循环。</p>
<p>如果启动了<code>watch</code>参数，则修改redis存储数据的同时，还要执行<code>publish</code>的操作，促使<code>confd</code>去触发比较配置并更新配置的操作。</p>
<p>publish的命令格式如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>publish __keyspace@0__:<span style="color:#ce5c00;font-weight:bold">{</span>prefix<span style="color:#ce5c00;font-weight:bold">}</span>/<span style="color:#ce5c00;font-weight:bold">{</span>key<span style="color:#ce5c00;font-weight:bold">}</span> set<span style="color:#ce5c00;font-weight:bold">(</span>or del<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-2-创建confdir">2.2. 创建confdir</h2>
<p>confdir底下包含两个目录:</p>
<ul>
<li><code>conf.d</code>:confd的配置文件，主要包含配置的生成逻辑，例如模板源，后端存储对应的keys，命令执行等。</li>
<li><code>templates</code>:配置模板Template，即基于不同组件的配置，修改为符合 <a href="http://golang.org/pkg/text/template/#pkg-overview">Golang text templates</a>的模板文件。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir -p /etc/confd/<span style="color:#ce5c00;font-weight:bold">{</span>conf.d,templates<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-2-1-template-resources">2.2.1. Template Resources</h3>
<p>模板源配置文件是<code>TOML</code>格式的文件，主要包含配置的生成逻辑，例如模板源，后端存储对应的keys，命令执行等。默认目录在<code>/etc/confd/conf.d</code>。</p>
<p>参数说明：</p>
<p><strong>必要参数</strong></p>
<ul>
<li><code>dest</code> (string) - The target file.</li>
<li><code>keys</code> (array of strings) - An array of keys.</li>
<li><code>src</code> (string) - The relative path of a <a href="https://github.com/kelseyhightower/confd/blob/master/docs/templates.md">configuration template</a>.</li>
</ul>
<p><strong>可选参数</strong></p>
<ul>
<li><code>gid</code> (int) - The gid that should own the file. Defaults to the effective gid.</li>
<li><code>mode</code> (string) - The permission mode of the file.</li>
<li><code>uid</code> (int) - The uid that should own the file. Defaults to the effective uid.</li>
<li><code>reload_cmd</code> (string) - The command to reload config.</li>
<li><code>check_cmd</code> (string) - The command to check config. Use <code>{{src}}</code> to reference the rendered source template.</li>
<li><code>prefix</code> (string) - The string to prefix to keys.</li>
</ul>
<p><strong>例子</strong></p>
<p>例如：<code>/etc/confd/conf.d/myapp-nginx.toml</code></p>
<pre tabindex="0"><code>[template]
prefix = &#34;/myapp&#34;
src = &#34;nginx.tmpl&#34;
dest = &#34;/tmp/myapp.conf&#34;
owner = &#34;nginx&#34;
mode = &#34;0644&#34;
keys = [
  &#34;/services/web&#34;
]
check_cmd = &#34;/usr/sbin/nginx -t -c {{.src}}&#34;
reload_cmd = &#34;/usr/sbin/service nginx reload&#34;
</code></pre><h3 id="2-2-2-template">2.2.2. Template</h3>
<p><code>Template</code>定义了单一应用配置的模板，默认存储在<code>/etc/confd/templates</code>目录下，模板文件符合Go的<a href="http://golang.org/pkg/text/template/"><code>text/template</code></a>格式。</p>
<p>模板文件常用函数有<code>base</code>，<code>get</code>，<code>gets</code>，<code>lsdir</code>，<code>json</code>等。具体可参考https://github.com/kelseyhightower/confd/blob/master/docs/templates.md。</p>
<p>例子：</p>
<p><code>/etc/confd/templates/nginx.tmpl</code></p>
<pre tabindex="0"><code>{{range $dir := lsdir &#34;/services/web&#34;}}
upstream {{base $dir}} {
    {{$custdir := printf &#34;/services/web/%s/*&#34; $dir}}{{range gets $custdir}}
    server {{$data := json .Value}}{{$data.IP}}:80;
    {{end}}
}

server {
    server_name {{base $dir}}.example.com;
    location / {
        proxy_pass {{base $dir}};
    }
}
{{end}}
</code></pre><h1 id="3-创建后端存储的配置数据">3. 创建后端存储的配置数据</h1>
<p>以<code>etcdv3</code>存储为例，在etcd中创建以下数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$endpoints</span> put /services/web/cust1/2 <span style="color:#4e9a06">&#39;{&#34;IP&#34;: &#34;10.0.0.2&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$endpoints</span> put /services/web/cust2/2 <span style="color:#4e9a06">&#39;{&#34;IP&#34;: &#34;10.0.0.4&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$endpoints</span> put /services/web/cust2/1 <span style="color:#4e9a06">&#39;{&#34;IP&#34;: &#34;10.0.0.3&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$endpoints</span> put /services/web/cust1/1 <span style="color:#4e9a06">&#39;{&#34;IP&#34;: &#34;10.0.0.1&#34;}&#39;</span>
</span></span></code></pre></div><h1 id="4-启动confd的服务">4. 启动confd的服务</h1>
<p>confd支持以<code>daemon</code>或者<code>onetime</code>两种模式运行，当以<code>daemon</code>模式运行时，confd会监听后端存储的配置变化，并根据配置模板动态生成目标配置文件。</p>
<p>confd可以使用<code>-config-file</code>参数来指定confd的配置文件，而将其他参数写在配置文件中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/local/bin/confd -config-file /etc/confd/conf/confd.toml
</span></span></code></pre></div><p>如果以<code>daemon</code>模式运行，在命令后面添加<code>&amp;</code>符号，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>confd -watch -backend etcdv3 -node http://172.16.5.4:12379 <span style="color:#000;font-weight:bold">&amp;</span>
</span></span></code></pre></div><p>以下以<code>onetime</code>模式运行为例。其中对应的后端存储类型是<code>etcdv3</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 执行命令</span>
</span></span><span style="display:flex;"><span>confd -onetime -backend etcdv3 -node http://172.16.5.4:12379
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># output</span>
</span></span><span style="display:flex;"><span>2018-05-11T18:04:59+08:00 k8s-dbg-master-1 confd<span style="color:#ce5c00;font-weight:bold">[</span>35808<span style="color:#ce5c00;font-weight:bold">]</span>: INFO Backend <span style="color:#204a87">set</span> to etcdv3
</span></span><span style="display:flex;"><span>2018-05-11T18:04:59+08:00 k8s-dbg-master-1 confd<span style="color:#ce5c00;font-weight:bold">[</span>35808<span style="color:#ce5c00;font-weight:bold">]</span>: INFO Starting confd
</span></span><span style="display:flex;"><span>2018-05-11T18:04:59+08:00 k8s-dbg-master-1 confd<span style="color:#ce5c00;font-weight:bold">[</span>35808<span style="color:#ce5c00;font-weight:bold">]</span>: INFO Backend source<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87">set</span> to http://172.16.5.4:12379
</span></span><span style="display:flex;"><span>2018-05-11T18:04:59+08:00 k8s-dbg-master-1 confd<span style="color:#ce5c00;font-weight:bold">[</span>35808<span style="color:#ce5c00;font-weight:bold">]</span>: INFO /root/myapp/twemproxy/conf/twemproxy.conf has md5sum 6f0f43abede612c75cb840a4840fbea3 should be 32f48664266e3fd6b56ee73a314ee272
</span></span><span style="display:flex;"><span>2018-05-11T18:04:59+08:00 k8s-dbg-master-1 confd<span style="color:#ce5c00;font-weight:bold">[</span>35808<span style="color:#ce5c00;font-weight:bold">]</span>: INFO Target config /root/myapp/twemproxy/conf/twemproxy.conf out of sync
</span></span><span style="display:flex;"><span>2018-05-11T18:04:59+08:00 k8s-dbg-master-1 confd<span style="color:#ce5c00;font-weight:bold">[</span>35808<span style="color:#ce5c00;font-weight:bold">]</span>: INFO Target config /root/myapp/twemproxy/conf/twemproxy.conf has been updated
</span></span></code></pre></div><h1 id="5-查看生成的配置文件">5. 查看生成的配置文件</h1>
<p>在<code>/etc/confd/conf.d/myapp-nginx.toml</code>中定义的配置文件的生成路径为<code>/tmp/myapp.conf</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@k8s-dbg-master-1 dest<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># cat myapp.conf</span>
</span></span><span style="display:flex;"><span>upstream cust1 <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    server 10.0.0.1:80<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    server 10.0.0.2:80<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>server <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    server_name cust1.example.com<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        proxy_pass cust1<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>upstream cust2 <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    server 10.0.0.3:80<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    server 10.0.0.4:80<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>server <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    server_name cust2.example.com<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    location / <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        proxy_pass cust2<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="6-confd动态更新twemproxy">6. confd动态更新twemproxy</h1>
<h2 id="6-1-twemproxy-toml">6.1. twemproxy.toml</h2>
<p>confd的模板源文件配置：/etc/confd/conf.d/twemproxy.toml</p>
<pre tabindex="0"><code>[template]
src = &#34;twemproxy.tmpl&#34;
dest = &#34;/root/myapp/twemproxy/conf/twemproxy.conf&#34;
keys = [
  &#34;/twemproxy/pool&#34;
]
check_cmd = &#34;/usr/local/bin/nutcracker -t -c /root/myapp/twemproxy/conf/twemproxy.conf&#34;
reload_cmd = &#34;bash /root/myapp/twemproxy/reload.sh&#34;
</code></pre><h2 id="6-2-twemproxy-tmpl">6.2. twemproxy.tmpl</h2>
<p>模板文件：/etc/confd/templates/twemproxy.tmpl</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">global</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">worker_processes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># 并发进程数, 如果为0, 这 fallback 回原来的单进程模型(不支持 config reload!)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nobody               </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># worker 进程的用户, 默认 nobody. 只要主进程是 root 用户启动才生效.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nobody              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># worker 进程的用户组</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">worker_shutdown_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 单位为秒. 用于 reload 过程中在改时间段之后强制退出旧的 worker 进程.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">pools</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{{<span style="color:#000">range gets &#34;/twemproxy/pool/*&#34;}}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>{{<span style="color:#204a87;font-weight:bold">base .Key}}</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{{<span style="color:#000">$pool := json .Value}}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">listen</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{{<span style="color:#000">$pool.ListenAddr.IP}}:{{$pool.ListenAddr.Port}}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">hash</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fnv1a_64</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 选择实例的 hash 规则</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">distribution</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ketama</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">auto_eject_hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># server 有问题是否剔除</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">redis</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 是否为 Redis 协议</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>{{<span style="color:#204a87;font-weight:bold">if $pool.Password}}redis_auth</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{{<span style="color:#000">$pool.Password}}{{end}}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">server_retry_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 被剔除多长时间后会重试</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">server_connections: 25 # NOTE</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">server 连接池的大小, 默认为 1, 建议调整</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">server_failure_limit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 失败多少次后暂时剔除</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Server 超时时间, 1 sec</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">backlog</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 连接队列大小</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">preconnect</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 预连接大小</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">servers:{{range $server := $pool.Servers}}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">     </span>- {{<span style="color:#000">$server.IP}}:{{$server.Port}}:1 {{if $server.Master}}master{{end}}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>{{<span style="color:#000">end}}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>{{<span style="color:#000">end}}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="6-3-etcd中的配置格式">6.3. etcd中的配置格式</h2>
<p><code>etcd</code>中的配置通过一个map来定义为完整的配置内容。其中<code>key</code>是<code>twemproxy</code>中<code>pool</code>的名称，<code>value</code>是<code>pool</code>的所有内容。</p>
<p>配置对应go结构体如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Pool</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ListenAddr</span>  <span style="color:#000">ListenAddr</span> <span style="color:#4e9a06">`json:&#34;ListenAddr,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Servers</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">Server</span> <span style="color:#4e9a06">`json:&#34;Servers,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Password</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;Password,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ListenAddr</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">IP</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;IP,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Port</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;Port,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Server</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">IP</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;IP,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Port</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;Port,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Master</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#4e9a06">`json:&#34;Master,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>配置对应<code>JSON</code>格式如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Json" data-lang="Json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;ListenAddr&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;IP&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;192.168.5.7&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;Port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;22225&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;Servers&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;IP&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;10.233.116.168&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;Port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;6379&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;Master&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;IP&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;10.233.110.207&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;Port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;6379&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;Master&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;Password&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;987654&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-4-生成-twemproxy-配置文件">6.4. 生成<code>twemproxy</code>配置文件</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>global:
</span></span><span style="display:flex;"><span>  worker_processes: <span style="color:#0000cf;font-weight:bold">4</span>         <span style="color:#8f5902;font-style:italic"># 并发进程数, 如果为0, 这 fallback 回原来的单进程模型(不支持 config reload!)</span>
</span></span><span style="display:flex;"><span>  user: nobody                <span style="color:#8f5902;font-style:italic"># worker 进程的用户, 默认 nobody. 只要主进程是 root 用户启动才生效.</span>
</span></span><span style="display:flex;"><span>  group: nobody               <span style="color:#8f5902;font-style:italic"># worker 进程的用户组</span>
</span></span><span style="display:flex;"><span>  worker_shutdown_timeout: <span style="color:#0000cf;font-weight:bold">30</span> <span style="color:#8f5902;font-style:italic"># 单位为秒. 用于 reload 过程中在改时间段之后强制退出旧的 worker 进程.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pools:
</span></span><span style="display:flex;"><span>  redis1:
</span></span><span style="display:flex;"><span>    listen: 192.168.5.7:22223
</span></span><span style="display:flex;"><span>    hash: fnv1a_64 <span style="color:#8f5902;font-style:italic"># 选择实例的 hash 规则</span>
</span></span><span style="display:flex;"><span>    distribution: ketama
</span></span><span style="display:flex;"><span>    auto_eject_hosts: <span style="color:#204a87">true</span> <span style="color:#8f5902;font-style:italic"># server 有问题是否剔除</span>
</span></span><span style="display:flex;"><span>    redis: <span style="color:#204a87">true</span> <span style="color:#8f5902;font-style:italic"># 是否为 Redis 协议</span>
</span></span><span style="display:flex;"><span>    redis_auth: <span style="color:#0000cf;font-weight:bold">987654</span>
</span></span><span style="display:flex;"><span>    server_retry_timeout: <span style="color:#0000cf;font-weight:bold">5000</span> <span style="color:#8f5902;font-style:italic"># 被剔除多长时间后会重试</span>
</span></span><span style="display:flex;"><span>    server_connections: <span style="color:#0000cf;font-weight:bold">25</span> <span style="color:#8f5902;font-style:italic"># NOTE: server 连接池的大小, 默认为 1, 建议调整</span>
</span></span><span style="display:flex;"><span>    server_failure_limit: <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#8f5902;font-style:italic"># 失败多少次后暂时剔除</span>
</span></span><span style="display:flex;"><span>    timeout: <span style="color:#0000cf;font-weight:bold">1000</span> <span style="color:#8f5902;font-style:italic"># Server 超时时间, 1 sec</span>
</span></span><span style="display:flex;"><span>    backlog: <span style="color:#0000cf;font-weight:bold">1024</span> <span style="color:#8f5902;font-style:italic"># 连接队列大小</span>
</span></span><span style="display:flex;"><span>    preconnect: <span style="color:#204a87">true</span> <span style="color:#8f5902;font-style:italic"># 预连接大小</span>
</span></span><span style="display:flex;"><span>    servers:
</span></span><span style="display:flex;"><span>     - 10.233.116.169:6379:1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  redis2:
</span></span><span style="display:flex;"><span>    listen: 192.168.5.7:22224
</span></span><span style="display:flex;"><span>    hash: fnv1a_64 <span style="color:#8f5902;font-style:italic"># 选择实例的 hash 规则</span>
</span></span><span style="display:flex;"><span>    distribution: ketama
</span></span><span style="display:flex;"><span>    auto_eject_hosts: <span style="color:#204a87">true</span> <span style="color:#8f5902;font-style:italic"># server 有问题是否剔除</span>
</span></span><span style="display:flex;"><span>    redis: <span style="color:#204a87">true</span> <span style="color:#8f5902;font-style:italic"># 是否为 Redis 协议</span>
</span></span><span style="display:flex;"><span>    redis_auth: <span style="color:#0000cf;font-weight:bold">987654</span>
</span></span><span style="display:flex;"><span>    server_retry_timeout: <span style="color:#0000cf;font-weight:bold">5000</span> <span style="color:#8f5902;font-style:italic"># 被剔除多长时间后会重试</span>
</span></span><span style="display:flex;"><span>    server_connections: <span style="color:#0000cf;font-weight:bold">25</span> <span style="color:#8f5902;font-style:italic"># NOTE: server 连接池的大小, 默认为 1, 建议调整</span>
</span></span><span style="display:flex;"><span>    server_failure_limit: <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#8f5902;font-style:italic"># 失败多少次后暂时剔除</span>
</span></span><span style="display:flex;"><span>    timeout: <span style="color:#0000cf;font-weight:bold">1000</span> <span style="color:#8f5902;font-style:italic"># Server 超时时间, 1 sec</span>
</span></span><span style="display:flex;"><span>    backlog: <span style="color:#0000cf;font-weight:bold">1024</span> <span style="color:#8f5902;font-style:italic"># 连接队列大小</span>
</span></span><span style="display:flex;"><span>    preconnect: <span style="color:#204a87">true</span> <span style="color:#8f5902;font-style:italic"># 预连接大小</span>
</span></span><span style="display:flex;"><span>    servers:
</span></span><span style="display:flex;"><span>     - 10.233.110.223:6379:1 master
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     - 10.233.111.21:6379:1
</span></span></code></pre></div><h1 id="7-confd的命令">7. confd的命令</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ confd --help
</span></span><span style="display:flex;"><span>Usage of confd:
</span></span><span style="display:flex;"><span>  -app-id string
</span></span><span style="display:flex;"><span>    	Vault app-id to use with the app-id backend <span style="color:#ce5c00;font-weight:bold">(</span>only used with -backend<span style="color:#ce5c00;font-weight:bold">=</span>vault and auth-type<span style="color:#ce5c00;font-weight:bold">=</span>app-id<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -auth-token string
</span></span><span style="display:flex;"><span>    	Auth bearer token to use
</span></span><span style="display:flex;"><span>  -auth-type string
</span></span><span style="display:flex;"><span>    	Vault auth backend <span style="color:#204a87">type</span> to use <span style="color:#ce5c00;font-weight:bold">(</span>only used with -backend<span style="color:#ce5c00;font-weight:bold">=</span>vault<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -backend string
</span></span><span style="display:flex;"><span>    	backend to use <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;etcd&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -basic-auth
</span></span><span style="display:flex;"><span>    	Use Basic Auth to authenticate <span style="color:#ce5c00;font-weight:bold">(</span>only used with -backend<span style="color:#ce5c00;font-weight:bold">=</span>consul and -backend<span style="color:#ce5c00;font-weight:bold">=</span>etcd<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -client-ca-keys string
</span></span><span style="display:flex;"><span>    	client ca keys
</span></span><span style="display:flex;"><span>  -client-cert string
</span></span><span style="display:flex;"><span>    	the client cert
</span></span><span style="display:flex;"><span>  -client-key string
</span></span><span style="display:flex;"><span>    	the client key
</span></span><span style="display:flex;"><span>  -confdir string
</span></span><span style="display:flex;"><span>    	confd conf directory <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;/etc/confd&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -config-file string
</span></span><span style="display:flex;"><span>    	the confd config file <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;/etc/confd/confd.toml&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -file value
</span></span><span style="display:flex;"><span>    	the YAML file to watch <span style="color:#204a87;font-weight:bold">for</span> changes <span style="color:#ce5c00;font-weight:bold">(</span>only used with -backend<span style="color:#ce5c00;font-weight:bold">=</span>file<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -filter string
</span></span><span style="display:flex;"><span>    	files filter <span style="color:#ce5c00;font-weight:bold">(</span>only used with -backend<span style="color:#ce5c00;font-weight:bold">=</span>file<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -interval int
</span></span><span style="display:flex;"><span>    	backend polling interval <span style="color:#ce5c00;font-weight:bold">(</span>default 600<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -keep-stage-file
</span></span><span style="display:flex;"><span>    	keep staged files
</span></span><span style="display:flex;"><span>  -log-level string
</span></span><span style="display:flex;"><span>    	level which confd should log messages
</span></span><span style="display:flex;"><span>  -node value
</span></span><span style="display:flex;"><span>    	list of backend nodes
</span></span><span style="display:flex;"><span>  -noop
</span></span><span style="display:flex;"><span>    	only show pending changes
</span></span><span style="display:flex;"><span>  -onetime
</span></span><span style="display:flex;"><span>    	run once and <span style="color:#204a87">exit</span>
</span></span><span style="display:flex;"><span>  -password string
</span></span><span style="display:flex;"><span>    	the password to authenticate with <span style="color:#ce5c00;font-weight:bold">(</span>only used with vault and etcd backends<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -path string
</span></span><span style="display:flex;"><span>    	Vault mount path of the auth method <span style="color:#ce5c00;font-weight:bold">(</span>only used with -backend<span style="color:#ce5c00;font-weight:bold">=</span>vault<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -prefix string
</span></span><span style="display:flex;"><span>    	key path prefix
</span></span><span style="display:flex;"><span>  -role-id string
</span></span><span style="display:flex;"><span>    	Vault role-id to use with the AppRole, Kubernetes backends <span style="color:#ce5c00;font-weight:bold">(</span>only used with -backend<span style="color:#ce5c00;font-weight:bold">=</span>vault and either auth-type<span style="color:#ce5c00;font-weight:bold">=</span>app-role or auth-type<span style="color:#ce5c00;font-weight:bold">=</span>kubernetes<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -scheme string
</span></span><span style="display:flex;"><span>    	the backend URI scheme <span style="color:#204a87;font-weight:bold">for</span> nodes retrieved from DNS SRV records <span style="color:#ce5c00;font-weight:bold">(</span>http or https<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;http&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -secret-id string
</span></span><span style="display:flex;"><span>    	Vault secret-id to use with the AppRole backend <span style="color:#ce5c00;font-weight:bold">(</span>only used with -backend<span style="color:#ce5c00;font-weight:bold">=</span>vault and auth-type<span style="color:#ce5c00;font-weight:bold">=</span>app-role<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -secret-keyring string
</span></span><span style="display:flex;"><span>    	path to armored PGP secret keyring <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">for</span> use with crypt functions<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -separator string
</span></span><span style="display:flex;"><span>    	the separator to replace <span style="color:#4e9a06">&#39;/&#39;</span> with when looking up keys in the backend, prefixed <span style="color:#4e9a06">&#39;/&#39;</span> will also be removed <span style="color:#ce5c00;font-weight:bold">(</span>only used with -backend<span style="color:#ce5c00;font-weight:bold">=</span>redis<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -srv-domain string
</span></span><span style="display:flex;"><span>    	the name of the resource record
</span></span><span style="display:flex;"><span>  -srv-record string
</span></span><span style="display:flex;"><span>    	the SRV record to search <span style="color:#204a87;font-weight:bold">for</span> backends nodes. Example: _etcd-client._tcp.example.com
</span></span><span style="display:flex;"><span>  -sync-only
</span></span><span style="display:flex;"><span>    	sync without check_cmd and reload_cmd
</span></span><span style="display:flex;"><span>  -table string
</span></span><span style="display:flex;"><span>    	the name of the DynamoDB table <span style="color:#ce5c00;font-weight:bold">(</span>only used with -backend<span style="color:#ce5c00;font-weight:bold">=</span>dynamodb<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -user-id string
</span></span><span style="display:flex;"><span>    	Vault user-id to use with the app-id backend <span style="color:#ce5c00;font-weight:bold">(</span>only used with -backend<span style="color:#ce5c00;font-weight:bold">=</span>value and auth-type<span style="color:#ce5c00;font-weight:bold">=</span>app-id<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -username string
</span></span><span style="display:flex;"><span>    	the username to authenticate as <span style="color:#ce5c00;font-weight:bold">(</span>only used with vault and etcd backends<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -version
</span></span><span style="display:flex;"><span>    	print version and <span style="color:#204a87">exit</span>
</span></span><span style="display:flex;"><span>  -watch
</span></span><span style="display:flex;"><span>    	<span style="color:#204a87">enable</span> watch support
</span></span></code></pre></div><p>参考文章：</p>
<p><a href="https://github.com/kelseyhightower/confd/blob/master/docs/installation.md">https://github.com/kelseyhightower/confd/blob/master/docs/installation.md</a></p>
<p><a href="https://github.com/kelseyhightower/confd/blob/master/docs/quick-start-guide.md">https://github.com/kelseyhightower/confd/blob/master/docs/quick-start-guide.md</a></p>
<p><a href="https://github.com/kelseyhightower/confd/blob/master/docs/template-resources.md">https://github.com/kelseyhightower/confd/blob/master/docs/template-resources.md</a></p>
<p><a href="https://github.com/kelseyhightower/confd/blob/master/docs/templates.md">https://github.com/kelseyhightower/confd/blob/master/docs/templates.md</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5531ca3712df8e070f36d75562fd0f0e">6.4 - NFS的使用</h1>
    
	<h1 id="1-nfs简介">1. NFS简介</h1>
<p>NFS，是Network File System的简写，即网络文件系统。网络文件系统是FreeBSD支持的文件系统中的一种，也被称为NFS. NFS允许一个系统在网络上与他人共享目录和文件。
通过使用NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件。</p>
<h1 id="2-nfs的安装与配置">2. NFS的安装与配置</h1>
<h2 id="2-1-服务端">2.1 服务端</h2>
<p>NFS需要安装nfs-utils、rpcbind两个包。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#可以先检查下本地是否已经安装，如果安装则无需重复安装包</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@k8s-dbg-master-1 build<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># rpm -qa|grep rpcbind</span>
</span></span><span style="display:flex;"><span>rpcbind-0.2.0-42.el7.x86_64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@k8s-dbg-master-1 build<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># rpm -qa|grep nfs</span>
</span></span><span style="display:flex;"><span>libnfsidmap-0.25-17.el7.x86_64
</span></span><span style="display:flex;"><span>nfs-utils-1.3.0-0.48.el7_4.x86_64
</span></span></code></pre></div><h3 id="2-1-1-安装nfs-utils-rpcbind两个包">2.1.1. 安装nfs-utils、rpcbind两个包</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#centos系统</span>
</span></span><span style="display:flex;"><span>yum -y install nfs-utils rpcbind
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#Ubuntu系统</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#服务端</span>
</span></span><span style="display:flex;"><span>apt-get install nfs-kernel-server
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#客户端</span>
</span></span><span style="display:flex;"><span>apt-get install nfs-common
</span></span></code></pre></div><h3 id="2-1-2-创建共享目录">2.1.2. 创建共享目录</h3>
<p>服务端共享目录：<code>/data/nfs-storage/</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /data/nfs-storage/
</span></span></code></pre></div><h3 id="2-1-3-nfs共享目录文件配置">2.1.3. NFS共享目录文件配置</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /etc/exports 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#添加以下信息</span>
</span></span><span style="display:flex;"><span>/data/nfs-storage *<span style="color:#ce5c00;font-weight:bold">(</span>rw,insecure,sync,no_subtree_check,no_root_squash<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>以上配置分为三个部分：</p>
<ul>
<li>第一部分就是本地要共享出去的目录。</li>
<li>第二部分为允许访问的主机（可以是一个IP也可以是一个IP段），<code>*</code>代表允许所有的网段访问。</li>
<li>第三部分小括号里面的，为一些权限选项。</li>
</ul>
<p><strong>权限说明</strong></p>
<ul>
<li>rw ：读写；</li>
<li>ro ：只读；</li>
<li>sync ：同步模式，内存中数据时时写入磁盘；</li>
<li>async ：不同步，把内存中数据定期写入磁盘中；</li>
<li>secure ：nfs通过1024以下的安全TCP/IP端口发送</li>
<li>insecure ：nfs通过1024以上的端口发送</li>
<li>no_root_squash ：加上这个选项后，root用户就会对共享的目录拥有至高的权限控制，就像是对本机的目录操作一样。不安全，不建议使用；</li>
<li>root_squash ：和上面的选项对应，root用户对共享目录的权限不高，只有普通用户的权限，即限制了root；</li>
<li>subtree_check ：如果共享/usr/bin之类的子目录时，强制nfs检查父目录的权限（默认）</li>
<li>no_subtree_check ：和上面相对，不检查父目录权限</li>
<li>all_squash ：不管使用NFS的用户是谁，他的身份都会被限定成为一个指定的普通用户身份；</li>
<li>anonuid/anongid ：要和root_squash 以及 all_squash一同使用，用于指定使用NFS的用户限定后的uid和gid，前提是本机的/etc/passwd中存在这个uid和gid。</li>
</ul>
<h3 id="2-1-4-启动nfs服务">2.1.4. 启动NFS服务</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#先启动rpcbind</span>
</span></span><span style="display:flex;"><span>service rpcbind start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#后启动nfs</span>
</span></span><span style="display:flex;"><span>service nfs start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#可以设置开机启动</span>
</span></span><span style="display:flex;"><span>chkconfig rpcbind on
</span></span><span style="display:flex;"><span>chkconfig nfs on
</span></span></code></pre></div><h3 id="2-1-5-服务端验证">2.1.5. 服务端验证</h3>
<p>通过<code>showmount -e</code>命令如果正常显示共享目录，表示安装正常。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@k8s-dbg-master-1 build<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># showmount -e</span>
</span></span><span style="display:flex;"><span>Export list <span style="color:#204a87;font-weight:bold">for</span> k8s-dbg-master-1:
</span></span><span style="display:flex;"><span>/data/nfs-storage *
</span></span></code></pre></div><h2 id="2-2-客户端">2.2 客户端</h2>
<h3 id="2-2-1-安装nfs-utils的包">2.2.1. 安装nfs-utils的包</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install nfs-utils.x86_64  -y
</span></span></code></pre></div><h3 id="2-2-2-创建挂载点">2.2.2. 创建挂载点</h3>
<p>客户端挂载目录：<code>/mnt/store</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /mnt/store
</span></span></code></pre></div><h3 id="2-2-3-查看nfs服务器的共享">2.2.3. 查看NFS服务器的共享</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@k8s-dbg-node-5:~# showmount -e 172.16.5.4
</span></span><span style="display:flex;"><span>Export list <span style="color:#204a87;font-weight:bold">for</span> 172.16.5.4:
</span></span><span style="display:flex;"><span>/data/nfs-storage *
</span></span></code></pre></div><h3 id="2-2-4-挂载">2.2.4. 挂载</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mount -t nfs &lt;NFS_SERVER_IP&gt;:&lt;NFS_SERVER_SHARED_DIR&gt; &lt;NFS_CLIENT_MOUNT_DIR&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#例如：</span>
</span></span><span style="display:flex;"><span>mount -t nfs 172.16.5.4:/data/nfs-storage /mnt/store
</span></span></code></pre></div><h3 id="2-2-5-验证挂载信息">2.2.5. 验证挂载信息</h3>
<p>使用<code>mount</code>命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@k8s-dbg-node-5:~# mount <span style="color:#000;font-weight:bold">|</span>grep /mnt/store
</span></span><span style="display:flex;"><span>172.16.5.4:/data/nfs-storage/k8s-storage/ssd on /mnt/store <span style="color:#204a87">type</span> nfs4 <span style="color:#ce5c00;font-weight:bold">(</span>rw,relatime,vers<span style="color:#ce5c00;font-weight:bold">=</span>4.0,rsize<span style="color:#ce5c00;font-weight:bold">=</span>1048576,wsize<span style="color:#ce5c00;font-weight:bold">=</span>1048576,namlen<span style="color:#ce5c00;font-weight:bold">=</span>255,hard,proto<span style="color:#ce5c00;font-weight:bold">=</span>tcp,port<span style="color:#ce5c00;font-weight:bold">=</span>0,timeo<span style="color:#ce5c00;font-weight:bold">=</span>600,retrans<span style="color:#ce5c00;font-weight:bold">=</span>2,sec<span style="color:#ce5c00;font-weight:bold">=</span>sys,clientaddr<span style="color:#ce5c00;font-weight:bold">=</span>172.16.200.24,local_lock<span style="color:#ce5c00;font-weight:bold">=</span>none,addr<span style="color:#ce5c00;font-weight:bold">=</span>172.16.5.4<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>使用<code>df -h</code>命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@k8s-dbg-node-5:~# df -h<span style="color:#000;font-weight:bold">|</span>grep nfs
</span></span><span style="display:flex;"><span>172.16.5.4:/data/nfs-storage                                                                                             40G   25G   13G  67% /mnt/store
</span></span></code></pre></div><p>创建文件测试</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#进入客户端的挂载目录，创建文件</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /mnt/store
</span></span><span style="display:flex;"><span>touch test.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#进入服务端的共享目录，查看客户端创建的文件是否同步</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /data/nfs-storage 
</span></span><span style="display:flex;"><span>ls
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9b6e7b7fc8e7add51ad7e8a79a48edd8">6.5 - ssh tips</h1>
    
	<h1 id="1-ssh-scp免密码">1. ssh/scp免密码</h1>
<p>A服务器地址：10.8.216.25，下面简称A</p>
<p>B服务器地址：10.8.216.26，下面简称B</p>
<p>实现A登录B免密码。</p>
<h2 id="1-1-在a生成密钥对">1.1. 在A生成密钥对</h2>
<p>无密码方式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh-keygen -t rsa -P 
</span></span></code></pre></div><p>自定义密码参数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh-keygen -C &lt;comment&gt; -f &lt;keyfile&gt; -t rsa -P <span style="color:#4e9a06">&#34;&lt;passphrase&gt;&#34;</span>
</span></span></code></pre></div><p>执行上述命令，一路回车，会在当前登录用户的home目录下的.ssh目录下生成id_rsa和id_rsa.pub两个文件，分别代表密钥对的私钥和公钥，如下图所示：</p>
<p><img src="https://img-blog.csdn.net/20170916200144505?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHV3aF8=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></p>
<h2 id="1-2-拷贝a的公钥-id-rsa-pub-到b">1.2. 拷贝A的公钥（id_rsa.pub）到B</h2>
<p>这里拷贝到B的root用户home目录下为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>scp /root/.ssh/id_rsa.pub root@10.8.216.26:/root
</span></span></code></pre></div><h2 id="1-3-登录b">1.3. 登录B</h2>
<p>拷贝A的id_rsa.pub内容到.ssh目录下的authorized_keys文件中</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> /root
</span></span><span style="display:flex;"><span>cat id_rsa.pub &gt;&gt; .ssh/authorized_keys
</span></span></code></pre></div><p>如图：</p>
<p><img src="https://img-blog.csdn.net/20170916200919602?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHV3aF8=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></p>
<h2 id="1-4-登录或拷贝">1.4. 登录或拷贝</h2>
<p>此时在A中用SSH登录B或向B拷贝文件，将不需要密码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh root@10.8.216.26
</span></span><span style="display:flex;"><span>scp abc.txt root@10.8.216.26:/root
</span></span></code></pre></div><h1 id="2-配置跳板机快速登录">2. 配置跳板机快速登录</h1>
<h2 id="2-1-配置ssh-config文件">2.1. 配置ssh config文件</h2>
<p>ssh config 路径：~/.ssh/config</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>AddKeysToAgent yes
</span></span><span style="display:flex;"><span>ServerAliveInterval <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>Host jump
</span></span><span style="display:flex;"><span>        HostName <span style="color:#ce5c00;font-weight:bold">{</span>jump_ip<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        Port    <span style="color:#ce5c00;font-weight:bold">{</span>port<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        User    <span style="color:#ce5c00;font-weight:bold">{</span>username<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        forwardagent yes
</span></span><span style="display:flex;"><span>        identityfile ~/.ssh/id_rsa
</span></span><span style="display:flex;"><span>Host *.gw
</span></span><span style="display:flex;"><span>        user <span style="color:#ce5c00;font-weight:bold">{</span>username<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        port <span style="color:#ce5c00;font-weight:bold">{</span>port<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        proxycommand ssh -W <span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">echo</span> %h <span style="color:#000;font-weight:bold">|</span> sed -e <span style="color:#4e9a06">&#34;s/.gw</span>$<span style="color:#4e9a06">//&#34;</span><span style="color:#204a87;font-weight:bold">)</span>:%p jump
</span></span><span style="display:flex;"><span>Host bj*
</span></span><span style="display:flex;"><span>        User    <span style="color:#ce5c00;font-weight:bold">{</span>username<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        Port    <span style="color:#ce5c00;font-weight:bold">{</span>port<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        proxycommand ssh -W 192.168.123.<span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">echo</span> %h <span style="color:#000;font-weight:bold">|</span> awk -F <span style="color:#4e9a06">&#39;bj&#39;</span> <span style="color:#4e9a06">&#39;{print $2}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>:%p jump    
</span></span></code></pre></div><p>多层跳板机</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Host jump1
</span></span><span style="display:flex;"><span>        Hostname <span style="color:#ce5c00;font-weight:bold">{</span>jump1_ip<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        Port  <span style="color:#ce5c00;font-weight:bold">{</span>port<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        User  <span style="color:#ce5c00;font-weight:bold">{</span>username<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        forwardagent yes
</span></span><span style="display:flex;"><span>        identityfile ~/.ssh/id_rsa
</span></span><span style="display:flex;"><span>Host jump2
</span></span><span style="display:flex;"><span>        Hostname <span style="color:#ce5c00;font-weight:bold">{</span>jump2_ip<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        Port <span style="color:#ce5c00;font-weight:bold">{</span>port<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        User <span style="color:#ce5c00;font-weight:bold">{</span>username<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        ProxyCommand ssh -q -x -W %h:%p jump1
</span></span><span style="display:flex;"><span>Host *
</span></span><span style="display:flex;"><span>        Hostname %h
</span></span><span style="display:flex;"><span>        Port  <span style="color:#ce5c00;font-weight:bold">{</span>port<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        User  <span style="color:#ce5c00;font-weight:bold">{</span>username<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        ProxyCommand ssh -q -x -W %h:%p jump2
</span></span></code></pre></div><h2 id="2-2-记录机器文件">2.2. 记录机器文件</h2>
<p>将关键字和IP写入文件记录，例如 <code>~/.my_hosts</code>。</p>
<p>示例：可以是IP + 环境等关键字，中间用空格隔开。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># release</span>
</span></span><span style="display:flex;"><span>192.168.123.11 rel-node-11
</span></span><span style="display:flex;"><span>192.168.123.12 rel-node-12
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pre</span>
</span></span><span style="display:flex;"><span>192.168.321.13 pre-node-13
</span></span><span style="display:flex;"><span>192.168.321.14 pre-node-14
</span></span><span style="display:flex;"><span>192.168.321.15 pre-node-15
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dev</span>
</span></span><span style="display:flex;"><span>192.168.111.16 dev-node-16
</span></span><span style="display:flex;"><span>192.168.111.17 dev-node-17
</span></span></code></pre></div><h2 id="2-3-安装fzf">2.3. 安装fzf</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for mac</span>
</span></span><span style="display:flex;"><span>brew install fzf
</span></span></code></pre></div><h2 id="2-4-设置命令别名">2.4. 设置命令别名</h2>
<p>设置 alias 到shell rc 文件(.bashrc / .zshrc)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">goto</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;ssh \$(cat ~/.my_hosts | fzf | awk &#39;{ printf(\&#34;%s.gw\&#34;, \$1)}&#39;)&#34;</span>
</span></span></code></pre></div><h2 id="2-5-使用">2.5. 使用</h2>
<p>使用别名命令，输入关键字搜索，点击回车进入指定机器。</p>
<p>也可以使用ssh命令登录机器别名。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh bj11
</span></span></code></pre></div><h1 id="3-ssh配置项说明">3. ssh配置项说明</h1>
<p>可以通过man查看ssh配置说明</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>man ssh_config
</span></span></code></pre></div><p>配置文件示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Host jump
</span></span><span style="display:flex;"><span>  port <span style="color:#0000cf;font-weight:bold">22</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Host * !jump
</span></span><span style="display:flex;"><span>  StrictHostKeyChecking no
</span></span><span style="display:flex;"><span>  HostName %h
</span></span><span style="display:flex;"><span>  UserKnownHostsFile /dev/null
</span></span><span style="display:flex;"><span>  LogLevel ERROR
</span></span><span style="display:flex;"><span>  IdentityFile ~/.ssh/id_rsa
</span></span><span style="display:flex;"><span>  ProxyCommand ssh -p <span style="color:#0000cf;font-weight:bold">22</span> -F /dev/null jump -W %h:%p
</span></span><span style="display:flex;"><span>  SendEnv LANG LC_*
</span></span></code></pre></div><p>配置项说明：</p>
<ul>
<li>
<p>Host: 标识设备，<code>*</code>表示通配所有字符，<code>!</code>表示例外通配。</p>
</li>
<li>
<p>StrictHostKeyChecking no：连接时不进行公钥交互确认操作。</p>
</li>
<li>
<p>UserKnownHostsFile /dev/null：不提示确认known_hosts文件。</p>
</li>
<li>
<p>ProxyCommand：代理命令</p>
</li>
</ul>
<p>如果使用命令加参数的方式：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh -o <span style="color:#000">StrictHostKeyChecking</span><span style="color:#ce5c00;font-weight:bold">=</span>no -o <span style="color:#000">UserKnownHostsFile</span><span style="color:#ce5c00;font-weight:bold">=</span>/dev/null -o <span style="color:#000">ProxyCommand</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;ssh -p 22 jump -W %h:%p&#34;</span> 
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2fced7315a2daf4cf08293398519ee28">6.6 - Supervisor的使用</h1>
    
	<h1 id="1-supervisor简介">1. Supervisor简介</h1>
<p>Supervisord 是用 Python 实现的一款的进程管理工具，supervisord 要求管理的程序是非 daemon 程序，supervisord 会帮你把它转成 daemon 程序，因此如果用 supervisord 来管理进程，进程需要以非daemon的方式启动。</p>
<p>例如：管理nginx 的话，必须在 nginx 的配置文件里添加一行设置 daemon off 让 nginx 以非 daemon 方式启动。</p>
<h1 id="2-supervisor安装">2. Supervisor安装</h1>
<p>以centos系统为例，以下两种方式选择其一。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># yum install 的方式</span>
</span></span><span style="display:flex;"><span>yum install -y supervisor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># easy_install的方式</span>
</span></span><span style="display:flex;"><span>yum install -y python-setuptools
</span></span><span style="display:flex;"><span>easy_install supervisor
</span></span><span style="display:flex;"><span>echo_supervisord_conf &gt;/etc/supervisord.conf
</span></span></code></pre></div><h1 id="3-supervisor的配置">3. Supervisor的配置</h1>
<h2 id="3-1-supervisord-conf的配置">3.1. supervisord.conf的配置</h2>
<p>如果使用<code>yum install -y supervisor</code>的命令安装，会生成默认配置<code>/etc/supervisord.conf</code>和目录<code>/etc/supervisord.d</code>，如果没有则自行创建。</p>
<p>在<code>/etc/supervisord.d</code>的目录下创建<code>conf</code>和<code>log</code>两个目录，<code>conf</code>用于存放管理进程的配置，<code>log</code>用于存放管理进程的日志。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> /etc/supervisord.d
</span></span><span style="display:flex;"><span>mkdir conf log
</span></span></code></pre></div><p>修改<code>/etc/supervisord.conf</code>的<code>[include]</code>部分，即载入<code>/etc/supervisord.d/conf</code>目录下的所有配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /etc/supervisord.conf
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>include<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">files</span> <span style="color:#ce5c00;font-weight:bold">=</span> supervisord.d/conf/*.conf
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>也可以修改supervisor应用日志的目录，默认日志路径为<code>/var/log/supervisor/supervisord.log</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /etc/supervisord.conf
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>supervisord<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">logfile</span><span style="color:#ce5c00;font-weight:bold">=</span>/var/log/supervisor/supervisord.log  <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>main log file<span style="color:#000;font-weight:bold">;</span>default <span style="color:#000">$CWD</span>/supervisord.log<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">logfile_maxbytes</span><span style="color:#ce5c00;font-weight:bold">=</span>50MB       <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>max main logfile bytes b4 rotation<span style="color:#000;font-weight:bold">;</span>default 50MB<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">logfile_backups</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>          <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>num of main logfile rotation backups<span style="color:#000;font-weight:bold">;</span>default 10<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">loglevel</span><span style="color:#ce5c00;font-weight:bold">=</span>info               <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>log level<span style="color:#000;font-weight:bold">;</span>default info<span style="color:#000;font-weight:bold">;</span> others: debug,warn,trace<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">pidfile</span><span style="color:#ce5c00;font-weight:bold">=</span>/var/run/supervisord.pid <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>supervisord pidfile<span style="color:#000;font-weight:bold">;</span>default supervisord.pid<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h2 id="3-2-管理应用的配置">3.2. 管理应用的配置</h2>
<p>进入到<code>/etc/supervisord.d/conf</code>目录，创建管理应用的配置，可以创建多个应用配置。</p>
<p>例如，创建<code>confd.conf</code>配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>program:confd<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">directory</span> <span style="color:#ce5c00;font-weight:bold">=</span> /usr/local/bin <span style="color:#000;font-weight:bold">;</span> 程序的启动目录
</span></span><span style="display:flex;"><span><span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">=</span> /usr/local/bin/confd -config-file /etc/confd/confd.toml <span style="color:#000;font-weight:bold">;</span> 启动命令，与命令行启动的命令是一样的
</span></span><span style="display:flex;"><span><span style="color:#000">autostart</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>     <span style="color:#000;font-weight:bold">;</span> 在 supervisord 启动的时候也自动启动
</span></span><span style="display:flex;"><span><span style="color:#000">startsecs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>        <span style="color:#000;font-weight:bold">;</span> 启动 <span style="color:#0000cf;font-weight:bold">5</span> 秒后没有异常退出，就当作已经正常启动了
</span></span><span style="display:flex;"><span><span style="color:#000">autorestart</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>   <span style="color:#000;font-weight:bold">;</span> 程序异常退出后自动重启
</span></span><span style="display:flex;"><span><span style="color:#000">startretries</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>     <span style="color:#000;font-weight:bold">;</span> 启动失败自动重试次数，默认是 <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> root          <span style="color:#000;font-weight:bold">;</span> 用哪个用户启动
</span></span><span style="display:flex;"><span><span style="color:#000">redirect_stderr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>  <span style="color:#000;font-weight:bold">;</span> 把 stderr 重定向到 stdout，默认 <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#000">stdout_logfile_maxbytes</span> <span style="color:#ce5c00;font-weight:bold">=</span> 20MB  <span style="color:#000;font-weight:bold">;</span> stdout 日志文件大小，默认 50MB
</span></span><span style="display:flex;"><span><span style="color:#000">stdout_logfile_backups</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">20</span>     <span style="color:#000;font-weight:bold">;</span> stdout 日志文件备份数
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）
</span></span><span style="display:flex;"><span><span style="color:#000">stdout_logfile</span> <span style="color:#ce5c00;font-weight:bold">=</span> /etc/supervisord.d/log/confd.log  <span style="color:#000;font-weight:bold">;</span>日志统一放在log目录下
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> 可以通过 environment 来添加需要的环境变量，一种常见的用法是修改 PYTHONPATH
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">PYTHONPATH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$PYTHONPATH</span>:/path/to/somewhere
</span></span></code></pre></div><h1 id="4-surpervisor的启动">4. Surpervisor的启动</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># supervisord二进制启动</span>
</span></span><span style="display:flex;"><span>supervisord -c /etc/supervisord.conf
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 检查进程</span>
</span></span><span style="display:flex;"><span>ps aux <span style="color:#000;font-weight:bold">|</span> grep supervisord
</span></span></code></pre></div><p>或者以systemd的方式管理</p>
<p>vi /etc/rc.d/init.d/supervisord</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># /etc/rc.d/init.d/supervisord</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Supervisor is a client/server system that</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allows its users to monitor and control a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># number of processes on UNIX-like operating</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># systems.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># chkconfig: - 64 36</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># description: Supervisor Server</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># processname: supervisord</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Source init functions</span>
</span></span><span style="display:flex;"><span>. /etc/rc.d/init.d/functions
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">prog</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;supervisord&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">prefix</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/usr&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">exec_prefix</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">prefix</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">prog_bin</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">exec_prefix</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/bin/supervisord&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PIDFILE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/var/run/</span><span style="color:#000">$prog</span><span style="color:#4e9a06">.pid&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>start<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87">echo</span> -n $<span style="color:#4e9a06">&#34;Starting </span><span style="color:#000">$prog</span><span style="color:#4e9a06">: &#34;</span>
</span></span><span style="display:flex;"><span>       daemon <span style="color:#000">$prog_bin</span> --pidfile <span style="color:#000">$PIDFILE</span> -c /etc/supervisord.conf
</span></span><span style="display:flex;"><span>       <span style="color:#ce5c00;font-weight:bold">[</span> -f <span style="color:#000">$PIDFILE</span> <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> success $<span style="color:#4e9a06">&#34;</span><span style="color:#000">$prog</span><span style="color:#4e9a06"> startup&#34;</span> <span style="color:#ce5c00;font-weight:bold">||</span> failure $<span style="color:#4e9a06">&#34;</span><span style="color:#000">$prog</span><span style="color:#4e9a06"> startup&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87">echo</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stop<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87">echo</span> -n $<span style="color:#4e9a06">&#34;Shutting down </span><span style="color:#000">$prog</span><span style="color:#4e9a06">: &#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#ce5c00;font-weight:bold">[</span> -f <span style="color:#000">$PIDFILE</span> <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> killproc <span style="color:#000">$prog</span> <span style="color:#ce5c00;font-weight:bold">||</span> success $<span style="color:#4e9a06">&#34;</span><span style="color:#000">$prog</span><span style="color:#4e9a06"> shutdown&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87">echo</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$1</span><span style="color:#4e9a06">&#34;</span> in
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> start<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   start
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> stop<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   stop
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> status<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       status <span style="color:#000">$prog</span>
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> restart<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   stop
</span></span><span style="display:flex;"><span>   start
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> *<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Usage: </span><span style="color:#000">$0</span><span style="color:#4e9a06"> {start|stop|restart|status}&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">esac</span>
</span></span></code></pre></div><p>设置开机启动及systemd方式启动。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo chmod +x /etc/rc.d/init.d/supervisord
</span></span><span style="display:flex;"><span>sudo chkconfig --add supervisord
</span></span><span style="display:flex;"><span>sudo chkconfig supervisord on
</span></span><span style="display:flex;"><span>sudo service supervisord start
</span></span></code></pre></div><h1 id="5-supervisorctl-supervisord">5. supervisorctl&amp;supervisord</h1>
<p>Supervisord 安装完成后有两个可用的命令行 <code>supervisord</code> 和 <code>supervisorctl</code>，命令使用解释如下：</p>
<h2 id="5-1-supervisorctl">5.1. supervisorctl</h2>
<ul>
<li><code>supervisorctl stop programxxx</code>，停止某一个进程(programxxx)，programxxx 为 [program:beepkg] 里配置的值，这个示例就是 beepkg。</li>
<li><code>supervisorctl start programxxx</code>，启动某个进程。</li>
<li><code>supervisorctl restart programxxx</code>，重启某个进程。</li>
<li><code>supervisorctl status</code>，查看进程状态。</li>
<li><code>supervisorctl stop groupworker</code> ，重启所有属于名为 groupworker 这个分组的进程(start,restart 同理)。</li>
<li><code>supervisorctl stop all</code>，停止全部进程，注：start、restart、stop 都不会载入最新的配置文件。</li>
<li><code>supervisorctl reload</code>，载入最新的配置文件，停止原有进程并按新的配置启动、管理所有进程。</li>
<li><code>supervisorctl update</code>，根据最新的配置文件，启动新配置或有改动的进程，配置没有改动的进程不会受影响而重启。</li>
</ul>
<p>更多参考：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ supervisorctl --help
</span></span><span style="display:flex;"><span>supervisorctl -- control applications run by supervisord from the cmd line.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage: /usr/bin/supervisorctl <span style="color:#ce5c00;font-weight:bold">[</span>options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>action <span style="color:#ce5c00;font-weight:bold">[</span>arguments<span style="color:#ce5c00;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Options:
</span></span><span style="display:flex;"><span>-c/--configuration -- configuration file path <span style="color:#ce5c00;font-weight:bold">(</span>default /etc/supervisord.conf<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-h/--help -- print usage message and <span style="color:#204a87">exit</span>
</span></span><span style="display:flex;"><span>-i/--interactive -- start an interactive shell after executing commands
</span></span><span style="display:flex;"><span>-s/--serverurl URL -- URL on which supervisord server is listening
</span></span><span style="display:flex;"><span>     <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;http://localhost:9001&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>-u/--username -- username to use <span style="color:#204a87;font-weight:bold">for</span> authentication with server
</span></span><span style="display:flex;"><span>-p/--password -- password to use <span style="color:#204a87;font-weight:bold">for</span> authentication with server
</span></span><span style="display:flex;"><span>-r/--history-file -- keep a readline <span style="color:#204a87">history</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">if</span> readline is available<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>action <span style="color:#ce5c00;font-weight:bold">[</span>arguments<span style="color:#ce5c00;font-weight:bold">]</span> -- see below
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Actions are commands like <span style="color:#4e9a06">&#34;tail&#34;</span> or <span style="color:#4e9a06">&#34;stop&#34;</span>.  If -i is specified or no action is
</span></span><span style="display:flex;"><span>specified on the <span style="color:#204a87">command</span> line, a <span style="color:#4e9a06">&#34;shell&#34;</span> interpreting actions typed
</span></span><span style="display:flex;"><span>interactively is started.  Use the action <span style="color:#4e9a06">&#34;help&#34;</span> to find out about available
</span></span><span style="display:flex;"><span>actions.
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># supervisorctl status</span>
</span></span><span style="display:flex;"><span>confd                            RUNNING   pid 31256, uptime 0:11:24
</span></span><span style="display:flex;"><span>twemproxy                        RUNNING   pid 31255, uptime 0:11:24
</span></span></code></pre></div><h2 id="5-2-supervisord">5.2. supervisord</h2>
<ul>
<li>supervisord，初始启动 Supervisord，启动、管理配置中设置的进程。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ supervisord --help
</span></span><span style="display:flex;"><span>supervisord -- run a <span style="color:#204a87">set</span> of applications as daemons.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage: /usr/bin/supervisord <span style="color:#ce5c00;font-weight:bold">[</span>options<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Options:
</span></span><span style="display:flex;"><span>-c/--configuration FILENAME -- configuration file
</span></span><span style="display:flex;"><span>-n/--nodaemon -- run in the foreground <span style="color:#ce5c00;font-weight:bold">(</span>same as <span style="color:#4e9a06">&#39;nodaemon true&#39;</span> in config file<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-h/--help -- print this usage message and <span style="color:#204a87">exit</span>
</span></span><span style="display:flex;"><span>-v/--version -- print supervisord version number and <span style="color:#204a87">exit</span>
</span></span><span style="display:flex;"><span>-u/--user USER -- run supervisord as this user <span style="color:#ce5c00;font-weight:bold">(</span>or numeric uid<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-m/--umask UMASK -- use this <span style="color:#204a87">umask</span> <span style="color:#204a87;font-weight:bold">for</span> daemon subprocess <span style="color:#ce5c00;font-weight:bold">(</span>default is 022<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-d/--directory DIRECTORY -- directory to chdir to when daemonized
</span></span><span style="display:flex;"><span>-l/--logfile FILENAME -- use FILENAME as logfile path
</span></span><span style="display:flex;"><span>-y/--logfile_maxbytes BYTES -- use BYTES to limit the max size of logfile
</span></span><span style="display:flex;"><span>-z/--logfile_backups NUM -- number of backups to keep when max bytes reached
</span></span><span style="display:flex;"><span>-e/--loglevel LEVEL -- use LEVEL as log level <span style="color:#ce5c00;font-weight:bold">(</span>debug,info,warn,error,critical<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-j/--pidfile FILENAME -- write a pid file <span style="color:#204a87;font-weight:bold">for</span> the daemon process to FILENAME
</span></span><span style="display:flex;"><span>-i/--identifier STR -- identifier used <span style="color:#204a87;font-weight:bold">for</span> this instance of supervisord
</span></span><span style="display:flex;"><span>-q/--childlogdir DIRECTORY -- the log directory <span style="color:#204a87;font-weight:bold">for</span> child process logs
</span></span><span style="display:flex;"><span>-k/--nocleanup --  prevent the process from performing cleanup <span style="color:#ce5c00;font-weight:bold">(</span>removal of
</span></span><span style="display:flex;"><span>                   old automatic child log files<span style="color:#ce5c00;font-weight:bold">)</span> at startup.
</span></span><span style="display:flex;"><span>-a/--minfds NUM -- the minimum number of file descriptors <span style="color:#204a87;font-weight:bold">for</span> start success
</span></span><span style="display:flex;"><span>-t/--strip_ansi -- strip ansi escape codes from process output
</span></span><span style="display:flex;"><span>--minprocs NUM  -- the minimum number of processes available <span style="color:#204a87;font-weight:bold">for</span> start success
</span></span><span style="display:flex;"><span>--profile_options OPTIONS -- run supervisord under profiler and output
</span></span><span style="display:flex;"><span>                             results based on OPTIONS, which  is a comma-sep<span style="color:#4e9a06">&#39;d
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                             list of &#39;</span>cumulative<span style="color:#4e9a06">&#39;, &#39;</span>calls<span style="color:#4e9a06">&#39;, and/or &#39;</span>callers<span style="color:#4e9a06">&#39;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                             e.g. &#39;</span>cumulative,callers<span style="color:#a40000">&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="6-supervisor控制台">6. Supervisor控制台</h1>
<p>在<code>/etc/supervisord.conf</code>中修改<code>[inet_http_server] </code>的参数，具体如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>inet_http_server<span style="color:#ce5c00;font-weight:bold">]</span>         <span style="color:#000;font-weight:bold">;</span> inet <span style="color:#ce5c00;font-weight:bold">(</span>TCP<span style="color:#ce5c00;font-weight:bold">)</span> server disabled by default
</span></span><span style="display:flex;"><span><span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">=</span>*:9001        <span style="color:#000;font-weight:bold">;</span> ip_address:port specifier, *:port <span style="color:#204a87;font-weight:bold">for</span> all iface
</span></span><span style="display:flex;"><span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span>root             <span style="color:#000;font-weight:bold">;</span> default is no username <span style="color:#ce5c00;font-weight:bold">(</span>open server<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span>xxxx               <span style="color:#000;font-weight:bold">;</span> default is no password <span style="color:#ce5c00;font-weight:bold">(</span>open server<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>修改后重启supervisor进程，在浏览器访问 <code>http://&lt;host-ip&gt;:9001</code>。</p>
<p>具体如下：</p>
<p><img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1528457482/article/linux/supervisor.png" alt="supervisor"></p>
<h1 id="7-supervisor-conf详细配置">7. supervisor.conf详细配置</h1>
<p>cat /etc/supervisord.conf</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> Sample supervisor config file.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>unix_http_server<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">file</span><span style="color:#ce5c00;font-weight:bold">=</span>/var/run/supervisor/supervisor.sock   <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>the path to the socket file<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">chmod</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0700</span>                 <span style="color:#000;font-weight:bold">;</span> sockef file mode <span style="color:#ce5c00;font-weight:bold">(</span>default 0700<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">chown</span><span style="color:#ce5c00;font-weight:bold">=</span>nobody:nogroup       <span style="color:#000;font-weight:bold">;</span> socket file uid:gid owner
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span>user              <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>default is no username <span style="color:#ce5c00;font-weight:bold">(</span>open server<span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>               <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>default is no password <span style="color:#ce5c00;font-weight:bold">(</span>open server<span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#ce5c00;font-weight:bold">[</span>inet_http_server<span style="color:#ce5c00;font-weight:bold">]</span>         <span style="color:#000;font-weight:bold">;</span> inet <span style="color:#ce5c00;font-weight:bold">(</span>TCP<span style="color:#ce5c00;font-weight:bold">)</span> server disabled by default
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1:9001        <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>ip_address:port specifier, *:port <span style="color:#204a87;font-weight:bold">for</span> all iface<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">username</span><span style="color:#ce5c00;font-weight:bold">=</span>user              <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>default is no username <span style="color:#ce5c00;font-weight:bold">(</span>open server<span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>               <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>default is no password <span style="color:#ce5c00;font-weight:bold">(</span>open server<span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>supervisord<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">logfile</span><span style="color:#ce5c00;font-weight:bold">=</span>/var/log/supervisor/supervisord.log  <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>main log file<span style="color:#000;font-weight:bold">;</span>default <span style="color:#000">$CWD</span>/supervisord.log<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">logfile_maxbytes</span><span style="color:#ce5c00;font-weight:bold">=</span>50MB       <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>max main logfile bytes b4 rotation<span style="color:#000;font-weight:bold">;</span>default 50MB<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">logfile_backups</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>          <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>num of main logfile rotation backups<span style="color:#000;font-weight:bold">;</span>default 10<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">loglevel</span><span style="color:#ce5c00;font-weight:bold">=</span>info               <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>log level<span style="color:#000;font-weight:bold">;</span>default info<span style="color:#000;font-weight:bold">;</span> others: debug,warn,trace<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">pidfile</span><span style="color:#ce5c00;font-weight:bold">=</span>/var/run/supervisord.pid <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>supervisord pidfile<span style="color:#000;font-weight:bold">;</span>default supervisord.pid<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">nodaemon</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>              <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>start in foreground <span style="color:#204a87;font-weight:bold">if</span> true<span style="color:#000;font-weight:bold">;</span>default <span style="color:#204a87">false</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">minfds</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1024</span>                 <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>min. avail startup file descriptors<span style="color:#000;font-weight:bold">;</span>default 1024<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">minprocs</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">200</span>                <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>min. avail process descriptors<span style="color:#000;font-weight:bold">;</span>default 200<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">umask</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">022</span>                  <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>process file creation umask<span style="color:#000;font-weight:bold">;</span>default 022<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">=</span>chrism                 <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>default is current user, required <span style="color:#204a87;font-weight:bold">if</span> root<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">identifier</span><span style="color:#ce5c00;font-weight:bold">=</span>supervisor       <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>supervisord identifier, default is <span style="color:#4e9a06">&#39;supervisor&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">directory</span><span style="color:#ce5c00;font-weight:bold">=</span>/tmp              <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>default is not to <span style="color:#204a87">cd</span> during start<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">nocleanup</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>              <span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">(</span>don<span style="color:#4e9a06">&#39;t clean up tempfiles at start;default false)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;childlogdir=/tmp            ; (&#39;</span>AUTO<span style="color:#4e9a06">&#39; child log dir, default $TEMP)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;environment=KEY=value       ; (key value pairs to add to environment)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;strip_ansi=false            ; (strip ansi escape codes in logs; def. false)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">; the below section must remain in the config file for RPC
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">; (supervisorctl/web interface) to work, additional interfaces may be
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">; added by defining them in separate rpcinterface: sections
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[rpcinterface:supervisor]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[supervisorctl]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">serverurl=unix:///var/run/supervisor/supervisor.sock ; use a unix:// URL  for a unix socket
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;serverurl=http://127.0.0.1:9001 ; use an http:// url to specify an inet socket
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;username=chris              ; should be same as http_username if set
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;password=123                ; should be same as http_password if set
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;prompt=mysupervisor         ; cmd line prompt (default &#34;supervisor&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;history_file=~/.sc_history  ; use readline history if available
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">; The below sample program section shows all possible program subsection values,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">; create one or more &#39;</span>real<span style="color:#4e9a06">&#39; program: sections to be able to control them under
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">; supervisor.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;[program:theprogramname]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;command=/bin/cat              ; the program (relative uses PATH, can take args)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;process_name=%(program_name)s ; process_name expr (default %(program_name)s)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;numprocs=1                    ; number of processes copies to start (def 1)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;directory=/tmp                ; directory to cwd to before exec (def no cwd)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;umask=022                     ; umask for process (default None)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;priority=999                  ; the relative start priority (default 999)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;autostart=true                ; start at supervisord start (default: true)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;autorestart=true              ; retstart at unexpected quit (default: true)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;startsecs=10                  ; number of secs prog must stay running (def. 1)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;startretries=3                ; max # of serial start failures (default 3)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;exitcodes=0,2                 ; &#39;</span>expected<span style="color:#4e9a06">&#39; exit codes for process (default 0,2)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;stopsignal=QUIT               ; signal used to kill process (default TERM)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;stopwaitsecs=10               ; max num secs to wait b4 SIGKILL (default 10)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;user=chrism                   ; setuid to this UNIX account to run the program
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;redirect_stderr=true          ; redirect proc stderr to stdout (default false)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;stdout_logfile=/a/path        ; stdout log path, NONE for none; default AUTO
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;stdout_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;stdout_logfile_backups=10     ; # of stdout logfile backups (default 10)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;stdout_capture_maxbytes=1MB   ; number of bytes in &#39;</span>capturemode<span style="color:#4e9a06">&#39; (default 0)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;stdout_events_enabled=false   ; emit events on stdout writes (default false)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;stderr_logfile=/a/path        ; stderr log path, NONE for none; default AUTO
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;stderr_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;stderr_logfile_backups=10     ; # of stderr logfile backups (default 10)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;stderr_capture_maxbytes=1MB   ; number of bytes in &#39;</span>capturemode<span style="color:#4e9a06">&#39; (default 0)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;stderr_events_enabled=false   ; emit events on stderr writes (default false)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;environment=A=1,B=2           ; process environment additions (def no adds)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;serverurl=AUTO                ; override serverurl computation (childutils)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">; The below sample eventlistener section shows all possible
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">; eventlistener subsection values, create one or more &#39;</span>real<span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">; eventlistener: sections to be able to handle event notifications
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">; sent by supervisor.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;[eventlistener:theeventlistenername]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;command=/bin/eventlistener    ; the program (relative uses PATH, can take args)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;process_name=%(program_name)s ; process_name expr (default %(program_name)s)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;numprocs=1                    ; number of processes copies to start (def 1)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">;events=EVENT                  ; event notif. types to subscribe to (req&#39;</span>d<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">buffer_size</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>                <span style="color:#000;font-weight:bold">;</span> event buffer queue size <span style="color:#ce5c00;font-weight:bold">(</span>default 10<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">directory</span><span style="color:#ce5c00;font-weight:bold">=</span>/tmp                <span style="color:#000;font-weight:bold">;</span> directory to cwd to before <span style="color:#204a87">exec</span> <span style="color:#ce5c00;font-weight:bold">(</span>def no cwd<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">umask</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">022</span>                     <span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">umask</span> <span style="color:#204a87;font-weight:bold">for</span> process <span style="color:#ce5c00;font-weight:bold">(</span>default None<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">priority</span><span style="color:#ce5c00;font-weight:bold">=</span>-1                   <span style="color:#000;font-weight:bold">;</span> the relative start priority <span style="color:#ce5c00;font-weight:bold">(</span>default -1<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">autostart</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>                <span style="color:#000;font-weight:bold">;</span> start at supervisord start <span style="color:#ce5c00;font-weight:bold">(</span>default: <span style="color:#204a87">true</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">autorestart</span><span style="color:#ce5c00;font-weight:bold">=</span>unexpected        <span style="color:#000;font-weight:bold">;</span> restart at unexpected quit <span style="color:#ce5c00;font-weight:bold">(</span>default: unexpected<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">startsecs</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>                  <span style="color:#000;font-weight:bold">;</span> number of secs prog must stay running <span style="color:#ce5c00;font-weight:bold">(</span>def. 1<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">startretries</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>                <span style="color:#000;font-weight:bold">;</span> max <span style="color:#8f5902;font-style:italic"># of serial start failures (default 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">exitcodes</span><span style="color:#ce5c00;font-weight:bold">=</span>0,2                 <span style="color:#000;font-weight:bold">;</span> <span style="color:#4e9a06">&#39;expected&#39;</span> <span style="color:#204a87">exit</span> codes <span style="color:#204a87;font-weight:bold">for</span> process <span style="color:#ce5c00;font-weight:bold">(</span>default 0,2<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">stopsignal</span><span style="color:#ce5c00;font-weight:bold">=</span>QUIT               <span style="color:#000;font-weight:bold">;</span> signal used to <span style="color:#204a87">kill</span> process <span style="color:#ce5c00;font-weight:bold">(</span>default TERM<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">stopwaitsecs</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>               <span style="color:#000;font-weight:bold">;</span> max num secs to <span style="color:#204a87">wait</span> b4 SIGKILL <span style="color:#ce5c00;font-weight:bold">(</span>default 10<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">=</span>chrism                   <span style="color:#000;font-weight:bold">;</span> setuid to this UNIX account to run the program
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">redirect_stderr</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>          <span style="color:#000;font-weight:bold">;</span> redirect proc stderr to stdout <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#204a87">false</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">stdout_logfile</span><span style="color:#ce5c00;font-weight:bold">=</span>/a/path        <span style="color:#000;font-weight:bold">;</span> stdout log path, NONE <span style="color:#204a87;font-weight:bold">for</span> none<span style="color:#000;font-weight:bold">;</span> default AUTO
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">stdout_logfile_maxbytes</span><span style="color:#ce5c00;font-weight:bold">=</span>1MB   <span style="color:#000;font-weight:bold">;</span> max <span style="color:#8f5902;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">stdout_logfile_backups</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>     <span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic"># of stdout logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">stdout_events_enabled</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>   <span style="color:#000;font-weight:bold">;</span> emit events on stdout writes <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#204a87">false</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">stderr_logfile</span><span style="color:#ce5c00;font-weight:bold">=</span>/a/path        <span style="color:#000;font-weight:bold">;</span> stderr log path, NONE <span style="color:#204a87;font-weight:bold">for</span> none<span style="color:#000;font-weight:bold">;</span> default AUTO
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">stderr_logfile_maxbytes</span><span style="color:#ce5c00;font-weight:bold">=</span>1MB   <span style="color:#000;font-weight:bold">;</span> max <span style="color:#8f5902;font-style:italic"># logfile bytes b4 rotation (default 50MB)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span>stderr_logfile_backups        <span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic"># of stderr logfile backups (default 10)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">stderr_events_enabled</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>   <span style="color:#000;font-weight:bold">;</span> emit events on stderr writes <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#204a87">false</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">A</span><span style="color:#ce5c00;font-weight:bold">=</span>1,B<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>           <span style="color:#000;font-weight:bold">;</span> process environment additions
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">serverurl</span><span style="color:#ce5c00;font-weight:bold">=</span>AUTO                <span style="color:#000;font-weight:bold">;</span> override serverurl computation <span style="color:#ce5c00;font-weight:bold">(</span>childutils<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> The below sample group section shows all possible group values,
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> create one or more <span style="color:#4e9a06">&#39;real&#39;</span> group: sections to create <span style="color:#4e9a06">&#34;heterogeneous&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> process groups.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#ce5c00;font-weight:bold">[</span>group:thegroupname<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">programs</span><span style="color:#ce5c00;font-weight:bold">=</span>progname1,progname2  <span style="color:#000;font-weight:bold">;</span> each refers to <span style="color:#4e9a06">&#39;x&#39;</span> in <span style="color:#ce5c00;font-weight:bold">[</span>program:x<span style="color:#ce5c00;font-weight:bold">]</span> definitions
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span><span style="color:#000">priority</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">999</span>                  <span style="color:#000;font-weight:bold">;</span> the relative start priority <span style="color:#ce5c00;font-weight:bold">(</span>default 999<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> The <span style="color:#ce5c00;font-weight:bold">[</span>include<span style="color:#ce5c00;font-weight:bold">]</span> section can just contain the <span style="color:#4e9a06">&#34;files&#34;</span> setting.  This
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> setting can list multiple files <span style="color:#ce5c00;font-weight:bold">(</span>separated by whitespace or
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> newlines<span style="color:#ce5c00;font-weight:bold">)</span>.  It can also contain wildcards.  The filenames are
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> interpreted as relative to this file.  Included files *cannot*
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> include files themselves.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>include<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">files</span> <span style="color:#ce5c00;font-weight:bold">=</span> supervisord.d/conf/*.conf
</span></span></code></pre></div><p>参考：</p>
<p><a href="http://supervisord.org/">http://supervisord.org/</a></p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c28c6a3abee361dd3f854007745692f7">7 - GIT命令</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-cff29e90b0bc24db749cc6ee1e7f6a04">7.1 - Git介绍</h1>
    
	<h1 id="1-git是什么">1. Git是什么</h1>
<h2 id="1-1-概述">1.1. 概述</h2>
<p>Git是分布式版本控制系统，与SVN类似的集中化版本控制系统相比，集中化版本控制系统如果中央服务器宕机则会影响数据和协同开发。</p>
<p>Git是分布式的版本控制系统，客户端不只是提取最新版本的快照，而且将整个代码仓库镜像复制下来。如果任何协同工作用的服务器发生故障了，也可以用任何一个代码仓库来恢复。而且在协作服务器宕机期间，你也可以提交代码到本地仓库，当协作服务器正常工作后，你再将本地仓库同步到远程仓库。</p>
<h2 id="1-2-特性">1.2. 特性</h2>
<ul>
<li>能够对文件版本控制和多人协作开发</li>
<li>拥有强大的分支特性，所以能够灵活地以不同的工作流协同开发</li>
<li>分布式版本控制系统，即使协作服务器宕机，也能继续提交代码或文件到本地仓库，当协作服务器恢复正常工作时，再将本地仓库同步到远程仓库。</li>
<li>当团队中某个成员完成某个功能时，通过pull request操作来通知其他团队成员，其他团队成员能够review code后再合并代码。</li>
</ul>
<h1 id="2-为什么要用git">2. 为什么要用Git</h1>
<ul>
<li>能够对文件版本控制和多人协作开发</li>
<li>拥有强大的分支特性，所以能够灵活地以不同的工作流协同开发</li>
<li>分布式版本控制系统，即使协作服务器宕机，也能继续提交代码或文件到本地仓库，当协作服务器恢复正常工作时，再将本地仓库同步到远程仓库。</li>
<li>当团队中某个成员完成某个功能时，通过pull request操作来通知其他团队成员，其他团队成员能够review code后再合并代码。</li>
</ul>
<h1 id="3-git-命令思维导图">3. Git 命令思维导图</h1>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578830/article/git/git-map.png" alt="git-map"></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b6a548be9e6ddcaeda2721c9a3f2f8ef">7.2 - Git常用命令</h1>
    
	<h1 id="1-git常用命令">1. Git常用命令</h1>
<table>
<thead>
<tr>
<th>分类</th>
<th>子类</th>
<th>git command</th>
<th>zsh alias</th>
</tr>
</thead>
<tbody>
<tr>
<td>分支</td>
<td>查看当前分支</td>
<td><code>git branch</code></td>
<td>gb</td>
</tr>
<tr>
<td></td>
<td>创建新分支,仍停留在当前分支</td>
<td>git branch <new branch></td>
<td></td>
</tr>
<tr>
<td></td>
<td>创建并切换到新分支</td>
<td>git checkout -b <new branch></td>
<td>gcb</td>
</tr>
<tr>
<td></td>
<td>切换分支</td>
<td>git checkout <branch></td>
<td></td>
</tr>
<tr>
<td></td>
<td>合并分支</td>
<td>git checkout <branch> #切换到要合并的分支git merge –no-ff <to be merged branch> #合并指定分支到当前分支</td>
<td></td>
</tr>
<tr>
<td>提交</td>
<td>查看状态</td>
<td>git status</td>
<td>gst</td>
</tr>
<tr>
<td></td>
<td>查看修改部分</td>
<td>git diff --color</td>
<td>gd</td>
</tr>
<tr>
<td></td>
<td>添加文件到暂存区</td>
<td>git add --all</td>
<td></td>
</tr>
<tr>
<td></td>
<td>提交本地仓库</td>
<td>git commit -m &quot;<message>&quot;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>推送到指定分支</td>
<td>git push -u origin <branch></td>
<td></td>
</tr>
<tr>
<td></td>
<td>查看提交日志</td>
<td>git log</td>
<td>-</td>
</tr>
</tbody>
</table>
<h1 id="2-git-rebase">2. git rebase</h1>
<p>如果信息修改无法生效，设置永久环境变量：export EDITOR=vim</p>
<p>帮助信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Rebase 67da308..6ef692b onto 67da308 (1 command)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Commands:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># p, pick = use commit</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># r, reword = use commit, but edit the commit message</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># e, edit = use commit, but stop for amending</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># s, squash = use commit, but meld into previous commit</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># f, fixup = like &#34;squash&#34;, but discard this commit&#39;s log message</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># x, exec = run command (the rest of the line) using shell</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># d, drop = remove commit</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># These lines can be re-ordered; they are executed from top to bottom.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If you remove a line here THAT COMMIT WILL BE LOST.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># However, if you remove everything, the rebase will be aborted.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note that empty commits are commented out</span>
</span></span></code></pre></div><h2 id="2-1-合并多余提交记录">2.1. 合并多余提交记录</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#以交互的方式进行rebase</span>
</span></span><span style="display:flex;"><span>git rebase -i master
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#合并多余提交记录：s, squash = use commit, but meld into previous commit</span>
</span></span><span style="display:flex;"><span>pick 6ef692b FIX: Fix parsing docker image version error
</span></span><span style="display:flex;"><span>s 3df667y FIX: the second push
</span></span><span style="display:flex;"><span>s 3fds95t FIX: the third push
</span></span><span style="display:flex;"><span>保存退出
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 进入修改交互界面</span>
</span></span><span style="display:flex;"><span>删除需要删除的提交记录，保存退出
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#查看提交记录是否已被修改</span>
</span></span><span style="display:flex;"><span>git log
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#最后强制提交到分支</span>
</span></span><span style="display:flex;"><span>git commit --force -u origin fix/add-unit-test-for-global-role-revoking
</span></span></code></pre></div><h2 id="2-2-修改提交记录">2.2. 修改提交记录</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#以交互的方式进行rebase</span>
</span></span><span style="display:flex;"><span>git rebase -i master
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#修改提交记录：e, edit = use commit, but stop for amending</span>
</span></span><span style="display:flex;"><span>e 6ef692b FIX: Fix parsing docker image version error
</span></span><span style="display:flex;"><span>e 5ty697u FIX: Fix parsing docker image version error
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#保存退出</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>git commit --amend
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#修改提交记录内容，保存退出</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>git rebase --continue
</span></span><span style="display:flex;"><span>git commit --amend
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#修改下一条提交记录，保存退出</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>git rebase --continue
</span></span><span style="display:flex;"><span>git status <span style="color:#8f5902;font-style:italic"># 查看状态提示</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#最后强制提交到分支</span>
</span></span><span style="display:flex;"><span>git commit --force -u origin fix/add-unit-test-for-global-role-revoking
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#查看提交记录是否已被修改</span>
</span></span><span style="display:flex;"><span>git log
</span></span></code></pre></div><h1 id="3-git设置忽略特殊文件">3. git设置忽略特殊文件</h1>
<h2 id="3-1-忽略文件的原则">3.1. 忽略文件的原则</h2>
<ol>
<li>忽略操作系统自动生成的文件，比如缩略图等；</li>
<li>忽略编译生成的中间文件、可执行文件等，也就是如果一个文件是通过另一个文件自动生成的，那自动生成的文件就没必要放进版本库，比如Java编译产生的<code>.class</code>文件；</li>
<li>忽略你自己的带有敏感信息的配置文件，比如存放口令的配置文件。</li>
</ol>
<h2 id="3-2-设置的方法">3.2. 设置的方法</h2>
<p>在项目的workdir 下编辑 .gitignore 文件，文件的路径填写为workdir的相对路径。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.idea/         <span style="color:#8f5902;font-style:italic">#IDE的配置文件</span>
</span></span><span style="display:flex;"><span>_build/
</span></span><span style="display:flex;"><span>server/server  <span style="color:#8f5902;font-style:italic">#二进制文件</span>
</span></span></code></pre></div><h2 id="3-3-gitignore-不生效解决方法">3.3. gitignore 不生效解决方法</h2>
<p>原因是.gitignore只能忽略那些原来没有被track的文件，如果某些文件已经被纳入了版本管理中，则修改.gitignore是无效的。那么解决方法就是先把本地缓存删除（改变成未track状态），然后再提交：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git rm -r --cached .
</span></span><span style="display:flex;"><span>git add .
</span></span><span style="display:flex;"><span>git commit -m <span style="color:#4e9a06">&#39;update .gitignore&#39;</span>
</span></span></code></pre></div><h1 id="4-git分支重命名">4. Git分支重命名</h1>
<p>假设分支名称为oldName
想要修改为 newName</p>
<p><strong>1. 本地分支重命名(还没有推送到远程)</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git branch -m oldName newName
</span></span></code></pre></div><p><strong>2. 远程分支重命名 (已经推送远程-假设本地分支和远程对应分支名称相同)</strong>
a. 重命名远程分支对应的本地分支</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git branch -m oldName newName
</span></span></code></pre></div><p>b. 删除远程分支</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git push --delete origin oldName
</span></span></code></pre></div><p>c. 上传新命名的本地分支</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git push origin newName
</span></span></code></pre></div><p>d.把修改后的本地分支与远程分支关联</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git branch --set-upstream-to origin/newName
</span></span></code></pre></div><h1 id="5-代码冲突">5. 代码冲突</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git checkout master
</span></span><span style="display:flex;"><span>git pull
</span></span><span style="display:flex;"><span>git checkout &lt;branch&gt;
</span></span><span style="display:flex;"><span>git rebase -i master
</span></span><span style="display:flex;"><span>fix conflict
</span></span><span style="display:flex;"><span>git rebase --continue
</span></span><span style="display:flex;"><span>git push --force -u origin &lt;branch&gt;
</span></span></code></pre></div><h1 id="6-修改历史提交的用户信息">6. 修改历史提交的用户信息</h1>
<p>1、克隆并进入你的仓库</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone --bare https://github.com/user/repo.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> repo.git
</span></span></code></pre></div><p>2、创建以下脚本，例如命名为rename.sh</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span> 
</span></span><span style="display:flex;"><span>git filter-branch --env-filter <span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">OLD_EMAIL=&#34;your-old-email@example.com&#34;          #修改参数为你的旧提交邮箱
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">CORRECT_NAME=&#34;Your Correct Name&#34;                #修改参数为你新的用户名
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">CORRECT_EMAIL=&#34;your-correct-email@example.com&#34;  #修改参数为你新的邮箱名
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">if [ &#34;$GIT_COMMITTER_EMAIL&#34; = &#34;$OLD_EMAIL&#34; ]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">then
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    export GIT_COMMITTER_NAME=&#34;$CORRECT_NAME&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    export GIT_COMMITTER_EMAIL=&#34;$CORRECT_EMAIL&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">fi
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">if [ &#34;$GIT_AUTHOR_EMAIL&#34; = &#34;$OLD_EMAIL&#34; ]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">then
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    export GIT_AUTHOR_NAME=&#34;$CORRECT_NAME&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    export GIT_AUTHOR_EMAIL=&#34;$CORRECT_EMAIL&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">fi
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#39;</span> --tag-name-filter cat -- --branches --tags
</span></span></code></pre></div><p>3、执行脚本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod +x rename.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sh rename.sh
</span></span></code></pre></div><p>4、查看新 Git 历史有没有错误。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#可以看到提交记录的用户信息已经修改为新的用户信息</span>
</span></span><span style="display:flex;"><span>git log 
</span></span></code></pre></div><p>5、确认提交内容，重新提交（可以先把rename.sh移除掉）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git push --force --tags origin <span style="color:#4e9a06">&#39;refs/heads/*&#39;</span>
</span></span></code></pre></div><h1 id="7-撤销已经push的提交">7. 撤销已经push的提交</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 本地仓库回退到某一版本</span>
</span></span><span style="display:flex;"><span>git reset -hard &lt;commit-id&gt;
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 强制 PUSH，此时远程分支已经恢复成指定的 commit 了</span>
</span></span><span style="display:flex;"><span>git push origin master --force
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f9f4e5c41f44aa45facefe4fb49b47f1">7.3 - Git命令分类</h1>
    
	<h1 id="git-命令详解">Git 命令详解</h1>
<h1 id="1-示意图">1. 示意图</h1>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578830/article/git/git-arch.png" alt="这里写图片描述"></p>
<ul>
<li>Workspace：工作区</li>
<li>Index / Stage：暂存区</li>
<li>Repository：仓库区（或本地仓库）</li>
<li>Remote：远程仓库</li>
</ul>
<h1 id="2-git-命令分类">2. Git 命令分类</h1>
<h2 id="2-1-新建代码库">2.1. 新建代码库</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在当前目录新建一个Git代码库</span>
</span></span><span style="display:flex;"><span>$ git init
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 新建一个目录，将其初始化为Git代码库</span>
</span></span><span style="display:flex;"><span>$ git init <span style="color:#ce5c00;font-weight:bold">[</span>project-name<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下载一个项目和它的整个代码历史</span>
</span></span><span style="display:flex;"><span>$ git clone <span style="color:#ce5c00;font-weight:bold">[</span>url<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h2 id="2-2-配置">2.2. 配置</h2>
<p>Git的设置文件为.gitconfig，它可以在用户主目录下（全局配置），也可以在项目目录下（项目配置）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示当前的Git配置</span>
</span></span><span style="display:flex;"><span>$ git config --list
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 编辑Git配置文件</span>
</span></span><span style="display:flex;"><span>$ git config -e <span style="color:#ce5c00;font-weight:bold">[</span>--global<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置提交代码时的用户信息</span>
</span></span><span style="display:flex;"><span>$ git config <span style="color:#ce5c00;font-weight:bold">[</span>--global<span style="color:#ce5c00;font-weight:bold">]</span> user.name <span style="color:#4e9a06">&#34;[name]&#34;</span>
</span></span><span style="display:flex;"><span>$ git config <span style="color:#ce5c00;font-weight:bold">[</span>--global<span style="color:#ce5c00;font-weight:bold">]</span> user.email <span style="color:#4e9a06">&#34;[email address]&#34;</span>
</span></span></code></pre></div><h2 id="2-3-增加-删除文件">2.3. 增加/删除文件</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加指定文件到暂存区</span>
</span></span><span style="display:flex;"><span>$ git add <span style="color:#ce5c00;font-weight:bold">[</span>file1<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>file2<span style="color:#ce5c00;font-weight:bold">]</span> ...
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加指定目录到暂存区，包括子目录</span>
</span></span><span style="display:flex;"><span>$ git add <span style="color:#ce5c00;font-weight:bold">[</span>dir<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加当前目录的所有文件到暂存区</span>
</span></span><span style="display:flex;"><span>$ git add .
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加每个变化前，都会要求确认</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 对于同一个文件的多处变化，可以实现分次提交</span>
</span></span><span style="display:flex;"><span>$ git add -p
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除工作区文件，并且将这次删除放入暂存区</span>
</span></span><span style="display:flex;"><span>$ git rm <span style="color:#ce5c00;font-weight:bold">[</span>file1<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>file2<span style="color:#ce5c00;font-weight:bold">]</span> ...
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 停止追踪指定文件，但该文件会保留在工作区</span>
</span></span><span style="display:flex;"><span>$ git rm --cached <span style="color:#ce5c00;font-weight:bold">[</span>file<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 改名文件，并且将这个改名放入暂存区</span>
</span></span><span style="display:flex;"><span>$ git mv <span style="color:#ce5c00;font-weight:bold">[</span>file-original<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>file-renamed<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h2 id="2-4-代码提交">2.4. 代码提交</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 提交暂存区到仓库区</span>
</span></span><span style="display:flex;"><span>$ git commit -m <span style="color:#ce5c00;font-weight:bold">[</span>message<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 提交暂存区的指定文件到仓库区</span>
</span></span><span style="display:flex;"><span>$ git commit <span style="color:#ce5c00;font-weight:bold">[</span>file1<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>file2<span style="color:#ce5c00;font-weight:bold">]</span> ... -m <span style="color:#ce5c00;font-weight:bold">[</span>message<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 提交工作区自上次commit之后的变化，直接到仓库区</span>
</span></span><span style="display:flex;"><span>$ git commit -a
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 提交时显示所有diff信息</span>
</span></span><span style="display:flex;"><span>$ git commit -v
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用一次新的commit，替代上一次提交</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果代码没有任何新变化，则用来改写上一次commit的提交信息</span>
</span></span><span style="display:flex;"><span>$ git commit --amend -m <span style="color:#ce5c00;font-weight:bold">[</span>message<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重做上一次commit，并包括指定文件的新变化</span>
</span></span><span style="display:flex;"><span>$ git commit --amend <span style="color:#ce5c00;font-weight:bold">[</span>file1<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>file2<span style="color:#ce5c00;font-weight:bold">]</span> ...
</span></span></code></pre></div><h2 id="2-5-分支">2.5. 分支</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 列出所有本地分支</span>
</span></span><span style="display:flex;"><span>$ git branch
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 列出所有远程分支</span>
</span></span><span style="display:flex;"><span>$ git branch -r
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 列出所有本地分支和远程分支</span>
</span></span><span style="display:flex;"><span>$ git branch -a
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 新建一个分支，但依然停留在当前分支</span>
</span></span><span style="display:flex;"><span>$ git branch <span style="color:#ce5c00;font-weight:bold">[</span>branch-name<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 新建一个分支，并切换到该分支</span>
</span></span><span style="display:flex;"><span>$ git checkout -b <span style="color:#ce5c00;font-weight:bold">[</span>branch<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 新建一个分支，指向指定commit</span>
</span></span><span style="display:flex;"><span>$ git branch <span style="color:#ce5c00;font-weight:bold">[</span>branch<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>commit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 新建一个分支，与指定的远程分支建立追踪关系</span>
</span></span><span style="display:flex;"><span>$ git branch --track <span style="color:#ce5c00;font-weight:bold">[</span>branch<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>remote-branch<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 切换到指定分支，并更新工作区</span>
</span></span><span style="display:flex;"><span>$ git checkout <span style="color:#ce5c00;font-weight:bold">[</span>branch-name<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 切换到上一个分支</span>
</span></span><span style="display:flex;"><span>$ git checkout -
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 建立追踪关系，在现有分支与指定的远程分支之间</span>
</span></span><span style="display:flex;"><span>$ git branch --set-upstream <span style="color:#ce5c00;font-weight:bold">[</span>branch<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>remote-branch<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 合并指定分支到当前分支</span>
</span></span><span style="display:flex;"><span>$ git merge <span style="color:#ce5c00;font-weight:bold">[</span>branch<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 选择一个commit，合并进当前分支</span>
</span></span><span style="display:flex;"><span>$ git cherry-pick <span style="color:#ce5c00;font-weight:bold">[</span>commit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除分支</span>
</span></span><span style="display:flex;"><span>$ git branch -d <span style="color:#ce5c00;font-weight:bold">[</span>branch-name<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除远程分支</span>
</span></span><span style="display:flex;"><span>$ git push origin --delete <span style="color:#ce5c00;font-weight:bold">[</span>branch-name<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>$ git branch -dr <span style="color:#ce5c00;font-weight:bold">[</span>remote/branch<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h2 id="2-6-标签">2.6. 标签</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 列出所有tag</span>
</span></span><span style="display:flex;"><span>$ git tag
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 新建一个tag在当前commit</span>
</span></span><span style="display:flex;"><span>$ git tag <span style="color:#ce5c00;font-weight:bold">[</span>tag<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 新建一个tag在指定commit</span>
</span></span><span style="display:flex;"><span>$ git tag <span style="color:#ce5c00;font-weight:bold">[</span>tag<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>commit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除本地tag</span>
</span></span><span style="display:flex;"><span>$ git tag -d <span style="color:#ce5c00;font-weight:bold">[</span>tag<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除远程tag</span>
</span></span><span style="display:flex;"><span>$ git push origin :refs/tags/<span style="color:#ce5c00;font-weight:bold">[</span>tagName<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看tag信息</span>
</span></span><span style="display:flex;"><span>$ git show <span style="color:#ce5c00;font-weight:bold">[</span>tag<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 提交指定tag</span>
</span></span><span style="display:flex;"><span>$ git push <span style="color:#ce5c00;font-weight:bold">[</span>remote<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>tag<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 提交所有tag</span>
</span></span><span style="display:flex;"><span>$ git push <span style="color:#ce5c00;font-weight:bold">[</span>remote<span style="color:#ce5c00;font-weight:bold">]</span> --tags
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 新建一个分支，指向某个tag</span>
</span></span><span style="display:flex;"><span>$ git checkout -b <span style="color:#ce5c00;font-weight:bold">[</span>branch<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>tag<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h2 id="2-7-查看信息">2.7. 查看信息</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示有变更的文件</span>
</span></span><span style="display:flex;"><span>$ git status
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示当前分支的版本历史</span>
</span></span><span style="display:flex;"><span>$ git log
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示commit历史，以及每次commit发生变更的文件</span>
</span></span><span style="display:flex;"><span>$ git log --stat
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 搜索提交历史，根据关键词</span>
</span></span><span style="display:flex;"><span>$ git log -S <span style="color:#ce5c00;font-weight:bold">[</span>keyword<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示某个commit之后的所有变动，每个commit占据一行</span>
</span></span><span style="display:flex;"><span>$ git log <span style="color:#ce5c00;font-weight:bold">[</span>tag<span style="color:#ce5c00;font-weight:bold">]</span> HEAD --pretty<span style="color:#ce5c00;font-weight:bold">=</span>format:%s
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示某个commit之后的所有变动，其&#34;提交说明&#34;必须符合搜索条件</span>
</span></span><span style="display:flex;"><span>$ git log <span style="color:#ce5c00;font-weight:bold">[</span>tag<span style="color:#ce5c00;font-weight:bold">]</span> HEAD --grep feature
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示某个文件的版本历史，包括文件改名</span>
</span></span><span style="display:flex;"><span>$ git log --follow <span style="color:#ce5c00;font-weight:bold">[</span>file<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>$ git whatchanged <span style="color:#ce5c00;font-weight:bold">[</span>file<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示指定文件相关的每一次diff</span>
</span></span><span style="display:flex;"><span>$ git log -p <span style="color:#ce5c00;font-weight:bold">[</span>file<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示过去5次提交</span>
</span></span><span style="display:flex;"><span>$ git log -5 --pretty --oneline
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示所有提交过的用户，按提交次数排序</span>
</span></span><span style="display:flex;"><span>$ git shortlog -sn
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示指定文件是什么人在什么时间修改过</span>
</span></span><span style="display:flex;"><span>$ git blame <span style="color:#ce5c00;font-weight:bold">[</span>file<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示暂存区和工作区的差异</span>
</span></span><span style="display:flex;"><span>$ git diff
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示暂存区和上一个commit的差异</span>
</span></span><span style="display:flex;"><span>$ git diff --cached <span style="color:#ce5c00;font-weight:bold">[</span>file<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示工作区与当前分支最新commit之间的差异</span>
</span></span><span style="display:flex;"><span>$ git diff HEAD
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示两次提交之间的差异</span>
</span></span><span style="display:flex;"><span>$ git diff <span style="color:#ce5c00;font-weight:bold">[</span>first-branch<span style="color:#ce5c00;font-weight:bold">]</span>...<span style="color:#ce5c00;font-weight:bold">[</span>second-branch<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示今天你写了多少行代码</span>
</span></span><span style="display:flex;"><span>$ git diff --shortstat <span style="color:#4e9a06">&#34;@{0 day ago}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示某次提交的元数据和内容变化</span>
</span></span><span style="display:flex;"><span>$ git show <span style="color:#ce5c00;font-weight:bold">[</span>commit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示某次提交发生变化的文件</span>
</span></span><span style="display:flex;"><span>$ git show --name-only <span style="color:#ce5c00;font-weight:bold">[</span>commit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示某次提交时，某个文件的内容</span>
</span></span><span style="display:flex;"><span>$ git show <span style="color:#ce5c00;font-weight:bold">[</span>commit<span style="color:#ce5c00;font-weight:bold">]</span>:<span style="color:#ce5c00;font-weight:bold">[</span>filename<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示当前分支的最近几次提交</span>
</span></span><span style="display:flex;"><span>$ git reflog
</span></span></code></pre></div><h2 id="2-8-远程同步">2.8. 远程同步</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下载远程仓库的所有变动</span>
</span></span><span style="display:flex;"><span>$ git fetch <span style="color:#ce5c00;font-weight:bold">[</span>remote<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示所有远程仓库</span>
</span></span><span style="display:flex;"><span>$ git remote -v
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示某个远程仓库的信息</span>
</span></span><span style="display:flex;"><span>$ git remote show <span style="color:#ce5c00;font-weight:bold">[</span>remote<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 增加一个新的远程仓库，并命名</span>
</span></span><span style="display:flex;"><span>$ git remote add <span style="color:#ce5c00;font-weight:bold">[</span>shortname<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>url<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 取回远程仓库的变化，并与本地分支合并</span>
</span></span><span style="display:flex;"><span>$ git pull <span style="color:#ce5c00;font-weight:bold">[</span>remote<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>branch<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 上传本地指定分支到远程仓库</span>
</span></span><span style="display:flex;"><span>$ git push <span style="color:#ce5c00;font-weight:bold">[</span>remote<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>branch<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 强行推送当前分支到远程仓库，即使有冲突</span>
</span></span><span style="display:flex;"><span>$ git push <span style="color:#ce5c00;font-weight:bold">[</span>remote<span style="color:#ce5c00;font-weight:bold">]</span> --force
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 推送所有分支到远程仓库</span>
</span></span><span style="display:flex;"><span>$ git push <span style="color:#ce5c00;font-weight:bold">[</span>remote<span style="color:#ce5c00;font-weight:bold">]</span> --all
</span></span></code></pre></div><h2 id="2-9-撤销">2.9. 撤销</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 恢复暂存区的指定文件到工作区</span>
</span></span><span style="display:flex;"><span>$ git checkout <span style="color:#ce5c00;font-weight:bold">[</span>file<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 恢复某个commit的指定文件到暂存区和工作区</span>
</span></span><span style="display:flex;"><span>$ git checkout <span style="color:#ce5c00;font-weight:bold">[</span>commit<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>file<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 恢复暂存区的所有文件到工作区</span>
</span></span><span style="display:flex;"><span>$ git checkout .
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重置暂存区的指定文件，与上一次commit保持一致，但工作区不变</span>
</span></span><span style="display:flex;"><span>$ git reset <span style="color:#ce5c00;font-weight:bold">[</span>file<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重置暂存区与工作区，与上一次commit保持一致</span>
</span></span><span style="display:flex;"><span>$ git reset --hard
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重置当前分支的指针为指定commit，同时重置暂存区，但工作区不变</span>
</span></span><span style="display:flex;"><span>$ git reset <span style="color:#ce5c00;font-weight:bold">[</span>commit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重置当前分支的HEAD为指定commit，同时重置暂存区和工作区，与指定commit一致</span>
</span></span><span style="display:flex;"><span>$ git reset --hard <span style="color:#ce5c00;font-weight:bold">[</span>commit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重置当前HEAD为指定commit，但保持暂存区和工作区不变</span>
</span></span><span style="display:flex;"><span>$ git reset --keep <span style="color:#ce5c00;font-weight:bold">[</span>commit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 新建一个commit，用来撤销指定commit</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 后者的所有变化都将被前者抵消，并且应用到当前分支</span>
</span></span><span style="display:flex;"><span>$ git revert <span style="color:#ce5c00;font-weight:bold">[</span>commit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 暂时将未提交的变化移除，稍后再移入</span>
</span></span><span style="display:flex;"><span>$ git stash
</span></span><span style="display:flex;"><span>$ git stash pop
</span></span></code></pre></div><h2 id="2-10-其他">2.10. 其他</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 生成一个可供发布的压缩包</span>
</span></span><span style="display:flex;"><span>$ git archive
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置换行符为LF</span>
</span></span><span style="display:flex;"><span>git config --global core.autocrlf <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#拒绝提交包含混合换行符的文件</span>
</span></span><span style="display:flex;"><span>git config --global core.safecrlf <span style="color:#204a87">true</span>
</span></span></code></pre></div><p>参考文章：</p>
<ul>
<li><a href="http://www.ruanyifeng.com/blog/2015/12/git-cheat-sheet.html">http://www.ruanyifeng.com/blog/2015/12/git-cheat-sheet.html</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e48a32742a2c5129a6ef36eb9ec51bd4">7.4 - Git commit规范</h1>
    
	<h1 id="1-git-commit规范">1. Git commit规范</h1>
<h2 id="1-1-格式">1.1. 格式</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;type&gt;<span style="color:#ce5c00;font-weight:bold">(</span>&lt;scope&gt;<span style="color:#ce5c00;font-weight:bold">)</span>: &lt;subject&gt;
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>fix<span style="color:#ce5c00;font-weight:bold">(</span>ngRepeat<span style="color:#ce5c00;font-weight:bold">)</span>: fix trackBy <span style="color:#204a87;font-weight:bold">function</span> being invoked with incorrect scope
</span></span></code></pre></div><h2 id="1-2-type">1.2. type</h2>
<p>主要的提交类型如下：</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>feat</code></td>
<td>提交新功能</td>
<td>常用</td>
</tr>
<tr>
<td><code>fix</code></td>
<td>修复bug</td>
<td>常用</td>
</tr>
<tr>
<td><code>docs</code></td>
<td>修改文档</td>
<td></td>
</tr>
<tr>
<td><code>style</code></td>
<td>修改格式，例如格式化代码，空格，拼写错误等</td>
<td></td>
</tr>
<tr>
<td><code>refactor</code></td>
<td>重构代码，没有添加新功能也没有修复bug</td>
<td></td>
</tr>
<tr>
<td><code>test</code></td>
<td>添加或修改测试用例</td>
<td></td>
</tr>
<tr>
<td><code>perf</code></td>
<td>代码性能调优</td>
<td></td>
</tr>
<tr>
<td><code>chore</code></td>
<td>修改构建工具、构建流程、更新依赖库、文档生成逻辑</td>
<td>例如vendor包</td>
</tr>
</tbody>
</table>
<h2 id="1-3-scope">1.3. scope</h2>
<p>表示此次commit涉及的文件范围，可以使用<code>*</code>来表示涉及多个范围。</p>
<h2 id="1-4-subject">1.4. subject</h2>
<p>描述此次commit涉及的修改内容。</p>
<ul>
<li>使用祈使句（动词开头）、动宾短语。</li>
<li>第一个字母不要大写。</li>
<li>不要以<code>.</code>句号结尾。</li>
</ul>
<h1 id="2-git-commit工具">2. Git commit工具</h1>
<p>安装<code>commitizen</code>和<code>cz-conventional-changelog</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install -g commitizen cz-conventional-changelog
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;{ &#34;path&#34;: &#34;cz-conventional-changelog&#34; }&#39;</span> &gt; ~/.czrc
</span></span></code></pre></div><p>使用cz-cli</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ git cz
</span></span><span style="display:flex;"><span>cz-cli@4.0.3, cz-conventional-changelog@3.0.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>? Select the <span style="color:#204a87">type</span> of change that you<span style="color:#a40000">&#39;</span>re committing: <span style="color:#ce5c00;font-weight:bold">(</span>Use arrow keys<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>❯ feat:     A new feature
</span></span><span style="display:flex;"><span>  fix:      A bug fix
</span></span><span style="display:flex;"><span>  docs:     Documentation only changes
</span></span><span style="display:flex;"><span>  style:    Changes that <span style="color:#204a87;font-weight:bold">do</span> not affect the meaning of the code <span style="color:#ce5c00;font-weight:bold">(</span>white-space, formatting, missing semi-colons, etc<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  refactor: A code change that neither fixes a bug nor adds a feature
</span></span><span style="display:flex;"><span>  perf:     A code change that improves performance
</span></span><span style="display:flex;"><span>  test:     Adding missing tests or correcting existing tests
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>Move up and down to reveal more choices<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/angular/angular.js/blob/master/DEVELOPERS.md#-git-commit-guidelines">https://github.com/angular/angular.js/blob/master/DEVELOPERS.md#-git-commit-guidelines</a></li>
<li><a href="https://juejin.im/post/5afc5242f265da0b7f44bee4">https://juejin.im/post/5afc5242f265da0b7f44bee4</a></li>
<li><a href="https://link.juejin.im/?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fcommitizen%2Fcz-cli">commitizen/cz-cli</a></li>
<li><a href="https://link.juejin.im/?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fcommitizen%2Fcz-conventional-changelog">commitizen/cz-conventional-changelog</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a1b9224ec12791c7d41ce8381ea5ab4d">7.5 - Git命令别名</h1>
    
	<blockquote>
<p>以下由<a href="https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins/git">zsh-plugin-git</a>内容转载过来，以备查询使用。</p>
</blockquote>
<h1 id="git-plugin">git plugin</h1>
<p>The git plugin provides many <a href="#aliases">aliases</a> and a few useful <a href="#functions">functions</a>.</p>
<p>To use it, add <code>git</code> to the plugins array in your zshrc file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">plugins</span><span style="color:#ce5c00;font-weight:bold">=(</span>... git<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="aliases">Aliases</h2>
<h3 id="常用">常用</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Alias</th>
<th style="text-align:left">Command</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">g</td>
<td style="text-align:left">git</td>
</tr>
<tr>
<td style="text-align:left"><strong>ga</strong></td>
<td style="text-align:left">git add</td>
</tr>
<tr>
<td style="text-align:left"><strong>gaa</strong></td>
<td style="text-align:left">git add --all</td>
</tr>
<tr>
<td style="text-align:left"><strong>gcmsg</strong></td>
<td style="text-align:left">git commit -m</td>
</tr>
<tr>
<td style="text-align:left">--------------------</td>
<td style="text-align:left">------------------------------------------------------------</td>
</tr>
<tr>
<td style="text-align:left">ggp</td>
<td style="text-align:left">git push origin $(current_branch)</td>
</tr>
<tr>
<td style="text-align:left">ggf</td>
<td style="text-align:left">git push --force origin $(current_branch)</td>
</tr>
<tr>
<td style="text-align:left">gp</td>
<td style="text-align:left">git push</td>
</tr>
<tr>
<td style="text-align:left">gl</td>
<td style="text-align:left">git pull</td>
</tr>
<tr>
<td style="text-align:left">ggl</td>
<td style="text-align:left">git pull origin $(current_branch)</td>
</tr>
<tr>
<td style="text-align:left">--------------------</td>
<td style="text-align:left">------------------------------------------------------------</td>
</tr>
<tr>
<td style="text-align:left"><strong>gco</strong></td>
<td style="text-align:left">git checkout</td>
</tr>
<tr>
<td style="text-align:left">gcb</td>
<td style="text-align:left">git checkout -b</td>
</tr>
<tr>
<td style="text-align:left">gcm</td>
<td style="text-align:left">git checkout master</td>
</tr>
<tr>
<td style="text-align:left">gb</td>
<td style="text-align:left">git branch</td>
</tr>
<tr>
<td style="text-align:left">gba</td>
<td style="text-align:left">git branch -a</td>
</tr>
<tr>
<td style="text-align:left">gcf</td>
<td style="text-align:left">git config --list</td>
</tr>
<tr>
<td style="text-align:left">gd</td>
<td style="text-align:left">git diff</td>
</tr>
</tbody>
</table>
<h3 id="完整列表">完整列表</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Alias</th>
<th style="text-align:left">Command</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">g</td>
<td style="text-align:left">git</td>
</tr>
<tr>
<td style="text-align:left"><strong>ga</strong></td>
<td style="text-align:left">git add</td>
</tr>
<tr>
<td style="text-align:left"><strong>gaa</strong></td>
<td style="text-align:left">git add --all</td>
</tr>
<tr>
<td style="text-align:left">gapa</td>
<td style="text-align:left">git add --patch</td>
</tr>
<tr>
<td style="text-align:left">gau</td>
<td style="text-align:left">git add --update</td>
</tr>
<tr>
<td style="text-align:left">gav</td>
<td style="text-align:left">git add --verbose</td>
</tr>
<tr>
<td style="text-align:left">gap</td>
<td style="text-align:left">git apply</td>
</tr>
<tr>
<td style="text-align:left">gb</td>
<td style="text-align:left">git branch</td>
</tr>
<tr>
<td style="text-align:left">gba</td>
<td style="text-align:left">git branch -a</td>
</tr>
<tr>
<td style="text-align:left">gbd</td>
<td style="text-align:left">git branch -d</td>
</tr>
<tr>
<td style="text-align:left">gbda</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">gbD</td>
<td style="text-align:left">git branch -D</td>
</tr>
<tr>
<td style="text-align:left">gbl</td>
<td style="text-align:left">git blame -b -w</td>
</tr>
<tr>
<td style="text-align:left">gbnm</td>
<td style="text-align:left">git branch --no-merged</td>
</tr>
<tr>
<td style="text-align:left">gbr</td>
<td style="text-align:left">git branch --remote</td>
</tr>
<tr>
<td style="text-align:left">gbs</td>
<td style="text-align:left">git bisect</td>
</tr>
<tr>
<td style="text-align:left">gbsb</td>
<td style="text-align:left">git bisect bad</td>
</tr>
<tr>
<td style="text-align:left">gbsg</td>
<td style="text-align:left">git bisect good</td>
</tr>
<tr>
<td style="text-align:left">gbsr</td>
<td style="text-align:left">git bisect reset</td>
</tr>
<tr>
<td style="text-align:left">gbss</td>
<td style="text-align:left">git bisect start</td>
</tr>
<tr>
<td style="text-align:left">gc</td>
<td style="text-align:left">git commit -v</td>
</tr>
<tr>
<td style="text-align:left">gc!</td>
<td style="text-align:left">git commit -v --amend</td>
</tr>
<tr>
<td style="text-align:left">gcn!</td>
<td style="text-align:left">git commit -v --no-edit --amend</td>
</tr>
<tr>
<td style="text-align:left">gca</td>
<td style="text-align:left">git commit -v -a</td>
</tr>
<tr>
<td style="text-align:left">gca!</td>
<td style="text-align:left">git commit -v -a --amend</td>
</tr>
<tr>
<td style="text-align:left">gcan!</td>
<td style="text-align:left">git commit -v -a --no-edit --amend</td>
</tr>
<tr>
<td style="text-align:left">gcans!</td>
<td style="text-align:left">git commit -v -a -s --no-edit --amend</td>
</tr>
<tr>
<td style="text-align:left">gcam</td>
<td style="text-align:left">git commit -a -m</td>
</tr>
<tr>
<td style="text-align:left">gcsm</td>
<td style="text-align:left">git commit -s -m</td>
</tr>
<tr>
<td style="text-align:left">gcb</td>
<td style="text-align:left">git checkout -b</td>
</tr>
<tr>
<td style="text-align:left">gcf</td>
<td style="text-align:left">git config --list</td>
</tr>
<tr>
<td style="text-align:left">gcl</td>
<td style="text-align:left">git clone --recurse-submodules</td>
</tr>
<tr>
<td style="text-align:left">gclean</td>
<td style="text-align:left">git clean -id</td>
</tr>
<tr>
<td style="text-align:left">gpristine</td>
<td style="text-align:left">git reset --hard &amp;&amp; git clean -dfx</td>
</tr>
<tr>
<td style="text-align:left">gcm</td>
<td style="text-align:left">git checkout master</td>
</tr>
<tr>
<td style="text-align:left">gcd</td>
<td style="text-align:left">git checkout develop</td>
</tr>
<tr>
<td style="text-align:left"><strong>gcmsg</strong></td>
<td style="text-align:left">git commit -m</td>
</tr>
<tr>
<td style="text-align:left"><strong>gco</strong></td>
<td style="text-align:left">git checkout</td>
</tr>
<tr>
<td style="text-align:left">gcount</td>
<td style="text-align:left">git shortlog -sn</td>
</tr>
<tr>
<td style="text-align:left">gcp</td>
<td style="text-align:left">git cherry-pick</td>
</tr>
<tr>
<td style="text-align:left">gcpa</td>
<td style="text-align:left">git cherry-pick --abort</td>
</tr>
<tr>
<td style="text-align:left">gcpc</td>
<td style="text-align:left">git cherry-pick --continue</td>
</tr>
<tr>
<td style="text-align:left">gcs</td>
<td style="text-align:left">git commit -S</td>
</tr>
<tr>
<td style="text-align:left">gd</td>
<td style="text-align:left">git diff</td>
</tr>
<tr>
<td style="text-align:left">gdca</td>
<td style="text-align:left">git diff --cached</td>
</tr>
<tr>
<td style="text-align:left">gdcw</td>
<td style="text-align:left">git diff --cached --word-diff</td>
</tr>
<tr>
<td style="text-align:left">gdct</td>
<td style="text-align:left">git describe --tags $(git rev-list --tags --max-count=1)</td>
</tr>
<tr>
<td style="text-align:left">gds</td>
<td style="text-align:left">git diff --staged</td>
</tr>
<tr>
<td style="text-align:left">gdt</td>
<td style="text-align:left">git diff-tree --no-commit-id --name-only -r</td>
</tr>
<tr>
<td style="text-align:left">gdv</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">gdw</td>
<td style="text-align:left">git diff --word-diff</td>
</tr>
<tr>
<td style="text-align:left">gf</td>
<td style="text-align:left">git fetch</td>
</tr>
<tr>
<td style="text-align:left">gfa</td>
<td style="text-align:left">git fetch --all --prune</td>
</tr>
<tr>
<td style="text-align:left">gfg</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">gfo</td>
<td style="text-align:left">git fetch origin</td>
</tr>
<tr>
<td style="text-align:left">gg</td>
<td style="text-align:left">git gui citool</td>
</tr>
<tr>
<td style="text-align:left">gga</td>
<td style="text-align:left">git gui citool --amend</td>
</tr>
<tr>
<td style="text-align:left">ggf</td>
<td style="text-align:left">git push --force origin $(current_branch)</td>
</tr>
<tr>
<td style="text-align:left">ggfl</td>
<td style="text-align:left">git push --force-with-lease origin $(current_branch)</td>
</tr>
<tr>
<td style="text-align:left">ggl</td>
<td style="text-align:left">git pull origin $(current_branch)</td>
</tr>
<tr>
<td style="text-align:left">ggp</td>
<td style="text-align:left">git push origin $(current_branch)</td>
</tr>
<tr>
<td style="text-align:left">ggpnp</td>
<td style="text-align:left">ggl &amp;&amp; ggp</td>
</tr>
<tr>
<td style="text-align:left">ggpull</td>
<td style="text-align:left">git pull origin &quot;$(git_current_branch)&quot;</td>
</tr>
<tr>
<td style="text-align:left">ggpur</td>
<td style="text-align:left">ggu</td>
</tr>
<tr>
<td style="text-align:left">ggpush</td>
<td style="text-align:left">git push origin &quot;$(git_current_branch)&quot;</td>
</tr>
<tr>
<td style="text-align:left">ggsup</td>
<td style="text-align:left">git branch --set-upstream-to=origin/$(git_current_branch)</td>
</tr>
<tr>
<td style="text-align:left">ggu</td>
<td style="text-align:left">git pull --rebase origin $(current_branch)</td>
</tr>
<tr>
<td style="text-align:left">gpsup</td>
<td style="text-align:left">git push --set-upstream origin $(git_current_branch)</td>
</tr>
<tr>
<td style="text-align:left">ghh</td>
<td style="text-align:left">git help</td>
</tr>
<tr>
<td style="text-align:left">gignore</td>
<td style="text-align:left">git update-index --assume-unchanged</td>
</tr>
<tr>
<td style="text-align:left">gignored</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">git-svn-dcommit-push</td>
<td style="text-align:left">git svn dcommit &amp;&amp; git push github master:svntrunk</td>
</tr>
<tr>
<td style="text-align:left">gk</td>
<td style="text-align:left">gitk --all --branches</td>
</tr>
<tr>
<td style="text-align:left">gke</td>
<td style="text-align:left">gitk --all $(git log -g --pretty=%h)</td>
</tr>
<tr>
<td style="text-align:left">gl</td>
<td style="text-align:left">git pull</td>
</tr>
<tr>
<td style="text-align:left">glg</td>
<td style="text-align:left">git log --stat</td>
</tr>
<tr>
<td style="text-align:left">glgp</td>
<td style="text-align:left">git log --stat -p</td>
</tr>
<tr>
<td style="text-align:left">glgg</td>
<td style="text-align:left">git log --graph</td>
</tr>
<tr>
<td style="text-align:left">glgga</td>
<td style="text-align:left">git log --graph --decorate --all</td>
</tr>
<tr>
<td style="text-align:left">glgm</td>
<td style="text-align:left">git log --graph --max-count=10</td>
</tr>
<tr>
<td style="text-align:left">glo</td>
<td style="text-align:left">git log --oneline --decorate</td>
</tr>
<tr>
<td style="text-align:left">glol</td>
<td style="text-align:left">git log --graph --pretty='%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset'</td>
</tr>
<tr>
<td style="text-align:left">glols</td>
<td style="text-align:left">git log --graph --pretty='%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset' --stat</td>
</tr>
<tr>
<td style="text-align:left">glod</td>
<td style="text-align:left">git log --graph --pretty='%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%ad) %C(bold blue)&lt;%an&gt;%Creset'</td>
</tr>
<tr>
<td style="text-align:left">glods</td>
<td style="text-align:left">git log --graph --pretty='%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%ad) %C(bold blue)&lt;%an&gt;%Creset' --date=short</td>
</tr>
<tr>
<td style="text-align:left">glola</td>
<td style="text-align:left">git log --graph --pretty='%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset' --all</td>
</tr>
<tr>
<td style="text-align:left">glog</td>
<td style="text-align:left">git log --oneline --decorate --graph</td>
</tr>
<tr>
<td style="text-align:left">gloga</td>
<td style="text-align:left">git log --oneline --decorate --graph --all</td>
</tr>
<tr>
<td style="text-align:left">glp</td>
<td style="text-align:left"><code>_git_log_prettily</code></td>
</tr>
<tr>
<td style="text-align:left">gm</td>
<td style="text-align:left">git merge</td>
</tr>
<tr>
<td style="text-align:left">gmom</td>
<td style="text-align:left">git merge origin/master</td>
</tr>
<tr>
<td style="text-align:left">gmt</td>
<td style="text-align:left">git mergetool --no-prompt</td>
</tr>
<tr>
<td style="text-align:left">gmtvim</td>
<td style="text-align:left">git mergetool --no-prompt --tool=vimdiff</td>
</tr>
<tr>
<td style="text-align:left">gmum</td>
<td style="text-align:left">git merge upstream/master</td>
</tr>
<tr>
<td style="text-align:left">gma</td>
<td style="text-align:left">git merge --abort</td>
</tr>
<tr>
<td style="text-align:left">gp</td>
<td style="text-align:left">git push</td>
</tr>
<tr>
<td style="text-align:left">gpd</td>
<td style="text-align:left">git push --dry-run</td>
</tr>
<tr>
<td style="text-align:left">gpf</td>
<td style="text-align:left">git push --force-with-lease</td>
</tr>
<tr>
<td style="text-align:left">gpf!</td>
<td style="text-align:left">git push --force</td>
</tr>
<tr>
<td style="text-align:left">gpoat</td>
<td style="text-align:left">git push origin --all &amp;&amp; git push origin --tags</td>
</tr>
<tr>
<td style="text-align:left">gpu</td>
<td style="text-align:left">git push upstream</td>
</tr>
<tr>
<td style="text-align:left">gpv</td>
<td style="text-align:left">git push -v</td>
</tr>
<tr>
<td style="text-align:left">gr</td>
<td style="text-align:left">git remote</td>
</tr>
<tr>
<td style="text-align:left">gra</td>
<td style="text-align:left">git remote add</td>
</tr>
<tr>
<td style="text-align:left">grb</td>
<td style="text-align:left">git rebase</td>
</tr>
<tr>
<td style="text-align:left">grba</td>
<td style="text-align:left">git rebase --abort</td>
</tr>
<tr>
<td style="text-align:left">grbc</td>
<td style="text-align:left">git rebase --continue</td>
</tr>
<tr>
<td style="text-align:left">grbd</td>
<td style="text-align:left">git rebase develop</td>
</tr>
<tr>
<td style="text-align:left">grbi</td>
<td style="text-align:left">git rebase -i</td>
</tr>
<tr>
<td style="text-align:left">grbm</td>
<td style="text-align:left">git rebase master</td>
</tr>
<tr>
<td style="text-align:left">grbs</td>
<td style="text-align:left">git rebase --skip</td>
</tr>
<tr>
<td style="text-align:left">grh</td>
<td style="text-align:left">git reset</td>
</tr>
<tr>
<td style="text-align:left">grhh</td>
<td style="text-align:left">git reset --hard</td>
</tr>
<tr>
<td style="text-align:left">groh</td>
<td style="text-align:left">git reset origin/$(git_current_branch) --hard</td>
</tr>
<tr>
<td style="text-align:left">grm</td>
<td style="text-align:left">git rm</td>
</tr>
<tr>
<td style="text-align:left">grmc</td>
<td style="text-align:left">git rm --cached</td>
</tr>
<tr>
<td style="text-align:left">grmv</td>
<td style="text-align:left">git remote rename</td>
</tr>
<tr>
<td style="text-align:left">grrm</td>
<td style="text-align:left">git remote remove</td>
</tr>
<tr>
<td style="text-align:left">grset</td>
<td style="text-align:left">git remote set-url</td>
</tr>
<tr>
<td style="text-align:left">grt</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">gru</td>
<td style="text-align:left">git reset --</td>
</tr>
<tr>
<td style="text-align:left">grup</td>
<td style="text-align:left">git remote update</td>
</tr>
<tr>
<td style="text-align:left">grv</td>
<td style="text-align:left">git remote -v</td>
</tr>
<tr>
<td style="text-align:left">gsb</td>
<td style="text-align:left">git status -sb</td>
</tr>
<tr>
<td style="text-align:left">gsd</td>
<td style="text-align:left">git svn dcommit</td>
</tr>
<tr>
<td style="text-align:left">gsh</td>
<td style="text-align:left">git show</td>
</tr>
<tr>
<td style="text-align:left">gsi</td>
<td style="text-align:left">git submodule init</td>
</tr>
<tr>
<td style="text-align:left">gsps</td>
<td style="text-align:left">git show --pretty=short --show-signature</td>
</tr>
<tr>
<td style="text-align:left">gsr</td>
<td style="text-align:left">git svn rebase</td>
</tr>
<tr>
<td style="text-align:left">gss</td>
<td style="text-align:left">git status -s</td>
</tr>
<tr>
<td style="text-align:left">gst</td>
<td style="text-align:left">git status</td>
</tr>
<tr>
<td style="text-align:left">gsta</td>
<td style="text-align:left">git stash push</td>
</tr>
<tr>
<td style="text-align:left">gsta</td>
<td style="text-align:left">git stash save</td>
</tr>
<tr>
<td style="text-align:left">gstaa</td>
<td style="text-align:left">git stash apply</td>
</tr>
<tr>
<td style="text-align:left">gstc</td>
<td style="text-align:left">git stash clear</td>
</tr>
<tr>
<td style="text-align:left">gstd</td>
<td style="text-align:left">git stash drop</td>
</tr>
<tr>
<td style="text-align:left">gstl</td>
<td style="text-align:left">git stash list</td>
</tr>
<tr>
<td style="text-align:left">gstp</td>
<td style="text-align:left">git stash pop</td>
</tr>
<tr>
<td style="text-align:left">gsts</td>
<td style="text-align:left">git stash show --text</td>
</tr>
<tr>
<td style="text-align:left">gstall</td>
<td style="text-align:left">git stash --all</td>
</tr>
<tr>
<td style="text-align:left">gsu</td>
<td style="text-align:left">git submodule update</td>
</tr>
<tr>
<td style="text-align:left">gts</td>
<td style="text-align:left">git tag -s</td>
</tr>
<tr>
<td style="text-align:left">gtv</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">gtl</td>
<td style="text-align:left">gtl(){ git tag --sort=-v:refname -n -l ${1}* }; noglob gtl</td>
</tr>
<tr>
<td style="text-align:left">gunignore</td>
<td style="text-align:left">git update-index --no-assume-unchanged</td>
</tr>
<tr>
<td style="text-align:left">gunwip</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">gup</td>
<td style="text-align:left">git pull --rebase</td>
</tr>
<tr>
<td style="text-align:left">gupv</td>
<td style="text-align:left">git pull --rebase -v</td>
</tr>
<tr>
<td style="text-align:left">gupa</td>
<td style="text-align:left">git pull --rebase --autostash</td>
</tr>
<tr>
<td style="text-align:left">gupav</td>
<td style="text-align:left">git pull --rebase --autostash -v</td>
</tr>
<tr>
<td style="text-align:left">glum</td>
<td style="text-align:left">git pull upstream master</td>
</tr>
<tr>
<td style="text-align:left">gwch</td>
<td style="text-align:left">git whatchanged -p --abbrev-commit --pretty=medium</td>
</tr>
<tr>
<td style="text-align:left">gwip</td>
<td style="text-align:left">git add -A; git rm $(git ls-files --deleted) 2&gt; /dev/null; git commit --no-verify --no-gpg-sign -m &quot;--wip-- [skip ci]&quot;</td>
</tr>
</tbody>
</table>
<h3 id="deprecated">Deprecated</h3>
<p>These are aliases that have been removed, renamed, or otherwise modified in a way that may, or may not, receive further support.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Alias</th>
<th style="text-align:left">Command</th>
<th>Modification</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">gap</td>
<td style="text-align:left">git add --patch</td>
<td>new alias <code>gapa</code></td>
</tr>
<tr>
<td style="text-align:left">gcl</td>
<td style="text-align:left">git config --list</td>
<td>new alias <code>gcf</code></td>
</tr>
<tr>
<td style="text-align:left">gdc</td>
<td style="text-align:left">git diff --cached</td>
<td>new alias <code>gdca</code></td>
</tr>
<tr>
<td style="text-align:left">gdt</td>
<td style="text-align:left">git difftool</td>
<td>no replacement</td>
</tr>
<tr>
<td style="text-align:left">ggpull</td>
<td style="text-align:left">git pull origin $(current_branch)</td>
<td>new alias <code>ggl</code> (<code>ggpull</code> still exists for now though)</td>
</tr>
<tr>
<td style="text-align:left">ggpur</td>
<td style="text-align:left">git pull --rebase origin $(current_branch)</td>
<td>new alias <code>ggu</code> (<code>ggpur</code> still exists for now though)</td>
</tr>
<tr>
<td style="text-align:left">ggpush</td>
<td style="text-align:left">git push origin $(current_branch)</td>
<td>new alias <code>ggp</code> (<code>ggpush</code> still exists for now though)</td>
</tr>
<tr>
<td style="text-align:left">gk</td>
<td style="text-align:left">gitk --all --branches</td>
<td>now aliased to <code>gitk --all --branches</code></td>
</tr>
<tr>
<td style="text-align:left">glg</td>
<td style="text-align:left">git log --stat --max-count = 10</td>
<td>now aliased to <code>git log --stat --color</code></td>
</tr>
<tr>
<td style="text-align:left">glgg</td>
<td style="text-align:left">git log --graph --max-count = 10</td>
<td>now aliased to <code>git log --graph --color</code></td>
</tr>
<tr>
<td style="text-align:left">gwc</td>
<td style="text-align:left">git whatchanged -p --abbrev-commit --pretty = medium</td>
<td>new alias <code>gwch</code></td>
</tr>
</tbody>
</table>
<h2 id="functions">Functions</h2>
<h3 id="current">Current</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Command</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">current_branch</td>
<td style="text-align:left">Return the name of the current branch</td>
</tr>
<tr>
<td style="text-align:left">git_current_user_name</td>
<td style="text-align:left">Returns the <code>user.name</code> config value</td>
</tr>
<tr>
<td style="text-align:left">git_current_user_email</td>
<td style="text-align:left">Returns the <code>user.email</code> config value</td>
</tr>
</tbody>
</table>
<h3 id="work-in-progress-wip">Work in Progress (WIP)</h3>
<p>These features allow to pause a branch development and switch to another one (<em>&quot;Work in Progress&quot;</em>,  or wip). When you want to go back to work, just unwip it.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Command</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">work_in_progress</td>
<td style="text-align:left">Echoes a warning if the current branch is a wip</td>
</tr>
<tr>
<td style="text-align:left">gwip</td>
<td style="text-align:left">Commit wip branch</td>
</tr>
<tr>
<td style="text-align:left">gunwip</td>
<td style="text-align:left">Uncommit wip branch</td>
</tr>
</tbody>
</table>
<h3 id="deprecated-1">Deprecated</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Command</th>
<th style="text-align:left">Description</th>
<th style="text-align:left">Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">current_repository</td>
<td style="text-align:left">Return the names of the current remotes</td>
<td style="text-align:left">Didn't work properly. Use <code>git remote -v</code> instead (<code>grv</code> alias)</td>
</tr>
</tbody>
</table>
<p>参考</p>
<ul>
<li><a href="https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins/git">https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins/git</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3aee0e423ebb89b407ca75b697cf3a28">8 - Mysql</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-ebadcae1889d3c43f4974dbe7131450b">8.1 - Mysql服务部署</h1>
    
	<h1 id="1-通过容器的方式部署">1. 通过容器的方式部署</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p ~/data/mysql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run --name my-mysql -v ~/data/mysql:/var/lib/mysql -p 3306:3306 -e <span style="color:#000">MYSQL_ROOT_PASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123456</span> -d mysql:5.7
</span></span></code></pre></div><h1 id="2-通过k8s-deployment的方式部署">2. 通过k8s deployment的方式部署</h1>
<p>部署的注意事项：</p>
<ul>
<li>
<p>mysql数据的持久化：数据卷映射和固定宿主机</p>
</li>
<li>
<p>设置账号密码及服务端口</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">strategy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Recreate </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 先删除旧 Pod，再启动新 Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql:8.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MYSQL_ROOT_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;rootpass&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MYSQL_USER</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MYSQL_PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;userpass&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3306</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># MySQL 默认端口</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">hostPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13306</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 直接映射到宿主机端口</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/mysql </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># MySQL 数据目录</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/data/mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 宿主机上的 MySQL 存储目录</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DirectoryOrCreate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">nodeName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql-node</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2609be5f858790ac1cddb1f05497c666">8.2 - Mysql常用命令之系统管理</h1>
    
	<h1 id="1-系统管理">1. 系统管理</h1>
<h2 id="1-1-连接mysql">1.1. 连接mysql</h2>
<p>快速部署docker mysql</p>
<pre tabindex="0"><code>docker pull mysql:5.7
</code></pre><p>启动MySQL</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p ~/data/mysql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run --name my-mysql -v ~/data/mysql:/var/lib/mysql -p 3306:3306 -e <span style="color:#000">MYSQL_ROOT_PASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123456</span> -d mysql:5.7
</span></span></code></pre></div><p>格式： mysql -h主机地址 -u用户名 －p用户密码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#连接本地</span>
</span></span><span style="display:flex;"><span>mysql -h&lt;localhost/127.0.0.1&gt; -P &lt;PORT&gt; -u用户名 －p用户密码
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#连接远程</span>
</span></span><span style="display:flex;"><span>mysql -h &lt;mysql地址&gt; -P &lt;PORT&gt; -u &lt;user&gt; -p &lt;password&gt; &lt;db_name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用mycli, apt install -y mycli</span>
</span></span><span style="display:flex;"><span>mycli -h &lt;mysql地址&gt; -P &lt;PORT&gt; -u &lt;user&gt; -p &lt;password&gt; &lt;db_name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#退出连接</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span>
</span></span></code></pre></div><h2 id="1-2-备份数据库">1.2. 备份数据库</h2>
<p><strong>1.导出整个数据库</strong></p>
<p>导出文件默认是存在mysql\bin目录下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#1）备份单个数据库</span>
</span></span><span style="display:flex;"><span>mysqldump -u 用户名 -p 数据库名 &gt; 导出的文件名
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysqldump -u user_name -p123456 database_name &gt; outfile_name.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#2）同时备份多个数据库，例如database1_name，database2_name</span>
</span></span><span style="display:flex;"><span>mysqldump -u user_name -p123456 --databases database1_name database2_name &gt; outfile_name.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#3）备份全部数据库</span>
</span></span><span style="display:flex;"><span>mysqldump -u user_name -p123456 --all-databases &gt; outfile_name.sql
</span></span></code></pre></div><p><strong>2.导出一个表</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysqldump -u 用户名 -p 数据库名 表名&gt; 导出的文件名
</span></span><span style="display:flex;"><span>mysqldump -u user_name -p database_name table_name &gt; outfile_name.sql
</span></span></code></pre></div><p><strong>3.导出一个数据库结构</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysqldump -u user_name -p -d –add-drop-table database_name &gt; outfile_name.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-d 没有数据 –add-drop-table 在每个create语句之前增加一个drop table
</span></span></code></pre></div><p><strong>4.带语言参数导出</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysqldump -uroot -p –default-character-set<span style="color:#ce5c00;font-weight:bold">=</span>latin1 –set-charset<span style="color:#ce5c00;font-weight:bold">=</span>gbk –skip-opt database_name &gt; outfile_name.sql
</span></span></code></pre></div><p><strong>5、导入数据库</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#1）多个个数据库</span>
</span></span><span style="display:flex;"><span>mysql -u root –p &lt; <span style="color:#ce5c00;font-weight:bold">[</span>备份文件的保存路径<span style="color:#ce5c00;font-weight:bold">]</span> 或者source <span style="color:#ce5c00;font-weight:bold">[</span>备份文件的保存路径<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#2）单个数据库</span>
</span></span><span style="display:flex;"><span>mysql -uroot –p database_name &lt; <span style="color:#ce5c00;font-weight:bold">[</span>备份文件的保存路径<span style="color:#ce5c00;font-weight:bold">]</span> 或者source <span style="color:#ce5c00;font-weight:bold">[</span>备份文件的保存路径<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h2 id="1-3-用户管理">1.3. 用户管理</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">创建用户</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;用户名&#39;</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#4e9a06">&#39;IP地址&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">identified</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;密码&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">删除用户</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;用户名&#39;</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#4e9a06">&#39;IP地址&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">delete</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;用户名&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;localhost&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">修改用户</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rename</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;用户名&#39;</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#4e9a06">&#39;IP地址&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;新用户名&#39;</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#4e9a06">&#39;IP地址&#39;</span><span style="color:#000;font-weight:bold">;;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">修改密码</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">password</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;用户名&#39;</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#4e9a06">&#39;IP地址&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Password</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;新密码&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysqladmin</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">u用户名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">p旧密码</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">password</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">新密码</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="1-4-权限管理">1.4. 权限管理</h2>
<h3 id="1-4-1-grant">1.4.1. grant</h3>
<p><strong>1、grant 权限 on 数据库对象 to 用户</strong></p>
<p>数据库对象的格式为<code>&lt;database&gt;.&lt;table&gt;</code>。<code>&lt;database&gt;.*</code>：表示授权数据库对象该数据库的所有表；<code>*.*</code>：表示授权数据库对象为所有数据库的所有表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">grant</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">privileges</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#ce5c00;font-weight:bold">&gt;@</span><span style="color:#4e9a06">&#39;&lt;ip&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">identified</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&lt;passwd&gt;&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">如果</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#a40000">为</span><span style="color:#4e9a06">&#39;%&#39;</span><span style="color:#a40000">表示不限制</span><span style="color:#000">IP</span><span style="color:#a40000">。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>2、撤销权限</strong>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">revoke</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#ce5c00;font-weight:bold">&gt;@&lt;</span><span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span></code></pre></div><h3 id="1-4-2-普通数据库用户">1.4.2. 普通数据库用户</h3>
<p>查询、插入、更新、删除 数据库中所有表数据的权利</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">grant</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">delete</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testdb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#ce5c00;font-weight:bold">&gt;@</span><span style="color:#4e9a06">&#39;&lt;ip&gt;&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="1-4-3-dba-用户">1.4.3. DBA 用户</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#a40000">、授权</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">grant</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">all</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">privileges</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">to</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">dba</span><span style="color:#ce5c00;font-weight:bold">&gt;@</span><span style="color:#4e9a06">&#39;&lt;ip&gt;&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">identified</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;&lt;passwd&gt;&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#a40000">、刷新系统权限</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">flush</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">privileges</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="1-4-4-查看用户权限">1.4.4. 查看用户权限</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">查看当前用户（自己）权限</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">show</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">grants</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">查看指定</span><span style="color:#000">MySQL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">用户权限</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">show</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">grants</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#ce5c00;font-weight:bold">&gt;@&lt;</span><span style="color:#000">localhost</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">查看</span><span style="color:#000">user和host</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="1-4-5-权限列表">1.4.5. 权限列表</h3>
<table>
<thead>
<tr>
<th>权限</th>
<th>说明</th>
<th>网站使用账户是否给予</th>
</tr>
</thead>
<tbody>
<tr>
<td>Select</td>
<td>可对其下所有表进行查询</td>
<td>建议给予</td>
</tr>
<tr>
<td>Insert</td>
<td>可对其下所有表进行插入</td>
<td>建议给予</td>
</tr>
<tr>
<td>Update</td>
<td>可对其下所有表进行更新</td>
<td>建议给予</td>
</tr>
<tr>
<td>Delete</td>
<td>可对其下所有表进行删除</td>
<td>建议给予</td>
</tr>
<tr>
<td>Create</td>
<td>可在此数据库下创建表或索引</td>
<td>建议给予</td>
</tr>
<tr>
<td>Drop</td>
<td>可删除此数据库及数据库下所有表</td>
<td>不建议给予</td>
</tr>
<tr>
<td>Grant</td>
<td>赋予权限选项</td>
<td>不建议给予</td>
</tr>
<tr>
<td>References</td>
<td>未来MySQL特性的占位符</td>
<td>不建议给予</td>
</tr>
<tr>
<td>Index</td>
<td>可对其下所有表进行索引</td>
<td>建议给予</td>
</tr>
<tr>
<td>Alter</td>
<td>可对其下所有表进行更改</td>
<td>建议给予</td>
</tr>
<tr>
<td>Create_tmp_table</td>
<td>创建临时表</td>
<td>不建议给予</td>
</tr>
<tr>
<td>Lock_tables</td>
<td>可对其下所有表进行锁定</td>
<td>不建议给予</td>
</tr>
<tr>
<td>Create_view</td>
<td>可在此数据下创建视图</td>
<td>建议给予</td>
</tr>
<tr>
<td>Show_view</td>
<td>可在此数据下查看视图</td>
<td>建议给予</td>
</tr>
<tr>
<td>Create_routine</td>
<td>可在此数据下创建存储过程</td>
<td>不建议给予</td>
</tr>
<tr>
<td>Alter_routine</td>
<td>可在此数据下更改存储过程</td>
<td>不建议给予</td>
</tr>
<tr>
<td>Execute</td>
<td>可在此数据下执行存储过程</td>
<td>不建议给予</td>
</tr>
<tr>
<td>Event</td>
<td>可在此数据下创建事件调度器</td>
<td>不建议给予</td>
</tr>
<tr>
<td>Trigger</td>
<td>可在此数据下创建触发器</td>
<td>不建议给予</td>
</tr>
</tbody>
</table>
<h3 id="1-4-6-查看主从关系">1.4.6.查看主从关系</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">登录主机</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">show</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">slave</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hosts</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">登录从机</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">show</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">slave</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7ccae74658d9fc5c12e59022143d21b7">8.3 - Mysql常用命令之数据表操作</h1>
    
	<h1 id="2-数据库操作">2. 数据库操作</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">创建数据库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#a40000">数据库名</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">显示数据库</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">show</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">databases</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">删除数据</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">database</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#a40000">数据库名</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="3-数据表操作">3. 数据表操作</h1>
<h2 id="3-1-创建表">3.1. 创建表</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">列名</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">类型</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">是否可以为空，</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#a40000">列名</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">类型</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">是否可以为空</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ENGINE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">InnoDB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CHARSET</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">utf8</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>默认值，创建列时可以指定默认值，当插入数据时如果未主动设置，则自动添加默认值</li>
<li>自增，如果为某列设置自增列，插入数据时无需设置此列，默认将自增（表中只能有一个自增列）注意：1、对于自增列，必须是索引（含主键）2、对于自增可以设置步长和起始值</li>
<li>主键，一种特殊的唯一索引，不允许有空值，如果主键使用单个列，则它的值必须唯一，如果是多列，则其组合必须唯一。</li>
</ul>
<h2 id="3-2-查看表">3.2. 查看表</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">show</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tables</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">查看数据库全部表</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">查看表所有内容</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-3-删除表">3.3. 删除表</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-4-清空表内容">3.4. 清空表内容</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">delete</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">truncate</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-5-查看表结构">3.5. 查看表结构</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-6-修改表">3.6. 修改表</h2>
<p><strong>列操作</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">添加列</span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">add</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">列名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">类型</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">add</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">列名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">类型</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">after</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#a40000">列名</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">删除列</span><span style="color:#f8f8f8;text-decoration:underline">   
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">列名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">修改列</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">modify</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">column</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">列名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">类型</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">-- 类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">change</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">原列名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">新列名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">类型</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">-- 列名，类型
</span></span></span></code></pre></div><p><strong>主键操作</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">添加主键</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">add</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">primary</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">列名</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">删除主键</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">primary</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">modify</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#a40000">列名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">primary</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">修改主键：先删除后添加</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">primary</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">add</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">primary</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">列名</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">添加外键</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">从表</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">add</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">constraint</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">外键名称（形如：</span><span style="color:#000">FK从表主表</span><span style="color:#a40000">）</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">foreign</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">从表</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">外键字段</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">references</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">主表</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">主键字段</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">删除外键</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表名</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">foreign</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">外键名称</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>默认值操作</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">修改默认值：</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testalter_tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">删除默认值：</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testalter_tbl</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">i</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DROP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>调整表结构字段顺序</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">modify</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#a40000">字段</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">after</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#a40000">字段</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table_name</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">modify</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">unsigned</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">auto_increment</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">first</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5ba81b3ac92960640ff1ead93cc35ba1">8.4 - Mysql常用命令之表内容操作</h1>
    
	<h1 id="4-表内容操作">4. 表内容操作</h1>
<h2 id="4-1-增">4.1. 增</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">列名</span><span style="color:#000;font-weight:bold">,</span><span style="color:#a40000">列名</span><span style="color:#000;font-weight:bold">...)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">值</span><span style="color:#000;font-weight:bold">,</span><span style="color:#a40000">值</span><span style="color:#000;font-weight:bold">,...)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">列名</span><span style="color:#000;font-weight:bold">,</span><span style="color:#a40000">列名</span><span style="color:#000;font-weight:bold">...)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">值</span><span style="color:#000;font-weight:bold">,</span><span style="color:#a40000">值</span><span style="color:#000;font-weight:bold">,...),(</span><span style="color:#a40000">值</span><span style="color:#000;font-weight:bold">,</span><span style="color:#a40000">值</span><span style="color:#000;font-weight:bold">,</span><span style="color:#a40000">值</span><span style="color:#000;font-weight:bold">...)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">列名</span><span style="color:#000;font-weight:bold">,</span><span style="color:#a40000">列名</span><span style="color:#000;font-weight:bold">...)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">列名</span><span style="color:#000;font-weight:bold">,</span><span style="color:#a40000">列名</span><span style="color:#000;font-weight:bold">...)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#a40000">例：</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tab1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">email</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;zhangyanlin&#39;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#39;zhangyanlin8851@163.com&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="4-2-删">4.2. 删</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">delete</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表</span><span style="color:#f8f8f8;text-decoration:underline">                                      </span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">删除表里全部数据</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">delete</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#a40000">＝</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#a40000">＝</span><span style="color:#4e9a06">&#39;zhangyanlin&#39;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">删除</span><span style="color:#000">ID</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">和</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;zhangyanlin&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">那一行数据</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="4-3-改">4.3. 改</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">＝</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;zhangyanlin&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="4-4-查">4.4. 查</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">gender</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">as</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gg</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">表</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="4-5-条件判断">4.5. 条件判断</h2>
<h3 id="4-5-1-where">4.5.1. where</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">!=</span><span style="color:#4e9a06">&#39;huwh&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">between</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">and</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">33</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">not</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">33</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="4-5-2-通配符like">4.5.2. 通配符like</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">like</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;hu%&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">hu开头</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">name</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">like</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;hu_&#39;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#000">hu开头后接一个字符</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="4-5-3-限制limit">4.5.3. 限制limit</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">limit</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">前</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#a40000">行</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">limit</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">从第四行开始的</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#a40000">行</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">limit</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">offset</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">从第四行开始的</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#a40000">行</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="4-5-4-排序asc-desc">4.5.4. 排序asc，desc</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">列</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">asc</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">跟据“列”从小到大排序（不指定默认为从小到大排序）</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">列</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">根据“列”从大到小排序</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">列</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">,</span><span style="color:#a40000">列</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">asc</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">#</span><span style="color:#a40000">根据“列</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#a40000">”从大到小排序，如果相同则按“列</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#a40000">”从小到大排序</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="4-5-5-分组group-by">4.5.5. 分组group by</h3>
<p>group by 必须在where之后，order by之前。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">     
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">nid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">nid</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">nid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">order</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nid</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">desc</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">nid</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">),</span><span style="color:#204a87;font-weight:bold">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">score</span><span style="color:#000;font-weight:bold">),</span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">score</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">having</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">num</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9e477e659dccf915ab32cf50bbf82a15">9 - Redis</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-06c8cb916130c134fb71dc7a25278b26">9.1 - Redis介绍</h1>
    
	<h1 id="1-redis是什么-what">1. redis是什么？（what）</h1>
<p>Redis是一个开源（BSD许可），内存存储的数据结构服务器，可用作数据库，高速缓存和消息队列代理。它支持字符串、哈希表、列表、集合、有序集合，位图，hyperloglogs等数据类型。内置复制、Lua脚本、LRU收回、事务以及不同级别磁盘持久化功能，同时通过Redis Sentinel提供高可用，通过Redis Cluster提供自动分区。</p>
<p>Redis是一个开源的使用ANSI C语言编写、遵守BSD协议、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。</p>
<h1 id="2-为什么使用redis-why">2. 为什么使用redis？（why）</h1>
<h2 id="2-1-redis的特点">2.1. redis的特点</h2>
<ol>
<li>Redis支持数据的持久化，可以将内存中的数据保持在磁盘中，重启的时候可以再次加载进行使用。</li>
<li>Redis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储。</li>
<li>Redis支持数据的备份，即master-slave模式的数据备份。</li>
</ol>
<h2 id="2-2-redis的优势">2.2. redis的优势</h2>
<ol>
<li>性能极高 – Redis能读的速度是110000次/s,写的速度是81000次/s 。</li>
<li>丰富的数据类型 – Redis支持二进制案例的 Strings, Lists, Hashes, Sets 及 Ordered Sets 数据类型操作。</li>
<li>原子 – Redis的所有操作都是原子性的，同时Redis还支持对几个操作全并后的原子性执行。</li>
<li>丰富的特性 – Redis还支持 publish/subscribe, 通知, key 过期等等特性。</li>
</ol>
<h2 id="2-3-redis与其他key-value存储有什么不同">2.3. redis与其他key-value存储有什么不同</h2>
<ol>
<li>Redis有着更为复杂的数据结构并且提供对他们的原子性操作，Redis的数据类型都是基于基本数据结构的同时对程序员透明，无需进行额外的抽象。</li>
<li>Redis运行在内存中但是可以持久化到磁盘，所以在对不同数据集进行高速读写时需要权衡内存，应为数据量不能大于硬件内存。</li>
<li>相比在磁盘上相同的复杂的数据结构，在内存中操作起来非常简单，这样Redis可以做很多内部复杂性很强的事情。</li>
<li>在磁盘格式方面他们是紧凑的以追加的方式产生的，因为他们并不需要进行随机访问。</li>
</ol>
<h1 id="3-如何使用redis-how">3. 如何使用redis？（how）</h1>
<h2 id="3-1-redis的数据类型">3.1. redis的数据类型</h2>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>概念</th>
<th>常用命令</th>
</tr>
</thead>
<tbody>
<tr>
<td>String(字符串)</td>
<td>key-value型</td>
<td>SET ，GET</td>
</tr>
<tr>
<td>Hash(哈希)</td>
<td>field-value,适用于存储对象类型（对象名-对象属性值）</td>
<td>HMSET，HEGTALL</td>
</tr>
<tr>
<td>List(列表)</td>
<td>string类型的有序列表，按照插入顺序排序</td>
<td>lpush，lrange</td>
</tr>
<tr>
<td>Set(集合)</td>
<td>string类型的无序集合</td>
<td>sadd，smembers</td>
</tr>
<tr>
<td>zset(sorted set：有序集合)</td>
<td>string类型元素的集合,且不允许重复的成员。每个元素关联一个double值来进行排序，double值可以重复但元素不能重复。</td>
<td>zadd，ZRANGEBYSCORE</td>
</tr>
</tbody>
</table>
<h2 id="3-2-redis常用命令">3.2. redis常用命令</h2>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f92dac7a4ae2762cd888cf113e026e81">9.2 - Redis集群模式部署</h1>
    
	<h1 id="1-redis部署">1. Redis部署</h1>
<blockquote>
<p>以下以Linux系统为例</p>
</blockquote>
<h2 id="1-1-下载和编译">1.1 下载和编译</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ wget http://download.redis.io/releases/redis-4.0.7.tar.gz
</span></span><span style="display:flex;"><span>$ tar xzf redis-4.0.7.tar.gz
</span></span><span style="display:flex;"><span>$ <span style="color:#204a87">cd</span> redis-4.0.7
</span></span><span style="display:flex;"><span>$ make
</span></span></code></pre></div><p>编译完成后会在<code>src</code>目录下生成Redis服务端程序<code>redis-server</code>和客户端程序<code>redis-cli</code>。</p>
<h2 id="1-2-启动服务">1.2 启动服务</h2>
<p><strong>1、前台运行</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>src/redis-server
</span></span></code></pre></div><p>该方式启动默认为<code>前台方式</code>运行，使用默认配置。</p>
<p><strong>2、后台运行</strong></p>
<p>可以修改<code>redis.conf</code>文件的<code>daemonize</code>参数为<code>yes</code>，指定配置文件启动，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi redis.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default Redis does not run as a daemon. Use &#39;yes&#39; if you need it.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note that Redis will write a pid file in /var/run/redis.pid when daemonized.</span>
</span></span><span style="display:flex;"><span>daemonize yes
</span></span></code></pre></div><p>指定配置文件启动。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>src/redis-server redis.conf
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#指定配置文件后台启动</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 redis-4.0.7<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># src/redis-server redis.conf</span>
</span></span><span style="display:flex;"><span>95778:C <span style="color:#0000cf;font-weight:bold">30</span> Jan 00:44:37.633 <span style="color:#8f5902;font-style:italic"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
</span></span><span style="display:flex;"><span>95778:C <span style="color:#0000cf;font-weight:bold">30</span> Jan 00:44:37.634 <span style="color:#8f5902;font-style:italic"># Redis version=4.0.7, bits=64, commit=00000000, modified=0, pid=95778, just started</span>
</span></span><span style="display:flex;"><span>95778:C <span style="color:#0000cf;font-weight:bold">30</span> Jan 00:44:37.634 <span style="color:#8f5902;font-style:italic"># Configuration loaded</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#查看Redis进程</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 redis-4.0.7<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># ps aux|grep redis</span>
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">95779</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">145268</span>   <span style="color:#0000cf;font-weight:bold">468</span> ?        Ssl  00:44   0:00 src/redis-server 127.0.0.1:6379
</span></span></code></pre></div><p>更多启动参数如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 src<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># ./redis-server --help</span>
</span></span><span style="display:flex;"><span>Usage: ./redis-server <span style="color:#ce5c00;font-weight:bold">[</span>/path/to/redis.conf<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>options<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>       ./redis-server - <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">read</span> config from stdin<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       ./redis-server -v or --version
</span></span><span style="display:flex;"><span>       ./redis-server -h or --help
</span></span><span style="display:flex;"><span>       ./redis-server --test-memory &lt;megabytes&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Examples:
</span></span><span style="display:flex;"><span>       ./redis-server <span style="color:#ce5c00;font-weight:bold">(</span>run the server with default conf<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       ./redis-server /etc/redis/6379.conf
</span></span><span style="display:flex;"><span>       ./redis-server --port <span style="color:#0000cf;font-weight:bold">7777</span>
</span></span><span style="display:flex;"><span>       ./redis-server --port <span style="color:#0000cf;font-weight:bold">7777</span> --slaveof 127.0.0.1 <span style="color:#0000cf;font-weight:bold">8888</span>
</span></span><span style="display:flex;"><span>       ./redis-server /etc/myredis.conf --loglevel verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Sentinel mode:
</span></span><span style="display:flex;"><span>       ./redis-server /etc/sentinel.conf --sentinel
</span></span></code></pre></div><h2 id="1-3-客户端测试">1.3 客户端测试</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ src/redis-cli
</span></span><span style="display:flex;"><span>redis&gt; <span style="color:#204a87">set</span> foo bar
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>redis&gt; get foo
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;bar&#34;</span>
</span></span></code></pre></div><h1 id="2-redis集群部署">2. Redis集群部署</h1>
<p>Redis的集群部署需要在每台集群部署的机器上安装Redis（可参考上述的[Redis安装] ），然后修改配置以集群的方式启动。</p>
<h2 id="2-1-手动部署集群">2.1 手动部署集群</h2>
<h3 id="2-1-1-设置配置文件及启动实例">2.1.1 设置配置文件及启动实例</h3>
<p>修改配置文件redis.conf，集群模式的最小化配置文件如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#可选操作，该项设置后台方式运行，</span>
</span></span><span style="display:flex;"><span>daemonize yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>port <span style="color:#0000cf;font-weight:bold">7000</span>
</span></span><span style="display:flex;"><span>cluster-enabled yes
</span></span><span style="display:flex;"><span>cluster-config-file nodes.conf
</span></span><span style="display:flex;"><span>cluster-node-timeout <span style="color:#0000cf;font-weight:bold">5000</span>
</span></span><span style="display:flex;"><span>appendonly yes
</span></span></code></pre></div><blockquote>
<p>更多集群配置参数可参考默认配置文件redis.conf中<code>Cluster</code>模块的说明</p>
</blockquote>
<p>最小集群模式需要三个master实例，一般建议起六个实例，即三主三从。因此我们创建6个以端口号命名的目录存放实例的配置文件和其他信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir cluster-test
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> cluster-test
</span></span><span style="display:flex;"><span>mkdir <span style="color:#0000cf;font-weight:bold">7000</span> <span style="color:#0000cf;font-weight:bold">7001</span> <span style="color:#0000cf;font-weight:bold">7002</span> <span style="color:#0000cf;font-weight:bold">7003</span> <span style="color:#0000cf;font-weight:bold">7004</span> <span style="color:#0000cf;font-weight:bold">7005</span>
</span></span></code></pre></div><p>在对应端口号的目录中创建<code>redis.conf</code>的文件，配置文件的内容可参考上述的集群模式配置。每个配置文件中的端口号<code>port</code>参数改为对应目录的端口号。</p>
<p>复制<code>redis-server</code>的二进制文件到<code>cluster-test</code>目录中，通过指定配置文件的方式启动<code>redis</code>服务，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> <span style="color:#0000cf;font-weight:bold">7000</span>
</span></span><span style="display:flex;"><span>../redis-server ./redis.conf
</span></span></code></pre></div><p>如果是以前台方式运行，则会在控制台输出以下信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>82462<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#0000cf;font-weight:bold">26</span> Nov 11:56:55.329 * No cluster configuration found, I<span style="color:#a40000">&#39;</span>m 97a3a64667477371c4479320d683e4c8db5858b1
</span></span></code></pre></div><p>每个实例都会生成一个<code>Node ID</code>，类似<code>97a3a64667477371c4479320d683e4c8db5858b1</code>，用来作为Redis实例在集群中的唯一标识，而不是通过IP和Port，IP和Port可能会改变，该<code>Node ID</code>不会改变。</p>
<p>目录结构可参考：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cluster-test/
</span></span><span style="display:flex;"><span>├── <span style="color:#0000cf;font-weight:bold">7000</span>
</span></span><span style="display:flex;"><span>│   ├── appendonly.aof
</span></span><span style="display:flex;"><span>│   ├── dump.rdb
</span></span><span style="display:flex;"><span>│   ├── nodes.conf
</span></span><span style="display:flex;"><span>│   └── redis.conf
</span></span><span style="display:flex;"><span>├── <span style="color:#0000cf;font-weight:bold">7001</span>
</span></span><span style="display:flex;"><span>│   ├── appendonly.aof
</span></span><span style="display:flex;"><span>│   ├── dump.rdb
</span></span><span style="display:flex;"><span>│   ├── nodes.conf
</span></span><span style="display:flex;"><span>│   └── redis.conf
</span></span><span style="display:flex;"><span>├── <span style="color:#0000cf;font-weight:bold">7002</span>
</span></span><span style="display:flex;"><span>│   ├── appendonly.aof
</span></span><span style="display:flex;"><span>│   ├── dump.rdb
</span></span><span style="display:flex;"><span>│   ├── nodes.conf
</span></span><span style="display:flex;"><span>│   └── redis.conf
</span></span><span style="display:flex;"><span>├── <span style="color:#0000cf;font-weight:bold">7003</span>
</span></span><span style="display:flex;"><span>│   ├── appendonly.aof
</span></span><span style="display:flex;"><span>│   ├── dump.rdb
</span></span><span style="display:flex;"><span>│   ├── nodes.conf
</span></span><span style="display:flex;"><span>│   └── redis.conf
</span></span><span style="display:flex;"><span>├── <span style="color:#0000cf;font-weight:bold">7004</span>
</span></span><span style="display:flex;"><span>│   ├── appendonly.aof
</span></span><span style="display:flex;"><span>│   ├── dump.rdb
</span></span><span style="display:flex;"><span>│   ├── nodes.conf
</span></span><span style="display:flex;"><span>│   └── redis.conf
</span></span><span style="display:flex;"><span>├── <span style="color:#0000cf;font-weight:bold">7005</span>
</span></span><span style="display:flex;"><span>│   ├── appendonly.aof
</span></span><span style="display:flex;"><span>│   ├── dump.rdb
</span></span><span style="display:flex;"><span>│   ├── nodes.conf
</span></span><span style="display:flex;"><span>│   └── redis.conf
</span></span><span style="display:flex;"><span>├── redis-cli
</span></span><span style="display:flex;"><span>└── redis-server
</span></span></code></pre></div><h3 id="2-1-2-redis-trib创建集群">2.1.2 redis-trib创建集群</h3>
<p>Redis的实例全部运行之后，还需要<code>redis-trib.rb</code>工具来完成集群的创建，<code>redis-trib.rb</code>二进制文件在Redis包主目录下的<code>src</code>目录中，运行该工具依赖<code>Ruby</code>环境和<code>gem</code>，因此需要提前安装。</p>
<p><strong>1、安装Ruby</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum -y install ruby rubygems
</span></span></code></pre></div><p>查看Ruby版本信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 src<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># ruby --version</span>
</span></span><span style="display:flex;"><span>ruby 2.0.0p648 <span style="color:#ce5c00;font-weight:bold">(</span>2015-12-16<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">[</span>x86_64-linux<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>由于<code>centos</code>系统默认支持Ruby版本为<code>2.0.0</code>，因此执行<code>gem install redis</code>命令时会报以下错误。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 src<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># gem install redis</span>
</span></span><span style="display:flex;"><span>Fetching: redis-4.0.1.gem <span style="color:#ce5c00;font-weight:bold">(</span>100%<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>ERROR:  Error installing redis:
</span></span><span style="display:flex;"><span>	redis requires Ruby version &gt;<span style="color:#ce5c00;font-weight:bold">=</span> 2.2.2.
</span></span></code></pre></div><p>解决方法是先安装<code>rvm</code>，再升级<code>ruby</code>版本。</p>
<p><strong>2、安装rvm</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -L get.rvm.io <span style="color:#000;font-weight:bold">|</span> bash -s stable
</span></span></code></pre></div><p>如果遇到以下报错，则执行报错中的<code>gpg2 --recv-keys </code>的命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># curl -L get.rvm.io | bash -s stable</span>
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">100</span>   <span style="color:#0000cf;font-weight:bold">194</span>  <span style="color:#0000cf;font-weight:bold">100</span>   <span style="color:#0000cf;font-weight:bold">194</span>    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">335</span>      <span style="color:#0000cf;font-weight:bold">0</span> --:--:-- --:--:-- --:--:--   <span style="color:#0000cf;font-weight:bold">335</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#0000cf;font-weight:bold">24090</span>  <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#0000cf;font-weight:bold">24090</span>    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>  <span style="color:#0000cf;font-weight:bold">17421</span>      <span style="color:#0000cf;font-weight:bold">0</span>  0:00:01  0:00:01 --:--:-- <span style="color:#0000cf;font-weight:bold">44446</span>
</span></span><span style="display:flex;"><span>Downloading https://github.com/rvm/rvm/archive/1.29.3.tar.gz
</span></span><span style="display:flex;"><span>Downloading https://github.com/rvm/rvm/releases/download/1.29.3/1.29.3.tar.gz.asc
</span></span><span style="display:flex;"><span>gpg: 于 2017年09月11日 星期一 04时59分21秒 CST 创建的签名，使用 RSA，钥匙号 BF04FF17
</span></span><span style="display:flex;"><span>gpg: 无法检查签名：没有公钥
</span></span><span style="display:flex;"><span>Warning, RVM 1.26.0 introduces signed releases and automated check of signatures when GPG software found. Assuming you trust Michal Papis import the mpapis public key <span style="color:#ce5c00;font-weight:bold">(</span>downloading the signatures<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GPG signature verification failed <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#4e9a06">&#39;/usr/local/rvm/archives/rvm-1.29.3.tgz&#39;</span> - <span style="color:#4e9a06">&#39;https://github.com/rvm/rvm/releases/download/1.29.3/1.29.3.tar.gz.asc&#39;</span>! Try to install GPG v2 and <span style="color:#204a87;font-weight:bold">then</span> fetch the public key:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>or <span style="color:#204a87;font-weight:bold">if</span> it fails:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">command</span> curl -sSL https://rvm.io/mpapis.asc <span style="color:#000;font-weight:bold">|</span> gpg2 --import -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>the key can be compared with:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    https://rvm.io/mpapis.asc
</span></span><span style="display:flex;"><span>    https://keybase.io/mpapis
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NOTE: GPG version 2.1.17 have a bug which cause failures during fetching keys from remote server. Please downgrade or upgrade to newer version <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">if</span> available<span style="color:#ce5c00;font-weight:bold">)</span> or use the second method described above.
</span></span></code></pre></div><p>执行报错中的<code>gpg2 --recv-keys </code>的命令。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3</span>
</span></span><span style="display:flex;"><span>gpg: 钥匙环‘/root/.gnupg/secring.gpg’已建立
</span></span><span style="display:flex;"><span>gpg: 下载密钥‘D39DC0E3’，从 hkp 服务器 keys.gnupg.net
</span></span><span style="display:flex;"><span>gpg: /root/.gnupg/trustdb.gpg：建立了信任度数据库
</span></span><span style="display:flex;"><span>gpg: 密钥 D39DC0E3：公钥“Michal Papis <span style="color:#ce5c00;font-weight:bold">(</span>RVM signing<span style="color:#ce5c00;font-weight:bold">)</span> &lt;mpapis@gmail.com&gt;”已导入
</span></span><span style="display:flex;"><span>gpg: 没有找到任何绝对信任的密钥
</span></span><span style="display:flex;"><span>gpg: 合计被处理的数量：1
</span></span><span style="display:flex;"><span>gpg:           已导入：1  <span style="color:#ce5c00;font-weight:bold">(</span>RSA: 1<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>再次执行命令<code>curl -L get.rvm.io | bash -s stable</code>。例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># curl -L get.rvm.io | bash -s stable</span>
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">100</span>   <span style="color:#0000cf;font-weight:bold">194</span>  <span style="color:#0000cf;font-weight:bold">100</span>   <span style="color:#0000cf;font-weight:bold">194</span>    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">310</span>      <span style="color:#0000cf;font-weight:bold">0</span> --:--:-- --:--:-- --:--:--   <span style="color:#0000cf;font-weight:bold">309</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#0000cf;font-weight:bold">24090</span>  <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#0000cf;font-weight:bold">24090</span>    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>  <span style="color:#0000cf;font-weight:bold">18230</span>      <span style="color:#0000cf;font-weight:bold">0</span>  0:00:01  0:00:01 --:--:--  103k
</span></span><span style="display:flex;"><span>Downloading https://github.com/rvm/rvm/archive/1.29.3.tar.gz
</span></span><span style="display:flex;"><span>Downloading https://github.com/rvm/rvm/releases/download/1.29.3/1.29.3.tar.gz.asc
</span></span><span style="display:flex;"><span>gpg: 于 2017年09月11日 星期一 04时59分21秒 CST 创建的签名，使用 RSA，钥匙号 BF04FF17
</span></span><span style="display:flex;"><span>gpg: 完好的签名，来自于“Michal Papis <span style="color:#ce5c00;font-weight:bold">(</span>RVM signing<span style="color:#ce5c00;font-weight:bold">)</span> &lt;mpapis@gmail.com&gt;”
</span></span><span style="display:flex;"><span>gpg:               亦即“Michal Papis &lt;michal.papis@toptal.com&gt;”
</span></span><span style="display:flex;"><span>gpg:               亦即“<span style="color:#ce5c00;font-weight:bold">[</span>jpeg image of size 5015<span style="color:#ce5c00;font-weight:bold">]</span>”
</span></span><span style="display:flex;"><span>gpg: 警告：这把密钥未经受信任的签名认证！
</span></span><span style="display:flex;"><span>gpg:       没有证据表明这个签名属于它所声称的持有者。
</span></span><span style="display:flex;"><span>主钥指纹： 409B 6B17 96C2 <span style="color:#0000cf;font-weight:bold">7546</span> 2A17  <span style="color:#0000cf;font-weight:bold">0311</span> <span style="color:#0000cf;font-weight:bold">3804</span> BB82 D39D C0E3
</span></span><span style="display:flex;"><span>子钥指纹： 62C9 E5F4 DA30 0D94 AC36  166B E206 C29F BF04 FF17
</span></span><span style="display:flex;"><span>GPG verified <span style="color:#4e9a06">&#39;/usr/local/rvm/archives/rvm-1.29.3.tgz&#39;</span>
</span></span><span style="display:flex;"><span>Creating group <span style="color:#4e9a06">&#39;rvm&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Installing RVM to /usr/local/rvm/
</span></span><span style="display:flex;"><span>Installation of RVM in /usr/local/rvm/ is almost complete:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  * First you need to add all users that will be using rvm to <span style="color:#4e9a06">&#39;rvm&#39;</span> group,
</span></span><span style="display:flex;"><span>    and <span style="color:#204a87">logout</span> - login again, anyone using rvm will be operating with <span style="color:#4e9a06">`</span><span style="color:#204a87">umask</span> <span style="color:#000">u</span><span style="color:#ce5c00;font-weight:bold">=</span>rwx,g<span style="color:#ce5c00;font-weight:bold">=</span>rwx,o<span style="color:#ce5c00;font-weight:bold">=</span>rx<span style="color:#4e9a06">`</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  * To start using RVM you need to run <span style="color:#4e9a06">`</span><span style="color:#204a87">source</span> /etc/profile.d/rvm.sh<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex;"><span>    in all your open bash windows, in rare cases you need to reopen all bash windows.
</span></span></code></pre></div><p>以上表示执行成功，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">source</span> /usr/local/rvm/scripts/rvm
</span></span></code></pre></div><p>查看rvm库中已知的ruby版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>rvm list known
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># rvm list known</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># MRI Rubies</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>ruby-<span style="color:#ce5c00;font-weight:bold">]</span>1.8.6<span style="color:#ce5c00;font-weight:bold">[</span>-p420<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>ruby-<span style="color:#ce5c00;font-weight:bold">]</span>1.8.7<span style="color:#ce5c00;font-weight:bold">[</span>-head<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#8f5902;font-style:italic"># security released on head</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>ruby-<span style="color:#ce5c00;font-weight:bold">]</span>1.9.1<span style="color:#ce5c00;font-weight:bold">[</span>-p431<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>ruby-<span style="color:#ce5c00;font-weight:bold">]</span>1.9.2<span style="color:#ce5c00;font-weight:bold">[</span>-p330<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>ruby-<span style="color:#ce5c00;font-weight:bold">]</span>1.9.3<span style="color:#ce5c00;font-weight:bold">[</span>-p551<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>ruby-<span style="color:#ce5c00;font-weight:bold">]</span>2.0.0<span style="color:#ce5c00;font-weight:bold">[</span>-p648<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>ruby-<span style="color:#ce5c00;font-weight:bold">]</span>2.1<span style="color:#ce5c00;font-weight:bold">[</span>.10<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>ruby-<span style="color:#ce5c00;font-weight:bold">]</span>2.2<span style="color:#ce5c00;font-weight:bold">[</span>.7<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>ruby-<span style="color:#ce5c00;font-weight:bold">]</span>2.3<span style="color:#ce5c00;font-weight:bold">[</span>.4<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>ruby-<span style="color:#ce5c00;font-weight:bold">]</span>2.4<span style="color:#ce5c00;font-weight:bold">[</span>.1<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>ruby-head
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><strong>3、升级Ruby</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#安装ruby</span>
</span></span><span style="display:flex;"><span>rvm install  2.4.0
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#使用新版本</span>
</span></span><span style="display:flex;"><span>rvm use  2.4.0
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#移除旧版本</span>
</span></span><span style="display:flex;"><span>rvm remove 2.0.0
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#查看当前版本</span>
</span></span><span style="display:flex;"><span>ruby --version
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># rvm install  2.4.0</span>
</span></span><span style="display:flex;"><span>Searching <span style="color:#204a87;font-weight:bold">for</span> binary rubies, this might take some time.
</span></span><span style="display:flex;"><span>Found remote file https://rvm_io.global.ssl.fastly.net/binaries/centos/7/x86_64/ruby-2.4.0.tar.bz2
</span></span><span style="display:flex;"><span>Checking requirements <span style="color:#204a87;font-weight:bold">for</span> centos.
</span></span><span style="display:flex;"><span>Installing requirements <span style="color:#204a87;font-weight:bold">for</span> centos.
</span></span><span style="display:flex;"><span>Installing required packages: autoconf, automake, bison, bzip2, gcc-c++, libffi-devel, libtool, readline-devel, sqlite-devel, zlib-devel, libyaml-devel, openssl-devel................................
</span></span><span style="display:flex;"><span>Requirements installation successful.
</span></span><span style="display:flex;"><span>ruby-2.4.0 - <span style="color:#8f5902;font-style:italic">#configure</span>
</span></span><span style="display:flex;"><span>ruby-2.4.0 - <span style="color:#8f5902;font-style:italic">#download</span>
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">100</span> 14.0M  <span style="color:#0000cf;font-weight:bold">100</span> 14.0M    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>   852k      <span style="color:#0000cf;font-weight:bold">0</span>  0:00:16  0:00:16 --:--:--  980k
</span></span><span style="display:flex;"><span>No checksum <span style="color:#204a87;font-weight:bold">for</span> downloaded archive, recording checksum in user configuration.
</span></span><span style="display:flex;"><span>ruby-2.4.0 - <span style="color:#8f5902;font-style:italic">#validate archive</span>
</span></span><span style="display:flex;"><span>ruby-2.4.0 - <span style="color:#8f5902;font-style:italic">#extract</span>
</span></span><span style="display:flex;"><span>ruby-2.4.0 - <span style="color:#8f5902;font-style:italic">#validate binary</span>
</span></span><span style="display:flex;"><span>ruby-2.4.0 - <span style="color:#8f5902;font-style:italic">#setup</span>
</span></span><span style="display:flex;"><span>ruby-2.4.0 - <span style="color:#8f5902;font-style:italic">#gemset created /usr/local/rvm/gems/ruby-2.4.0@global</span>
</span></span><span style="display:flex;"><span>ruby-2.4.0 - <span style="color:#8f5902;font-style:italic">#importing gemset /usr/local/rvm/gemsets/global.gems..............................</span>
</span></span><span style="display:flex;"><span>ruby-2.4.0 - <span style="color:#8f5902;font-style:italic">#generating global wrappers........</span>
</span></span><span style="display:flex;"><span>ruby-2.4.0 - <span style="color:#8f5902;font-style:italic">#gemset created /usr/local/rvm/gems/ruby-2.4.0</span>
</span></span><span style="display:flex;"><span>ruby-2.4.0 - <span style="color:#8f5902;font-style:italic">#importing gemsetfile /usr/local/rvm/gemsets/default.gems evaluated to empty gem list</span>
</span></span><span style="display:flex;"><span>ruby-2.4.0 - <span style="color:#8f5902;font-style:italic">#generating default wrappers........</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># rvm use  2.4.0</span>
</span></span><span style="display:flex;"><span>Using /usr/local/rvm/gems/ruby-2.4.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># rvm remove 2.0.0</span>
</span></span><span style="display:flex;"><span>ruby-2.0.0-p648 - <span style="color:#8f5902;font-style:italic">#already gone</span>
</span></span><span style="display:flex;"><span>Using /usr/local/rvm/gems/ruby-2.4.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># ruby --version</span>
</span></span><span style="display:flex;"><span>ruby 2.4.0p0 <span style="color:#ce5c00;font-weight:bold">(</span>2016-12-24 revision 57164<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">[</span>x86_64-linux<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p><strong>4、安装gem</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gem install redis
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># gem install redis</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Fetching: redis-4.0.1.gem <span style="color:#ce5c00;font-weight:bold">(</span>100%<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Successfully installed redis-4.0.1
</span></span><span style="display:flex;"><span>Parsing documentation <span style="color:#204a87;font-weight:bold">for</span> redis-4.0.1
</span></span><span style="display:flex;"><span>Installing ri documentation <span style="color:#204a87;font-weight:bold">for</span> redis-4.0.1
</span></span><span style="display:flex;"><span>Done installing documentation <span style="color:#204a87;font-weight:bold">for</span> redis after <span style="color:#0000cf;font-weight:bold">2</span> seconds
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span> gem installed
</span></span></code></pre></div><p><strong>5、执行redis-trib.rb命令</strong></p>
<p>以上表示安装成功，可以执行<code>redis-trib.rb</code>命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> src 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#执行redis-trib.rb命令</span>
</span></span><span style="display:flex;"><span>./redis-trib.rb create --replicas <span style="color:#0000cf;font-weight:bold">1</span> 127.0.0.1:7000 127.0.0.1:7001 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005
</span></span></code></pre></div><p>参数<code>create</code>表示创建一个新的集群，<code>--replicas 1</code>表示为每个master创建一个slave。</p>
<p>如果创建成功会显示以下信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>OK<span style="color:#ce5c00;font-weight:bold">]</span> All <span style="color:#0000cf;font-weight:bold">16384</span> slots covered
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 src<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># ./redis-trib.rb create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 \</span>
</span></span><span style="display:flex;"><span>&gt; 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Creating cluster
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Performing <span style="color:#204a87">hash</span> slots allocation on <span style="color:#0000cf;font-weight:bold">6</span> nodes...
</span></span><span style="display:flex;"><span>Using <span style="color:#0000cf;font-weight:bold">3</span> masters:
</span></span><span style="display:flex;"><span>127.0.0.1:7000
</span></span><span style="display:flex;"><span>127.0.0.1:7001
</span></span><span style="display:flex;"><span>127.0.0.1:7002
</span></span><span style="display:flex;"><span>Adding replica 127.0.0.1:7004 to 127.0.0.1:7000
</span></span><span style="display:flex;"><span>Adding replica 127.0.0.1:7005 to 127.0.0.1:7001
</span></span><span style="display:flex;"><span>Adding replica 127.0.0.1:7003 to 127.0.0.1:7002
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Trying to optimize slaves allocation <span style="color:#204a87;font-weight:bold">for</span> anti-affinity
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>WARNING<span style="color:#ce5c00;font-weight:bold">]</span> Some slaves are in the same host as their master
</span></span><span style="display:flex;"><span>M: d5a834d075fd93eefab877c6ebb86efff680650f 127.0.0.1:7000
</span></span><span style="display:flex;"><span>   slots:0-5460 <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5461</span> slots<span style="color:#ce5c00;font-weight:bold">)</span> master
</span></span><span style="display:flex;"><span>M: 13d0c397604a0b2644244c37b666fce83f29faa8 127.0.0.1:7001
</span></span><span style="display:flex;"><span>   slots:5461-10922 <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5462</span> slots<span style="color:#ce5c00;font-weight:bold">)</span> master
</span></span><span style="display:flex;"><span>M: be2718476eba4e56f696e56b75e67df720b7fc24 127.0.0.1:7002
</span></span><span style="display:flex;"><span>   slots:10923-16383 <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5461</span> slots<span style="color:#ce5c00;font-weight:bold">)</span> master
</span></span><span style="display:flex;"><span>S: 3d02f59b34047486faecc023685379de7b38076c 127.0.0.1:7003
</span></span><span style="display:flex;"><span>   replicates 13d0c397604a0b2644244c37b666fce83f29faa8
</span></span><span style="display:flex;"><span>S: dedf672f0a75faf37407ac4edd5da23bc4651e25 127.0.0.1:7004
</span></span><span style="display:flex;"><span>   replicates be2718476eba4e56f696e56b75e67df720b7fc24
</span></span><span style="display:flex;"><span>S: 99c07119a449a703583019f7699e15afa0e41952 127.0.0.1:7005
</span></span><span style="display:flex;"><span>   replicates d5a834d075fd93eefab877c6ebb86efff680650f
</span></span><span style="display:flex;"><span>Can I <span style="color:#204a87">set</span> the above configuration? <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">type</span> <span style="color:#4e9a06">&#39;yes&#39;</span> to accept<span style="color:#ce5c00;font-weight:bold">)</span>: yes
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Nodes configuration updated
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Assign a different config epoch to each node
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
</span></span><span style="display:flex;"><span>Waiting <span style="color:#204a87;font-weight:bold">for</span> the cluster to join....
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Performing Cluster Check <span style="color:#ce5c00;font-weight:bold">(</span>using node 127.0.0.1:7000<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>M: d5a834d075fd93eefab877c6ebb86efff680650f 127.0.0.1:7000
</span></span><span style="display:flex;"><span>   slots:0-5460 <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5461</span> slots<span style="color:#ce5c00;font-weight:bold">)</span> master
</span></span><span style="display:flex;"><span>   <span style="color:#0000cf;font-weight:bold">1</span> additional replica<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>M: be2718476eba4e56f696e56b75e67df720b7fc24 127.0.0.1:7002
</span></span><span style="display:flex;"><span>   slots:10923-16383 <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5461</span> slots<span style="color:#ce5c00;font-weight:bold">)</span> master
</span></span><span style="display:flex;"><span>   <span style="color:#0000cf;font-weight:bold">1</span> additional replica<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>M: 13d0c397604a0b2644244c37b666fce83f29faa8 127.0.0.1:7001
</span></span><span style="display:flex;"><span>   slots:5461-10922 <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5462</span> slots<span style="color:#ce5c00;font-weight:bold">)</span> master
</span></span><span style="display:flex;"><span>   <span style="color:#0000cf;font-weight:bold">1</span> additional replica<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>S: 3d02f59b34047486faecc023685379de7b38076c 127.0.0.1:7003
</span></span><span style="display:flex;"><span>   slots: <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> slots<span style="color:#ce5c00;font-weight:bold">)</span> slave
</span></span><span style="display:flex;"><span>   replicates 13d0c397604a0b2644244c37b666fce83f29faa8
</span></span><span style="display:flex;"><span>S: 99c07119a449a703583019f7699e15afa0e41952 127.0.0.1:7005
</span></span><span style="display:flex;"><span>   slots: <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> slots<span style="color:#ce5c00;font-weight:bold">)</span> slave
</span></span><span style="display:flex;"><span>   replicates d5a834d075fd93eefab877c6ebb86efff680650f
</span></span><span style="display:flex;"><span>S: dedf672f0a75faf37407ac4edd5da23bc4651e25 127.0.0.1:7004
</span></span><span style="display:flex;"><span>   slots: <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> slots<span style="color:#ce5c00;font-weight:bold">)</span> slave
</span></span><span style="display:flex;"><span>   replicates be2718476eba4e56f696e56b75e67df720b7fc24
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>OK<span style="color:#ce5c00;font-weight:bold">]</span> All nodes agree about slots configuration.
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Check <span style="color:#204a87;font-weight:bold">for</span> open slots...
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Check slots coverage...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>OK<span style="color:#ce5c00;font-weight:bold">]</span> All <span style="color:#0000cf;font-weight:bold">16384</span> slots covered.
</span></span></code></pre></div><h3 id="2-1-3-部署结果验证">2.1.3 部署结果验证</h3>
<p><strong>1、客户端访问</strong></p>
<p>使用客户端<code>redis-cli </code>二进制访问某个实例，执行<code>set</code>和<code>get</code>的测试。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ redis-cli -c -p <span style="color:#0000cf;font-weight:bold">7000</span>
</span></span><span style="display:flex;"><span>redis 127.0.0.1:7000&gt; <span style="color:#204a87">set</span> foo bar
</span></span><span style="display:flex;"><span>-&gt; Redirected to slot <span style="color:#ce5c00;font-weight:bold">[</span>12182<span style="color:#ce5c00;font-weight:bold">]</span> located at 127.0.0.1:7002
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>redis 127.0.0.1:7002&gt; <span style="color:#204a87">set</span> hello world
</span></span><span style="display:flex;"><span>-&gt; Redirected to slot <span style="color:#ce5c00;font-weight:bold">[</span>866<span style="color:#ce5c00;font-weight:bold">]</span> located at 127.0.0.1:7000
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>redis 127.0.0.1:7000&gt; get foo
</span></span><span style="display:flex;"><span>-&gt; Redirected to slot <span style="color:#ce5c00;font-weight:bold">[</span>12182<span style="color:#ce5c00;font-weight:bold">]</span> located at 127.0.0.1:7002
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;bar&#34;</span>
</span></span><span style="display:flex;"><span>redis 127.0.0.1:7000&gt; get hello
</span></span><span style="display:flex;"><span>-&gt; Redirected to slot <span style="color:#ce5c00;font-weight:bold">[</span>866<span style="color:#ce5c00;font-weight:bold">]</span> located at 127.0.0.1:7000
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;world&#34;</span>
</span></span></code></pre></div><p><strong>2、查看集群状态</strong></p>
<p>使用<code>cluster info</code>命令查看集群状态。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:7000&gt; cluster info
</span></span><span style="display:flex;"><span>cluster_state:ok                       <span style="color:#8f5902;font-style:italic">#集群状态</span>
</span></span><span style="display:flex;"><span>cluster_slots_assigned:16384           <span style="color:#8f5902;font-style:italic">#被分配的槽位数</span>
</span></span><span style="display:flex;"><span>cluster_slots_ok:16384                 <span style="color:#8f5902;font-style:italic">#正确分配的槽位</span>
</span></span><span style="display:flex;"><span>cluster_slots_pfail:0
</span></span><span style="display:flex;"><span>cluster_slots_fail:0
</span></span><span style="display:flex;"><span>cluster_known_nodes:6                  <span style="color:#8f5902;font-style:italic">#当前节点</span>
</span></span><span style="display:flex;"><span>cluster_size:3
</span></span><span style="display:flex;"><span>cluster_current_epoch:6
</span></span><span style="display:flex;"><span>cluster_my_epoch:1
</span></span><span style="display:flex;"><span>cluster_stats_messages_ping_sent:48273
</span></span><span style="display:flex;"><span>cluster_stats_messages_pong_sent:49884
</span></span><span style="display:flex;"><span>cluster_stats_messages_sent:98157
</span></span><span style="display:flex;"><span>cluster_stats_messages_ping_received:49879
</span></span><span style="display:flex;"><span>cluster_stats_messages_pong_received:48273
</span></span><span style="display:flex;"><span>cluster_stats_messages_meet_received:5
</span></span><span style="display:flex;"><span>cluster_stats_messages_received:98157
</span></span></code></pre></div><p><strong>3、查看节点状态</strong></p>
<p>使用<code>cluster nodes</code>命令查看节点状态。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:7000&gt; cluster nodes
</span></span><span style="display:flex;"><span>be2718476eba4e56f696e56b75e67df720b7fc24 127.0.0.1:7002@17002 master - <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1517303607000</span> <span style="color:#0000cf;font-weight:bold">3</span> connected 10923-16383
</span></span><span style="display:flex;"><span>13d0c397604a0b2644244c37b666fce83f29faa8 127.0.0.1:7001@17001 master - <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1517303606000</span> <span style="color:#0000cf;font-weight:bold">2</span> connected 5461-10922
</span></span><span style="display:flex;"><span>3d02f59b34047486faecc023685379de7b38076c 127.0.0.1:7003@17003 slave 13d0c397604a0b2644244c37b666fce83f29faa8 <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1517303606030</span> <span style="color:#0000cf;font-weight:bold">4</span> connected
</span></span><span style="display:flex;"><span>d5a834d075fd93eefab877c6ebb86efff680650f 127.0.0.1:7000@17000 myself,master - <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1517303604000</span> <span style="color:#0000cf;font-weight:bold">1</span> connected 0-5460
</span></span><span style="display:flex;"><span>99c07119a449a703583019f7699e15afa0e41952 127.0.0.1:7005@17005 slave d5a834d075fd93eefab877c6ebb86efff680650f <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1517303607060</span> <span style="color:#0000cf;font-weight:bold">6</span> connected
</span></span><span style="display:flex;"><span>dedf672f0a75faf37407ac4edd5da23bc4651e25 127.0.0.1:7004@17004 slave be2718476eba4e56f696e56b75e67df720b7fc24 <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">1517303608082</span> <span style="color:#0000cf;font-weight:bold">5</span> connected
</span></span></code></pre></div><p>参考文章：</p>
<p><a href="https://redis.io/download">https://redis.io/download</a></p>
<p><a href="https://redis.io/topics/cluster-tutorial">https://redis.io/topics/cluster-tutorial</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5caba3265013584f81feac5ce6c89fad">9.3 - Redis哨兵模式部署</h1>
    
	<h1 id="1-部署redis集群">1. 部署Redis集群</h1>
<p>redis的安装及配置参考[redis部署]</p>
<blockquote>
<p>本文以创建一主二从的集群为例。</p>
</blockquote>
<h2 id="1-1-部署与配置">1.1 部署与配置</h2>
<p>先创建<code>sentinel</code>目录，在该目录下创建<code>8000</code>，<code>8001</code>，<code>8002</code>三个以端口号命名的目录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir sentinel
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> sentinel
</span></span><span style="display:flex;"><span>mkdir <span style="color:#0000cf;font-weight:bold">8000</span> <span style="color:#0000cf;font-weight:bold">8001</span> <span style="color:#0000cf;font-weight:bold">8002</span> 
</span></span></code></pre></div><p>在对应端口号目录中创建<code>redis.conf</code>的文件，配置文件中的端口号<code>port</code>参数改为对应目录的端口号。配置如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 守护进程模式</span>
</span></span><span style="display:flex;"><span>daemonize yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pid file</span>
</span></span><span style="display:flex;"><span>pidfile /var/run/redis.pid
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 监听端口</span>
</span></span><span style="display:flex;"><span>port <span style="color:#0000cf;font-weight:bold">8000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># TCP接收队列长度，受/proc/sys/net/core/somaxconn和tcp_max_syn_backlog这两个内核参数的影响</span>
</span></span><span style="display:flex;"><span>tcp-backlog <span style="color:#0000cf;font-weight:bold">511</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 一个客户端空闲多少秒后关闭连接(0代表禁用，永不关闭)</span>
</span></span><span style="display:flex;"><span>timeout <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果非零，则设置SO_KEEPALIVE选项来向空闲连接的客户端发送ACK</span>
</span></span><span style="display:flex;"><span>tcp-keepalive <span style="color:#0000cf;font-weight:bold">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定服务器调试等级</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可能值：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># debug （大量信息，对开发/测试有用）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># verbose （很多精简的有用信息，但是不像debug等级那么多）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># notice （适量的信息，基本上是你生产环境中需要的）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># warning （只有很重要/严重的信息会记录下来）</span>
</span></span><span style="display:flex;"><span>loglevel notice
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指明日志文件名</span>
</span></span><span style="display:flex;"><span>logfile <span style="color:#4e9a06">&#34;./redis8000.log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置数据库个数</span>
</span></span><span style="display:flex;"><span>databases <span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 会在指定秒数和数据变化次数之后把数据库写到磁盘上</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 900秒（15分钟）之后，且至少1次变更</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 300秒（5分钟）之后，且至少10次变更</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 60秒之后，且至少10000次变更</span>
</span></span><span style="display:flex;"><span>save <span style="color:#0000cf;font-weight:bold">900</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>save <span style="color:#0000cf;font-weight:bold">300</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>save <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#0000cf;font-weight:bold">10000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认如果开启RDB快照(至少一条save指令)并且最新的后台保存失败，Redis将会停止接受写操作</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这将使用户知道数据没有正确的持久化到硬盘，否则可能没人注意到并且造成一些灾难</span>
</span></span><span style="display:flex;"><span>stop-writes-on-bgsave-error yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当导出到 .rdb 数据库时是否用LZF压缩字符串对象</span>
</span></span><span style="display:flex;"><span>rdbcompression yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 版本5的RDB有一个CRC64算法的校验和放在了文件的最后。这将使文件格式更加可靠。</span>
</span></span><span style="display:flex;"><span>rdbchecksum yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 持久化数据库的文件名</span>
</span></span><span style="display:flex;"><span>dbfilename dump.rdb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 工作目录</span>
</span></span><span style="display:flex;"><span>dir ./
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当master服务设置了密码保护时，slave服务连接master的密码</span>
</span></span><span style="display:flex;"><span>masterauth 0234kz9*l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当一个slave失去和master的连接，或者同步正在进行中，slave的行为可以有两种：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1) 如果 slave-serve-stale-data 设置为 &#34;yes&#34; (默认值)，slave会继续响应客户端请求，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可能是正常数据，或者是过时了的数据，也可能是还没获得值的空数据。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2) 如果 slave-serve-stale-data 设置为 &#34;no&#34;，slave会回复&#34;正在从master同步</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># （SYNC with master in progress）&#34;来处理各种请求，除了 INFO 和 SLAVEOF 命令。</span>
</span></span><span style="display:flex;"><span>slave-serve-stale-data yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 你可以配置salve实例是否接受写操作。可写的slave实例可能对存储临时数据比较有用(因为写入salve</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 的数据在同master同步之后将很容易被删除</span>
</span></span><span style="display:flex;"><span>slave-read-only yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 是否在slave套接字发送SYNC之后禁用 TCP_NODELAY？</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果你选择“yes”Redis将使用更少的TCP包和带宽来向slaves发送数据。但是这将使数据传输到slave</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 上有延迟，Linux内核的默认配置会达到40毫秒</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果你选择了 &#34;no&#34; 数据传输到salve的延迟将会减少但要使用更多的带宽</span>
</span></span><span style="display:flex;"><span>repl-disable-tcp-nodelay no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave的优先级是一个整数展示在Redis的Info输出中。如果master不再正常工作了，哨兵将用它来</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 选择一个slave提升=升为master。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 优先级数字小的salve会优先考虑提升为master，所以例如有三个slave优先级分别为10，100，25，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 哨兵将挑选优先级最小数字为10的slave。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 0作为一个特殊的优先级，标识这个slave不能作为master，所以一个优先级为0的slave永远不会被</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 哨兵挑选提升为master</span>
</span></span><span style="display:flex;"><span>slave-priority <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 密码验证</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 警告：因为Redis太快了，所以外面的人可以尝试每秒150k的密码来试图破解密码。这意味着你需要</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 一个高强度的密码，否则破解太容易了</span>
</span></span><span style="display:flex;"><span>requirepass 0234kz9*l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># redis实例最大占用内存，不要用比设置的上限更多的内存。一旦内存使用达到上限，Redis会根据选定的回收策略（参见：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># maxmemmory-policy）删除key</span>
</span></span><span style="display:flex;"><span>maxmemory 3gb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 最大内存策略：如果达到内存限制了，Redis如何选择删除key。你可以在下面五个行为里选：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># volatile-lru -&gt; 根据LRU算法删除带有过期时间的key。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allkeys-lru -&gt; 根据LRU算法删除任何key。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># volatile-random -&gt; 根据过期设置来随机删除key, 具备过期时间的key。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allkeys-&gt;random -&gt; 无差别随机删, 任何一个key。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># volatile-ttl -&gt; 根据最近过期时间来删除（辅以TTL）, 这是对于有过期时间的key</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># noeviction -&gt; 谁也不删，直接在写操作时返回错误。</span>
</span></span><span style="display:flex;"><span>maxmemory-policy volatile-lru
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认情况下，Redis是异步的把数据导出到磁盘上。这种模式在很多应用里已经足够好，但Redis进程</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 出问题或断电时可能造成一段时间的写操作丢失(这取决于配置的save指令)。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># AOF是一种提供了更可靠的替代持久化模式，例如使用默认的数据写入文件策略（参见后面的配置）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在遇到像服务器断电或单写情况下Redis自身进程出问题但操作系统仍正常运行等突发事件时，Redis</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 能只丢失1秒的写操作。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># AOF和RDB持久化能同时启动并且不会有问题。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果AOF开启，那么在启动时Redis将加载AOF文件，它更能保证数据的可靠性。</span>
</span></span><span style="display:flex;"><span>appendonly no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># aof文件名</span>
</span></span><span style="display:flex;"><span>appendfilename <span style="color:#4e9a06">&#34;appendonly.aof&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># fsync() 系统调用告诉操作系统把数据写到磁盘上，而不是等更多的数据进入输出缓冲区。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 有些操作系统会真的把数据马上刷到磁盘上；有些则会尽快去尝试这么做。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis支持三种不同的模式：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># no：不要立刻刷，只有在操作系统需要刷的时候再刷。比较快。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># always：每次写操作都立刻写入到aof文件。慢，但是最安全。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># everysec：每秒写一次。折中方案。</span>
</span></span><span style="display:flex;"><span>appendfsync everysec
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果AOF的同步策略设置成 &#34;always&#34; 或者 &#34;everysec&#34;，并且后台的存储进程（后台存储或写入AOF</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 日志）会产生很多磁盘I/O开销。某些Linux的配置下会使Redis因为 fsync()系统调用而阻塞很久。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意，目前对这个情况还没有完美修正，甚至不同线程的 fsync() 会阻塞我们同步的write(2)调用。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为了缓解这个问题，可以用下面这个选项。它可以在 BGSAVE 或 BGREWRITEAOF 处理时阻止主进程进行fsync()。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这就意味着如果有子进程在进行保存操作，那么Redis就处于&#34;不可同步&#34;的状态。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这实际上是说，在最差的情况下可能会丢掉30秒钟的日志数据。（默认Linux设定）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果你有延时问题把这个设置成&#34;yes&#34;，否则就保持&#34;no&#34;，这是保存持久数据的最安全的方式。</span>
</span></span><span style="display:flex;"><span>no-appendfsync-on-rewrite yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 自动重写AOF文件</span>
</span></span><span style="display:flex;"><span>auto-aof-rewrite-percentage <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>auto-aof-rewrite-min-size 64mb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># AOF文件可能在尾部是不完整的（这跟system关闭有问题，尤其是mount ext4文件系统时</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 没有加上data=ordered选项。只会发生在os死时，redis自己死不会不完整）。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 那redis重启时load进内存的时候就有问题了。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 发生的时候，可以选择redis启动报错，并且通知用户和写日志，或者load尽量多正常的数据。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果aof-load-truncated是yes，会自动发布一个log给客户端然后load（默认）。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果是no，用户必须手动redis-check-aof修复AOF文件才可以。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意，如果在读取的过程中，发现这个aof是损坏的，服务器也是会退出的，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这个选项仅仅用于当服务器尝试读取更多的数据但又找不到相应的数据时。</span>
</span></span><span style="display:flex;"><span>aof-load-truncated yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Lua 脚本的最大执行时间，毫秒为单位</span>
</span></span><span style="display:flex;"><span>lua-time-limit <span style="color:#0000cf;font-weight:bold">5000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis慢查询日志可以记录超过指定时间的查询</span>
</span></span><span style="display:flex;"><span>slowlog-log-slower-than <span style="color:#0000cf;font-weight:bold">10000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这个长度没有限制。只是要主要会消耗内存。你可以通过 SLOWLOG RESET 来回收内存。</span>
</span></span><span style="display:flex;"><span>slowlog-max-len <span style="color:#0000cf;font-weight:bold">128</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># redis延时监控系统在运行时会采样一些操作，以便收集可能导致延时的数据根源。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过 LATENCY命令 可以打印一些图样和获取一些报告，方便监控</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这个系统仅仅记录那个执行时间大于或等于预定时间（毫秒）的操作,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这个预定时间是通过latency-monitor-threshold配置来指定的，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当设置为0时，这个监控系统处于停止状态</span>
</span></span><span style="display:flex;"><span>latency-monitor-threshold <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis能通知 Pub/Sub 客户端关于键空间发生的事件，默认关闭</span>
</span></span><span style="display:flex;"><span>notify-keyspace-events <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当hash只有少量的entry时，并且最大的entry所占空间没有超过指定的限制时，会用一种节省内存的</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 数据结构来编码。可以通过下面的指令来设定限制</span>
</span></span><span style="display:flex;"><span>hash-max-ziplist-entries <span style="color:#0000cf;font-weight:bold">512</span>
</span></span><span style="display:flex;"><span>hash-max-ziplist-value <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 与hash似，数据元素较少的list，可以用另一种方式来编码从而节省大量空间。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这种特殊的方式只有在符合下面限制时才可以用</span>
</span></span><span style="display:flex;"><span>list-max-ziplist-entries <span style="color:#0000cf;font-weight:bold">512</span>
</span></span><span style="display:flex;"><span>list-max-ziplist-value <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># set有一种特殊编码的情况：当set数据全是十进制64位有符号整型数字构成的字符串时。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下面这个配置项就是用来设置set使用这种编码来节省内存的最大长度。</span>
</span></span><span style="display:flex;"><span>set-max-intset-entries <span style="color:#0000cf;font-weight:bold">512</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 与hash和list相似，有序集合也可以用一种特别的编码方式来节省大量空间。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这种编码只适合长度和元素都小于下面限制的有序集合</span>
</span></span><span style="display:flex;"><span>zset-max-ziplist-entries <span style="color:#0000cf;font-weight:bold">128</span>
</span></span><span style="display:flex;"><span>zset-max-ziplist-value <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># HyperLogLog稀疏结构表示字节的限制。该限制包括</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 16个字节的头。当HyperLogLog使用稀疏结构表示</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这些限制，它会被转换成密度表示。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 值大于16000是完全没用的，因为在该点</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 密集的表示是更多的内存效率。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 建议值是3000左右，以便具有的内存好处, 减少内存的消耗</span>
</span></span><span style="display:flex;"><span>hll-sparse-max-bytes <span style="color:#0000cf;font-weight:bold">3000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启用哈希刷新，每100个CPU毫秒会拿出1个毫秒来刷新Redis的主哈希表（顶级键值映射表）</span>
</span></span><span style="display:flex;"><span>activerehashing yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 客户端的输出缓冲区的限制，可用于强制断开那些因为某种原因从服务器读取数据的速度不够快的客户端</span>
</span></span><span style="display:flex;"><span>client-output-buffer-limit normal <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>client-output-buffer-limit slave 256mb 64mb <span style="color:#0000cf;font-weight:bold">60</span>
</span></span><span style="display:flex;"><span>client-output-buffer-limit pubsub 32mb 8mb <span style="color:#0000cf;font-weight:bold">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认情况下，“hz”的被设定为10。提高该值将在Redis空闲时使用更多的CPU时，但同时当有多个key</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 同时到期会使Redis的反应更灵敏，以及超时可以更精确地处理</span>
</span></span><span style="display:flex;"><span>hz <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当一个子进程重写AOF文件时，如果启用下面的选项，则文件每生成32M数据会被同步</span>
</span></span><span style="display:flex;"><span>aof-rewrite-incremental-fsync yes
</span></span></code></pre></div><h2 id="1-2-配置主从关系">1.2 配置主从关系</h2>
<p><strong>1、启动实例</strong></p>
<p>三个Redis实例配置相同，分别启动三个Redis实例。建议将<code>redis-server</code>、<code>redis-cli</code>、<code>redis-sentinel</code>的二进制复制到<code>/usr/local/bin</code>的目录下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> <span style="color:#0000cf;font-weight:bold">8000</span>
</span></span><span style="display:flex;"><span>redis-server redis.conf
</span></span></code></pre></div><p><strong>2、配置主从关系</strong></p>
<p>例如，将8000端口实例设为主，8001和8002端口的实例设为从。</p>
<p>则分别登录8001和8002的实例，执行<code>slaveof &lt;MASTER_IP&gt; &lt;MASTER_PORT&gt;</code>命令。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 8000<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># redis-cli -c -p 8001 -a 0234kz9*l</span>
</span></span><span style="display:flex;"><span>127.0.0.1:8001&gt; slaveof 127.0.0.1 <span style="color:#0000cf;font-weight:bold">8000</span>
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><p><strong>3、检查集群状态</strong></p>
<p>登录master和slave实例，执行<code>info replication</code>查看集群状态。</p>
<p>Master</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 8000<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># redis-cli -c -p 8000 -a 0234kz9*l</span>
</span></span><span style="display:flex;"><span>127.0.0.1:8000&gt; info replication
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Replication</span>
</span></span><span style="display:flex;"><span>role:master
</span></span><span style="display:flex;"><span>connected_slaves:2
</span></span><span style="display:flex;"><span>slave0:ip<span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1,port<span style="color:#ce5c00;font-weight:bold">=</span>8001,state<span style="color:#ce5c00;font-weight:bold">=</span>online,offset<span style="color:#ce5c00;font-weight:bold">=</span>2853,lag<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>slave1:ip<span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1,port<span style="color:#ce5c00;font-weight:bold">=</span>8002,state<span style="color:#ce5c00;font-weight:bold">=</span>online,offset<span style="color:#ce5c00;font-weight:bold">=</span>2853,lag<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>master_replid:4f8331d5f180a4669241ab0dd97e43508abd6d8f
</span></span><span style="display:flex;"><span>master_replid2:0000000000000000000000000000000000000000
</span></span><span style="display:flex;"><span>master_repl_offset:2853
</span></span><span style="display:flex;"><span>second_repl_offset:-1
</span></span><span style="display:flex;"><span>repl_backlog_active:1
</span></span><span style="display:flex;"><span>repl_backlog_size:1048576
</span></span><span style="display:flex;"><span>repl_backlog_first_byte_offset:1
</span></span><span style="display:flex;"><span>repl_backlog_histlen:2853
</span></span></code></pre></div><p>Slave</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 8000<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># redis-cli -c -p 8001 -a 0234kz9*l</span>
</span></span><span style="display:flex;"><span>127.0.0.1:8001&gt; info replication
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Replication</span>
</span></span><span style="display:flex;"><span>role:slave
</span></span><span style="display:flex;"><span>master_host:127.0.0.1
</span></span><span style="display:flex;"><span>master_port:8000
</span></span><span style="display:flex;"><span>master_link_status:up
</span></span><span style="display:flex;"><span>master_last_io_seconds_ago:3
</span></span><span style="display:flex;"><span>master_sync_in_progress:0
</span></span><span style="display:flex;"><span>slave_repl_offset:2909
</span></span><span style="display:flex;"><span>slave_priority:100
</span></span><span style="display:flex;"><span>slave_read_only:1
</span></span><span style="display:flex;"><span>connected_slaves:0
</span></span><span style="display:flex;"><span>master_replid:4f8331d5f180a4669241ab0dd97e43508abd6d8f
</span></span><span style="display:flex;"><span>master_replid2:0000000000000000000000000000000000000000
</span></span><span style="display:flex;"><span>master_repl_offset:2909
</span></span><span style="display:flex;"><span>second_repl_offset:-1
</span></span><span style="display:flex;"><span>repl_backlog_active:1
</span></span><span style="display:flex;"><span>repl_backlog_size:1048576
</span></span><span style="display:flex;"><span>repl_backlog_first_byte_offset:1
</span></span><span style="display:flex;"><span>repl_backlog_histlen:2909
</span></span></code></pre></div><p>也可以往master写数据，从slave读取数据来验证。</p>
<h1 id="2-部署sentinel集群">2. 部署sentinel集群</h1>
<h2 id="2-1-部署与配置">2.1 部署与配置</h2>
<p>在之前创建的<code>sentinel</code>目录中场景sentinel端口号命名的目录<code>28000</code>，<code>28001</code>，<code>28002</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> sentinel
</span></span><span style="display:flex;"><span>mkdir <span style="color:#0000cf;font-weight:bold">28000</span> <span style="color:#0000cf;font-weight:bold">28001</span> <span style="color:#0000cf;font-weight:bold">28002</span> 
</span></span></code></pre></div><p>在对应端口号目录中创建<code>redis.conf</code>的文件，配置文件中的端口号<code>port</code>参数改为对应目录的端口号。配置如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>port <span style="color:#0000cf;font-weight:bold">28000</span>
</span></span><span style="display:flex;"><span>sentinel monitor mymaster 127.0.0.1 <span style="color:#0000cf;font-weight:bold">8000</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>sentinel down-after-milliseconds mymaster <span style="color:#0000cf;font-weight:bold">60000</span>
</span></span><span style="display:flex;"><span>sentinel failover-timeout mymaster <span style="color:#0000cf;font-weight:bold">180000</span>
</span></span><span style="display:flex;"><span>sentinel parallel-syncs mymaster <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><h2 id="2-2-启动sentinel实例">2.2 启动sentinel实例</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&amp; 表示后台运行的方式</span>
</span></span><span style="display:flex;"><span>redis-sentinel sentinel.conf <span style="color:#000;font-weight:bold">&amp;</span>
</span></span></code></pre></div><h2 id="2-3-查看状态">2.3 查看状态</h2>
<p>使用<code>sentinel masters</code>命令查看监控的master节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@kube-node-1 28000<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># redis-cli -c -p 28000 -a 0234kz9*l</span>
</span></span><span style="display:flex;"><span>127.0.0.1:28000&gt;
</span></span><span style="display:flex;"><span>127.0.0.1:28000&gt; ping
</span></span><span style="display:flex;"><span>PONG
</span></span><span style="display:flex;"><span>127.0.0.1:28000&gt;
</span></span><span style="display:flex;"><span>127.0.0.1:28000&gt; sentinel masters
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span>  1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;name&#34;</span>
</span></span><span style="display:flex;"><span>    1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;mymaster&#34;</span>
</span></span><span style="display:flex;"><span>    2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;ip&#34;</span>
</span></span><span style="display:flex;"><span>    3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>    4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;port&#34;</span>
</span></span><span style="display:flex;"><span>    5<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;8000&#34;</span>
</span></span><span style="display:flex;"><span>    6<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;runid&#34;</span>
</span></span><span style="display:flex;"><span>    7<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    8<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;flags&#34;</span>
</span></span><span style="display:flex;"><span>   1<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#4e9a06">&#34;s_down,master,disconnected&#34;</span>
</span></span><span style="display:flex;"><span>   2<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#4e9a06">&#34;link-pending-commands&#34;</span>
</span></span><span style="display:flex;"><span>   3<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#4e9a06">&#34;0&#34;</span>
</span></span><span style="display:flex;"><span>   4<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#4e9a06">&#34;link-refcount&#34;</span>
</span></span><span style="display:flex;"><span>   5<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#4e9a06">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>   6<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#4e9a06">&#34;last-ping-sent&#34;</span>
</span></span><span style="display:flex;"><span>   7<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#4e9a06">&#34;187539&#34;</span>
</span></span><span style="display:flex;"><span>   8<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#4e9a06">&#34;last-ok-ping-reply&#34;</span>
</span></span><span style="display:flex;"><span>   9<span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#4e9a06">&#34;187539&#34;</span>
</span></span><span style="display:flex;"><span>   10<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;last-ping-reply&#34;</span>
</span></span><span style="display:flex;"><span>   11<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;3943&#34;</span>
</span></span><span style="display:flex;"><span>   12<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;s-down-time&#34;</span>
</span></span><span style="display:flex;"><span>   13<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;127491&#34;</span>
</span></span><span style="display:flex;"><span>   14<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;down-after-milliseconds&#34;</span>
</span></span><span style="display:flex;"><span>   15<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;60000&#34;</span>
</span></span><span style="display:flex;"><span>   16<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;info-refresh&#34;</span>
</span></span><span style="display:flex;"><span>   17<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;1517346914642&#34;</span>
</span></span><span style="display:flex;"><span>   18<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;role-reported&#34;</span>
</span></span><span style="display:flex;"><span>   19<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;master&#34;</span>
</span></span><span style="display:flex;"><span>   20<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;role-reported-time&#34;</span>
</span></span><span style="display:flex;"><span>   21<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;187539&#34;</span>
</span></span><span style="display:flex;"><span>   22<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;config-epoch&#34;</span>
</span></span><span style="display:flex;"><span>   23<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;0&#34;</span>
</span></span><span style="display:flex;"><span>   24<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;num-slaves&#34;</span>
</span></span><span style="display:flex;"><span>   25<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;0&#34;</span>
</span></span><span style="display:flex;"><span>   26<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;num-other-sentinels&#34;</span>
</span></span><span style="display:flex;"><span>   27<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;0&#34;</span>
</span></span><span style="display:flex;"><span>   28<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;quorum&#34;</span>
</span></span><span style="display:flex;"><span>   29<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;2&#34;</span>
</span></span><span style="display:flex;"><span>   30<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;failover-timeout&#34;</span>
</span></span><span style="display:flex;"><span>   31<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;180000&#34;</span>
</span></span><span style="display:flex;"><span>   32<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;parallel-syncs&#34;</span>
</span></span><span style="display:flex;"><span>   33<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;1&#34;</span>
</span></span></code></pre></div><p>参考文章：</p>
<p><a href="https://redis.io/topics/sentinel">https://redis.io/topics/sentinel</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-159b390d9892e8b1b4d4b746b95330a8">9.4 - Redis配置详解（中文版）</h1>
    
	<blockquote>
<p>以下为<code>redis.conf</code>的文件的中文描述，整理于网络</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis 配置文件示例</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意单位: 当需要配置内存大小时, 可能需要指定像1k,5GB,4M等常见格式</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1k =&gt; 1000 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1kb =&gt; 1024 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1m =&gt; 1000000 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1mb =&gt; 1024*1024 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1g =&gt; 1000000000 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1gb =&gt; 1024*1024*1024 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 单位是对大小写不敏感的 1GB 1Gb 1gB 是相同的。</span>
</span></span></code></pre></div><h1 id="includes">INCLUDES</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################## INCLUDES ###################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以在这里包含一个或多个其他的配置文件。如果你有一个适用于所有Redis服务器的标准配置模板</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 但也需要一些每个服务器自定义的设置，这个功能将很有用。被包含的配置文件也可以包含其他配置文件，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 所以需要谨慎的使用这个功能。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意“inclue”选项不能被admin或Redis哨兵的&#34;CONFIG REWRITE&#34;命令重写。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 因为Redis总是使用最后解析的配置行最为配置指令的值, 你最好在这个文件的开头配置includes来</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 避免它在运行时重写配置。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果相反你想用includes的配置覆盖原来的配置，你最好在该文件的最后使用include</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># include /path/to/local.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># include /path/to/other.conf</span>
</span></span></code></pre></div><h1 id="general">GENERAL</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################ GENERAL  #####################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认Rdis不会作为守护进程运行。如果需要的话配置成&#39;yes&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意配置成守护进程后Redis会将进程号写入文件/var/run/redis.pid</span>
</span></span><span style="display:flex;"><span>daemonize no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当以守护进程方式运行时，默认Redis会把进程ID写到 /var/run/redis.pid。你可以在这里修改路径。</span>
</span></span><span style="display:flex;"><span>pidfile /var/run/redis.pid
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 接受连接的特定端口，默认是6379</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果端口设置为0，Redis就不会监听TCP套接字。</span>
</span></span><span style="display:flex;"><span>port <span style="color:#0000cf;font-weight:bold">6379</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># TCP listen() backlog.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在高并发环境下你需要一个高backlog值来避免慢客户端连接问题。注意Linux内核默默地将这个值减小</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 到/proc/sys/net/core/somaxconn的值，所以需要确认增大somaxconn和tcp_max_syn_backlog</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 两个值来达到想要的效果。</span>
</span></span><span style="display:flex;"><span>tcp-backlog <span style="color:#0000cf;font-weight:bold">511</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认Redis监听服务器上所有可用网络接口的连接。可以用&#34;bind&#34;配置指令跟一个或多个ip地址来实现</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 监听一个或多个网络接口</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 示例:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># bind 192.168.1.100 10.0.0.1</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># bind 127.0.0.1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定用来监听Unix套套接字的路径。没有默认值， 所以在没有指定的情况下Redis不会监听Unix套接字</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># unixsocket /tmp/redis.sock</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># unixsocketperm 755</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 一个客户端空闲多少秒后关闭连接。(0代表禁用，永不关闭)</span>
</span></span><span style="display:flex;"><span>timeout <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># TCP keepalive.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果非零，则设置SO_KEEPALIVE选项来向空闲连接的客户端发送ACK，由于以下两个原因这是很有用的：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1）能够检测无响应的对端</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2）让该连接中间的网络设备知道这个连接还存活</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在Linux上，这个指定的值(单位：秒)就是发送ACK的时间间隔。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意：要关闭这个连接需要两倍的这个时间值。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在其他内核上这个时间间隔由内核配置决定</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这个选项的一个合理值是60秒</span>
</span></span><span style="display:flex;"><span>tcp-keepalive <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定服务器调试等级</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可能值：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># debug （大量信息，对开发/测试有用）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># verbose （很多精简的有用信息，但是不像debug等级那么多）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># notice （适量的信息，基本上是你生产环境中需要的）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># warning （只有很重要/严重的信息会记录下来）</span>
</span></span><span style="display:flex;"><span>loglevel notice
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指明日志文件名。也可以使用&#34;stdout&#34;来强制让Redis把日志信息写到标准输出上。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意:如果Redis以守护进程方式运行，而设置日志显示到标准输出的话，日志会发送到/dev/null</span>
</span></span><span style="display:flex;"><span>logfile <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 要使用系统日志记录器，只要设置 &#34;syslog-enabled&#34; 为 &#34;yes&#34; 就可以了。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 然后根据需要设置其他一些syslog参数就可以了。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># syslog-enabled no</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指明syslog身份</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># syslog-ident redis</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指明syslog的设备。必须是user或LOCAL0 ~ LOCAL7之一。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># syslog-facility local0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置数据库个数。默认数据库是 DB 0，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以通过select &lt;dbid&gt;  (0 &lt;= dbid &lt;= &#39;databases&#39; - 1 ）来为每个连接使用不同的数据库。</span>
</span></span><span style="display:flex;"><span>databases <span style="color:#0000cf;font-weight:bold">16</span>
</span></span></code></pre></div><h1 id="snapshotting">SNAPSHOTTING</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################ SNAPSHOTTING  ################################</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 把数据库存到磁盘上:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   save &lt;seconds&gt; &lt;changes&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   会在指定秒数和数据变化次数之后把数据库写到磁盘上。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   下面的例子将会进行把数据写入磁盘的操作:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   900秒（15分钟）之后，且至少1次变更</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   300秒（5分钟）之后，且至少10次变更</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   60秒之后，且至少10000次变更</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   注意：你要想不写磁盘的话就把所有 &#34;save&#34; 设置注释掉就行了。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   通过添加一条带空字符串参数的save指令也能移除之前所有配置的save指令</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   像下面的例子：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   save &#34;&#34; </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>save <span style="color:#0000cf;font-weight:bold">900</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>save <span style="color:#0000cf;font-weight:bold">300</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>save <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#0000cf;font-weight:bold">10000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认如果开启RDB快照(至少一条save指令)并且最新的后台保存失败，Redis将会停止接受写操作</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这将使用户知道数据没有正确的持久化到硬盘，否则可能没人注意到并且造成一些灾难。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果后台保存进程能重新开始工作，Redis将自动允许写操作</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 然而如果你已经部署了适当的Redis服务器和持久化的监控，你可能想关掉这个功能以便于即使是</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 硬盘，权限等出问题了Redis也能够像平时一样正常工作，</span>
</span></span><span style="display:flex;"><span>stop-writes-on-bgsave-error yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当导出到 .rdb 数据库时是否用LZF压缩字符串对象？</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认设置为 &#34;yes&#34;，因为几乎在任何情况下它都是不错的。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果你想节省CPU的话你可以把这个设置为 &#34;no&#34;，但是如果你有可压缩的key和value的话，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 那数据文件就会更大了。</span>
</span></span><span style="display:flex;"><span>rdbcompression yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 因为版本5的RDB有一个CRC64算法的校验和放在了文件的最后。这将使文件格式更加可靠但在</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 生产和加载RDB文件时，这有一个性能消耗(大约10%)，所以你可以关掉它来获取最好的性能。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 生成的关闭校验的RDB文件有一个0的校验和，它将告诉加载代码跳过检查</span>
</span></span><span style="display:flex;"><span>rdbchecksum yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 持久化数据库的文件名</span>
</span></span><span style="display:flex;"><span>dbfilename dump.rdb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 工作目录</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 数据库会写到这个目录下，文件名就是上面的 &#34;dbfilename&#34; 的值。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 累加文件也放这里。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意你这里指定的必须是目录，不是文件名。</span>
</span></span><span style="display:flex;"><span>dir ./
</span></span></code></pre></div><h1 id="replication">REPLICATION</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################# REPLICATION #################################</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 主从同步。通过 slaveof 指令来实现Redis实例的备份。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意，这里是本地从远端复制数据。也就是说，本地可以有不同的数据库文件、绑定不同的IP、监听</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 不同的端口。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slaveof &lt;masterip&gt; &lt;masterport&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果master设置了密码保护（通过 &#34;requirepass&#34; 选项来配置），那么slave在开始同步之前必须</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 进行身份验证，否则它的同步请求会被拒绝。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># masterauth &lt;master-password&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当一个slave失去和master的连接，或者同步正在进行中，slave的行为有两种可能：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1) 如果 slave-serve-stale-data 设置为 &#34;yes&#34; (默认值)，slave会继续响应客户端请求，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    可能是正常数据，也可能是还没获得值的空数据。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2) 如果 slave-serve-stale-data 设置为 &#34;no&#34;，slave会回复&#34;正在从master同步</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   （SYNC with master in progress）&#34;来处理各种请求，除了 INFO 和 SLAVEOF 命令。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span>slave-serve-stale-data yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 你可以配置salve实例是否接受写操作。可写的slave实例可能对存储临时数据比较有用(因为写入salve</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 的数据在同master同步之后将很容被删除)，但是如果客户端由于配置错误在写入时也可能产生一些问题。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 从Redis2.6默认所有的slave为只读</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意:只读的slave不是为了暴露给互联网上不可信的客户端而设计的。它只是一个防止实例误用的保护层。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 一个只读的slave支持所有的管理命令比如config,debug等。为了限制你可以用&#39;rename-command&#39;来</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 隐藏所有的管理和危险命令来增强只读slave的安全性</span>
</span></span><span style="display:flex;"><span>slave-read-only yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave根据指定的时间间隔向master发送ping请求。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 时间间隔可以通过 repl_ping_slave_period 来设置。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认10秒。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repl-ping-slave-period 10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 以下选项设置同步的超时时间</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1）slave在与master SYNC期间有大量数据传输，造成超时</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2）在slave角度，master超时，包括数据、ping等</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 3）在master角度，slave超时，当master发送REPLCONF ACK pings</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 确保这个值大于指定的repl-ping-slave-period，否则在主从间流量不高时每次都会检测到超时</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repl-timeout 60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 是否在slave套接字发送SYNC之后禁用 TCP_NODELAY ？</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果你选择“yes”Redis将使用更少的TCP包和带宽来向slaves发送数据。但是这将使数据传输到slave</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 上有延迟，Linux内核的默认配置会达到40毫秒</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果你选择了 &#34;no&#34; 数据传输到salve的延迟将会减少但要使用更多的带宽</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认我们会为低延迟做优化，但高流量情况或主从之间的跳数过多时，把这个选项设置为“yes”</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 是个不错的选择。</span>
</span></span><span style="display:flex;"><span>repl-disable-tcp-nodelay no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置数据备份的backlog大小。backlog是一个slave在一段时间内断开连接时记录salve数据的缓冲，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 所以一个slave在重新连接时，不必要全量的同步，而是一个增量同步就足够了，将在断开连接的这段</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 时间内slave丢失的部分数据传送给它。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 同步的backlog越大，slave能够进行增量同步并且允许断开连接的时间就越长。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># backlog只分配一次并且至少需要一个slave连接</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repl-backlog-size 1mb</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当master在一段时间内不再与任何slave连接，backlog将会释放。以下选项配置了从最后一个</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave断开开始计时多少秒后，backlog缓冲将会释放。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 0表示永不释放backlog</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repl-backlog-ttl 3600</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave的优先级是一个整数展示在Redis的Info输出中。如果master不再正常工作了，哨兵将用它来</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 选择一个slave提升=升为master。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 优先级数字小的salve会优先考虑提升为master，所以例如有三个slave优先级分别为10，100，25，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 哨兵将挑选优先级最小数字为10的slave。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 0作为一个特殊的优先级，标识这个slave不能作为master，所以一个优先级为0的slave永远不会被</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 哨兵挑选提升为master</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认优先级为100</span>
</span></span><span style="display:flex;"><span>slave-priority <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果master少于N个延时小于等于M秒的已连接slave，就可以停止接收写操作。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># N个slave需要是“oneline”状态</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 延时是以秒为单位，并且必须小于等于指定值，是从最后一个从slave接收到的ping（通常每秒发送）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 开始计数。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This option does not GUARANTEES that N replicas will accept the write, but</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># will limit the window of exposure for lost writes in case not enough slaves</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># are available, to the specified number of seconds.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如至少需要3个延时小于等于10秒的slave用下面的指令：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># min-slaves-to-write 3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># min-slaves-max-lag 10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 两者之一设置为0将禁用这个功能。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认 min-slaves-to-write 值是0（该功能禁用）并且 min-slaves-max-lag 值是10。</span>
</span></span></code></pre></div><h1 id="security">SECURITY</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################## SECURITY ###################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 要求客户端在处理任何命令时都要验证身份和密码。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这个功能在有你不信任的其它客户端能够访问redis服务器的环境里非常有用。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为了向后兼容的话这段应该注释掉。而且大多数人不需要身份验证(例如:它们运行在自己的服务器上)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 警告：因为Redis太快了，所以外面的人可以尝试每秒150k的密码来试图破解密码。这意味着你需要</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 一个高强度的密码，否则破解太容易了。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># requirepass foobared</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 命令重命名</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在共享环境下，可以为危险命令改变名字。比如，你可以为 CONFIG 改个其他不太容易猜到的名字，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这样内部的工具仍然可以使用，而普通的客户端将不行。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 也可以通过改名为空字符串来完全禁用一个命令</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># rename-command CONFIG &#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 请注意：改变命令名字被记录到AOF文件或被传送到从服务器可能产生问题。</span>
</span></span></code></pre></div><h1 id="limits">LIMITS</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################### LIMITS ####################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置最多同时连接的客户端数量。默认这个限制是10000个客户端，然而如果Redis服务器不能配置</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 处理文件的限制数来满足指定的值，那么最大的客户端连接数就被设置成当前文件限制数减32（因</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为Redis服务器保留了一些文件描述符作为内部使用）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 一旦达到这个限制，Redis会关闭所有新连接并发送错误&#39;max number of clients reached&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># maxclients 10000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 不要用比设置的上限更多的内存。一旦内存使用达到上限，Redis会根据选定的回收策略（参见：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># maxmemmory-policy）删除key</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果因为删除策略Redis无法删除key，或者策略设置为 &#34;noeviction&#34;，Redis会回复需要更</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 多内存的错误信息给命令。例如，SET,LPUSH等等，但是会继续响应像Get这样的只读命令。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在使用Redis作为LRU缓存，或者为实例设置了硬性内存限制的时候（使用 &#34;noeviction&#34; 策略）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 的时候，这个选项通常事很有用的。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 警告：当有多个slave连上达到内存上限的实例时，master为同步slave的输出缓冲区所需</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 内存不计算在使用内存中。这样当驱逐key时，就不会因网络问题 / 重新同步事件触发驱逐key</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 的循环，反过来slaves的输出缓冲区充满了key被驱逐的DEL命令，这将触发删除更多的key，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 直到这个数据库完全被清空为止</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 总之...如果你需要附加多个slave，建议你设置一个稍小maxmemory限制，这样系统就会有空闲</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 的内存作为slave的输出缓存区(但是如果最大内存策略设置为&#34;noeviction&#34;的话就没必要了)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># maxmemory &lt;bytes&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 最大内存策略：如果达到内存限制了，Redis如何选择删除key。你可以在下面五个行为里选：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># volatile-lru -&gt; 根据LRU算法生成的过期时间来删除。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allkeys-lru -&gt; 根据LRU算法删除任何key。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># volatile-random -&gt; 根据过期设置来随机删除key。 </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allkeys-&gt;random -&gt; 无差别随机删。 </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># volatile-ttl -&gt; 根据最近过期时间来删除（辅以TTL） </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># noeviction -&gt; 谁也不删，直接在写操作时返回错误。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意：对所有策略来说，如果Redis找不到合适的可以删除的key都会在写操作时返回一个错误。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#       目前为止涉及的命令：set setnx setex append</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#       incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#       sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#       zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#       getset mset msetnx exec sort</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认值如下：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># maxmemory-policy volatile-lru</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># LRU和最小TTL算法的实现都不是很精确，但是很接近（为了省内存），所以你可以用样本量做检测。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如：默认Redis会检查3个key然后取最旧的那个，你可以通过下面的配置指令来设置样本的个数。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># maxmemory-samples 3</span>
</span></span></code></pre></div><h1 id="append-only-mode">APPEND ONLY MODE</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">############################## APPEND ONLY MODE ###############################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认情况下，Redis是异步的把数据导出到磁盘上。这种模式在很多应用里已经足够好，但Redis进程</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 出问题或断电时可能造成一段时间的写操作丢失(这取决于配置的save指令)。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># AOF是一种提供了更可靠的替代持久化模式，例如使用默认的数据写入文件策略（参见后面的配置）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在遇到像服务器断电或单写情况下Redis自身进程出问题但操作系统仍正常运行等突发事件时，Redis</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 能只丢失1秒的写操作。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># AOF和RDB持久化能同时启动并且不会有问题。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果AOF开启，那么在启动时Redis将加载AOF文件，它更能保证数据的可靠性。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 请查看 http://redis.io/topics/persistence 来获取更多信息.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>appendonly no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 纯累加文件名字（默认：&#34;appendonly.aof&#34;）</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>appendfilename <span style="color:#4e9a06">&#34;appendonly.aof&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># fsync() 系统调用告诉操作系统把数据写到磁盘上，而不是等更多的数据进入输出缓冲区。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 有些操作系统会真的把数据马上刷到磁盘上；有些则会尽快去尝试这么做。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis支持三种不同的模式：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># no：不要立刻刷，只有在操作系统需要刷的时候再刷。比较快。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># always：每次写操作都立刻写入到aof文件。慢，但是最安全。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># everysec：每秒写一次。折中方案。 </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认的 &#34;everysec&#34; 通常来说能在速度和数据安全性之间取得比较好的平衡。根据你的理解来</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 决定，如果你能放宽该配置为&#34;no&#34; 来获取更好的性能(但如果你能忍受一些数据丢失，可以考虑使用</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认的快照持久化模式)，或者相反，用“always”会比较慢但比everysec要更安全。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 请查看下面的文章来获取更多的细节</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># http://antirez.com/post/redis-persistence-demystified.html </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果不能确定，就用 &#34;everysec&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># appendfsync always</span>
</span></span><span style="display:flex;"><span>appendfsync everysec
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># appendfsync no</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果AOF的同步策略设置成 &#34;always&#34; 或者 &#34;everysec&#34;，并且后台的存储进程（后台存储或写入AOF</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 日志）会产生很多磁盘I/O开销。某些Linux的配置下会使Redis因为 fsync()系统调用而阻塞很久。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意，目前对这个情况还没有完美修正，甚至不同线程的 fsync() 会阻塞我们同步的write(2)调用。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为了缓解这个问题，可以用下面这个选项。它可以在 BGSAVE 或 BGREWRITEAOF 处理时阻止fsync()。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这就意味着如果有子进程在进行保存操作，那么Redis就处于&#34;不可同步&#34;的状态。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这实际上是说，在最差的情况下可能会丢掉30秒钟的日志数据。（默认Linux设定）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果把这个设置成&#34;yes&#34;带来了延迟问题，就保持&#34;no&#34;，这是保存持久数据的最安全的方式。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>no-appendfsync-on-rewrite no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 自动重写AOF文件</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果AOF日志文件增大到指定百分比，Redis能够通过 BGREWRITEAOF 自动重写AOF日志文件。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 工作原理：Redis记住上次重写时AOF文件的大小（如果重启后还没有写操作，就直接用启动时的AOF大小）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这个基准大小和当前大小做比较。如果当前大小超过指定比例，就会触发重写操作。你还需要指定被重写</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 日志的最小尺寸，这样避免了达到指定百分比但尺寸仍然很小的情况还要重写。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定百分比为0会禁用AOF自动重写特性。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>auto-aof-rewrite-percentage <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>auto-aof-rewrite-min-size 64mb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################ LUA SCRIPTING  ###############################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Lua 脚本的最大执行时间，毫秒为单位</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果达到了最大的执行时间，Redis将要记录在达到最大允许时间之后一个脚本仍然在执行，并且将</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 开始对查询进行错误响应。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当一个长时间运行的脚本超过了最大执行时间，只有 SCRIPT KILL 和 SHUTDOWN NOSAVE 两个</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 命令可用。第一个可以用于停止一个还没有调用写命名的脚本。第二个是关闭服务器唯一方式，当</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 写命令已经通过脚本开始执行，并且用户不想等到脚本的自然终止。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置成0或者负值表示不限制执行时间并且没有任何警告</span>
</span></span><span style="display:flex;"><span>lua-time-limit <span style="color:#0000cf;font-weight:bold">5000</span>
</span></span></code></pre></div><h1 id="slow-log">SLOW LOG</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################## SLOW LOG ###################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis慢查询日志可以记录超过指定时间的查询。运行时间不包括各种I/O时间，例如：连接客户端，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 发送响应数据等，而只计算命令执行的实际时间（这只是线程阻塞而无法同时为其他请求服务的命令执</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 行阶段）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 你可以为慢查询日志配置两个参数:一个指明Redis的超时时间(单位为微秒)来记录超过这个时间的命令</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 另一个是慢查询日志长度。当一个新的命令被写进日志的时候，最老的那个记录从队列中移除。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下面的时间单位是微秒，所以1000000就是1秒。注意，负数时间会禁用慢查询日志，而0则会强制记录</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 所有命令。</span>
</span></span><span style="display:flex;"><span>slowlog-log-slower-than <span style="color:#0000cf;font-weight:bold">10000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这个长度没有限制。只是要主要会消耗内存。你可以通过 SLOWLOG RESET 来回收内存。</span>
</span></span><span style="display:flex;"><span>slowlog-max-len <span style="color:#0000cf;font-weight:bold">128</span>
</span></span></code></pre></div><h1 id="event-notification">Event notification</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">############################# Event notification ##############################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis 能通知 Pub/Sub 客户端关于键空间发生的事件</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这个功能文档位于http://redis.io/topics/keyspace-events</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如：如果键空间事件通知被开启，并且客户端对 0 号数据库的键 foo 执行 DEL 命令时，将通过</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Pub/Sub发布两条消息：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># PUBLISH __keyspace@0__:foo del</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># PUBLISH __keyevent@0__:del foo</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以在下表中选择Redis要通知的事件类型。事件类型由单个字符来标识：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># K    键空间通知，以__keyspace@&lt;db&gt;__为前缀</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># E    键事件通知，以__keysevent@&lt;db&gt;__为前缀</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># g    DEL , EXPIRE , RENAME 等类型无关的通用命令的通知, ...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># $    String命令</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># l    List命令</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># s    Set命令</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># h    Hash命令</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># z    有序集合命令</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># x    过期事件（每次key过期时生成）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># e    驱逐事件（当key在内存满了被清除时生成）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A    g$lshzxe的别名，因此”AKE”意味着所有的事件</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># notify-keyspace-events 带一个由0到多个字符组成的字符串参数。空字符串意思是通知被禁用。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例子：启用List和通用事件通知：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># notify-keyspace-events Elg</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例子2：为了获取过期key的通知订阅名字为 __keyevent@__:expired 的频道，用以下配置</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># notify-keyspace-events Ex</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认所用的通知被禁用，因为用户通常不需要该特性，并且该特性会有性能损耗。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意如果你不指定至少K或E之一，不会发送任何事件。</span>
</span></span><span style="display:flex;"><span>notify-keyspace-events <span style="color:#4e9a06">&#34;&#34;</span>
</span></span></code></pre></div><h1 id="advanced-config">ADVANCED CONFIG</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当hash只有少量的entry时，并且最大的entry所占空间没有超过指定的限制时，会用一种节省内存的</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 数据结构来编码。可以通过下面的指令来设定限制</span>
</span></span><span style="display:flex;"><span>hash-max-ziplist-entries <span style="color:#0000cf;font-weight:bold">512</span>
</span></span><span style="display:flex;"><span>hash-max-ziplist-value <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 与hash似，数据元素较少的list，可以用另一种方式来编码从而节省大量空间。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这种特殊的方式只有在符合下面限制时才可以用：</span>
</span></span><span style="display:flex;"><span>list-max-ziplist-entries <span style="color:#0000cf;font-weight:bold">512</span>
</span></span><span style="display:flex;"><span>list-max-ziplist-value <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># set有一种特殊编码的情况：当set数据全是十进制64位有符号整型数字构成的字符串时。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下面这个配置项就是用来设置set使用这种编码来节省内存的最大长度。</span>
</span></span><span style="display:flex;"><span>set-max-intset-entries <span style="color:#0000cf;font-weight:bold">512</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 与hash和list相似，有序集合也可以用一种特别的编码方式来节省大量空间。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这种编码只适合长度和元素都小于下面限制的有序集合：</span>
</span></span><span style="display:flex;"><span>zset-max-ziplist-entries <span style="color:#0000cf;font-weight:bold">128</span>
</span></span><span style="display:flex;"><span>zset-max-ziplist-value <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># HyperLogLog sparse representation bytes limit. The limit includes the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 16 bytes header. When an HyperLogLog using the sparse representation crosses</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># this limit, it is converted into the dense representation.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A value greater than 16000 is totally useless, since at that point the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dense representation is more memory efficient.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The suggested value is ~ 3000 in order to have the benefits of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the space efficient encoding without slowing down too much PFADD,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># which is O(N) with the sparse encoding. The value can be raised to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ~ 10000 when CPU is not a concern, but space is, and the data set is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># composed of many HyperLogLogs with cardinality in the 0 - 15000 range.</span>
</span></span><span style="display:flex;"><span>hll-sparse-max-bytes <span style="color:#0000cf;font-weight:bold">3000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启用哈希刷新，每100个CPU毫秒会拿出1个毫秒来刷新Redis的主哈希表（顶级键值映射表）。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># redis所用的哈希表实现（见dict.c）采用延迟哈希刷新机制：你对一个哈希表操作越多，哈希刷新</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 操作就越频繁；反之，如果服务器是空闲的，那么哈希刷新就不会完成，哈希表就会占用更多的一些</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 内存而已。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认是每秒钟进行10次哈希表刷新，用来刷新字典，然后尽快释放内存。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 建议：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果你对延迟比较在意，不能够接受Redis时不时的对请求有2毫秒的延迟的话，就用</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &#34;activerehashing no&#34;，如果不太在意延迟而希望尽快释放内存就设置&#34;activerehashing yes&#34;</span>
</span></span><span style="display:flex;"><span>activerehashing yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 客户端的输出缓冲区的限制，可用于强制断开那些因为某种原因从服务器读取数据的速度不够快的客户端，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># （一个常见的原因是一个发布/订阅客户端消费消息的速度无法赶上生产它们的速度）</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以对三种不同的客户端设置不同的限制：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># normal -&gt; 正常客户端</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave -&gt; slave和 MONITOR 客户端</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pubsub -&gt; 至少订阅了一个pubsub channel或pattern的客户端</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下面是每个client-output-buffer-limit语法:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># client-output-buffer-limit &lt;class&gt;&lt;hard limit&gt; &lt;soft limit&gt; &lt;soft seconds&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 一旦达到硬限制客户端会立即被断开，或者达到软限制并持续达到指定的秒数（连续的）。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如，如果硬限制为32兆字节和软限制为16兆字节/10秒，客户端将会立即断开</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果输出缓冲区的大小达到32兆字节，或客户端达到16兆字节并连续超过了限制10秒，就将断开连接。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认normal客户端不做限制，因为他们在不主动请求时不接收数据（以推的方式），只有异步客户端</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可能会出现请求数据的速度比它可以读取的速度快的场景。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pubsub和slave客户端会有一个默认值，因为订阅者和slaves以推的方式来接收数据</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 把硬限制和软限制都设置为0来禁用该功能</span>
</span></span><span style="display:flex;"><span>client-output-buffer-limit normal <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>client-output-buffer-limit slave 256mb 64mb <span style="color:#0000cf;font-weight:bold">60</span>
</span></span><span style="display:flex;"><span>client-output-buffer-limit pubsub 32mb 8mb <span style="color:#0000cf;font-weight:bold">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis调用内部函数来执行许多后台任务，如关闭客户端超时的连接，清除未被请求过的过期Key等等。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 不是所有的任务都以相同的频率执行，但Redis依照指定的“hz”值来执行检查任务。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认情况下，“hz”的被设定为10。提高该值将在Redis空闲时使用更多的CPU时，但同时当有多个key</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 同时到期会使Redis的反应更灵敏，以及超时可以更精确地处理。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 范围是1到500之间，但是值超过100通常不是一个好主意。</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 大多数用户应该使用10这个默认值，只有在非常低的延迟要求时有必要提高到100。</span>
</span></span><span style="display:flex;"><span>hz <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当一个子进程重写AOF文件时，如果启用下面的选项，则文件每生成32M数据会被同步。为了增量式的</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 写入硬盘并且避免大的延迟高峰这个指令是非常有用的</span>
</span></span><span style="display:flex;"><span>aof-rewrite-incremental-fsync yes
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fb05c22cf7382c53488c3ab08823d9b8">9.5 - Redis配置详解（英文版）</h1>
    
	<blockquote>
<p>本文来自redis 官方配置文件</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis configuration file example.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note that in order to read the configuration file, Redis must be</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># started with the file path as first argument:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ./redis-server /path/to/redis.conf</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note on units: when memory size is needed, it is possible to specify</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># it in the usual form of 1k 5GB 4M and so forth:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1k =&gt; 1000 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1kb =&gt; 1024 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1m =&gt; 1000000 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1mb =&gt; 1024*1024 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1g =&gt; 1000000000 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1gb =&gt; 1024*1024*1024 bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># units are case insensitive so 1GB 1Gb 1gB are all the same.</span>
</span></span></code></pre></div><h1 id="includes">INCLUDES</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################## INCLUDES ###################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Include one or more other config files here.  This is useful if you</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># have a standard template that goes to all Redis servers but also need</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to customize a few per-server settings.  Include files can include</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># other files, so use this wisely.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Notice option &#34;include&#34; won&#39;t be rewritten by command &#34;CONFIG REWRITE&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># from admin or Redis Sentinel. Since Redis always uses the last processed</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># line as value of a configuration directive, you&#39;d better put includes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># at the beginning of this file to avoid overwriting config change at runtime.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If instead you are interested in using includes to override configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># options, it is better to use include as the last line.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># include /path/to/local.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># include /path/to/other.conf</span>
</span></span></code></pre></div><h1 id="modules">MODULES</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################## MODULES #####################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Load modules at startup. If the server is not able to load modules</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># it will abort. It is possible to use multiple loadmodule directives.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># loadmodule /path/to/my_module.so</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># loadmodule /path/to/other_module.so</span>
</span></span></code></pre></div><h1 id="network">NETWORK</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################## NETWORK #####################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default, if no &#34;bind&#34; configuration directive is specified, Redis listens</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for connections from all the network interfaces available on the server.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It is possible to listen to just one or multiple selected interfaces using</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the &#34;bind&#34; configuration directive, followed by one or more IP addresses.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Examples:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># bind 192.168.1.100 10.0.0.1</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># bind 127.0.0.1 ::1</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ~~~ WARNING ~~~ If the computer running Redis is directly exposed to the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># internet, binding to all the interfaces is dangerous and will expose the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># instance to everybody on the internet. So by default we uncomment the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># following bind directive, that will force Redis to listen only into</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the IPv4 lookback interface address (this means Redis will be able to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># accept connections only from clients running into the same computer it</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># is running).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># IF YOU ARE SURE YOU WANT YOUR INSTANCE TO LISTEN TO ALL THE INTERFACES</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># JUST COMMENT THE FOLLOWING LINE.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">bind</span> 127.0.0.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Protected mode is a layer of security protection, in order to avoid that</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis instances left open on the internet are accessed and exploited.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># When protected mode is on and if:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1) The server is not binding explicitly to a set of addresses using the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    &#34;bind&#34; directive.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2) No password is configured.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The server only accepts connections from clients connecting from the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># IPv4 and IPv6 loopback addresses 127.0.0.1 and ::1, and from Unix domain</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># sockets.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default protected mode is enabled. You should disable it only if</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># you are sure you want clients from other hosts to connect to Redis</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># even if no authentication is configured, nor a specific set of interfaces</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># are explicitly listed using the &#34;bind&#34; directive.</span>
</span></span><span style="display:flex;"><span>protected-mode yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Accept connections on the specified port, default is 6379 (IANA #815344).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If port 0 is specified Redis will not listen on a TCP socket.</span>
</span></span><span style="display:flex;"><span>port <span style="color:#0000cf;font-weight:bold">6379</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># TCP listen() backlog.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># In high requests-per-second environments you need an high backlog in order</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to avoid slow clients connections issues. Note that the Linux kernel</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># will silently truncate it to the value of /proc/sys/net/core/somaxconn so</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># make sure to raise both the value of somaxconn and tcp_max_syn_backlog</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in order to get the desired effect.</span>
</span></span><span style="display:flex;"><span>tcp-backlog <span style="color:#0000cf;font-weight:bold">511</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Unix socket.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specify the path for the Unix socket that will be used to listen for</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># incoming connections. There is no default, so Redis will not listen</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># on a unix socket when not specified.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># unixsocket /tmp/redis.sock</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># unixsocketperm 700</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Close the connection after a client is idle for N seconds (0 to disable)</span>
</span></span><span style="display:flex;"><span>timeout <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># TCP keepalive.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If non-zero, use SO_KEEPALIVE to send TCP ACKs to clients in absence</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># of communication. This is useful for two reasons:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1) Detect dead peers.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2) Take the connection alive from the point of view of network</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    equipment in the middle.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># On Linux, the specified value (in seconds) is the period used to send ACKs.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note that to close the connection the double of the time is needed.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># On other kernels the period depends on the kernel configuration.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A reasonable value for this option is 300 seconds, which is the new</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis default starting with Redis 3.2.1.</span>
</span></span><span style="display:flex;"><span>tcp-keepalive <span style="color:#0000cf;font-weight:bold">300</span>
</span></span></code></pre></div><h1 id="general">GENERAL</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################# GENERAL #####################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default Redis does not run as a daemon. Use &#39;yes&#39; if you need it.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note that Redis will write a pid file in /var/run/redis.pid when daemonized.</span>
</span></span><span style="display:flex;"><span>daemonize yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If you run Redis from upstart or systemd, Redis can interact with your</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># supervision tree. Options:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   supervised no      - no supervision interaction</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   supervised upstart - signal upstart by putting Redis into SIGSTOP mode</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   supervised systemd - signal systemd by writing READY=1 to $NOTIFY_SOCKET</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   supervised auto    - detect upstart or systemd method based on</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#                        UPSTART_JOB or NOTIFY_SOCKET environment variables</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note: these supervision methods only signal &#34;process is ready.&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#       They do not enable continuous liveness pings back to your supervisor.</span>
</span></span><span style="display:flex;"><span>supervised no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If a pid file is specified, Redis writes it where specified at startup</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># and removes it at exit.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># When the server runs non daemonized, no pid file is created if none is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># specified in the configuration. When the server is daemonized, the pid file</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># is used even if not specified, defaulting to &#34;/var/run/redis.pid&#34;.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Creating a pid file is best effort: if Redis is not able to create it</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># nothing bad happens, the server will start and run normally.</span>
</span></span><span style="display:flex;"><span>pidfile /var/run/redis_6379.pid
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specify the server verbosity level.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This can be one of:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># debug (a lot of information, useful for development/testing)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># verbose (many rarely useful info, but not a mess like the debug level)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># notice (moderately verbose, what you want in production probably)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># warning (only very important / critical messages are logged)</span>
</span></span><span style="display:flex;"><span>loglevel notice
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specify the log file name. Also the empty string can be used to force</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis to log on the standard output. Note that if you use standard</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># output for logging but daemonize, logs will be sent to /dev/null</span>
</span></span><span style="display:flex;"><span>logfile <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># To enable logging to the system logger, just set &#39;syslog-enabled&#39; to yes,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># and optionally update the other syslog parameters to suit your needs.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># syslog-enabled no</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specify the syslog identity.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># syslog-ident redis</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specify the syslog facility. Must be USER or between LOCAL0-LOCAL7.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># syslog-facility local0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Set the number of databases. The default database is DB 0, you can select</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># a different one on a per-connection basis using SELECT &lt;dbid&gt; where</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dbid is a number between 0 and &#39;databases&#39;-1</span>
</span></span><span style="display:flex;"><span>databases <span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default Redis shows an ASCII art logo only when started to log to the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># standard output and if the standard output is a TTY. Basically this means</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># that normally a logo is displayed only in interactive sessions.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># However it is possible to force the pre-4.0 behavior and always show a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ASCII art logo in startup logs by setting the following option to yes.</span>
</span></span><span style="display:flex;"><span>always-show-logo yes
</span></span></code></pre></div><h1 id="snapshotting">SNAPSHOTTING</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################ SNAPSHOTTING  ################################</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Save the DB on disk:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   save &lt;seconds&gt; &lt;changes&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   Will save the DB if both the given number of seconds and the given</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   number of write operations against the DB occurred.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   In the example below the behaviour will be to save:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   after 900 sec (15 min) if at least 1 key changed</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   after 300 sec (5 min) if at least 10 keys changed</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   after 60 sec if at least 10000 keys changed</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   Note: you can disable saving completely by commenting out all &#34;save&#34; lines.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   It is also possible to remove all the previously configured save</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   points by adding a save directive with a single empty string argument</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   like in the following example:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   save &#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>save <span style="color:#0000cf;font-weight:bold">900</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>save <span style="color:#0000cf;font-weight:bold">300</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>save <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#0000cf;font-weight:bold">10000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default Redis will stop accepting writes if RDB snapshots are enabled</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (at least one save point) and the latest background save failed.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This will make the user aware (in a hard way) that data is not persisting</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># on disk properly, otherwise chances are that no one will notice and some</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># disaster will happen.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If the background saving process will start working again Redis will</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># automatically allow writes again.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># However if you have setup your proper monitoring of the Redis server</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># and persistence, you may want to disable this feature so that Redis will</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># continue to work as usual even if there are problems with disk,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># permissions, and so forth.</span>
</span></span><span style="display:flex;"><span>stop-writes-on-bgsave-error yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Compress string objects using LZF when dump .rdb databases?</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For default that&#39;s set to &#39;yes&#39; as it&#39;s almost always a win.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If you want to save some CPU in the saving child set it to &#39;no&#39; but</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the dataset will likely be bigger if you have compressible values or keys.</span>
</span></span><span style="display:flex;"><span>rdbcompression yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Since version 5 of RDB a CRC64 checksum is placed at the end of the file.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This makes the format more resistant to corruption but there is a performance</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># hit to pay (around 10%) when saving and loading RDB files, so you can disable it</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for maximum performances.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># RDB files created with checksum disabled have a checksum of zero that will</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># tell the loading code to skip the check.</span>
</span></span><span style="display:flex;"><span>rdbchecksum yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The filename where to dump the DB</span>
</span></span><span style="display:flex;"><span>dbfilename dump.rdb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The working directory.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The DB will be written inside this directory, with the filename specified</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># above using the &#39;dbfilename&#39; configuration directive.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The Append Only File will also be created inside this directory.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note that you must specify a directory here, not a file name.</span>
</span></span><span style="display:flex;"><span>dir ./
</span></span></code></pre></div><h1 id="replication">REPLICATION</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################# REPLICATION #################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Master-Slave replication. Use slaveof to make a Redis instance a copy of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># another Redis server. A few things to understand ASAP about Redis replication.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1) Redis replication is asynchronous, but you can configure a master to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    stop accepting writes if it appears to be not connected with at least</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    a given number of slaves.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2) Redis slaves are able to perform a partial resynchronization with the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    master if the replication link is lost for a relatively small amount of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    time. You may want to configure the replication backlog size (see the next</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    sections of this file) with a sensible value depending on your needs.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 3) Replication is automatic and does not need user intervention. After a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    network partition slaves automatically try to reconnect to masters</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    and resynchronize with them.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slaveof &lt;masterip&gt; &lt;masterport&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If the master is password protected (using the &#34;requirepass&#34; configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># directive below) it is possible to tell the slave to authenticate before</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># starting the replication synchronization process, otherwise the master will</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># refuse the slave request.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># masterauth &lt;master-password&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># When a slave loses its connection with the master, or when the replication</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># is still in progress, the slave can act in two different ways:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1) if slave-serve-stale-data is set to &#39;yes&#39; (the default) the slave will</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    still reply to client requests, possibly with out of date data, or the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    data set may just be empty if this is the first synchronization.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2) if slave-serve-stale-data is set to &#39;no&#39; the slave will reply with</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    an error &#34;SYNC with master in progress&#34; to all the kind of commands</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    but to INFO and SLAVEOF.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span>slave-serve-stale-data yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># You can configure a slave instance to accept writes or not. Writing against</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># a slave instance may be useful to store some ephemeral data (because data</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># written on a slave will be easily deleted after resync with the master) but</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># may also cause problems if clients are writing to it because of a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># misconfiguration.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Since Redis 2.6 by default slaves are read-only.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note: read only slaves are not designed to be exposed to untrusted clients</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># on the internet. It&#39;s just a protection layer against misuse of the instance.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Still a read only slave exports by default all the administrative commands</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># such as CONFIG, DEBUG, and so forth. To a limited extent you can improve</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># security of read only slaves using &#39;rename-command&#39; to shadow all the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># administrative / dangerous commands.</span>
</span></span><span style="display:flex;"><span>slave-read-only yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Replication SYNC strategy: disk or socket.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># WARNING: DISKLESS REPLICATION IS EXPERIMENTAL CURRENTLY</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># New slaves and reconnecting slaves that are not able to continue the replication</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># process just receiving differences, need to do what is called a &#34;full</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># synchronization&#34;. An RDB file is transmitted from the master to the slaves.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The transmission can happen in two different ways:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1) Disk-backed: The Redis master creates a new process that writes the RDB</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#                 file on disk. Later the file is transferred by the parent</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#                 process to the slaves incrementally.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2) Diskless: The Redis master creates a new process that directly writes the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#              RDB file to slave sockets, without touching the disk at all.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># With disk-backed replication, while the RDB file is generated, more slaves</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># can be queued and served with the RDB file as soon as the current child producing</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the RDB file finishes its work. With diskless replication instead once</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the transfer starts, new slaves arriving will be queued and a new transfer</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># will start when the current one terminates.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># When diskless replication is used, the master waits a configurable amount of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># time (in seconds) before starting the transfer in the hope that multiple slaves</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># will arrive and the transfer can be parallelized.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># With slow disks and fast (large bandwidth) networks, diskless replication</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># works better.</span>
</span></span><span style="display:flex;"><span>repl-diskless-sync no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># When diskless replication is enabled, it is possible to configure the delay</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the server waits in order to spawn the child that transfers the RDB via socket</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to the slaves.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This is important since once the transfer starts, it is not possible to serve</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># new slaves arriving, that will be queued for the next RDB transfer, so the server</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># waits a delay in order to let more slaves arrive.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The delay is specified in seconds, and by default is 5 seconds. To disable</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># it entirely just set it to 0 seconds and the transfer will start ASAP.</span>
</span></span><span style="display:flex;"><span>repl-diskless-sync-delay <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Slaves send PINGs to server in a predefined interval. It&#39;s possible to change</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># this interval with the repl_ping_slave_period option. The default value is 10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># seconds.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repl-ping-slave-period 10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The following option sets the replication timeout for:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1) Bulk transfer I/O during SYNC, from the point of view of slave.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2) Master timeout from the point of view of slaves (data, pings).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 3) Slave timeout from the point of view of masters (REPLCONF ACK pings).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It is important to make sure that this value is greater than the value</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># specified for repl-ping-slave-period otherwise a timeout will be detected</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># every time there is low traffic between the master and the slave.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repl-timeout 60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Disable TCP_NODELAY on the slave socket after SYNC?</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If you select &#34;yes&#34; Redis will use a smaller number of TCP packets and</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># less bandwidth to send data to slaves. But this can add a delay for</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the data to appear on the slave side, up to 40 milliseconds with</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Linux kernels using a default configuration.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If you select &#34;no&#34; the delay for data to appear on the slave side will</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># be reduced but more bandwidth will be used for replication.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default we optimize for low latency, but in very high traffic conditions</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># or when the master and slaves are many hops away, turning this to &#34;yes&#34; may</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># be a good idea.</span>
</span></span><span style="display:flex;"><span>repl-disable-tcp-nodelay no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Set the replication backlog size. The backlog is a buffer that accumulates</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave data when slaves are disconnected for some time, so that when a slave</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># wants to reconnect again, often a full resync is not needed, but a partial</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># resync is enough, just passing the portion of data the slave missed while</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># disconnected.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The bigger the replication backlog, the longer the time the slave can be</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># disconnected and later be able to perform a partial resynchronization.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The backlog is only allocated once there is at least a slave connected.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repl-backlog-size 1mb</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># After a master has no longer connected slaves for some time, the backlog</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># will be freed. The following option configures the amount of seconds that</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># need to elapse, starting from the time the last slave disconnected, for</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the backlog buffer to be freed.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note that slaves never free the backlog for timeout, since they may be</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># promoted to masters later, and should be able to correctly &#34;partially</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># resynchronize&#34; with the slaves: hence they should always accumulate backlog.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A value of 0 means to never release the backlog.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># repl-backlog-ttl 3600</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The slave priority is an integer number published by Redis in the INFO output.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It is used by Redis Sentinel in order to select a slave to promote into a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># master if the master is no longer working correctly.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A slave with a low priority number is considered better for promotion, so</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for instance if there are three slaves with priority 10, 100, 25 Sentinel will</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pick the one with priority 10, that is the lowest.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># However a special priority of 0 marks the slave as not able to perform the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># role of master, so a slave with priority of 0 will never be selected by</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis Sentinel for promotion.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default the priority is 100.</span>
</span></span><span style="display:flex;"><span>slave-priority <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It is possible for a master to stop accepting writes if there are less than</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># N slaves connected, having a lag less or equal than M seconds.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The N slaves need to be in &#34;online&#34; state.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The lag in seconds, that must be &lt;= the specified value, is calculated from</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the last ping received from the slave, that is usually sent every second.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This option does not GUARANTEE that N replicas will accept the write, but</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># will limit the window of exposure for lost writes in case not enough slaves</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># are available, to the specified number of seconds.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For example to require at least 3 slaves with a lag &lt;= 10 seconds use:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># min-slaves-to-write 3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># min-slaves-max-lag 10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Setting one or the other to 0 disables the feature.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default min-slaves-to-write is set to 0 (feature disabled) and</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># min-slaves-max-lag is set to 10.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A Redis master is able to list the address and port of the attached</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slaves in different ways. For example the &#34;INFO replication&#34; section</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># offers this information, which is used, among other tools, by</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis Sentinel in order to discover slave instances.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Another place where this info is available is in the output of the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &#34;ROLE&#34; command of a master.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The listed IP and address normally reported by a slave is obtained</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in the following way:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   IP: The address is auto detected by checking the peer address</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   of the socket used by the slave to connect with the master.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   Port: The port is communicated by the slave during the replication</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   handshake, and is normally the port that the slave is using to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   list for connections.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># However when port forwarding or Network Address Translation (NAT) is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># used, the slave may be actually reachable via different IP and port</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pairs. The following two options can be used by a slave in order to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># report to its master a specific set of IP and port, so that both INFO</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># and ROLE will report those values.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># There is no need to use both the options if you need to override just</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the port or the IP address.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave-announce-ip 5.5.5.5</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave-announce-port 1234</span>
</span></span></code></pre></div><h1 id="security">SECURITY</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################## SECURITY ###################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Require clients to issue AUTH &lt;PASSWORD&gt; before processing any other</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># commands.  This might be useful in environments in which you do not trust</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># others with access to the host running redis-server.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This should stay commented out for backward compatibility and because most</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># people do not need auth (e.g. they run their own servers).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Warning: since Redis is pretty fast an outside user can try up to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 150k passwords per second against a good box. This means that you should</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># use a very strong password otherwise it will be very easy to break.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># requirepass foobared</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Command renaming.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It is possible to change the name of dangerous commands in a shared</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># environment. For instance the CONFIG command may be renamed into something</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># hard to guess so that it will still be available for internal-use tools</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># but not available for general clients.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Example:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It is also possible to completely kill a command by renaming it into</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># an empty string:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># rename-command CONFIG &#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Please note that changing the name of commands that are logged into the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># AOF file or transmitted to slaves may cause problems.</span>
</span></span></code></pre></div><h1 id="clients">CLIENTS</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################### CLIENTS ####################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Set the max number of connected clients at the same time. By default</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># this limit is set to 10000 clients, however if the Redis server is not</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># able to configure the process file limit to allow for the specified limit</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the max number of allowed clients is set to the current file limit</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># minus 32 (as Redis reserves a few file descriptors for internal uses).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Once the limit is reached Redis will close all the new connections sending</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># an error &#39;max number of clients reached&#39;.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># maxclients 10000</span>
</span></span></code></pre></div><h1 id="memory-management">MEMORY MANAGEMENT</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">############################## MEMORY MANAGEMENT ################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Set a memory usage limit to the specified amount of bytes.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># When the memory limit is reached Redis will try to remove keys</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># according to the eviction policy selected (see maxmemory-policy).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If Redis can&#39;t remove keys according to the policy, or if the policy is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># set to &#39;noeviction&#39;, Redis will start to reply with errors to commands</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># that would use more memory, like SET, LPUSH, and so on, and will continue</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to reply to read-only commands like GET.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This option is usually useful when using Redis as an LRU or LFU cache, or to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># set a hard memory limit for an instance (using the &#39;noeviction&#39; policy).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># WARNING: If you have slaves attached to an instance with maxmemory on,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the size of the output buffers needed to feed the slaves are subtracted</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># from the used memory count, so that network problems / resyncs will</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># not trigger a loop where keys are evicted, and in turn the output</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># buffer of slaves is full with DELs of keys evicted triggering the deletion</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># of more keys, and so forth until the database is completely emptied.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># In short... if you have slaves attached it is suggested that you set a lower</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># limit for maxmemory so that there is some free RAM on the system for slave</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># output buffers (but this is not needed if the policy is &#39;noeviction&#39;).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># maxmemory &lt;bytes&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># MAXMEMORY POLICY: how Redis will select what to remove when maxmemory</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># is reached. You can select among five behaviors:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># volatile-lru -&gt; Evict using approximated LRU among the keys with an expire set.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allkeys-lru -&gt; Evict any key using approximated LRU.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># volatile-lfu -&gt; Evict using approximated LFU among the keys with an expire set.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allkeys-lfu -&gt; Evict any key using approximated LFU.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># volatile-random -&gt; Remove a random key among the ones with an expire set.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># allkeys-random -&gt; Remove a random key, any key.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># noeviction -&gt; Don&#39;t evict anything, just return an error on write operations.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># LRU means Least Recently Used</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># LFU means Least Frequently Used</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Both LRU, LFU and volatile-ttl are implemented using approximated</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># randomized algorithms.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note: with any of the above policies, Redis will return an error on write</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#       operations, when there are no suitable keys for eviction.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#       At the date of writing these commands are: set setnx setex append</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#       incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#       sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#       zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#       getset mset msetnx exec sort</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The default is:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># maxmemory-policy noeviction</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># LRU, LFU and minimal TTL algorithms are not precise algorithms but approximated</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># algorithms (in order to save memory), so you can tune it for speed or</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># accuracy. For default Redis will check five keys and pick the one that was</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># used less recently, you can change the sample size using the following</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># configuration directive.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The default of 5 produces good enough results. 10 Approximates very closely</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># true LRU but costs more CPU. 3 is faster but not very accurate.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># maxmemory-samples 5</span>
</span></span></code></pre></div><h1 id="lazy-freeing">LAZY FREEING</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">############################# LAZY FREEING ####################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis has two primitives to delete keys. One is called DEL and is a blocking</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># deletion of the object. It means that the server stops processing new commands</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in order to reclaim all the memory associated with an object in a synchronous</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># way. If the key deleted is associated with a small object, the time needed</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in order to execute the DEL command is very small and comparable to most other</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># O(1) or O(log_N) commands in Redis. However if the key is associated with an</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># aggregated value containing millions of elements, the server can block for</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># a long time (even seconds) in order to complete the operation.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For the above reasons Redis also offers non blocking deletion primitives</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># such as UNLINK (non blocking DEL) and the ASYNC option of FLUSHALL and</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># FLUSHDB commands, in order to reclaim memory in background. Those commands</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># are executed in constant time. Another thread will incrementally free the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># object in the background as fast as possible.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># DEL, UNLINK and ASYNC option of FLUSHALL and FLUSHDB are user-controlled.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It&#39;s up to the design of the application to understand when it is a good</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># idea to use one or the other. However the Redis server sometimes has to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># delete keys or flush the whole database as a side effect of other operations.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specifically Redis deletes objects independently of a user call in the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># following scenarios:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1) On eviction, because of the maxmemory and maxmemory policy configurations,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    in order to make room for new data, without going over the specified</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    memory limit.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2) Because of expire: when a key with an associated time to live (see the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    EXPIRE command) must be deleted from memory.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 3) Because of a side effect of a command that stores data on a key that may</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    already exist. For example the RENAME command may delete the old key</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    content when it is replaced with another one. Similarly SUNIONSTORE</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    or SORT with STORE option may delete existing keys. The SET command</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    itself removes any old content of the specified key in order to replace</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    it with the specified string.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 4) During replication, when a slave performs a full resynchronization with</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    its master, the content of the whole database is removed in order to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    load the RDB file just transfered.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># In all the above cases the default is to delete objects in a blocking way,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># like if DEL was called. However you can configure each case specifically</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in order to instead release memory in a non-blocking way like if UNLINK</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># was called, using the following configuration directives:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lazyfree-lazy-eviction no
</span></span><span style="display:flex;"><span>lazyfree-lazy-expire no
</span></span><span style="display:flex;"><span>lazyfree-lazy-server-del no
</span></span><span style="display:flex;"><span>slave-lazy-flush no
</span></span></code></pre></div><h1 id="append-only-mode">APPEND ONLY MODE</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">############################## APPEND ONLY MODE ###############################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default Redis asynchronously dumps the dataset on disk. This mode is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># good enough in many applications, but an issue with the Redis process or</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># a power outage may result into a few minutes of writes lost (depending on</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the configured save points).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The Append Only File is an alternative persistence mode that provides</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># much better durability. For instance using the default data fsync policy</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (see later in the config file) Redis can lose just one second of writes in a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dramatic event like a server power outage, or a single write if something</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># wrong with the Redis process itself happens, but the operating system is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># still running correctly.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># AOF and RDB persistence can be enabled at the same time without problems.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If the AOF is enabled on startup Redis will load the AOF, that is the file</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># with the better durability guarantees.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Please check http://redis.io/topics/persistence for more information.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>appendonly no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The name of the append only file (default: &#34;appendonly.aof&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>appendfilename <span style="color:#4e9a06">&#34;appendonly.aof&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The fsync() call tells the Operating System to actually write data on disk</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># instead of waiting for more data in the output buffer. Some OS will really flush</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># data on disk, some other OS will just try to do it ASAP.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis supports three different modes:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># no: don&#39;t fsync, just let the OS flush the data when it wants. Faster.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># always: fsync after every write to the append only log. Slow, Safest.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># everysec: fsync only one time every second. Compromise.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The default is &#34;everysec&#34;, as that&#39;s usually the right compromise between</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># speed and data safety. It&#39;s up to you to understand if you can relax this to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &#34;no&#34; that will let the operating system flush the output buffer when</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># it wants, for better performances (but if you can live with the idea of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># some data loss consider the default persistence mode that&#39;s snapshotting),</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># or on the contrary, use &#34;always&#34; that&#39;s very slow but a bit safer than</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># everysec.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># More details please check the following article:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># http://antirez.com/post/redis-persistence-demystified.html</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If unsure, use &#34;everysec&#34;.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># appendfsync always</span>
</span></span><span style="display:flex;"><span>appendfsync everysec
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># appendfsync no</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># When the AOF fsync policy is set to always or everysec, and a background</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># saving process (a background save or AOF log background rewriting) is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># performing a lot of I/O against the disk, in some Linux configurations</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis may block too long on the fsync() call. Note that there is no fix for</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># this currently, as even performing fsync in a different thread will block</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># our synchronous write(2) call.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># In order to mitigate this problem it&#39;s possible to use the following option</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># that will prevent fsync() from being called in the main process while a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># BGSAVE or BGREWRITEAOF is in progress.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This means that while another child is saving, the durability of Redis is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the same as &#34;appendfsync none&#34;. In practical terms, this means that it is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># possible to lose up to 30 seconds of log in the worst scenario (with the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># default Linux settings).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If you have latency problems turn this to &#34;yes&#34;. Otherwise leave it as</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &#34;no&#34; that is the safest pick from the point of view of durability.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>no-appendfsync-on-rewrite no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Automatic rewrite of the append only file.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis is able to automatically rewrite the log file implicitly calling</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># BGREWRITEAOF when the AOF log size grows by the specified percentage.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This is how it works: Redis remembers the size of the AOF file after the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># latest rewrite (if no rewrite has happened since the restart, the size of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the AOF at startup is used).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This base size is compared to the current size. If the current size is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># bigger than the specified percentage, the rewrite is triggered. Also</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># you need to specify a minimal size for the AOF file to be rewritten, this</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># is useful to avoid rewriting the AOF file even if the percentage increase</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># is reached but it is still pretty small.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specify a percentage of zero in order to disable the automatic AOF</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># rewrite feature.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>auto-aof-rewrite-percentage <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>auto-aof-rewrite-min-size 64mb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># An AOF file may be found to be truncated at the end during the Redis</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># startup process, when the AOF data gets loaded back into memory.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This may happen when the system where Redis is running</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># crashes, especially when an ext4 filesystem is mounted without the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># data=ordered option (however this can&#39;t happen when Redis itself</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># crashes or aborts but the operating system still works correctly).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis can either exit with an error when this happens, or load as much</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># data as possible (the default now) and start if the AOF file is found</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to be truncated at the end. The following option controls this behavior.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If aof-load-truncated is set to yes, a truncated AOF file is loaded and</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the Redis server starts emitting a log to inform the user of the event.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Otherwise if the option is set to no, the server aborts with an error</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># and refuses to start. When the option is set to no, the user requires</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to fix the AOF file using the &#34;redis-check-aof&#34; utility before to restart</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the server.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note that if the AOF file will be found to be corrupted in the middle</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the server will still exit with an error. This option only applies when</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis will try to read more data from the AOF file but not enough bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># will be found.</span>
</span></span><span style="display:flex;"><span>aof-load-truncated yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># When rewriting the AOF file, Redis is able to use an RDB preamble in the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># AOF file for faster rewrites and recoveries. When this option is turned</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># on the rewritten AOF file is composed of two different stanzas:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   [RDB file][AOF tail]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># When loading Redis recognizes that the AOF file starts with the &#34;REDIS&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># string and loads the prefixed RDB file, and continues loading the AOF</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># tail.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This is currently turned off by default in order to avoid the surprise</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># of a format change, but will at some point be used as the default.</span>
</span></span><span style="display:flex;"><span>aof-use-rdb-preamble no
</span></span></code></pre></div><h1 id="lua-scripting">LUA SCRIPTING</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################ LUA SCRIPTING  ###############################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Max execution time of a Lua script in milliseconds.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If the maximum execution time is reached Redis will log that a script is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># still in execution after the maximum allowed time and will start to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># reply to queries with an error.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># When a long running script exceeds the maximum execution time only the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># SCRIPT KILL and SHUTDOWN NOSAVE commands are available. The first can be</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># used to stop a script that did not yet called write commands. The second</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># is the only way to shut down the server in the case a write command was</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># already issued by the script but the user doesn&#39;t want to wait for the natural</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># termination of the script.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Set it to 0 or a negative value for unlimited execution without warnings.</span>
</span></span><span style="display:flex;"><span>lua-time-limit <span style="color:#0000cf;font-weight:bold">5000</span>
</span></span></code></pre></div><h1 id="redis-cluster">REDIS CLUSTER</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################ REDIS CLUSTER  ###############################</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># WARNING EXPERIMENTAL: Redis Cluster is considered to be stable code, however</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in order to mark it as &#34;mature&#34; we need to wait for a non trivial percentage</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># of users to deploy it in production.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Normal Redis instances can&#39;t be part of a Redis Cluster; only nodes that are</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># started as cluster nodes can. In order to start a Redis instance as a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cluster node enable the cluster support uncommenting the following:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cluster-enabled yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Every cluster node has a cluster configuration file. This file is not</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># intended to be edited by hand. It is created and updated by Redis nodes.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Every Redis Cluster node requires a different cluster configuration file.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Make sure that instances running in the same system do not have</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># overlapping cluster configuration file names.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cluster-config-file nodes-6379.conf</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Cluster node timeout is the amount of milliseconds a node must be unreachable</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for it to be considered in failure state.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Most other internal time limits are multiple of the node timeout.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cluster-node-timeout 15000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A slave of a failing master will avoid to start a failover if its data</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># looks too old.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># There is no simple way for a slave to actually have an exact measure of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># its &#34;data age&#34;, so the following two checks are performed:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1) If there are multiple slaves able to failover, they exchange messages</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    in order to try to give an advantage to the slave with the best</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    replication offset (more data from the master processed).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    Slaves will try to get their rank by offset, and apply to the start</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    of the failover a delay proportional to their rank.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2) Every single slave computes the time of the last interaction with</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    its master. This can be the last ping or command received (if the master</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    is still in the &#34;connected&#34; state), or the time that elapsed since the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    disconnection with the master (if the replication link is currently down).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    If the last interaction is too old, the slave will not try to failover</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    at all.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The point &#34;2&#34; can be tuned by user. Specifically a slave will not perform</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the failover if, since the last interaction with the master, the time</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># elapsed is greater than:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   (node-timeout * slave-validity-factor) + repl-ping-slave-period</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># So for example if node-timeout is 30 seconds, and the slave-validity-factor</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># is 10, and assuming a default repl-ping-slave-period of 10 seconds, the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave will not try to failover if it was not able to talk with the master</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for longer than 310 seconds.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A large slave-validity-factor may allow slaves with too old data to failover</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># a master, while a too small value may prevent the cluster from being able to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># elect a slave at all.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For maximum availability, it is possible to set the slave-validity-factor</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to a value of 0, which means, that slaves will always try to failover the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># master regardless of the last time they interacted with the master.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (However they&#39;ll always try to apply a delay proportional to their</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># offset rank).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Zero is the only value able to guarantee that when all the partitions heal</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the cluster will always be able to continue.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cluster-slave-validity-factor 10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Cluster slaves are able to migrate to orphaned masters, that are masters</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># that are left without working slaves. This improves the cluster ability</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to resist to failures as otherwise an orphaned master can&#39;t be failed over</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in case of failure if it has no working slaves.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Slaves migrate to orphaned masters only if there are still at least a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># given number of other working slaves for their old master. This number</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># is the &#34;migration barrier&#34;. A migration barrier of 1 means that a slave</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># will migrate only if there is at least 1 other working slave for its master</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># and so forth. It usually reflects the number of slaves you want for every</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># master in your cluster.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default is 1 (slaves migrate only if their masters remain with at least</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># one slave). To disable migration just set it to a very large value.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A value of 0 can be set but is useful only for debugging and dangerous</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in production.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cluster-migration-barrier 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default Redis Cluster nodes stop accepting queries if they detect there</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># is at least an hash slot uncovered (no available node is serving it).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This way if the cluster is partially down (for example a range of hash slots</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># are no longer covered) all the cluster becomes, eventually, unavailable.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It automatically returns available as soon as all the slots are covered again.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># However sometimes you want the subset of the cluster which is working,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to continue to accept queries for the part of the key space that is still</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># covered. In order to do so, just set the cluster-require-full-coverage</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># option to no.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cluster-require-full-coverage yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># In order to setup your cluster make sure to read the documentation</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># available at http://redis.io web site.</span>
</span></span></code></pre></div><h1 id="cluster-docker-nat-support">CLUSTER DOCKER/NAT support</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">########################## CLUSTER DOCKER/NAT support  ########################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># In certain deployments, Redis Cluster nodes address discovery fails, because</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># addresses are NAT-ted or because ports are forwarded (the typical case is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Docker and other containers).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># In order to make Redis Cluster working in such environments, a static</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># configuration where each node knows its public address is needed. The</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># following two options are used for this scope, and are:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * cluster-announce-ip</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * cluster-announce-port</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * cluster-announce-bus-port</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Each instruct the node about its address, client port, and cluster message</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># bus port. The information is then published in the header of the bus packets</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># so that other nodes will be able to correctly map the address of the node</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># publishing the information.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If the above options are not used, the normal Redis Cluster auto-detection</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># will be used instead.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note that when remapped, the bus port may not be at the fixed offset of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># clients port + 10000, so you can specify any port and bus-port depending</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># on how they get remapped. If the bus-port is not set, a fixed offset of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 10000 will be used as usually.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Example:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cluster-announce-ip 10.1.1.5</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cluster-announce-port 6379</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cluster-announce-bus-port 6380</span>
</span></span></code></pre></div><h1 id="slow-log">SLOW LOG</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################## SLOW LOG ###################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The Redis Slow Log is a system to log queries that exceeded a specified</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># execution time. The execution time does not include the I/O operations</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># like talking with the client, sending the reply and so forth,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># but just the time needed to actually execute the command (this is the only</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># stage of command execution where the thread is blocked and can not serve</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># other requests in the meantime).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># You can configure the slow log with two parameters: one tells Redis</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># what is the execution time, in microseconds, to exceed in order for the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># command to get logged, and the other parameter is the length of the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slow log. When a new command is logged the oldest one is removed from the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># queue of logged commands.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The following time is expressed in microseconds, so 1000000 is equivalent</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to one second. Note that a negative number disables the slow log, while</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># a value of zero forces the logging of every command.</span>
</span></span><span style="display:flex;"><span>slowlog-log-slower-than <span style="color:#0000cf;font-weight:bold">10000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># There is no limit to this length. Just be aware that it will consume memory.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># You can reclaim memory used by the slow log with SLOWLOG RESET.</span>
</span></span><span style="display:flex;"><span>slowlog-max-len <span style="color:#0000cf;font-weight:bold">128</span>
</span></span></code></pre></div><h1 id="latency-monitor">LATENCY MONITOR</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">################################ LATENCY MONITOR ##############################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The Redis latency monitoring subsystem samples different operations</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># at runtime in order to collect data related to possible sources of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># latency of a Redis instance.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Via the LATENCY command this information is available to the user that can</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># print graphs and obtain reports.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The system only logs operations that were performed in a time equal or</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># greater than the amount of milliseconds specified via the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># latency-monitor-threshold configuration directive. When its value is set</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to zero, the latency monitor is turned off.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default latency monitoring is disabled since it is mostly not needed</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># if you don&#39;t have latency issues, and collecting data has a performance</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># impact, that while very small, can be measured under big load. Latency</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># monitoring can easily be enabled at runtime using the command</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &#34;CONFIG SET latency-monitor-threshold &lt;milliseconds&gt;&#34; if needed.</span>
</span></span><span style="display:flex;"><span>latency-monitor-threshold <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><h1 id="event-notification">EVENT NOTIFICATION</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">############################# EVENT NOTIFICATION ##############################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis can notify Pub/Sub clients about events happening in the key space.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This feature is documented at http://redis.io/topics/notifications</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For instance if keyspace events notification is enabled, and a client</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># performs a DEL operation on key &#34;foo&#34; stored in the Database 0, two</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># messages will be published via Pub/Sub:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># PUBLISH __keyspace@0__:foo del</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># PUBLISH __keyevent@0__:del foo</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It is possible to select the events that Redis will notify among a set</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># of classes. Every class is identified by a single character:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  K     Keyspace events, published with __keyspace@&lt;db&gt;__ prefix.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  E     Keyevent events, published with __keyevent@&lt;db&gt;__ prefix.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  g     Generic commands (non-type specific) like DEL, EXPIRE, RENAME, ...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  $     String commands</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  l     List commands</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  s     Set commands</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  h     Hash commands</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  z     Sorted set commands</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  x     Expired events (events generated every time a key expires)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  e     Evicted events (events generated when a key is evicted for maxmemory)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  A     Alias for g$lshzxe, so that the &#34;AKE&#34; string means all the events.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  The &#34;notify-keyspace-events&#34; takes as argument a string that is composed</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  of zero or multiple characters. The empty string means that notifications</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  are disabled.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  Example: to enable list and generic events, from the point of view of the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#           event name, use:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  notify-keyspace-events Elg</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  Example 2: to get the stream of the expired keys subscribing to channel</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#             name __keyevent@0__:expired use:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  notify-keyspace-events Ex</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  By default all notifications are disabled because most users don&#39;t need</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  this feature and the feature has some overhead. Note that if you don&#39;t</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  specify at least one of K or E, no events will be delivered.</span>
</span></span><span style="display:flex;"><span>notify-keyspace-events <span style="color:#4e9a06">&#34;&#34;</span>
</span></span></code></pre></div><h1 id="advanced-config">ADVANCED CONFIG</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">############################### ADVANCED CONFIG ###############################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Hashes are encoded using a memory efficient data structure when they have a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># small number of entries, and the biggest entry does not exceed a given</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># threshold. These thresholds can be configured using the following directives.</span>
</span></span><span style="display:flex;"><span>hash-max-ziplist-entries <span style="color:#0000cf;font-weight:bold">512</span>
</span></span><span style="display:flex;"><span>hash-max-ziplist-value <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Lists are also encoded in a special way to save a lot of space.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The number of entries allowed per internal list node can be specified</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># as a fixed maximum size or a maximum number of elements.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For a fixed maximum size, use -5 through -1, meaning:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -5: max size: 64 Kb  &lt;-- not recommended for normal workloads</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -4: max size: 32 Kb  &lt;-- not recommended</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -3: max size: 16 Kb  &lt;-- probably not recommended</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -2: max size: 8 Kb   &lt;-- good</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -1: max size: 4 Kb   &lt;-- good</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Positive numbers mean store up to _exactly_ that number of elements</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># per list node.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The highest performing option is usually -2 (8 Kb size) or -1 (4 Kb size),</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># but if your use case is unique, adjust the settings as necessary.</span>
</span></span><span style="display:flex;"><span>list-max-ziplist-size -2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Lists may also be compressed.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Compress depth is the number of quicklist ziplist nodes from *each* side of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the list to *exclude* from compression.  The head and tail of the list</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># are always uncompressed for fast push/pop operations.  Settings are:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 0: disable all list compression</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1: depth 1 means &#34;don&#39;t start compressing until after 1 node into the list,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    going from either the head or tail&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    So: [head]-&gt;node-&gt;node-&gt;...-&gt;node-&gt;[tail]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    [head], [tail] will always be uncompressed; inner nodes will compress.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2: [head]-&gt;[next]-&gt;node-&gt;node-&gt;...-&gt;node-&gt;[prev]-&gt;[tail]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    2 here means: don&#39;t compress head or head-&gt;next or tail-&gt;prev or tail,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    but compress all nodes between them.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 3: [head]-&gt;[next]-&gt;[next]-&gt;node-&gt;node-&gt;...-&gt;node-&gt;[prev]-&gt;[prev]-&gt;[tail]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># etc.</span>
</span></span><span style="display:flex;"><span>list-compress-depth <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Sets have a special encoding in just one case: when a set is composed</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># of just strings that happen to be integers in radix 10 in the range</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># of 64 bit signed integers.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The following configuration setting sets the limit in the size of the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># set in order to use this special memory saving encoding.</span>
</span></span><span style="display:flex;"><span>set-max-intset-entries <span style="color:#0000cf;font-weight:bold">512</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Similarly to hashes and lists, sorted sets are also specially encoded in</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># order to save a lot of space. This encoding is only used when the length and</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># elements of a sorted set are below the following limits:</span>
</span></span><span style="display:flex;"><span>zset-max-ziplist-entries <span style="color:#0000cf;font-weight:bold">128</span>
</span></span><span style="display:flex;"><span>zset-max-ziplist-value <span style="color:#0000cf;font-weight:bold">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># HyperLogLog sparse representation bytes limit. The limit includes the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 16 bytes header. When an HyperLogLog using the sparse representation crosses</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># this limit, it is converted into the dense representation.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A value greater than 16000 is totally useless, since at that point the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># dense representation is more memory efficient.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The suggested value is ~ 3000 in order to have the benefits of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the space efficient encoding without slowing down too much PFADD,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># which is O(N) with the sparse encoding. The value can be raised to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ~ 10000 when CPU is not a concern, but space is, and the data set is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># composed of many HyperLogLogs with cardinality in the 0 - 15000 range.</span>
</span></span><span style="display:flex;"><span>hll-sparse-max-bytes <span style="color:#0000cf;font-weight:bold">3000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Active rehashing uses 1 millisecond every 100 milliseconds of CPU time in</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># order to help rehashing the main Redis hash table (the one mapping top-level</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># keys to values). The hash table implementation Redis uses (see dict.c)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># performs a lazy rehashing: the more operation you run into a hash table</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># that is rehashing, the more rehashing &#34;steps&#34; are performed, so if the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># server is idle the rehashing is never complete and some more memory is used</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># by the hash table.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The default is to use this millisecond 10 times every second in order to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># actively rehash the main dictionaries, freeing memory when possible.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If unsure:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># use &#34;activerehashing no&#34; if you have hard latency requirements and it is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># not a good thing in your environment that Redis can reply from time to time</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to queries with 2 milliseconds delay.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># use &#34;activerehashing yes&#34; if you don&#39;t have such hard requirements but</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># want to free memory asap when possible.</span>
</span></span><span style="display:flex;"><span>activerehashing yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The client output buffer limits can be used to force disconnection of clients</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># that are not reading data from the server fast enough for some reason (a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># common reason is that a Pub/Sub client can&#39;t consume messages as fast as the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># publisher can produce them).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The limit can be set differently for the three different classes of clients:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># normal -&gt; normal clients including MONITOR clients</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave  -&gt; slave clients</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pubsub -&gt; clients subscribed to at least one pubsub channel or pattern</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The syntax of every client-output-buffer-limit directive is the following:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># client-output-buffer-limit &lt;class&gt; &lt;hard limit&gt; &lt;soft limit&gt; &lt;soft seconds&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A client is immediately disconnected once the hard limit is reached, or if</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the soft limit is reached and remains reached for the specified number of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># seconds (continuously).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># So for instance if the hard limit is 32 megabytes and the soft limit is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 16 megabytes / 10 seconds, the client will get disconnected immediately</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># if the size of the output buffers reach 32 megabytes, but will also get</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># disconnected if the client reaches 16 megabytes and continuously overcomes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the limit for 10 seconds.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default normal clients are not limited because they don&#39;t receive data</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># without asking (in a push way), but just after a request, so only</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># asynchronous clients may create a scenario where data is requested faster</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># than it can read.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Instead there is a default limit for pubsub and slave clients, since</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># subscribers and slaves receive data in a push fashion.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Both the hard or the soft limit can be disabled by setting them to zero.</span>
</span></span><span style="display:flex;"><span>client-output-buffer-limit normal <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>client-output-buffer-limit slave 256mb 64mb <span style="color:#0000cf;font-weight:bold">60</span>
</span></span><span style="display:flex;"><span>client-output-buffer-limit pubsub 32mb 8mb <span style="color:#0000cf;font-weight:bold">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Client query buffers accumulate new commands. They are limited to a fixed</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># amount by default in order to avoid that a protocol desynchronization (for</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># instance due to a bug in the client) will lead to unbound memory usage in</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the query buffer. However you can configure it here if you have very special</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># needs, such us huge multi/exec requests or alike.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># client-query-buffer-limit 1gb</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># In the Redis protocol, bulk requests, that are, elements representing single</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># strings, are normally limited ot 512 mb. However you can change this limit</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># here.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># proto-max-bulk-len 512mb</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis calls an internal function to perform many background tasks, like</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># closing connections of clients in timeout, purging expired keys that are</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># never requested, and so forth.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Not all tasks are performed with the same frequency, but Redis checks for</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># tasks to perform according to the specified &#34;hz&#34; value.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># By default &#34;hz&#34; is set to 10. Raising the value will use more CPU when</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis is idle, but at the same time will make Redis more responsive when</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># there are many keys expiring at the same time, and timeouts may be</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># handled with more precision.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The range is between 1 and 500, however a value over 100 is usually not</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># a good idea. Most users should use the default of 10 and raise this up to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 100 only in environments where very low latency is required.</span>
</span></span><span style="display:flex;"><span>hz <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># When a child rewrites the AOF file, if the following option is enabled</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the file will be fsync-ed every 32 MB of data generated. This is useful</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in order to commit the file to the disk more incrementally and avoid</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># big latency spikes.</span>
</span></span><span style="display:flex;"><span>aof-rewrite-incremental-fsync yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Redis LFU eviction (see maxmemory setting) can be tuned. However it is a good</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># idea to start with the default settings and only change them after investigating</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># how to improve the performances and how the keys LFU change over time, which</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># is possible to inspect via the OBJECT FREQ command.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># There are two tunable parameters in the Redis LFU implementation: the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># counter logarithm factor and the counter decay time. It is important to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># understand what the two parameters mean before changing them.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The LFU counter is just 8 bits per key, it&#39;s maximum value is 255, so Redis</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># uses a probabilistic increment with logarithmic behavior. Given the value</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># of the old counter, when a key is accessed, the counter is incremented in</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># this way:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1. A random number R between 0 and 1 is extracted.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2. A probability P is calculated as 1/(old_value*lfu_log_factor+1).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 3. The counter is incremented only if R &lt; P.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The default lfu-log-factor is 10. This is a table of how the frequency</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># counter changes with a different number of accesses with different</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># logarithmic factors:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># +--------+------------+------------+------------+------------+------------+</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># | factor | 100 hits   | 1000 hits  | 100K hits  | 1M hits    | 10M hits   |</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># +--------+------------+------------+------------+------------+------------+</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># | 0      | 104        | 255        | 255        | 255        | 255        |</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># +--------+------------+------------+------------+------------+------------+</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># | 1      | 18         | 49         | 255        | 255        | 255        |</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># +--------+------------+------------+------------+------------+------------+</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># | 10     | 10         | 18         | 142        | 255        | 255        |</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># +--------+------------+------------+------------+------------+------------+</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># | 100    | 8          | 11         | 49         | 143        | 255        |</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># +--------+------------+------------+------------+------------+------------+</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># NOTE: The above table was obtained by running the following commands:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   redis-benchmark -n 1000000 incr foo</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   redis-cli object freq foo</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># NOTE 2: The counter initial value is 5 in order to give new objects a chance</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to accumulate hits.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The counter decay time is the time, in minutes, that must elapse in order</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for the key counter to be divided by two (or decremented if it has a value</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># less &lt;= 10).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The default value for the lfu-decay-time is 1. A Special value of 0 means to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># decay the counter every time it happens to be scanned.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># lfu-log-factor 10</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># lfu-decay-time 1</span>
</span></span></code></pre></div><h1 id="active-defragmentation">ACTIVE DEFRAGMENTATION</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">########################### ACTIVE DEFRAGMENTATION #######################</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># WARNING THIS FEATURE IS EXPERIMENTAL. However it was stress tested</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># even in production and manually tested by multiple engineers for some</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># time.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># What is active defragmentation?</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Active (online) defragmentation allows a Redis server to compact the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># spaces left between small allocations and deallocations of data in memory,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># thus allowing to reclaim back memory.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Fragmentation is a natural process that happens with every allocator (but</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># less so with Jemalloc, fortunately) and certain workloads. Normally a server</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># restart is needed in order to lower the fragmentation, or at least to flush</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># away all the data and create it again. However thanks to this feature</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># implemented by Oran Agra for Redis 4.0 this process can happen at runtime</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in an &#34;hot&#34; way, while the server is running.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Basically when the fragmentation is over a certain level (see the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># configuration options below) Redis will start to create new copies of the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># values in contiguous memory regions by exploiting certain specific Jemalloc</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># features (in order to understand if an allocation is causing fragmentation</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># and to allocate it in a better place), and at the same time, will release the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># old copies of the data. This process, repeated incrementally for all the keys</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># will cause the fragmentation to drop back to normal values.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Important things to understand:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1. This feature is disabled by default, and only works if you compiled Redis</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    to use the copy of Jemalloc we ship with the source code of Redis.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    This is the default with Linux builds.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 2. You never need to enable this feature if you don&#39;t have fragmentation</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    issues.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 3. Once you experience fragmentation, you can enable this feature when</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    needed with the command &#34;CONFIG SET activedefrag yes&#34;.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The configuration parameters are able to fine tune the behavior of the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># defragmentation process. If you are not sure about what they mean it is</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># a good idea to leave the defaults untouched.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Enabled active defragmentation</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># activedefrag yes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Minimum amount of fragmentation waste to start active defrag</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># active-defrag-ignore-bytes 100mb</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Minimum percentage of fragmentation to start active defrag</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># active-defrag-threshold-lower 10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Maximum percentage of fragmentation at which we use maximum effort</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># active-defrag-threshold-upper 100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Minimal effort for defrag in CPU percentage</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># active-defrag-cycle-min 25</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Maximal effort for defrag in CPU percentage</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># active-defrag-cycle-max 75</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ad720d1acea602e36850206b5c3201aa">10 - Memcached</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1a183ff43ce899c1c4a8db7481a3acaf">10.1 - Memcached的使用</h1>
    
	<h1 id="1-memcached简介">1. Memcached简介</h1>
<ul>
<li>
<p>Memcached是一个开源的，高性能，分布式内存对象缓存系统。</p>
</li>
<li>
<p>Memcached是一种基于内存的key-value存储，用来存储小块的任意数据（字符串、对象）。这些数据可以是数据库调用、API调用或者是页面渲染的结果。</p>
</li>
<li>
<p>一般的使用目的是，通过缓存数据库查询结果，减少数据库访问次数，以提高动态Web应用的速度、提高可扩展性。</p>
</li>
</ul>
<h2 id="1-1-特征">1.1. 特征</h2>
<p>memcached作为高速运行的分布式缓存服务器，具有以下的特点。</p>
<ul>
<li>协议简单</li>
<li>基于libevent的事件处理</li>
<li>内置内存存储方式</li>
<li>memcached不互相通信的分布式</li>
</ul>
<h1 id="2-安装与运行">2. 安装与运行</h1>
<h2 id="2-1-自动安装">2.1. 自动安装</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For Redhat/Fedora</span>
</span></span><span style="display:flex;"><span>yum install -y memcached
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For Debian or Ubuntu</span>
</span></span><span style="display:flex;"><span>apt-get install memcached
</span></span></code></pre></div><h2 id="2-2-源码安装">2.2. 源码安装</h2>
<p>安装指定版本的Memcached可以从 <a href="https://github.com/memcached/memcached/wiki/ReleaseNotes">https://github.com/memcached/memcached/wiki/ReleaseNotes</a> 地址下载。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Memcached depends on libevent</span>
</span></span><span style="display:flex;"><span>yum install libevent-devel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># install </span>
</span></span><span style="display:flex;"><span>wget https://memcached.org/latest
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>you might need to rename the file<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>tar -zxf memcached-1.x.x.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> memcached-1.x.x
</span></span><span style="display:flex;"><span>./configure --prefix<span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/memcached
</span></span><span style="display:flex;"><span>make <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> make <span style="color:#204a87">test</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo make install
</span></span></code></pre></div><p><strong>问题</strong></p>
<p>如遇以下报错，可再执行<code>make install</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Signal handled: Interrupt.
</span></span><span style="display:flex;"><span>ok <span style="color:#0000cf;font-weight:bold">51</span> - shutdown
</span></span><span style="display:flex;"><span>ok <span style="color:#0000cf;font-weight:bold">52</span> - stop_server
</span></span><span style="display:flex;"><span>/bin/sh:行3: prove: 未找到命令
</span></span><span style="display:flex;"><span>make: *** <span style="color:#ce5c00;font-weight:bold">[</span>test<span style="color:#ce5c00;font-weight:bold">]</span> Error <span style="color:#0000cf;font-weight:bold">127</span>
</span></span></code></pre></div><h2 id="2-3-验证">2.3. 验证</h2>
<p>确认是否安装成功，可执行以下命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/local/memcached/bin/memcached -h      
</span></span></code></pre></div><h2 id="2-4-运行">2.4. 运行</h2>
<h3 id="2-4-1-前台运行">2.4.1. 前台运行</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/local/memcached/bin/memcached -p <span style="color:#0000cf;font-weight:bold">11211</span> -m 64m -vv
</span></span></code></pre></div><h3 id="2-4-2-后台运行">2.4.2. 后台运行</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/local/memcached/bin/memcached -p <span style="color:#0000cf;font-weight:bold">11211</span> -m 64m -d -c <span style="color:#0000cf;font-weight:bold">102400</span> -t <span style="color:#0000cf;font-weight:bold">8</span> -P /tmp/memcached.pid 
</span></span></code></pre></div><h2 id="2-5-连接">2.5. 连接</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ telnet 127.0.0.1 <span style="color:#0000cf;font-weight:bold">11211</span>
</span></span><span style="display:flex;"><span>Trying 127.0.0.1...
</span></span><span style="display:flex;"><span>Connected to 127.0.0.1.
</span></span><span style="display:flex;"><span>Escape character is <span style="color:#4e9a06">&#39;^]&#39;</span>.
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> foo <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">3</span>                                                   保存命令
</span></span><span style="display:flex;"><span>bar                                                             数据
</span></span><span style="display:flex;"><span>STORED                                                          结果
</span></span><span style="display:flex;"><span>get foo                                                         取得命令
</span></span><span style="display:flex;"><span>VALUE foo <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">3</span>                                                   数据
</span></span><span style="display:flex;"><span>bar                                                             数据
</span></span><span style="display:flex;"><span>END                                                             结束行
</span></span><span style="display:flex;"><span>quit                                                            退出
</span></span></code></pre></div><h1 id="3-memcached运行参数">3. Memcached运行参数</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># /usr/local/memcached/bin/memcached -h</span>
</span></span><span style="display:flex;"><span>memcached 1.5.12
</span></span><span style="display:flex;"><span>-p, --port<span style="color:#ce5c00;font-weight:bold">=</span>&lt;num&gt;          TCP port to listen on <span style="color:#ce5c00;font-weight:bold">(</span>default: 11211<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-U, --udp-port<span style="color:#ce5c00;font-weight:bold">=</span>&lt;num&gt;      UDP port to listen on <span style="color:#ce5c00;font-weight:bold">(</span>default: 0, off<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-s, --unix-socket<span style="color:#ce5c00;font-weight:bold">=</span>&lt;file&gt;  UNIX socket to listen on <span style="color:#ce5c00;font-weight:bold">(</span>disables network support<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-A, --enable-shutdown     <span style="color:#204a87">enable</span> ascii <span style="color:#4e9a06">&#34;shutdown&#34;</span> <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>-a, --unix-mask<span style="color:#ce5c00;font-weight:bold">=</span>&lt;mask&gt;    access mask <span style="color:#204a87;font-weight:bold">for</span> UNIX socket, in octal <span style="color:#ce5c00;font-weight:bold">(</span>default: 0700<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-l, --listen<span style="color:#ce5c00;font-weight:bold">=</span>&lt;addr&gt;       interface to listen on <span style="color:#ce5c00;font-weight:bold">(</span>default: INADDR_ANY<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-d, --daemon              run as a daemon
</span></span><span style="display:flex;"><span>-r, --enable-coredumps    maximize core file limit
</span></span><span style="display:flex;"><span>-u, --user<span style="color:#ce5c00;font-weight:bold">=</span>&lt;user&gt;         assume identity of &lt;username&gt; <span style="color:#ce5c00;font-weight:bold">(</span>only when run as root<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-m, --memory-limit<span style="color:#ce5c00;font-weight:bold">=</span>&lt;num&gt;  item memory in megabytes <span style="color:#ce5c00;font-weight:bold">(</span>default: <span style="color:#0000cf;font-weight:bold">64</span> MB<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-M, --disable-evictions   <span style="color:#204a87;font-weight:bold">return</span> error on memory exhausted instead of evicting
</span></span><span style="display:flex;"><span>-c, --conn-limit<span style="color:#ce5c00;font-weight:bold">=</span>&lt;num&gt;    max simultaneous connections <span style="color:#ce5c00;font-weight:bold">(</span>default: 1024<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-k, --lock-memory         lock down all paged memory
</span></span><span style="display:flex;"><span>-v, --verbose             verbose <span style="color:#ce5c00;font-weight:bold">(</span>print errors/warnings <span style="color:#204a87;font-weight:bold">while</span> in event loop<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-vv                       very verbose <span style="color:#ce5c00;font-weight:bold">(</span>also print client commands/responses<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-vvv                      extremely verbose <span style="color:#ce5c00;font-weight:bold">(</span>internal state transitions<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-h, --help                print this <span style="color:#204a87">help</span> and <span style="color:#204a87">exit</span>
</span></span><span style="display:flex;"><span>-i, --license             print memcached and libevent license
</span></span><span style="display:flex;"><span>-V, --version             print version and <span style="color:#204a87">exit</span>
</span></span><span style="display:flex;"><span>-P, --pidfile<span style="color:#ce5c00;font-weight:bold">=</span>&lt;file&gt;      save PID in &lt;file&gt;, only used with -d option
</span></span><span style="display:flex;"><span>-f, --slab-growth-factor<span style="color:#ce5c00;font-weight:bold">=</span>&lt;num&gt; chunk size growth factor <span style="color:#ce5c00;font-weight:bold">(</span>default: 1.25<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-n, --slab-min-size<span style="color:#ce5c00;font-weight:bold">=</span>&lt;bytes&gt; min space used <span style="color:#204a87;font-weight:bold">for</span> key+value+flags <span style="color:#ce5c00;font-weight:bold">(</span>default: 48<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-L, --enable-largepages  try to use large memory pages <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">if</span> available<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-D &lt;char&gt;     Use &lt;char&gt; as the delimiter between key prefixes and IDs.
</span></span><span style="display:flex;"><span>              This is used <span style="color:#204a87;font-weight:bold">for</span> per-prefix stats reporting. The default is
</span></span><span style="display:flex;"><span>              <span style="color:#4e9a06">&#34;:&#34;</span> <span style="color:#ce5c00;font-weight:bold">(</span>colon<span style="color:#ce5c00;font-weight:bold">)</span>. If this option is specified, stats collection
</span></span><span style="display:flex;"><span>              is turned on automatically<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">if</span> not, <span style="color:#204a87;font-weight:bold">then</span> it may be turned on
</span></span><span style="display:flex;"><span>              by sending the <span style="color:#4e9a06">&#34;stats detail on&#34;</span> <span style="color:#204a87">command</span> to the server.
</span></span><span style="display:flex;"><span>-t, --threads<span style="color:#ce5c00;font-weight:bold">=</span>&lt;num&gt;       number of threads to use <span style="color:#ce5c00;font-weight:bold">(</span>default: 4<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-R, --max-reqs-per-event  maximum number of requests per event, limits the
</span></span><span style="display:flex;"><span>                          requests processed per connection to prevent
</span></span><span style="display:flex;"><span>                          starvation <span style="color:#ce5c00;font-weight:bold">(</span>default: 20<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-C, --disable-cas         disable use of CAS
</span></span><span style="display:flex;"><span>-b, --listen-backlog<span style="color:#ce5c00;font-weight:bold">=</span>&lt;num&gt; <span style="color:#204a87">set</span> the backlog queue limit <span style="color:#ce5c00;font-weight:bold">(</span>default: 1024<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-B, --protocol<span style="color:#ce5c00;font-weight:bold">=</span>&lt;name&gt;     protocol - one of ascii, binary, or auto <span style="color:#ce5c00;font-weight:bold">(</span>default<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-I, --max-item-size<span style="color:#ce5c00;font-weight:bold">=</span>&lt;num&gt; adjusts max item size
</span></span><span style="display:flex;"><span>                          <span style="color:#ce5c00;font-weight:bold">(</span>default: 1mb, min: 1k, max: 128m<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>-F, --disable-flush-all   disable flush_all <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>-X, --disable-dumping     disable stats cachedump and lru_crawler metadump
</span></span><span style="display:flex;"><span>-o, --extended            comma separated list of extended options
</span></span><span style="display:flex;"><span>                          most options have a <span style="color:#4e9a06">&#39;no_&#39;</span> prefix to disable
</span></span><span style="display:flex;"><span>   - maxconns_fast:       immediately close new connections after limit
</span></span><span style="display:flex;"><span>   - hashpower:           an integer multiplier <span style="color:#204a87;font-weight:bold">for</span> how large the <span style="color:#204a87">hash</span>
</span></span><span style="display:flex;"><span>                          table should be. normally grows at runtime.
</span></span><span style="display:flex;"><span>                          <span style="color:#204a87">set</span> based on <span style="color:#4e9a06">&#34;STAT hash_power_level&#34;</span>
</span></span><span style="display:flex;"><span>   - tail_repair_time:    <span style="color:#204a87">time</span> in seconds <span style="color:#204a87;font-weight:bold">for</span> how long to <span style="color:#204a87">wait</span> before
</span></span><span style="display:flex;"><span>                          forcefully killing LRU tail item.
</span></span><span style="display:flex;"><span>                          disabled by default<span style="color:#000;font-weight:bold">;</span> very dangerous option.
</span></span><span style="display:flex;"><span>   - hash_algorithm:      the <span style="color:#204a87">hash</span> table algorithm
</span></span><span style="display:flex;"><span>                          default is murmur3 hash. options: jenkins, murmur3
</span></span><span style="display:flex;"><span>   - lru_crawler:         <span style="color:#204a87">enable</span> LRU Crawler background thread
</span></span><span style="display:flex;"><span>   - lru_crawler_sleep:   microseconds to sleep between items
</span></span><span style="display:flex;"><span>                          default is 100.
</span></span><span style="display:flex;"><span>   - lru_crawler_tocrawl: max items to crawl per slab per run
</span></span><span style="display:flex;"><span>                          default is <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">(</span>unlimited<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   - lru_maintainer:      <span style="color:#204a87">enable</span> new LRU system + background thread
</span></span><span style="display:flex;"><span>   - hot_lru_pct:         pct of slab memory to reserve <span style="color:#204a87;font-weight:bold">for</span> hot lru.
</span></span><span style="display:flex;"><span>                          <span style="color:#ce5c00;font-weight:bold">(</span>requires lru_maintainer<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   - warm_lru_pct:        pct of slab memory to reserve <span style="color:#204a87;font-weight:bold">for</span> warm lru.
</span></span><span style="display:flex;"><span>                          <span style="color:#ce5c00;font-weight:bold">(</span>requires lru_maintainer<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   - hot_max_factor:      items idle &gt; cold lru age * drop from hot lru.
</span></span><span style="display:flex;"><span>   - warm_max_factor:     items idle &gt; cold lru age * this drop from warm.
</span></span><span style="display:flex;"><span>   - temporary_ttl:       TTL<span style="color:#4e9a06">&#39;s below get separate LRU, can&#39;</span>t be evicted.
</span></span><span style="display:flex;"><span>                          <span style="color:#ce5c00;font-weight:bold">(</span>requires lru_maintainer<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   - idle_timeout:        timeout <span style="color:#204a87;font-weight:bold">for</span> idle connections
</span></span><span style="display:flex;"><span>   - slab_chunk_max:      <span style="color:#ce5c00;font-weight:bold">(</span>EXPERIMENTAL<span style="color:#ce5c00;font-weight:bold">)</span> maximum slab size. use extreme care.
</span></span><span style="display:flex;"><span>   - watcher_logbuf_size: size in kilobytes of per-watcher write buffer.
</span></span><span style="display:flex;"><span>   - worker_logbuf_size:  size in kilobytes of per-worker-thread buffer
</span></span><span style="display:flex;"><span>                          <span style="color:#204a87">read</span> by background thread, <span style="color:#204a87;font-weight:bold">then</span> written to watchers.
</span></span><span style="display:flex;"><span>   - track_sizes:         <span style="color:#204a87">enable</span> dynamic reports <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#4e9a06">&#39;stats sizes&#39;</span> command.
</span></span><span style="display:flex;"><span>   - no_inline_ascii_resp: save up to <span style="color:#0000cf;font-weight:bold">24</span> bytes per item.
</span></span><span style="display:flex;"><span>                           small perf hit in ASCII, no perf difference in
</span></span><span style="display:flex;"><span>                           binary protocol. speeds up all sets.
</span></span><span style="display:flex;"><span>   - no_hashexpand:       disables <span style="color:#204a87">hash</span> table expansion <span style="color:#ce5c00;font-weight:bold">(</span>dangerous<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   - modern:              enables options which will be default in future.
</span></span><span style="display:flex;"><span>             currently: nothing
</span></span><span style="display:flex;"><span>   - no_modern:           uses defaults of previous major version <span style="color:#ce5c00;font-weight:bold">(</span>1.4.x<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>常用参数：</p>
<ul>
<li>-d是启动一个守护进程；</li>
<li>-m是分配给Memcache使用的内存数量，单位是MB；</li>
<li>-u是运行Memcache的用户；</li>
<li>-l是监听的服务器IP地址，可以有多个地址；</li>
<li>-p是设置Memcache监听的端口，，最好是1024以上的端口；</li>
<li>-c是最大运行的并发连接数，默认是1024；</li>
<li>-t是线程数，默认为4；</li>
<li>-P是设置保存Memcache的pid文件。</li>
</ul>
<p>参考文章：</p>
<ul>
<li><a href="https://github.com/memcached/memcached/wiki/Overview">https://github.com/memcached/memcached/wiki/Overview</a></li>
<li><a href="https://github.com/memcached/memcached/wiki/Install">https://github.com/memcached/memcached/wiki/Install</a></li>
<li><a href="http://www.runoob.com/memcached/memcached-tutorial.html">http://www.runoob.com/memcached/memcached-tutorial.html</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c28ae96d748e302a7642d5734f49cfad">10.2 - Memcached命令</h1>
    
	<h1 id="1-memcached-命令">1. Memcached 命令</h1>
<h2 id="1-1-存储命令">1.1. 存储命令</h2>
<h3 id="1-1-1-常用命令">1.1.1. 常用命令</h3>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>set</td>
<td>新增或更新</td>
</tr>
<tr>
<td>add</td>
<td>新增</td>
</tr>
<tr>
<td>replace</td>
<td>替换</td>
</tr>
<tr>
<td>append</td>
<td>在后面追加</td>
</tr>
<tr>
<td>prepend</td>
<td>在前面追加</td>
</tr>
<tr>
<td>cas</td>
<td>检查并设置</td>
</tr>
</tbody>
</table>
<p>以上几个命令语法格式相似，以<code>set</code>为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">set</span> key flags exptime bytes <span style="color:#ce5c00;font-weight:bold">[</span>noreply<span style="color:#ce5c00;font-weight:bold">]</span> 
</span></span><span style="display:flex;"><span>value 
</span></span></code></pre></div><p>参数说明如下：</p>
<ul>
<li>**key：**键值 key-value 结构中的 key，用于查找缓存值。</li>
<li><strong>flags</strong>：可以包括键值对的整型参数，客户机使用它存储关于键值对的额外信息 。</li>
<li><strong>exptime</strong>：在缓存中保存键值对的时间长度（以秒为单位，0 表示永远）</li>
<li><strong>bytes</strong>：在缓存中存储的字节数</li>
<li><strong>noreply（可选）</strong>： 该参数告知服务器不需要返回数据</li>
<li><strong>value</strong>：存储的值（始终位于第二行）（可直接理解为key-value结构中的value）</li>
</ul>
<p>实例：</p>
<ul>
<li>key → runoob</li>
<li>flag → 0</li>
<li>exptime → 900 (以秒为单位)</li>
<li>bytes → 9 (数据存储的字节数)</li>
<li>value → memcached</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">set</span> runoob <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">900</span> <span style="color:#0000cf;font-weight:bold">9</span>
</span></span><span style="display:flex;"><span>memcached
</span></span><span style="display:flex;"><span>STORED
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>get runoob
</span></span><span style="display:flex;"><span>VALUE runoob <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">9</span>
</span></span><span style="display:flex;"><span>memcached
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>END
</span></span></code></pre></div><p>输出：</p>
<p>如果数据设置成功，则输出：</p>
<pre tabindex="0"><code>STORED
</code></pre><p>输出信息说明：</p>
<ul>
<li><strong>STORED</strong>：保存成功后输出。</li>
<li><strong>ERROR</strong>：在保存失败后输出。</li>
</ul>
<h3 id="1-1-2-cas命令">1.1.2. cas命令</h3>
<p>Memcached CAS（Check-And-Set 或 Compare-And-Swap） 命令用于执行一个&quot;检查并设置&quot;的操作。</p>
<p>它仅在当前客户端最后一次取值后，该key 对应的值没有被其他客户端修改的情况下， 才能够将值写入。</p>
<p>检查是通过cas_token参数进行的， 这个参数是Memcach指定给已经存在的元素的一个唯一的64位值。</p>
<p>语法：</p>
<blockquote>
<p>比以上命令多了一个<code>unique_cas_token</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cas key flags exptime bytes unique_cas_token <span style="color:#ce5c00;font-weight:bold">[</span>noreply<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>value
</span></span></code></pre></div><p>参数说明如下：</p>
<ul>
<li><strong>key</strong>：键值 key-value 结构中的 key，用于查找缓存值。</li>
<li><strong>flags</strong>：可以包括键值对的整型参数，客户机使用它存储关于键值对的额外信息 。</li>
<li><strong>exptime</strong>：在缓存中保存键值对的时间长度（以秒为单位，0 表示永远）</li>
<li><strong>bytes</strong>：在缓存中存储的字节数</li>
<li><strong>unique_cas_token</strong>通过 gets 命令获取的一个唯一的64位值。</li>
<li><strong>noreply（可选）</strong>： 该参数告知服务器不需要返回数据</li>
<li><strong>value</strong>：存储的值（始终位于第二行）（可直接理解为key-value结构中的value）</li>
</ul>
<p><strong>unique_cas_token</strong>通过<strong>gets</strong>命令获取。</p>
<h2 id="1-2-查找命令">1.2. 查找命令</h2>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>get</td>
<td>获取一个或多个key</td>
</tr>
<tr>
<td>gets</td>
<td>获取一个或多个cas token</td>
</tr>
<tr>
<td>delete</td>
<td>删除已存在的key</td>
</tr>
<tr>
<td>incr/decr</td>
<td>对已存在的 key(键) 的数字值进行自增或自减操作</td>
</tr>
</tbody>
</table>
<h2 id="1-3-统计命令">1.3. 统计命令</h2>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>stats</td>
<td>用于返回统计信息例如 PID(进程号)、版本号、连接数等。</td>
</tr>
<tr>
<td>stats items</td>
<td>用于显示各个 slab 中 item 的数目和存储时长(最后一次访问距离现在的秒数)。</td>
</tr>
<tr>
<td>stats slabs</td>
<td>用于显示各个slab的信息，包括chunk的大小、数目、使用情况等。</td>
</tr>
<tr>
<td>stats sizes</td>
<td>用于显示所有item的大小和个数。</td>
</tr>
<tr>
<td>flush_all</td>
<td>用于清理缓存中的所有 <strong>key=&gt;value(键=&gt;值)</strong> 对。</td>
</tr>
</tbody>
</table>
<p>参考文章：</p>
<ul>
<li><a href="http://www.runoob.com/memcached/memcached-tutorial.html">http://www.runoob.com/memcached/memcached-tutorial.html</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-153b18296e29e533d7c39d91a8a169f9">11 - Nginx</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-2b21d9995de5be0bc344a9f01ba118e4">11.1 - Nginx的部署与配置</h1>
    
	<h1 id="1-部署">1. 部署</h1>
<h2 id="1-1-使用安装包的方式">1.1. 使用安装包的方式</h2>
<p>rpm -ivh nginx-xxx.rpm</p>
<h2 id="1-2-使用源代码安装">1.2. 使用源代码安装</h2>
<h3 id="1-2-1-下载源码包">1.2.1. 下载源码包</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget http://blob.wae.haplat.net/nginx/nginx-1.9.13.tar.gz
</span></span></code></pre></div><h2 id="1-2-2-创建临时目录并解压源码包">1.2.2. 创建临时目录并解压源码包</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir <span style="color:#000">$HOME</span>/build
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> <span style="color:#000">$HOME</span>/build <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> tar zxvf nginx-&lt;version-number&gt;.tar.gz
</span></span></code></pre></div><h3 id="1-2-3-编译并安装">1.2.3. 编译并安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> <span style="color:#204a87">cd</span> <span style="color:#000">$HOME</span>/build/nginx-&lt;version-number&gt;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>./configure <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--prefix<span style="color:#ce5c00;font-weight:bold">=</span>/etc/nginx <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--sbin-path<span style="color:#ce5c00;font-weight:bold">=</span>/usr/sbin/nginx <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--conf-path<span style="color:#ce5c00;font-weight:bold">=</span>/etc/nginx/nginx.conf <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>...
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#&lt;更多配置项见以下说明&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>make <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> make install
</span></span></code></pre></div><h3 id="1-2-4-配置项">1.2.4. 配置项</h3>
<h4 id="1-2-4-1-通用配置项">1.2.4.1. 通用配置项</h4>
<table>
<thead>
<tr>
<th>配置选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>--prefix=<path></td>
<td>nginx安装的根路径，所有其他的路径都要依赖与该选项</td>
</tr>
<tr>
<td>--sbin-path=<path></td>
<td>nginx二进制文件的路径，如果没有指定则会依赖于--prefix</td>
</tr>
<tr>
<td>--conf-path=<path></td>
<td>如果在命令行中没有指定配置文件，则通过该配置项去查找配置文件</td>
</tr>
<tr>
<td>--error-log-path=<path></td>
<td>指定错误文件的路径</td>
</tr>
<tr>
<td>--pid-path=<path></td>
<td>指定的文件将会写入nginx master进程的pid，通常在/var/run下</td>
</tr>
<tr>
<td>--lock-path=<path></td>
<td>共享存储器互斥锁文件的路径</td>
</tr>
<tr>
<td>--user=<user></td>
<td>worker进程运行的用户</td>
</tr>
<tr>
<td>--group=<group></td>
<td>worker进程运行的组</td>
</tr>
<tr>
<td>--with-file-aio</td>
<td>启动异步I/O</td>
</tr>
<tr>
<td>--with-debug</td>
<td>启用调试日志，生产环境不推荐配置</td>
</tr>
</tbody>
</table>
<h4 id="1-2-4-2-优化配置项">1.2.4.2. 优化配置项</h4>
<table>
<thead>
<tr>
<th>配置选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>--with-cc=<path></td>
<td>如果想设置一个不在默认PATH下的C编译器</td>
</tr>
<tr>
<td>--with-cpp=<path></td>
<td>设置C预处理器的相应路径</td>
</tr>
<tr>
<td>--with-cc-opt=<options></td>
<td>指定必要的include文件路径</td>
</tr>
<tr>
<td>--with-ld-opt=<options></td>
<td>包含连接器库的路径和运行路径</td>
</tr>
<tr>
<td>--with-cpu-opt=<cpu></td>
<td>通过该选项为特定的CPU构建nginx</td>
</tr>
</tbody>
</table>
<h4 id="1-2-4-3-http模块的配置项">1.2.4.3. http模块的配置项</h4>
<table>
<thead>
<tr>
<th>配置选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>--without-http-cache</td>
<td>在使用upstream模块时，nginx能够配置本地缓存内容，该选项可以禁用缓存</td>
</tr>
<tr>
<td>--with-http_perl_module</td>
<td>nginx配置能够扩展使用perl代码。该项启用这个模块，但会降低性能</td>
</tr>
<tr>
<td>--with-perl_modules_path=<path></td>
<td>对于额外嵌入的perl模块，该选项指定该perl解析器的路径</td>
</tr>
<tr>
<td>--with-perl=<path></td>
<td>如果在默认的路径中找不到perl则指定perl（5.6版本以上）的路径</td>
</tr>
<tr>
<td>--http-log-path=<path></td>
<td>http访问日志的默认路径</td>
</tr>
<tr>
<td>--http-client-body-temp-path=<path></td>
<td>从客户端收到请求后，该项用于作为请求体临时存放的目录</td>
</tr>
<tr>
<td>--http-proxy-temp-path=<path></td>
<td>在使用代理后，通过该项设置存放临时文件路径</td>
</tr>
<tr>
<td>--http-fastcgi-temp-path=<path></td>
<td>设置FastCGI临时文件的目录</td>
</tr>
<tr>
<td>--http-uwsgi-temp-path=<path></td>
<td>设置uWSGI临时文件的目录</td>
</tr>
<tr>
<td>--http-scgi-temp-path=<path></td>
<td>设置SCGI临时文件的目录</td>
</tr>
</tbody>
</table>
<h4 id="1-2-4-4-其他模块额外配置项">1.2.4.4. 其他模块额外配置项</h4>
<p>默认没有安装这些模块，可以通过--with-<module-name>_module来启用相应的模块功能。</p>
<table>
<thead>
<tr>
<th>配置选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>--with-http_ssl_module</td>
<td>如果需要对流量进行加密，可以使用该选项，再URLs中开始部分将会是https(需要OpenSSL库)</td>
</tr>
<tr>
<td>--with-http_realip_module</td>
<td>如果nginx在七层负载均衡器或者其他设备之后，它们将Http头中的客户端IP地址传递，则需要启用该模块，再多个客户处于一个IP地址的情况下使用</td>
</tr>
<tr>
<td>--with-http_addition_module</td>
<td>该模块作为输出过滤器，使能够在请求经过一个location前或后时在该location本身添加内容</td>
</tr>
<tr>
<td>--with-http_xslt_module</td>
<td>该模块用于处理XML响应转换，基于一个或多个XSLT格式</td>
</tr>
<tr>
<td>--with-http_image_filter_module</td>
<td>该模块被作为图像过滤器使用，在将图像投递到客户之前进行处理（需要libgd库）</td>
</tr>
<tr>
<td>--with-http_geoip_module</td>
<td>使用该模块，能够设置各种变量以便在配置文件中的区段使用，基于地理位置查找客户端IP地址</td>
</tr>
<tr>
<td>--with-http_sub_module</td>
<td>该模块实现替代过滤，在响应中用一个字符串替代另一个字符串</td>
</tr>
<tr>
<td>--with-heep_dav_module</td>
<td>启用这个模块将激活使用WebDAV的配置指令。</td>
</tr>
<tr>
<td>--with-http_flv_module</td>
<td>如果需要提供Flash流媒体视频文件，那么该模块将会提供伪流媒体</td>
</tr>
<tr>
<td>--with-http_mp4_module</td>
<td>这个模块支持H.264/AAC文件伪流媒体</td>
</tr>
<tr>
<td>--with-http_gzip_static_module</td>
<td>当被调用的资源没有.gz结尾格式的文件时，如果想支持发送预压缩版本的静态文件，那么使用该模块</td>
</tr>
<tr>
<td>--with-http_gunzip_module</td>
<td>对于不支持gzip编码的客户，该模块用于为客户解压缩预压缩内容</td>
</tr>
<tr>
<td>--with-http_random_index_module</td>
<td>如果你想提供从一个目录中随机选择文件的索引文件，那么该模块需要激活</td>
</tr>
<tr>
<td>--with-http_secure_link_module</td>
<td>该模块提供一种机制，它会将一个哈希值链接到一个URL中，因此只有那些使用正确密码能够计算链接</td>
</tr>
<tr>
<td>--with-http_stub_status_module</td>
<td>启用这个模块后会收集Nginx自身的状态信息。输出的状态信息可以使用RRDtool或类似的东西绘制成图</td>
</tr>
</tbody>
</table>
<h1 id="2-配置">2. 配置</h1>
<p>配置文件一般为/etc/nginx/nginx.conf或/usr/local/nginx/conf/nginx.conf。</p>
<h2 id="2-1-基本配置格式">2.1. 基本配置格式</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&lt;section&gt;<span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    &lt;directive&gt; &lt;parameters&gt;<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>每一个指令行由分号结束，大括号{}表示一个新的上下文。</p>
<h2 id="2-2-nginx全局配置参数">2.2. Nginx全局配置参数</h2>
<p>全局配置指令</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>main模块</td>
<td>user</td>
<td>配置worker进程的用户和组，如果忽略group，则group等于指定的用户的所属组</td>
</tr>
<tr>
<td>worker_processes</td>
<td>指定worker进程的启动数量，可将其设置为可用的CPU内核数，若为auto为自动检测</td>
<td></td>
</tr>
<tr>
<td>error_log</td>
<td>所有错误的写入文件，第二个参数指定错误的级别（debug，info，notice，warn，error，crit，alert，emerg）</td>
<td></td>
</tr>
<tr>
<td>pid</td>
<td>设置主进程IP的文件</td>
<td></td>
</tr>
<tr>
<td>events模块</td>
<td>use</td>
<td>用于设置使用什么样的连接方法</td>
</tr>
<tr>
<td>worker_connections</td>
<td>用于配置一个工作进程能够接受的并发连接最大数。包括客户连接和向上游服务器的连接。</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="2-3-使用include文件">2.3. 使用include文件</h2>
<p>include文件可以在任何地方以增强配置文件的可读性，使用include文件要确保被包含文件自身正确的nginx语法，即配置指令和块，然后指定这些文件的路径。</p>
<p>include /etc/nginx/mime.types;</p>
<p>若使用通配符则表示通配的多个文件，若没有给定全路径则依据主配置文件路径进行搜索。</p>
<p>include /etc/nginx/conf.d/*.conf</p>
<p>测试配置文件(包括include的配置文件)语法：</p>
<p>nginx -t -c {path-to-nginx.conf}</p>
<h2 id="2-4-配置说明">2.4. 配置说明</h2>
<h3 id="2-4-1-main模块">2.4.1. main模块</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#main模块类似main函数包含其他子模块，非模块配置项(包括模块内)分号结尾，子模块配置花括号结尾</span>
</span></span><span style="display:flex;"><span>user nobady<span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">#一般按默认设置</span>
</span></span><span style="display:flex;"><span>pid /var/run/nginx.pid<span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">#进程标识符存放路径，一般按默认设置</span>
</span></span><span style="display:flex;"><span>worker_processes auto<span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">#nginx对外提供web服务时的worder进程数，可将其设置为可用的CPU内核数，auto为自动检测</span>
</span></span><span style="display:flex;"><span>worker_rlimit_nofile 100000<span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic"># 更改worker进程的最大打开文件数限制</span>
</span></span><span style="display:flex;"><span>error_log logs/error.log  info<span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">#错误日志存放路径</span>
</span></span><span style="display:flex;"><span>keepalive_timeout 60<span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">#keepalive_timeout 60;</span>
</span></span><span style="display:flex;"><span>events<span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">#见events模块</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>http<span style="color:#ce5c00;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">#见http模块</span>
</span></span><span style="display:flex;"><span>  server<span style="color:#ce5c00;font-weight:bold">{</span> 
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    location /<span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>mail<span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">#见mail模块</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-4-2-events模块">2.4.2. events模块</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>events <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  worker_connections 2048<span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">#设置可由一个worker进程同时打开的最大连接数</span>
</span></span><span style="display:flex;"><span>  multi_accept on<span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">#告诉nginx收到一个新连接通知后接受尽可能多的连接</span>
</span></span><span style="display:flex;"><span>  use epoll<span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">#设置用于复用客户端线程的轮询方法。Linux 2.6+：使用epoll；*BSD：使用kqueue。</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-4-3-http模块">2.4.3. http模块</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>http <span style="color:#ce5c00;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">#http模块</span>
</span></span><span style="display:flex;"><span>    server <span style="color:#ce5c00;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">#server模块，http服务上的虚拟主机， server 当做对应一个域名进行的配置</span>
</span></span><span style="display:flex;"><span>        listen          80<span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">#配置监听端口</span>
</span></span><span style="display:flex;"><span>        server_name     www.linuxidc.com<span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">#配置访问域名</span>
</span></span><span style="display:flex;"><span>        access_log      logs/linuxidc.access.log main<span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">#指定日志文件的存放路径</span>
</span></span><span style="display:flex;"><span>        index index.html<span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">#默认访问页面</span>
</span></span><span style="display:flex;"><span>        root  /var/www/androidj.com/htdocs<span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic"># root 是指将本地的一个文件夹作为所有 url 请求的根路径</span>
</span></span><span style="display:flex;"><span>        upstream backend <span style="color:#ce5c00;font-weight:bold">{</span>   <span style="color:#8f5902;font-style:italic">#反向代理的后端机器，实现负载均衡</span>
</span></span><span style="display:flex;"><span>            ip_hash<span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">#指明了我们均衡的方式是按照用户的 ip 地址进行分配</span>
</span></span><span style="display:flex;"><span>            server backend1.example.com<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            server backend2.example.com<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            server backend3.example.com<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            server backend4.example.com<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        location / <span style="color:#ce5c00;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">#location 是在一个域名下对更精细的路径进行配置</span>
</span></span><span style="display:flex;"><span>            proxy_pass http://backend<span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">#反向代理到后端机器</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    server <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        listen          80<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        server_name     www.Androidj.com<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        access_log      logs/androidj.access.log main<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        location / <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            index index.html<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            root  /var/www/androidj.com/htdocs<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-4-4-mail模块">2.4.4. mail模块</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mail <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    auth_http  127.0.0.1:80/auth.php<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    pop3_capabilities  <span style="color:#4e9a06">&#34;TOP&#34;</span>  <span style="color:#4e9a06">&#34;USER&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    imap_capabilities  <span style="color:#4e9a06">&#34;IMAP4rev1&#34;</span>  <span style="color:#4e9a06">&#34;UIDPLUS&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    server <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        listen     110<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        protocol   pop3<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        proxy      on<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    server <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        listen      25<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        protocol    smtp<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        proxy       on<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        smtp_auth   login plain<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        xclient     off<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3bd1e1c86d00c1b0ad09142914f775f6">11.2 - Nginx作为反向代理</h1>
    
	<h1 id="1-反向代理简介">1. 反向代理简介</h1>
<p>Nginx可以作为反向代理，接收客户端的请求，并向上游服务器发起新的请求。该请求可以根据客户端请求的URI，客户机参数或其他逻辑进行拆分，原始URL中的任何部分可以以这种方式进行转换。</p>
<h2 id="1-1-代理模块指令">1.1. 代理模块指令</h2>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>proxy_connect_timeout</td>
<td>Nginx从接受到请求到连接至上游服务器的最长等待时间</td>
</tr>
<tr>
<td>proxy_cookie_domain</td>
<td>替代从上游服务器来的Set-Cookie头的域domain</td>
</tr>
<tr>
<td>proxy_cookie_path</td>
<td>替代从上游服务器来的Set-Cookie头的path属性</td>
</tr>
<tr>
<td>proxy_headers_hash_bucket_size</td>
<td>头名字的最大值</td>
</tr>
<tr>
<td>proxy_headers_hash_max_size</td>
<td>从上游服务器接收到头的总大小</td>
</tr>
<tr>
<td>proxy_hide_header</td>
<td>不应该传递给客户端头的列表</td>
</tr>
<tr>
<td>proxy_http_version</td>
<td>用于通上游服务器通信的Http协议版本</td>
</tr>
<tr>
<td>proxy_ignore_client_abort</td>
<td>如果设置为ON，那么客户端放弃连接后，nginx将不会放弃同上游服务器的连接</td>
</tr>
<tr>
<td>proxy_ignore_headers</td>
<td>当处理来自上游服务器的响应时，设置哪些头可以被忽略</td>
</tr>
<tr>
<td>proxy_intercept_errors</td>
<td>如果启用该选项，Nginx将会显示配置的error_page错误，而不是来自于上游服务器的直接响应</td>
</tr>
<tr>
<td>proxy_max_temp_file_size</td>
<td>在写入内存缓冲区时响应与内存不匹配时使用时，给出溢出文件的最大值</td>
</tr>
<tr>
<td>proxy_pass</td>
<td>指定请求被传递到的上游服务器，格式为URL</td>
</tr>
<tr>
<td>proxy_pass_header</td>
<td>覆盖掉在proxy_hide_header指令中设置的头，允许这些头传递到客户端</td>
</tr>
<tr>
<td>proxy_pass_request_body</td>
<td>如果设置为off，将会阻止请求体传递到客户端</td>
</tr>
<tr>
<td>proxy_pass_request_headers</td>
<td>如果设置为on,则阻止请求头发送到上游服务器</td>
</tr>
<tr>
<td>proxy_read_timeout</td>
<td>给出连接关闭前从上游服务器两次成功的读操作耗时，如果上游服务器处理请求比较慢，那么该值需设置较高些</td>
</tr>
<tr>
<td>proxy_redirect</td>
<td>重写来自于上游服务器的Location和Refresh头</td>
</tr>
<tr>
<td>proxy_send_timeout</td>
<td>给出连接关闭前从上游服务器两次成功的写操作耗时，如果上游服务器处理请求比较慢，那么该值需设置较高些</td>
</tr>
<tr>
<td>proxy_set_body</td>
<td>发送到上游服务器的请求体可能会被该指令的设置值修改</td>
</tr>
<tr>
<td>proxy_set_header</td>
<td>重写发送到上游服务器头的内容，也可以通过将某种头的值设置为空字符，而不是发送某种头的方法实现</td>
</tr>
<tr>
<td>proxy_temp_file_write_size</td>
<td>在同一时间内限制缓冲到一个临时文件的数据量，以使得Nginx不会过长地阻止单个请求</td>
</tr>
<tr>
<td>proxy_temp_path</td>
<td>设定临时文件的缓冲，用于缓冲从上游服务器来的文件，可以设定目录的层次</td>
</tr>
</tbody>
</table>
<h2 id="1-2-upstream模块">1.2. upstream模块</h2>
<p>upstream指令将会启用一个新的配置区域，在该区域定义了一组上游服务器，这些服务器可以被设置为不同的权重（权重高的服务器将会被Nginx传递越多的连接）。</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ip_hash</td>
<td>通过IP地址的哈希值确保客户端均匀地连接所有的服务器，键值基于C类地址</td>
</tr>
<tr>
<td>keepalive</td>
<td>每一个worker进程缓存的到上游服务器的连接数。再使用Http连接时，proxy_http_verison设置1.1，并将proxy_set_header设置为Connection &quot;&quot;</td>
</tr>
<tr>
<td>least_conn</td>
<td>激活负载均衡算法，将请求发送到活跃连接数最少的那台服务器</td>
</tr>
<tr>
<td>server</td>
<td>为upstream定义一个服务器地址（带有端口号的域名、IP地址，或者是UNIX套接字）和一个可选的参数，参数如下：weight：设置一个服务器的优先级优于其他服务器。max_fails：设置在fail_timeout时间之内尝试对一个服务器连接的最大次数，如果超过这个次数，那么就会被标记为down。fail_timeout：在这个指定的时间内服务器必须提供响应，如果在这个时间内没有收到响应，那么服务器就会被标记为down状态。backup：一旦其他服务器宕机，那么有该标记的机器就会接收请求。down：标记为一个服务器不再接受任何请求。</td>
</tr>
</tbody>
</table>
<h3 id="1-2-1-负载均衡算法">1.2.1. 负载均衡算法</h3>
<p>upstream模块能够使用轮询、IP hash和最少连接数三种负载均衡算法之一来选择哪个上游服务器将会被在下一步中连接。</p>
<h4 id="1-2-1-1-轮询">1.2.1.1. 轮询</h4>
<p>默认情况使用轮询，不需要配置指令来设置，该算法选择下一个服务器，基于先前选择，再配置文件中哪一个是下一个服务器，以及每个服务器的负载。轮询算法是基于在队列中谁是下一个的原理确保将访问量均匀的分配给每一个上游服务器。</p>
<h4 id="1-2-1-2-ip-哈希">1.2.1.2. IP 哈希</h4>
<p>通过ip_hash指令激活使用，从而将某些IP地址映射到同一个上游服务器。</p>
<h4 id="1-2-1-3-最少连接数">1.2.1.3. 最少连接数</h4>
<p>通过least_conn指令启用，该算法通过选择一个活跃的最少连接数服务器，然后将负载均匀分配给上游服务器。如果上游服务器的处理器能力不同，那么可以为server指令使用weight来指示说明。该算法将考虑到不同服务器的加权最小连接数。</p>
<h1 id="2-upstream服务器类型">2. Upstream服务器类型</h1>
<p>上游服务器是Ngixn代理连接的一个服务器，可以是物理机或虚拟机。</p>
<h2 id="2-1-单个upstream服务器">2.1. 单个upstream服务器</h2>
<p>指令try_files(包括http core模块内)意味着按顺序尝试，直到找到一个匹配为止。Nginx将会投递与客户端给定URI匹配的任何文件，如果没有找到任何配置文件，将会把请求代理到Apache作进一步处理。</p>
<h2 id="2-2-多个upstream服务器">2.2. 多个upstream服务器</h2>
<p>Nginx将会通过轮询的方式将连续请求传递给3个上游服务器。这样应用程序不会过载。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1537696859/article/nginx/nginx.png" alt="这里写图片描述"></p>
<h1 id="3-负载均衡特别说明">3. 负载均衡特别说明</h1>
<ol>
<li>如果客户端希望总是访问同一个上游服务器，可以使用ip_hash指令；</li>
<li>如果请求响应时间长短不一，可以使用least_conn指令；</li>
<li>默认为轮询。</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fd3c37bc56a35cbed876a7ec53b56dc6">11.3 - Nginx http服务器</h1>
    
	<h1 id="1-nginx的系统架构">1. Nginx的系统架构</h1>
<ol>
<li>Nginx包含一个单一的master进程和多个worker进程，每个进程都是单进程，并且设计为同时处理成千上万个连接。</li>
<li>worker进程是处理连接的地方，Nginx使用了操作系统事件机制来快速响应这些请求。</li>
<li>master进程负责读取配置文件、处理套接字、派生worker进程、打开日志文件和编译嵌入式的perl脚本。master进程是一个可以通过处理信号量来管理请求的进程。</li>
<li>worker进程运行在一个忙碌的事件循环处理中，用于处理进入的连接。每一个nginx模块被构筑在worker中。任何请求处理、过滤、处理代理的连接和更多操作都在worker中完成。</li>
<li>如果没有阻塞worker进程的进程（例如磁盘I/O），那么需要配置的worker进程要多于CPU内核数，以便处理负载。</li>
</ol>
<h1 id="2-http核心模块">2. Http核心模块</h1>
<h2 id="2-1-1-server">2.1.1. server</h2>
<p>指令server开始一个新的上下文（context）。</p>
<p>http server指令</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>port_in_redirect</td>
<td>确认nginx是否对端口指定重定向</td>
</tr>
<tr>
<td>server</td>
<td>创建一个新的配置区域，定义一个虚拟主机。listen指令指定IP和端口；server_name列举用于匹配的Host头值</td>
</tr>
<tr>
<td>server_name</td>
<td>配置用于响应请求的虚拟主机名称</td>
</tr>
<tr>
<td>server_name_in_redirect</td>
<td></td>
</tr>
<tr>
<td>server_tokens</td>
<td>在错误信息中禁止发送nginx的版本号和server响应头</td>
</tr>
</tbody>
</table>
<h2 id="2-1-2-日志格式">2.1.2. 日志格式</h2>
<table>
<thead>
<tr>
<th><strong>参数</strong></th>
<th><strong>说明</strong></th>
<th><strong>示例</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>$remote_addr</td>
<td>客户端地址</td>
<td>211.28.65.253</td>
</tr>
<tr>
<td>$remote_user</td>
<td>客户端用户名称</td>
<td>--</td>
</tr>
<tr>
<td>$time_local</td>
<td>访问时间和时区</td>
<td>18/Jul/2012:17:00:01 +0800</td>
</tr>
<tr>
<td>$request</td>
<td>请求的URI和HTTP协议</td>
<td>&quot;GET /article-10000.html HTTP/1.1&quot;</td>
</tr>
<tr>
<td>$http_host</td>
<td>请求地址，即浏览器中你输入的地址（IP或域名）</td>
<td><a href="https://www.it300.com">www.it300.com</a>192.168.100.100</td>
</tr>
<tr>
<td>$status</td>
<td>HTTP请求状态</td>
<td>200</td>
</tr>
<tr>
<td>$upstream_status</td>
<td>upstream状态</td>
<td>200</td>
</tr>
<tr>
<td>$body_bytes_sent</td>
<td>发送给客户端文件内容大小</td>
<td>1547</td>
</tr>
<tr>
<td>$http_referer</td>
<td>url跳转来源</td>
<td><a href="https://www.baidu.com/">https://www.baidu.com/</a></td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>用户终端浏览器等信息</td>
<td>&quot;Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; SV1; GTB7.0; .NET4.0C;</td>
</tr>
<tr>
<td>$ssl_protocol</td>
<td>SSL协议版本</td>
<td>TLSv1</td>
</tr>
<tr>
<td>$ssl_cipher</td>
<td>交换数据中的算法</td>
<td>RC4-SHA</td>
</tr>
<tr>
<td>$upstream_addr</td>
<td>后台upstream的地址，即真正提供服务的主机地址</td>
<td>10.10.10.100:80</td>
</tr>
<tr>
<td>$request_time</td>
<td>整个请求的总时间</td>
<td>0.205</td>
</tr>
<tr>
<td>$upstream_response_time</td>
<td>请求过程中，upstream响应时间</td>
<td>0.002</td>
</tr>
</tbody>
</table>
<p><strong>日志切割</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># vim /etc/logrotate.d/nginx</span>
</span></span><span style="display:flex;"><span>/usr/local/nginx/logs/*.log<span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">#指定转储周期为每天</span>
</span></span><span style="display:flex;"><span>        daily
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">#保留30个备份</span>
</span></span><span style="display:flex;"><span>        rotate <span style="color:#0000cf;font-weight:bold">30</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">#需要压缩</span>
</span></span><span style="display:flex;"><span>        delaycompress
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">#YYYYMMDD日期格式</span>
</span></span><span style="display:flex;"><span>        dateext
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">#忽略错误</span>
</span></span><span style="display:flex;"><span>        missingok
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">#如果日志为空则不做轮询</span>
</span></span><span style="display:flex;"><span>        notifempty
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">#只为整个日志组运行一次的脚本</span>
</span></span><span style="display:flex;"><span>        sharedscripts
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">#日志轮询后执行的脚本</span>
</span></span><span style="display:flex;"><span>        postrotate
</span></span><span style="display:flex;"><span>                service nginx reload
</span></span><span style="display:flex;"><span>        endscript
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-703079dad1fd73ade9e4c50d7b207138">11.4 - 配置Nginx免费证书</h1>
    
	<h1 id="1-介绍">1. 介绍</h1>
<p>网站的 SSL/TLS 加密会为您的用户带来更靠前的搜索排名和更出色的安全性。但是最大障碍是证书获取成本高昂和所涉人工流程繁琐。</p>
<p>Let’s Encrypt 是一家免费、开放、自动化的证书颁发机构 (CA)。本文介绍了如何使用 Let’s Encrypt 客户端生成证书，以及如何自动配置 NGINX 开源版和 NGINX Plus 以使用这些证书。</p>
<h1 id="2-安装certbot">2. 安装certbot</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get install certbot
</span></span><span style="display:flex;"><span>apt-get install python3-certbot-nginx
</span></span></code></pre></div><h1 id="3-为域名生成证书">3. 为域名生成证书</h1>
<p>执行以下命令会生成一个<code>90天到期</code>的证书文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo certbot --nginx -d www.example.com
</span></span></code></pre></div><p>以上命令会在<code>/etc/letsencrypt/live/</code>生成证书文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> /etc/letsencrypt/live/www.example.com
</span></span><span style="display:flex;"><span>ls
</span></span><span style="display:flex;"><span>README  cert.pem  chain.pem  fullchain.pem  privkey.pem
</span></span></code></pre></div><p>如果配置成功会生成以下信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Congratulations! You have successfully enabled https://example.com and https://www.example.com 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>IMPORTANT NOTES: 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Congratulations! Your certificate and chain have been saved at: 
</span></span><span style="display:flex;"><span>/etc/letsencrypt/live/example.com/fullchain.pem 
</span></span><span style="display:flex;"><span>Your key file has been saved at: 
</span></span><span style="display:flex;"><span>/etc/letsencrypt/live/example.com//privkey.pem
</span></span><span style="display:flex;"><span>Your cert will expire on 2017-12-12.
</span></span></code></pre></div><p>并且certbot会自动为<strong>domain‑name.conf</strong>文件自行修改证书路径。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>server <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen <span style="color:#0000cf;font-weight:bold">80</span> default_server<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    listen <span style="color:#ce5c00;font-weight:bold">[</span>::<span style="color:#ce5c00;font-weight:bold">]</span>:80 default_server<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    root /var/www/html<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    server_name  example.com www.example.com<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    listen <span style="color:#0000cf;font-weight:bold">443</span> ssl<span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic"># managed by Certbot</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># RSA certificate</span>
</span></span><span style="display:flex;"><span>    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem<span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic"># managed by Certbot</span>
</span></span><span style="display:flex;"><span>    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem<span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic"># managed by Certbot</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    include /etc/letsencrypt/options-ssl-nginx.conf<span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic"># managed by Certbot</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Redirect non-https traffic to https</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">$scheme</span> !<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;https&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">301</span> https://<span style="color:#000">$host$request_uri</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#8f5902;font-style:italic"># managed by Certbot</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-重启nginx">3. 重启Nginx</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nginx -t <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> nginx -s reload
</span></span></code></pre></div><h1 id="4-自动更新证书">4. 自动更新证书</h1>
<p>Let’s Encrypt 证书将在 90 天后到期， 因此设置定时任务自动更新证书。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>crontab -e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将以下信息写入到crontab文件中</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">12</span> * * * /usr/bin/certbot renew --quiet
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://www.nginx-cn.net/blog/using-free-ssltls-certificates-from-lets-encrypt-with-nginx/">更新：为 NGINX 配置免费的 Let’s Encrypt SSL/TLS 证书</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b1f3db196ed4affef1e665659e3bf482">12 - Keepalived</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-295f28cbefbc44466b8fbb62852e0e33">12.1 - Keepalived简介</h1>
    
	<h1 id="1-keepalived简介">1. Keepalived简介</h1>
<h2 id="1-1-概述">1.1. 概述</h2>
<p>Keepalived一个基于VRRP协议来实现的LVS服务高可用方案，可以利用其来避免单点故障。一个LVS服务会有2台服务器运行Keepalived，一台为主服务器（MASTER），一台为备份服务器（BACKUP），但是对外表现为一个虚拟IP，主服务器会发送特定的消息给备份服务器，当备份服务器收不到这个消息的时候，即主服务器宕机的时候， 备份服务器就会接管虚拟IP，继续提供服务，从而保证了高可用性。</p>
<h2 id="1-2-keepalived的作用">1.2. keepalived的作用</h2>
<p>Keepalived的作用是检测服务器的状态，如果有一台web服务器死机，或工作出现故障，Keepalived将检测到，并将有故障的服务器从系统中剔除，同时使用其他服务器代替该服务器的工作，当服务器工作正常后Keepalived自动将服务器加入到服务器群中。</p>
<h1 id="2-如何实现keepalived">2. 如何实现Keepalived</h1>
<h2 id="2-1-基于vrrp协议的理解">2.1. 基于VRRP协议的理解</h2>
<p>Keepalived是以VRRP协议为实现基础的，VRRP全称<code>Virtual Router Redundancy Protocol</code>，即<code>虚拟路由冗余协议</code>。</p>
<p>虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master和多个backup，master上面有一个对外提供服务的vip（该路由器所在局域网内其他机器的默认路由为该vip），master会发组播，当backup收不到vrrp包时就认为master宕掉了，这时就需要根据VRRP的优先级来选举一个backup当master。这样的话就可以保证路由器的高可用了。</p>
<p>keepalived主要有三个模块，分别是core、check和vrrp。core模块为keepalived的核心，负责主进程的启动、维护以及全局配置文件的加载和解析。check负责健康检查，包括常见的各种检查方式。vrrp模块是来实现VRRP协议的。</p>
<h2 id="2-2-基于tcp-ip协议的理解">2.2. 基于TCP/IP协议的理解</h2>
<p>Layer3,4&amp;7工作在IP/TCP协议栈的IP层，TCP层，及应用层,原理分别如下：</p>
<p><strong>Layer3：</strong></p>
<p>Keepalived使用Layer3的方式工作式时，Keepalived会定期向服务器群中的服务器发送一个ICMP的数据包（既我们平时用的Ping程序）,如果发现某台服务的IP地址没有激活，Keepalived便报告这台服务器失效，并将它从服务器群中剔除，这种情况的典型例子是某台服务器被非法关机。Layer3的方式是以服务器的IP地址是否有效作为服务器工作正常与否的标准。</p>
<p><strong>Layer4:</strong></p>
<p>如果您理解了Layer3的方式，Layer4就容易了。Layer4主要以TCP端口的状态来决定服务器工作正常与否。如web server的服务端口一般是80，如果Keepalived检测到80端口没有启动，则Keepalived将把这台服务器从服务器群中剔除。</p>
<p><strong>Layer7：</strong></p>
<p>Layer7就是工作在具体的应用层了，比Layer3,Layer4要复杂一点，在网络上占用的带宽也要大一些。Keepalived将根据用户的设定检查服务器程序的运行是否正常，如果与用户的设定不相符，则Keepalived将把服务器从服务器群中剔除。</p>
<h1 id="3-keepalived选举策略">3. Keepalived选举策略</h1>
<h2 id="3-1-选举策略">3.1. 选举策略</h2>
<p>首先，每个节点有一个初始优先级，由配置文件中的priority配置项指定，MASTER节点的priority应比BAKCUP高。运行过程中keepalived根据vrrp_script的weight设定，增加或减小节点优先级。规则如下：</p>
<ol>
<li>“weight”值为正时,脚本检测成功时”weight”值会加到”priority”上,检测失败是不加</li>
</ol>
<ul>
<li>
<p>主失败:
主priority&lt;备priority+weight之和时会切换</p>
</li>
<li>
<p>主成功:
主priority+weight之和&gt;备priority+weight之和时,主依然为主,即不发生切换</p>
</li>
</ul>
<ol start="2">
<li>“weight”为负数时,脚本检测成功时”weight”不影响”priority”,检测失败时,Master节点的权值将是“priority“值与“weight”值之差</li>
</ol>
<ul>
<li>
<p>主失败:
主priotity-abs(weight) &lt; 备priority时会发生切换</p>
</li>
<li>
<p>主成功:
主priority &gt; 备priority 不切换</p>
</li>
</ul>
<ol start="3">
<li>当两个节点的优先级相同时，以节点发送VRRP通告的IP作为比较对象，IP较大者为MASTER。</li>
</ol>
<h2 id="3-2-priority和weight的设定">3.2. priority和weight的设定</h2>
<ol>
<li>
<p>主从的优先级初始值priority和变化量weight设置非常关键，配错的话会导致无法进行主从切换。比如，当MASTER初始值定得太高，即使script脚本执行失败，也比BACKUP的priority + weight大，就没法进行VIP漂移了。</p>
</li>
<li>
<p>所以priority和weight值的设定应遵循: abs(MASTER priority - BAKCUP priority) &lt; abs(weight)。一般情况下，初始值MASTER的priority值应该比较BACKUP大，但不能超过weight的绝对值。 另外，当网络中不支持多播(例如某些云环境)，或者出现网络分区的情况，keepalived BACKUP节点收不到MASTER的VRRP通告，就会出现脑裂(split brain)现象，此时集群中会存在多个MASTER节点。</p>
</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a0c0ae349d3e1054e9789f4f459ccd1c">12.2 - Keepalived安装与配置</h1>
    
	<h1 id="1-keepalived的安装">1. Keepalived的安装</h1>
<h2 id="1-1-yum-install方式">1.1. yum install方式</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y keepalived
</span></span></code></pre></div><h2 id="1-2-安装包编译方式">1.2. 安装包编译方式</h2>
<p>更多安装包参考：http://www.keepalived.org/download.html</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget http://www.keepalived.org/software/keepalived-2.0.7.tar.gz
</span></span><span style="display:flex;"><span>tar zxvf keepalived-2.0.7.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> keepalived-2.0.7
</span></span><span style="display:flex;"><span>./configure --bindir<span style="color:#ce5c00;font-weight:bold">=</span>/usr/bin --sbindir<span style="color:#ce5c00;font-weight:bold">=</span>/usr/sbin --sysconfdir<span style="color:#ce5c00;font-weight:bold">=</span>/etc --mandir<span style="color:#ce5c00;font-weight:bold">=</span>/usr/share
</span></span><span style="display:flex;"><span>make <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> make install
</span></span></code></pre></div><h1 id="2-常用配置">2. 常用配置</h1>
<p>keepalived配置文件路径：<code>/etc/keepalived/keepalived</code>。</p>
<h2 id="2-1-master-主机配置">2.1. MASTER（主机配置）</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>global_defs <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    router_id proxy-keepalived
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_script check_nginx <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#4e9a06">&#34;/etc/keepalived/scripts/check_nginx.sh&#34;</span> 
</span></span><span style="display:flex;"><span>    interval <span style="color:#0000cf;font-weight:bold">3</span>  
</span></span><span style="display:flex;"><span>    weight <span style="color:#0000cf;font-weight:bold">2</span>   
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    state BACKUP
</span></span><span style="display:flex;"><span>    interface eth2
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#0000cf;font-weight:bold">15</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass xxx
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        check_nginx 
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        180.101.115.139
</span></span><span style="display:flex;"><span>        218.98.38.29
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	nopreempt
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	notify_master <span style="color:#4e9a06">&#34;/etc/keepalived/keepalived_notify.sh master&#34;</span>
</span></span><span style="display:flex;"><span>	notify_backup <span style="color:#4e9a06">&#34;/etc/keepalived/keepalived_notify.sh backup&#34;</span>
</span></span><span style="display:flex;"><span>	notify_fault <span style="color:#4e9a06">&#34;/etc/keepalived/keepalived_notify.sh fault&#34;</span>
</span></span><span style="display:flex;"><span>	notify_stop <span style="color:#4e9a06">&#34;/etc/keepalived/keepalived_notify.sh stop&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-backup-备机配置">2.2. BACKUP（备机配置）</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>global_defs <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    router_id proxy-keepalived
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_script check_nginx <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#4e9a06">&#34;/etc/keepalived/scripts/check_nginx.sh&#34;</span> 
</span></span><span style="display:flex;"><span>    interval <span style="color:#0000cf;font-weight:bold">3</span>  
</span></span><span style="display:flex;"><span>    weight <span style="color:#0000cf;font-weight:bold">2</span>   
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    state BACKUP 
</span></span><span style="display:flex;"><span>    interface eth2
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#0000cf;font-weight:bold">15</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#0000cf;font-weight:bold">99</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass xxx
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        check_nginx 
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        180.101.115.139
</span></span><span style="display:flex;"><span>        218.98.38.29
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	nopreempt
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	notify_master <span style="color:#4e9a06">&#34;/etc/keepalived/keepalived_notify.sh master&#34;</span>
</span></span><span style="display:flex;"><span>	notify_backup <span style="color:#4e9a06">&#34;/etc/keepalived/keepalived_notify.sh backup&#34;</span>
</span></span><span style="display:flex;"><span>	notify_fault <span style="color:#4e9a06">&#34;/etc/keepalived/keepalived_notify.sh fault&#34;</span>
</span></span><span style="display:flex;"><span>	notify_stop <span style="color:#4e9a06">&#34;/etc/keepalived/keepalived_notify.sh stop&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-注意事项">3. 注意事项</h1>
<p>1、指定Nginx健康检测脚本：/etc/keepalived/scripts/check_nginx.sh</p>
<p>2、主备配置差别主要为（建议这么配置）：</p>
<blockquote>
<p>以下两种方式的配置，当其中一台机器keepalived挂掉后会自动VIP切到另一台机器，当挂掉机器keepalived恢复后不会抢占VIP，该方式可以避免机器恢复再次切VIP所带来的影响。</p>
</blockquote>
<ul>
<li>
<p>主机:(state BACKUP;priority 100)</p>
</li>
<li>
<p>备机：(state BACKUP;priority 99)</p>
</li>
<li>
<p>非抢占：nopreempt</p>
<p>或者：</p>
</li>
<li>
<p>主机:(state MASTER;priority 100)</p>
</li>
<li>
<p>备机：(state BACKUP;priority 100)</p>
</li>
<li>
<p>默认抢占</p>
</li>
</ul>
<p>3、指定VIP</p>
<pre tabindex="0"><code>    virtual_ipaddress {
        180.101.115.139
        218.98.38.29
    }
</code></pre><p>4、可以指定为非抢占：nopreempt，即priority高不会抢占已经绑定VIP的机器。</p>
<p>5、制定绑定IP的网卡： interface eth2</p>
<p>6、可以指定keepalived状态变化通知</p>
<pre tabindex="0"><code>	notify_master &#34;/etc/keepalived/keepalived_notify.sh master&#34;
	notify_backup &#34;/etc/keepalived/keepalived_notify.sh backup&#34;
	notify_fault &#34;/etc/keepalived/keepalived_notify.sh fault&#34;
	notify_stop &#34;/etc/keepalived/keepalived_notify.sh stop&#34;
</code></pre><p>7、virtual_router_id 15值，主备值一致，但建议不应与集群中其他Nginx机器上的相同，如果同一个网段配置的virtual_router_id 重复则会报错，选择一个不重复的0~255之间的值，可以用以下命令查看已存在的vrid。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tcpdump -nn -i any net 224.0.0.0/8
</span></span></code></pre></div><h1 id="4-常用脚本">4. 常用脚本</h1>
<h2 id="4-1-nginx健康检测脚本">4.1. Nginx健康检测脚本</h2>
<p>在Nginx配置目录下（/etc/nginx/conf.d/）增加health.conf的配置文件,该配置文件用于配置Nginx health的接口。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>server <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listen       <span style="color:#0000cf;font-weight:bold">80</span>  default_server<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    server_name  localhost<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    default_type text/html<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">200</span> <span style="color:#4e9a06">&#39;Health&#39;</span><span style="color:#000;font-weight:bold">;</span>  
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Nginx健康检测脚本：/etc/keepalived/scripts/check_nginx.sh</p>
<h3 id="4-1-1-检查接口调用是否为200">4.1.1. 检查接口调用是否为200</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">30</span> <span style="color:#8f5902;font-style:italic">#指定默认30秒没返回200则为非健康，该值可根据实际调整</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> -n <span style="color:#4e9a06">${</span><span style="color:#000">timeout</span><span style="color:#4e9a06">}</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">httpcode</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">`</span>curl -sL -w %<span style="color:#ce5c00;font-weight:bold">{</span>http_code<span style="color:#ce5c00;font-weight:bold">}</span> -m <span style="color:#4e9a06">${</span><span style="color:#000">timeout</span><span style="color:#4e9a06">}</span> http://localhost -o /dev/null<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">httpcode</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">`</span>curl -sL -w %<span style="color:#ce5c00;font-weight:bold">{</span>http_code<span style="color:#ce5c00;font-weight:bold">}</span>  http://localhost -o /dev/null<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#4e9a06">${</span><span style="color:#000">httpcode</span><span style="color:#4e9a06">}</span> -ne <span style="color:#0000cf;font-weight:bold">200</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">echo</span> <span style="color:#4e9a06">`</span>date<span style="color:#4e9a06">`</span><span style="color:#4e9a06">&#39;:  nginx is not healthy, return http_code is &#39;</span><span style="color:#4e9a06">${</span><span style="color:#000">httpcode</span><span style="color:#4e9a06">}</span> &gt;&gt; /etc/keeperalived/keepalived.log
</span></span><span style="display:flex;"><span>        killall keepalived
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span></code></pre></div><h3 id="4-1-2-检查nginx进程是否运行">4.1.2. 检查Nginx进程是否运行</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#4e9a06">`</span>ps -C nginx --no-header <span style="color:#000;font-weight:bold">|</span>wc -l<span style="color:#4e9a06">`</span> -eq <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>date<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06"> nginx pid not found&#34;</span>&gt;&gt;/etc/keepalived/keepalived.log
</span></span><span style="display:flex;"><span>        killall keepalived
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span></code></pre></div><h2 id="4-2-keepalived状态通知脚本">4.2. Keepalived状态通知脚本</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">warn_receiver</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>ifconfig bond0<span style="color:#000;font-weight:bold">|</span>grep inet <span style="color:#000;font-weight:bold">|</span>awk <span style="color:#4e9a06">&#39;{print $2}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">warningInfo</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">ip</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">_keepalived_changed_status_to_</span><span style="color:#000">$1</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>warn-report --user admin --key<span style="color:#ce5c00;font-weight:bold">=</span>xxxx --target<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">warn_receiver</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">${</span><span style="color:#000">warningInfo</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#204a87;font-weight:bold">$(</span>date<span style="color:#204a87;font-weight:bold">)</span>  <span style="color:#000">$1</span> &gt;&gt; /etc/keepalived/status
</span></span></code></pre></div><p><strong>说明：</strong></p>
<ol>
<li>ip获取本机IP，本例中IP获取是bond0的IP，不同机器网卡名称不同需要修改为对应网卡名称。</li>
<li>告警工具根据自己指定。</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e553bc1d8197e89a121a1338faed792d">12.3 - Keepalived相关操作</h1>
    
	<h1 id="1-常用命令">1. 常用命令</h1>
<h2 id="1-1-查看当前vip在哪个节点上">1.1. 查看当前VIP在哪个节点上</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看VIP是否在筛选结果中</span>
</span></span><span style="display:flex;"><span>ip addr show<span style="color:#000;font-weight:bold">|</span>grep <span style="color:#4e9a06">&#34;scope global&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或者 </span>
</span></span><span style="display:flex;"><span>ip addr show<span style="color:#000;font-weight:bold">|</span>grep <span style="color:#ce5c00;font-weight:bold">{</span>vip<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-2-查看keepalived的日志">1.2. 查看keepalived的日志</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tail /var/log/messages
</span></span></code></pre></div><h2 id="1-3-抓包命令">1.3. 抓包命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 抓包</span>
</span></span><span style="display:flex;"><span>tcpdump -nn vrrp
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以用这条命令来查看该网络中所存在的vrid</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any net 224.0.0.0/8
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># tcpdump -nn -i any net 224.0.0.0/8</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># tcpdump -nn vrrp</span>
</span></span><span style="display:flex;"><span>tcpdump: verbose output suppressed, use -v or -vv <span style="color:#204a87;font-weight:bold">for</span> full protocol decode
</span></span><span style="display:flex;"><span>listening on eth0, link-type EN10MB <span style="color:#ce5c00;font-weight:bold">(</span>Ethernet<span style="color:#ce5c00;font-weight:bold">)</span>, capture size <span style="color:#0000cf;font-weight:bold">262144</span> bytes
</span></span><span style="display:flex;"><span>14:40:00.576387 IP 192.168.98.57 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 9, prio 99, authtype simple, intvl 1s, length <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>14:40:01.577605 IP 192.168.98.57 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 9, prio 99, authtype simple, intvl 1s, length <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>14:40:02.578429 IP 192.168.98.57 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 9, prio 99, authtype simple, intvl 1s, length <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>14:40:03.579605 IP 192.168.98.57 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 9, prio 99, authtype simple, intvl 1s, length <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>14:40:04.580443 IP 192.168.98.57 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 9, prio 99, authtype simple, intvl 1s, length <span style="color:#0000cf;font-weight:bold">20</span>
</span></span></code></pre></div><h2 id="1-4-vip操作">1.4. VIP操作</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 解绑VIP</span>
</span></span><span style="display:flex;"><span>ip addr del  dev 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 绑定VIP</span>
</span></span><span style="display:flex;"><span>ip addr add  dev 
</span></span></code></pre></div><h2 id="1-5-keepalived-切-vip">1.5. keepalived 切 VIP</h2>
<p>例如将 A 机器上的 VIP 迁移到B 机器上。</p>
<h3 id="1-5-1-停止keepalived服务">1.5.1. 停止keepalived服务</h3>
<p>停止被迁移的机器（A机器）的keepalived服务。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl stop keepalived
</span></span></code></pre></div><h3 id="1-5-2-查看日志">1.5.2. 查看日志</h3>
<p>解绑 A机器 VIP的日志</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">19</span> 14:28:09 localhost systemd: Stopping LVS and VRRP High Availability Monitor...
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">19</span> 14:28:09 localhost Keepalived<span style="color:#ce5c00;font-weight:bold">[</span>45705<span style="color:#ce5c00;font-weight:bold">]</span>: Stopping
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">19</span> 14:28:09 localhost Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>45707<span style="color:#ce5c00;font-weight:bold">]</span>: VRRP_Instance<span style="color:#ce5c00;font-weight:bold">(</span>twemproxy<span style="color:#ce5c00;font-weight:bold">)</span> sent <span style="color:#0000cf;font-weight:bold">0</span> priority
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">19</span> 14:28:09 localhost Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>45707<span style="color:#ce5c00;font-weight:bold">]</span>: VRRP_Instance<span style="color:#ce5c00;font-weight:bold">(</span>twemproxy<span style="color:#ce5c00;font-weight:bold">)</span> removing protocol VIPs.
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">19</span> 14:28:09 localhost Keepalived_healthcheckers<span style="color:#ce5c00;font-weight:bold">[</span>45706<span style="color:#ce5c00;font-weight:bold">]</span>: Stopped
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">19</span> 14:28:10 localhost Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>45707<span style="color:#ce5c00;font-weight:bold">]</span>: Stopped
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">19</span> 14:28:10 localhost Keepalived<span style="color:#ce5c00;font-weight:bold">[</span>45705<span style="color:#ce5c00;font-weight:bold">]</span>: Stopped Keepalived v1.3.5 <span style="color:#ce5c00;font-weight:bold">(</span>03/19,2017<span style="color:#ce5c00;font-weight:bold">)</span>, git commit v1.3.5-6-g6fa32f2
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">19</span> 14:28:10 localhost systemd: Stopped LVS and VRRP High Availability Monitor.
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">19</span> 14:28:10 localhost ntpd<span style="color:#ce5c00;font-weight:bold">[</span>1186<span style="color:#ce5c00;font-weight:bold">]</span>: Deleting interface <span style="color:#8f5902;font-style:italic">#10 bond0, 192.168.99.9#123, interface stats: received=0, sent=0, dropped=0, active_time=6755768 secs</span>
</span></span></code></pre></div><p>绑定 B 机器 VIP的日志</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:25 localhost systemd: Starting LVS and VRRP High Availability Monitor...
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived<span style="color:#ce5c00;font-weight:bold">[</span>34566<span style="color:#ce5c00;font-weight:bold">]</span>: Starting Keepalived v1.3.5 <span style="color:#ce5c00;font-weight:bold">(</span>03/19,2017<span style="color:#ce5c00;font-weight:bold">)</span>, git commit v1.3.5-6-g6fa32f2
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived<span style="color:#ce5c00;font-weight:bold">[</span>34566<span style="color:#ce5c00;font-weight:bold">]</span>: Opening file <span style="color:#4e9a06">&#39;/etc/keepalived/keepalived.conf&#39;</span>.
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived<span style="color:#ce5c00;font-weight:bold">[</span>34568<span style="color:#ce5c00;font-weight:bold">]</span>: Starting Healthcheck child process, <span style="color:#000">pid</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">34569</span>
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived<span style="color:#ce5c00;font-weight:bold">[</span>34568<span style="color:#ce5c00;font-weight:bold">]</span>: Starting VRRP child process, <span style="color:#000">pid</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">34570</span>
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>34570<span style="color:#ce5c00;font-weight:bold">]</span>: Registering Kernel netlink reflector
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>34570<span style="color:#ce5c00;font-weight:bold">]</span>: Registering Kernel netlink <span style="color:#204a87">command</span> channel
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>34570<span style="color:#ce5c00;font-weight:bold">]</span>: Registering gratuitous ARP shared channel
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>34570<span style="color:#ce5c00;font-weight:bold">]</span>: Opening file <span style="color:#4e9a06">&#39;/etc/keepalived/keepalived.conf&#39;</span>.
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>34570<span style="color:#ce5c00;font-weight:bold">]</span>: Truncating auth_pass to <span style="color:#0000cf;font-weight:bold">8</span> characters
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>34570<span style="color:#ce5c00;font-weight:bold">]</span>: VRRP_Instance<span style="color:#ce5c00;font-weight:bold">(</span>twemproxy<span style="color:#ce5c00;font-weight:bold">)</span> removing protocol VIPs.
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>34570<span style="color:#ce5c00;font-weight:bold">]</span>: Using LinkWatch kernel netlink reflector...
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>34570<span style="color:#ce5c00;font-weight:bold">]</span>: VRRP_Instance<span style="color:#ce5c00;font-weight:bold">(</span>twemproxy<span style="color:#ce5c00;font-weight:bold">)</span> Entering BACKUP STATE
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>34570<span style="color:#ce5c00;font-weight:bold">]</span>: VRRP sockpool: <span style="color:#ce5c00;font-weight:bold">[</span>ifindex<span style="color:#ce5c00;font-weight:bold">(</span>4<span style="color:#ce5c00;font-weight:bold">)</span>, proto<span style="color:#ce5c00;font-weight:bold">(</span>112<span style="color:#ce5c00;font-weight:bold">)</span>, unicast<span style="color:#ce5c00;font-weight:bold">(</span>0<span style="color:#ce5c00;font-weight:bold">)</span>, fd<span style="color:#ce5c00;font-weight:bold">(</span>10,11<span style="color:#ce5c00;font-weight:bold">)]</span>
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost systemd: Started LVS and VRRP High Availability Monitor.
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost kernel: IPVS: Registered protocols <span style="color:#ce5c00;font-weight:bold">(</span>TCP, UDP, SCTP, AH, ESP<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost kernel: IPVS: Connection <span style="color:#204a87">hash</span> table configured <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">size</span><span style="color:#ce5c00;font-weight:bold">=</span>4096, <span style="color:#000">memory</span><span style="color:#ce5c00;font-weight:bold">=</span>64Kbytes<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost kernel: IPVS: Creating netns <span style="color:#000">size</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2192</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost kernel: IPVS: Creating netns <span style="color:#000">size</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2192</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost kernel: IPVS: ipvs loaded.
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">17</span> 17:20:26 localhost Keepalived_healthcheckers<span style="color:#ce5c00;font-weight:bold">[</span>34569<span style="color:#ce5c00;font-weight:bold">]</span>: Opening file <span style="color:#4e9a06">&#39;/etc/keepalived/keepalived.conf&#39;</span>.
</span></span></code></pre></div><h1 id="2-指定keepalived的输出日志文件">2. 指定keepalived的输出日志文件</h1>
<h2 id="2-1-修改-etc-sysconfig-keepalived">2.1. 修改 <code>/etc/sysconfig/keepalived</code></h2>
<p>将<code>KEEPALIVED_OPTIONS=&quot;-D&quot;</code>改为<code>KEEPALIVED_OPTIONS=&quot;-D -d -S 0&quot;</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Options for keepalived. See `keepalived --help&#39; output and keepalived(8) and</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># keepalived.conf(5) man pages for a list of all options. Here are the most</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># common ones :</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># --vrrp               -P    Only run with VRRP subsystem.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># --check              -C    Only run with Health-checker subsystem.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># --dont-release-vrrp  -V    Dont remove VRRP VIPs &amp; VROUTEs on daemon stop.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># --dont-release-ipvs  -I    Dont remove IPVS topology on daemon stop.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># --dump-conf          -d    Dump the configuration data.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># --log-detail         -D    Detailed log messages.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># --log-facility       -S    0-7 Set local syslog facility (default=LOG_DAEMON)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">KEEPALIVED_OPTIONS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-D -d -S 0&#34;</span>
</span></span></code></pre></div><h2 id="2-2-修改rsyslog的配置-etc-rsyslog-conf">2.2. 修改rsyslog的配置 /etc/rsyslog.conf</h2>
<p>在/etc/rsyslog.conf  添加 keepalived的日志路径</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /etc/rsyslog.conf
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># keepalived log</span>
</span></span><span style="display:flex;"><span>local0.*                                                /etc/keepalived/keepalived.log
</span></span></code></pre></div><h2 id="2-3-重启rsyslog和keepalived">2.3. 重启rsyslog和keepalived</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重启rsyslog</span>
</span></span><span style="display:flex;"><span>systemctl restart rsyslog
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  重启keepalived</span>
</span></span><span style="display:flex;"><span>systemctl restart keepalived
</span></span></code></pre></div><h1 id="3-troubleshooting">3. Troubleshooting</h1>
<h2 id="3-1-virtual-router-id-同网段重复">3.1. virtual_router_id 同网段重复</h2>
<p>日志报错如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Mar <span style="color:#0000cf;font-weight:bold">09</span> 21:28:28 k8s4 Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>8548<span style="color:#ce5c00;font-weight:bold">]</span>: bogus VRRP packet received on eth0 !!!
</span></span><span style="display:flex;"><span>Mar <span style="color:#0000cf;font-weight:bold">09</span> 21:28:28 k8s4 Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>8548<span style="color:#ce5c00;font-weight:bold">]</span>: VRRP_Instance<span style="color:#ce5c00;font-weight:bold">(</span>VI-kube-master<span style="color:#ce5c00;font-weight:bold">)</span> ignoring received advertisment...
</span></span><span style="display:flex;"><span>Mar <span style="color:#0000cf;font-weight:bold">09</span> 21:28:43 k8s4 Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>8548<span style="color:#ce5c00;font-weight:bold">]</span>: ip address associated with VRID not present in received packet : 192.168.1.10
</span></span><span style="display:flex;"><span>Mar <span style="color:#0000cf;font-weight:bold">09</span> 21:28:43 k8s4 Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>8548<span style="color:#ce5c00;font-weight:bold">]</span>: one or more VIP associated with VRID mismatch actual MASTER advert
</span></span></code></pre></div><p>解决方法:</p>
<p>同一网段内LB节点配置的 <code>virtual_router_id</code> 值有重复了，选择一个不重复的0~255之间的值，可以用以下命令查看已存在的vrid。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tcpdump -nn -i any net 224.0.0.0/8
</span></span></code></pre></div><h2 id="3-2-operation-not-permitted">3.2. Operation not permitted</h2>
<p>问题：</p>
<p>两台主备机器都绑定了VIP，查看日志如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">28</span> 14:28:37 node Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>1686<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#ce5c00;font-weight:bold">(</span>VI_1<span style="color:#ce5c00;font-weight:bold">)</span>: send advert error <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>Operation not permitted<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Sep <span style="color:#0000cf;font-weight:bold">28</span> 14:28:39 node Keepalived_vrrp<span style="color:#ce5c00;font-weight:bold">[</span>1686<span style="color:#ce5c00;font-weight:bold">]</span>: <span style="color:#ce5c00;font-weight:bold">(</span>VI_1<span style="color:#ce5c00;font-weight:bold">)</span>: send advert error <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>Operation not permitted<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>原因：</p>
<p>由于iptables vrrp协议没有放通，导致keepalived直接无法互相探测选主。</p>
<p>解决方法：</p>
<p>添加iptabels vrrp协议规则</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>iptables -A INPUT -p vrrp -j ACCEPT
</span></span><span style="display:flex;"><span>iptables -A OUTPUT -p vrrp -j ACCEPT
</span></span></code></pre></div><p>持久化iptables规则，添加规则到文件中/etc/sysconfig/iptables</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># vi /etc/sysconfig/iptables</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-A INPUT -p vrrp -j ACCEPT
</span></span><span style="display:flex;"><span>-A OUTPUT -p vrrp -j ACCEPT
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c60c32f3a5275e8f405771d11c5a360f">12.4 - Keepalived配置详解</h1>
    
	<h1 id="详细配置说明">详细配置说明</h1>
<p>keepalived只有一个配置文件<code>/etc/keepalived/keepalived.conf</code>。</p>
<p>里面主要包括以下几个配置区域，分别是:</p>
<ul>
<li>global_defs</li>
<li>static_ipaddress</li>
<li>static_routes</li>
<li>vrrp_script</li>
<li>vrrp_instance</li>
<li>virtual_server</li>
</ul>
<h2 id="1-global-defs区域">1. global_defs区域</h2>
<p>主要是配置故障发生时的通知对象以及机器标识。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>global_defs <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    notification_email <span style="color:#ce5c00;font-weight:bold">{</span>        <span style="color:#8f5902;font-style:italic"># notification_email 故障发生时给谁发邮件通知</span>
</span></span><span style="display:flex;"><span>        a@abc.com
</span></span><span style="display:flex;"><span>        b@abc.com
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    notification_email_from alert@abc.com  <span style="color:#8f5902;font-style:italic"># notification_email_from 通知邮件从哪个地址发出</span>
</span></span><span style="display:flex;"><span>    smtp_server smtp.abc.com    <span style="color:#8f5902;font-style:italic"># smpt_server 通知邮件的smtp地址</span>
</span></span><span style="display:flex;"><span>    smtp_connect_timeout <span style="color:#0000cf;font-weight:bold">30</span>     <span style="color:#8f5902;font-style:italic"># smtp_connect_timeout 连接smtp服务器的超时时间</span>
</span></span><span style="display:flex;"><span>    enable_traps                <span style="color:#8f5902;font-style:italic"># enable_traps 开启SNMP陷阱（Simple Network Management Protocol）</span>
</span></span><span style="display:flex;"><span>    router_id host163 <span style="color:#8f5902;font-style:italic"># router_id 标识本节点的字条串，通常为hostname，但不一定非得是hostname。故障发生时，邮件通知会用到。</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-static-ipaddress和static-routes区域-可忽略">2. static_ipaddress和static_routes区域[可忽略]</h2>
<p>static_ipaddress和static_routes区域配置的是是本节点的IP和路由信息。如果你的机器上已经配置了IP和路由，那么这两个区域可以不用配置。其实，一般情况下你的机器都会有IP地址和路由信息的，因此没必要再在这两个区域配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>static_ipaddress <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    10.210.214.163/24 brd 10.210.214.255 dev eth0
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>static_routes <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    10.0.0.0/8 via 10.210.214.1 dev eth0
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-vrrp-script区域">3. vrrp_script区域</h2>
<p>用来做健康检查的，当时检查失败时会将vrrp_instance的priority减少相应的值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vrrp_script chk_http_port <span style="color:#ce5c00;font-weight:bold">{</span>   
</span></span><span style="display:flex;"><span>    script <span style="color:#4e9a06">&#34;&lt;/dev/tcp/127.0.0.1/80&#34;</span>       <span style="color:#8f5902;font-style:italic">#一句指令或者一个脚本文件，需返回0(成功)或非0(失败)，keepalived以此为依据判断其监控的服务状态。</span>
</span></span><span style="display:flex;"><span>    interval 1    <span style="color:#8f5902;font-style:italic">#健康检查周期</span>
</span></span><span style="display:flex;"><span>    weight -10   <span style="color:#8f5902;font-style:italic"># 优先级变化幅度，如果script中的指令执行失败，那么相应的vrrp_instance的优先级会减少10个点。</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-vrrp-instance和vrrp-sync-group区域">4. vrrp_instance和vrrp_sync_group区域</h2>
<p>vrrp_instance用来定义对外提供服务的VIP区域及其相关属性。</p>
<p>vrrp_rsync_group用来定义vrrp_intance组，使得这个组内成员动作一致。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vrrp_sync_group VG_1 <span style="color:#ce5c00;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">#监控多个网段的实例</span>
</span></span><span style="display:flex;"><span>    group <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        inside_network   <span style="color:#8f5902;font-style:italic"># name of vrrp_instance (below)</span>
</span></span><span style="display:flex;"><span>        outside_network  <span style="color:#8f5902;font-style:italic"># One for each moveable IP.</span>
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    notify_master /path/to_master.sh      <span style="color:#8f5902;font-style:italic"># notify_master表示切换为主机执行的脚本</span>
</span></span><span style="display:flex;"><span>    notify_backup /path/to_backup.sh      <span style="color:#8f5902;font-style:italic"># notify_backup表示切换为备机师的脚本</span>
</span></span><span style="display:flex;"><span>    notify_fault <span style="color:#4e9a06">&#34;/path/fault.sh VG_1&#34;</span>    <span style="color:#8f5902;font-style:italic"># notify_fault表示出错时执行的脚本</span>
</span></span><span style="display:flex;"><span>    notify /path/notify.sh  <span style="color:#8f5902;font-style:italic"># notify表示任何一状态切换时都会调用该脚本，且在以上三个脚本执行完成之后进行调用</span>
</span></span><span style="display:flex;"><span>    smtp_alert  <span style="color:#8f5902;font-style:italic"># smtp_alert 表示是否开启邮件通知（用全局区域的邮件设置来发通知）</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    state MASTER <span style="color:#8f5902;font-style:italic"># state MASTER或BACKUP，当其他节点keepalived启动时会将priority比较大的节点选举为MASTER，因此该项其实没有实质用途。</span>
</span></span><span style="display:flex;"><span>    interface eth0  <span style="color:#8f5902;font-style:italic"># interface 节点固有IP（非VIP）的网卡，用来发VRRP包</span>
</span></span><span style="display:flex;"><span>    use_vmac    dont_track_primary <span style="color:#8f5902;font-style:italic"># use_vmac 是否使用VRRP的虚拟MAC地址，dont_track_primary 忽略VRRP网卡错误（默认未设置）</span>
</span></span><span style="display:flex;"><span>    track_interface <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#8f5902;font-style:italic"># track_interface 监控以下网卡，如果任何一个不通就会切换到FALT状态。（可选项）</span>
</span></span><span style="display:flex;"><span>        eth0
</span></span><span style="display:flex;"><span>        eth1
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">#mcast_src_ip 修改vrrp组播包的源地址，默认源地址为master的IP</span>
</span></span><span style="display:flex;"><span>    mcast_src_ip    lvs_sync_daemon_interface eth1 <span style="color:#8f5902;font-style:italic">#lvs_sync_daemon_interface 绑定lvs syncd的网卡</span>
</span></span><span style="display:flex;"><span>    garp_master_delay 10  <span style="color:#8f5902;font-style:italic"># garp_master_delay 当切为主状态后多久更新ARP缓存，默认5秒</span>
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#8f5902;font-style:italic"># virtual_router_id 取值在0-255之间，用来区分多个instance的VRRP组播， 同一网段中virtual_router_id的值不能重复，否则会出错</span>
</span></span><span style="display:flex;"><span>    priority 100 <span style="color:#8f5902;font-style:italic">#priority用来选举master的，根据服务是否可用，以weight的幅度来调整节点的priority，从而选取priority高的为master，该项取值范围是1-255（在此范围之外会被识别成默认值100）</span>
</span></span><span style="display:flex;"><span>    advert_int 1 <span style="color:#8f5902;font-style:italic"># advert_int 发VRRP包的时间间隔，即多久进行一次master选举（可以认为是健康查检时间间隔）</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic"># authentication 认证区域，认证类型有PASS和HA（IPSEC），推荐使用PASS（密码只识别前8位）</span>
</span></span><span style="display:flex;"><span>        auth_type PASS  <span style="color:#8f5902;font-style:italic">#认证方式</span>
</span></span><span style="display:flex;"><span>        auth_pass 12345678  <span style="color:#8f5902;font-style:italic">#认证密码</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic"># 设置vip</span>
</span></span><span style="display:flex;"><span>        10.210.214.253/24 brd 10.210.214.255 dev eth0
</span></span><span style="display:flex;"><span>        192.168.1.11/24 brd 192.168.1.255 dev eth1
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    virtual_routes <span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic"># virtual_routes 虚拟路由，当IP漂过来之后需要添加的路由信息</span>
</span></span><span style="display:flex;"><span>        172.16.0.0/12 via 10.210.214.1
</span></span><span style="display:flex;"><span>        192.168.1.0/24 via 192.168.1.1 dev eth1
</span></span><span style="display:flex;"><span>        default via 202.102.152.1
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        chk_http_port
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    nopreempt <span style="color:#8f5902;font-style:italic"># nopreempt 允许一个priority比较低的节点作为master，即使有priority更高的节点启动</span>
</span></span><span style="display:flex;"><span>    preempt_delay 300 <span style="color:#8f5902;font-style:italic"># preempt_delay master启动多久之后进行接管资源（VIP/Route信息等），并提是没有nopreempt选项</span>
</span></span><span style="display:flex;"><span>    debug
</span></span><span style="display:flex;"><span>    notify_master<span style="color:#000;font-weight:bold">|</span>    notify_backup<span style="color:#000;font-weight:bold">|</span>    notify_fault<span style="color:#000;font-weight:bold">|</span>    notify<span style="color:#000;font-weight:bold">|</span>    smtp_alert
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-virtual-server-group和virtual-server区域">5. virtual_server_group和virtual_server区域</h2>
<p>virtual_server_group一般在超大型的LVS中用到，一般LVS用不到这东西。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>virtual_server IP Port <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    delay_loop    <span style="color:#8f5902;font-style:italic"># delay_loop 延迟轮询时间（单位秒）</span>
</span></span><span style="display:flex;"><span>    lb_algo rr<span style="color:#000;font-weight:bold">|</span>wrr<span style="color:#000;font-weight:bold">|</span>lc<span style="color:#000;font-weight:bold">|</span>wlc<span style="color:#000;font-weight:bold">|</span>lblc<span style="color:#000;font-weight:bold">|</span>sh<span style="color:#000;font-weight:bold">|</span>dh  <span style="color:#8f5902;font-style:italic"># lb_algo 后端调试算法（load balancing algorithm）</span>
</span></span><span style="display:flex;"><span>    lb_kind NAT<span style="color:#000;font-weight:bold">|</span>DR<span style="color:#000;font-weight:bold">|</span>TUN  <span style="color:#8f5902;font-style:italic"># lb_kind LVS调度类型NAT/DR/TUN</span>
</span></span><span style="display:flex;"><span>    persistence_timeout    <span style="color:#8f5902;font-style:italic">#会话保持时间</span>
</span></span><span style="display:flex;"><span>    persistence_granularity  <span style="color:#8f5902;font-style:italic">#lvs会话保持粒度 </span>
</span></span><span style="display:flex;"><span>    protocol TCP  <span style="color:#8f5902;font-style:italic">#使用的协议</span>
</span></span><span style="display:flex;"><span>    ha_suspend
</span></span><span style="display:flex;"><span>    virtualhost    <span style="color:#8f5902;font-style:italic"># virtualhost 用来给HTTP_GET和SSL_GET配置请求header的</span>
</span></span><span style="display:flex;"><span>    alpha 
</span></span><span style="display:flex;"><span>    omega
</span></span><span style="display:flex;"><span>    quorum   
</span></span><span style="display:flex;"><span>    hysteresis   
</span></span><span style="display:flex;"><span>    quorum_up<span style="color:#000;font-weight:bold">|</span>   
</span></span><span style="display:flex;"><span>    quorum_down<span style="color:#000;font-weight:bold">|</span>   
</span></span><span style="display:flex;"><span>    sorry_server  <span style="color:#8f5902;font-style:italic">#备用机，所有realserver失效后启用 </span>
</span></span><span style="display:flex;"><span>    real_server<span style="color:#ce5c00;font-weight:bold">{</span>   <span style="color:#8f5902;font-style:italic"># real_server 真正提供服务的服务器</span>
</span></span><span style="display:flex;"><span>        weight 1 <span style="color:#8f5902;font-style:italic"># 默认为1,0为失效       </span>
</span></span><span style="display:flex;"><span>        inhibit_on_failure <span style="color:#8f5902;font-style:italic">#在服务器健康检查失效时，将其设为0，而不是直接从ipvs中删除</span>
</span></span><span style="display:flex;"><span>        notify_up<span style="color:#000;font-weight:bold">|</span>       <span style="color:#8f5902;font-style:italic"># real server宕掉时执行的脚本</span>
</span></span><span style="display:flex;"><span>        notify_down<span style="color:#000;font-weight:bold">|</span>     <span style="color:#8f5902;font-style:italic"># real server启动时执行的脚本</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK</span>
</span></span><span style="display:flex;"><span>        TCP_CHECK <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            connect_timeout 3 <span style="color:#8f5902;font-style:italic">#连接超时时间</span>
</span></span><span style="display:flex;"><span>            nb_get_retry 3 <span style="color:#8f5902;font-style:italic">#重连次数</span>
</span></span><span style="display:flex;"><span>            delay_before_retry 3 <span style="color:#8f5902;font-style:italic">#重连间隔时间</span>
</span></span><span style="display:flex;"><span>            connect_port 23  <span style="color:#8f5902;font-style:italic">#健康检查的端口的端口</span>
</span></span><span style="display:flex;"><span>            bindto  
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        HTTP_GET<span style="color:#000;font-weight:bold">|</span>SSL_GET <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            url <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#8f5902;font-style:italic"># 检查url，可以指定多个</span>
</span></span><span style="display:flex;"><span>                path          <span style="color:#8f5902;font-style:italic"># path 请求real serserver上的路径  </span>
</span></span><span style="display:flex;"><span>                digest        <span style="color:#8f5902;font-style:italic"># 用genhash算出的摘要信息       </span>
</span></span><span style="display:flex;"><span>                status_code   <span style="color:#8f5902;font-style:italic"># 检查的http状态码       </span>
</span></span><span style="display:flex;"><span>                <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            connect_port         <span style="color:#8f5902;font-style:italic"># connect_port 健康检查，如果端口通则认为服务器正常     </span>
</span></span><span style="display:flex;"><span>            connect_timeout      <span style="color:#8f5902;font-style:italic"># 超时时长       </span>
</span></span><span style="display:flex;"><span>            nb_get_retry         <span style="color:#8f5902;font-style:italic"># 重试次数</span>
</span></span><span style="display:flex;"><span>            delay_before_retry   <span style="color:#8f5902;font-style:italic">#  下次重试的时间延迟  </span>
</span></span><span style="display:flex;"><span>         <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>         SMTP_CHECK <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            host <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              connect_ip
</span></span><span style="display:flex;"><span>              connect_port <span style="color:#8f5902;font-style:italic">#默认检查25端口</span>
</span></span><span style="display:flex;"><span>              bindto
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            connect_timeout <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>            retry <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>            delay_before_retry <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>            helo_name <span style="color:#000;font-weight:bold">|</span> <span style="color:#8f5902;font-style:italic">#smtp helo请求命令参数，可选</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         
</span></span><span style="display:flex;"><span>         MISC_CHECK <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            misc_path <span style="color:#000;font-weight:bold">|</span> <span style="color:#8f5902;font-style:italic">#外部脚本路径</span>
</span></span><span style="display:flex;"><span>            misc_timeout <span style="color:#8f5902;font-style:italic">#脚本执行超时时间</span>
</span></span><span style="display:flex;"><span>            misc_dynamic <span style="color:#8f5902;font-style:italic">#如设置该项，则退出状态码会用来动态调整服务器的权重，返回0 正常，不修改；返回1，</span>
</span></span><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">#检查失败，权重改为0；返回2-255，正常，权重设置为：返回状态码-2</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-16f49169aa956c243ca215c373a08ac2">13 - IDE配置</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-243ed74536ebf2005c7cf02805cada75">13.1 - vscode使用配置</h1>
    
	<blockquote>
<p>本文主要描述个人使用vscode中的常用插件和配置</p>
</blockquote>
<h1 id="1-常用插件">1. 常用插件</h1>
<table>
<thead>
<tr>
<th>插件名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Atom One Dark Theme</td>
<td>代码风格主题</td>
</tr>
<tr>
<td>JetBrains Icon Theme</td>
<td>Icon主题</td>
</tr>
<tr>
<td>GitLens</td>
<td>显示某行提交记录</td>
</tr>
<tr>
<td>Partial Diff</td>
<td>通过剪切板diff对比</td>
</tr>
<tr>
<td>Go/Python</td>
<td>编程语言插件</td>
</tr>
</tbody>
</table>
<h1 id="2-常用快捷键">2. 常用快捷键</h1>
<p>详细快捷键参考：<a href="https://blog.huweihuang.com/linux-notes/keymap/vscode-keymap/">vscode快捷键</a></p>
<table>
<thead>
<tr>
<th>功能</th>
<th>快捷键</th>
</tr>
</thead>
<tbody>
<tr>
<td>函数跳转和引用</td>
<td>（command+单击）或者F12</td>
</tr>
<tr>
<td>回到上次跳回原处（跳转前位置）</td>
<td>ctrl + -</td>
</tr>
<tr>
<td>查看接口的实现方法</td>
<td></td>
</tr>
<tr>
<td>打开terminal终端</td>
<td>Ctrl + `</td>
</tr>
<tr>
<td>多行 块选择编辑</td>
<td>Shift + option +鼠标选择块</td>
</tr>
</tbody>
</table>
<h1 id="3-配置多窗口显示">3. 配置多窗口显示</h1>
<p>vscode默认打开一个新项目就需要打开新的窗口，为了避免很多项目同时浏览而打开太多窗口，因此设置在同一个窗口中可以显示和快速切换多个项目。</p>
<p>1、左下角点击配置按钮，选中 settings。</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1747572400/article/linux/ide/vscode-setting.png" title="" alt="" width="413">
<p>2、搜索 <code>window.native</code> 选中此选项。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1747572395/article/linux/ide/vscode-windows.native.png" alt=""></p>
<p>3、重启并合并窗口。</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1747572942/article/linux/ide/vscode-merge-windows.png" title="" alt="" width="367">
<h1 id="4-配置远程开发">4. 配置远程开发</h1>
<h2 id="4-1-本地文件传远程开发">4.1. 本地文件传远程开发</h2>
<ol>
<li>
<p>安装sftp插件</p>
</li>
<li>
<p>创建sftp配置文件</p>
<p>创建<code>.vscode</code>目录，在目录下创建sftp.json文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ip&#34;</span><span style="color:#000;font-weight:bold">,</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;host&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ip&#34;</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;protocol&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;sftp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;username&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;root&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;privateKeyPath&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;~/.ssh/id_rsa&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;remotePath&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/home/go/src/projectname&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;uploadOnSave&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;ignore&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;.git&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;.vscode&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;.idea&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;.DS_Store&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;node_modules&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;watcher&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;files&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/home/go/src/github.com/projectname/*&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;autoUpload&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;autoDelete&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></li>
</ol>
<h2 id="4-2-远程文件传本地开发">4.2. 远程文件传本地开发</h2>
<p>在远程设备上git clone代码，然后在vscode上安装remote的插件，通过remote插件连接远程开发机并打开代码目录。即可进行远程开发。</p>
<p>通过vscode在远程机器上面安装相关的代码插件即可实现代码跳转等操作。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7224ecb92d80a9b6c12c139c7848a293">13.2 - Goland配置</h1>
    
	<h1 id="goland配置引用mod目录索引">Goland配置引用mod目录索引</h1>
<p>在preferences-Go-Go module下，启用go模块集成，配置环境变量如下，点击应用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">GOPROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>https://goproxy.cn,direct
</span></span></code></pre></div><p><img src="/Users/kk.hu/Library/Application%20Support/marktext/images/2022-12-18-13-49-11-image.png" alt=""></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c4eb9770381a78fb5f9401001a8d5fa1">13.3 - VIM配置</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-c20a457b7e26f9f05096ffe2529b4571">13.3.1 - basic vimrc</h1>
    
	<blockquote>
<p>以下转自https://github.com/amix/vimrc/blob/master/vimrcs/basic.vim</p>
</blockquote>
<h1 id="basic-vimrc">basic vimrc</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Maintainer: 
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;       Amir Salihefendic — @amix3k
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Awesome_version:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>       Get this config, nice color schemes and lots of plugins!
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>       Install the awesome version from:
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>           https://github.com/amix/vimrc
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Sections:
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;    -&gt; General
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>    -&gt; VIM user interface
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;    -&gt; Colors and Fonts
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>    -&gt; Files and backups
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;    -&gt; Text, tab and indent related
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>    -&gt; Visual mode related
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;    -&gt; Moving around, tabs and buffers
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>    -&gt; Status line
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;    -&gt; Editing mappings
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>    -&gt; vimgrep searching and cope displaying
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;    -&gt; Spell checking
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>    -&gt; Misc
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;    -&gt; Helper functions
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; =&gt; General
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Sets how many lines of history VIM has to remember
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set history=500
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Enable filetype plugins
</span></span><span style="display:flex;"><span>filetype plugin on
</span></span><span style="display:flex;"><span>filetype indent on
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Set to auto read when a file is changed from the outside
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set autoread
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> With a map leader it<span style="color:#4e9a06">&#39;s possible to do extra key combinations
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; like &lt;leader&gt;w saves the current file
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">let mapleader = &#34;,&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Fast saving
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">nmap &lt;leader&gt;w :w!&lt;cr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; :W sudo saves the file 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; (useful for handling the permission-denied error)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">command W w !sudo tee % &gt; /dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; =&gt; VIM user interface
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Set 7 lines to the cursor - when moving vertically using j/k
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set so=7
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Avoid garbled characters in Chinese language windows OS
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">let $LANG=&#39;</span>en<span style="color:#4e9a06">&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set langmenu=en
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">source $VIMRUNTIME/delmenu.vim
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">source $VIMRUNTIME/menu.vim
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Turn on the Wild menu
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set wildmenu
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Ignore compiled files
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set wildignore=*.o,*~,*.pyc
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">if has(&#34;win16&#34;) || has(&#34;win32&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    set wildignore+=.git\*,.hg\*,.svn\*
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">else
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    set wildignore+=*/.git/*,*/.hg/*,*/.svn/*,*/.DS_Store
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">endif
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;Always show current position
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set ruler
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Height of the command bar
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set cmdheight=2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; A buffer becomes hidden when it is abandoned
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set hid
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Configure backspace so it acts as it should act
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set backspace=eol,start,indent
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set whichwrap+=&lt;,&gt;,h,l
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Ignore case when searching
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set ignorecase
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; When searching try to be smart about cases 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set smartcase
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Highlight search results
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set hlsearch
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Makes search act like search in modern browsers
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set incsearch 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Don&#39;</span>t redraw <span style="color:#204a87;font-weight:bold">while</span> executing macros <span style="color:#ce5c00;font-weight:bold">(</span>good performance config<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> lazyredraw 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; For regular expressions turn magic on
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set magic
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Show matching brackets when text indicator is over them
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> showmatch 
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; How many tenths of a second to blink when matching brackets
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set mat=2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> No annoying sound on errors
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> noerrorbells
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> novisualbell
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">t_vb</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">tm</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">500</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Properly disable sound on errors on MacVim
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">if has(&#34;</span>gui_macvim<span style="color:#4e9a06">&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    autocmd GUIEnter * set vb t_vb=
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">endif
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Add a bit extra margin to the left
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">foldcolumn</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; Colors and Fonts
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Enable syntax highlighting
</span></span><span style="display:flex;"><span>syntax <span style="color:#204a87">enable</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Enable 256 colors palette in Gnome Terminal
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">if </span><span style="color:#000">$COLORTERM</span><span style="color:#4e9a06"> == &#39;gnome-terminal&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    set t_Co=256
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">endif
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">try
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    colorscheme desert
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">catch
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">endtry
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set background=dark
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Set extra options when running in GUI mode
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> has<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;gui_running&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">set</span> guioptions-<span style="color:#ce5c00;font-weight:bold">=</span>T
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">set</span> guioptions-<span style="color:#ce5c00;font-weight:bold">=</span>e
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">set</span> <span style="color:#000">t_Co</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">256</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">set</span> <span style="color:#000">guitablabel</span><span style="color:#ce5c00;font-weight:bold">=</span>%M<span style="color:#4e9a06">\ </span>%t
</span></span><span style="display:flex;"><span>endif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Set utf8 as standard encoding and en_US as the standard language
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set encoding=utf8
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Use Unix as the standard file <span style="color:#204a87">type</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">ffs</span><span style="color:#ce5c00;font-weight:bold">=</span>unix,dos,mac
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; Files, backups and undo
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Turn backup off, since most stuff is in SVN, git et.c anyway...
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> nobackup
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> nowb
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> noswapfile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; Text, tab and indent related
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Use spaces instead of tabs
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> expandtab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Be smart when using tabs ;)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set smarttab
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000">tab</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">4</span> spaces
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">shiftwidth</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">tabstop</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Linebreak on 500 characters
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set lbr
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set tw=500
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set ai &#34;</span>Auto indent
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> si <span style="color:#4e9a06">&#34;Smart indent
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set wrap &#34;</span>Wrap lines
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; =&gt; Visual mode related
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Visual mode pressing * or <span style="color:#8f5902;font-style:italic"># searches for the current selection</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Super useful! From an idea by Michael Naumann
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">vnoremap &lt;silent&gt; * :&lt;C-u&gt;call VisualSelection(&#39;&#39;, &#39;&#39;)&lt;CR&gt;/&lt;C-R&gt;=@/&lt;CR&gt;&lt;CR&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">vnoremap &lt;silent&gt; # :&lt;C-u&gt;call VisualSelection(&#39;&#39;, &#39;&#39;)&lt;CR&gt;?&lt;C-R&gt;=@/&lt;CR&gt;&lt;CR&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; =&gt; Moving around, tabs, windows and buffers
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Map &lt;Space&gt; to / (search) and Ctrl-&lt;Space&gt; to ? (backwards search)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;space&gt; /
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;c-space&gt; ?
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Disable highlight when &lt;leader&gt;&lt;cr&gt; is pressed
</span></span><span style="display:flex;"><span>map &lt;silent&gt; &lt;leader&gt;&lt;cr&gt; :noh&lt;cr&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Smart way to move between windows
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;C-j&gt; &lt;C-W&gt;j
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;C-k&gt; &lt;C-W&gt;k
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;C-h&gt; &lt;C-W&gt;h
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;C-l&gt; &lt;C-W&gt;l
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Close the current buffer
</span></span><span style="display:flex;"><span>map &lt;leader&gt;bd :Bclose&lt;cr&gt;:tabclose&lt;cr&gt;gT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Close all the buffers
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;leader&gt;ba :bufdo bd&lt;cr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;leader&gt;l :bnext&lt;cr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;leader&gt;h :bprevious&lt;cr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Useful mappings <span style="color:#204a87;font-weight:bold">for</span> managing tabs
</span></span><span style="display:flex;"><span>map &lt;leader&gt;tn :tabnew&lt;cr&gt;
</span></span><span style="display:flex;"><span>map &lt;leader&gt;to :tabonly&lt;cr&gt;
</span></span><span style="display:flex;"><span>map &lt;leader&gt;tc :tabclose&lt;cr&gt;
</span></span><span style="display:flex;"><span>map &lt;leader&gt;tm :tabmove 
</span></span><span style="display:flex;"><span>map &lt;leader&gt;t&lt;leader&gt; :tabnext 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Let &#39;tl&#39; toggle between this and the last accessed tab
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">let g:lasttab = 1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">nmap &lt;Leader&gt;tl :exe &#34;</span>tabn <span style="color:#4e9a06">&#34;.g:lasttab&lt;CR&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">au TabLeave * let g:lasttab = tabpagenr()
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Opens a new tab with the current buffer<span style="color:#4e9a06">&#39;s path
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Super useful when editing files in the same directory
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;leader&gt;te :tabedit &lt;c-r&gt;=expand(&#34;%:p:h&#34;)&lt;cr&gt;/
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Switch CWD to the directory of the open buffer
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;leader&gt;cd :cd %:p:h&lt;cr&gt;:pwd&lt;cr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Specify the behavior when switching between buffers 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">try
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  set switchbuf=useopen,usetab,newtab
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  set stal=2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">catch
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">endtry
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Return to last edit position when opening files (You want this!)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">au BufReadPost * if line(&#34;&#39;</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">&#34;) &gt; 1 &amp;&amp; line(&#34;</span><span style="color:#4e9a06">&#39;\&#34;&#34;) &lt;= line(&#34;$&#34;) | exe &#34;normal! g&#39;</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">&#34; | endif
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; Status line
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Always show the status line
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set laststatus=2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Format the status line
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">statusline</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">\ </span>%<span style="color:#ce5c00;font-weight:bold">{</span>HasPaste<span style="color:#ce5c00;font-weight:bold">()}</span>%F%m%r%h<span style="color:#4e9a06">\ </span>%w<span style="color:#4e9a06">\ \ </span>CWD:<span style="color:#4e9a06">\ </span>%r%<span style="color:#ce5c00;font-weight:bold">{</span>getcwd<span style="color:#ce5c00;font-weight:bold">()}</span>%h<span style="color:#4e9a06">\ \ \ </span>Line:<span style="color:#4e9a06">\ </span>%l<span style="color:#4e9a06">\ \ </span>Column:<span style="color:#4e9a06">\ </span>%c
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; Editing mappings
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Remap VIM <span style="color:#0000cf;font-weight:bold">0</span> to first non-blank character
</span></span><span style="display:flex;"><span>map <span style="color:#0000cf;font-weight:bold">0</span> ^
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Move a line of text using ALT+[jk] or Command+[jk] on mac
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">nmap &lt;M-j&gt; mz:m+&lt;cr&gt;`z
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">nmap &lt;M-k&gt; mz:m-2&lt;cr&gt;`z
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">vmap &lt;M-j&gt; :m&#39;&gt;+&lt;cr&gt;`&lt;my`&gt;mzgv`yo`z
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">vmap &lt;M-k&gt; :m&#39;&lt;-2&lt;cr&gt;`&gt;my`&lt;mzgv`yo`z
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">if has(&#34;</span>mac<span style="color:#4e9a06">&#34;) || has(&#34;</span>macunix<span style="color:#4e9a06">&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  nmap &lt;D-j&gt; &lt;M-j&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  nmap &lt;D-k&gt; &lt;M-k&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  vmap &lt;D-j&gt; &lt;M-j&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  vmap &lt;D-k&gt; &lt;M-k&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">endif
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Delete trailing white space on save, useful <span style="color:#204a87;font-weight:bold">for</span> some filetypes <span style="color:#000;font-weight:bold">;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>fun! CleanExtraSpaces<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">let</span> <span style="color:#000">save_cursor</span> <span style="color:#ce5c00;font-weight:bold">=</span> getpos<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">let</span> <span style="color:#000">old_query</span> <span style="color:#ce5c00;font-weight:bold">=</span> getreg<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    silent! %s/<span style="color:#4e9a06">\s\+</span>$//e
</span></span><span style="display:flex;"><span>    call setpos<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;.&#39;</span>, save_cursor<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    call setreg<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/&#39;</span>, old_query<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>endfun
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> has<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;autocmd&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    autocmd BufWritePre *.txt,*.js,*.py,*.wiki,*.sh,*.coffee :call CleanExtraSpaces<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>endif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; Spell checking
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Pressing ,ss will toggle and untoggle spell checking
</span></span><span style="display:flex;"><span>map &lt;leader&gt;ss :setlocal spell!&lt;cr&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Shortcuts using &lt;leader&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;leader&gt;sn ]s
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;leader&gt;sp [s
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;leader&gt;sa zg
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;leader&gt;s? z=
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; =&gt; Misc
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Remove the Windows ^M - when the encodings gets messed up
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">noremap &lt;Leader&gt;m mmHmt:%s/&lt;C-V&gt;&lt;cr&gt;//ge&lt;cr&gt;&#39;tzt&#39;m
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Quickly open a buffer <span style="color:#204a87;font-weight:bold">for</span> scribble
</span></span><span style="display:flex;"><span>map &lt;leader&gt;q :e ~/buffer&lt;cr&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Quickly open a markdown buffer for scribble
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">map &lt;leader&gt;x :e ~/buffer.md&lt;cr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Toggle paste mode on and off
</span></span><span style="display:flex;"><span>map &lt;leader&gt;pp :setlocal paste!&lt;cr&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; Helper functions
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> Returns <span style="color:#204a87">true</span> <span style="color:#204a87;font-weight:bold">if</span> paste mode is enabled
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span>! HasPaste<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">&amp;</span>paste
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#39;PASTE MODE  &#39;</span>
</span></span><span style="display:flex;"><span>    endif
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>endfunction
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; Don&#39;t close window, when deleting a buffer
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">command! Bclose call &lt;SID&gt;BufcloseCloseIt()
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">function! &lt;SID&gt;BufcloseCloseIt()
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    let l:currentBufNum = bufnr(&#34;</span>%<span style="color:#4e9a06">&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    let l:alternateBufNum = bufnr(&#34;</span><span style="color:#8f5902;font-style:italic">#&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> buflisted<span style="color:#ce5c00;font-weight:bold">(</span>l:alternateBufNum<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        buffer <span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>        bnext
</span></span><span style="display:flex;"><span>    endif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> bufnr<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> l:currentBufNum
</span></span><span style="display:flex;"><span>        new
</span></span><span style="display:flex;"><span>    endif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> buflisted<span style="color:#ce5c00;font-weight:bold">(</span>l:currentBufNum<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        execute<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bdelete! &#34;</span>.l:currentBufNum<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    endif
</span></span><span style="display:flex;"><span>endfunction
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span>! CmdLine<span style="color:#ce5c00;font-weight:bold">(</span>str<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    call feedkeys<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:&#34;</span> . a:str<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>endfunction 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span>! VisualSelection<span style="color:#ce5c00;font-weight:bold">(</span>direction, extra_filter<span style="color:#ce5c00;font-weight:bold">)</span> range
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">let</span> l:saved_reg <span style="color:#ce5c00;font-weight:bold">=</span> @<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    execute &#34;</span>normal! vgvy<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    let l:pattern = escape(@&#34;</span>, <span style="color:#4e9a06">&#34;\\/.*&#39;</span>$<span style="color:#4e9a06">^~[]&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">let</span> l:pattern <span style="color:#ce5c00;font-weight:bold">=</span> substitute<span style="color:#ce5c00;font-weight:bold">(</span>l:pattern, <span style="color:#4e9a06">&#34;\n</span>$<span style="color:#4e9a06">&#34;</span>, <span style="color:#4e9a06">&#34;&#34;</span>, <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> a:direction <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;gv&#39;</span>
</span></span><span style="display:flex;"><span>        call CmdLine<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Ack &#39;&#34;</span> . l:pattern . <span style="color:#4e9a06">&#34;&#39; &#34;</span> <span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    elseif a:direction <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;replace&#39;</span>
</span></span><span style="display:flex;"><span>        call CmdLine<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s&#34;</span> . <span style="color:#4e9a06">&#39;/&#39;</span>. l:pattern . <span style="color:#4e9a06">&#39;/&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    endif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">let</span> @/ <span style="color:#ce5c00;font-weight:bold">=</span> l:pattern
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">let</span> @<span style="color:#4e9a06">&#34; = l:saved_reg
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">endfunction
</span></span></span></code></pre></div><p>参考</p>
<ul>
<li><a href="https://github.com/amix/vimrc">https://github.com/amix/vimrc</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-20b46b33939e315547987e613a59b4fd">13.3.2 - vim 命令</h1>
    
	<h1 id="1-vi的模式">1. vi的模式</h1>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1562931318/article/vim/vi-mode.png">
<h2 id="1-1-普通模式">1.1. 普通模式</h2>
<p>由Shell进入vi编辑器时，首先进入普通模式。在普通模式下，从键盘输入任何字符都被当作命令来解释。普通模式下没有任何提示符，输入命令后立即执行，不需要回车，而且输入的字符不会在屏幕上显示出来。</p>
<h2 id="1-2-编辑模式">1.2. 编辑模式</h2>
<p>编辑模式主要用于文本的编辑。该模式下用户输入的任何字符都被作为文件的内容保存起来，并在屏幕上显示出来。</p>
<h2 id="1-3-命令模式">1.3. 命令模式</h2>
<p>命令模式下，用户可以对文件进行一些高级处理。尽管普通模式下的命令可以完成很多功能，但要执行一些如字符串查找、替换、显示行号等操作还是必须要进入命令模式。</p>
<blockquote>
<p>也有文章称为两种工作模式，即把命令模式合并到普通模式。</p>
<p>如果不确定当前处于哪种模式，按两次 Esc 键将回到普通模式。</p>
</blockquote>
<h1 id="2-vim命令汇总">2. vim命令汇总</h1>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1562930885/article/vim/vi-vim-cheat-sheet.gif">
<p><strong>高级汇总</strong></p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1562930889/article/vim/vim-keymap.png">
<h1 id="3-vim命令分类">3. vim命令分类</h1>
<h2 id="3-1-基础编辑-移动光标">3.1. 基础编辑、移动光标</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1562931487/article/vim/vim-toturial/vi-vim-tutorial-1.gif">
<table>
<thead>
<tr>
<th style="text-align:left">指令</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">$</td>
<td style="text-align:left">行尾</td>
</tr>
<tr>
<td style="text-align:left">^</td>
<td style="text-align:left">行首</td>
</tr>
<tr>
<td style="text-align:left">w</td>
<td style="text-align:left">下一个单词 (词首）</td>
</tr>
<tr>
<td style="text-align:left">e</td>
<td style="text-align:left">下一个单词（词尾）</td>
</tr>
<tr>
<td style="text-align:left">b</td>
<td style="text-align:left">前一个单词</td>
</tr>
<tr>
<td style="text-align:left">x</td>
<td style="text-align:left">del 删除后一个字符</td>
</tr>
<tr>
<td style="text-align:left">X</td>
<td style="text-align:left">backspace 删除前一个字符</td>
</tr>
<tr>
<td style="text-align:left">u</td>
<td style="text-align:left">撤销</td>
</tr>
<tr>
<td style="text-align:left">ctrl + r</td>
<td style="text-align:left">重做</td>
</tr>
<tr>
<td style="text-align:left">k</td>
<td style="text-align:left">上</td>
</tr>
<tr>
<td style="text-align:left">h</td>
<td style="text-align:left">下</td>
</tr>
<tr>
<td style="text-align:left">g</td>
<td style="text-align:left">左</td>
</tr>
<tr>
<td style="text-align:left">l</td>
<td style="text-align:left">右</td>
</tr>
<tr>
<td style="text-align:left">i</td>
<td style="text-align:left">插入，开始写东西</td>
</tr>
<tr>
<td style="text-align:left">s</td>
<td style="text-align:left">覆盖</td>
</tr>
<tr>
<td style="text-align:left">esc</td>
<td style="text-align:left">退出输入模式，进入普通模式，可执行各种命令</td>
</tr>
</tbody>
</table>
<h2 id="3-2-操作和重复操作">3.2. 操作和重复操作</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1562931488/article/vim/vim-toturial/vi-vim-tutorial-2.gif">
<table>
<thead>
<tr>
<th style="text-align:left">指令</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">f</td>
<td style="text-align:left">查找字符，按f后再按需要移动到的字符，光标就会移动到那</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><code>f;</code> 就会移动到下一个 <code>;</code>的位置</td>
</tr>
<tr>
<td style="text-align:left">F</td>
<td style="text-align:left">反向查找字符</td>
</tr>
<tr>
<td style="text-align:left">.</td>
<td style="text-align:left">重复上一个操作</td>
</tr>
<tr>
<td style="text-align:left">v</td>
<td style="text-align:left">选择模式，用上下左右选择文本，按相应的指令直接执行，<strong>如</strong>：选中后执行 <code>d</code> 就直接删除选中的文本</td>
</tr>
<tr>
<td style="text-align:left">ctrl + v</td>
<td style="text-align:left">块状选择模式，可以纵向选择文本块，而非以行的形式</td>
</tr>
<tr>
<td style="text-align:left">d</td>
<td style="text-align:left">高级删除指令：</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><code>dw</code> 删除一个单词</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><code>df(</code> 配合 <code>f</code> ，删除从光标处到 <code>(</code> 的字符，单行操作</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><code>dd</code> 删除当前行</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><code>d2w</code> 删除两个单词</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left"><code>d2t,</code> 删除当前位置到后面第二个 <code>,</code> 之间的内容，不包含 <code>,</code> （t = <code>to</code>）</td>
</tr>
</tbody>
</table>
<h2 id="3-3-复制-和-粘贴">3.3. 复制 和 粘贴</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1562931487/article/vim/vim-toturial/vi-vim-tutorial-3.gif">
<table>
<thead>
<tr>
<th style="text-align:left">指令</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">y</td>
<td style="text-align:left">复制</td>
</tr>
<tr>
<td style="text-align:left">yy</td>
<td style="text-align:left">复制当前行</td>
</tr>
<tr>
<td style="text-align:left">p</td>
<td style="text-align:left">粘贴到<code>后面</code></td>
</tr>
<tr>
<td style="text-align:left">P</td>
<td style="text-align:left">粘贴到<code>前面</code></td>
</tr>
<tr>
<td style="text-align:left">o</td>
<td style="text-align:left">在当前行的<code>下一行</code>添加空行并开始输入</td>
</tr>
<tr>
<td style="text-align:left">O</td>
<td style="text-align:left">在当前行的<code>上一行</code>添加空行并开始输入</td>
</tr>
</tbody>
</table>
<p><strong>所有经过 d x e 处理的字符串都已经复制到了粘贴板上。</strong></p>
<h2 id="3-4-搜索">3.4. 搜索</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1562931487/article/vim/vim-toturial/vi-vim-tutorial-4.gif">
<table>
<thead>
<tr>
<th style="text-align:left">指令</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">/</td>
<td style="text-align:left">从当前位置<code>向后</code>搜索</td>
</tr>
<tr>
<td style="text-align:left">？</td>
<td style="text-align:left">从当前位置<code>后前</code>搜索</td>
</tr>
<tr>
<td style="text-align:left">n</td>
<td style="text-align:left">搜索完之后，如果有多个结果，跳到 <code>下一个匹</code> 配项</td>
</tr>
<tr>
<td style="text-align:left">N</td>
<td style="text-align:left">跳到 <code>上一个</code> 匹配项</td>
</tr>
<tr>
<td style="text-align:left">*</td>
<td style="text-align:left">直接匹配当前光标下面的字符串，移到下一个匹配项，跟<code>/</code> <code>?</code> 没有关系</td>
</tr>
<tr>
<td style="text-align:left">#</td>
<td style="text-align:left">上一个匹配项</td>
</tr>
</tbody>
</table>
<h2 id="3-5-标记-和-宏">3.5. 标记 和 宏</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1562931487/article/vim/vim-toturial/vi-vim-tutorial-5.gif">
<p><strong>标记</strong></p>
<ul>
<li>
<p><code>m</code> 后跟 <code>a - z</code> 任意字符来设置一个<code>标记</code></p>
</li>
<li>
<p>`` `后跟 字符来跳到这个标记点</p>
</li>
<li>
<p>大写 <code>A - Z</code> 是全局的，小写 <code>a - z</code></p>
</li>
<li>
<p><code>'.</code> 代表最后编辑位置</p>
</li>
</ul>
<p><strong>宏</strong></p>
<ul>
<li>
<p><code>q</code> 后接 <code>a - z</code> 开始录制宏</p>
</li>
<li>
<p><code>q</code> 结束宏的录制</p>
</li>
<li>
<p><code>@</code> 后接 <code>a - z</code> 读取宏</p>
</li>
<li>
<p><code>@@</code> 代表最后一个宏</p>
</li>
</ul>
<h2 id="3-6-高级移动">3.6. 高级移动</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1562931489/article/vim/vim-toturial/vi-vim-tutorial-6.gif">
<ul>
<li>
<p><code>%</code> 在配对的 <code>()</code> <code>[]</code> 之间移动</p>
</li>
<li>
<p><code>H</code> <code>M</code> <code>L</code> 移动到编辑器可视范围的头部，中间，尾部</p>
</li>
<li>
<p><code>G</code> 到文件的尾部，前面添加数字再按 <code>G</code> 跳到输入的行，写行号的时候是看不见的</p>
</li>
<li>
<p><code>-</code> <code>+</code> 跳到上一行，下一行</p>
</li>
<li>
<p><code>(</code> <code>)</code> 跳到当前句子的 <code>首 / 尾</code></p>
</li>
<li>
<p><code>{</code> <code>}</code> 跳到 <code>前一个 / 后一个</code> 空行</p>
</li>
<li>
<p><code>[[</code> jumps to the previous <code>{</code> in column 0</p>
</li>
<li>
<p><code>]]</code> jumps to the next <code>}</code> column 0</p>
</li>
</ul>
<h2 id="3-7-高级指令">3.7. 高级指令</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1562931488/article/vim/vim-toturial/vi-vim-tutorial-7.gif">
<ul>
<li>
<p><code>J</code> 合并当前行与下一行。合并已选中的所有行。</p>
</li>
<li>
<p><code>r</code> 替换当前字符到下一个输入的字符。如： <code>r</code> 后接 <code>4</code> 会把当前字符替换成 <code>4</code></p>
</li>
<li>
<p><code>C</code> 是 <code>c$</code> 的缩写：修改从光标到结尾</p>
</li>
<li>
<p><code>D</code> 是 <code>d$</code> 的缩写：删除从光标到结尾</p>
</li>
<li>
<p><code>Y</code> 是 <code>yy</code> 的缩写：复制当前行</p>
</li>
<li>
<p><code>s</code> 删除光标下字符，并开始编辑</p>
</li>
<li>
<p><code>S</code> 删除当前行，并开始编辑</p>
</li>
<li>
<p><code>&lt;</code> 向前缩进，一行，或多行，范围设置在前面提到了，<code>t</code>等等</p>
</li>
<li>
<p><code>&gt;</code> 向后缩进，一行，或多行</p>
</li>
<li>
<p><code>=</code> 格式化，一行，或多行</p>
</li>
<li>
<p><code>~</code> 切换光标下的字符大小写</p>
</li>
</ul>
<p>参考：</p>
<blockquote>
<p>本文由以下文章整理得</p>
</blockquote>
<ul>
<li><a href="http://www.viemu.com/a_vi_vim_graphical_cheat_sheet_tutorial.html">http://www.viemu.com/a_vi_vim_graphical_cheat_sheet_tutorial.html</a></li>
<li><a href="https://segmentfault.com/a/1190000016056004#articleHeader15">https://segmentfault.com/a/1190000016056004#articleHeader15</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-779146eac7118bf7f6498da5bb9ec3e4">13.3.3 - vim 配置</h1>
    
	<h1 id="vimrc-中文版">vimrc 中文版</h1>
<blockquote>
<p>由 <a href="https://blog.51cto.com/zpf666/2335640">https://blog.51cto.com/zpf666/2335640</a> 转载</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;~/.vimrc
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>vim config file
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;date 2018-12-26
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>Created by bert
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;blog:https://blog.51cto.com/zpf666
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;=&gt;全局配置&lt;=&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>关闭vi兼容模式<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set nocompatible
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>设置历史记录步数<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set history=1000
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>开启相关插件<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>侦测文件类型<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">filetype on
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>载入文件类型插件<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">filetype plugin on
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>为特定文件类型载入相关缩进文件<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">filetype indent on
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>当文件在外部被修改时，自动更新该文件<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set autoread
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>激活鼠标的使用<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set mouse=a
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set selection=exclusive
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set selectmode=mouse,key
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>保存全局变量<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set viminfo+=!
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>带有如下符号的单词不要被换行分割<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set iskeyword+=_,</span>$<span style="color:#4e9a06">,@,%,#,-
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>通过使用: commands命令，告诉我们文件的哪一行被改变过<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set report=0
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>被分割的窗口间显示空白，便于阅读<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set fillchars=vert:\ ,stl:\ ,stlnc:\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;=&gt;字体和颜色&lt;=&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>自动开启语法高亮<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">syntax enable
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>设置字体<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87">set</span> <span style="color:#000">guifont</span><span style="color:#ce5c00;font-weight:bold">=</span>dejaVu<span style="color:#4e9a06">\ </span>Sans<span style="color:#4e9a06">\ </span>MONO<span style="color:#4e9a06">\ </span><span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">guifont</span><span style="color:#ce5c00;font-weight:bold">=</span>Courier_New:h10:cANSI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置颜色&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;colorscheme desert
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>高亮显示当前行<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set cursorline
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">hi cursorline guibg=#00ff00
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">hi CursorColumn guibg=#00ff00
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>高亮显示普通txt文件（需要txt.vim脚本）<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">au BufRead,BufNewFile *  setfiletype txt
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;=&gt;代码折叠功能&lt;=&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>激活折叠功能<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set foldenable
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87">set</span> nofen（这个是关闭折叠功能）<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>设置按照语法方式折叠（可简写set <span style="color:#000">fdm</span><span style="color:#ce5c00;font-weight:bold">=</span>XX）<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>有6种折叠方法：
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;manual   手工定义折叠&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;indent   更多的缩进表示更高级别的折叠&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;expr     用表达式来定义折叠&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;syntax   用语法高亮来定义折叠&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;diff     对没有更改的文本进行折叠&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;marker   对文中的标志进行折叠&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">foldmethod</span><span style="color:#ce5c00;font-weight:bold">=</span>manual
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;set fdl=0（这个是不选用任何折叠方法）&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置折叠区域的宽度&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;如果不为0，则在屏幕左侧显示一个折叠标识列
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>分别用“-”和“+”来表示打开和关闭的折叠
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">foldcolumn</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置折叠层数为3&#34;</span>
</span></span><span style="display:flex;"><span>setlocal <span style="color:#000">foldlevel</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置为自动关闭折叠&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">foldclose</span><span style="color:#ce5c00;font-weight:bold">=</span>all
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;用空格键来代替zo和zc快捷键实现开关折叠&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;zo O-pen a fold (打开折叠)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>zc C-lose a fold <span style="color:#ce5c00;font-weight:bold">(</span>关闭折叠<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;zf F-old creation (创建折叠)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>nnoremap &lt;space&gt; @<span style="color:#ce5c00;font-weight:bold">=((</span>foldclosed<span style="color:#ce5c00;font-weight:bold">(</span>line<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#ce5c00;font-weight:bold">))</span> &lt; 0<span style="color:#ce5c00;font-weight:bold">)</span> ? <span style="color:#4e9a06">&#39;zc&#39;</span> : <span style="color:#4e9a06">&#39;zo&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>&lt;CR&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">=</span>&gt;文字处理&lt;<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;使用空格来替换Tab&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> expandtab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置所有的Tab和缩进为4个空格&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">tabstop</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设定&lt;&lt;和&gt;&gt;命令移动时的宽度为4&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">shiftwidth</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;使得按退格键时可以一次删除4个空格&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">softtabstop</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> smarttab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;缩进，自动缩进（继承前一行的缩进）&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;set autoindent 命令打开自动缩进，是下面配置的缩写
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>可使用autoindent命令的简写，即“:set ai”和“:set noai”
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;还可以使用“:set ai sw=4”在一个命令中打开缩进并设置缩进级别
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set ai
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set cindent
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>智能缩进<span style="color:#4e9a06">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">set si
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span>自动换行”
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> wrap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置软宽度&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">sw</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;行内替换&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> gdefault
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;=&gt;Vim 界面&lt;=&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;增强模式中的命令行自动完成操作&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> wildmenu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;显示标尺&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> ruler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置命令行的高度&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">cmdheight</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;显示行数&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> nu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;不要图形按钮&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">go</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;在执行宏命令时，不进行显示重绘；在宏命令执行完成后，一次性重绘，以便提高性能&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> lz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;使回格键（backspace）正常处理indent, eol, start等&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">backspace</span><span style="color:#ce5c00;font-weight:bold">=</span>eol,start,indent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;允许空格键和光标键跨越行边界&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">whichwrap</span><span style="color:#ce5c00;font-weight:bold">+=</span>&lt;,&gt;,h,l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置魔术&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> magic
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;关闭遇到错误时的声音提示&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;关闭错误信息响铃&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> noerrorbells
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;关闭使用可视响铃代替呼叫&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> novisualbell
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;高亮显示匹配的括号([{和}])&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> showmatch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;匹配括号高亮的时间（单位是十分之一秒）&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">mat</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;光标移动到buffer的顶部和底部时保持3行距离&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">scrolloff</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;搜索逐字符高亮&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> hlsearch
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> incsearch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;搜索时不区分大小写&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;还可以使用简写（“:set ic”和“:set noic”）&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> ignorecase
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;用浅色高亮显示当前行&#34;</span>
</span></span><span style="display:flex;"><span>autocmd InsertLeave * se nocul
</span></span><span style="display:flex;"><span>autocmd InsertEnter * se cul
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;输入的命令显示出来，看的清楚&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> showcmd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;=&gt;编码设置&lt;=&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置编码&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">encoding</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">fencs</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8,ucs-bom,shift-jis,gb18030,gbk,gb2312,cp936
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置文件编码&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">fileencodings</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置终端编码&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">termencoding</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置语言编码&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">langmenu</span><span style="color:#ce5c00;font-weight:bold">=</span>zh_CN.UTF-8
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">helplang</span><span style="color:#ce5c00;font-weight:bold">=</span>cn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">=</span>&gt;其他设置&lt;<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;开启新行时使用智能自动缩进&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> smartindent
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> cin
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> showmatch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;在处理未保存或只读文件的时候，弹出确认&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> confirm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;隐藏工具栏&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> guioptions-<span style="color:#ce5c00;font-weight:bold">=</span>T
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;隐藏菜单栏&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> guioptions-<span style="color:#ce5c00;font-weight:bold">=</span>m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;置空错误铃声的终端代码&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> vb <span style="color:#000">t_vb</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;显示状态栏（默认值为1，表示无法显示状态栏）&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">laststatus</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;状态行显示的内容&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">statusline</span><span style="color:#ce5c00;font-weight:bold">=</span>%F%m%r%h%w<span style="color:#4e9a06">\ </span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">FORMAT</span><span style="color:#ce5c00;font-weight:bold">=</span>%<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000;font-weight:bold">&amp;</span>ff<span style="color:#ce5c00;font-weight:bold">}]</span><span style="color:#4e9a06">\ </span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">TYPE</span><span style="color:#ce5c00;font-weight:bold">=</span>%Y<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#4e9a06">\ </span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">POS</span><span style="color:#ce5c00;font-weight:bold">=</span>%l,%v<span style="color:#ce5c00;font-weight:bold">][</span>%p%%<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#4e9a06">\ </span>%<span style="color:#ce5c00;font-weight:bold">{</span>strftime<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">\&#34;</span>%d/%m/%y<span style="color:#4e9a06">\ </span>-<span style="color:#4e9a06">\ </span>%H:%M<span style="color:#4e9a06">\&#34;</span><span style="color:#ce5c00;font-weight:bold">)}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;粘贴不换行问题的解决方法&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">pastetoggle</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;F9&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置背景颜色&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">background</span><span style="color:#ce5c00;font-weight:bold">=</span>dark
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;文件类型自动检测，代码智能补全&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">completeopt</span><span style="color:#ce5c00;font-weight:bold">=</span>longest,preview,menu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;共享剪切板&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> <span style="color:#000">clipboard</span><span style="color:#ce5c00;font-weight:bold">+=</span>unnamed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;从不备份&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> nobackup
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> noswapfile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;自动保存&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> autowrite
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;显示中文帮助&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> version &gt;<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">603</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">set</span> <span style="color:#000">helplang</span><span style="color:#ce5c00;font-weight:bold">=</span>cn
</span></span><span style="display:flex;"><span>            <span style="color:#204a87">set</span> <span style="color:#000">encoding</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>endif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;设置高亮相关项&#34;</span>
</span></span><span style="display:flex;"><span>highlight Search <span style="color:#000">ctermbg</span><span style="color:#ce5c00;font-weight:bold">=</span>black <span style="color:#000">ctermfg</span><span style="color:#ce5c00;font-weight:bold">=</span>white <span style="color:#000">guifg</span><span style="color:#ce5c00;font-weight:bold">=</span>white <span style="color:#000">guibg</span><span style="color:#ce5c00;font-weight:bold">=</span>black
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;=&gt;在shell脚本开头自动增加解释器以及作者等版权信息&lt;=&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;新建.py,.cc,.sh,.java文件，自动插入文件头&#34;</span>
</span></span><span style="display:flex;"><span>autocmd BufNewFile *.py,*.cc,*.sh,*.java <span style="color:#204a87">exec</span> <span style="color:#4e9a06">&#34;:call SetTitle()&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;定义函数SetTitle，自动插入文件头&#34;</span>
</span></span><span style="display:flex;"><span>func SetTitle<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> expand <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%:e&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;sh&#39;</span>
</span></span><span style="display:flex;"><span>        call setline<span style="color:#ce5c00;font-weight:bold">(</span>1, <span style="color:#4e9a06">&#34;#!/bin/bash&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        call setline<span style="color:#ce5c00;font-weight:bold">(</span>2, <span style="color:#4e9a06">&#34;#Author:bert&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        call setline<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;#Blog:https://blog.51cto.com/zpf666&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        call setline<span style="color:#ce5c00;font-weight:bold">(</span>4, <span style="color:#4e9a06">&#34;#Time:&#34;</span>.strftime<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%F %T&#34;</span><span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        call setline<span style="color:#ce5c00;font-weight:bold">(</span>5, <span style="color:#4e9a06">&#34;#Name:&#34;</span>.expand<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%&#34;</span><span style="color:#ce5c00;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        call setline<span style="color:#ce5c00;font-weight:bold">(</span>6, <span style="color:#4e9a06">&#34;#Version:V1.0&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        call setline<span style="color:#ce5c00;font-weight:bold">(</span>7, <span style="color:#4e9a06">&#34;#Description:This is a production script.&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    endif
</span></span><span style="display:flex;"><span>endfunc
</span></span></code></pre></div>
</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bf34de6e998c6df58b66ee716c2bb945">14 - 快捷键</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e3c108320ce63363bf1c69dd20cf3b36">14.1 - vscode快捷键</h1>
    
	<h1 id="vscode快捷键">vscode快捷键</h1>
<h1 id="1-基本快捷键">1. 基本快捷键</h1>
<h2 id="1-1-vscode-快捷键有五种组合方式">1.1. VsCode 快捷键有五种组合方式</h2>
<ol>
<li><code>Ctrl + Shift + ?</code> : 这种常规组合按钮</li>
<li><code>Ctrl + V Ctrl +V</code> : 同时依赖一个按键的组合</li>
<li><code>Shift + V c</code> : 先组合后单键的输入</li>
<li><code>Ctrl + Click</code>: 键盘 + 鼠标点击</li>
<li><code>Ctrl + DragMouse</code> : 键盘 + 鼠标拖动</li>
</ol>
<h2 id="1-2-ctrl-p-模式">1.2. Ctrl+P 模式</h2>
<p>在<code>Ctrl+P</code>下输入<code>&gt;</code>又可以回到主命令框 <code>Ctrl+Shift+P</code>模式。</p>
<p>在<code>Ctrl+P</code>窗口下还可以</p>
<ul>
<li>直接输入文件名，快速打开文件</li>
<li><code>?</code> 列出当前可执行的动作</li>
<li><code>!</code> 显示Errors或Warnings，也可以<code>Ctrl+Shift+M</code></li>
<li><code>:</code> 跳转到行数，也可以<code>Ctrl+G</code>直接进入</li>
<li><strong>@ 跳转到symbol（搜索变量或者函数），也可以Ctrl+Shift+O直接进入</strong></li>
<li><code>@:</code>根据分类跳转symbol，查找属性或函数，也可以<code>Ctrl+Shift+O</code>后输入<code>:</code>进入</li>
<li><code>#</code> 根据名字查找symbol，也可以<code>Ctrl+T</code></li>
</ul>
<hr>
<h1 id="2-快捷键分类">2. 快捷键分类</h1>
<h2 id="2-1-通用快捷键">2.1. 通用快捷键</h2>
<table>
<thead>
<tr>
<th style="text-align:left">快捷键</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>Ctrl+Shift+P,F1</strong></td>
<td style="text-align:left"><strong>展示全局命令面板</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>Ctrl+P</strong></td>
<td style="text-align:left"><strong>快速打开最近打开的文件</strong></td>
</tr>
<tr>
<td style="text-align:left">Ctrl+Shift+N</td>
<td style="text-align:left">打开新的编辑器窗口</td>
</tr>
<tr>
<td style="text-align:left">Ctrl+Shift+W</td>
<td style="text-align:left">关闭编辑器</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="2-2-基础编辑">2.2. 基础编辑</h2>
<table>
<thead>
<tr>
<th style="text-align:left">快捷键</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Ctrl + X</td>
<td style="text-align:left">剪切</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + C</td>
<td style="text-align:left">复制</td>
</tr>
<tr>
<td style="text-align:left">Alt + up/down</td>
<td style="text-align:left">移动行上下</td>
</tr>
<tr>
<td style="text-align:left">Shift + Alt up/down</td>
<td style="text-align:left">在当前行上下复制当前行</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + K</td>
<td style="text-align:left">删除行</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Enter</td>
<td style="text-align:left">在当前行下插入新的一行</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + Enter</td>
<td style="text-align:left">在当前行上插入新的一行</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + | 匹配花括号的闭合处，跳转</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Ctrl + ] / [</td>
<td style="text-align:left">行缩进</td>
</tr>
<tr>
<td style="text-align:left">Home</td>
<td style="text-align:left">光标跳转到行头</td>
</tr>
<tr>
<td style="text-align:left">End</td>
<td style="text-align:left">光标跳转到行尾</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Home</td>
<td style="text-align:left">跳转到页头</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + End</td>
<td style="text-align:left">跳转到页尾</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + up/down</td>
<td style="text-align:left">行视图上下偏移</td>
</tr>
<tr>
<td style="text-align:left">Alt + PgUp/PgDown</td>
<td style="text-align:left">屏视图上下偏移</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + [</td>
<td style="text-align:left">折叠区域代码</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + ]</td>
<td style="text-align:left">展开区域代码</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K Ctrl + [</td>
<td style="text-align:left">折叠所有子区域代码</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + k Ctrl + ]</td>
<td style="text-align:left">展开所有折叠的子区域代码</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K Ctrl + 0</td>
<td style="text-align:left">折叠所有区域代码</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K Ctrl + J</td>
<td style="text-align:left">展开所有折叠区域代码</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K Ctrl + C</td>
<td style="text-align:left">添加行注释</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K Ctrl + U</td>
<td style="text-align:left">删除行注释</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + /</td>
<td style="text-align:left">添加关闭行注释</td>
</tr>
<tr>
<td style="text-align:left">Shift + Alt +A</td>
<td style="text-align:left">块区域注释</td>
</tr>
<tr>
<td style="text-align:left">Alt + Z</td>
<td style="text-align:left">添加关闭词汇包含</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="2-3-导航">2.3. 导航</h2>
<table>
<thead>
<tr>
<th style="text-align:left">快捷键</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Ctrl + T</td>
<td style="text-align:left">列出所有符号</td>
</tr>
<tr>
<td style="text-align:left"><strong>Ctrl + G</strong></td>
<td style="text-align:left"><strong>跳转行</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>Ctrl + P</strong></td>
<td style="text-align:left"><strong>跳转文件</strong></td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + O</td>
<td style="text-align:left">跳转到符号处</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + M</td>
<td style="text-align:left">打开问题展示面板</td>
</tr>
<tr>
<td style="text-align:left">F8</td>
<td style="text-align:left">跳转到下一个错误或者警告</td>
</tr>
<tr>
<td style="text-align:left">Shift + F8</td>
<td style="text-align:left">跳转到上一个错误或者警告</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + Tab</td>
<td style="text-align:left">切换到最近打开的文件</td>
</tr>
<tr>
<td style="text-align:left">Alt + left / right</td>
<td style="text-align:left">向后、向前</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + M</td>
<td style="text-align:left">进入用Tab来移动焦点</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="2-4-查询与替换">2.4. 查询与替换</h2>
<table>
<thead>
<tr>
<th style="text-align:left">快捷键</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Ctrl + F</td>
<td style="text-align:left">查询</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + H</td>
<td style="text-align:left">替换</td>
</tr>
<tr>
<td style="text-align:left">F3 / Shift + F3</td>
<td style="text-align:left">查询下一个/上一个</td>
</tr>
<tr>
<td style="text-align:left">Alt + Enter</td>
<td style="text-align:left">选中所有出现在查询中的</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + D</td>
<td style="text-align:left">匹配当前选中的词汇或者行，再次选中-可操作</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K Ctrl + D</td>
<td style="text-align:left">移动当前选择到下个匹配选择的位置(光标选定)</td>
</tr>
<tr>
<td style="text-align:left">Alt + C / R / W</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="2-5-多行光标操作于选择">2.5. 多行光标操作于选择</h2>
<table>
<thead>
<tr>
<th style="text-align:left">快捷键</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Alt + Click</td>
<td style="text-align:left">插入光标-支持多个</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Alt + up/down</td>
<td style="text-align:left">上下插入光标-支持多个</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + U</td>
<td style="text-align:left">撤销最后一次光标操作</td>
</tr>
<tr>
<td style="text-align:left">Shift + Alt + I</td>
<td style="text-align:left">插入光标到选中范围内所有行结束符</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + I</td>
<td style="text-align:left">选中当前行</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + L</td>
<td style="text-align:left">选择所有出现在当前选中的行-操作</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + F2</td>
<td style="text-align:left">选择所有出现在当前选中的词汇-操作</td>
</tr>
<tr>
<td style="text-align:left">Shift + Alt + right</td>
<td style="text-align:left">从光标处扩展选中全行</td>
</tr>
<tr>
<td style="text-align:left">Shift + Alt + left</td>
<td style="text-align:left">收缩选择区域</td>
</tr>
<tr>
<td style="text-align:left">Shift + Alt + (drag mouse)</td>
<td style="text-align:left">鼠标拖动区域，同时在多个行结束符插入光标</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + Alt + (Arrow Key)</td>
<td style="text-align:left">也是插入多行光标的[方向键控制]</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + Alt + PgUp/PgDown</td>
<td style="text-align:left">也是插入多行光标的[整屏生效]</td>
</tr>
<tr>
<td style="text-align:left"><strong>Shift + Alt +鼠标选择块</strong></td>
<td style="text-align:left"><strong>多行 块选择编辑</strong></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="2-6-丰富的语言操作">2.6. 丰富的语言操作</h2>
<table>
<thead>
<tr>
<th style="text-align:left">快捷键</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Ctrl + Space</td>
<td style="text-align:left">输入建议[智能提示]</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + Space</td>
<td style="text-align:left">参数提示</td>
</tr>
<tr>
<td style="text-align:left">Tab</td>
<td style="text-align:left">Emmet指令触发/缩进</td>
</tr>
<tr>
<td style="text-align:left"><strong>Shift + Alt + F</strong></td>
<td style="text-align:left"><strong>格式化代码</strong></td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K Ctrl + F</td>
<td style="text-align:left">格式化选中部分的代码</td>
</tr>
<tr>
<td style="text-align:left"><strong>F12</strong></td>
<td style="text-align:left"><strong>跳转到定义处</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>ctrl + -</strong></td>
<td style="text-align:left"><strong>跳回原处（跳转前位置）</strong></td>
</tr>
<tr>
<td style="text-align:left">Alt + F12</td>
<td style="text-align:left">代码片段显示定义</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K F12</td>
<td style="text-align:left">在其他窗口打开定义处</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + .</td>
<td style="text-align:left">快速修复部分可以修复的语法错误</td>
</tr>
<tr>
<td style="text-align:left"><strong>Shift + F12</strong></td>
<td style="text-align:left"><strong>显示所有引用</strong></td>
</tr>
<tr>
<td style="text-align:left">F2</td>
<td style="text-align:left">重命名符号</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + . / ,</td>
<td style="text-align:left">替换下个值</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K Ctrl + X</td>
<td style="text-align:left">移除空白字符</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K M</td>
<td style="text-align:left">更改页面文档格式</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="2-7-编辑器管理">2.7. 编辑器管理</h2>
<table>
<thead>
<tr>
<th style="text-align:left">快捷键</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Ctrl + F4, Ctrl + W</td>
<td style="text-align:left">关闭编辑器</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + k F</td>
<td style="text-align:left">关闭当前打开的文件夹</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + |切割编辑窗口</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">Ctrl + 1/2/3</td>
<td style="text-align:left">切换焦点在不同的切割窗口</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K Ctrl &lt;-/-&gt;</td>
<td style="text-align:left">切换焦点在不同的切割窗口</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + PgUp/PgDown</td>
<td style="text-align:left">切换标签页的位置</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K &lt;-/-&gt;</td>
<td style="text-align:left">切割窗口位置调换</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="2-8-文件管理">2.8. 文件管理</h2>
<table>
<thead>
<tr>
<th style="text-align:left">快捷键</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Ctrl + N</td>
<td style="text-align:left">新建文件</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + O</td>
<td style="text-align:left">打开文件</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + S</td>
<td style="text-align:left">保存文件</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + S</td>
<td style="text-align:left">另存为</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K S</td>
<td style="text-align:left">保存所有当前已经打开的文件</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + F4</td>
<td style="text-align:left">关闭当前编辑窗口</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K Ctrl + W</td>
<td style="text-align:left">关闭所有编辑窗口</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + T</td>
<td style="text-align:left">撤销最近关闭的一个文件编辑窗口</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K Enter</td>
<td style="text-align:left">保持开启</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + Tab</td>
<td style="text-align:left">调出最近打开的文件列表，重复按会切换</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Tab</td>
<td style="text-align:left">与上面一致，顺序不一致</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K P</td>
<td style="text-align:left">复制当前打开文件的存放路径</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K R</td>
<td style="text-align:left">打开当前编辑文件存放位置【文件管理器】</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K O</td>
<td style="text-align:left">在新的编辑器中打开当前编辑的文件</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="2-9-显示">2.9. 显示</h2>
<table>
<thead>
<tr>
<th style="text-align:left">快捷键</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">F11</td>
<td style="text-align:left">切换全屏模式</td>
</tr>
<tr>
<td style="text-align:left">Shift + Alt + 1</td>
<td style="text-align:left">切换编辑布局【目前无效】</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + =/-</td>
<td style="text-align:left">放大 / 缩小</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + B</td>
<td style="text-align:left">侧边栏显示隐藏</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + E</td>
<td style="text-align:left">资源视图和编辑视图的焦点切换</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + F</td>
<td style="text-align:left">打开全局搜索</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + G</td>
<td style="text-align:left">打开Git可视管理</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + D</td>
<td style="text-align:left">打开DeBug面板</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + X</td>
<td style="text-align:left">打开插件市场面板</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + H</td>
<td style="text-align:left">在当前文件替换查询替换</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + J</td>
<td style="text-align:left">开启详细查询</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + V</td>
<td style="text-align:left">预览Markdown文件【编译后】</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K v</td>
<td style="text-align:left">在边栏打开渲染后的视图【新建】</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="2-10-调试">2.10. 调试</h2>
<table>
<thead>
<tr>
<th style="text-align:left">快捷键</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">F9</td>
<td style="text-align:left">添加解除断点</td>
</tr>
<tr>
<td style="text-align:left">F5</td>
<td style="text-align:left">启动调试、继续</td>
</tr>
<tr>
<td style="text-align:left">F11 / Shift + F11</td>
<td style="text-align:left">单步进入 / 单步跳出</td>
</tr>
<tr>
<td style="text-align:left">F10</td>
<td style="text-align:left">单步跳过</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + K Ctrl + I</td>
<td style="text-align:left">显示悬浮</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="2-11-集成终端">2.11. 集成终端</h2>
<table>
<thead>
<tr>
<th style="text-align:left">快捷键</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Ctrl + `</td>
<td style="text-align:left">打开集成终端</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + `</td>
<td style="text-align:left">创建一个新的终端</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + C</td>
<td style="text-align:left">复制所选</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Shift + V</td>
<td style="text-align:left">复制到当前激活的终端</td>
</tr>
<tr>
<td style="text-align:left">Shift + PgUp / PgDown</td>
<td style="text-align:left">页面上下翻屏</td>
</tr>
<tr>
<td style="text-align:left">Ctrl + Home / End</td>
<td style="text-align:left">滚动到页面头部或尾部</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c8f6be5c515ff7cf53a522f8a2590173">14.2 - eclipse快捷键</h1>
    
	<h1 id="eclipse快捷键">eclipse快捷键</h1>
<h1 id="1-快捷键">1. 快捷键</h1>
<h2 id="1-1-编辑">1.1. 编辑</h2>
<table>
<thead>
<tr>
<th>作用域</th>
<th>功能</th>
<th>快捷键</th>
</tr>
</thead>
<tbody>
<tr>
<td>全局</td>
<td>查找并替换</td>
<td>Ctrl+F</td>
</tr>
<tr>
<td>文本编辑器</td>
<td>查找上一个</td>
<td>Ctrl+Shift+K</td>
</tr>
<tr>
<td>文本编辑器</td>
<td>查找下一个</td>
<td>Ctrl+K</td>
</tr>
<tr>
<td>文本编辑器</td>
<td>删除当前行</td>
<td>Ctrl+D</td>
</tr>
<tr>
<td>文本编辑器</td>
<td>当前行的下一行插入空行</td>
<td>Shift+Enter</td>
</tr>
<tr>
<td>文本编辑器</td>
<td>当前行插入空行</td>
<td>Ctrl+Shift+Enter</td>
</tr>
<tr>
<td>文本编辑器</td>
<td>定位到最后编辑的位置</td>
<td>Ctrl+Q</td>
</tr>
<tr>
<td>全局</td>
<td>恢复上一个选择</td>
<td>Alt+Shift+↓</td>
</tr>
<tr>
<td>全局</td>
<td>快速修正</td>
<td>Ctrl+1</td>
</tr>
<tr>
<td>全局</td>
<td>内容辅助（代码提示）</td>
<td>Alt+/</td>
</tr>
<tr>
<td>全局</td>
<td>全部选中</td>
<td>Ctrl+A</td>
</tr>
<tr>
<td>全局</td>
<td>删除</td>
<td>Delete</td>
</tr>
<tr>
<td>全局</td>
<td>上下文信息</td>
<td>Alt+/Alt+Shift+?Ctrl+Shift+Space</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>显示工具提示描述</td>
<td>F2</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>选择封装元素</td>
<td>Alt+Shift+↑</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>增量选择上一个同级元素</td>
<td>Alt+Shift+←</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>增量选择下一个同级元素</td>
<td>Alt+Shift+→</td>
</tr>
<tr>
<td>文本编辑器</td>
<td>增量查找</td>
<td>Ctrl+J</td>
</tr>
<tr>
<td>文本编辑器</td>
<td>增量逆向查找</td>
<td>Ctrl+Shift+J</td>
</tr>
<tr>
<td>java编辑器</td>
<td>自动生成get set方法</td>
<td>Alt+Shift+s 再按 r</td>
</tr>
<tr>
<td>java编辑器</td>
<td>列出所有实现此接口的类</td>
<td>ctrl+T</td>
</tr>
</tbody>
</table>
<h2 id="1-2-查看">1.2. 查看</h2>
<table>
<thead>
<tr>
<th>作用域</th>
<th>功能</th>
<th>快捷键</th>
</tr>
</thead>
<tbody>
<tr>
<td>全局</td>
<td>放大</td>
<td>Ctrl+=</td>
</tr>
<tr>
<td>全局</td>
<td>缩小</td>
<td>Ctrl+-</td>
</tr>
</tbody>
</table>
<h2 id="1-3-窗口">1.3. 窗口</h2>
<table>
<thead>
<tr>
<th>作用域</th>
<th>功能</th>
<th>快捷键</th>
</tr>
</thead>
<tbody>
<tr>
<td>全局</td>
<td>激活编辑器</td>
<td>F12</td>
</tr>
<tr>
<td>全局</td>
<td>关闭所有编辑器</td>
<td>Ctrl+Shift+W</td>
</tr>
<tr>
<td>全局</td>
<td>上一个编辑器</td>
<td>Ctrl+Shift+F6</td>
</tr>
<tr>
<td>全局</td>
<td>上一个视图</td>
<td>Ctrl+Shift+F7</td>
</tr>
<tr>
<td>全局</td>
<td>上一个透视图</td>
<td>Ctrl+Shift+F8</td>
</tr>
<tr>
<td>全局</td>
<td>下一个编辑器</td>
<td>Ctrl+F6</td>
</tr>
<tr>
<td>全局</td>
<td>下一个视图</td>
<td>Ctrl+F7</td>
</tr>
<tr>
<td>全局</td>
<td>下一个透视图</td>
<td>Ctrl+F8</td>
</tr>
<tr>
<td>文本编辑器</td>
<td>关闭当前窗口</td>
<td>Ctrl+W</td>
</tr>
<tr>
<td>全局</td>
<td>显示视图菜单</td>
<td>Ctrl+F10</td>
</tr>
<tr>
<td>全局</td>
<td>显示系统菜单</td>
<td>Alt+-</td>
</tr>
</tbody>
</table>
<h2 id="1-4-导航">1.4. 导航</h2>
<table>
<thead>
<tr>
<th>作用域</th>
<th>功能</th>
<th>快捷键</th>
</tr>
</thead>
<tbody>
<tr>
<td>Java编辑器</td>
<td>打开结构</td>
<td>Ctrl+F3</td>
</tr>
<tr>
<td>全局</td>
<td>打开类型</td>
<td>Ctrl+Shift+T</td>
</tr>
<tr>
<td>全局</td>
<td>打开类型层次结构</td>
<td>F4</td>
</tr>
<tr>
<td>全局</td>
<td>打开声明</td>
<td>F3</td>
</tr>
<tr>
<td>全局</td>
<td>打开外部javadoc</td>
<td>Shift+F2</td>
</tr>
<tr>
<td>全局</td>
<td>打开资源</td>
<td>Ctrl+Shift+R</td>
</tr>
<tr>
<td>全局</td>
<td>后退历史记录</td>
<td>Alt+←</td>
</tr>
<tr>
<td>全局</td>
<td>前进历史记录</td>
<td>Alt+→</td>
</tr>
<tr>
<td>全局</td>
<td>上一个</td>
<td>Ctrl+,</td>
</tr>
<tr>
<td>全局</td>
<td>下一个</td>
<td>Ctrl+.</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>显示大纲</td>
<td>Ctrl+O</td>
</tr>
<tr>
<td>全局</td>
<td>在层次结构中打开类型</td>
<td>Ctrl+Shift+H</td>
</tr>
<tr>
<td>全局</td>
<td>转至匹配的括号</td>
<td>Ctrl+Shift+P</td>
</tr>
<tr>
<td>全局</td>
<td>转至上一个编辑位置</td>
<td>Ctrl+Q</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>转至上一个成员</td>
<td>Ctrl+Shift+↑</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>转至下一个成员</td>
<td>Ctrl+Shift+↓</td>
</tr>
<tr>
<td>文本编辑器</td>
<td>转至行</td>
<td>Ctrl+L</td>
</tr>
</tbody>
</table>
<h1 id="2-搜索">2. 搜索</h1>
<table>
<thead>
<tr>
<th>作用域</th>
<th>功能</th>
<th>快捷键</th>
</tr>
</thead>
<tbody>
<tr>
<td>全局</td>
<td>出现在文件中</td>
<td>Ctrl+Shift+U</td>
</tr>
<tr>
<td>全局</td>
<td>查找目标文件</td>
<td>ctrl+shift+R</td>
</tr>
<tr>
<td>全局</td>
<td>打开搜索对话框</td>
<td>Ctrl+H</td>
</tr>
<tr>
<td>全局</td>
<td>工作区中的声明</td>
<td>Ctrl+G</td>
</tr>
<tr>
<td>全局</td>
<td>工作区中的引用</td>
<td>Ctrl+Shift+G</td>
</tr>
<tr>
<td>工作区域的类</td>
<td>查看某一个类的继承类或者实现类</td>
<td>ctrl+T</td>
</tr>
</tbody>
</table>
<h1 id="3-文本编辑">3. 文本编辑</h1>
<table>
<thead>
<tr>
<th>作用域</th>
<th>功能</th>
<th>快捷键</th>
</tr>
</thead>
<tbody>
<tr>
<td>文本编辑器</td>
<td>改写切换</td>
<td>Insert</td>
</tr>
<tr>
<td>文本编辑器</td>
<td>上滚行</td>
<td>Ctrl+↑</td>
</tr>
<tr>
<td>文本编辑器</td>
<td>下滚行</td>
<td>Ctrl+↓</td>
</tr>
</tbody>
</table>
<h1 id="4-文件">4. 文件</h1>
<table>
<thead>
<tr>
<th>作用域</th>
<th>功能</th>
<th>快捷键</th>
</tr>
</thead>
<tbody>
<tr>
<td>全局</td>
<td>保存</td>
<td>Ctrl+S</td>
</tr>
<tr>
<td>全局</td>
<td>打印</td>
<td>Ctrl+P</td>
</tr>
<tr>
<td>全局</td>
<td>关闭</td>
<td>Ctrl+F4</td>
</tr>
<tr>
<td>全局</td>
<td>全部保存</td>
<td>Ctrl+Shift+S</td>
</tr>
<tr>
<td>全局</td>
<td>全部关闭</td>
<td>Ctrl+Shift+F4</td>
</tr>
<tr>
<td>全局</td>
<td>属性</td>
<td>Alt+Enter</td>
</tr>
<tr>
<td>全局</td>
<td>新建</td>
<td>Ctrl+N</td>
</tr>
</tbody>
</table>
<h1 id="5-项目">5. 项目</h1>
<table>
<thead>
<tr>
<th>作用域</th>
<th>功能</th>
<th>快捷键</th>
</tr>
</thead>
<tbody>
<tr>
<td>全局</td>
<td>全部构建</td>
<td>Ctrl+B</td>
</tr>
</tbody>
</table>
<h2 id="5-1-源代码">5.1. 源代码</h2>
<table>
<thead>
<tr>
<th>作用域</th>
<th>功能</th>
<th>快捷键</th>
</tr>
</thead>
<tbody>
<tr>
<td>Java编辑器</td>
<td>格式化</td>
<td>Ctrl+Shift+F</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>添加/取消注释</td>
<td>Ctrl+/</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>添加导入</td>
<td>Ctrl+Shift+M</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>组织导入</td>
<td>Ctrl+Shift+O</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>使用try/catch块来包围</td>
<td>未设置，太常用了，所以在这里列出，建议自己设置。也可以使用Ctrl+1自动修正。Alt+Shift+z（就可以吧）</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>将所选区域字母设置为小写</td>
<td>Ctrl+Shift+Y</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>将所选区域字母设置为大写</td>
<td>Ctrl+Shift+X</td>
</tr>
<tr>
<td>Java编辑器</td>
<td>方法添加注释</td>
<td>Alt+Shift+J</td>
</tr>
</tbody>
</table>
<h2 id="5-2-运行">5.2. 运行</h2>
<table>
<thead>
<tr>
<th>作用域</th>
<th>功能</th>
<th>快捷键</th>
</tr>
</thead>
<tbody>
<tr>
<td>全局</td>
<td>单步返回</td>
<td>F7</td>
</tr>
<tr>
<td>全局</td>
<td>单步执行</td>
<td>F6</td>
</tr>
<tr>
<td>全局</td>
<td>单步跳入</td>
<td>F5</td>
</tr>
<tr>
<td>全局</td>
<td>单步跳入选择</td>
<td>Ctrl+F5</td>
</tr>
<tr>
<td>全局</td>
<td>调试上次启动</td>
<td>F11</td>
</tr>
<tr>
<td>全局</td>
<td>继续</td>
<td>F8</td>
</tr>
<tr>
<td>全局</td>
<td>使用过滤器单步执行</td>
<td>Shift+F5</td>
</tr>
<tr>
<td>全局</td>
<td>添加/去除断点</td>
<td>Ctrl+Shift+B</td>
</tr>
<tr>
<td>全局</td>
<td>显示</td>
<td>Ctrl+D</td>
</tr>
<tr>
<td>全局</td>
<td>运行上次启动</td>
<td>Ctrl+F11</td>
</tr>
<tr>
<td>全局</td>
<td>运行至行</td>
<td>Ctrl+R</td>
</tr>
<tr>
<td>全局</td>
<td>执行</td>
<td>Ctrl+U</td>
</tr>
</tbody>
</table>
<h2 id="5-3-重构">5.3. 重构</h2>
<table>
<thead>
<tr>
<th>作用域</th>
<th>功能</th>
<th>快捷键</th>
</tr>
</thead>
<tbody>
<tr>
<td>全局</td>
<td>撤销重构</td>
<td>Alt+Shift+Z</td>
</tr>
<tr>
<td>全局</td>
<td>抽取方法</td>
<td>Alt+Shift+M</td>
</tr>
<tr>
<td>全局</td>
<td>抽取局部变量</td>
<td>Alt+Shift+L</td>
</tr>
<tr>
<td>全局</td>
<td>内联</td>
<td>Alt+Shift+I</td>
</tr>
<tr>
<td>全局</td>
<td>移动</td>
<td>Alt+Shift+V</td>
</tr>
<tr>
<td>全局</td>
<td>重命名</td>
<td>Alt+Shift+R</td>
</tr>
<tr>
<td>全局</td>
<td>重做</td>
<td>Alt+Shift+Y</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-272274d6cdd6ca909a6e3761d71fb5e4">14.3 - chrome快捷键</h1>
    
	<h1 id="chrome快捷键">chrome快捷键</h1>
<h1 id="1-标签页和窗口快捷键">1. 标签页和窗口快捷键</h1>
<table>
<thead>
<tr>
<th><strong>操作</strong></th>
<th><strong>快捷键</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>打开新窗口</td>
<td><strong>⌘ + n</strong></td>
</tr>
<tr>
<td>在无痕模式下打开新窗口</td>
<td><strong>⌘ + Shift + n</strong></td>
</tr>
<tr>
<td>打开新的标签页，并跳转到该标签页</td>
<td><strong>⌘ + t</strong></td>
</tr>
<tr>
<td>重新打开最后关闭的标签页，并跳转到该标签页</td>
<td><strong>⌘ + Shift + t</strong></td>
</tr>
<tr>
<td>跳转到下一个打开的标签页</td>
<td><strong>⌘ + Option + 向右箭头键</strong></td>
</tr>
<tr>
<td>跳转到上一个打开的标签页</td>
<td><strong>⌘ + Option + 向左箭头键</strong></td>
</tr>
<tr>
<td>跳转到特定标签页</td>
<td><strong>⌘ + 1</strong> 到 <strong>⌘ + 8</strong></td>
</tr>
<tr>
<td>顺序切换标签页</td>
<td>Ctrl + Tab</td>
</tr>
<tr>
<td>跳转到最后一个标签页</td>
<td><strong>⌘ + 9</strong></td>
</tr>
<tr>
<td>打开当前标签页浏览记录中记录的上一个页面</td>
<td><strong>⌘ + [</strong> 或 <strong>⌘ + 向左箭头键</strong></td>
</tr>
<tr>
<td>打开当前标签页浏览记录中记录的下一个页面</td>
<td><strong>⌘ + ]</strong> 或 <strong>⌘ + 向右箭头键</strong></td>
</tr>
<tr>
<td>关闭当前标签页或弹出式窗口</td>
<td><strong>⌘ + w</strong></td>
</tr>
<tr>
<td>关闭当前窗口</td>
<td><strong>⌘ + Shift + w</strong></td>
</tr>
<tr>
<td>最小化窗口</td>
<td><strong>⌘ + m</strong></td>
</tr>
<tr>
<td>隐藏 Google Chrome</td>
<td><strong>⌘ + h</strong></td>
</tr>
<tr>
<td>退出 Google Chrome</td>
<td><strong>⌘ + q</strong></td>
</tr>
</tbody>
</table>
<h1 id="2-google-chrome-功能快捷键">2. Google Chrome 功能快捷键</h1>
<table>
<thead>
<tr>
<th><strong>操作</strong></th>
<th><strong>快捷键</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>显示或隐藏书签栏</td>
<td><strong>⌘ + Shift + b</strong></td>
</tr>
<tr>
<td>打开书签管理器</td>
<td><strong>⌘ + Option + b</strong></td>
</tr>
<tr>
<td>在新标签页中打开“设置”页</td>
<td><strong>⌘ + ,</strong></td>
</tr>
<tr>
<td>在新标签页中打开“历史记录”页</td>
<td><strong>⌘ + y</strong></td>
</tr>
<tr>
<td>在新标签页中打开“下载内容”页</td>
<td><strong>⌘ + Shift + j</strong></td>
</tr>
<tr>
<td>打开查找栏搜索当前网页</td>
<td><strong>⌘ + f</strong></td>
</tr>
<tr>
<td>跳转到与查找栏中搜索字词相匹配的下一条内容</td>
<td><strong>⌘ + g</strong></td>
</tr>
<tr>
<td>跳转到与查找栏中搜索字词相匹配的上一条内容</td>
<td><strong>⌘ + Shift + g</strong></td>
</tr>
<tr>
<td>打开查找栏后，搜索选定文本</td>
<td><strong>⌘ + e</strong></td>
</tr>
<tr>
<td>打开“开发者工具”</td>
<td><strong>⌘ + Option + i</strong></td>
</tr>
<tr>
<td>打开“清除浏览数据”选项</td>
<td><strong>⌘ + Shift + Delete</strong></td>
</tr>
<tr>
<td>使用其他帐号登录或以访客身份浏览</td>
<td><strong>⌘ + Shift + m</strong></td>
</tr>
</tbody>
</table>
<h1 id="3-地址栏快捷键">3. 地址栏快捷键</h1>
<p>在地址栏中可使用以下快捷键：</p>
<table>
<thead>
<tr>
<th><strong>操作</strong></th>
<th><strong>快捷键</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>使用默认搜索引擎进行搜索</td>
<td>输入搜索字词并按 <strong>Enter</strong> 键</td>
</tr>
<tr>
<td>使用其他搜索引擎进行搜索</td>
<td>输入搜索引擎名称并按 <strong>Tab</strong> 键</td>
</tr>
<tr>
<td>为网站名称添加 <code>www.</code> 和 <code>.com</code>，并在当前标签页中打开该网站</td>
<td>输入网站名称并按 <strong>Control + Enter</strong> 键</td>
</tr>
<tr>
<td>为网站名称添加 <code>www.</code> 和 <code>.com</code>，并在新标签页中打开该网站</td>
<td>输入网站名称并按 <strong>Control + Shift + Enter</strong> 键</td>
</tr>
<tr>
<td>在新的后台标签页中打开网站</td>
<td>输入网址并按 <strong>⌘ + Enter</strong> 键</td>
</tr>
<tr>
<td>跳转到地址栏</td>
<td><strong>⌘ + l</strong></td>
</tr>
<tr>
<td>从地址栏中移除联想查询内容</td>
<td>按<strong>向下箭头键</strong>以突出显示相应内容，然后按 <strong>Shift + fn + Delete</strong></td>
</tr>
</tbody>
</table>
<h1 id="4-网页快捷键">4. 网页快捷键</h1>
<table>
<thead>
<tr>
<th><strong>操作</strong></th>
<th><strong>快捷键</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>打开选项以打印当前网页</td>
<td><strong>⌘ + p</strong></td>
</tr>
<tr>
<td>打开选项以保存当前网页</td>
<td><strong>⌘ + s</strong></td>
</tr>
<tr>
<td>打开“页面设置”对话框</td>
<td><strong>⌘ + Option + p</strong></td>
</tr>
<tr>
<td>通过电子邮件发送当前网页</td>
<td><strong>⌘ + Shift + i</strong></td>
</tr>
<tr>
<td>重新加载当前网页</td>
<td><strong>⌘ + r</strong></td>
</tr>
<tr>
<td>重新加载当前网页（忽略缓存的内容）</td>
<td><strong>⌘ + Shift + r</strong></td>
</tr>
<tr>
<td>停止加载网页</td>
<td><strong>Esc</strong></td>
</tr>
<tr>
<td>浏览下一个可点击项</td>
<td><strong>Tab</strong></td>
</tr>
<tr>
<td>浏览上一个可点击项</td>
<td><strong>Shift + Tab</strong></td>
</tr>
<tr>
<td>使用 Google Chrome 打开计算机中的文件</td>
<td>按住 <strong>⌘ + o</strong> 键并选择文件</td>
</tr>
<tr>
<td>显示当前网页的 HTML 源代码（不可修改）</td>
<td><strong>⌘ + Option + u</strong></td>
</tr>
<tr>
<td>打开 JavaScript 控制台</td>
<td><strong>⌘ + Option + j</strong></td>
</tr>
<tr>
<td>将当前网页保存为书签</td>
<td><strong>⌘ + d</strong></td>
</tr>
<tr>
<td>将所有打开的标签页以书签的形式保存在新文件夹中</td>
<td><strong>⌘ + Shift + d</strong></td>
</tr>
<tr>
<td>开启或关闭全屏模式</td>
<td><strong>⌘ + Ctrl + f</strong></td>
</tr>
<tr>
<td>放大网页上的所有内容</td>
<td><strong>⌘ 和 +</strong></td>
</tr>
<tr>
<td>缩小网页上的所有内容</td>
<td><strong>⌘ 和 -</strong></td>
</tr>
<tr>
<td>将网页上的所有内容恢复到默认大小</td>
<td><strong>⌘ + 0</strong></td>
</tr>
<tr>
<td>向下滚动网页，一次一个屏幕</td>
<td><strong>空格键</strong></td>
</tr>
<tr>
<td>向上滚动网页，一次一个屏幕</td>
<td><strong>Shift + 空格键</strong></td>
</tr>
<tr>
<td>搜索网络</td>
<td><strong>⌘ + Option + f</strong></td>
</tr>
<tr>
<td>将光标移到文本字段中的上一个字词前面</td>
<td><strong>Option + 向左箭头键</strong></td>
</tr>
<tr>
<td>将光标移到文本字段中的上一个字词后面</td>
<td><strong>Option + 向右箭头键</strong></td>
</tr>
<tr>
<td>删除文本字段中的上一个字词</td>
<td><strong>Option + Delete</strong></td>
</tr>
<tr>
<td>在当前标签页中打开主页</td>
<td><strong>⌘ + Shift + h</strong></td>
</tr>
</tbody>
</table>
<h1 id="5-鼠标快捷键">5. 鼠标快捷键</h1>
<p>以下快捷键要求您使用鼠标：</p>
<table>
<thead>
<tr>
<th><strong>操作</strong></th>
<th><strong>快捷键</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>在当前标签页中打开链接（仅限鼠标）</td>
<td>将链接拖到标签页中</td>
</tr>
<tr>
<td>在新的后台标签页中打开链接</td>
<td>按住 <strong>⌘</strong> 键的同时点击链接</td>
</tr>
<tr>
<td>打开链接，并跳转到该链接</td>
<td>按住 <strong>⌘ + Shift</strong> 键的同时点击链接</td>
</tr>
<tr>
<td>打开链接，并跳转到该链接（仅使用鼠标）</td>
<td>将链接拖到标签栏的空白区域</td>
</tr>
<tr>
<td>在新窗口中打开链接</td>
<td>按住 <strong>Shift</strong> 键的同时点击链接</td>
</tr>
<tr>
<td>在新窗口中打开标签页（仅使用鼠标）</td>
<td>将标签页拖出标签栏</td>
</tr>
<tr>
<td>将标签页移至当前窗口（仅限鼠标）</td>
<td>将标签页拖到现有窗口中</td>
</tr>
<tr>
<td>将标签页移回其原始位置</td>
<td>拖动标签页的同时按 <strong>Esc</strong></td>
</tr>
<tr>
<td>将当前网页保存为书签</td>
<td>将相应网址拖动到书签栏中</td>
</tr>
<tr>
<td>下载链接目标</td>
<td>按住 <strong>Option</strong> 键的同时点击链接</td>
</tr>
<tr>
<td>显示浏览记录</td>
<td>右键点击“后退”箭头  或“前进”箭头 ，或者左键点击（并按住鼠标左键不放）“后退”箭头或“前进”箭头</td>
</tr>
<tr>
<td>将窗口高度最大化</td>
<td>双击标签栏的空白区域</td>
</tr>
</tbody>
</table>
<p>来自：https://support.google.com/chrome/answer/157179?hl=zh-Hans</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5433013698b9a3e74116f9cc13b4d2b1">14.4 - tmux快捷键</h1>
    
	<h1 id="1-安装tmux">1. 安装tmux</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># linux</span>
</span></span><span style="display:flex;"><span>yum install -y tmux
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># mac</span>
</span></span><span style="display:flex;"><span>brew install tmux
</span></span></code></pre></div><h1 id="2-tmux常用命令">2. tmux常用命令</h1>
<h2 id="2-1-进入tmux">2.1. 进入tmux</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tmux
</span></span></code></pre></div><h2 id="2-2-退出tmux-程序后台运行">2.2. 退出tmux，程序后台运行</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>按ctrl + b 进入控制台，再按 d
</span></span></code></pre></div><h2 id="2-3-重回上次tmux窗口">2.3. 重回上次tmux窗口</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ctrl + a
</span></span></code></pre></div><h2 id="2-4-结束tmux窗口运行的进程">2.4. 结束tmux窗口运行的进程</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ctrl + d
</span></span></code></pre></div><h1 id="3-更多快捷键说明">3. 更多快捷键说明</h1>
<table>
<thead>
<tr>
<th>类别</th>
<th>快捷键</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>进入控制台</strong></td>
<td><strong>Ctrl+b</strong></td>
<td><strong>激活控制台；此时以下按键生效</strong></td>
</tr>
<tr>
<td><strong>系统操作</strong></td>
<td>?</td>
<td>列出所有快捷键；按q返回</td>
</tr>
<tr>
<td></td>
<td><strong>d</strong></td>
<td>脱离当前会话；这样可以暂时返回Shell界面，输入tmux attach能够重新进入之前的会话</td>
</tr>
<tr>
<td></td>
<td>D</td>
<td>选择要脱离的会话；在同时开启了多个会话时使用</td>
</tr>
<tr>
<td></td>
<td>Ctrl+z</td>
<td>挂起当前会话</td>
</tr>
<tr>
<td></td>
<td>r</td>
<td>强制重绘未脱离的会话</td>
</tr>
<tr>
<td></td>
<td>s</td>
<td>选择并切换会话；在同时开启了多个会话时使用</td>
</tr>
<tr>
<td></td>
<td>:</td>
<td>进入命令行模式；此时可以输入支持的命令，例如kill-server可以关闭服务器</td>
</tr>
<tr>
<td></td>
<td>[</td>
<td>进入复制模式；此时的操作与vi/emacs相同，按q/Esc退出</td>
</tr>
<tr>
<td></td>
<td>~</td>
<td>列出提示信息缓存；其中包含了之前tmux返回的各种提示信息</td>
</tr>
<tr>
<td><strong>窗口操作</strong></td>
<td>c</td>
<td>创建新窗口</td>
</tr>
<tr>
<td></td>
<td>&amp;</td>
<td>关闭当前窗口</td>
</tr>
<tr>
<td></td>
<td>数字键</td>
<td>切换至指定窗口</td>
</tr>
<tr>
<td></td>
<td>p</td>
<td>切换至上一窗口</td>
</tr>
<tr>
<td></td>
<td>n</td>
<td>切换至下一窗口</td>
</tr>
<tr>
<td></td>
<td>l</td>
<td>在前后两个窗口间互相切换</td>
</tr>
<tr>
<td></td>
<td>w</td>
<td>通过窗口列表切换窗口</td>
</tr>
<tr>
<td></td>
<td>,</td>
<td>重命名当前窗口；这样便于识别</td>
</tr>
<tr>
<td></td>
<td>.</td>
<td>修改当前窗口编号；相当于窗口重新排序</td>
</tr>
<tr>
<td></td>
<td>f</td>
<td>在所有窗口中查找指定文本</td>
</tr>
<tr>
<td><strong>面板操作</strong></td>
<td>”</td>
<td>将当前面板平分为上下两块</td>
</tr>
<tr>
<td></td>
<td>%</td>
<td>将当前面板平分为左右两块</td>
</tr>
<tr>
<td></td>
<td>x</td>
<td>关闭当前面板</td>
</tr>
<tr>
<td></td>
<td>!</td>
<td>将当前面板置于新窗口；即新建一个窗口，其中仅包含当前面板</td>
</tr>
<tr>
<td></td>
<td>Ctrl+方向键</td>
<td>以1个单元格为单位移动边缘以调整当前面板大小</td>
</tr>
<tr>
<td></td>
<td>Alt+方向键</td>
<td>以5个单元格为单位移动边缘以调整当前面板大小</td>
</tr>
<tr>
<td></td>
<td>Space</td>
<td>在预置的面板布局中循环切换；依次包括even-horizontal、even-vertical、main-horizontal、main-vertical、tiled</td>
</tr>
<tr>
<td></td>
<td>q</td>
<td>显示面板编号</td>
</tr>
<tr>
<td></td>
<td>o</td>
<td>在当前窗口中选择下一面板</td>
</tr>
<tr>
<td></td>
<td>方向键</td>
<td>移动光标以选择面板</td>
</tr>
<tr>
<td></td>
<td>{</td>
<td>向前置换当前面板</td>
</tr>
<tr>
<td></td>
<td>}</td>
<td>向后置换当前面板</td>
</tr>
<tr>
<td></td>
<td>Alt+o</td>
<td>逆时针旋转当前窗口的面板</td>
</tr>
<tr>
<td></td>
<td>Ctrl+o</td>
<td>顺时针旋转当前窗口的面板</td>
</tr>
</tbody>
</table>
<blockquote>
<p>快捷键列表原文：https://blog.csdn.net/hcx25909/article/details/7602935</p>
</blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-10c176346e3ba799558f25b19b5fc093">14.5 - iterm2 rz与sz的使用</h1>
    
	<blockquote>
<p>本文由网络文章整理备份。</p>
</blockquote>
<h1 id="iterm2-rz与sz的功能">iterm2 rz与sz的功能</h1>
<p>本文主要介绍<code>mac</code>环境下使用<code>iterm2</code>的<code>rz sz</code>功能的安装流程。</p>
<h2 id="1-安装lrzsz">1. 安装lrzsz</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew install lrzsz
</span></span></code></pre></div><h2 id="2-安装执行脚本">2. 安装执行脚本</h2>
<p>将<code>iterm2-send-zmodem.sh</code>和<code>iterm2-recv-zmodem.sh</code>保存到<code>/usr/local/bin</code>目录下。</p>
<p><a href="https://raw.githubusercontent.com/RobberPhex/iterm2-zmodem/master/iterm2-send-zmodem.sh">iterm2-send-zmodem.sh</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic"># Author: Matt Mastracci (matthew@mastracci.com)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># AppleScript from http://stackoverflow.com/questions/4309087/cancel-button-on-osascript-in-a-bash-script</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># licensed under cc-wiki with attribution required </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Remainder of script public domain</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>osascript -e <span style="color:#4e9a06">&#39;tell application &#34;iTerm2&#34; to version&#39;</span> &gt; /dev/null 2&gt;<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>iTerm2 <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>iTerm
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[[</span> <span style="color:#000">$NAME</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;iTerm&#34;</span> <span style="color:#ce5c00;font-weight:bold">]]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">FILE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>osascript -e <span style="color:#4e9a06">&#39;tell application &#34;iTerm&#34; to activate&#39;</span> -e <span style="color:#4e9a06">&#39;tell application &#34;iTerm&#34; to set thefile to choose file with prompt &#34;Choose a file to send&#34;&#39;</span> -e <span style="color:#4e9a06">&#34;do shell script (\&#34;echo \&#34;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&#34;\&#34;)&#34;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">FILE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>osascript -e <span style="color:#4e9a06">&#39;tell application &#34;iTerm2&#34; to activate&#39;</span> -e <span style="color:#4e9a06">&#39;tell application &#34;iTerm2&#34; to set thefile to choose file with prompt &#34;Choose a file to send&#34;&#39;</span> -e <span style="color:#4e9a06">&#34;do shell script (\&#34;echo \&#34;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&#34;\&#34;)&#34;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[[</span> <span style="color:#000">$FILE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#ce5c00;font-weight:bold">]]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span> Cancelled.
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic"># Send ZModem cancel</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">\\</span>x18<span style="color:#4e9a06">\\</span>x18<span style="color:#4e9a06">\\</span>x18<span style="color:#4e9a06">\\</span>x18<span style="color:#4e9a06">\\</span>x18
</span></span><span style="display:flex;"><span>	sleep <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span> <span style="color:#4e9a06">\#</span> Cancelled transfer
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>	/usr/local/bin/sz <span style="color:#4e9a06">&#34;</span><span style="color:#000">$FILE</span><span style="color:#4e9a06">&#34;</span> --escape --binary --bufsize <span style="color:#0000cf;font-weight:bold">4096</span>
</span></span><span style="display:flex;"><span>	sleep <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span> <span style="color:#4e9a06">\#</span> Received <span style="color:#4e9a06">&#34;</span><span style="color:#000">$FILE</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span></code></pre></div><p><a href="https://raw.githubusercontent.com/RobberPhex/iterm2-zmodem/master/iterm2-recv-zmodem.sh">iterm2-recv-zmodem.sh</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic"># Author: Matt Mastracci (matthew@mastracci.com)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># AppleScript from http://stackoverflow.com/questions/4309087/cancel-button-on-osascript-in-a-bash-script</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># licensed under cc-wiki with attribution required </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Remainder of script public domain</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>osascript -e <span style="color:#4e9a06">&#39;tell application &#34;iTerm2&#34; to version&#39;</span> &gt; /dev/null 2&gt;<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>iTerm2 <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>iTerm
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[[</span> <span style="color:#000">$NAME</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;iTerm&#34;</span> <span style="color:#ce5c00;font-weight:bold">]]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">FILE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>osascript -e <span style="color:#4e9a06">&#39;tell application &#34;iTerm&#34; to activate&#39;</span> -e <span style="color:#4e9a06">&#39;tell application &#34;iTerm&#34; to set thefile to choose folder with prompt &#34;Choose a folder to place received files in&#34;&#39;</span> -e <span style="color:#4e9a06">&#34;do shell script (\&#34;echo \&#34;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&#34;\&#34;)&#34;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">FILE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>osascript -e <span style="color:#4e9a06">&#39;tell application &#34;iTerm2&#34; to activate&#39;</span> -e <span style="color:#4e9a06">&#39;tell application &#34;iTerm2&#34; to set thefile to choose folder with prompt &#34;Choose a folder to place received files in&#34;&#39;</span> -e <span style="color:#4e9a06">&#34;do shell script (\&#34;echo \&#34;&amp;(quoted form of POSIX path of thefile as Unicode text)&amp;\&#34;\&#34;)&#34;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[[</span> <span style="color:#000">$FILE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#ce5c00;font-weight:bold">]]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span> Cancelled.
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic"># Send ZModem cancel</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span> -e <span style="color:#4e9a06">\\</span>x18<span style="color:#4e9a06">\\</span>x18<span style="color:#4e9a06">\\</span>x18<span style="color:#4e9a06">\\</span>x18<span style="color:#4e9a06">\\</span>x18
</span></span><span style="display:flex;"><span>	sleep <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span> <span style="color:#4e9a06">\#</span> Cancelled transfer
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">cd</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$FILE</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>	/usr/local/bin/rz --rename --escape --binary --bufsize <span style="color:#0000cf;font-weight:bold">4096</span> 
</span></span><span style="display:flex;"><span>	sleep <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span> <span style="color:#4e9a06">\#</span> Sent <span style="color:#4e9a06">\-\&gt;</span> <span style="color:#000">$FILE</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span></code></pre></div><h2 id="3-赋予这两个文件可执行权限">3. 赋予这两个文件可执行权限</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod <span style="color:#0000cf;font-weight:bold">777</span> /usr/local/bin/iterm2-*
</span></span></code></pre></div><h2 id="4-设置iterm2的tirgger特性">4. 设置Iterm2的Tirgger特性</h2>
<p>设置Iterm2的Tirgger特性，profiles-&gt;default-&gt;editProfiles-&gt;Advanced中的Tirgger</p>
<p>添加两条trigger，分别设置 Regular expression，Action，Parameters，Instant如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Regular expression: rz waiting to receive.<span style="color:#4e9a06">\*\*</span>B0100
</span></span><span style="display:flex;"><span>Action: Run Silent Coprocess
</span></span><span style="display:flex;"><span>Parameters: /usr/local/bin/iterm2-send-zmodem.sh
</span></span><span style="display:flex;"><span>Instant: checked
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Regular expression: <span style="color:#4e9a06">\*\*</span>B00000000000000
</span></span><span style="display:flex;"><span>Action: Run Silent Coprocess
</span></span><span style="display:flex;"><span>Parameters: /usr/local/bin/iterm2-recv-zmodem.sh
</span></span><span style="display:flex;"><span>Instant: checked
</span></span></code></pre></div><p>示例图：</p>
<img src="https://raw.githubusercontent.com/aikuyun/iterm2-zmodem/master/imgs/01.png">
<h2 id="5-使用">5. 使用</h2>
<ul>
<li>上传文件：rz</li>
<li>下载文件：sz + file</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://www.robberphex.com/use-zmodem-at-macos/">https://www.robberphex.com/use-zmodem-at-macos/</a></li>
<li><a href="https://github.com/RobberPhex/iterm2-zmodem">https://github.com/RobberPhex/iterm2-zmodem</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0718f1276a4708caa2b7206e4792ef77">14.6 - 博客问题记录</h1>
    
	<blockquote>
<p>本文主要介绍博客相关问题</p>
</blockquote>
<h1 id="1-安装nodejs">1. 安装nodejs</h1>
<p>参考官方文档：<a href="https://nodejs.org/zh-cn/download">Node.js — Download Node.js®</a>，通过nvm管理node的不同版本。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Download and install nvm:</span>
</span></span><span style="display:flex;"><span>curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh <span style="color:#000;font-weight:bold">|</span> bash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in lieu of restarting the shell</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">\.</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$HOME</span><span style="color:#4e9a06">/.nvm/nvm.sh&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Download and install Node.js:</span>
</span></span><span style="display:flex;"><span>nvm install <span style="color:#0000cf;font-weight:bold">22</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Verify the Node.js version:</span>
</span></span><span style="display:flex;"><span>node -v <span style="color:#8f5902;font-style:italic"># Should print &#34;v22.17.0&#34;.</span>
</span></span><span style="display:flex;"><span>nvm current <span style="color:#8f5902;font-style:italic"># Should print &#34;v22.17.0&#34;.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Verify npm version:</span>
</span></span><span style="display:flex;"><span>npm -v <span style="color:#8f5902;font-style:italic"># Should print &#34;10.9.2&#34;.</span>
</span></span></code></pre></div><h1 id="2-nvm的使用">2. nvm的使用</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看node版本</span>
</span></span><span style="display:flex;"><span>nvm list
</span></span><span style="display:flex;"><span>       v10.24.1
</span></span><span style="display:flex;"><span>-&gt;     v12.14.0
</span></span><span style="display:flex;"><span>       v16.20.2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装node版本</span>
</span></span><span style="display:flex;"><span>nvm install &lt;版本&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 卸载node</span>
</span></span><span style="display:flex;"><span>nvm uninstall &lt;版本&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置默认版本</span>
</span></span><span style="display:flex;"><span>nvm <span style="color:#204a87">alias</span> default &lt;版本&gt;
</span></span></code></pre></div><h1 id="3-安装hexo">3. 安装hexo</h1>
<p>参考：<a href="https://hexo.io/zh-cn/">Hexo</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install hexo-cli -g
</span></span></code></pre></div><p>由于node的版本过新可能会导致hexo使用异常，例如hexo g 生成空白的html文件等。</p>
<p>以下是本人使用可用的相关版本，其中node的版本是<code>12.14.0</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># hexo -v</span>
</span></span><span style="display:flex;"><span>hexo: 3.9.0
</span></span><span style="display:flex;"><span>hexo-cli: 4.3.2
</span></span><span style="display:flex;"><span>os: darwin 24.3.0 15.3.1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>node: 12.14.0
</span></span><span style="display:flex;"><span>v8: 7.7.299.13-node.16
</span></span><span style="display:flex;"><span>uv: 1.33.1
</span></span><span style="display:flex;"><span>zlib: 1.2.11
</span></span><span style="display:flex;"><span>brotli: 1.0.7
</span></span><span style="display:flex;"><span>ares: 1.15.0
</span></span><span style="display:flex;"><span>modules: <span style="color:#0000cf;font-weight:bold">72</span>
</span></span><span style="display:flex;"><span>nghttp2: 1.39.2
</span></span><span style="display:flex;"><span>napi: <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>llhttp: 1.1.4
</span></span><span style="display:flex;"><span>http_parser: 2.8.0
</span></span><span style="display:flex;"><span>openssl: 1.1.1d
</span></span><span style="display:flex;"><span>cldr: 35.1
</span></span><span style="display:flex;"><span>icu: 64.2
</span></span><span style="display:flex;"><span>tz: 2019c
</span></span><span style="display:flex;"><span>unicode: 12.1
</span></span></code></pre></div><p>node相关版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ nvm -v
</span></span><span style="display:flex;"><span>0.40.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ npm -v
</span></span><span style="display:flex;"><span>6.13.4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ node -v
</span></span><span style="display:flex;"><span>v12.14.0
</span></span></code></pre></div><h1 id="4-安装hugo">4. 安装hugo</h1>
<p>hugo是跟hexo类似的博客工具。</p>
<p>安装参考：<a href="https://gohugo.io/installation/macos/">hugo macOS</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew install hugo
</span></span></code></pre></div><p>或者通过github下载对应的安装包：https://github.com/gohugoio/hugo/releases</p>
<p>hugo由于版本的不兼容问题也可能带来构建报错，以下是我博客使用的版本<code>v0.101.0</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/gohugoio/hugo/releases/download/v0.101.0/hugo_0.101.0_macOS-ARM64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># hugo version</span>
</span></span><span style="display:flex;"><span>hugo v0.101.0-466fa43c16709b4483689930a4f9ac8add5c9f66+extended darwin/arm64 <span style="color:#000">BuildDate</span><span style="color:#ce5c00;font-weight:bold">=</span>2022-06-16T07:09:16Z <span style="color:#000">VendorInfo</span><span style="color:#ce5c00;font-weight:bold">=</span>gohugoio
</span></span></code></pre></div><p>hugo下使用的node的版本太低可能会导致博客生成的问题，例如本人使用12.14.0会有问题，而需要切换到node的<code>v16.20.2</code>的版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># nvm use 16.20.2</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># node -v        </span>
</span></span><span style="display:flex;"><span>v16.20.2
</span></span></code></pre></div><h1 id="5-问题">5. 问题</h1>
<h2 id="5-1-zsh-bad-cpu-type-in-executable-node">5.1. zsh: bad CPU type in executable: node</h2>
<p>执行node相关命令出现以上信息报错：<code>zsh: bad CPU type in executable: node</code>。</p>
<p>原因是mac的M1/M4系列版本与node较低的版本不兼容导致，例如node 12 以下的版本可能出现上述的问题。可以执行以下命令修复。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>softwareupdate --install-rosetta
</span></span></code></pre></div><h2 id="5-2-hexo-g-生成空白的html文件">5.2. hexo g 生成空白的html文件</h2>
<p>由于node的版本太高不兼容导致，需要降低node的版本，例如本人使用<code>12.14.0</code>是可用的，因此安装12.14.0的版本修复。</p>
<h2 id="5-3-hugo-failed-to-connect-to-github-com-port-443">5.3. hugo: Failed to connect to github.com port 443</h2>
<p>问题：使用vpn代理导致hugo命令执行时连接github超时。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Failed to connect to github.com port <span style="color:#0000cf;font-weight:bold">443</span> after <span style="color:#0000cf;font-weight:bold">75018</span> ms: Couldn<span style="color:#a40000">&#39;</span>t connect to server
</span></span></code></pre></div><p>搜索mac代理，找到代理配置的端口，例如：1087。或者打开“设置 -&gt; 网络和Internet -&gt; 代理”，记录下当前的端口号。</p>
<p>执行以下命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用VPN则设置代理</span>
</span></span><span style="display:flex;"><span>git config --global http.proxy http://127.0.0.1:1087
</span></span><span style="display:flex;"><span>git config --global https.proxy https://127.0.0.1:1087
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 未使用VPN则取消代理</span>
</span></span><span style="display:flex;"><span>git config --global <span style="color:#204a87">unset</span> https.proxy
</span></span><span style="display:flex;"><span>git config --global <span style="color:#204a87">unset</span> http.proxy
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0488542643c0e111cc5f5c82f6e0c1cd">15 - 裸金属</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-fced43a1ad90e1cdc08fa6daea3e24fb">15.1 - BMC概念</h1>
    
	<p>本文主要介绍跟baremetal相关的基本概念</p>
<h1 id="bmc-baseboard-management-controller">BMC（Baseboard Management Controller）</h1>
<p>在介绍BMC之前需要了解一个概念，即平台管理（platform management）。平台管理表示的是一系列的监视和控制功能，操作的对象是系统硬件。比如通过监视系统的温度，电压，风扇、电源等等，并做相应的调节工作，以保证系统处于健康的状态。同时平台管理还负责记录各种硬件的信息和日志记录，用于提示用户和后续问题的定位。</p>
<p>以上的这些功能可以集成到一个控制器上来实现，这个控制器被称为基板管理控制器（Baseboard Manager Controller，简称BMC）。</p>
<p><strong>BMC</strong> <strong>是独立于服务器系统之外的小型操作系统</strong>，是一个集成在主板上的芯片，也有产品是通过 PCIE 等形式插在主板上，对外表现形式只是一个标准的 RJ45 网口，拥有独立 IP 的固件系统。服务器集群一般使用 BMC 指令进行大规模无人值守操作，包括服务器的远程管理、监控、安装、重启等。</p>
<ul>
<li>
<p>BMC是一个独立的系统，它不依赖与系统上的其它硬件（比如CPU、内存等），也不依赖与BIOS、OS等。</p>
</li>
<li>
<p>BMC通过不同的接口与系统中的其它组件连接。LPC、I2C、SMBUS，Serial等，这些都是比较基本的接口，而IPMI，它是与BMC匹配的接口，所有的BMC都需要实现这种接口。</p>
</li>
</ul>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1693105510/article/baremetal/bmc.png" alt=""></p>
<h1 id="bios-basic-input-output-system">BIOS（Basic Input Output System）</h1>
<p><strong>BIOS（Basic Input Output System）</strong>，即基础输入输出系统，是刻在主板 ROM 芯片上不可篡改的启动程序，BIOS 负责计算系统自检程序（POST，Power On Self Test）和系统自启动程序，因此是计算机系统启动后的第一道程式。由于不可篡改性，故程序存储在 ROM 芯片中，并且在断电后，依然可以维持原有设置。</p>
<p>BIOS 主要功能是控制计算机启动后的基本程式，包括硬盘驱动（如装机过程中优先选择 DVD 或者 USB 启动盘），键盘设置，软盘驱动，内存和相关设备。</p>
<h1 id="ipmi-intelligent-platform-management-interface">IPMI（Intelligent Platform Management Interface）</h1>
<p>IPMI: <strong>智慧平台管理接口</strong>（Intelligent Platform Management Interface）基于硬件的平台管理系统的一组标准化规范，可以集中控制和监视服务器。</p>
<p>IPMI就是对“平台管理”这个概念的具体的规范定义，该规范定义了“平台管理”的软硬件架构，交互指令，事件格式，数据记录，能力集等。而BMC是IPMI中的一个核心部分，属于IPMI硬件架构。</p>
<p><strong>IPMI</strong>是独立于主机系统 CPU、BIOS/UEFI 和 OS 之外，可独立运行的板上部件，其核心部件即为 BMC。或者说，BMC 与其他组件如 BIOS/UEFI、CPU 等交互，都是经由 IPMI 来完成。在 IPMI 协助下，用户可以远程对关闭的服务器进行启动、重装、挂载 ISO 镜像等。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1693105510/article/baremetal/ipmi.png" alt=""></p>
<h1 id="redfish">RedFish</h1>
<p>Redfish是一种基于HTTPs服务的管理标准，利用RESTful接口实现设备管理。每个HTTPs操作都以UTF-8编码的JSON的形式，提交或返回一个资源。用于执行带外系统管理（out-of-band systems management），其适用于大规模的服务器。</p>
<p>Redfish是相当于IPMI规范的一种演化。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9518c18f4390f81263a98d07b0d07cff">15.2 - Redfish API</h1>
    
	<blockquote>
<p>本文主要介绍redfish api的调用路径及格式。</p>
</blockquote>
<p>Redfish是一种基于HTTPs服务的管理标准，利用RESTful接口实现设备管理。可以理解为redfish api就是通过http的调用方式来操作服务器的bmc设备，从而实现对设备的远程控制。</p>
<h1 id="1-bmc常用功能操作">1. BMC常用功能操作</h1>
<ul>
<li>
<p>BIOS 管理</p>
</li>
<li>
<p>启动设置（boot order）</p>
</li>
<li>
<p>虚拟媒体管理</p>
</li>
<li>
<p>电源管理（开机、关机、重启）</p>
</li>
<li>
<p>固件升级</p>
</li>
<li>
<p>远程控制（VNC/SOL）</p>
</li>
<li>
<p>监控和日志</p>
</li>
</ul>
<h1 id="2-通用-redfish-api-接口格式">2. 通用 Redfish API 接口格式</h1>
<h2 id="2-1-通用-redfish-api-接口格式">2.1. 通用 Redfish API 接口格式</h2>
<h3 id="2-1-1-基础路径结构">2.1.1. 基础路径结构</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/redfish/v1/
</span></span></code></pre></div><h3 id="2-1-2-主要资源类型">2.1.2. 主要资源类型</h3>
<ol>
<li><strong>系统资源 (Systems)</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/redfish/v1/Systems/<span style="color:#ce5c00;font-weight:bold">{</span>systemId<span style="color:#ce5c00;font-weight:bold">}</span>/
</span></span><span style="display:flex;"><span>├── Bios/                    <span style="color:#8f5902;font-style:italic"># BIOS设置</span>
</span></span><span style="display:flex;"><span>├── Boot/                    <span style="color:#8f5902;font-style:italic"># 启动设置</span>
</span></span><span style="display:flex;"><span>├── Memory/                  <span style="color:#8f5902;font-style:italic"># 内存信息</span>
</span></span><span style="display:flex;"><span>├── Processors/              <span style="color:#8f5902;font-style:italic"># 处理器信息</span>
</span></span><span style="display:flex;"><span>├── Storage/                 <span style="color:#8f5902;font-style:italic"># 存储信息</span>
</span></span><span style="display:flex;"><span>├── EthernetInterfaces/      <span style="color:#8f5902;font-style:italic"># 网络接口</span>
</span></span><span style="display:flex;"><span>└── Actions/                 <span style="color:#8f5902;font-style:italic"># 系统操作</span>
</span></span></code></pre></div><ol start="2">
<li><strong>机箱资源 (Chassis)</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/redfish/v1/Chassis/<span style="color:#ce5c00;font-weight:bold">{</span>chassisId<span style="color:#ce5c00;font-weight:bold">}</span>/
</span></span><span style="display:flex;"><span>├── Power/                   <span style="color:#8f5902;font-style:italic"># 电源管理</span>
</span></span><span style="display:flex;"><span>├── Thermal/                 <span style="color:#8f5902;font-style:italic"># 温度管理</span>
</span></span><span style="display:flex;"><span>├── NetworkAdapters/         <span style="color:#8f5902;font-style:italic"># 网络适配器</span>
</span></span><span style="display:flex;"><span>└── Actions/                 <span style="color:#8f5902;font-style:italic"># 机箱操作</span>
</span></span></code></pre></div><ol start="3">
<li><strong>管理控制器 (Managers)</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/redfish/v1/Managers/<span style="color:#ce5c00;font-weight:bold">{</span>managerId<span style="color:#ce5c00;font-weight:bold">}</span>/
</span></span><span style="display:flex;"><span>├── NetworkProtocol/         <span style="color:#8f5902;font-style:italic"># 网络协议</span>
</span></span><span style="display:flex;"><span>├── VirtualMedia/            <span style="color:#8f5902;font-style:italic"># 虚拟媒体</span>
</span></span><span style="display:flex;"><span>├── LogServices/            <span style="color:#8f5902;font-style:italic"># 日志服务</span>
</span></span><span style="display:flex;"><span>└── Actions/                <span style="color:#8f5902;font-style:italic"># 管理操作</span>
</span></span></code></pre></div><ol start="4">
<li><strong>更新服务 (UpdateService)</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/redfish/v1/UpdateService/
</span></span><span style="display:flex;"><span>├── FirmwareInventory/      <span style="color:#8f5902;font-style:italic"># 固件清单</span>
</span></span><span style="display:flex;"><span>└── Actions/                <span style="color:#8f5902;font-style:italic"># 更新操作</span>
</span></span></code></pre></div><h1 id="3-bios-管理">3. BIOS 管理</h1>
<h2 id="1-通用-bios-接口路径">1. 通用 BIOS 接口路径</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/redfish/v1/Systems/<span style="color:#ce5c00;font-weight:bold">{</span>systemId<span style="color:#ce5c00;font-weight:bold">}</span>/Bios
</span></span></code></pre></div><p>获取 BIOS 属性</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>GET /redfish/v1/Systems/<span style="color:#ce5c00;font-weight:bold">{</span>systemId<span style="color:#ce5c00;font-weight:bold">}</span>/Bios
</span></span></code></pre></div><p>设置 BIOS 属性</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PATCH /redfish/v1/Systems/<span style="color:#ce5c00;font-weight:bold">{</span>systemId<span style="color:#ce5c00;font-weight:bold">}</span>/Bios/Settings
</span></span></code></pre></div><h2 id="2-各厂商路径">2. 各厂商路径</h2>
<table>
<thead>
<tr>
<th>厂商</th>
<th>操作</th>
<th>方法</th>
<th>路径</th>
<th>request</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dell</td>
<td>获取 BIOS 属性</td>
<td>GET</td>
<td>/redfish/v1/Systems/{systemId}/Bios</td>
<td></td>
</tr>
<tr>
<td></td>
<td>设置 BIOS 属性</td>
<td>PATCH</td>
<td>/redfish/v1/Systems/{systemId}/Bios/Settings</td>
<td>{&quot;Attributes&quot;:                 attrs,<br /> &quot;@Redfish.SettingsApplyTime&quot;: &quot;OnReset&quot;}</td>
</tr>
<tr>
<td>HPE</td>
<td>获取 BIOS 属性</td>
<td>GET</td>
<td>/redfish/v1/Systems/{systemId}/Bios</td>
<td></td>
</tr>
<tr>
<td></td>
<td>设置 BIOS 属性</td>
<td>PATCH</td>
<td>/redfish/v1/Systems/{systemId}/Bios/Settings</td>
<td>{&quot;Attributes&quot;:                 attrs,<br /> &quot;@Redfish.SettingsApplyTime&quot;: &quot;OnReset&quot;}</td>
</tr>
<tr>
<td>HUAWEI</td>
<td>获取 BIOS 属性</td>
<td>GET</td>
<td>/redfish/v1/Systems/{systemId}/Bios</td>
<td></td>
</tr>
<tr>
<td></td>
<td>设置 BIOS 属性</td>
<td>PATCH</td>
<td>/redfish/v1/Systems/{systemId}/Bios/Settings</td>
<td>{ &quot;Attributes&quot;: attrs}</td>
</tr>
<tr>
<td>Inspur</td>
<td>获取 BIOS 属性</td>
<td>GET</td>
<td>/redfish/v1/Systems/{systemId}/Bios</td>
<td></td>
</tr>
<tr>
<td></td>
<td>设置 BIOS 属性</td>
<td>PATCH</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Lenovo</td>
<td>获取 BIOS 属性</td>
<td>GET</td>
<td>/redfish/v1/Systems/{systemId}/Bios</td>
<td></td>
</tr>
<tr>
<td></td>
<td>设置 BIOS 属性</td>
<td>PATCH</td>
<td>/redfish/v1/Systems/{systemId}/Bios/Settings</td>
<td>{ &quot;Attributes&quot;: attrs}</td>
</tr>
<tr>
<td>xFusion</td>
<td>获取 BIOS 属性</td>
<td>GET</td>
<td>/redfish/v1/Systems/{systemId}/Bios</td>
<td></td>
</tr>
<tr>
<td></td>
<td>设置 BIOS 属性</td>
<td>PATCH</td>
<td>/redfish/v1/Systems/{systemId}/Bios/Settings</td>
<td>{ &quot;Attributes&quot;: attrs}</td>
</tr>
</tbody>
</table>
<h1 id="4-启动设置-boot-order">4. 启动设置（boot order）</h1>
<h1 id="5-virtualmedia-的通用接口路径">5. VirtualMedia 的通用接口路径</h1>
<h2 id="1-通用-virtualmedia-接口路径">1. 通用 VirtualMedia 接口路径</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/redfish/v1/Managers/<span style="color:#ce5c00;font-weight:bold">{</span>managerId<span style="color:#ce5c00;font-weight:bold">}</span>/VirtualMedia/<span style="color:#ce5c00;font-weight:bold">{</span>mediaId<span style="color:#ce5c00;font-weight:bold">}</span>/
</span></span></code></pre></div><p>获取虚拟媒体信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>GET /redfish/v1/Managers/<span style="color:#ce5c00;font-weight:bold">{</span>managerId<span style="color:#ce5c00;font-weight:bold">}</span>/VirtualMedia/<span style="color:#ce5c00;font-weight:bold">{</span>mediaId<span style="color:#ce5c00;font-weight:bold">}</span>/
</span></span></code></pre></div><p>插入虚拟媒体</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>POST /redfish/v1/Managers/<span style="color:#ce5c00;font-weight:bold">{</span>managerId<span style="color:#ce5c00;font-weight:bold">}</span>/VirtualMedia/<span style="color:#ce5c00;font-weight:bold">{</span>mediaId<span style="color:#ce5c00;font-weight:bold">}</span>/Actions/VirtualMedia.InsertMedia
</span></span></code></pre></div><p>弹出虚拟媒体</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>POST /redfish/v1/Managers/<span style="color:#ce5c00;font-weight:bold">{</span>managerId<span style="color:#ce5c00;font-weight:bold">}</span>/VirtualMedia/<span style="color:#ce5c00;font-weight:bold">{</span>mediaId<span style="color:#ce5c00;font-weight:bold">}</span>/Actions/VirtualMedia.EjectMedia
</span></span></code></pre></div><h2 id="2-各厂商路径-1">2. 各厂商路径</h2>
<table>
<thead>
<tr>
<th>厂商</th>
<th>操作</th>
<th>方法</th>
<th>路径</th>
<th>request</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dell</td>
<td>获取VirtualMedia</td>
<td>GET</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/CD</td>
<td></td>
</tr>
<tr>
<td></td>
<td>插入VirtualMedia</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>弹出VirtualMedia</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>HPE</td>
<td>获取VirtualMedia</td>
<td>GET</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/{mediaId}</td>
<td></td>
</tr>
<tr>
<td></td>
<td>插入VirtualMedia</td>
<td>POST</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/{mediaId}/Actions/VirtualMedia.InsertMedia</td>
<td>{<br/> &quot;Image&quot;: &quot;string&quot;,<br/> &quot;Inserted&quot;: boolean,<br/> &quot;WriteProtected&quot;: boolean<br/>}</td>
</tr>
<tr>
<td></td>
<td>弹出VirtualMedia</td>
<td>POST</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/{mediaId}/Actions/VirtualMedia.EjectMedia</td>
<td></td>
</tr>
<tr>
<td>HUAWEI</td>
<td>获取VirtualMedia</td>
<td>GET</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/CD</td>
<td></td>
</tr>
<tr>
<td></td>
<td>插入VirtualMedia</td>
<td>POST</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/CD/Oem/Huawei/Actions/VirtualMedia.VmmControl</td>
<td>{&quot;VmmControlType&quot;: &quot;Connect&quot;,<br/> &quot;Image&quot;: imageURL}</td>
</tr>
<tr>
<td></td>
<td>弹出VirtualMedia</td>
<td>POST</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/CD/Oem/Huawei/Actions/VirtualMedia.VmmControl</td>
<td>{&quot;VmmControlType&quot;: &quot;Disconnect&quot;}</td>
</tr>
<tr>
<td>Inspur(M6)</td>
<td>获取VirtualMedia</td>
<td>GET</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/{mediaId}</td>
<td>mediaId=CD/CD1</td>
</tr>
<tr>
<td></td>
<td>插入VirtualMedia</td>
<td>POST</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/{mediaId}/Actions/VirtualMedia.InsertMedia</td>
<td>{&quot;Image&quot;: image,<br/>&quot;TransferProtocolType&quot;: &quot;NFS&quot;}</td>
</tr>
<tr>
<td></td>
<td>弹出VirtualMedia</td>
<td>POST</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/{mediaId}/Actions/VirtualMedia.EjectMedia</td>
<td></td>
</tr>
<tr>
<td>Lenovo</td>
<td>获取VirtualMedia</td>
<td>GET</td>
<td>/redfish/v1/Systems/{systemId}/VirtualMedia/EXT1</td>
<td></td>
</tr>
<tr>
<td></td>
<td>插入VirtualMedia</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>弹出VirtualMedia</td>
<td>PATCH</td>
<td>/redfish/v1/Systems/{systemId}/VirtualMedia/EXT1</td>
<td>{&quot;Inserted&quot;: false}</td>
</tr>
<tr>
<td>xFusion(华为子品牌)</td>
<td>获取VirtualMedia</td>
<td>GET</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/CD</td>
<td></td>
</tr>
<tr>
<td></td>
<td>插入VirtualMedia</td>
<td>POST</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/CD/Oem/xFusion/Actions/VirtualMedia.VmmControl</td>
<td>{&quot;VmmControlType&quot;: &quot;Connect&quot;,<br/> &quot;Image&quot;: imageURL}</td>
</tr>
<tr>
<td></td>
<td>弹出VirtualMedia</td>
<td>POST</td>
<td>/redfish/v1/Managers/{managerId}/VirtualMedia/CD/Oem/xFusion/Actions/VirtualMedia.VmmControl</td>
<td>{&quot;VmmControlType&quot;: &quot;Disconnect&quot;}</td>
</tr>
</tbody>
</table>
<h1 id="6-电源管理-开机-关机-重启">6. 电源管理（开机、关机、重启）</h1>
<h1 id="7-固件升级">7. 固件升级</h1>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-37f45ccd9b715779fda2cec095a76286">15.3 - 格式化磁盘分区</h1>
    
	<p>本文主要描述重装操作系统如何格式化跟分区和数据盘以及设置磁盘挂载配置。</p>
<h1 id="1-将操作系统写入根分区设备">1.将操作系统写入根分区设备</h1>
<p><strong>1、解绑根分区磁盘目录挂载</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如跟分区下的挂载目录如下：</span>
</span></span><span style="display:flex;"><span>cat /proc/mounts <span style="color:#000;font-weight:bold">|</span> grep ^/dev/sda
</span></span><span style="display:flex;"><span>/dev/sda4 / ext4 rw,relatime,errors<span style="color:#ce5c00;font-weight:bold">=</span>remount-ro <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>/dev/sda3 /boot ext4 rw,relatime <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>/dev/sda2 /boot/efi vfat rw,relatime,fmask<span style="color:#ce5c00;font-weight:bold">=</span>0077,dmask<span style="color:#ce5c00;font-weight:bold">=</span>0077,codepage<span style="color:#ce5c00;font-weight:bold">=</span>437,iocharset<span style="color:#ce5c00;font-weight:bold">=</span>iso8859-1,shortname<span style="color:#ce5c00;font-weight:bold">=</span>mixed,errors<span style="color:#ce5c00;font-weight:bold">=</span>remount-ro <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如根分区的块设备是/dev/sda，则解绑该块设备下所有挂载目录</span>
</span></span><span style="display:flex;"><span>cat /proc/mounts <span style="color:#000;font-weight:bold">|</span> grep ^/dev/sda <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $2}&#39;</span> <span style="color:#000;font-weight:bold">|</span> xargs -n1 -i umount <span style="color:#ce5c00;font-weight:bold">{}</span>
</span></span></code></pre></div><p><strong>2、删除块设备分区</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sfdisk --delete /dev/sda
</span></span></code></pre></div><p><strong>3、将操作系统镜像写入根分区设备</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>qemu-img dd -f qcow2 -O raw <span style="color:#000">bs</span><span style="color:#ce5c00;font-weight:bold">=</span>16M <span style="color:#204a87;font-weight:bold">if</span><span style="color:#ce5c00;font-weight:bold">=</span>osi.qcow2 <span style="color:#000">of</span><span style="color:#ce5c00;font-weight:bold">=</span>/dev/sda
</span></span></code></pre></div><p>命令参数说明：</p>
<ul>
<li>
<p><strong><code>-f qcow2</code></strong></p>
<ul>
<li>指定输入文件的格式为 <code>qcow2</code>（QEMU Copy-On-Write v2）。</li>
<li><code>osi.qcow2</code> 是一个虚拟磁盘文件，包含系统或数据。</li>
</ul>
</li>
<li>
<p><strong><code>-O raw</code></strong></p>
<ul>
<li>指定输出格式为 <code>raw</code>，即不包含额外元数据的裸数据格式。</li>
<li>裸数据格式适用于直接写入物理磁盘设备。</li>
</ul>
</li>
<li>
<p><strong><code>bs=16M</code></strong></p>
<ul>
<li>设置块大小为 16 MB，在数据复制过程中以 16 MB 为单位进行读写。</li>
<li>较大的块大小通常能提高写入效率，特别是对大容量文件。</li>
</ul>
</li>
<li>
<p><strong><code>if=osi.qcow2</code></strong></p>
<ul>
<li>输入文件路径，<code>osi.qcow2</code> 是源虚拟磁盘镜像文件。</li>
</ul>
</li>
<li>
<p><strong><code>of=/dev/sda</code></strong></p>
<ul>
<li>输出文件路径，<code>/dev/sda</code> 是目标物理磁盘设备。</li>
<li>数据将直接写入 <code>/dev/sda</code>，覆盖其内容。</li>
</ul>
</li>
</ul>
<p><strong>4、检查并修复根分区</strong></p>
<ul>
<li>如果分区表无问题，<code>parted</code> 会直接显示分区信息。</li>
<li>如果检测到分区表错误，<code>parted</code> 会自动应用修复并输出结果。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> Fix <span style="color:#000;font-weight:bold">|</span> parted ---pretend-input-tty /dev/sda print
</span></span></code></pre></div><p><strong>5、 通知内核重新读取分区表</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通知内核重新加载指定设备的分区表，无需重启</span>
</span></span><span style="display:flex;"><span>partprobe /dev/sda
</span></span></code></pre></div><h1 id="2-根分区设备重新分区">2. 根分区设备重新分区</h1>
<p>跟设备的分区主要包括三个分区</p>
<ul>
<li>
<p><code>swap分区</code>：是否需要做swap分区</p>
</li>
<li>
<p><code>根分区</code>：在swap分区做完后再做根分区</p>
</li>
<li>
<p><code>跟设备的data分区</code>：在根分区做完后再做data分区。</p>
</li>
</ul>
<h2 id="2-1-配置swap分区">2.1. 配置swap分区</h2>
<p><code>swap分区一般从根分区设备大小中切分出来128G作为swap的分区，剩余的做根分区和data分区。</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 假设跟设备为sda</span>
</span></span><span style="display:flex;"><span><span style="color:#000">root_device</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;sda&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">swap_device_num</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 假设swap分区的大小是128G，换算为131072MiB</span>
</span></span><span style="display:flex;"><span><span style="color:#000">swap_size</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">131072</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 移除根分区</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> Ignore <span style="color:#000;font-weight:bold">|</span> parted ---pretend-input-tty /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}</span> rm <span style="color:#4e9a06">${</span><span style="color:#000">swap_device_num</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取指定磁盘设备上最后一段空闲空间的起始位置（单位为 MiB）以便新建分区。</span>
</span></span><span style="display:flex;"><span><span style="color:#000">free_end</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>parted /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}</span> unit MiB print free <span style="color:#000;font-weight:bold">|</span> grep <span style="color:#4e9a06">&#39;Free Space&#39;</span><span style="color:#000;font-weight:bold">|</span>tail -1 <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $1}&#39;</span> <span style="color:#000;font-weight:bold">|</span> sed <span style="color:#4e9a06">&#39;s/MiB//&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建指定大小的swap分区</span>
</span></span><span style="display:flex;"><span><span style="color:#000">swap_start</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">free_end</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">swap_end</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$((</span>swap_start <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">${</span><span style="color:#000">swap_size</span><span style="color:#4e9a06">}</span><span style="color:#204a87;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> Ignore <span style="color:#000;font-weight:bold">|</span> parted ---pretend-input-tty /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}</span> -- mkpart primary <span style="color:#4e9a06">${</span><span style="color:#000">swap_start</span><span style="color:#4e9a06">}</span>MiB <span style="color:#4e9a06">${</span><span style="color:#000">swap_end</span><span style="color:#4e9a06">}</span>MiB
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 格式化分区为 Swap 类型，例如：mkswap /dev/sda1</span>
</span></span><span style="display:flex;"><span>mkswap /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}${</span><span style="color:#000">swap_device_num</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><h2 id="2-2-格式化根分区">2.2. 格式化根分区</h2>
<h3 id="2-2-1-未指定根分区大小">2.2.1. 未指定根分区大小</h3>
<p>如果没有指定根分区大小，一般不需要再做一个data分区，而是把根分区扩展为剩余的所有空间。</p>
<p>1、如果根分区目录没有指定分区大小，且没有做swap分区。则重新调整大小，扩展到设备的所有剩余空间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">root_device</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;sda&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">root_device_num</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> Yes <span style="color:#000;font-weight:bold">|</span> parted ---pretend-input-tty /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}</span> -- resizepart <span style="color:#4e9a06">${</span><span style="color:#000">root_device_num</span><span style="color:#4e9a06">}</span> 100%
</span></span></code></pre></div><p>2、如果根分区没有指定分区大小，但是有做swap分区。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">root_device</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;sda&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取空闲空间的起始位置</span>
</span></span><span style="display:flex;"><span><span style="color:#000">root_start</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>parted /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}</span> unit MiB print free <span style="color:#000;font-weight:bold">|</span> grep <span style="color:#4e9a06">&#39;Free Space&#39;</span><span style="color:#000;font-weight:bold">|</span>tail -1 <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $1}&#39;</span> <span style="color:#000;font-weight:bold">|</span> sed <span style="color:#4e9a06">&#39;s/MiB//&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将剩余空间做一个root分区</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> Ignore <span style="color:#000;font-weight:bold">|</span> parted ---pretend-input-tty /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}</span> -- mkpart primary <span style="color:#4e9a06">${</span><span style="color:#000">root_start</span><span style="color:#4e9a06">}</span>MiB 100%
</span></span></code></pre></div><h3 id="2-2-2-指定根分区大小">2.2.2. 指定根分区大小</h3>
<p>如果指定了根分区大小，一般需要再创建一个data分区，将data分区扩展为剩余的所有的空间。</p>
<p>1、如果根分区目录有指定大小，且没有做swap分区。则按指定大小分区，例如将跟分区大小设置300G</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">root_device</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;sda&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">root_device_num</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">root_size</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">307200</span> <span style="color:#8f5902;font-style:italic"># 300G换算成单位MiB</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取根分区的起始位置和终止位置</span>
</span></span><span style="display:flex;"><span><span style="color:#000">root_start</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>parted /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}</span> unit MiB print <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;/./{end=$2} END{print end}&#39;</span> <span style="color:#000;font-weight:bold">|</span> sed <span style="color:#4e9a06">&#39;s/MiB//&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">root_end</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$((</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">+</span> root_start <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">${</span><span style="color:#000">root_size</span><span style="color:#4e9a06">}</span><span style="color:#204a87;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 调整跟分区大小</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> Yes <span style="color:#000;font-weight:bold">|</span> parted ---pretend-input-tty /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}</span> -- resizepart <span style="color:#4e9a06">${</span><span style="color:#000">root_device_num</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">${</span><span style="color:#000">root_end</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><p>2、如果根分区有指定大小，但是有做swap分区。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">root_device</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;sda&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">root_device_num</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">root_size</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">307200</span> <span style="color:#8f5902;font-style:italic"># 300G换算成单位MiB</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取根分区的起始位置和终止位置</span>
</span></span><span style="display:flex;"><span><span style="color:#000">root_start</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>parted /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}</span> unit MiB print free <span style="color:#000;font-weight:bold">|</span> grep <span style="color:#4e9a06">&#39;Free Space&#39;</span><span style="color:#000;font-weight:bold">|</span>tail -1 <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $1}&#39;</span> <span style="color:#000;font-weight:bold">|</span> sed <span style="color:#4e9a06">&#39;s/MiB//&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">root_end</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$((</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">+</span> root_start <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">${</span><span style="color:#000">root_size</span><span style="color:#4e9a06">}</span><span style="color:#204a87;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建指定大小的根分区</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> Ignore <span style="color:#000;font-weight:bold">|</span> parted ---pretend-input-tty /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}</span> -- mkpart primary <span style="color:#4e9a06">${</span><span style="color:#000">root_start</span><span style="color:#4e9a06">}</span>MiB <span style="color:#4e9a06">${</span><span style="color:#000">root_end</span><span style="color:#4e9a06">}</span>MiB
</span></span></code></pre></div><h2 id="2-3-创建跟设备的data分区">2.3. 创建跟设备的data分区</h2>
<p>如果有指定需要创建跟设备的data分区，则在创建完swap分区和根分区后，继续创建data分区。</p>
<p>1、创建跟设备的data分区</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">root_device</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;sda&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取空闲空间的起始位置</span>
</span></span><span style="display:flex;"><span><span style="color:#000">data_start</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>parted /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}</span> unit MiB print free <span style="color:#000;font-weight:bold">|</span> grep <span style="color:#4e9a06">&#39;Free Space&#39;</span><span style="color:#000;font-weight:bold">|</span>tail -1 <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $1}&#39;</span> <span style="color:#000;font-weight:bold">|</span> sed <span style="color:#4e9a06">&#39;s/MiB//&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将剩余空间做一个data分区</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> Ignore <span style="color:#000;font-weight:bold">|</span> parted ---pretend-input-tty /dev/<span style="color:#4e9a06">${</span><span style="color:#000">root_device</span><span style="color:#4e9a06">}</span> -- mkpart primary <span style="color:#4e9a06">${</span><span style="color:#000">data_start</span><span style="color:#4e9a06">}</span>MiB 100%
</span></span></code></pre></div><p>2、格式化根data分区的文件系统</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># data分区的序号一般是在root分区的序号+1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">device</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/dev/sda2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 格式化为xfs文件系统</span>
</span></span><span style="display:flex;"><span>mkfs.xfs -f -n <span style="color:#000">ftype</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#4e9a06">${</span><span style="color:#000">device</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 格式化为ext4文件系统</span>
</span></span><span style="display:flex;"><span>mkfs.ext4 -F <span style="color:#4e9a06">${</span><span style="color:#000">device</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><h1 id="2-格式化数据盘">2. 格式化数据盘</h1>
<p><strong>1、找出数据盘所对应的块设备，例如：<code>/dev/sdb</code></strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lsblk -J -d
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#4e9a06">&#34;blockdevices&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;name&#34;</span>:<span style="color:#4e9a06">&#34;sda&#34;</span>, <span style="color:#4e9a06">&#34;maj:min&#34;</span>:<span style="color:#4e9a06">&#34;8:0&#34;</span>, <span style="color:#4e9a06">&#34;rm&#34;</span>:false, <span style="color:#4e9a06">&#34;size&#34;</span>:<span style="color:#4e9a06">&#34;1.1T&#34;</span>, <span style="color:#4e9a06">&#34;ro&#34;</span>:false, <span style="color:#4e9a06">&#34;type&#34;</span>:<span style="color:#4e9a06">&#34;disk&#34;</span>, <span style="color:#4e9a06">&#34;mountpoint&#34;</span>:null<span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;name&#34;</span>:<span style="color:#4e9a06">&#34;sdb&#34;</span>, <span style="color:#4e9a06">&#34;maj:min&#34;</span>:<span style="color:#4e9a06">&#34;8:16&#34;</span>, <span style="color:#4e9a06">&#34;rm&#34;</span>:false, <span style="color:#4e9a06">&#34;size&#34;</span>:<span style="color:#4e9a06">&#34;6.1T&#34;</span>, <span style="color:#4e9a06">&#34;ro&#34;</span>:false, <span style="color:#4e9a06">&#34;type&#34;</span>:<span style="color:#4e9a06">&#34;disk&#34;</span>, <span style="color:#4e9a06">&#34;mountpoint&#34;</span>:<span style="color:#4e9a06">&#34;/data&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>2、删除块设备分区并重建分区</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除块设备所有的分区</span>
</span></span><span style="display:flex;"><span>sfdisk --delete /dev/sdb
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将分区重建为GPT格式</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> label:gpt <span style="color:#000;font-weight:bold">|</span> sfdisk /dev/sdb
</span></span></code></pre></div><p><strong>3、 通知内核重新读取分区表</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通知内核重新加载指定设备的分区表，无需重启</span>
</span></span><span style="display:flex;"><span>partprobe /dev/sdb
</span></span></code></pre></div><p><strong>4、格式化数据盘的文件系统</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 格式化为xfs文件系统</span>
</span></span><span style="display:flex;"><span>mkfs.xfs -f -n <span style="color:#000">ftype</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span> /dev/sdb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 格式化为ext4文件系统</span>
</span></span><span style="display:flex;"><span>mkfs.ext4 -F /dev/sdb
</span></span></code></pre></div><h1 id="3-设置fstab磁盘挂载">3. 设置fstab磁盘挂载</h1>
<p>设置swap分区磁盘挂载</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">swap_uuid</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>lsblk -f <span style="color:#000;font-weight:bold">|</span>grep swap<span style="color:#000;font-weight:bold">|</span>awk <span style="color:#4e9a06">&#39;{print $3}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;UUID=</span><span style="color:#4e9a06">${</span><span style="color:#000">swap_uuid</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> swap swap defaults 0 0&#34;</span> &gt;&gt; /etc/fstab
</span></span></code></pre></div><p>设置根分区磁盘挂载</p>
<blockquote>
<p>todo</p>
</blockquote>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f9e021ef17cb105673447af8aecd0337">16 - 大模型</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-093f126ec9e750c4adca83e14d272d51">16.1 - 基于Ollama构建本地大模型</h1>
    
	<p>本文主要介绍如何通过<code>Ollama</code>和<code>OpenWebUI</code>来搭建一个本地私有化运行的大模型工具。私有化大模型的构建主要用于解决<code>数据的安全性问题</code>，对于大部分私有数据不适合通过外部的大模型网站来上传和分析。</p>
<h1 id="1-ollama-与-openwebui-介绍">1. Ollama 与 OpenWebUI 介绍</h1>
<h2 id="1-1-ollama简介">1.1. Ollama简介</h2>
<p>Ollama 是一个 <strong>本地运行的 AI 大模型管理工具</strong>，可以让你在本地 <strong>快速拉取、管理和运行</strong> 各种开源大语言模型（如 LLaMA、Mistral、deepseek 等），而无需依赖云端 API。它的主要特点包括：</p>
<ul>
<li><strong>简易安装</strong>：支持 macOS、Linux 和 Windows（WSL）。</li>
<li><strong>本地推理</strong>：在本地设备上直接运行 LLM，保护数据隐私。</li>
<li><strong>模型管理</strong>：可以像使用 Docker 一样 <code>ollama run llama2</code> 轻松拉取和运行模型。</li>
<li><strong>自定义模型</strong>：支持通过 <code>Modelfile</code> 进行微调和定制。</li>
<li><strong>支持 API</strong>：可以通过 Python、Node.js 等语言调用 Ollama 提供的本地 REST API。</li>
</ul>
<p>Ollama 适用于本地 AI 代理、嵌入式 AI 应用、隐私保护的智能助手等场景。你可以用它来运行大语言模型，而无需自己搭建复杂的推理环境。</p>
<h2 id="1-2-openwebui简介">1.2. OpenWebUI简介</h2>
<p><strong>Open-WebUI</strong> 是一个 <strong>开源的 Web 用户界面</strong>，用于管理和使用本地或远程的大语言模型（LLM），比如 Ollama、OpenAI、Gemini 等。它的主要特点包括：</p>
<ul>
<li><strong>友好的 Web 界面</strong>：提供 ChatGPT 类似的对话 UI，方便交互。</li>
<li><strong>支持多种后端</strong>：可以连接 <strong>Ollama、OpenAI API、本地 LLM</strong> 等。</li>
<li><strong>多用户支持</strong>：适用于团队协作。</li>
<li><strong>对话历史管理</strong>：可保存和管理聊天记录。</li>
<li><strong>插件和自定义功能</strong>：支持扩展，适用于不同应用场景。</li>
</ul>
<p>它可以让本地 LLM 变得更加易用，适合个人、企业部署本地 AI 助手。</p>
<h1 id="2-部署ollama">2. 部署ollama</h1>
<h2 id="2-1-脚本安装-ollama">2.1. 脚本安装<code>ollama</code></h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsSL https://ollama.com/install.sh <span style="color:#000;font-weight:bold">|</span> sh
</span></span></code></pre></div><p>输出</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt;&gt;&gt; Installing ollama to /usr/local
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Downloading Linux amd64 bundle
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">######################################################################## 100.0%</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Creating ollama user...
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Adding ollama user to render group...
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Adding ollama user to video group...
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Adding current user to ollama group...
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Creating ollama systemd service...
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Enabling and starting ollama service...
</span></span><span style="display:flex;"><span>Created symlink /etc/systemd/system/default.target.wants/ollama.service -&gt; /etc/systemd/system/ollama.service.
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; The Ollama API is now available at 127.0.0.1:11434.
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Install complete. Run <span style="color:#4e9a06">&#34;ollama&#34;</span> from the <span style="color:#204a87">command</span> line.
</span></span><span style="display:flex;"><span>WARNING: No NVIDIA/AMD GPU detected. Ollama will run in CPU-only mode.
</span></span></code></pre></div><p>默认服务监听的地址为：<code>127.0.0.1:11434</code></p>
<h2 id="2-2-查看-ollama-服务状态">2.2. 查看<code>ollama</code>服务状态</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl status ollama
</span></span><span style="display:flex;"><span>* ollama.service - Ollama Service
</span></span><span style="display:flex;"><span>     Loaded: loaded <span style="color:#ce5c00;font-weight:bold">(</span>/etc/systemd/system/ollama.service<span style="color:#000;font-weight:bold">;</span> enabled<span style="color:#000;font-weight:bold">;</span> vendor preset: enabled<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>     Active: active <span style="color:#ce5c00;font-weight:bold">(</span>running<span style="color:#ce5c00;font-weight:bold">)</span> since Fri 2025-02-07 17:21:55 +08<span style="color:#000;font-weight:bold">;</span> 23s ago
</span></span><span style="display:flex;"><span>   Main PID: <span style="color:#0000cf;font-weight:bold">53472</span> <span style="color:#ce5c00;font-weight:bold">(</span>ollama<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      Tasks: <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>     Memory: 10.3M
</span></span><span style="display:flex;"><span>     CGroup: /system.slice/ollama.service
</span></span><span style="display:flex;"><span>             <span style="color:#4e9a06">`</span>-53472 /usr/local/bin/ollama serve
</span></span></code></pre></div><p>查看<code>ollama</code>命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ollama --help</span>
</span></span><span style="display:flex;"><span>Large language model runner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  ollama <span style="color:#ce5c00;font-weight:bold">[</span>flags<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  ollama <span style="color:#ce5c00;font-weight:bold">[</span>command<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available Commands:
</span></span><span style="display:flex;"><span>  serve       Start ollama
</span></span><span style="display:flex;"><span>  create      Create a model from a Modelfile
</span></span><span style="display:flex;"><span>  show        Show information <span style="color:#204a87;font-weight:bold">for</span> a model
</span></span><span style="display:flex;"><span>  run         Run a model
</span></span><span style="display:flex;"><span>  stop        Stop a running model
</span></span><span style="display:flex;"><span>  pull        Pull a model from a registry
</span></span><span style="display:flex;"><span>  push        Push a model to a registry
</span></span><span style="display:flex;"><span>  list        List models
</span></span><span style="display:flex;"><span>  ps          List running models
</span></span><span style="display:flex;"><span>  cp          Copy a model
</span></span><span style="display:flex;"><span>  rm          Remove a model
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">help</span>        Help about any <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>  -h, --help      <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> ollama
</span></span><span style="display:flex;"><span>  -v, --version   Show version information
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;ollama [command] --help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information about a command.
</span></span></code></pre></div><h2 id="2-3-拉取一个大模型">2.3. 拉取一个大模型</h2>
<p>可以在 <a href="https://ollama.com/search">https://ollama.com/search</a> 网站上，选择一个所需要的大模型，例如<code>deepseek-r1:7b</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下载指定的大模型，例如deepseek</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ollama pull deepseek-r1:7b</span>
</span></span><span style="display:flex;"><span>pulling manifest
</span></span><span style="display:flex;"><span>pulling 96c415656d37... 100% ▕███████████████████████████████████████████████████████████████████████████████████████████████████████████▏ 4.7 GB
</span></span><span style="display:flex;"><span>pulling 369ca498f347... 100% ▕███████████████████████████████████████████████████████████████████████████████████████████████████████████▏  <span style="color:#0000cf;font-weight:bold">387</span> B
</span></span><span style="display:flex;"><span>pulling 6e4c38e1172f... 100% ▕███████████████████████████████████████████████████████████████████████████████████████████████████████████▏ 1.1 KB
</span></span><span style="display:flex;"><span>pulling f4d24e9138dd... 100% ▕███████████████████████████████████████████████████████████████████████████████████████████████████████████▏  <span style="color:#0000cf;font-weight:bold">148</span> B
</span></span><span style="display:flex;"><span>pulling 40fb844194b2... 100% ▕███████████████████████████████████████████████████████████████████████████████████████████████████████████▏  <span style="color:#0000cf;font-weight:bold">487</span> B
</span></span><span style="display:flex;"><span>verifying sha256 digest
</span></span><span style="display:flex;"><span>writing manifest
</span></span><span style="display:flex;"><span>success
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ollama list</span>
</span></span><span style="display:flex;"><span>NAME              ID              SIZE      MODIFIED
</span></span><span style="display:flex;"><span>deepseek-r1:7b    0a8c26691023    4.7 GB    <span style="color:#0000cf;font-weight:bold">12</span> minutes ago
</span></span></code></pre></div><h2 id="2-4-运行大模型">2.4. 运行大模型</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ollama run deepseek-r1:7b</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 你是谁
</span></span><span style="display:flex;"><span>&lt;think&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;/think&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>您好！我是由中国的深度求索（DeepSeek）公司开发的智能助手DeepSeek-R1。如您有任何任何问题，我会尽我所能为您提供帮助。
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; /bye
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看正在运行的模型</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ollama ps</span>
</span></span><span style="display:flex;"><span>NAME              ID              SIZE      PROCESSOR    UNTIL
</span></span><span style="display:flex;"><span>deepseek-r1:7b    0a8c26691023    5.5 GB    100% CPU     <span style="color:#0000cf;font-weight:bold">3</span> minutes from now
</span></span></code></pre></div><h2 id="2-5-修改ollama服务地址和目录">2.5. 修改ollama服务地址和目录</h2>
<h3 id="2-5-1-修改ollama服务地址">2.5.1. 修改ollama服务地址</h3>
<p>ollama服务默认监听127.0.0.1, 如果要修改监听地址，则可以添加<code>Environment=&quot;OLLAMA_HOST=0.0.0.0:11434&quot;</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /etc/systemd/system/ollama.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Unit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Description</span><span style="color:#ce5c00;font-weight:bold">=</span>Ollama Service
</span></span><span style="display:flex;"><span><span style="color:#000">After</span><span style="color:#ce5c00;font-weight:bold">=</span>network-online.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Service<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;OLLAMA_HOST=0.0.0.0:11434&#34;</span>   <span style="color:#8f5902;font-style:italic"># 增加环境变量</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ExecStart</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/bin/ollama serve
</span></span><span style="display:flex;"><span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">=</span>ollama
</span></span><span style="display:flex;"><span><span style="color:#000">Group</span><span style="color:#ce5c00;font-weight:bold">=</span>ollama
</span></span><span style="display:flex;"><span><span style="color:#000">Restart</span><span style="color:#ce5c00;font-weight:bold">=</span>always
</span></span><span style="display:flex;"><span><span style="color:#000">RestartSec</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Install<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">WantedBy</span><span style="color:#ce5c00;font-weight:bold">=</span>default.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重启服务</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl restart ollama
</span></span><span style="display:flex;"><span>systemctl status ollama
</span></span></code></pre></div><h3 id="2-5-2-修改ollama数据目录">2.5.2. 修改ollama数据目录</h3>
<p>参考：<a href="https://github.com/ollama/ollama/blob/main/docs/faq.md#where-are-models-stored">ollama/docs/faq.md</a></p>
<p>默认存储目录</p>
<ul>
<li>macOS: <code>~/.ollama/models</code></li>
<li>Linux: <code>/usr/share/ollama/.ollama/models</code></li>
<li>Windows: <code>C:\Users\%username%\.ollama\models</code></li>
</ul>
<p>以linux系统为例，修改默认的存储目录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">dir</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/data/ollama/models&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建目录并分配权限</span>
</span></span><span style="display:flex;"><span>mkdir -p /data/ollama/models
</span></span><span style="display:flex;"><span>sudo chown -R ollama:ollama /data/ollama/models
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加环境变量OLLAMA_MODELS</span>
</span></span><span style="display:flex;"><span>vi /etc/systemd/system/ollama.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Service<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;OLLAMA_MODELS=/data/ollama/models&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重启服务</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl restart ollama
</span></span><span style="display:flex;"><span>systemctl status ollama
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 迁移数据</span>
</span></span><span style="display:flex;"><span>cp -fr /usr/share/ollama/.ollama/models/* /data/ollama/models
</span></span><span style="display:flex;"><span>sudo chown -R ollama:ollama /data/ollama/models
</span></span></code></pre></div><h1 id="3-部署open-webui">3. 部署open-webui</h1>
<h2 id="3-1-单独部署open-webui">3.1. 单独部署open-webui</h2>
<p>如果已经部署了ollama服务，可以通过以下命令单独部署open-webui，修改<code>OLLAMA_BASE_URL</code>为ollama的服务地址。如果使用host-network，默认服务监听端口为<code>8080</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d --network<span style="color:#ce5c00;font-weight:bold">=</span>host -e <span style="color:#000">OLLAMA_BASE_URL</span><span style="color:#ce5c00;font-weight:bold">=</span>http://OLLAMA_HOST:11434 -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main
</span></span></code></pre></div><p>环境变量</p>
<ul>
<li><code>OLLAMA_BASE_URL:http://OLLAMA_HOST:11434</code> : 设置ollama服务的地址</li>
<li><code>HF_HUB_OFFLINE: &quot;1&quot;</code>：设置模型为离线的环境</li>
<li><code>ENABLE_OPENAI_API: &quot;false&quot;</code>：设置关闭openai的接口</li>
</ul>
<p><strong>访问open-webui服务：</strong></p>
<p>访问<code>http://服务器IP:8080</code>，注册用户名密码然后登录。就可以使用本地的大模型服务。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1739864579/article/linux/llm/open-webui.png" alt=""></p>
<h2 id="3-2-部署open-webui和ollama服务">3.2. 部署open-webui和ollama服务</h2>
<p>如果不想单独部署ollama，可以通过open-webui:ollama镜像，同时部署open-webui和ollama，两个服务集成在同一个镜像中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下载镜像</span>
</span></span><span style="display:flex;"><span>docker pull ghcr.io/open-webui/open-webui:ollama
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 运行open-webui:ollama</span>
</span></span><span style="display:flex;"><span>docker run -d -p 3000:8080 -v ollama:/root/.ollama -v ollama-open-webui:/app/backend/data --name ollama-open-webui --restart always ghcr.io/open-webui/open-webui:ollama
</span></span></code></pre></div><p>查看服务</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># docker images</span>
</span></span><span style="display:flex;"><span>REPOSITORY                      TAG       IMAGE ID       CREATED        SIZE
</span></span><span style="display:flex;"><span>ghcr.io/open-webui/open-webui   ollama    29d60b4958c8   <span style="color:#0000cf;font-weight:bold">4</span> days ago     8.02GB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># docker ps</span>
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE                                  COMMAND           CREATED          STATUS                    PORTS                              NAMES
</span></span><span style="display:flex;"><span>3175fc20c608   ghcr.io/open-webui/open-webui:ollama   <span style="color:#4e9a06">&#34;bash start.sh&#34;</span>   <span style="color:#0000cf;font-weight:bold">16</span> minutes ago   Up <span style="color:#0000cf;font-weight:bold">16</span> minutes <span style="color:#ce5c00;font-weight:bold">(</span>healthy<span style="color:#ce5c00;font-weight:bold">)</span>   0.0.0.0:3000-&gt;8080/tcp             ollama-open-webui
</span></span></code></pre></div><p>登录容器下载大模型文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 登录容器</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># docker exec -it 3175fc20c608 bash</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下载指定的大模型</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ollama pull deepseek-r1:7b</span>
</span></span><span style="display:flex;"><span>pulling manifest
</span></span><span style="display:flex;"><span>pulling 96c415656d37... 100% ▕███████████████████████████████████████████████████████████████████████████████████████████████████████████▏ 4.7 GB
</span></span><span style="display:flex;"><span>pulling 369ca498f347... 100% ▕███████████████████████████████████████████████████████████████████████████████████████████████████████████▏  <span style="color:#0000cf;font-weight:bold">387</span> B
</span></span><span style="display:flex;"><span>pulling 6e4c38e1172f... 100% ▕███████████████████████████████████████████████████████████████████████████████████████████████████████████▏ 1.1 KB
</span></span><span style="display:flex;"><span>pulling f4d24e9138dd... 100% ▕███████████████████████████████████████████████████████████████████████████████████████████████████████████▏  <span style="color:#0000cf;font-weight:bold">148</span> B
</span></span><span style="display:flex;"><span>pulling 40fb844194b2... 100% ▕███████████████████████████████████████████████████████████████████████████████████████████████████████████▏  <span style="color:#0000cf;font-weight:bold">487</span> B
</span></span><span style="display:flex;"><span>verifying sha256 digest
</span></span><span style="display:flex;"><span>writing manifest
</span></span><span style="display:flex;"><span>success
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ollama list</span>
</span></span><span style="display:flex;"><span>NAME              ID              SIZE      MODIFIED
</span></span><span style="display:flex;"><span>deepseek-r1:7b    0a8c26691023    4.7 GB    <span style="color:#0000cf;font-weight:bold">12</span> minutes ago
</span></span></code></pre></div><p>则可以访问所部属服务器的地址和端口来访问open-webui的服务。</p>
<h2 id="3-3-构建本地知识库">3.3. 构建本地知识库</h2>
<h3 id="3-3-1-自定义文件分析">3.3.1. 自定义文件分析</h3>
<p>可以通过页面上传本地的知识库文件，让AI回答关于自定义文件中的内容。</p>
<p>例如：我通过文件自定义了内容，提问张飞的电话号码，则可以通过文章中的内容来回答。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1739871922/article/linux/llm/phone-chat.png" alt=""></p>
<p>其中自定义文档的内容如下：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1739869289/article/linux/llm/ollama-docs.png" alt=""></p>
<p>同样可以上传其他文件来构建一个本地大模型知识库。然后借助大模型来查询和分析数据内容。</p>
<h3 id="3-3-2-本地化数据存储">3.3.2. 本地化数据存储</h3>
<p>其中open-webui的本地化数据存储在容器内的<code>/app/backend/data/</code>目录下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/app/backend/data# ls -l
</span></span><span style="display:flex;"><span>total <span style="color:#0000cf;font-weight:bold">236</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#0000cf;font-weight:bold">7</span> root root   <span style="color:#0000cf;font-weight:bold">4096</span> Feb <span style="color:#0000cf;font-weight:bold">11</span> 10:48 cache
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#0000cf;font-weight:bold">2</span> root root   <span style="color:#0000cf;font-weight:bold">4096</span> Feb <span style="color:#0000cf;font-weight:bold">18</span> 06:11 uploads
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#0000cf;font-weight:bold">3</span> root root   <span style="color:#0000cf;font-weight:bold">4096</span> Feb <span style="color:#0000cf;font-weight:bold">18</span> 06:11 vector_db
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">229376</span> Feb <span style="color:#0000cf;font-weight:bold">18</span> 06:38 webui.db
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以从uploads目录看到上传的本地文件</span>
</span></span><span style="display:flex;"><span>/app/backend/data/uploads# cat 117e6f99-0657-40d1-ab6f-1bea81e78053_ollama-docs.md
</span></span><span style="display:flex;"><span>张飞的电话号码是u987438274
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>曹操的电话号码是123456
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>关羽的电话号码是5352345
</span></span></code></pre></div><h2 id="3-4-faq">3.4. FAQ</h2>
<h3 id="1-open-webui页面无法选择模型">1）open-webui页面无法选择模型</h3>
<p><strong>问题：</strong></p>
<p>当单独部署open-webui，可能会遇到open-webui页面无法选择模型具体的现象如下：</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1739864579/article/linux/llm/open-webui-error.png" title="" alt="" width="709">
<p>open-webui日志报错：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>INFO  <span style="color:#ce5c00;font-weight:bold">[</span>open_webui.routers.ollama<span style="color:#ce5c00;font-weight:bold">]</span> get_all_models<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>ERROR <span style="color:#ce5c00;font-weight:bold">[</span>open_webui.routers.ollama<span style="color:#ce5c00;font-weight:bold">]</span> Connection error: Cannot connect to host 1.1.1.1:11434 ssl:default <span style="color:#ce5c00;font-weight:bold">[</span>Connect call failed <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;1.1.1.1&#39;</span>, 11434<span style="color:#ce5c00;font-weight:bold">)]</span>
</span></span></code></pre></div><p><strong>原因：</strong></p>
<p>按官网命令使用<code>端口映射</code>的网络模式，如果OLLAMA_BASE_URL配置为127.0.0.1则访问不到单独部署的ollama服务，如果改用具体的ollama的IP也可能存在访问失败的问题。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d -p 3000:8080 -e <span style="color:#000">OLLAMA_BASE_URL</span><span style="color:#ce5c00;font-weight:bold">=</span>https://example.com -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main
</span></span></code></pre></div><p><strong>解决方案：</strong></p>
<p>docker网络模式改为<code>host-network</code>的网络模式</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d --network<span style="color:#ce5c00;font-weight:bold">=</span>host -e <span style="color:#000">OLLAMA_BASE_URL</span><span style="color:#ce5c00;font-weight:bold">=</span>http://OLLAMA_HOST:11434 -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main
</span></span></code></pre></div><h3 id="2-数据目录没权限permission-denied">2）数据目录没权限permission denied</h3>
<p>如果用户修改了ollama的models的存储目录，出现ollama服务重启失败，或者pull model数据报错</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 修改ollama的model目录后ollama服务重启报错</span>
</span></span><span style="display:flex;"><span>Error: mkdir /data/ollama: permission denied
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 迁移model数据后出现没权限，因为使用了root命令执行</span>
</span></span><span style="display:flex;"><span>cp -fr /usr/share/ollama/.ollama/models/* /data/ollama/models
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ollama pull deepseek-r1:70b</span>
</span></span><span style="display:flex;"><span>writing manifest
</span></span><span style="display:flex;"><span>Error: open /data/ollama/models/manifests/registry.ollama.ai/library/deepseek-r1/70b: permission denied
</span></span></code></pre></div><p><strong>原因：</strong></p>
<p>ollama默认使用的用户名是 ollama，因此需要给目录添加用户的权限，例如：目录创建和model文件迁移是通过root或其他用户执行的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo chown -R ollama:ollama /data/ollama/models
</span></span></code></pre></div><h1 id="4-总结">4. 总结</h1>
<p>本文主要介绍了ollama和open-webui的部署，从而搭建一个<code>本地化私有的大模型工具</code>，<code>所有的数据都存储在本地</code>。可以通过上传文件来分析本地的数据，类似构建<code>本地大模型知识库</code>。</p>
<p>不过本地大模型的响应速度依赖于大模型本身和本地的资源，包括cpu和gpu，没有gpu资源也可以运行。在资源较小的情况下，大模型回答问题的速度比较慢。如果完全需要离线的大模型分析数据，在资源受限的情况下需要再进一步做优化才能得到比较好的体验。</p>
<p>参考：</p>
<ul>
<li><a href="https://ollama.com/download/linux">https://ollama.com/download/linux</a></li>
<li><a href="https://github.com/ollama/ollama/blob/main/docs/faq.md">https://github.com/ollama/ollama/blob/main/docs/faq.md</a></li>
<li><a href="https://docs.openwebui.com/getting-started/quick-start">https://docs.openwebui.com/getting-started/quick-start</a></li>
<li><a href="https://github.com/open-webui/open-webui#troubleshooting">https://github.com/open-webui/open-webui#troubleshooting</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e44128ff477d39d7fb8644a3a4a27ea6">16.2 - 大模型相关概念</h1>
    
	<blockquote>
<p>本文主要介绍大模型领域常用的名词概念等。</p>
</blockquote>
<h1 id="mcp">MCP</h1>
<h2 id="mcp的概念">MCP的概念</h2>
<p>MCP的全称是<code>Model Context Protocol</code>，即模型上下文协议。根据官网的解释，MCP 是一个开放协议，它规范了应用程序向 LLM 提供<code>上下文</code>的方式。MCP 就像 AI 应用程序的 <code>USB-C </code>端口一样。正如 USB-C 提供了一种标准化的方式将您的设备连接到各种外围设备和配件一样，MCP 也提供了一种标准化的方式将 AI 模型连接到不同的数据源和工具。</p>
<p>简单理解<code>模型上下文协议</code>，可以把它拆成三个部分：</p>
<ul>
<li>
<p><code>模型</code>：协议的使用方即大模型工具。</p>
</li>
<li>
<p><code>上下文</code>：提供存储上下文的功能，类似于存储大模型历史交互的记忆。</p>
</li>
<li>
<p><code>协议</code>：本质是一种标准，类比与TCP协议，http协议，而MCP可以类比于http之上的业务层协议。</p>
</li>
</ul>
<p>它的目的是 <strong>定义模型上下文的结构、状态传递、缓存方式、状态更新机制等内容</strong>，以支持复杂推理任务中的“状态保持”和“多轮交互”。</p>
<h2 id="为什么需要mcp">为什么需要MCP</h2>
<p>在大模型推理中，尤其是以下场景：</p>
<ul>
<li>
<p>多轮对话（如 ChatGPT）</p>
</li>
<li>
<p>Streaming 推理</p>
</li>
<li>
<p>长上下文处理（如 RAG、LLM agent）</p>
</li>
<li>
<p>分布式推理流水线（分stage执行）</p>
</li>
</ul>
<p>我们需要在模型之间、服务组件之间传递“上下文状态”（如 past key value、token buffer、history、session id）。这个时候，就需要一套 <strong>标准的协议</strong> 来描述和控制这些状态 —— MCP 就是为此而生。</p>
<p>可以将 MCP 看作在 HTTP 或 gRPC 上层的“<strong>业务语义协议</strong>”：</p>
<pre tabindex="0"><code>┌──────────────────────────────────────────────┐
│                Application (LLM API)         │
│     ┌─────────────┐                          │
│     │   MCP 协议   │  &lt;-- 管理模型上下文状态   │
│     └─────────────┘                          │
│         ↑ 使用 protobuf / JSON               │
│     ┌─────────────┐                          │
│     │   HTTP/gRPC  │  &lt;-- 实际传输协议        │
│     └─────────────┘                          │
│         ↑ 使用 TCP/IP                        │
└──────────────────────────────────────────────┘
</code></pre><h2 id="类比">类比</h2>
<p><strong>MCP 是“大脑助手的记忆本”</strong></p>
<p>想象你在和一个 AI 助手（比如 ChatGPT）对话，它像一个演员在扮演各种角色。</p>
<p><strong>如果没有 MCP：</strong></p>
<p>助手每次都“失忆”，你要一遍遍重复之前的内容，它无法记得你是谁、想干嘛、聊过啥。</p>
<p><strong>如果有 MCP：</strong></p>
<p>就像它有了一本“<strong>记忆本</strong>”：</p>
<ul>
<li>
<p>每次你对它说话，它都记下“对话历史”、“你正在聊的主题”、“你的偏好”</p>
</li>
<li>
<p>它能从记忆本中取出之前你说的话，继续展开对话</p>
</li>
<li>
<p>这个“记忆本”就由 <strong>MCP 协议定义结构、内容和传递方式</strong></p>
</li>
</ul>
<p>🧠 <strong>形象理解</strong>：</p>
<blockquote>
<p>MCP 就像是 AI 模型的大脑助手，负责“记住你们聊过什么”，以及“接下来该怎么回复你”。</p>
</blockquote>
<h1 id="mcp-server">MCP server</h1>
<p>MCP server是模型上下文协议（Model Context Protocol）中的一个组件，它扮演着AI模型与外部数据、工具和功能之间连接的桥梁。它就像一个工具箱，为AI模型提供各种功能，比如访问文件、调用API、执行计算等，可以实现更复杂的任务。﻿</p>
<p>更详细地说，MCP server是一种轻量级服务程序，负责提供数据、工具和提示，帮助AI模型理解和执行任务。它通过标准化的接口和协议，将外部能力暴露给AI模型，让AI模型能够访问各种外部资源，例如数据库、API、文件等。</p>
<p>mcp server 链接：</p>
<ul>
<li><a href="https://mcp.ad/">https://mcp.ad/</a></li>
</ul>
<h1 id="prompt">Prompt</h1>
<blockquote>
<p>Prompt 就是你给大模型的“指令 + 提示 +上下文”，用来引导它输出你想要的结果。</p>
</blockquote>
<p><strong>Prompt 是 MCP 协议中的核心内容之一</strong>，而 <strong>MCP 是管理 Prompt 的“协议和系统”</strong>，用来组织、封装、传输、复用 prompt（以及上下文）以便模型推理使用。</p>
<p><strong>Prompt 是 MCP 协议中的核心内容之一</strong>，而 <strong>MCP 是管理 Prompt 的“协议和系统”</strong>，用来组织、封装、传输、复用 prompt（以及上下文）以便模型推理使用。</p>
<table>
<thead>
<tr>
<th>维度</th>
<th>Prompt</th>
<th>MCP（Model Context Protocol）</th>
</tr>
</thead>
<tbody>
<tr>
<td>本质</td>
<td>一段输入文本（或 token 序列）</td>
<td>一种上下文协议，组织模型输入/状态/上下文的格式与流程</td>
</tr>
<tr>
<td>作用</td>
<td>引导模型生成内容</td>
<td>管理 Prompt 和上下文的结构、状态、生命周期</td>
</tr>
<tr>
<td>是否直接传给模型</td>
<td>✅ 是模型输入的一部分</td>
<td>✅ 会生成 prompt，并交给模型</td>
</tr>
<tr>
<td>是谁的子集？</td>
<td>Prompt 是 MCP 的<strong>一部分字段</strong></td>
<td>MCP 是对 Prompt 及其上下文的<strong>结构化封装</strong></td>
</tr>
<tr>
<td>类比关系</td>
<td>你要说的一句话</td>
<td>你整场对话的“聊天记录 + 状态 + 上下文管理系统”</td>
</tr>
</tbody>
</table>
<p>示例：</p>
<p>Prompt：</p>
<blockquote>
<p>“你是一个翻译专家，请将下面这段话翻译为英文：‘我爱编程’”</p>
</blockquote>
<p>最终形成一个这样的 MCP payload：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&#34;session_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;abc123&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;stage&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;prompt&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;inputs&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;prompt&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;你是一个翻译专家，请将下面这段话翻译为英文：‘我爱编程’&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;history&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#a40000">...</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;role&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;generation_config&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;temperature&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.8</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;top_p&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.95</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;kv_cache_refs&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;position&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">128</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="token">Token</h1>
<blockquote>
<p><strong>Token 是大模型处理语言时的最小单位</strong>，相当于模型的“语言颗粒度”。它可能是一个词、一个子词、一个字符，甚至是一部分单词。</p>
</blockquote>
<p>人说话是用句子、单词，大模型不能直接理解这些自然语言，它必须先<strong>把文本切割成小块（token）</strong>，再转成数字（embedding）才能理解。</p>
<p>比如下面这句话：<code>你好，世界！</code></p>
<p>对人来说是 几 个字，但对模型来说，它可能被切分成 <strong>2~4 个 token</strong>，取决于使用的 tokenizer（分词器）。</p>
<p><strong>为什么 token 很重要？</strong></p>
<ul>
<li>
<p><strong>计费单位</strong>（OpenAI/Claude/其他 API）是按 token 收费的</p>
</li>
<li>
<p><strong>上下文长度限制</strong> 是按 token 算的，不是按“字”算的</p>
</li>
<li>
<p><strong>模型性能 &amp; 精度</strong> 和 token 分布、长度密切相关</p>
</li>
<li>
<p><strong>Prompt 工程</strong> 就是用尽可能少的 token 实现更强的引导效果</p>
</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://modelcontextprotocol.io/introduction">Introduction - Model Context Protocol</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-025ba230ccbdecd2053c28d50a7b1b46">17 - </h1>
    
	<h1 id="summary">Summary</h1>
<h2 id="序言">序言</h2>
<ul>
<li><a href="README.md">序言</a></li>
</ul>
<h2 id="计算">计算</h2>
<ul>
<li>
<p><a href="">CPU</a></p>
</li>
<li>
<p><a href="">内存</a></p>
</li>
</ul>
<h2 id="存储">存储</h2>
<ul>
<li><a href="">Linux 文件系统</a>
<ul>
<li><a href="file/linux-introduction.md">Linux 介绍</a></li>
<li><a href="file/linux-file-system.md">文件系统</a></li>
<li><a href="file/linux-file-storage.md">文件存储结构</a></li>
<li><a href="file/linux-file-permission.md">文件权限</a></li>
</ul>
</li>
<li><a href="">磁盘</a>
<ul>
<li><a href="disk/lvm-usage.md">LVM的使用</a></li>
<li><a href="disk/disk-command.md">磁盘命令</a></li>
<li><a href="disk/disk-raid.md">Raid介绍</a></li>
</ul>
</li>
</ul>
<h2 id="网络">网络</h2>
<ul>
<li><a href="">TCP/IP</a>
<ul>
<li><a href="tcpip/tcpip-basics.md">TCP/IP基础</a></li>
<li><a href="tcpip/ip.md">IP协议</a></li>
<li><a href="tcpip/tcp-udp.md">TCP与UDP协议</a></li>
</ul>
</li>
<li><a href="">Http</a>
<ul>
<li><a href="tcpip/http-basics.md">Http基础</a></li>
<li><a href="tcpip/http-message.md">Http报文</a></li>
<li><a href="tcpip/http-code.md">Http状态码</a></li>
</ul>
</li>
<li><a href="">网络命令</a>
<ul>
<li><a href="network/iptables.md">iptables介绍</a></li>
<li><a href="network/iptables-command.md">iptables命令</a></li>
<li><a href="network/tcpdump.md">tcpdump命令</a></li>
<li><a href="network/wrk-usage.md">wrk压测命令</a></li>
<li><a href="network/vlan.md">VLAN介绍</a></li>
</ul>
</li>
</ul>
<h2 id="程序">程序</h2>
<ul>
<li>
<p><a href="">进程</a></p>
</li>
<li>
<p><a href="">Shell 脚本</a></p>
<ul>
<li><a href="shell/shell-introduction.md">Shell简介</a></li>
<li><a href="shell/shell-var.md">Shell变量</a></li>
<li><a href="shell/shell-char.md">Shell运算符</a></li>
<li><a href="shell/shell-array.md">Shell数组</a></li>
<li><a href="shell/shell-echo.md">Shell echo命令</a></li>
<li><a href="shell/shell-if.md">Shell判断语句</a></li>
<li><a href="shell/shell-loop.md">Shell循环语句</a></li>
<li><a href="shell/shell-function.md">Shell函数</a></li>
<li><a href="shell/shell-stdout.md">Shell重定向</a></li>
</ul>
</li>
</ul>
<hr>
<h2 id="运维工具">运维工具</h2>
<ul>
<li><a href="tools/ansible-usage.md">Ansible的使用</a></li>
<li><a href="tools/supervisor-usage.md">Supervisor的使用</a></li>
<li><a href="tools/confd-usage.md">Confd的使用</a></li>
<li><a href="tools/nfs-usage.md">NFS的使用</a></li>
<li><a href="tools/ceph-fuse.md">ceph-fuse的使用</a></li>
<li><a href="tools/ssh-tips.md">ssh tips</a></li>
</ul>
<h2 id="git管理">Git管理</h2>
<ul>
<li><a href="git/git.md">Git 介绍</a></li>
<li><a href="git/git-common-cmd.md">Git 常用命令</a></li>
<li><a href="git/git-commands.md">Git 命令分类</a></li>
<li><a href="git/git-commit-msg.md">Git commit规范</a></li>
<li><a href="git/git-alias-zsh.md">Git 命令别名</a></li>
</ul>
<h2 id="数据库">数据库</h2>
<ul>
<li><a href="">Mysql</a>
<ul>
<li><a href="mysql/system-manage.md">系统管理</a></li>
<li><a href="mysql/table-operation.md">数据表操作</a></li>
<li><a href="mysql/curd-commands.md">表内容操作</a></li>
</ul>
</li>
<li><a href="">Redis</a>
<ul>
<li><a href="redis/redis-introduction.md">Redis介绍</a></li>
<li><a href="redis/redis-cluster.md">Redis集群模式部署</a></li>
<li><a href="redis/redis-sentinel.md">Redis主从及哨兵模式部署</a></li>
<li><a href="redis/redis-conf-cn.md">Redis配置详解(中文版)</a></li>
<li><a href="redis/redis-conf-en.md">Redis配置详解(英文版)</a></li>
</ul>
</li>
<li><a href="">Memcached</a>
<ul>
<li><a href="memcached/memcached.md">Memcached的使用</a></li>
<li><a href="memcached/memcached-cmd.md">Memcached命令</a></li>
</ul>
</li>
</ul>
<h2 id="网络工具">网络工具</h2>
<ul>
<li><a href="">Nginx</a>
<ul>
<li><a href="nginx/install-nginx.md">Nginx安装与配置</a></li>
<li><a href="nginx/nginx-proxy.md">Nginx作为反向代理</a></li>
<li><a href="nginx/nginx-http.md">Nginx http服务器</a></li>
<li><a href="nginx/config-ssl-for-nginx.md">配置Nginx免费证书</a></li>
</ul>
</li>
<li><a href="">Keepalived</a>
<ul>
<li><a href="keepalived/keepalived-introduction.md">Keepalived简介</a></li>
<li><a href="keepalived/install-keepalived.md">Keepalived的安装与配置</a></li>
<li><a href="keepalived/keepalived-operation.md">Keepalived的相关操作</a></li>
<li><a href="keepalived/keepalived-conf.md">Keepalived的配置详解</a></li>
</ul>
</li>
<li><a href="">Baremetal</a>
<ul>
<li><a href="baremetal/bmc.md">bmc概念</a></li>
</ul>
</li>
</ul>
<h2 id="工具技巧">工具技巧</h2>
<ul>
<li><a href="">快捷键</a>
<ul>
<li><a href="keymap/vscode-keymap.md">vscode快捷键</a></li>
<li><a href="keymap/eclipse-keymap.md">eclipse快捷键</a></li>
<li><a href="keymap/chrome-keymap.md">chrome快捷键</a></li>
<li><a href="keymap/tmux-keymap.md">tmux快捷键</a></li>
<li><a href="keymap/iterm2-rzsz.md">iterm2 rzsz的使用</a></li>
</ul>
</li>
<li><a href="">IDE工具</a>
<ul>
<li><a href="ide/vscode.md">vscode配置</a></li>
<li><a href="ide/goland.md">Goland配置</a></li>
</ul>
</li>
<li><a href="">vim</a>
<ul>
<li><a href="ide/vim/vim-keymap.md">vim命令</a></li>
<li><a href="ide/vim/vimrc-cn.md">vimrc配置</a></li>
<li><a href="ide/vim/basic-vimrc.md">basic vimrc</a></li>
</ul>
</li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2025 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
