<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/linux-notes/network/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/linux-notes/network/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>网络 | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="网络" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/linux-notes/network/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="网络">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="网络"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/kubernetes-notes/" ><span>Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/k8s-source-code-analysis/" ><span>Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/linux-notes/" ><span class="active">Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.484379d5eecd039c96fcd9e72fb90687.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/linux-notes/network/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">网络</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-699fefc6af767e2525a21bee111a7f03">tcpdump抓包流程</a></li>


    
  
    
    
	
<li>2: <a href="#pg-2e853cd9731a1b7fa5f3d4955c5ceda3">iptables介绍</a></li>


    
  
    
    
	
<li>3: <a href="#pg-fb885bb9e042e5f183dbbe1462da53d7">iptables命令</a></li>


    
  
    
    
	
<li>4: <a href="#pg-05f4d807ce9b3245e03b30114a0acab5">wrk的使用</a></li>


    
  
    
    
	
<li>5: <a href="#pg-47e00858ae348d66329dcfca96f7a676">VLAN介绍</a></li>


    
  
    
    
	
<li>6: <a href="#pg-3c94e21a7f8d25dbd0f1027dd1ff8ac0">netplan介绍</a></li>


    
  
    
    
	
<li>7: <a href="#pg-6b897bd3369333340265bef5a501a17a">网卡Bonding介绍</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-699fefc6af767e2525a21bee111a7f03">1 - tcpdump抓包流程</h1>
    
	<h1 id="1-简介">1. 简介</h1>
<p>linux系统上常用tcpdump抓包来分析网络问题。本文基于网络文章整理，主要介绍tcpdump抓包的常用命令及参数。</p>
<p>以下是数据包在操作系统层面的流程：</p>
<p><code>网卡nic</code> -&gt; <code>tcpdump</code> -&gt; <code>iptables(netfilter)</code> -&gt; <code>app</code> -&gt; <code>iptables(netfilter)</code> -&gt; <code>tcpdump</code> -&gt; <code>网卡nic</code></p>
<h1 id="2-tcpdump常用参数及命令">2. tcpdump常用参数及命令</h1>
<h2 id="2-1-指定网卡-i-和主机-host">2.1. 指定网卡(-i)和主机(host)</h2>
<p>tcpdump默认会将IP反向解析为域名，可以用<code>-nn</code>禁止反向解析。</p>
<ul>
<li>
<p><code>-i</code>：指定网卡</p>
</li>
<li>
<p><code>host</code>：指定主机</p>
</li>
<li>
<p><code>-nn</code>：禁止反向解析域名</p>
</li>
<li>
<p><code>-v或-vv</code>：显示抓包的详细信息</p>
</li>
<li>
<p><code>-w:</code> 写入文件（.pcap或.cap），供wireshark分析。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tcpdump -i any host 192.168.1.1      <span style="color:#8f5902;font-style:italic">#-i指定网卡为所有</span>
</span></span><span style="display:flex;"><span>tcpdump -i eth0 host 192.168.1.1      <span style="color:#8f5902;font-style:italic">#-i指定网卡为eth0</span>
</span></span><span style="display:flex;"><span>tcpdump -i eth0 host 192.168.1.1 -nn -v -w client.pcap     <span style="color:#8f5902;font-style:italic"># 写入文件</span>
</span></span></code></pre></div><h2 id="2-2-指定来源ip或目的ip-网段">2.2. 指定来源IP或目的IP、网段</h2>
<ul>
<li>
<p><code>src</code>：指定来源IP</p>
</li>
<li>
<p><code>dst</code>: 指定目标IP</p>
</li>
<li>
<p><code>net</code>: 指定网段</p>
</li>
<li>
<p><code>-s</code> : 指定抓包字节数，<code>-s 0</code>不限字节数，抓完整的包。例如icmp 大小为84字节</p>
</li>
<li>
<p><code>port</code>: 指定端口</p>
</li>
<li>
<p><code>portrange</code>: 指定端口范围</p>
</li>
<li>
<p><code>协议</code>：tcp, udp, icmp</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定源IP</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any src host 192.168.1.1 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  指定目标IP</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any dst 192.168.1.1 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定网段</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any net 192.168.1.1/32
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定字节数</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">84</span> host 192.168.1.1  <span style="color:#8f5902;font-style:italic"># 84表示icmp的包</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定协议</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> icmp  <span style="color:#8f5902;font-style:italic">#只抓icmp协议</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">60</span> tcp port <span style="color:#0000cf;font-weight:bold">80</span>  <span style="color:#8f5902;font-style:italic">#tcp协议，这里只抓60个头部字节</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> udp port <span style="color:#0000cf;font-weight:bold">22</span> <span style="color:#8f5902;font-style:italic"># udp协议</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定端口或范围</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> port <span style="color:#0000cf;font-weight:bold">22</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any tcp portrange 53-80 
</span></span></code></pre></div><h2 id="2-3-指定抓包数量-抓包大小-及轮询抓包">2.3. 指定抓包数量、抓包大小、及轮询抓包</h2>
<ul>
<li>
<p>-c: 指定抓多少个包</p>
</li>
<li>
<p>-W: 最多写入多少个抓包文件，以MB为单位</p>
</li>
<li>
<p>-C：写入到抓包文件的大小上限</p>
</li>
<li>
<p>-G：参数指定间隔多少秒轮询保存一次文件，通常是以时间格式命令</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定抓2个包</span>
</span></span><span style="display:flex;"><span>tcpdump -i any -s <span style="color:#0000cf;font-weight:bold">0</span> net 192.168.1.1/32 -c <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定写入到文件的大小上限为1M</span>
</span></span><span style="display:flex;"><span>tcpdump -i any -s <span style="color:#0000cf;font-weight:bold">0</span> -C <span style="color:#0000cf;font-weight:bold">1</span> -v -w client.pcap
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 指定写入到10个抓包文件，每个文件只抓1M，循环写入</span>
</span></span><span style="display:flex;"><span>tcpdump -i any -s <span style="color:#0000cf;font-weight:bold">0</span> -C 1M -v -W <span style="color:#0000cf;font-weight:bold">10</span> -w client.pcap
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 参数指定间隔多少秒轮询保存一次文件，通常是以时间格式命令</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> -G <span style="color:#0000cf;font-weight:bold">5</span> -Z root -v -w %m-%d-%H:%M:%S.pcap  <span style="color:#8f5902;font-style:italic">#每隔五秒保存一次文件</span>
</span></span></code></pre></div><h2 id="2-4-tcpdump的逻辑表达式-or-and-not">2.4. tcpdump的逻辑表达式(or、and、not)</h2>
<ul>
<li>
<p><code>and</code>: 与</p>
</li>
<li>
<p><code>or</code>: 或</p>
</li>
<li>
<p><code>not</code>: 非</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 与</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> host 192.168.1.1 and icmp
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> host 192.168.1.1 or icmp or src net 192.168.1.1/32 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 非</span>
</span></span><span style="display:flex;"><span>tcpdump -nn -i any -s <span style="color:#0000cf;font-weight:bold">0</span> ! net 172.16.0.0/16 and icmp and ! tcp
</span></span></code></pre></div><h1 id="3-flags标记解读">3. Flags标记解读</h1>
<table>
<thead>
<tr>
<th>Flags</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[S]</code></td>
<td>SYN</td>
</tr>
<tr>
<td><code>[.]</code></td>
<td>ACK</td>
</tr>
<tr>
<td><code>[S.]</code></td>
<td>SYN、ACK</td>
</tr>
<tr>
<td><code>[P.]</code></td>
<td>PUSH</td>
</tr>
<tr>
<td><code>[R.]</code></td>
<td>RST</td>
</tr>
<tr>
<td><code>[F.]</code></td>
<td>FIN</td>
</tr>
<tr>
<td><code>[DF]</code></td>
<td>Don't Fragment(不分片)，当DF=0时，允许分片</td>
</tr>
<tr>
<td><code>[FP.]</code></td>
<td>FIN、PUSH、ACK</td>
</tr>
</tbody>
</table>
<p>参考：</p>
<ul>
<li>
<p><a href="https://www.tcpdump.org/manpages/tcpdump.1.html">https://www.tcpdump.org/manpages/tcpdump.1.html</a></p>
</li>
<li>
<p><a href="https://cloud.tencent.com/developer/article/1858612">抓包神器TCPDUMP的分析总结-涵盖各大使用场景、高级用法</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2e853cd9731a1b7fa5f3d4955c5ceda3">2 - iptables介绍</h1>
    
	<h1 id="1-简介">1. 简介</h1>
<p>iptables是一个设置防火墙（<strong>netfilter</strong>）规则的命令工具。网络规则包括源地址、目的地址、传输协议（如TCP、UDP、ICMP）和服务类型（如HTTP、FTP和SMTP）等，当数据包与规则匹配时，iptables就根据规则所定义的方法来处理这些数据包，如放行（accept）、拒绝（reject）和丢弃（drop）等。配置防火墙的主要工作就是添加、修改和删除这些规则。</p>
<h1 id="2-基本概念">2. 基本概念</h1>
<h2 id="2-1-链-chain">2.1. 链(Chain)</h2>
<p>网络设置的”关卡“一般有多个网络规则，称为链。</p>
<ul>
<li>
<p>INPUT</p>
</li>
<li>
<p>OUTPUT</p>
</li>
<li>
<p>FORWORD</p>
</li>
<li>
<p>PREROUTING</p>
</li>
<li>
<p>POSTROUTING</p>
</li>
</ul>
<h2 id="2-2-表">2.2. 表</h2>
<p>具有相同功能的规则的集合叫做”表”。iptables定义了四类表。</p>
<ul>
<li>
<p>filter表：负责过滤功能，防火墙；内核模块：iptables_filter</p>
</li>
<li>
<p>nat表：network address translation，网络地址转换功能；内核模块：iptable_nat</p>
</li>
<li>
<p>mangle表：拆解报文，做出修改，并重新封装 的功能；iptable_mangle</p>
</li>
<li>
<p>raw表：关闭nat表上启用的连接追踪机制；iptable_raw</p>
</li>
</ul>
<h2 id="2-3-表和链的关系">2.3. 表和链的关系</h2>
<ul>
<li>
<p><code>PREROUTING</code>的规则可以存在于：raw表，mangle表，nat表。</p>
</li>
<li>
<p><code>INPUT</code>的规则可以存在于：mangle表，filter表。</p>
</li>
<li>
<p><code>FORWARD</code>的规则可以存在于：mangle表，filter表。</p>
</li>
<li>
<p><code>OUTPUT</code>的规则可以存在于：raw表mangle表，nat表，filter表。</p>
</li>
<li>
<p><code>POSTROUTING</code>的规则可以存在于：mangle表，nat表。</p>
</li>
</ul>
<h1 id="3-规则匹配条件">3. 规则匹配条件</h1>
<p><strong>基本匹配条件</strong></p>
<ul>
<li>
<p>源地址Source IP</p>
</li>
<li>
<p>目标地址 Destination IP</p>
</li>
</ul>
<p><strong>扩展匹配条件</strong></p>
<ul>
<li>
<p>源端口Source Port,</p>
</li>
<li>
<p>目标端口Destination Port</p>
</li>
</ul>
<p><strong>处理操作</strong></p>
<ul>
<li>
<p><strong>ACCEPT</strong>：允许数据包通过。</p>
</li>
<li>
<p><strong>DROP</strong>：直接丢弃数据包，不给任何回应信息，这时候客户端会感觉自己的请求泥牛入海了，过了超时时间才会有反应。</p>
</li>
<li>
<p><strong>REJECT</strong>：拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息。</p>
</li>
<li>
<p><strong>SNAT</strong>：源地址转换，解决内网用户用同一个公网地址上网的问题。</p>
</li>
<li>
<p><strong>MASQUERADE</strong>：是SNAT的一种特殊形式，适用于动态的、临时会变的ip上。</p>
</li>
<li>
<p><strong>DNAT</strong>：目标地址转换。</p>
</li>
<li>
<p><strong>REDIRECT</strong>：在本机做端口映射。l</p>
</li>
</ul>
<h1 id="4-数据包经过防火墙的流程">4. 数据包经过防火墙的流程</h1>
<blockquote>
<p>图片来自：https://www.zsythink.net/archives/1199</p>
</blockquote>
<ul>
<li>
<p>到本机某进程的报文：PREROUTING –&gt; INPUT</p>
</li>
<li>
<p>由本机转发的报文：PREROUTING –&gt; FORWARD –&gt; POSTROUTING</p>
</li>
<li>
<p>由本机的某进程发出报文（通常为响应报文）：OUTPUT –&gt; POSTROUTING</p>
</li>
</ul>
<p><img src="https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_2.png" alt=""></p>
<p><img src="https://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_6.png" alt=""></p>
<p>参考：</p>
<ul>
<li>
<p><a href="https://www.zsythink.net/archives/category/%e8%bf%90%e7%bb%b4%e7%9b%b8%e5%85%b3/iptables/">IPtables-朱双印博客</a></p>
</li>
<li>
<p><a href="https://www.zsythink.net/archives/1199">iptables详解（1）：iptables概念-朱双印博客</a></p>
</li>
</ul>
<p>    </p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fb885bb9e042e5f183dbbe1462da53d7">3 - iptables命令</h1>
    
	<h2 id="添加iptables规则">添加iptables规则</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 单个端口</span>
</span></span><span style="display:flex;"><span>iptables -A INPUT -p tcp --dport <span style="color:#0000cf;font-weight:bold">22</span> -j ACCEPT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 多个端口</span>
</span></span><span style="display:flex;"><span>iptables -A INPUT -p tcp -m multiport --dports 6443,8443,2379,2380,10250 -j ACCEPT
</span></span></code></pre></div><h2 id="删除iptables规则">删除iptables规则</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 显示iptables规则行号</span>
</span></span><span style="display:flex;"><span>iptables -nL --line-numbers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除某行规则</span>
</span></span><span style="display:flex;"><span>iptables -D INPUT <span style="color:#0000cf;font-weight:bold">11</span>
</span></span></code></pre></div><h2 id="持久化iptables-重启仍生效">持久化iptables（重启仍生效）</h2>
<p>持久化iptables规则，添加规则到文件中/etc/sysconfig/iptables</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># vi /etc/sysconfig/iptables</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-A INPUT -p vrrp -j ACCEPT
</span></span><span style="display:flex;"><span>-A OUTPUT -p vrrp -j ACCEPT
</span></span></code></pre></div><p>或者</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt-get install iptables-persistent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>netfilter-persistent save
</span></span><span style="display:flex;"><span>netfilter-persistent reload
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 生成的规则存储在以下文件</span>
</span></span><span style="display:flex;"><span>/etc/iptables/rules.v4
</span></span><span style="display:flex;"><span>/etc/iptables/rules.v6
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-05f4d807ce9b3245e03b30114a0acab5">4 - wrk的使用</h1>
    
	<h1 id="1-installation">1. Installation</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># mac</span>
</span></span><span style="display:flex;"><span>brew install wrk
</span></span></code></pre></div><h1 id="2-usage">2. Usage</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ wrk --help
</span></span><span style="display:flex;"><span>Usage: wrk &lt;options&gt; &lt;url&gt;
</span></span><span style="display:flex;"><span>  Options:
</span></span><span style="display:flex;"><span>    -c, --connections &lt;N&gt;  Connections to keep open <span style="color:#8f5902;font-style:italic"># 跟服务器建立并保持的TCP连接数量  </span>
</span></span><span style="display:flex;"><span>    -d, --duration    &lt;T&gt;  Duration of <span style="color:#204a87">test</span> <span style="color:#8f5902;font-style:italic"># 压测时间    </span>
</span></span><span style="display:flex;"><span>    -t, --threads     &lt;N&gt;  Number of threads to use <span style="color:#8f5902;font-style:italic"># 使用多少个线程进行压测 </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    -s, --script      &lt;S&gt;  Load Lua script file <span style="color:#8f5902;font-style:italic"># 指定Lua脚本路径 </span>
</span></span><span style="display:flex;"><span>    -H, --header      &lt;H&gt;  Add header to request  <span style="color:#8f5902;font-style:italic"># 为每一个HTTP请求添加HTTP头  </span>
</span></span><span style="display:flex;"><span>        --latency          Print latency statistics <span style="color:#8f5902;font-style:italic"># 在压测结束后，打印延迟统计信息 </span>
</span></span><span style="display:flex;"><span>        --timeout     &lt;T&gt;  Socket/request timeout  <span style="color:#8f5902;font-style:italic"># 超时时间  </span>
</span></span><span style="display:flex;"><span>    -v, --version          Print version details <span style="color:#8f5902;font-style:italic"># 打印正在使用的wrk的详细版本信息</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Numeric arguments may include a SI unit <span style="color:#ce5c00;font-weight:bold">(</span>1k, 1M, 1G<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 代表数字参数，支持国际单位 (1k, 1M, 1G)</span>
</span></span><span style="display:flex;"><span>  Time arguments may include a <span style="color:#204a87">time</span> unit <span style="color:#ce5c00;font-weight:bold">(</span>2s, 2m, 2h<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 代表时间参数，支持时间单位 (2s, 2m, 2h)</span>
</span></span></code></pre></div><p>参数设置说明：</p>
<p>一般设置线程数t，并发数c，压测时间d，--latency四个通用的参数。</p>
<ul>
<li>
<p>线程数：一般设置为压测机器CPU核数的2-4倍，过大会导致线程切换频繁，效果下降。</p>
</li>
<li>
<p>并发数：根据压测结果，动态调整并发数使得压测达到瓶颈。</p>
</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wrk -t12 -c400 -d30s --latency http://www.baidu.com
</span></span></code></pre></div><h1 id="3-压测结果">3. 压测结果</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># wrk -t12 -c400 -d30s --latency http://www.baidu.com</span>
</span></span><span style="display:flex;"><span>Running 30s <span style="color:#204a87">test</span> @ http://www.baidu.com
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">12</span> threads and <span style="color:#0000cf;font-weight:bold">400</span> connections
</span></span><span style="display:flex;"><span>               （平均值） （标准差）  （最大值）（正负一个标准差所占比例）
</span></span><span style="display:flex;"><span>  Thread Stats   Avg      Stdev     Max   +/- Stdev
</span></span><span style="display:flex;"><span>    （延迟）
</span></span><span style="display:flex;"><span>    Latency   568.16ms  250.70ms   2.00s    83.49%
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">(</span>每秒请求数<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    Req/Sec    28.26     14.99    90.00     65.71%
</span></span><span style="display:flex;"><span>  Latency Distribution （延迟分布）
</span></span><span style="display:flex;"><span>     50%  530.91ms
</span></span><span style="display:flex;"><span>     75%  585.73ms
</span></span><span style="display:flex;"><span>     90%  691.64ms
</span></span><span style="display:flex;"><span>     99%    1.78s
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">9842</span> requests in 30.10s, 99.03MB <span style="color:#204a87">read</span>  <span style="color:#ce5c00;font-weight:bold">(</span>30.10s内处理了9842个请求，耗费流量99.03MB<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  Socket errors: connect 158, <span style="color:#204a87">read</span> 0, write 0, timeout <span style="color:#0000cf;font-weight:bold">580</span>  <span style="color:#ce5c00;font-weight:bold">(</span>发生错误数<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Requests/sec:    327.00  <span style="color:#ce5c00;font-weight:bold">(</span>QPS ,即平均每秒处理请求数<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Transfer/sec:      3.29MB  <span style="color:#ce5c00;font-weight:bold">(</span>平均每秒流量<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="4-lua脚本定制压测参数">4. Lua脚本定制压测参数</h1>
<p>例如：压测post请求，需要设置指定参数。</p>
<p>写入以下lua脚本，login.lua</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#000">wrk.method</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;POST&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">wrk.body</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;{&#34;username&#34;:&#34;xxx&#34;,&#34;password&#34;:&#34;xxx&#34;}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">wrk.headers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;application/x-www-form-urlencoded&#34;</span>
</span></span></code></pre></div><p>发起压测请求：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wrk -t12 -c1000 -d30s --latency  http://127.0.0.1:8081/login -s login.lua
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/wg/wrk">GitHub - wg/wrk: Modern HTTP benchmarking tool</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/quanxiaoha/p/10661650.html">https://www.cnblogs.com/quanxiaoha/p/10661650.html</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-47e00858ae348d66329dcfca96f7a676">5 - VLAN介绍</h1>
    
	<h1 id="1-vlan是什么">1. vlan是什么</h1>
<p>VLAN（Virtual Local Area Network）即虚拟局域网，是将一个物理的LAN在逻辑上划分成多个广播域的通信技术。每个VLAN是一个广播域，VLAN内的主机间可以直接通信，而VLAN间则不能直接互通。这样，广播报文就被限制在一个VLAN内。</p>
<h1 id="2-为什么需要vlan">2. 为什么需要vlan</h1>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1719749729/article/linux/network/vlan.webp" alt=""></p>
<p>没有vlan前，广播报文会被发送到较大的广播域，主机数量较多时候会造成广播泛滥，性能低下，网络不可用等问题。<strong>如果把一个LAN网分成多个逻辑LAN网，每个逻辑LAN网通过id进行标识，相同逻辑LAN内的主机可以直接通信，不同逻辑LAN网内的主机不能直接通信，那么广播报文就限制在一个逻辑LAN网内，而这个逻辑LAN就是所谓的VLAN。</strong></p>
<p>由此可见，VLAN有以下的优点：</p>
<ul>
<li>限制广播域：节省了带宽，提高网络处理效率。</li>
<li>增加安全性：不同VLAN互相隔离，增加安全性。</li>
<li>灵活构建局域网：可以方便的构建安全的局域网。</li>
</ul>
<h1 id="3-vlan-id及vlan-tag">3. vlan ID及vlan tag</h1>
<p>为了让交换机识别不同vlan的报文，则需要通过某种标识来区分，因此在报文中加了vlan tag的字段，其中包括vlan id的信息，</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1719751351/article/linux/network/vlan_tag.webp" alt=""></p>
<p><strong>Vlan id(简称VID)，取值范围为0-4095,0和4095为保留字段，因此VLAN ID的有效范围为1-4094。</strong></p>
<p>交换机内部处理的数据帧都带有VLAN标签。而交换机连接的部分设备（如用户主机、服务器）只会收发不带VLAN tag的传统以太网数据帧。因此，要与这些设备交互，就需要交换机的接口能够识别传统以太网数据帧，并在收发时给帧添加、剥除VLAN标签。添加什么VLAN标签，由接口上的缺省VLAN（Port Default VLAN ID，PVID）决定。</p>
<h1 id="4-vlan的接口类型">4. vlan的接口类型</h1>
<p>现网中属于同一个VLAN的用户可能会被连接在不同的交换机上，且跨越交换机的VLAN可能不止一个，如果需要用户间的互通，就需要交换机间的接口能够同时识别和发送多个VLAN的数据帧。根据接口连接对象以及对收发数据帧处理的不同，当前有VLAN的多种接口类型，以适应不同的连接和组网。</p>
<p>常见的VLAN接口类型有三种，包括：Access、Trunk和Hybrid。</p>
<h2 id="4-1-access接口-接入vlan">4.1. Access接口（接入VLAN）</h2>
<p>Access接口一般用于和不能识别Tag的用户终端（如用户主机、服务器）相连，或者不需要区分不同VLAN成员时使用。</p>
<p><strong>定义</strong>：Access VLAN接口是一种用于连接终端设备（如计算机、打印机等）的接口，每个接口只属于一个VLAN。</p>
<p><strong>使用场景</strong>：适用于接入层交换机端口，每个端口连接一个终端设备，只能传输单个VLAN的流量。例如，一个办公区域内的计算机都连接到Access VLAN，以便这些计算机能够互相通信。</p>
<h2 id="4-2-trunk接口-干线vlan">4.2. Trunk接口（干线VLAN）</h2>
<p>Trunk接口一般用于连接交换机、路由器、AP以及可同时收发Tagged帧和Untagged帧的语音终端。它可以允许多个VLAN的帧带Tag通过，但只允许属于缺省VLAN的帧从该类接口上发出时不带Tag（即剥除Tag）。</p>
<p><strong>定义</strong>：Trunk VLAN接口用于在交换机之间传输多个VLAN的流量。Trunk端口能够标记（tagging）VLAN信息，以便区分不同的VLAN流量。
<strong>使用场景</strong>：适用于交换机之间或交换机与路由器之间的连接，用于传输多VLAN流量。例如，在数据中心内，需要通过Trunk端口将多个VLAN的数据传输到核心交换机。</p>
<h2 id="4-3-hybrid接口-混合vlan">4.3. Hybrid接口（混合VLAN）</h2>
<p>Hybrid接口既可以用于连接不能识别Tag的用户终端（如用户主机、服务器）和网络设备（如Hub），也可以用于连接交换机、路由器以及可同时收发Tagged帧和Untagged帧的语音终端、AP。它可以允许多个VLAN的帧带Tag通过，且允许从该类接口发出的帧根据需要配置某些VLAN的帧带Tag（即不剥除Tag）、某些VLAN的帧不带Tag（即剥除Tag）。</p>
<p><strong>定义</strong>：Hybrid VLAN接口可以同时处理Access VLAN和Trunk VLAN的流量。它可以将未标记的流量作为Access VLAN流量处理，并将标记的流量作为Trunk VLAN流量处理。</p>
<p><strong>使用场景</strong>：适用于需要灵活配置的环境，既需要处理来自终端设备的单一VLAN流量，又需要处理来自交换机的多VLAN流量。例如，在一个网络中，需要同时连接计算机和其他交换机的端口可以配置为Hybrid VLAN。</p>
<p>参考：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/5wH9QbBTGKpYaolRbMijMA">https://mp.weixin.qq.com/s/5wH9QbBTGKpYaolRbMijMA</a></li>
<li><a href="https://www.wpgdadatong.com.cn/blog/detail/71784">https://www.wpgdadatong.com.cn/blog/detail/71784</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3c94e21a7f8d25dbd0f1027dd1ff8ac0">6 - netplan介绍</h1>
    
	<h1 id="1-netplan简介">1. netplan简介</h1>
<p><code>netplan</code>是一个linux<code>网络配置的渲染器</code>，可以通过创建一个网络配置的yaml文件，netplan将该文件渲染成linux network所需的配置。</p>
<h1 id="2-netplan原理">2. netplan原理</h1>
<p>netplan读取<code>/etc/netplan/*.yaml</code>的配置文件，Netplan在<code>/run</code>（例如：<code>/run/systemd/network/</code>）中生成特定于后端的配置文件，将设备的控制交给特定的网络守护进程。</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1721465066/article/linux/network/netplan.svg" width="30%" />
<h1 id="3-netplan配置">3. netplan配置</h1>
<p>具体的netplan配置可以参考：</p>
<ul>
<li><a href="https://netplan.readthedocs.io/en/stable/howto/">https://netplan.readthedocs.io/en/stable/howto/</a></li>
<li><a href="https://netplan.readthedocs.io/en/stable/netplan-yaml/">https://netplan.readthedocs.io/en/stable/netplan-yaml/</a></li>
</ul>
<p>通用配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">network</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NUMBER   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 必填</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">renderer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">STRING  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 必填  networkd（默认）或者NetworkManager</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ethernets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 网卡相关配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bonds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># bond相关配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vlans</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># VLAN相关配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bridges</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dummy-devices</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">modems</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">tunnels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">virtual-ethernets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vrfs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">wifis</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">nm-devices</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MAPPING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-1-使用直连网关配置">3.1. 使用直连网关配置</h2>
<p>具体可参考：https://netplan.readthedocs.io/en/stable/netplan-yaml/#routing</p>
<p>如果是没有bond设置及VLAN设置，则可用以下网关配置。</p>
<p>参数说明：</p>
<ul>
<li><code>addresses</code>：网卡的IP地址</li>
<li><code>routes</code> 路由地址，一般to后面对应0.0.0.0/0， via对应网关地址</li>
<li><code>dhcp4</code>：布尔类型，是否给IPv4开启DHCP，默认是false。</li>
<li><code>gateway4</code>: IPv4的网关地址，已经废弃，被routes参数取代。gateway4和route两者配置一个即可。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">network</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">renderer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">networkd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ethernets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">addresses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;192.168.10.1/24&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">to</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># or 0.0.0.0/0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">via</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9.9.9.9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">on-link</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>使用“on-link”关键字，其中网关是直接连接到网络的IP地址，即使该地址与接口上配置的子网不匹配。</p>
<h2 id="3-2-配置bond网卡">3.2. 配置bond网卡</h2>
<p>具体可参考：https://netplan.readthedocs.io/en/stable/netplan-yaml/#properties-for-device-type-bonds</p>
<p>如果有bond网卡则按以下的配置。</p>
<p>bond参数 parameters 说明：</p>
<ul>
<li><code>mode</code>:网卡的bond模式，包括<code>balance-rr</code>(默认，即轮询), <code>active-backup</code>（主备模式）, <code>balance-xor</code>, <code>broadcast</code>, <code>802.3ad</code>, <code>balance-tlb</code> , <code>balance-alb</code></li>
<li><code>mii-monitor-interval</code>：指定MII监控的间隔时间(检查绑定的接口是否有carrier)。默认值为0;这将禁用MII监控。这相当于网络后端的MIIMonitorSec=字段。如果没有指定时间后缀，该值将被解释为毫秒。</li>
<li><code>lacp-rate</code>：配置lacpdu的传输速率。这只在802.3ad模式下有用。可能的值是slow(默认为30秒)和fast(每秒)。</li>
<li><code>transmit-hash-policy</code>：指定端口选择的传输哈希策略。这只在balance-xor、802.3ad和balance-tlb模式下有用。取值为layer2、layer3+4、layer2+3、encap2+3、encap3+4。</li>
</ul>
<p>以下示例配置一个或多个bond网卡：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">network</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">renderer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">networkd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ethernets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens4</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bonds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bond0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># bond0 即网卡名称</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">interfaces</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 由哪几块网卡做的bond0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ens1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ens2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">addresses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;192.168.10.1/24&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 配置bond0网卡地址及路由</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">to</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># or 0.0.0.0/0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">via</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9.9.9.9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># bond相关参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;802.3ad&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mii-monitor-interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;100&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置 MII 链路监控间隔为 100 毫秒。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">lacp-rate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;fast&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置 LACP 速率为快速模式（每秒发送 LACPDU 数据包）。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">transmit-hash-policy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;layer3+4&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置传输散列策略为基于第3层和第4层（IP地址和端口）的负载均衡策略。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bond1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># bond1 即网卡名称</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">interfaces</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 由哪几块网卡做的bond1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ens3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ens4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">addresses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;192.168.10.2/24&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 配置bond1网卡地址及路由</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">to</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># or 0.0.0.0/0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">via</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9.9.9.9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># bond相关参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;802.3ad&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mii-monitor-interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;100&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">lacp-rate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;fast&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">transmit-hash-policy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;layer3+4&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="3-2-1-bond模式802-3ad说明">3.2.1. bond模式802.3ad说明</h3>
<p>在网络配置中，<code>bond</code>（又称为 <code>link aggregation</code> 或 <code>NIC teaming</code>）是将多个网络接口聚合成一个单一的逻辑接口，以提高带宽和提供冗余性。<code>bond</code>模式决定了这些接口如何协同工作。</p>
<p><code>mode: &quot;802.3ad&quot;</code> 是一种 <code>bond</code>模式，它遵循 IEEE 802.3ad 标准，也称为 <code>LACP</code>（Link Aggregation Control Protocol）。这个模式提供了一种动态协商机制，可以在多个网络接口之间聚合链路。</p>
<p><strong>802.3ad 模式的特点</strong></p>
<ul>
<li><strong>动态协商</strong>：使用 LACP 协议动态协商链路聚合，使多个网络接口协同工作。</li>
<li><strong>负载均衡</strong>：能够在多个链路上均衡负载，提高整体带宽。</li>
<li><strong>冗余性</strong>：在任何一个接口故障时，其他接口仍能继续工作，提供链路冗余。</li>
<li><strong>兼容性</strong>：需要交换机端也支持并配置 LACP 协议。</li>
</ul>
<p><strong>典型应用场景</strong></p>
<ul>
<li><strong>高带宽需求</strong>：需要聚合多个网络接口来提高带宽，例如服务器对网络带宽有较高要求的情况。</li>
<li><strong>高可用性需求</strong>：需要提供网络接口的冗余，确保网络连接的稳定性和可靠性。</li>
</ul>
<p><strong>常用的模式802.3ad配置</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># bond相关参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;802.3ad&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mii-monitor-interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;100&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置 MII 链路监控间隔为 100 毫秒。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">lacp-rate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;fast&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置 LACP 速率为快速模式（每秒发送 LACPDU 数据包）。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">transmit-hash-policy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;layer3+4&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置传输散列策略为基于第3层和第4层（IP地址和端口）的负载均衡策略。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>交换机配置要求</strong></p>
<p>为了使 <code>802.3ad</code> 模式正常工作，需要确保连接的交换机支持并配置了 LACP。通过这种配置，可以实现服务器端和交换机端的链路聚合，提供更高的带宽和冗余性。</p>
<h2 id="3-3-配置vlan">3.3. 配置VLAN</h2>
<p>具体可参考：https://netplan.readthedocs.io/en/stable/netplan-yaml/#properties-for-device-type-vlans</p>
<p>如果有配置VLAN ID则按以下配置，</p>
<p>VLAN参数说明：</p>
<ul>
<li><code>bond0.1000</code>：VLAN的网卡名称</li>
<li><code>id</code>：VLAN id</li>
<li><code>link</code>：链接的网卡名称，可以是实体网卡也可以是bond的网卡。</li>
</ul>
<p>以下示例配置一个或多个VLAN网卡。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">network</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">renderer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">networkd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ethernets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens3</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bonds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bond0</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">interfaces</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ens1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ens2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;802.3ad&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">mii-monitor-interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;100&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">lacp-rate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;fast&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">transmit-hash-policy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;layer3+4&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vlans</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bond0.1000</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">addresses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;192.168.10.1/24&#34;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">#配置 bond0.1000 的地址和路由</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">to</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;0.0.0.0/0&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">via</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;9.9.9.9&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># VLAN ID</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">link</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;bond0&#34;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 配置VLAN对应的网卡</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ens3.2000</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">#多个VLAN的配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">addresses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;192.168.10.2/24&#34;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic">#配置 bond0.1000 的地址和路由</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">routes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">to</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;0.0.0.0/0&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">via</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;9.9.9.9&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># VLAN ID</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">link</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ens3&#34;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 配置VLAN对应的网卡</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>总结上述三种情况下<code>addresses</code>和<code>routes</code>参数配置的地方：</p>
<ul>
<li>没有配置bond和VLAN，则addresses和routes参数配置在ethernets</li>
<li>如果没有配置VLAN，但是配置了bond，则配置在bond下</li>
<li>如果配置了VLAN，不论是否配置bond，都配置在VLAN下</li>
</ul>
<h1 id="4-netplan命令">4. netplan命令</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>netplan -h
</span></span><span style="display:flex;"><span>usage: /usr/sbin/netplan  <span style="color:#ce5c00;font-weight:bold">[</span>-h<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>--debug<span style="color:#ce5c00;font-weight:bold">]</span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Network configuration in YAML
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>options:
</span></span><span style="display:flex;"><span>  -h, --help  show this <span style="color:#204a87">help</span> message and <span style="color:#204a87">exit</span>
</span></span><span style="display:flex;"><span>  --debug     Enable debug messages
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available commands:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">help</span>      Show this <span style="color:#204a87">help</span> message
</span></span><span style="display:flex;"><span>    apply     Apply current netplan config to running system
</span></span><span style="display:flex;"><span>    generate  Generate backend specific configuration files from /etc/netplan/*.yaml
</span></span><span style="display:flex;"><span>    get       Get a setting by specifying a nested key like <span style="color:#4e9a06">&#34;ethernets.eth0.addresses&#34;</span>, or <span style="color:#4e9a06">&#34;all&#34;</span>
</span></span><span style="display:flex;"><span>    info      Show available features
</span></span><span style="display:flex;"><span>    ip        Retrieve IP information from the system
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">set</span>       Add new setting by specifying a dotted <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span>value pair like ethernets.eth0.dhcp4<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>    rebind    Rebind SR-IOV virtual functions of given physical functions to their driver
</span></span><span style="display:flex;"><span>    status    Query networking state of the running system
</span></span><span style="display:flex;"><span>    try       Try to apply a new netplan config to running system, with automatic rollback
</span></span></code></pre></div><h2 id="4-1-netplan-get">4.1. netplan get</h2>
<p>查询当前的配置内容：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ netplan get
</span></span><span style="display:flex;"><span>network:
</span></span><span style="display:flex;"><span>  version: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>  renderer: networkd
</span></span><span style="display:flex;"><span>  ethernets:
</span></span><span style="display:flex;"><span>    enp24s0f0: <span style="color:#ce5c00;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    enp24s0f1: <span style="color:#ce5c00;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>  bonds:
</span></span><span style="display:flex;"><span>    bond0:
</span></span><span style="display:flex;"><span>      interfaces:
</span></span><span style="display:flex;"><span>      - enp24s0f1
</span></span><span style="display:flex;"><span>      - enp24s0f0
</span></span><span style="display:flex;"><span>      parameters:
</span></span><span style="display:flex;"><span>        mode: <span style="color:#4e9a06">&#34;802.3ad&#34;</span>
</span></span><span style="display:flex;"><span>        mii-monitor-interval: <span style="color:#4e9a06">&#34;100&#34;</span>
</span></span><span style="display:flex;"><span>        lacp-rate: <span style="color:#4e9a06">&#34;fast&#34;</span>
</span></span><span style="display:flex;"><span>        transmit-hash-policy: <span style="color:#4e9a06">&#34;layer3+4&#34;</span>
</span></span><span style="display:flex;"><span>  vlans:
</span></span><span style="display:flex;"><span>    bond0.1000:
</span></span><span style="display:flex;"><span>      addresses:
</span></span><span style="display:flex;"><span>      - <span style="color:#4e9a06">&#34;a.x.x.x/26&#34;</span>
</span></span><span style="display:flex;"><span>      dhcp4: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>      routes:
</span></span><span style="display:flex;"><span>      - to: <span style="color:#4e9a06">&#34;0.0.0.0/0&#34;</span>
</span></span><span style="display:flex;"><span>        via: <span style="color:#4e9a06">&#34;b.x.x.x&#34;</span>
</span></span><span style="display:flex;"><span>      id: <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>      link: <span style="color:#4e9a06">&#34;bond0&#34;</span>
</span></span></code></pre></div><h2 id="4-2-netplan-apply">4.2. netplan apply</h2>
<p>通过编辑/etc/netplan/*.yaml的文件，再执行<code>netplan apply</code>的命令可以使得网络配置生效。</p>
<h1 id="5-systemd-networkd">5. Systemd-networkd</h1>
<p>可以通过<code>man systemd-networkd</code>查看说明</p>
<ul>
<li>
<p>systemd-networkd是一种管理网络的系统服务。它检测和配置网络设备，以及创建虚拟网络设备。</p>
</li>
<li>
<p>systemd-networkd将根据systemd.netdev文件中的配置创建网络设备，并遵守这些文件中的[Match]部分。</p>
</li>
<li>
<p>当systemd-networkd退出时，它通常会保留现有的网络设备和配置不变。当配置更新并重新启动systemd-networkd时，netdev已删除配置的接口不会被删除，可能需要手动清理。</p>
</li>
<li>
<p>systemd-networkd可以在运行时使用<code>networkctl</code>进行控制。</p>
</li>
</ul>
<h2 id="5-1-配置文件">5.1. 配置文件</h2>
<p>systemd-networkd的配置文件位于<code>/run/systemd/network</code>，部分配置在<code>/etc/systemd/network</code>下。</p>
<p>主要配置文件路径和用途</p>
<ol>
<li><strong><code>.network</code> 文件</strong>：定义网络接口的配置。
<ul>
<li>路径：<code>/run/systemd/network/*.network</code></li>
<li>用途：配置网络接口的 IP 地址、网关、DNS 等。</li>
</ul>
</li>
<li><strong><code>.link</code> 文件</strong>：定义网络接口的属性，如名称、MAC 地址等。
<ul>
<li>路径：<code>/etc/systemd/network/*.link</code></li>
<li>用途：配置网络接口的属性，比如名称、MAC 地址、MTU 等。</li>
</ul>
</li>
<li><strong><code>.netdev</code> 文件</strong>：定义虚拟网络设备（例如 bridge、bond、vlan 等）的配置。
<ul>
<li>路径：<code>/run/systemd/network/*.netdev</code></li>
<li>用途：配置虚拟网络设备。</li>
</ul>
</li>
</ol>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cat  10-netplan-bond0.netdev</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">NetDev]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Name=bond0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Kind=bond</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Bond]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Mode=802.3ad</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LACPTransmitRate=fast</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">MIIMonitorSec=100ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">TransmitHashPolicy=layer3+4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># cat  10-netplan-bond0.network</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Match]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Name=bond0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Network]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LinkLocalAddressing=ipv6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ConfigureWithoutCarrier=yes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">VLAN=bond0.1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#cat  10-netplan-bond0.1000.network</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Match]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Name=bond0.1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Network]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">LinkLocalAddressing=ipv6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Address=192.168.0.1/26</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ConfigureWithoutCarrier=yes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Route]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Destination=0.0.0.0/0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Gateway=9.9.9.9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># cat  10-netplan-bond0.1000.netdev</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">NetDev]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Name=bond0.1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Kind=vlan</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">VLAN]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Id=1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="5-2-netdev参数说明">5.2. netdev参数说明</h2>
<p>netdev的参数可以参考：https://manpages.ubuntu.com/manpages/bionic/man5/systemd.netdev.5.html</p>
<p><strong>bond部分的参数说明：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>       The <span style="color:#4e9a06">&#34;[Bond]&#34;</span> section accepts the following key:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">Mode</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>           Specifies one of the bonding policies. The default is <span style="color:#4e9a06">&#34;balance-rr&#34;</span> <span style="color:#ce5c00;font-weight:bold">(</span>round robin<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>           Possible values are <span style="color:#4e9a06">&#34;balance-rr&#34;</span>, <span style="color:#4e9a06">&#34;active-backup&#34;</span>, <span style="color:#4e9a06">&#34;balance-xor&#34;</span>, <span style="color:#4e9a06">&#34;broadcast&#34;</span>,
</span></span><span style="display:flex;"><span>           <span style="color:#4e9a06">&#34;802.3ad&#34;</span>, <span style="color:#4e9a06">&#34;balance-tlb&#34;</span>, and <span style="color:#4e9a06">&#34;balance-alb&#34;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">TransmitHashPolicy</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>           Selects the transmit <span style="color:#204a87">hash</span> policy to use <span style="color:#204a87;font-weight:bold">for</span> slave selection in balance-xor, 802.3ad,
</span></span><span style="display:flex;"><span>           and tlb modes. Possible values are <span style="color:#4e9a06">&#34;layer2&#34;</span>, <span style="color:#4e9a06">&#34;layer3+4&#34;</span>, <span style="color:#4e9a06">&#34;layer2+3&#34;</span>, <span style="color:#4e9a06">&#34;encap2+3&#34;</span>, and
</span></span><span style="display:flex;"><span>           <span style="color:#4e9a06">&#34;encap3+4&#34;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">LACPTransmitRate</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>           Specifies the rate with which link partner transmits Link Aggregation Control Protocol
</span></span><span style="display:flex;"><span>           Data Unit packets in 802.3ad mode. Possible values are <span style="color:#4e9a06">&#34;slow&#34;</span>, which requests partner
</span></span><span style="display:flex;"><span>           to transmit LACPDUs every <span style="color:#0000cf;font-weight:bold">30</span> seconds, and <span style="color:#4e9a06">&#34;fast&#34;</span>, which requests partner to transmit
</span></span><span style="display:flex;"><span>           LACPDUs every second. The default value is <span style="color:#4e9a06">&#34;slow&#34;</span>.
</span></span></code></pre></div><p><strong>vlan部分说明：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>       The <span style="color:#4e9a06">&#34;[VLAN]&#34;</span> section only applies <span style="color:#204a87;font-weight:bold">for</span> netdevs of kind <span style="color:#4e9a06">&#34;vlan&#34;</span>, and accepts the following
</span></span><span style="display:flex;"><span>       key:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">Id</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>           The VLAN ID to use. An integer in the range 0–4094. This option is compulsory.
</span></span></code></pre></div><h1 id="6-networkctl命令">6. networkctl命令</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># networkctl -h</span>
</span></span><span style="display:flex;"><span>networkctl <span style="color:#ce5c00;font-weight:bold">[</span>OPTIONS...<span style="color:#ce5c00;font-weight:bold">]</span> COMMAND
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Query and control the networking subsystem.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Commands:
</span></span><span style="display:flex;"><span>  list <span style="color:#ce5c00;font-weight:bold">[</span>PATTERN...<span style="color:#ce5c00;font-weight:bold">]</span>      List links
</span></span><span style="display:flex;"><span>  status <span style="color:#ce5c00;font-weight:bold">[</span>PATTERN...<span style="color:#ce5c00;font-weight:bold">]</span>    Show link status
</span></span><span style="display:flex;"><span>  lldp <span style="color:#ce5c00;font-weight:bold">[</span>PATTERN...<span style="color:#ce5c00;font-weight:bold">]</span>      Show LLDP neighbors
</span></span><span style="display:flex;"><span>  label                  Show current address label entries in the kernel
</span></span><span style="display:flex;"><span>  delete DEVICES...      Delete virtual netdevs
</span></span><span style="display:flex;"><span>  up DEVICES...          Bring devices up
</span></span><span style="display:flex;"><span>  down DEVICES...        Bring devices down
</span></span><span style="display:flex;"><span>  renew DEVICES...       Renew dynamic configurations
</span></span><span style="display:flex;"><span>  forcerenew DEVICES...  Trigger DHCP reconfiguration of all connected clients
</span></span><span style="display:flex;"><span>  reconfigure DEVICES... Reconfigure interfaces
</span></span><span style="display:flex;"><span>  reload                 Reload .network and .netdev files
</span></span><span style="display:flex;"><span>  edit FILES<span style="color:#000;font-weight:bold">|</span>DEVICES...  Edit network configuration files
</span></span><span style="display:flex;"><span>  cat FILES<span style="color:#000;font-weight:bold">|</span>DEVICES...   Show network configuration files
</span></span></code></pre></div><h2 id="6-1-networkctl-status">6.1. networkctl status</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># networkctl status</span>
</span></span><span style="display:flex;"><span>● Interfaces: 8, 9, 7, 6, 5, 4, 3, 2, <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>       State: routable
</span></span><span style="display:flex;"><span>Online state: online
</span></span><span style="display:flex;"><span>     Address: 192.168.0.1 on bond0.1000
</span></span><span style="display:flex;"><span>              xxxx::4c0e:43ff:feba:xxxx on bond0
</span></span><span style="display:flex;"><span>              xxxx::4c0e:43ff:feba:xxxx on bond0.1000
</span></span><span style="display:flex;"><span>     Gateway: 9.9.9.9 on bond0.1000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:16 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0.1000: netdev ready
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:16 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: eno5: Gained carrier
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:16 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0.1000: Configuring with /run/systemd/network/10-netplan-bond0.1000.network.
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:16 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0.1000: Link UP
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:16 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0: Gained carrier
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:16 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0.1000: Gained carrier
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:17 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: eno6: Gained carrier
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:17 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0.1000: Gained IPv6LL
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:18 192.168.0.1 systemd-networkd<span style="color:#ce5c00;font-weight:bold">[</span>6393<span style="color:#ce5c00;font-weight:bold">]</span>: bond0: Gained IPv6LL
</span></span><span style="display:flex;"><span>Jul <span style="color:#0000cf;font-weight:bold">18</span> 02:21:18 192.168.0.1 systemd<span style="color:#ce5c00;font-weight:bold">[</span>1<span style="color:#ce5c00;font-weight:bold">]</span>: Finished systemd-networkd-wait-online.service - Wait <span style="color:#204a87;font-weight:bold">for</span> Network to be Configured.
</span></span></code></pre></div><h2 id="6-2-networkctl-list">6.2. networkctl list</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># networkctl list</span>
</span></span><span style="display:flex;"><span>IDX LINK       TYPE     OPERATIONAL SETUP
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">1</span> lo         loopback carrier     unmanaged
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2</span> eno1       ether    off         unmanaged
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">3</span> eno2       ether    off         unmanaged
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">4</span> eno3       ether    off         unmanaged
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">5</span> eno4       ether    off         unmanaged
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">6</span> eno5       ether    enslaved    configured
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">7</span> eno6       ether    enslaved    configured
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">8</span> bond0      bond     degraded    configured
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">9</span> bond0.1000 vlan     routable    configured
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">9</span> links listed.
</span></span></code></pre></div><h1 id="7-总结">7. 总结</h1>
<p>本文大概介绍了netplan和systemd-networkd两个模块，其中systemd-networkd是主要负责linux机器上的网络管理的后台进程。可以通过networkctl的命令行进行配置和查看。而netplan则是一个网络配置模板渲染工具，通过yaml文件可以生成systemd-networkd所使用的配置文件。其中netplan的配置文件位于<code>/etc/netplan/</code>目录，而systemd-networkd的配置文件为<code>/run/systemd/network</code>目录。两者的配置参数几乎是一一对应的，通过配置netplan的参数则可以配置systemd-networkd的参数。</p>
<p>参考：</p>
<ul>
<li><a href="https://netplan.io/">https://netplan.io/</a></li>
<li><a href="https://netplan.readthedocs.io/en/stable/netplan-yaml/">https://netplan.readthedocs.io/en/stable/netplan-yaml/</a></li>
<li><a href="https://netplan.readthedocs.io/en/stable/netplan-yaml/#routing">https://netplan.readthedocs.io/en/stable/netplan-yaml/#routing</a></li>
<li><a href="https://netplan.readthedocs.io/en/stable/netplan-yaml/#properties-for-device-type-bonds">https://netplan.readthedocs.io/en/stable/netplan-yaml/#properties-for-device-type-bonds</a></li>
<li><a href="https://netplan.readthedocs.io/en/stable/netplan-yaml/#properties-for-device-type-vlans">https://netplan.readthedocs.io/en/stable/netplan-yaml/#properties-for-device-type-vlans</a></li>
<li><a href="http://manpages.ubuntu.com/manpages/bionic/man5/systemd.network.5.html">Systemd-networkd</a></li>
<li><a href="https://manpages.ubuntu.com/manpages/bionic/man5/systemd.netdev.5.html">https://manpages.ubuntu.com/manpages/bionic/man5/systemd.netdev.5.html</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6b897bd3369333340265bef5a501a17a">7 - 网卡Bonding介绍</h1>
    
	<h1 id="1-概述">1. 概述</h1>
<p>网络接口绑定（Network Interface Bonding），也称为链路聚合（Link Aggregation）或NIC Teaming，是将多个物理网络接口聚合成一个逻辑接口，以提高带宽和提供冗余性的技术。这种技术广泛应用于服务器和高性能计算环境中，以确保网络的高可用性和高性能。</p>
<h1 id="2-优势">2. 优势</h1>
<ol>
<li><strong>增加带宽</strong>：通过聚合多个网络接口，整体带宽增加，从而提升网络吞吐量。</li>
<li><strong>高可用性</strong>：在一个接口发生故障时，其他接口可以继续工作，确保网络连接的连续性。</li>
<li><strong>负载均衡</strong>：数据流量可以在多个接口之间均衡分配，避免单一接口成为瓶颈。</li>
<li><strong>简化管理</strong>：将多个接口管理为一个逻辑接口，简化了网络配置和管理。</li>
</ol>
<h1 id="3-bonding-模式">3. Bonding 模式</h1>
<p>Linux 支持多种 Bonding 模式，每种模式都有其独特的特点和应用场景：</p>
<ol>
<li><strong>mode=0 (balance-rr)</strong>：循环方式（Round-robin），每个数据包依次从每个接口发送。提供负载均衡和容错功能。</li>
<li><strong>mode=1 (active-backup)</strong>：主备模式（Active-backup），一个接口为主接口，其他接口为备份接口。当主接口失败时，备份接口接管。提供高可用性。</li>
<li><strong>mode=2 (balance-xor)</strong>：根据传输散列算法选择接口。提供负载均衡和容错功能。</li>
<li><strong>mode=3 (broadcast)</strong>：广播模式，所有数据包通过所有接口发送。提供容错功能。</li>
<li><strong>mode=4 (802.3ad)</strong>：动态链路聚合（LACP），需要交换机支持 IEEE 802.3ad。提供负载均衡和高可用性。</li>
<li><strong>mode=5 (balance-tlb)</strong>：基于发送负载的自适应传输负载均衡（Adaptive Transmit Load Balancing）。无需特殊交换机支持。</li>
<li><strong>mode=6 (balance-alb)</strong>：基于接收负载的自适应负载均衡（Adaptive Load Balancing）。无需特殊交换机支持。</li>
</ol>
<h1 id="4-配置示例">4. 配置示例</h1>
<p>以下是使用 <code>systemd-networkd</code> 配置 Bonding 的示例。</p>
<h2 id="4-1-配置物理接口">4.1. 配置物理接口</h2>
<p>首先，配置要绑定的物理接口。例如，<code>enp26s0f0</code> 和 <code>enp26s0f1</code>：</p>
<p>创建文件 <code>/etc/systemd/network/10-enp26s0f0.network</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Match<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Name</span><span style="color:#ce5c00;font-weight:bold">=</span>enp26s0f0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Network<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Bond</span><span style="color:#ce5c00;font-weight:bold">=</span>bond0
</span></span></code></pre></div><p>创建文件 <code>/etc/systemd/network/10-enp26s0f1.network</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Match<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Name</span><span style="color:#ce5c00;font-weight:bold">=</span>enp26s0f1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Network<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Bond</span><span style="color:#ce5c00;font-weight:bold">=</span>bond0
</span></span></code></pre></div><h2 id="4-2-配置-bonding-接口">4.2. 配置 Bonding 接口</h2>
<p>创建文件 <code>/etc/systemd/network/bond0.netdev</code> 来定义 Bonding 接口：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>NetDev<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Name</span><span style="color:#ce5c00;font-weight:bold">=</span>bond0
</span></span><span style="display:flex;"><span><span style="color:#000">Kind</span><span style="color:#ce5c00;font-weight:bold">=</span>bond
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Bond<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Mode</span><span style="color:#ce5c00;font-weight:bold">=</span>802.3ad
</span></span><span style="display:flex;"><span><span style="color:#000">MIIMonitorSec</span><span style="color:#ce5c00;font-weight:bold">=</span>1s
</span></span><span style="display:flex;"><span><span style="color:#000">LACPTransmitRate</span><span style="color:#ce5c00;font-weight:bold">=</span>fast
</span></span></code></pre></div><h2 id="4-3-配置-bonding-接口的网络设置">4.3. 配置 Bonding 接口的网络设置</h2>
<p>创建文件 <code>/etc/systemd/network/10-bond0.network</code> 来配置 Bonding 接口的网络设置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Match<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Name</span><span style="color:#ce5c00;font-weight:bold">=</span>bond0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Network<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Address</span><span style="color:#ce5c00;font-weight:bold">=</span>192.168.1.10/24
</span></span><span style="display:flex;"><span><span style="color:#000">Gateway</span><span style="color:#ce5c00;font-weight:bold">=</span>192.168.1.1
</span></span><span style="display:flex;"><span><span style="color:#000">DNS</span><span style="color:#ce5c00;font-weight:bold">=</span>8.8.8.8
</span></span><span style="display:flex;"><span><span style="color:#000">DNS</span><span style="color:#ce5c00;font-weight:bold">=</span>8.8.4.4
</span></span></code></pre></div><h2 id="4-4-应用配置">4.4. 应用配置</h2>
<p>保存配置文件后，重新启动 <code>systemd-networkd</code> 服务以应用新的网络配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl restart systemd-networkd
</span></span></code></pre></div><h2 id="4-5-检查配置">4.5. 检查配置</h2>
<p>或者查看具体接口的详细信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># networkctl status bond0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>● 8: bond0
</span></span><span style="display:flex;"><span>                   Link File: /usr/lib/systemd/network/99-default.link
</span></span><span style="display:flex;"><span>                Network File: /run/systemd/network/10-netplan-bond0.network
</span></span><span style="display:flex;"><span>                       State: degraded <span style="color:#ce5c00;font-weight:bold">(</span>configured<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                Online state: online
</span></span><span style="display:flex;"><span>                        Type: bond
</span></span><span style="display:flex;"><span>                        Kind: bond
</span></span><span style="display:flex;"><span>                      Driver: bonding
</span></span><span style="display:flex;"><span>            Hardware Address: 4e:0e:43:ba:f7:82
</span></span><span style="display:flex;"><span>                         MTU: <span style="color:#0000cf;font-weight:bold">1500</span> <span style="color:#ce5c00;font-weight:bold">(</span>min: 68, max: 65535<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                       QDisc: noqueue
</span></span><span style="display:flex;"><span>IPv6 Address Generation Mode: eui64
</span></span><span style="display:flex;"><span>                        Mode: 802.3ad
</span></span><span style="display:flex;"><span>                      Miimon: 100ms
</span></span><span style="display:flex;"><span>                     Updelay: <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>                   Downdelay: <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    Number of Queues <span style="color:#ce5c00;font-weight:bold">(</span>Tx/Rx<span style="color:#ce5c00;font-weight:bold">)</span>: 16/16
</span></span><span style="display:flex;"><span>            Auto negotiation: no
</span></span><span style="display:flex;"><span>                       Speed: 20Gbps
</span></span><span style="display:flex;"><span>                      Duplex: full
</span></span><span style="display:flex;"><span>                     Address: xxx::4c0e:43ff:feba:xxx
</span></span><span style="display:flex;"><span>           Activation Policy: up
</span></span><span style="display:flex;"><span>         Required For Online: yes
</span></span><span style="display:flex;"><span>           DHCP6 Client DUID: DUID-EN/Vendor:0000ab111fbd6366525ac0ea
</span></span></code></pre></div><h1 id="5-通过命令配置bond">5. 通过命令配置bond</h1>
<h2 id="5-1-通过ip命令做bond">5.1. 通过IP命令做bond</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装必要的软件包</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get install -y ifenslave
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 Bond 接口</span>
</span></span><span style="display:flex;"><span>sudo ip link add bond0 <span style="color:#204a87">type</span> bond
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置 Bond 模式</span>
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> bond0 <span style="color:#204a87">type</span> bond mode 802.3ad
</span></span><span style="display:flex;"><span>或者
</span></span><span style="display:flex;"><span>modprobe bonding <span style="color:#000">mode</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000">miimon</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#000">lacp_rate</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000">xmit_hash_policy</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加从接口到 Bond 接口</span>
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> enp26s0f0 down
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> enp26s0f0 master bond0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> enp26s0f1 down
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> enp26s0f1 master bond0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 配置 Bond 接口的 IP 地址</span>
</span></span><span style="display:flex;"><span>sudo ip addr add 192.168.1.10/24 dev bond0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启用 Bond 接口</span>
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> bond0 up
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启用从接口</span>
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> enp26s0f0 up
</span></span><span style="display:flex;"><span>sudo ip link <span style="color:#204a87">set</span> enp26s0f1 up
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Bond 接口配置完成&#34;</span>
</span></span></code></pre></div><p>查看bond状态</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat /proc/net/bonding/bond0
</span></span></code></pre></div><blockquote>
<p>使用 modprobe 工具配置网络接口的 Bond（绑定）操作是另一种在 Linux 上设置链路聚合的方法。modprobe 用于加载和卸载内核模块，而 bonding 模块是用于实现网络接口绑定的内核模块。</p>
</blockquote>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2025 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
